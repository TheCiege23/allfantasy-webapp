'use client'

import React, { useState, useEffect, useMemo, useRef, Suspense } from 'react'
import { useSearchParams } from 'next/navigation'
import Link from 'next/link'
import { XP_PER_LEVEL, TIERS } from "@/lib/ranking/config"
import FeedbackModal from "@/app/components/FeedbackModal"
import LegacyTutorial from "@/app/components/LegacyTutorial"
import SmartRecommendations from "@/app/components/SmartRecommendations"
import AIGMStatusIndicator from "@/app/components/AIGMStatusIndicator"
import HeroMetricAI from "@/app/components/HeroMetricAI"
import PortfolioChart from "@/components/PortfolioChart"
import PlayerBadge from "@/components/PlayerBadge"
import PlayerProfileCard from "@/components/PlayerProfileCard"
import MiniPlayerImg from "@/components/MiniPlayerImg"
import { headshotUrl, teamLogoUrl } from '@/lib/media-url'
import { buildSleeperUser } from '@/lib/sleeper-user'
import InsightsPanel from "@/components/InsightsPanel"
import BadgeDisplay from "@/components/BadgeDisplay"
import CommunityInsights from "@/components/CommunityInsights"
import TradeAlternatives from "@/components/TradeAlternatives"
import TradeCounterSuggestions from "@/components/TradeCounterSuggestions"
import TradeFinderV2 from "@/components/TradeFinderV2"
import AdaptiveRankings from "@/components/AdaptiveRankings"
import EnhancedRankingsPanel from "@/components/EnhancedRankingsPanel"
import LeagueRankingsV2Panel from "@/components/LeagueRankingsV2Panel"
import StrategyPlanner from "@/components/StrategyPlanner"
import EtsyShop from "@/components/EtsyShop"
import ExploitMyLeague from "@/components/ExploitMyLeague"
import { DraftGradesSection } from "@/components/rankings/DraftGradesSection"
import { HallOfFameSection } from "@/components/rankings/HallOfFameSection"
import OverviewLanes from "@/app/af-legacy/components/OverviewLanes"
import OverviewReportCard from "@/app/af-legacy/components/OverviewReportCard"
import OverviewInsights from "@/app/af-legacy/components/OverviewInsights"
import { computeCompositeProfile } from "@/lib/legacy/overview-scoring"
import type { LeagueRecord } from "@/lib/legacy/overview-scoring"
import DecisionGuardianModal from "@/components/DecisionGuardianModal"
import type { GuardianEvaluationData } from "@/components/DecisionGuardianModal"
import AcceptanceMeter from "@/components/AcceptanceMeter"
import type { AcceptanceModelData } from "@/components/AcceptanceMeter"
import BottomTabBar from "@/components/mobile/BottomTabBar"
import type { MainTab } from "@/components/mobile/BottomTabBar"
import SubTabNav from "@/components/mobile/SubTabNav"
import MobileSectionHeader from "@/components/mobile/MobileSectionHeader"
import { ConfidenceBadge, TrustExplanationSheet, TrustTimeline } from "@/components/ai-confidence"
import { RiskFlags as AIRiskFlags } from "@/components/ai"
import { convertConfidenceRiskToTrustData, buildDataSources } from "@/lib/analytics/confidence-types"
import type { TrustData, TrustTimelinePoint } from "@/lib/analytics/confidence-types"
import { selectTopTradeCandidate, formatTradeHeadline } from "@/lib/ui/selectTopCandidate"
import { 
  MessageSquareText, 
  HelpCircle, 
  BarChart3, 
  ArrowLeftRight, 
  Target, 
  Search, 
  TrendingUp, 
  Trophy, 
  Radio, 
  Swords, 
  MessageCircle, 
  Share2, 
  PackageOpen,
  ShoppingBag,
  Sparkles,
  Shield,
  AlertTriangle,
  CheckCircle2,
  Info,
  ChevronRight,
  ChevronDown,
  History,
  X
} from "lucide-react"
import { useAnalytics } from "@/app/hooks/useAnalytics"

function cx(...classes: Array<string | false | null | undefined>) {
  return classes.filter(Boolean).join(' ')
}

function HeroMetric({ value, label, helper, accent = 'cyan' }: { value: string; label: string; helper: string; accent?: 'cyan' | 'purple' | 'amber' | 'emerald' | 'pink' }) {
  const accentStyles = {
    cyan: 'from-cyan-500/20 to-blue-500/10 border-cyan-400/30 text-cyan-300',
    purple: 'from-purple-500/20 to-pink-500/10 border-purple-400/30 text-purple-300',
    amber: 'from-amber-500/20 to-orange-500/10 border-amber-400/30 text-amber-300',
    emerald: 'from-emerald-500/20 to-teal-500/10 border-emerald-400/30 text-emerald-300',
    pink: 'from-pink-500/20 to-rose-500/10 border-pink-400/30 text-pink-300',
  }
  return (
    <div className={`mb-5 p-4 rounded-xl bg-gradient-to-r ${accentStyles[accent]} border flex items-center gap-4`}>
      <div className="text-3xl sm:text-4xl font-black text-white leading-none">{value}</div>
      <div className="flex-1 min-w-0">
        <div className="text-sm font-semibold text-white/80 truncate">{label}</div>
        <div className="text-xs text-white/50">{helper}</div>
      </div>
    </div>
  )
}

const tier_xp_thresholds = TIERS
  .slice()
  .sort((a, b) => a.tier - b.tier)
  .map((t) => ({
    tier: t.tier,
    name: t.name,
    minLevel: t.minLevel,
    minXp: t.minLevel * XP_PER_LEVEL,
  }))

type Tab = 'overview' | 'trade' | 'finder' | 'player-finder' | 'waiver' | 'rankings' | 'pulse' | 'compare' | 'chat' | 'share' | 'transfer' | 'strategy' | 'shop'

interface ProfileStats {
  seasons_imported?: number
  seasons?: number
  leagues_played?: number
  leagues?: number
  wins: number
  losses: number
  ties: number
  record: string
  win_percentage: number
  championships: number
  playoffs: number
  playoff_percentage?: number
  total_points_for: number
  total_points?: number
}

interface SpecialtyStats {
  total_leagues: number
  by_format: {
    guillotine?: { leagues: number; wins: number; losses: number; ties: number; championships: number }
    bestball?: { leagues: number; wins: number; losses: number; ties: number; championships: number }
    survivor?: { leagues: number; wins: number; losses: number; ties: number; championships: number }
    draft_only?: { leagues: number; wins: number; losses: number; ties: number; championships: number }
  }
}

interface LeagueHistory {
  league_id: string
  name: string
  season: number
  type: string
  scoring: string
  specialty_format?: string
  is_sf?: boolean
  is_tep?: boolean
  tep_bonus?: number | null
  team_count: number
  record: string
  wins: number
  losses: number
  ties?: number
  points_for: number
  final_standing: number | null
  playoff_seed: number | null
  is_champion: boolean
  champion_name: string
  made_playoffs: boolean
  roster?: {
    starters: string[]
    bench: string[]
    reserve: string[]
    taxi: string[]
    draftPicks?: Array<{
      season: number
      round: number
      originalOwner: number
      draftSlot?: number | null
    }>
  }
  transactions?: {
    trades?: any[]
    claims?: any[]
    drops?: any[]
    userTransactions?: any[]
  }
  trade_count?: number
  waiver_claims?: number
}

interface AIReport {
  rating: number
  title: string
  archetype: string
  consistency_score: number
  legacy_summary: string
  insights: {
    strengths: string[]
    weaknesses: string[]
    hall_of_fame_moments: string[]
    improvement_tips: string[]
  }
  next_season_advice: string
  share_text: string
}

interface Profile {
  sleeper_username: string
  sleeper_user_id: string
  display_name: string
  avatar: string
  import_status: string
  import_progress: number
  ai_rating?: number
  ai_title?: string
}

function clampMs(ms: unknown) {
  const n = Number(ms)
  if (!Number.isFinite(n)) return 0
  return Math.max(0, Math.floor(n))
}

function formatCooldown(ms: number) {
  const s = Math.ceil(ms / 1000)
  return `${s}s`
}

function getRetryAfterMsFromPayload(data: any, fallbackSec = 60) {
  const ms = data?.retryAfterMs
  if (ms != null) return clampMs(ms)
  const sec = data?.retryAfterSec
  if (sec != null) return clampMs(Number(sec) * 1000)
  return clampMs(fallbackSec * 1000)
}

function toLetterGrade(score: number | null | undefined) {
  const s = Number(score)
  if (!Number.isFinite(s)) return null

  if (s >= 97) return 'A+'
  if (s >= 93) return 'A'
  if (s >= 90) return 'A-'
  if (s >= 87) return 'B+'
  if (s >= 83) return 'B'
  if (s >= 80) return 'B-'
  if (s >= 77) return 'C+'
  if (s >= 73) return 'C'
  if (s >= 70) return 'C-'
  if (s >= 67) return 'D+'
  if (s >= 63) return 'D'
  if (s >= 60) return 'D-'
  return 'F'
}

function getLetterGradeColor(grade: string | null) {
  if (!grade) return { text: 'text-white/70', bg: 'bg-white/10', border: 'border-white/20' }
  
  if (grade.startsWith('A')) {
    return { text: 'text-emerald-300', bg: 'bg-emerald-500/20', border: 'border-emerald-400/40' }
  }
  if (grade.startsWith('B')) {
    return { text: 'text-cyan-300', bg: 'bg-cyan-500/20', border: 'border-cyan-400/40' }
  }
  if (grade.startsWith('C')) {
    return { text: 'text-yellow-300', bg: 'bg-yellow-500/20', border: 'border-yellow-400/40' }
  }
  if (grade.startsWith('D')) {
    return { text: 'text-orange-300', bg: 'bg-orange-500/20', border: 'border-orange-400/40' }
  }
  return { text: 'text-red-300', bg: 'bg-red-500/20', border: 'border-red-400/40' }
}

function getTierThresholdsFromPreview(rankingPreview: any) {
  const a = rankingPreview?.yearly_projection?.assumptions
  const rows = a?.tier_xp_thresholds

  if (!Array.isArray(rows) || rows.length < 2) return null

  // rows: [{ tier, name, minLevel, minXp }]
  return rows
    .map((r: any) => ({
      tier: Number(r.tier),
      name: String(r.name ?? ''),
      minLevel: Number(r.minLevel),
      minXp: Number(r.minXp),
    }))
    .filter(
      (r: any) =>
        Number.isFinite(r.tier) &&
        Number.isFinite(r.minLevel) &&
        Number.isFinite(r.minXp) &&
        r.tier > 0
    )
    .sort((x: any, y: any) => x.tier - y.tier)
}

function nextTierInfo(rankingPreview: any) {
  const xp = Number(rankingPreview?.career?.xp ?? 0)
  const tier = Number(rankingPreview?.career?.tier ?? 1)
  if (!Number.isFinite(xp) || !Number.isFinite(tier)) return null

  const tiers = getTierThresholdsFromPreview(rankingPreview)
  if (!tiers) return null

  const idx = tiers.findIndex((t: any) => t.tier === tier)
  if (idx === -1) return null

  const current = tiers[idx]
  const next = tiers[idx + 1] ?? null
  if (!next) return null // already top tier

  const currentFloor = Number(current.minXp ?? 0)
  const nextCeil = Number(next.minXp ?? 0)

  const needed = Math.max(0, nextCeil - xp)
  const span = Math.max(1, nextCeil - currentFloor)
  const progress = Math.max(0, Math.min(1, (xp - currentFloor) / span))

  return {
    currentFloor,
    nextCeil,
    needed,
    progress,
    nextTier: next.tier,
    nextTierName: next.name,
    nextTierMinLevel: next.minLevel,
  }
}

function safeNum(v: any, fallback = 0) {
  const n = Number(v)
  return Number.isFinite(n) ? n : fallback
}

function categorizeLeagueType(type: string): 'Redraft' | 'Dynasty' | 'Specialty' {
  const t = (type || '').toLowerCase()
  if (t.includes('dynasty')) return 'Dynasty'
  if (t.includes('redraft') || t === 'redraft') return 'Redraft'
  return 'Specialty'
}

const IDP_POSITIONS = new Set(['DL', 'DE', 'DT', 'LB', 'ILB', 'OLB', 'MLB', 'DB', 'CB', 'S', 'SS', 'FS', 'EDR'])

function LeagueHistoryAccordion({
  leagues,
  backfillLoading,
  backfillResult,
  onRefreshPlayoffData,
  getPlayerName,
  getPlayerPosition,
  navigateToChat,
}: {
  leagues: LeagueHistory[]
  backfillLoading: boolean
  backfillResult: string | null
  onRefreshPlayoffData: () => void
  getPlayerName: (id: string) => string
  getPlayerPosition: (id: string) => string
  navigateToChat?: (question: string, leagueId?: string) => void
}) {
  const [expandedYears, setExpandedYears] = useState<Set<number>>(new Set())
  const [expandedTypes, setExpandedTypes] = useState<Set<string>>(new Set())
  const [expandedLeagues, setExpandedLeagues] = useState<Set<string>>(new Set())
  const [historyFilter, setHistoryFilter] = useState<'All' | 'Dynasty' | 'Redraft' | 'Specialty'>('All')

  const filteredLeagues = useMemo(() => {
    if (historyFilter === 'All') return leagues
    return leagues.filter(l => categorizeLeagueType(l.type) === historyFilter)
  }, [leagues, historyFilter])

  const leaguesByYear: { year: number; leagues: LeagueHistory[] }[] = useMemo(() => {
    const grouped: Record<number, LeagueHistory[]> = {}
    for (const lg of filteredLeagues) {
      if (!grouped[lg.season]) grouped[lg.season] = []
      grouped[lg.season].push(lg)
    }
    return Object.entries(grouped)
      .map(([year, lgs]) => ({ year: Number(year), leagues: lgs }))
      .sort((a, b) => b.year - a.year)
  }, [filteredLeagues])

  const toggleYear = (year: number) => {
    setExpandedYears((prev) => {
      const next = new Set(prev)
      if (next.has(year)) next.delete(year)
      else next.add(year)
      return next
    })
  }

  const toggleType = (key: string) => {
    setExpandedTypes((prev) => {
      const next = new Set(prev)
      if (next.has(key)) next.delete(key)
      else next.add(key)
      return next
    })
  }

  const toggleLeague = (id: string) => {
    setExpandedLeagues((prev) => {
      const next = new Set(prev)
      if (next.has(id)) next.delete(id)
      else next.add(id)
      return next
    })
  }

  const typeOrder = ['Redraft', 'Dynasty', 'Specialty'] as const

  return (
    <div className="relative rounded-3xl bg-gradient-to-br from-slate-900/80 to-slate-950/80 border border-cyan-500/20 backdrop-blur-xl shadow-[0_20px_60px_rgba(0,0,0,0.4)] overflow-hidden">
      <div className="h-1.5 bg-gradient-to-r from-purple-400 via-cyan-500 to-purple-400" />
      <div className="p-6 sm:p-8">
        <div className="flex items-start justify-between gap-3 mb-6">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 rounded-2xl bg-gradient-to-br from-purple-500/30 to-cyan-500/30 flex items-center justify-center text-2xl">
              üìú
            </div>
            <div>
              <h3 className="text-2xl font-bold text-white">League History</h3>
              <p className="mt-1 text-sm text-white/50">
                {leagues.length} leagues across {leaguesByYear.length} seasons
              </p>
            </div>
          </div>
          <button
            onClick={onRefreshPlayoffData}
            disabled={backfillLoading}
            className="px-5 py-2.5 text-sm rounded-xl bg-purple-500/20 hover:bg-purple-500/30 border border-purple-400/30 text-purple-200 transition disabled:opacity-50 font-medium shrink-0"
          >
            {backfillLoading ? 'Updating‚Ä¶' : 'Refresh Playoff Data'}
          </button>
        </div>

        {backfillResult && (
          <p className={`text-sm mb-4 ${backfillResult.includes('failed') ? 'text-red-400' : 'text-green-400'}`}>
            {backfillResult}
          </p>
        )}

        {(() => {
          const filterOptions: Array<{ id: 'All' | 'Dynasty' | 'Redraft' | 'Specialty'; label: string; color: string; activeColor: string }> = [
            { id: 'All', label: 'All', color: 'text-white/50 hover:text-white/70', activeColor: 'bg-white/15 text-white border-white/25' },
            { id: 'Dynasty', label: 'Dynasty', color: 'text-amber-300/50 hover:text-amber-300/80', activeColor: 'bg-amber-500/20 text-amber-200 border-amber-400/30' },
            { id: 'Redraft', label: 'Redraft', color: 'text-cyan-300/50 hover:text-cyan-300/80', activeColor: 'bg-cyan-500/20 text-cyan-200 border-cyan-400/30' },
            { id: 'Specialty', label: 'Specialty', color: 'text-purple-300/50 hover:text-purple-300/80', activeColor: 'bg-purple-500/20 text-purple-200 border-purple-400/30' },
          ]
          const hasDynasty = leagues.some(l => categorizeLeagueType(l.type) === 'Dynasty')
          const hasRedraft = leagues.some(l => categorizeLeagueType(l.type) === 'Redraft')
          const hasSpecialty = leagues.some(l => categorizeLeagueType(l.type) === 'Specialty')
          const visibleFilters = filterOptions.filter(f =>
            f.id === 'All' ||
            (f.id === 'Dynasty' && hasDynasty) ||
            (f.id === 'Redraft' && hasRedraft) ||
            (f.id === 'Specialty' && hasSpecialty)
          )

          return visibleFilters.length > 2 ? (
            <div className="flex gap-1.5 mb-4 overflow-x-auto pb-1">
              {visibleFilters.map(f => (
                <button
                  key={f.id}
                  onClick={() => setHistoryFilter(f.id)}
                  className={`px-3.5 py-1.5 rounded-full text-xs font-medium border transition whitespace-nowrap ${
                    historyFilter === f.id ? f.activeColor : `${f.color} border-transparent`
                  }`}
                >
                  {f.label}
                </button>
              ))}
            </div>
          ) : null
        })()}

        {filteredLeagues.length === 0 ? (
          <p className="text-white/50">No league history found{historyFilter !== 'All' ? ` for ${historyFilter}` : ''}</p>
        ) : (
          <div className="space-y-3">
            {leaguesByYear.map(({ year, leagues: yearLeagues }) => {
              const isYearOpen = expandedYears.has(year)
              const byType: Record<string, LeagueHistory[]> = { Redraft: [], Dynasty: [], Specialty: [] }
              for (const lg of yearLeagues) {
                byType[categorizeLeagueType(lg.type)].push(lg)
              }

              const yearChampionships = yearLeagues.filter(l => l.is_champion).length
              const yearPlayoffsMade = yearLeagues.filter(l => l.made_playoffs).length
              const yearPlayoffRate = yearLeagues.length > 0 ? Math.round((yearPlayoffsMade / yearLeagues.length) * 100) : 0
              const yearTotalWins = yearLeagues.reduce((s, l) => s + l.wins, 0)
              const yearTotalLosses = yearLeagues.reduce((s, l) => s + l.losses, 0)
              const yearTrades = yearLeagues.reduce((s, l) => {
                if (l.trade_count != null) return s + l.trade_count
                if (l.transactions?.trades) return s + l.transactions.trades.length
                return s
              }, 0)
              const yearWaiverClaims = yearLeagues.reduce((s, l) => {
                if (l.waiver_claims != null) return s + l.waiver_claims
                if (l.transactions?.claims) return s + l.transactions.claims.length
                return s
              }, 0)
              const hasTransactionData = yearLeagues.some(l => l.trade_count != null || l.waiver_claims != null || l.transactions != null)

              return (
                <div key={year} className="rounded-2xl bg-gradient-to-br from-white/5 to-transparent border border-white/10 overflow-hidden hover:border-purple-400/30 transition-colors">
                  <button
                    onClick={() => toggleYear(year)}
                    className="w-full flex items-start justify-between px-5 py-4 hover:bg-white/5 transition"
                  >
                    <div className="min-w-0">
                      <div className="flex items-center gap-3 mb-1">
                        <span className={`text-xl font-bold ${isYearOpen ? 'text-cyan-300' : 'text-white'}`}>{year}</span>
                        <span className="px-3 py-1 rounded-full bg-purple-500/20 border border-purple-400/30 text-xs text-purple-200 font-medium">
                          {yearLeagues.length} leagues
                        </span>
                      </div>
                      <div className="flex flex-wrap gap-3 text-[11px] text-white/45">
                        <span>{yearTotalWins}-{yearTotalLosses} record</span>
                        {yearChampionships > 0 && (
                          <span className="text-amber-300/70">{yearChampionships} title{yearChampionships !== 1 ? 's' : ''}</span>
                        )}
                        <span>{yearPlayoffRate}% playoff rate</span>
                        {yearPlayoffsMade > 0 && (
                          <span>{yearPlayoffsMade}/{yearLeagues.length} made playoffs</span>
                        )}
                        {hasTransactionData && yearTrades > 0 && (
                          <span className="text-cyan-300/60">{yearTrades} trade{yearTrades !== 1 ? 's' : ''}</span>
                        )}
                        {hasTransactionData && yearWaiverClaims > 0 && (
                          <span className="text-emerald-300/60">{yearWaiverClaims} waiver hit{yearWaiverClaims !== 1 ? 's' : ''}</span>
                        )}
                      </div>
                    </div>
                    <span className={`text-purple-300 transition-transform duration-200 mt-1.5 ${isYearOpen ? 'rotate-180' : ''}`}>‚ñº</span>
                  </button>

                {isYearOpen && (
                  <div className="px-4 pb-4 space-y-2">
                    {typeOrder.map((typeName) => {
                      const typeLeagues = byType[typeName]
                      if (typeLeagues.length === 0) return null

                      const typeKey = `${year}-${typeName}`
                      const isTypeOpen = expandedTypes.has(typeKey)

                      return (
                        <div key={typeKey} className="rounded-xl bg-black/20 border border-white/5 overflow-hidden">
                          <button
                            onClick={() => toggleType(typeKey)}
                            className="w-full flex items-center justify-between px-3 py-2 hover:bg-white/5 transition"
                          >
                            <div className="flex items-center gap-2">
                              <span className={`text-sm font-semibold ${
                                typeName === 'Redraft' ? 'text-emerald-300' :
                                typeName === 'Dynasty' ? 'text-purple-300' :
                                'text-orange-300'
                              }`}>
                                {typeName}
                              </span>
                              <span className="text-[10px] text-white/50">({typeLeagues.length})</span>
                            </div>
                            <span className={`text-white/40 text-xs transition-transform ${isTypeOpen ? 'rotate-180' : ''}`}>‚ñº</span>
                          </button>

                          {isTypeOpen && (
                            <div className="px-3 pb-3 space-y-1">
                              {typeLeagues.map((league) => {
                                const isLeagueOpen = expandedLeagues.has(league.league_id)
                                const roster = league.roster

                                return (
                                  <div key={league.league_id} className="rounded-lg bg-black/30 border border-white/5 overflow-hidden">
                                    <button
                                      onClick={() => toggleLeague(league.league_id)}
                                      className="w-full flex items-center justify-between px-3 py-2 hover:bg-white/5 transition text-left"
                                    >
                                      <div className="flex items-center gap-2 min-w-0">
                                        <span className="text-sm text-white truncate">{league.name}</span>
                                        {league.is_champion && <span title="Champion">üèÜ</span>}
                                        {league.made_playoffs && !league.is_champion && (
                                          <span className="px-1.5 py-0.5 rounded bg-blue-500/20 text-blue-300 text-[10px] border border-blue-400/30">
                                            Playoffs
                                          </span>
                                        )}
                                      </div>
                                      <div className="flex items-center gap-3 shrink-0 text-xs text-white/60">
                                        <span>{league.record}</span>
                                        <span className={`transition-transform ${isLeagueOpen ? 'rotate-180' : ''}`}>‚ñº</span>
                                      </div>
                                    </button>

                                    {isLeagueOpen && (
                                      <div className="px-3 pb-3 pt-1 border-t border-white/5">
                                        <div className="grid grid-cols-2 gap-2 text-xs text-white/70 mb-3">
                                          <div>Record: <span className="text-white">{league.record}</span></div>
                                          <div>Finish: <span className="text-white">{league.final_standing ?? '-'}</span></div>
                                          <div>Scoring: <span className="text-white">{league.scoring}</span></div>
                                          <div>Teams: <span className="text-white">{league.team_count}</span></div>
                                        </div>

                                        {roster && (league.type === 'Dynasty' || league.type === 'Keeper') && (roster.starters.length > 0 || roster.bench.length > 0) ? (
                                          <div className="space-y-2">
                                            {(() => {
                                              const offStarters = roster.starters.filter(p => !IDP_POSITIONS.has(getPlayerPosition(p)))
                                              const idpStarters = roster.starters.filter(p => IDP_POSITIONS.has(getPlayerPosition(p)))
                                              return (
                                                <>
                                                  {offStarters.length > 0 && (
                                                    <div>
                                                      <div className="text-[10px] uppercase tracking-wide text-emerald-300/70 mb-1">Starters</div>
                                                      <div className="flex flex-wrap gap-1">
                                                        {offStarters.map((p, i) => (
                                                          <span key={i} className="px-1.5 py-0.5 rounded bg-emerald-500/10 border border-emerald-400/20 text-[11px] text-emerald-200">
                                                            <PlayerBadge name={getPlayerName(p)} sleeperId={p} position={getPlayerPosition(p)} size="sm" showTeamLogo={false} />
                                                          </span>
                                                        ))}
                                                      </div>
                                                    </div>
                                                  )}
                                                  {idpStarters.length > 0 && (
                                                    <div>
                                                      <div className="text-[10px] uppercase tracking-wide text-blue-300/70 mb-1">IDP</div>
                                                      <div className="flex flex-wrap gap-1">
                                                        {idpStarters.map((p, i) => (
                                                          <span key={i} className="px-1.5 py-0.5 rounded bg-blue-500/10 border border-blue-400/20 text-[11px] text-blue-200">
                                                            <PlayerBadge name={getPlayerName(p)} sleeperId={p} position={getPlayerPosition(p)} size="sm" showTeamLogo={false} />
                                                          </span>
                                                        ))}
                                                      </div>
                                                    </div>
                                                  )}
                                                </>
                                              )
                                            })()}
                                            {roster.bench.length > 0 && (
                                              <div>
                                                <div className="text-[10px] uppercase tracking-wide text-white/50 mb-1">Bench</div>
                                                <div className="flex flex-wrap gap-1">
                                                  {roster.bench.map((p, i) => (
                                                    <span key={i} className="px-1.5 py-0.5 rounded bg-white/5 border border-white/10 text-[11px] text-white/70">
                                                      <PlayerBadge name={getPlayerName(p)} sleeperId={p} position={getPlayerPosition(p)} size="sm" showTeamLogo={false} />
                                                    </span>
                                                  ))}
                                                </div>
                                              </div>
                                            )}
                                            {roster.reserve.length > 0 && (
                                              <div>
                                                <div className="text-[10px] uppercase tracking-wide text-red-300/70 mb-1">IR</div>
                                                <div className="flex flex-wrap gap-1">
                                                  {roster.reserve.map((p, i) => (
                                                    <span key={i} className="px-1.5 py-0.5 rounded bg-red-500/10 border border-red-400/20 text-[11px] text-red-200">
                                                      <PlayerBadge name={getPlayerName(p)} sleeperId={p} position={getPlayerPosition(p)} size="sm" showTeamLogo={false} />
                                                    </span>
                                                  ))}
                                                </div>
                                              </div>
                                            )}
                                            {roster.taxi.length > 0 && (
                                              <div>
                                                <div className="text-[10px] uppercase tracking-wide text-yellow-300/70 mb-1">Taxi Squad</div>
                                                <div className="flex flex-wrap gap-1">
                                                  {roster.taxi.map((p, i) => (
                                                    <span key={i} className="px-1.5 py-0.5 rounded bg-yellow-500/10 border border-yellow-400/20 text-[11px] text-yellow-200">
                                                      <PlayerBadge name={getPlayerName(p)} sleeperId={p} position={getPlayerPosition(p)} size="sm" showTeamLogo={false} />
                                                    </span>
                                                  ))}
                                                </div>
                                              </div>
                                            )}
                                            {/* Draft Picks - Only show for 2026 season with 3 years of picks */}
                                            {league.season >= 2025 && roster.draftPicks && roster.draftPicks.length > 0 && (() => {
                                              const picksBySeason: Record<number, typeof roster.draftPicks> = {}
                                              for (const pick of roster.draftPicks) {
                                                if (pick.season >= league.season && pick.season <= league.season + 2) {
                                                  if (!picksBySeason[pick.season]) picksBySeason[pick.season] = []
                                                  picksBySeason[pick.season]!.push(pick)
                                                }
                                              }
                                              const sortedSeasons = Object.keys(picksBySeason).map(Number).sort((a, b) => a - b)
                                              if (sortedSeasons.length === 0) return null
                                              return (
                                                <div>
                                                  <div className="text-[10px] uppercase tracking-wide text-purple-300/70 mb-1">Draft Capital</div>
                                                  <div className="space-y-1">
                                                    {sortedSeasons.map(season => {
                                                      const picks = picksBySeason[season]!.sort((a, b) => a.round - b.round || (a.draftSlot || 99) - (b.draftSlot || 99))
                                                      return (
                                                        <div key={season} className="flex flex-wrap items-center gap-1">
                                                          <span className="text-[10px] text-purple-200/60 w-10">{season}:</span>
                                                          {picks.map((pick, i) => (
                                                            <span key={i} className="px-2 py-0.5 rounded bg-purple-500/10 border border-purple-400/20 text-[11px] text-purple-200">
                                                              {pick.draftSlot ? `${pick.round}.${String(pick.draftSlot).padStart(2, '0')}` : `Rd ${pick.round}`}
                                                            </span>
                                                          ))}
                                                        </div>
                                                      )
                                                    })}
                                                  </div>
                                                </div>
                                              )
                                            })()}
                                          </div>
                                        ) : (
                                          <p className="text-xs text-white/40">No roster data available</p>
                                        )}
                                        <button
                                          onClick={(e) => { e.stopPropagation(); navigateToChat?.(`Tell me about my "${league.name}" league (${league.season}). I went ${league.record} in a ${league.team_count}-team ${league.scoring} ${league.type} league. What should I focus on?`, league.league_id) }}
                                          className="mt-3 w-full flex items-center justify-center gap-1.5 px-3 py-1.5 rounded-lg bg-cyan-500/10 border border-cyan-400/20 text-cyan-300 text-[11px] font-medium hover:bg-cyan-500/20 transition"
                                        >
                                          üí¨ Ask AI about this league
                                        </button>
                                      </div>
                                    )}
                                  </div>
                                )
                              })}
                            </div>
                          )}
                        </div>
                      )
                    })}
                  </div>
                )}
              </div>
            )
          })}
        </div>
      )}
      </div>
    </div>
  )
}

function CooldownPill(props: { label?: string; ms: number; tone?: 'cyan' | 'purple' | 'slate' }) {
  const { label = 'Cooldown', ms, tone = 'slate' } = props
  if (!ms || ms <= 0) return null

  const toneClass =
    tone === 'cyan'
      ? 'bg-cyan-500/10 border-cyan-400/25 text-cyan-200'
      : tone === 'purple'
      ? 'bg-purple-500/10 border-purple-400/25 text-purple-200'
      : 'bg-white/5 border-white/10 text-white/60'

  return (
    <span
      className={`inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full border text-[10px] leading-none ${toneClass}`}
      title={`${label}: ${formatCooldown(ms)}`}
    >
      <span className="opacity-70">‚è≥</span>
      <span className="opacity-80">{label}</span>
      <span className="font-semibold">{formatCooldown(ms)}</span>
    </span>
  )
}

function ToolStatCard({ label, value, icon, accent, subValue }: { label: string; value: string; icon?: string; accent?: 'cyan' | 'purple' | 'emerald' | 'amber' | 'rose'; subValue?: string }) {
  const accentClasses = {
    cyan: 'from-cyan-500/20 to-cyan-500/5 border-cyan-400/25 hover:border-cyan-400/40',
    purple: 'from-purple-500/20 to-purple-500/5 border-purple-400/25 hover:border-purple-400/40',
    emerald: 'from-emerald-500/20 to-emerald-500/5 border-emerald-400/25 hover:border-emerald-400/40',
    amber: 'from-amber-500/20 to-amber-500/5 border-amber-400/25 hover:border-amber-400/40',
    rose: 'from-rose-500/20 to-rose-500/5 border-rose-400/25 hover:border-rose-400/40',
  }
  const valueColors = {
    cyan: 'text-cyan-200',
    purple: 'text-purple-200',
    emerald: 'text-emerald-200',
    amber: 'text-amber-200',
    rose: 'text-rose-200',
  }

  return (
    <div className={cx(
      'rounded-xl sm:rounded-2xl bg-gradient-to-br border p-3 sm:p-4 transition-all duration-300 hover:scale-[1.02] hover:shadow-lg touch-manipulation',
      accent ? accentClasses[accent] : 'from-white/5 to-transparent border-white/10 hover:border-white/20'
    )}>
      <div className="flex items-center gap-1.5 sm:gap-2">
        {icon && <span className="text-base sm:text-lg flex-shrink-0">{icon}</span>}
        <div className="text-[10px] sm:text-[11px] uppercase tracking-wide text-white/50 truncate">{label}</div>
      </div>
      <div className={cx(
        'mt-1.5 sm:mt-2 text-lg sm:text-xl md:text-2xl font-extrabold leading-none',
        accent ? valueColors[accent] : 'text-white'
      )}>
        {value}
      </div>
      {subValue && <div className="mt-1 text-[10px] sm:text-xs text-white/40">{subValue}</div>}
    </div>
  )
}

function AFLegacyContent() {
  const { trackToolUse } = useAnalytics()
  const [platform, setPlatform] = useState<'sleeper' | 'yahoo' | 'mfl' | 'fantrax' | 'espn'>('sleeper')
  const [showEspnHelp, setShowEspnHelp] = useState(false)
  const [espnLeagueId, setEspnLeagueId] = useState('')
  const [espnTeamName, setEspnTeamName] = useState('')
  const [espnLoading, setEspnLoading] = useState(false)
  const [espnError, setEspnError] = useState('')
  const [espnResult, setEspnResult] = useState<any>(null)
  const [espnAvailableTeams, setEspnAvailableTeams] = useState<string[]>([])
  const [fantraxUsername, setFantraxUsername] = useState('')
  const [fantraxLeagueName, setFantraxLeagueName] = useState('')
  const [showFantraxHelp, setShowFantraxHelp] = useState(false)
  const [fantraxIsDevy, setFantraxIsDevy] = useState(false)
  const [fantraxFiles, setFantraxFiles] = useState<File[]>([])
  const [fantraxUploading, setFantraxUploading] = useState(false)
  const [fantraxLeagues, setFantraxLeagues] = useState<any[]>([])
  const [fantraxError, setFantraxError] = useState<string | null>(null)
  const [fantraxLoading, setFantraxLoading] = useState(false)
  const [showSleeperHelp, setShowSleeperHelp] = useState(false)
  const [showYahooHelp, setShowYahooHelp] = useState(false)
  const [showMflHelp, setShowMflHelp] = useState(false)
  const [username, setUsernameState] = useState('')
  const [loading, setLoading] = useState(false)

  // Persist username to sessionStorage so it survives page navigation
  const setUsername = (val: string) => {
    setUsernameState(val)
    if (typeof window !== 'undefined') {
      if (val) {
        sessionStorage.setItem('af_legacy_username', val)
      }
    }
  }

  // Yahoo state
  const [yahooConnected, setYahooConnected] = useState(false)
  const [yahooUserId, setYahooUserId] = useState<string | null>(null)
  const [yahooDisplayName, setYahooDisplayName] = useState<string | null>(null)
  const [yahooLeagues, setYahooLeagues] = useState<any[]>([])
  const [yahooLoading, setYahooLoading] = useState(false)
  const [yahooError, setYahooError] = useState('')

  // Custom platform state
  const [customPlatforms, setCustomPlatforms] = useState<Array<{ name: string; leagueCount: number; notes: string }>>([])
  const [showAddPlatform, setShowAddPlatform] = useState(false)
  const [newPlatformName, setNewPlatformName] = useState('')
  const [newPlatformLeagueCount, setNewPlatformLeagueCount] = useState('')
  const [newPlatformNotes, setNewPlatformNotes] = useState('')

  // MFL state
  const [mflConnected, setMflConnected] = useState(false)
  const [mflUsername, setMflUsername] = useState('')
  const [mflPassword, setMflPassword] = useState('')
  const [mflLeagues, setMflLeagues] = useState<any[]>([])
  const [mflLoading, setMflLoading] = useState(false)
  const [mflError, setMflError] = useState('')
  const [mflStartYear, setMflStartYear] = useState(new Date().getFullYear() - 5)
  const [mflEndYear, setMflEndYear] = useState(new Date().getFullYear())
  const [mflImporting, setMflImporting] = useState(false)
  const [mflImportResult, setMflImportResult] = useState<any>(null)

  const [error, setError] = useState('')
  const [importStatus, setImportStatus] = useState<'idle' | 'importing' | 'complete'>('idle')
  const [importProgress, setImportProgress] = useState(0)
  const [jobId, setJobId] = useState<string | null>(null)
  const [profile, setProfile] = useState<Profile | null>(null)
  const [stats, setStats] = useState<ProfileStats | null>(null)
  const [specialtyStats, setSpecialtyStats] = useState<SpecialtyStats | null>(null)
  const [leagues, setLeagues] = useState<LeagueHistory[]>([])
  const [seasonBreakdown, setSeasonBreakdown] = useState<any[]>([])
  const [aiReport, setAiReport] = useState<AIReport | null>(null)
  const [activeTab, setActiveTab] = useState<Tab>('overview')
  const [mobileMainTab, setMobileMainTab] = useState<MainTab>('home')
  const [moreMenuOpen, setMoreMenuOpen] = useState(false)
  const [moreMenuPosition, setMoreMenuPosition] = useState<{ top: number; right: number } | null>(null)
  const [trustSheetOpen, setTrustSheetOpen] = useState(false)
  const [trustSheetData, setTrustSheetData] = useState<TrustData | null>(null)
  const moreButtonRef = useRef<HTMLButtonElement>(null)
  const [aiLoading, setAiLoading] = useState(false)
  const [shareText, setShareText] = useState('')
  const [shareStyle, setShareStyle] = useState<'balanced' | 'humble' | 'trash_talk'>('balanced')
  const [shareLoading, setShareLoading] = useState(false)
  const [shareType, setShareType] = useState<'legacy' | 'trade' | 'rankings' | 'exposure'>('legacy')
  const [lastTradeResult, setLastTradeResult] = useState<{ sideA?: { name: string }[]; sideB?: { name: string }[]; grade?: string; verdict?: string; leagueType?: string } | null>(null)
  const [previewScreen, setPreviewScreen] = useState<0 | 1 | 2 | 3>(0)
  
  // Share tab inline data
  const [shareTradeSideA, setShareTradeSideA] = useState('')
  const [shareTradeSideB, setShareTradeSideB] = useState('')
  const [shareTradeLeagueType, setShareTradeLeagueType] = useState<'dynasty' | 'redraft'>('dynasty')
  const [shareTradeAnalysis, setShareTradeAnalysis] = useState<{ grade?: string; verdict?: string; sideA?: string[]; sideB?: string[] } | null>(null)
  const [shareTradeLoading, setShareTradeLoading] = useState(false)
  const [shareTradeError, setShareTradeError] = useState('')
  const [sharePlayerSearch, setSharePlayerSearch] = useState('')
  const [sharePlayerResult, setSharePlayerResult] = useState<{ name: string; sleeperId?: string; position?: string; team?: string; value?: number; trend?: string; signal?: string; rank?: number } | null>(null)
  const [sharePlayerLoading, setSharePlayerLoading] = useState(false)
  const [sharePlayerError, setSharePlayerError] = useState('')
  const [showTutorial, setShowTutorial] = useState(false)
  const [showFeedback, setShowFeedback] = useState(false)

  const [backfillLoading, setBackfillLoading] = useState(false)
  const [backfillResult, setBackfillResult] = useState<string>('')

  const [rankingPreview, setRankingPreview] = useState<any>(null)
  const [rankRefreshLoading, setRankRefreshLoading] = useState(false)
  const [showRankExplain, setShowRankExplain] = useState(false)
  const [rankRefreshError, setRankRefreshError] = useState('')

  const [aiCoach, setAiCoach] = useState<any>(null)
  const [aiCoachLoading, setAiCoachLoading] = useState(false)
  const [aiCoachError, setAiCoachError] = useState('')
  const [showAiExplain, setShowAiExplain] = useState(false)
  const [insightExpanded, setInsightExpanded] = useState(false)

  const [aiAnalysisLoading, setAiAnalysisLoading] = useState(false)
  const [careerStatsLoading, setCareerStatsLoading] = useState(false)
  const [aiAnalysisRemaining, setAiAnalysisRemaining] = useState<number | null>(null)
  const [careerStatsRemaining, setCareerStatsRemaining] = useState<number | null>(null)

  const [shareRemaining, setShareRemaining] = useState<number | null>(null)
  const [aiCoachRemaining, setAiCoachRemaining] = useState<number | null>(null)
  
  const [shareRewardLoading, setShareRewardLoading] = useState(false)
  const [shareRewardMessage, setShareRewardMessage] = useState<{ type: 'success' | 'error' | 'info'; text: string } | null>(null)
  const [shareRewardTokens, setShareRewardTokens] = useState<number>(0)
  const [canShareToday, setCanShareToday] = useState(true)
  const [rankRemaining, setRankRemaining] = useState<number | null>(null)
  
  const [playerNames, setPlayerNames] = useState<Record<string, { name: string; position: string; team: string | null }>>({})

  // Trade Finder state
  const [finderSelectedLeague, setFinderSelectedLeague] = useState<string>('')
  const [finderLoading, setFinderLoading] = useState(false)

  // Transfer state
  const [transferLeagueId, setTransferLeagueId] = useState('')
  const [transferLoading, setTransferLoading] = useState(false)
  const [transferError, setTransferError] = useState('')
  const [transferPreview, setTransferPreview] = useState<any>(null)
  const [playoffTeamCount, setPlayoffTeamCount] = useState<4 | 6 | 7 | 8 | 9>(6)
  const [phoneScreenIndex, setPhoneScreenIndex] = useState(0)
  const phoneScreens = ['overview', 'standings', 'draft', 'team', 'trades', 'settings', 'aitools'] as const

  // C2C Devy Roster state (from CFBD API)
  const [c2cDevyRoster, setC2cDevyRoster] = useState<Array<{
    name: string
    team: string
    position: string
    classYear: string
    devyValue: number
    fantasyPoints?: number
  }>>([])

  // Trade History state
  const [historyLeagueId, setHistoryLeagueId] = useState('')
  const [historyLoading, setHistoryLoading] = useState(false)
  const [historyProgress, setHistoryProgress] = useState(0)
  const [historyTrades, setHistoryTrades] = useState<Array<any>>([])
  const [historyGradedTrades, setHistoryGradedTrades] = useState<Record<string, any>>({})
  const [historyError, setHistoryError] = useState('')
  const [expandedTradeId, setExpandedTradeId] = useState<string | null>(null)
  const [c2cDevyLoading, setC2cDevyLoading] = useState(false)
  const [c2cDevyLeague, setC2cDevyLeague] = useState<{ name: string; season: number; teamCount: number } | null>(null)

  // Goal-Driven Proposal Generator state
  const [goalProposalGoal, setGoalProposalGoal] = useState<string>('')
  const [goalProposalLoading, setGoalProposalLoading] = useState(false)
  const [goalProposalError, setGoalProposalError] = useState('')
  const [goalProposalResult, setGoalProposalResult] = useState<any>(null)
  const [goalProposalExpandedPartner, setGoalProposalExpandedPartner] = useState<number | null>(null)

  // Trade Ideas Generator state
  const [tradeGoals, setTradeGoals] = useState('')
  const [tradeAnalysisDepth, setTradeAnalysisDepth] = useState<'fast' | 'deep'>('fast')
  const [tradeSelectedLeague, setTradeSelectedLeague] = useState('')
  const [tradeIdeasCount, setTradeIdeasCount] = useState(5)
  const [tradeIdeasLoading, setTradeIdeasLoading] = useState(false)
  const [tradeIdeasError, setTradeIdeasError] = useState('')
  const [tradeIdeasResults, setTradeIdeasResults] = useState<any[]>([])
  const [tradeIdeasOpportunities, setTradeIdeasOpportunities] = useState<any[]>([])
  
  // Inline Trade Evaluator state
  const [inlineSideA, setInlineSideA] = useState('')
  const [inlineSideB, setInlineSideB] = useState('')
  const [inlineTradeLoading, setInlineTradeLoading] = useState(false)
  const [inlineTradeError, setInlineTradeError] = useState('')
  const [inlineTradeResult, setInlineTradeResult] = useState<any>(null)
  const [inlineTradeFormat, setInlineTradeFormat] = useState<'dynasty' | 'redraft'>('dynasty')
  const LEAGUE_SIZES = [4, 10, 12, 14, 16, 32] as const
  type LeagueSize = (typeof LEAGUE_SIZES)[number]
  const [manualNumTeams, setManualNumTeams] = useState<LeagueSize>(12)
  
  // Decision Guardian state
  const [guardianEval, setGuardianEval] = useState<GuardianEvaluationData | null>(null)
  const [guardianInterventionId, setGuardianInterventionId] = useState<string | null>(null)
  const [guardianActionType, setGuardianActionType] = useState<'trade' | 'player_drop' | 'faab_bid'>('trade')
  const [guardianVisible, setGuardianVisible] = useState(false)
  const [guardianPayload, setGuardianPayload] = useState<any>(null)
  const guardianResolveRef = useRef<null | ((proceed: boolean) => void)>(null)

  useEffect(() => {
    return () => {
      if (guardianResolveRef.current) {
        guardianResolveRef.current(false)
        guardianResolveRef.current = null
      }
    }
  }, [])
  
  // Trade Hub dropdown-based state
  const [tradeHubLeague, setTradeHubLeague] = useState('')
  const [tradeHubManagers, setTradeHubManagers] = useState<any[]>([])
  const [tradeHubLoading, setTradeHubLoading] = useState(false)
  const [tradeHubRosterPositions, setTradeHubRosterPositions] = useState<string[]>([])
  const [tradeHubLeagueSettings, setTradeHubLeagueSettings] = useState<any>(null)
  const [tradeHubLivePreview, setTradeHubLivePreview] = useState<any>(null)
  const [tradeHubLiveLoading, setTradeHubLiveLoading] = useState(false)
  const [tradeHubExpandedSlotMap, setTradeHubExpandedSlotMap] = useState(false)
  
  // ‚úÖ Single source of truth for the whole AI Trade Hub
  const [reportCardLeague, setReportCardLeague] = useState<string>('')
  
  // Seasons
  type ReportCardSeasonMode = 'current' | 'all' | string
  const [reportCardYear, setReportCardYear] = useState<ReportCardSeasonMode>('current')
  const [reportCardAvailableYears, setReportCardAvailableYears] = useState<string[]>([])
  
  // ‚úÖ Derive the active league for all sub-tools from the report card league selection
  const activeTradeLeagueId = reportCardLeague

  // ‚úÖ Hard-sync legacy state vars whenever reportCardLeague changes
  useEffect(() => {
    if (!reportCardLeague) return
    setTradeHubLeague(reportCardLeague)
    setTradeSelectedLeague(reportCardLeague)
  }, [reportCardLeague])

  const effectiveNumTeams = useMemo(() => {
    if (activeTradeLeagueId) {
      const selectedLeague = leagues.find((l) => l.league_id === activeTradeLeagueId)
      const leagueTeamsFromLeague = selectedLeague?.team_count
      const fromManagers = tradeHubManagers.length
      const n =
        (Number.isFinite(leagueTeamsFromLeague) && (leagueTeamsFromLeague ?? 0) > 0 ? leagueTeamsFromLeague : null) ??
        (fromManagers > 0 ? fromManagers : null) ??
        12
      return Math.max(4, Math.min(32, Math.floor(Number(n) || 12)))
    }
    return manualNumTeams
  }, [activeTradeLeagueId, leagues, tradeHubManagers.length, manualNumTeams])

  // Trade History Report Card state
  const [reportCardLoading, setReportCardLoading] = useState(false)
  const [reportCardTradesByYear, setReportCardTradesByYear] = useState<Record<string, any[]>>({})
  const [reportCardSummary, setReportCardSummary] = useState<any>(null)
  const [tradeAnalytics, setTradeAnalytics] = useState<any>(null)
  const [analyticsLoading, setAnalyticsLoading] = useState(false)
  const [valuationMode, setValuationMode] = useState<'atTime' | 'hindsight'>('atTime')
  const [analyticsTradesCache, setAnalyticsTradesCache] = useState<any>(null)
  const [tradeFilter, setTradeFilter] = useState<'all' | 'wins' | 'losses' | 'even'>('all')
  const [tradeSort, setTradeSort] = useState<'recent' | 'impactful' | 'controversial' | 'marketShift'>('recent')
  const [showMoreRecap, setShowMoreRecap] = useState(false)
  const [statsTab, setStatsTab] = useState<'atTime' | 'hindsight' | 'lineupImpact'>('atTime')
  const [waiverActivity, setWaiverActivity] = useState<any>(null)
  const [waiverMVP, setWaiverMVP] = useState<any>(null)
  const [tradeHubTeamA, setTradeHubTeamA] = useState('')
  const [tradeHubTeamB, setTradeHubTeamB] = useState('')
  const [tradeHubPlayersA, setTradeHubPlayersA] = useState<string[]>([])
  const [tradeHubPlayersB, setTradeHubPlayersB] = useState<string[]>([])
  const [recentlyAddedIds, setRecentlyAddedIds] = useState<string[]>([])
  const [toast, setToast] = useState<string | null>(null)
  const sideARef = useRef<HTMLDivElement | null>(null)
  const sideBRef = useRef<HTMLDivElement | null>(null)
  const [tradeHubPicksA, setTradeHubPicksA] = useState<string[]>([])
  const [tradeHubPicksB, setTradeHubPicksB] = useState<string[]>([])
  const [tradeHubFaabA, setTradeHubFaabA] = useState(0)
  const [tradeHubFaabB, setTradeHubFaabB] = useState(0)
  const [tradeHubGoal, setTradeHubGoal] = useState('')
  const [tradeHubIdeasLoading, setTradeHubIdeasLoading] = useState(false)
  const [tradeHubIdeas, setTradeHubIdeas] = useState<any[]>([])
  const [showTradeHubIdeas, setShowTradeHubIdeas] = useState(false)

  const [proposalTargetTeam, setProposalTargetTeam] = useState('')
  const [proposalDesiredAssets, setProposalDesiredAssets] = useState<Array<{ type: 'player' | 'pick'; name: string; pos?: string; team?: string; pickYear?: number; pickRound?: number; pickSlot?: number | null; originalOwner?: string }>>([])
  const [proposalLoading, setProposalLoading] = useState(false)
  const [proposalError, setProposalError] = useState('')
  const [proposalResults, setProposalResults] = useState<any[]>([])
  const [proposalDesiredTotal, setProposalDesiredTotal] = useState(0)
  const [proposalBestAcceptIdx, setProposalBestAcceptIdx] = useState<number | null>(null)
  const [optimizeForAcceptance, setOptimizeForAcceptance] = useState(false)
  
  const [finderError, setFinderError] = useState('')
  const [finderWarning, setFinderWarning] = useState('')
  const [tradeSuggestions, setTradeSuggestions] = useState<any[]>([])
  const [finderLeagueInfo, setFinderLeagueInfo] = useState<{ name: string; scoringType: string } | null>(null)
  const [tradeFeedback, setTradeFeedback] = useState<Record<string, number>>({})
  const [feedbackLoading, setFeedbackLoading] = useState<Record<string, boolean>>({})
  const [expandedTrades, setExpandedTrades] = useState<Record<string, boolean>>({})

  const [finderUserRosterId, setFinderUserRosterId] = useState<number | null>(null)
  const [finderUserRoster, setFinderUserRoster] = useState<any[]>([])
  
  // Trade History Learning state
  const [tradeHistoryStatus, setTradeHistoryStatus] = useState<Record<string, { status: string; tradesLoaded: number; message?: string }>>({})
  const [tradeHistoryNotification, setTradeHistoryNotification] = useState<{ leagueId: string; message: string } | null>(null)
  
  // Trade Preferences Quiz state
  const [quizTrades, setQuizTrades] = useState<any[]>([])
  const [quizResponses, setQuizResponses] = useState<Record<number, 'A' | 'B'>>({})
  const [quizCurrentIndex, setQuizCurrentIndex] = useState(0)
  const [quizCompleted, setQuizCompleted] = useState(false)
  const [quizLoading, setQuizLoading] = useState(false)
  const [quizChecked, setQuizChecked] = useState(false)

  // Trade Notifications state
  const [tradeNotifications, setTradeNotifications] = useState<any[]>([])
  const [tradeNotifLoading, setTradeNotifLoading] = useState(false)
  const [showTradeNotifs, setShowTradeNotifs] = useState(false)
  const [newTradeCount, setNewTradeCount] = useState(0)
  const [highlightedTradeId, setHighlightedTradeId] = useState<string | null>(null)
  
  // URL params for deep linking from email notifications
  const searchParams = useSearchParams()

  // Email signup state
  const [emailForAlerts, setEmailForAlerts] = useState('')
  const [emailSignupLoading, setEmailSignupLoading] = useState(false)
  const [emailSignupSuccess, setEmailSignupSuccess] = useState(false)
  const [emailSignupError, setEmailSignupError] = useState('')

  // Waiver AI state
  const [waiverDynastyLeagues, setWaiverDynastyLeagues] = useState<any[]>([])
  const [waiverSelectedLeague, setWaiverSelectedLeague] = useState('')
  const [waiverLoading, setWaiverLoading] = useState(false)
  const [waiverError, setWaiverError] = useState('')
  const [waiverAnalysis, setWaiverAnalysis] = useState<any>(null)
  const [waiverLeaguesLoading, setWaiverLeaguesLoading] = useState(false)
  const [expandedWaivers, setExpandedWaivers] = useState<Record<number, boolean>>({})
  const [waiverGoal, setWaiverGoal] = useState<'win-now' | 'balanced' | 'rebuild' | ''>('')
  const [waiverRiskTolerance, setWaiverRiskTolerance] = useState(50)

  // League Rankings state
  const [rankingsDynastyLeagues, setRankingsDynastyLeagues] = useState<any[]>([])
  const [rankingsLeaguesLoading, setRankingsLeaguesLoading] = useState(false)
  const [rankingsSelectedLeague, setRankingsSelectedLeague] = useState('')
  const [rankingsShareCopied, setRankingsShareCopied] = useState(false)
  const [pendingShareLeague, setPendingShareLeague] = useState<string | null>(null)
  const [rankingsLoading, setRankingsLoading] = useState(false)
  const [rankingsError, setRankingsError] = useState('')
  const [rankingsData, setRankingsData] = useState<any>(null)
  const [rankingsCompareTeam1, setRankingsCompareTeam1] = useState('')
  const [rankingsCompareTeam2, setRankingsCompareTeam2] = useState('')
  const [rankingsExpandedTeam, setRankingsExpandedTeam] = useState<string | null>(null)

  // Devy Draft Assistant state
  const [devyBoardLoading, setDevyBoardLoading] = useState(false)
  const [devyBoardData, setDevyBoardData] = useState<any>(null)
  const [devyBoardError, setDevyBoardError] = useState('')

  // Playoff Forecast state
  const [playoffForecastYear, setPlayoffForecastYear] = useState<number>(new Date().getFullYear())
  const [playoffForecastData, setPlayoffForecastData] = useState<any>(null)
  const [playoffForecastLoading, setPlayoffForecastLoading] = useState(false)
  const [playoffForecastType, setPlayoffForecastType] = useState<'traditional' | 'elo'>('traditional')

  // Historical Ratings state
  const [historicalRatingsData, setHistoricalRatingsData] = useState<any>(null)
  const [historicalRatingsLoading, setHistoricalRatingsLoading] = useState(false)
  const [historicalRatingsSeason, setHistoricalRatingsSeason] = useState<number>(new Date().getFullYear() - 1)

  // Compare Teams memoized data - ensures proper reactivity when teams change
  const compareTeamsData = useMemo(() => {
    if (!rankingsCompareTeam1 || !rankingsCompareTeam2 || !rankingsData?.allTeams) {
      return null
    }
    const team1 = rankingsData.allTeams.find((t: any) => t.userId === rankingsCompareTeam1)
    const team2 = rankingsData.allTeams.find((t: any) => t.userId === rankingsCompareTeam2)
    
    if (!team1 || !team2) return null
    
    const categories = [
      { label: 'Overall', rank1: team1.overallRank, rank2: team2.overallRank },
      { label: 'QB', rank1: team1.qbRank, rank2: team2.qbRank },
      { label: 'RB', rank1: team1.rbRank, rank2: team2.rbRank },
      { label: 'WR', rank1: team1.wrRank, rank2: team2.wrRank },
      { label: 'TE', rank1: team1.teRank, rank2: team2.teRank },
      { label: 'Picks', rank1: team1.pickRank, rank2: team2.pickRank },
    ]
    
    return {
      team1,
      team2,
      categories,
      team1Wins: categories.filter(c => c.rank1 < c.rank2).length,
      team2Wins: categories.filter(c => c.rank2 < c.rank1).length,
    }
  }, [rankingsCompareTeam1, rankingsCompareTeam2, rankingsData?.allTeams])

  // League Format state
  const [leagueFormatData, setLeagueFormatData] = useState<any>(null)
  const [leagueFormatLoading, setLeagueFormatLoading] = useState(false)
  const [leagueFormatPreset, setLeagueFormatPreset] = useState('WAR View')

  // Manager Compare state
  const [compareOpponent, setCompareOpponent] = useState('')
  const [compareLoading, setCompareLoading] = useState(false)
  const [compareError, setCompareError] = useState('')
  const [compareResult, setCompareResult] = useState<any>(null)
  
  // Player Finder state
  const [playerSearchQuery, setPlayerSearchQuery] = useState('')
  const [playerSearchLoading, setPlayerSearchLoading] = useState(false)
  const [playerSearchError, setPlayerSearchError] = useState('')
  const [playerSearchResults, setPlayerSearchResults] = useState<any[]>([])
  const [selectedPlayerCard, setSelectedPlayerCard] = useState<any | null>(null)

  // Social Pulse state
  const [pulsePlayerInput, setPulsePlayerInput] = useState('')
  const [pulseLoading, setPulseLoading] = useState(false)
  const [pulseError, setPulseError] = useState('')
  const [pulseData, setPulseData] = useState<any>(null)
  const [pulseFormat, setPulseFormat] = useState<'dynasty' | 'redraft'>('dynasty')

  // AI Chat state
  const [chatMessages, setChatMessages] = useState<Array<{ role: 'user' | 'assistant'; content: string; imageUrl?: string }>>([])
  const [chatInput, setChatInput] = useState('')
  const [chatLoading, setChatLoading] = useState(false)
  const [chatError, setChatError] = useState('')
  const [chatImagePreview, setChatImagePreview] = useState<string | null>(null)
  const [chatLeagueId, setChatLeagueId] = useState<string>('')
  const chatContainerRef = useRef<HTMLDivElement>(null)

  // Feedback modal state
  const [feedbackOpen, setFeedbackOpen] = useState(false)

  // Fetch player names on mount
  useEffect(() => {
    fetch('/api/legacy/players')
      .then(res => res.json())
      .then(data => {
        if (data.players) setPlayerNames(data.players)
      })
      .catch(() => {})
  }, [])

  // Dynamic SEO titles based on active tab
  useEffect(() => {
    const seoTitles: Record<Tab, string> = {
      'overview': 'AI Fantasy Football Career Profile & Report Card | AllFantasy',
      'trade': 'AI Fantasy Football Trade Analyzer (Dynasty & Redraft) | AllFantasy',
      'finder': 'Fantasy Football Trade Finder Tool | Discover Winning Trades with AI',
      'player-finder': 'Fantasy Football Player Finder & Value Tool | AllFantasy AI',
      'waiver': 'Fantasy Football Waiver Wire AI | Best Pickup Suggestions',
      'rankings': 'Fantasy Football League Rankings & Power Rankings | AllFantasy',
      'pulse': 'Fantasy Football Market Pulse & Player Sentiment | AllFantasy AI',
      'compare': 'Fantasy Football Player Comparison Tool | Start or Sit with AI',
      'chat': 'AI Fantasy Football Coach | Personalized Advice & Strategy',
      'share': 'Share Your Fantasy Football Career Report Card | AllFantasy',
      'transfer': 'Transfer Fantasy Football Leagues from Sleeper, Yahoo & More',
      'strategy': 'Season Strategy Planner | AI-Powered Fantasy Football Roadmap',
      'shop': 'Official AllFantasy Merch | Shop AF Gear on Etsy',
    }
    document.title = seoTitles[activeTab] || 'AF Legacy | AllFantasy'
  }, [activeTab])

  // Refetch trade analytics when valuation mode changes
  useEffect(() => {
    if (!analyticsTradesCache) return
    
    const refetchAnalytics = async () => {
      setAnalyticsLoading(true)
      try {
        const analyticsRes = await fetch('/api/legacy/trade-analytics', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ...analyticsTradesCache,
            mode: valuationMode
          })
        })
        const analyticsData = await analyticsRes.json()
        if (analyticsRes.ok) {
          setTradeAnalytics(analyticsData)
        }
      } catch (err) {
        console.error('Analytics refetch error:', err)
      } finally {
        setAnalyticsLoading(false)
      }
    }
    
    refetchAnalytics()
  }, [valuationMode, analyticsTradesCache])

  // Check Yahoo connection status and handle OAuth callback
  useEffect(() => {
    const urlParams = new URLSearchParams(window.location.search)
    const yahooConnectedParam = urlParams.get('yahoo_connected')
    const yahooUserParam = urlParams.get('yahoo_user')
    const yahooErrorParam = urlParams.get('yahoo_error')
    
    if (yahooErrorParam) {
      setYahooError(`Yahoo connection failed: ${yahooErrorParam}`)
      setPlatform('yahoo')
    }
    
    if (yahooConnectedParam === '1' && yahooUserParam) {
      setYahooConnected(true)
      setYahooUserId(yahooUserParam)
      setPlatform('yahoo')
      window.history.replaceState({}, '', window.location.pathname)
      fetchYahooLeagues()
    } else {
      fetch('/api/yahoo/leagues')
        .then(res => {
          if (res.ok) return res.json()
          return null
        })
        .then(data => {
          if (data?.connected) {
            setYahooConnected(true)
            setYahooUserId(data.yahooUserId)
            setYahooDisplayName(data.displayName)
            setYahooLeagues(data.leagues || [])
          }
        })
        .catch(() => {})
    }
  }, [])

  const fetchFantraxLeagues = async (user: string) => {
    if (!user.trim()) return
    setFantraxLoading(true)
    setFantraxError(null)
    try {
      const res = await fetch(`/api/legacy/fantrax?username=${encodeURIComponent(user.trim())}`)
      const data = await res.json()
      if (res.ok && data.leagues) {
        setFantraxLeagues(data.leagues)
      }
    } catch (err) {
      console.error('Failed to fetch Fantrax leagues:', err)
    } finally {
      setFantraxLoading(false)
    }
  }

  useEffect(() => {
    if (platform === 'fantrax' && fantraxUsername.trim()) {
      const timer = setTimeout(() => {
        fetchFantraxLeagues(fantraxUsername)
      }, 500)
      return () => clearTimeout(timer)
    }
  }, [platform, fantraxUsername])

  const fetchYahooLeagues = async () => {
    setYahooLoading(true)
    setYahooError('')
    try {
      const res = await fetch('/api/yahoo/leagues')
      const data = await res.json()
      if (!res.ok) {
        setYahooError(data.error || 'Failed to fetch Yahoo leagues')
        return
      }
      setYahooConnected(true)
      setYahooDisplayName(data.displayName)
      setYahooLeagues(data.leagues || [])
    } catch {
      setYahooError('Network error')
    } finally {
      setYahooLoading(false)
    }
  }

  const connectYahoo = () => {
    window.location.href = '/api/auth/yahoo'
  }

  const connectMfl = async () => {
    if (!mflUsername.trim() || !mflPassword.trim()) {
      setMflError('Username and password are required')
      return
    }
    setMflLoading(true)
    setMflError('')
    try {
      const res = await fetch('/api/auth/mfl', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: mflUsername, password: mflPassword })
      })
      const data = await res.json()
      if (!res.ok) {
        setMflError(data.error || 'Login failed')
        return
      }
      setMflConnected(true)
      setMflPassword('')
      fetchMflLeagues()
    } catch {
      setMflError('Network error')
    } finally {
      setMflLoading(false)
    }
  }

  const fetchMflLeagues = async () => {
    setMflLoading(true)
    try {
      const res = await fetch('/api/mfl/leagues')
      const data = await res.json()
      if (data.connected) {
        setMflConnected(true)
        setMflUsername(data.username || '')
        setMflLeagues(data.leagues || [])
      }
    } catch {}
    finally {
      setMflLoading(false)
    }
  }

  useEffect(() => {
    fetch('/api/mfl/leagues')
      .then(res => res.ok ? res.json() : null)
      .then(data => {
        if (data?.connected) {
          setMflConnected(true)
          setMflUsername(data.username || '')
          setMflLeagues(data.leagues || [])
        }
      })
      .catch(() => {})
  }, [])

  const generateTradeIdeas = async () => {
    if (!tradeSelectedLeague) {
      setTradeIdeasError('Please select a league')
      return
    }
    setTradeIdeasLoading(true)
    setTradeIdeasError('')
    setTradeIdeasResults([])
    setTradeIdeasOpportunities([])
    try {
      const res = await fetch('/api/legacy/trade-ideas', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          goals: tradeGoals.trim() || undefined,
          depth: tradeAnalysisDepth,
          leagueId: tradeSelectedLeague,
          count: tradeIdeasCount,
          username,
        })
      })
      const data = await res.json()
      if (!res.ok) {
        setTradeIdeasError(data.error || 'Failed to generate trade ideas')
        return
      }
      setTradeIdeasResults(data.ideas || [])
      setTradeIdeasOpportunities(data.opportunities || [])
    } catch {
      setTradeIdeasError('Network error - please try again')
    } finally {
      setTradeIdeasLoading(false)
    }
  }

  const generateTradeProposals = async () => {
    if (!proposalTargetTeam || proposalDesiredAssets.length === 0) {
      setProposalError('Select a team and at least one asset you want')
      return
    }
    const myTeamData = tradeHubManagers.find((m: any) => String(m.rosterId) === tradeHubTeamA)
    const targetTeamData = tradeHubManagers.find((m: any) => String(m.rosterId) === proposalTargetTeam)
    if (!myTeamData || !targetTeamData) {
      setProposalError('Could not find team data')
      return
    }
    setProposalLoading(true)
    setProposalError('')
    setProposalResults([])
    setProposalDesiredTotal(0)
    try {
      const league = leagues.find(l => l.league_id === activeTradeLeagueId)
      const isSF = league?.scoring?.toLowerCase().includes('superflex') || league?.scoring?.toLowerCase().includes('sf') || false
      const res = await fetch('/api/legacy/trade/proposal-generator', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          leagueId: activeTradeLeagueId,
          username: username,
          myRosterId: tradeHubTeamA,
          targetRosterId: proposalTargetTeam,
          desiredAssets: proposalDesiredAssets,
          myTeam: {
            displayName: myTeamData.displayName,
            players: myTeamData.players,
            draftPicks: myTeamData.draftPicks || [],
            record: myTeamData.record,
          },
          targetTeam: {
            displayName: targetTeamData.displayName,
            players: targetTeamData.players,
            draftPicks: targetTeamData.draftPicks || [],
            record: targetTeamData.record,
          },
          format: 'dynasty',
          isSuperFlex: isSF,
        })
      })
      const data = await res.json()
      if (!res.ok) {
        setProposalError(data.error || 'Failed to generate proposals')
        return
      }
      setProposalResults(data.proposals || [])
      setProposalDesiredTotal(data.desiredTotal || 0)
      setProposalBestAcceptIdx(data.bestAcceptanceIndex ?? null)
      trackToolUse('trade_proposal_generator', { targetTeam: targetTeamData.displayName, assetsCount: proposalDesiredAssets.length })
    } catch {
      setProposalError('Network error - please try again')
    } finally {
      setProposalLoading(false)
    }
  }

  const toggleProposalAsset = (asset: { type: 'player' | 'pick'; name: string; pos?: string; team?: string; pickYear?: number; pickRound?: number; pickSlot?: number | null; originalOwner?: string }) => {
    setProposalDesiredAssets(prev => {
      const key = asset.type === 'player' ? `player:${asset.name}` : `pick:${asset.pickYear}:${asset.pickRound}:${asset.originalOwner}`
      const exists = prev.some(a => {
        const aKey = a.type === 'player' ? `player:${a.name}` : `pick:${a.pickYear}:${a.pickRound}:${a.originalOwner}`
        return aKey === key
      })
      if (exists) {
        return prev.filter(a => {
          const aKey = a.type === 'player' ? `player:${a.name}` : `pick:${a.pickYear}:${a.pickRound}:${a.originalOwner}`
          return aKey !== key
        })
      }
      return [...prev, asset]
    })
  }

  const generateGoalProposals = async () => {
    if (!goalProposalGoal || !tradeHubLeague) {
      setGoalProposalError('Select a goal and make sure a league is loaded')
      return
    }
    setGoalProposalLoading(true)
    setGoalProposalError('')
    setGoalProposalResult(null)
    setGoalProposalExpandedPartner(null)
    try {
      const res = await fetch('/api/legacy/trade/goal-proposals', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          leagueId: tradeHubLeague,
          username,
          goal: goalProposalGoal,
        }),
      })
      const data = await res.json()
      if (!res.ok) throw new Error(data.error || 'Failed to generate proposals')
      setGoalProposalResult(data)
      if (data.partners?.length > 0) setGoalProposalExpandedPartner(0)
    } catch (err: any) {
      setGoalProposalError(err.message || 'Something went wrong')
    } finally {
      setGoalProposalLoading(false)
    }
  }

  const analyzeInlineTrade = async () => {
    if (!inlineSideA.trim() || !inlineSideB.trim()) {
      setInlineTradeError('Please enter players for both sides')
      return
    }
    setInlineTradeLoading(true)
    setInlineTradeError('')
    setInlineTradeResult(null)
    
    const parsePlayers = (input: string) => {
      return input.split(/[,\n]/).map(p => p.trim()).filter(Boolean)
    }
    
    const sideAPlayers = parsePlayers(inlineSideA)
    const sideBPlayers = parsePlayers(inlineSideB)
    
    try {
      const res = await fetch('/api/legacy/trade/analyze', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          sideA: sideAPlayers.map(name => ({ type: 'player', player: { name, pos: 'UNKNOWN' } })),
          sideB: sideBPlayers.map(name => ({ type: 'player', player: { name, pos: 'UNKNOWN' } })),
          format: inlineTradeFormat,
          leagueId: tradeSelectedLeague || undefined,
          username: username || undefined,
          numTeams: effectiveNumTeams,
        })
      })
      const rawResponse = await res.json()
      if (!res.ok) {
        setInlineTradeError(rawResponse.error || 'Failed to analyze trade')
        return
      }
      const data = rawResponse.data || rawResponse
      const confidenceRisk = rawResponse.confidenceRisk
      const ok = await triggerGuardianCheck({
        actionType: 'trade',
        sideAPlayers,
        sideBPlayers,
        tradeGrade: data.grade,
        verdict: data.verdict,
        fairnessScore: data.fairnessScore || data.balanceScore,
        netDelta: data.netDelta ? parseFloat(String(data.netDelta)) : undefined,
        winProbShift: data.winProbabilityShift,
        confidenceRisk: confidenceRisk,
        format: inlineTradeFormat,
        acceptancePct: data.acceptancePct,
        acceptanceDrivers: data.acceptanceDrivers,
        failureRiskLine: data.failureRiskLine,
        tier: data.tier,
        totalAssets: sideAPlayers.length + sideBPlayers.length,
      })
      if (!ok) return

      const ea = rawResponse.engineAnalysis
      const engineCounters = ea?.counters || data.counters
      const engineChampEq = ea?.championshipEquity || data.championshipEquity
      const engineReqForSim = rawResponse.engineRequest || undefined
      const acceptBuckets = ea?.acceptanceProbability?.buckets || null
      const offseasonCtx = rawResponse.offseasonContext || null
      setInlineTradeResult({ ...data, confidenceRisk, counters: engineCounters || data.counters, championshipEquity: engineChampEq, engineRequest: engineReqForSim, acceptanceBuckets: acceptBuckets, offseasonContext: offseasonCtx })
      setLastTradeResult({
        sideA: sideAPlayers.map(name => ({ name })),
        sideB: sideBPlayers.map(name => ({ name })),
        grade: data.grade,
        verdict: data.verdict,
        leagueType: inlineTradeFormat
      })
      trackToolUse('trade_analyzer', { format: inlineTradeFormat })
    } catch {
      setInlineTradeError('Network error - please try again')
    } finally {
      setInlineTradeLoading(false)
    }
  }

  const triggerGuardianCheck = async (actionData: Record<string, unknown>): Promise<boolean> => {
    if (guardianVisible) return false
    if (guardianResolveRef.current) {
      guardianResolveRef.current(false)
      guardianResolveRef.current = null
    }
    try {
      const res = await fetch('/api/legacy/decision-guardian/evaluate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: actionData,
          userId: username || undefined,
          leagueId: tradeSelectedLeague || activeTradeLeagueId || undefined,
          logIntervention: true,
        }),
      })
      if (!res.ok) return true

      const data = await res.json()

      if (!data.success || !(data.showModal ?? data.evaluation?.shouldIntervene)) return true

      setGuardianEval(data.evaluation)
      setGuardianPayload(data)
      setGuardianInterventionId(data.interventionId || null)
      setGuardianActionType(actionData.actionType as 'trade' | 'player_drop' | 'faab_bid')
      setGuardianVisible(true)

      return await new Promise<boolean>((resolve) => {
        guardianResolveRef.current = resolve
      })
    } catch {
      return true
    }
  }

  const closeGuardian = (proceed: boolean) => {
    setGuardianVisible(false)
    const r = guardianResolveRef.current
    guardianResolveRef.current = null
    if (r) r(proceed)
  }

  // Load managers when Trade Hub league is selected
  const loadTradeHubManagers = async (leagueId: string) => {
    if (!leagueId) {
      setTradeHubManagers([])
      setTradeHubTeamA('')
      setTradeHubTeamB('')
      setProposalTargetTeam('')
      setProposalDesiredAssets([])
      setProposalResults([])
      setProposalError('')
      return
    }
    
    setTradeHubLoading(true)
    // Also sync with Trade Ideas Generator league selection
    setTradeSelectedLeague(leagueId)
    
    try {
      // Default to NFL for sport (Sleeper is primarily NFL focused)
      const sport = 'nfl'
      
      const res = await fetch(`/api/legacy/trade/league-managers?league_id=${leagueId}&sport=${sport}`)
      const data = await res.json()
      
      if (data.success && data.managers) {
        setTradeHubManagers(data.managers)
        setTradeHubRosterPositions(data.leagueSettings?.rosterPositions || [])
        setTradeHubLeagueSettings(data.leagueSettings || null)
        
        // Find the current user's team and set as Team A default
        const userTeam = data.managers.find((m: any) => 
          m.displayName?.toLowerCase() === username?.toLowerCase() ||
          m.userId === username
        )
        if (userTeam) {
          setTradeHubTeamA(String(userTeam.rosterId))
        } else if (data.managers.length > 0) {
          setTradeHubTeamA(String(data.managers[0].rosterId))
        }
        
        // Reset selections
        setTradeHubTeamB('')
        setTradeHubPlayersA([])
        setTradeHubPlayersB([])
        setTradeHubPicksA([])
        setProposalTargetTeam('')
        setProposalDesiredAssets([])
        setProposalResults([])
        setProposalError('')
        setTradeHubPicksB([])
        setTradeHubFaabA(0)
        setTradeHubFaabB(0)
      }
    } catch (e) {
      console.error('Failed to load league managers:', e)
    } finally {
      setTradeHubLoading(false)
    }
  }

  const quickEvalAbortRef = useRef<AbortController | null>(null)
  const quickEvalTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null)

  useEffect(() => {
    if (quickEvalTimerRef.current) clearTimeout(quickEvalTimerRef.current)
    if (quickEvalAbortRef.current) quickEvalAbortRef.current.abort()

    const teamA = tradeHubManagers.find(m => String(m.rosterId) === tradeHubTeamA)
    const teamB = tradeHubManagers.find(m => String(m.rosterId) === tradeHubTeamB)
    if (!teamA || !teamB) { setTradeHubLivePreview(null); return }

    const hasAssets = tradeHubPlayersA.length > 0 || tradeHubPicksA.length > 0 || tradeHubFaabA > 0 ||
                      tradeHubPlayersB.length > 0 || tradeHubPicksB.length > 0 || tradeHubFaabB > 0
    if (!hasAssets) { setTradeHubLivePreview(null); return }

    quickEvalTimerRef.current = setTimeout(async () => {
      const controller = new AbortController()
      quickEvalAbortRef.current = controller
      setTradeHubLiveLoading(true)

      const buildQuickAssets = (players: string[], picks: string[], faab: number, manager: any): any[] => {
        const items: any[] = []
        players.forEach(pid => {
          const p = manager.players.find((pl: any) => String(pl.id) === String(pid))
          const id = String(p?.id || pid).trim()
          const team = p?.team ? String(p.team).trim() : undefined
          if (p) items.push({ type: 'player', name: p.name, pos: p.pos, team, id, media: { headshotUrl: headshotUrl(id), teamLogoUrl: teamLogoUrl(team) } })
        })
        picks.forEach(pickKey => {
          const [season, round, , slot] = pickKey.split('|')
          items.push({ type: 'pick', year: parseInt(season), round: parseInt(round), pickNumber: slot ? parseInt(slot) : undefined })
        })
        if (faab > 0) items.push({ type: 'faab', amount: faab })
        return items
      }

      const benchCandidates = teamB.players
        .filter((p: any) => !tradeHubPlayersB.includes(p.id) && !(teamB.starters || []).includes(p.id))
        .slice(0, 15)
        .map((p: any) => {
          const id = String(p.id || '').trim()
          const team = p.team ? String(p.team).trim() : undefined
          return { type: 'player' as const, name: p.name, pos: p.pos, team, id, media: { headshotUrl: headshotUrl(id), teamLogoUrl: teamLogoUrl(team) } }
        })

      try {
        const res = await fetch('/api/legacy/trade/quick-evaluate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          signal: controller.signal,
          body: JSON.stringify({
            assetsYouGet: buildQuickAssets(tradeHubPlayersA, tradeHubPicksA, tradeHubFaabA, teamA),
            assetsYouGive: buildQuickAssets(tradeHubPlayersB, tradeHubPicksB, tradeHubFaabB, teamB),
            yourRoster: teamA.players,
            theirRoster: teamB.players,
            yourStarters: teamA.starters || [],
            theirStarters: teamB.starters || [],
            rosterPositions: tradeHubRosterPositions,
            format: inlineTradeFormat,
            numTeams: effectiveNumTeams,
            leagueId: activeTradeLeagueId,
            opponentUsername: teamB.displayName,
            sleeperUserA: { username: teamA.username || teamA.displayName, userId: teamA.userId || '' },
            sleeperUserB: { username: teamB.username || teamB.displayName, userId: teamB.userId || '' },
            leagueContext: tradeHubLeagueSettings ? {
              season: parseInt(tradeHubLeagueSettings.season) || new Date().getFullYear(),
              numTeams: tradeHubLeagueSettings.numTeams || effectiveNumTeams,
              settings: {
                qbFormat: tradeHubLeagueSettings.flags?.isSuperFlex ? 'superflex' : '1qb',
                tep: { enabled: !!tradeHubLeagueSettings.flags?.isTEP, premiumPprBonus: tradeHubLeagueSettings.scoring?.tepBonus ?? 0 },
                ppr: tradeHubLeagueSettings.scoring?.ppr ?? 1.0,
              },
              roster: { slots: tradeHubLeagueSettings.roster?.slots || {} },
            } : undefined,
            suggestSweetener: true,
            sweetenerCandidates: benchCandidates,
          }),
        })
        if (!controller.signal.aborted && res.ok) {
          const data = await res.json()
          if (data.success) setTradeHubLivePreview(data)
        }
      } catch (e: any) {
        if (e?.name !== 'AbortError') console.error('quick-evaluate error:', e)
      } finally {
        setTradeHubLiveLoading(false)
      }
    }, 400)

    return () => {
      if (quickEvalTimerRef.current) clearTimeout(quickEvalTimerRef.current)
      if (quickEvalAbortRef.current) quickEvalAbortRef.current.abort()
    }
  }, [tradeHubPlayersA, tradeHubPlayersB, tradeHubPicksA, tradeHubPicksB, tradeHubFaabA, tradeHubFaabB, tradeHubTeamA, tradeHubTeamB, tradeHubManagers, tradeHubRosterPositions, inlineTradeFormat, effectiveNumTeams, activeTradeLeagueId])

  // Generate trade report from Trade Hub selections
  const generateTradeHubReport = async () => {
    const teamA = tradeHubManagers.find(m => String(m.rosterId) === tradeHubTeamA)
    const teamB = tradeHubManagers.find(m => String(m.rosterId) === tradeHubTeamB)
    
    if (!teamA || !teamB) {
      setInlineTradeError('Please select both teams')
      return
    }
    
    const hasAssets = tradeHubPlayersA.length > 0 || tradeHubPicksA.length > 0 || tradeHubFaabA > 0 ||
                      tradeHubPlayersB.length > 0 || tradeHubPicksB.length > 0 || tradeHubFaabB > 0
    if (!hasAssets) {
      setInlineTradeError('Please select assets to trade')
      return
    }
    
    setInlineTradeLoading(true)
    setInlineTradeError('')
    setInlineTradeResult(null)
    setShowTradeHubIdeas(true)
    setTradeHubIdeasLoading(true)
    
    // Build trade sides
    const buildSide = (players: string[], picks: string[], faab: number, manager: any) => {
      const items: any[] = []
      
      players.forEach(pid => {
        const player = manager.players.find((p: any) => String(p.id) === String(pid))
        if (!player) return

        const id = String(player.id || '').trim()
        const team = player.team ? String(player.team).trim() : undefined

        if (!id) {
          console.warn('Missing player id in trade build:', player)
          return
        }

        items.push({
          type: 'player',
          player: {
            id,
            name: player.name,
            pos: player.pos,
            team,
            media: {
              headshotUrl: headshotUrl(id),
              teamLogoUrl: team ? teamLogoUrl(team) : '',
            },
          },
        })
      })
      
      picks.forEach(pickKey => {
        const [season, round, originalOwner, slot] = pickKey.split('|')
        items.push({ 
          type: 'pick', 
          pick: { 
            year: parseInt(season), 
            round: parseInt(round) as 1 | 2 | 3 | 4,
            pickNumber: slot ? parseInt(slot) : undefined,
            originalOwner 
          } 
        })
      })
      
      if (faab > 0) {
        items.push({ type: 'faab', faab: { amount: faab } })
      }
      
      return items
    }
    
    const sideA = buildSide(tradeHubPlayersA, tradeHubPicksA, tradeHubFaabA, teamA)
    const sideB = buildSide(tradeHubPlayersB, tradeHubPicksB, tradeHubFaabB, teamB)
    
    const enrichRoster = (players: any[]) => players.map((p: any) => {
      const id = String(p.id || '').trim()
      const team = p.team ? String(p.team).trim() : undefined
      return { id, name: p.name, pos: p.pos, team, media: { headshotUrl: id ? headshotUrl(id) : '', teamLogoUrl: team ? teamLogoUrl(team) : '' } }
    })

    const ls = tradeHubLeagueSettings
    const leagueContext = ls ? {
      season: parseInt(ls.season) || new Date().getFullYear(),
      phase: ls.status === 'in_season' ? 'in_season' : ls.status === 'complete' ? 'offseason' : ls.seasonType || 'unknown',
      numTeams: ls.numTeams || effectiveNumTeams,
      settings: {
        qbFormat: ls.flags?.isSuperFlex ? 'superflex' : '1qb',
        tep: { enabled: !!ls.flags?.isTEP, premiumPprBonus: ls.scoring?.tepBonus ?? 0 },
        ppr: ls.scoring?.ppr ?? 1.0,
        ppCarry: ls.scoring?.ppCarry ?? 0,
        ppCompletion: ls.scoring?.ppCompletion ?? 0,
        sixPtPassTd: !!ls.scoring?.sixPtPassTd,
        idp: !!ls.flags?.idp,
      },
      roster: {
        slots: ls.roster?.slots || {},
        limits: { maxRoster: ls.roster?.maxRoster || 0 },
      },
      trade: {
        vetoType: ls.trade?.vetoType || 'none',
        tradeDeadlineWeek: ls.trade?.tradeDeadlineWeek ?? 99,
        faabTradable: !!ls.trade?.faabTradable,
      },
    } : undefined

    try {
      const res = await fetch('/api/legacy/trade/analyze', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          sport: 'NFL',
          format: inlineTradeFormat,
          league_id: tradeHubLeague,
          sleeper_username_a: teamA.displayName,
          sleeper_username_b: teamB.displayName,
          sleeperUserA: { username: teamA.username || teamA.displayName, userId: teamA.userId || '' },
          sleeperUserB: { username: teamB.username || teamB.displayName, userId: teamB.userId || '' },
          assetsA: sideA,
          assetsB: sideB,
          tradeGoal: tradeHubGoal || undefined,
          numTeams: effectiveNumTeams,
          leagueContext,
          rosterA: enrichRoster(teamA.players),
          rosterB: enrichRoster(teamB.players),
          user_roster_id: Number(tradeHubTeamA),
          partner_roster_id: Number(tradeHubTeamB),
        })
      })
      
      const rawResponse = await res.json()
      if (!res.ok) {
        setInlineTradeError(rawResponse.error || 'Failed to analyze trade')
        return
      }
      
      const data = rawResponse.data || rawResponse
      const confidenceRisk = rawResponse.confidenceRisk
      
      const sideANames = sideA.map((item: any) => item.player?.name || `${item.pick?.season} ${item.pick?.round}rd` || `$${item.amount} FAAB`)
      const sideBNames = sideB.map((item: any) => item.player?.name || `${item.pick?.season} ${item.pick?.round}rd` || `$${item.amount} FAAB`)
      const ok = await triggerGuardianCheck({
        actionType: 'trade',
        sideAPlayers: sideANames,
        sideBPlayers: sideBNames,
        tradeGrade: data.grade,
        verdict: data.verdict,
        fairnessScore: data.fairnessScore || data.balanceScore,
        netDelta: data.netDelta ? parseFloat(String(data.netDelta)) : undefined,
        winProbShift: data.winProbabilityShift,
        confidenceRisk: confidenceRisk,
        format: inlineTradeFormat,
        acceptancePct: data.acceptancePct,
        acceptanceDrivers: data.acceptanceDrivers,
        failureRiskLine: data.failureRiskLine,
        tier: data.tier,
        totalAssets: sideA.length + sideB.length,
      })
      if (!ok) return

      const ea2 = rawResponse.engineAnalysis
      const engineCounters2 = ea2?.counters || data.counters
      const engineChampEq2 = ea2?.championshipEquity || data.championshipEquity
      const engineReqForSim2 = rawResponse.engineRequest || undefined
      const acceptBuckets2 = ea2?.acceptanceProbability?.buckets || null
      const offseasonCtx2 = rawResponse.offseasonContext || null
      setInlineTradeResult({ ...data, confidenceRisk, counters: engineCounters2 || data.counters, championshipEquity: engineChampEq2, engineRequest: engineReqForSim2, acceptanceBuckets: acceptBuckets2, offseasonContext: offseasonCtx2 })
      setLastTradeResult({
        sideA: sideA.map((item: any) => ({ name: item.player?.name || item.pick?.season + ' ' + item.pick?.round + 'rd' || `$${item.amount} FAAB` })),
        sideB: sideB.map((item: any) => ({ name: item.player?.name || item.pick?.season + ' ' + item.pick?.round + 'rd' || `$${item.amount} FAAB` })),
        grade: data.grade,
        verdict: data.verdict,
        leagueType: inlineTradeFormat
      })
      
      generateTradeHubIdeas(teamA, teamB)
      
    } catch (e) {
      setInlineTradeError('Network error - please try again')
    } finally {
      setInlineTradeLoading(false)
    }
  }

  // Analyze team needs based on roster composition
  const analyzeTeamNeeds = (manager: any) => {
    const posCount: Record<string, number> = { QB: 0, RB: 0, WR: 0, TE: 0 }
    manager.players?.forEach((p: any) => {
      if (posCount[p.pos] !== undefined) posCount[p.pos]++
    })
    
    const needs: string[] = []
    if (posCount.QB < 2) needs.push('QB')
    if (posCount.RB < 4) needs.push('RB')
    if (posCount.WR < 4) needs.push('WR')
    if (posCount.TE < 2) needs.push('TE')
    
    const isContending = manager.record.wins > manager.record.losses
    const status = isContending ? 'contending' : 'rebuilding'
    
    return { needs, status, record: manager.record, posCount }
  }

  const triggerHighlight = (id: string) => {
    setRecentlyAddedIds(prev => [...prev, id])
    setToast(`Added player to trade`)
    setTimeout(() => setToast(null), 1500)
    setTimeout(() => {
      setRecentlyAddedIds(prev => prev.filter(x => x !== id))
    }, 1200)
  }

  const addCounterCandidateToGive = (playerId: string) => {
    if (!playerId) return
    setTradeHubPlayersB(prev => {
      if (prev.includes(playerId)) return prev
      return [...prev, playerId]
    })
    triggerHighlight(playerId)
    setTimeout(() => {
      sideBRef.current?.scrollIntoView({ behavior: "smooth", block: "center" })
    }, 100)
  }

  const addCounterCandidateToGet = (playerId: string) => {
    if (!playerId) return
    setTradeHubPlayersA(prev => {
      if (prev.includes(playerId)) return prev
      return [...prev, playerId]
    })
    triggerHighlight(playerId)
    setTimeout(() => {
      sideARef.current?.scrollIntoView({ behavior: "smooth", block: "center" })
    }, 100)
  }

  const handleShareReward = async (shareType: 'trade_result' | 'rankings' | 'portfolio') => {
    if (!username) {
      setShareRewardMessage({ type: 'error', text: 'Please connect your Sleeper account first' })
      return
    }
    
    setShareRewardLoading(true)
    setShareRewardMessage(null)
    
    try {
      let shareContent: any = {}
      if (shareType === 'trade_result' && inlineTradeResult) {
        shareContent = {
          grade: inlineTradeResult.grade,
          verdict: inlineTradeResult.verdict,
          leagueType: inlineTradeFormat
        }
      }
      
      const res = await fetch('/api/legacy/share-reward', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          leagueId: reportCardLeague || null,
          shareType,
          shareContent,
          platform: 'twitter'
        })
      })
      
      const data = await res.json()
      
      if (data.alreadyClaimed) {
        setShareRewardMessage({ type: 'info', text: data.message })
        setCanShareToday(false)
      } else if (data.success) {
        setShareRewardMessage({ type: 'success', text: data.message })
        setShareRewardTokens(data.totalUnredeemedTokens || 0)
        setCanShareToday(false)
        
        const tweetText = encodeURIComponent(
          `Just analyzed a trade on @AllFantasyAI and got a ${inlineTradeResult?.grade || 'A'} grade! üèà\n\nVerdict: ${inlineTradeResult?.verdict || 'Fair Trade'}\n\n#FantasyFootball #Dynasty`
        )
        window.open(`https://twitter.com/intent/tweet?text=${tweetText}`, '_blank')
      } else {
        setShareRewardMessage({ type: 'error', text: data.error || 'Failed to record share' })
      }
    } catch (error) {
      setShareRewardMessage({ type: 'error', text: 'Network error' })
    } finally {
      setShareRewardLoading(false)
    }
  }

  // Load and grade trade history for Report Card
  const loadTradeHistoryReportCard = async (leagueId: string, selectedYear: string = 'all') => {
    if (!leagueId) {
      setReportCardTradesByYear({})
      setReportCardSummary(null)
      return
    }
    
    setReportCardLoading(true)
    setReportCardTradesByYear({})
    setReportCardSummary(null)
    setTradeAnalytics(null)
    
    try {
      // Fetch the user's trades from all years of this league
      const fetchRes = await fetch('/api/legacy/trade-history', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          leagueId,
          userId: profile?.sleeper_user_id || username,
          action: 'fetch'
        })
      })
      
      const fetchData = await fetchRes.json()
      if (!fetchRes.ok || !fetchData.tradesByYear) {
        console.error('Failed to fetch trades:', fetchData.error)
        setReportCardLoading(false)
        return
      }
      
      // Store ALL available years for dropdown (from API - includes all seasons even if no trades)
      const allLeagueYears = (fetchData.allSeasons as string[] || Object.keys(fetchData.tradesByYear as Record<string, any[]>))
        .sort((a, b) => parseInt(b) - parseInt(a))
      setReportCardAvailableYears(allLeagueYears)
      
      // Store waiver activity
      if (fetchData.waiverActivity) {
        setWaiverActivity(fetchData.waiverActivity)
        setWaiverMVP(fetchData.waiverMVP)
      }
      
      // Filter to only user's trades and count total
      const userTradesByYear: Record<string, any[]> = {}
      let totalUserTrades = 0
      
      for (const [year, trades] of Object.entries(fetchData.tradesByYear as Record<string, any[]>)) {
        const userTrades = trades.filter((t: any) => t.userInvolved)
        if (userTrades.length > 0) {
          userTradesByYear[year] = userTrades
          totalUserTrades += userTrades.length
        }
      }
      
      if (totalUserTrades === 0) {
        setReportCardSummary({ 
          noTrades: true, 
          message: 'No trades found for you in this league' 
        })
        setReportCardLoading(false)
        return
      }
      
      const resolvedYear = selectedYear === 'current' 
        ? (allLeagueYears[0] || String(new Date().getFullYear())) 
        : selectedYear
      const filteredTradesByYear: Record<string, any[]> = resolvedYear === 'all' 
        ? userTradesByYear 
        : { [resolvedYear]: userTradesByYear[resolvedYear] || [] }
      
      // Grade trades year by year
      const gradedTradesByYear: Record<string, any[]> = {}
      const allGradedTrades: any[] = []
      
      // Sort years newest to oldest
      const sortedYears = Object.keys(filteredTradesByYear).sort((a, b) => parseInt(b) - parseInt(a))
      
      for (const year of sortedYears) {
        const trades = filteredTradesByYear[year]
        if (!trades || trades.length === 0) continue
        gradedTradesByYear[year] = []
        
        for (const trade of trades.slice(0, 5)) { // Limit to 5 per year
          try {
            const gradeRes = await fetch('/api/legacy/trade-history', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                leagueId,
                userId: profile?.sleeper_user_id || username,
                action: 'grade',
                trade
              })
            })
            
            const gradeData = await gradeRes.json()
            if (gradeData.gradedTrade) {
              const gradedTrade = {
                ...trade,
                grade: gradeData.gradedTrade.grade,
                verdict: gradeData.gradedTrade.briefExplanation || gradeData.gradedTrade.verdict,
                analysis: gradeData.gradedTrade.fullAnalysis || gradeData.gradedTrade.analysis,
                winner: gradeData.gradedTrade.winner
              }
              gradedTradesByYear[year].push(gradedTrade)
              allGradedTrades.push(gradedTrade)
            }
          } catch (e) {
            console.error('Failed to grade trade:', e)
            const failedTrade = { ...trade, grade: 'N/A', verdict: 'Unable to grade' }
            gradedTradesByYear[year].push(failedTrade)
            allGradedTrades.push(failedTrade)
          }
        }
      }
      
      setReportCardTradesByYear(gradedTradesByYear)
      
      if (allGradedTrades.length === 0) {
        setReportCardSummary({ 
          noTrades: true, 
          message: resolvedYear === 'all' 
            ? 'No trades found for you in this league' 
            : `No trades found for the ${resolvedYear} season`
        })
        setReportCardLoading(false)
        return
      }
      
      // Calculate summary stats from all graded trades
      const gradeToScore: Record<string, number> = { 'A+': 10, 'A': 9, 'A-': 8, 'B+': 7, 'B': 6, 'B-': 5, 'C+': 4, 'C': 3, 'C-': 2, 'D': 1, 'F': 0 }
      const validGrades = allGradedTrades.filter(t => gradeToScore[t.grade] !== undefined)
      const avgScore = validGrades.length > 0 
        ? validGrades.reduce((sum, t) => sum + (gradeToScore[t.grade] || 0), 0) / validGrades.length
        : null
      
      const overallGrade = avgScore !== null 
        ? Object.entries(gradeToScore).find(([g, s]) => Math.abs(s - avgScore) < 1)?.[0] || 'C'
        : 'N/A'
      
      // Count wins/losses based on whether the USER was the winner, not trade fairness
      // winner field contains the displayName of whoever got the better side
      const userPartyNames = allGradedTrades.map(t => {
        const userParty = t.parties?.find((p: any) => p.rosterId === t.userRosterId)
        return userParty?.displayName?.toLowerCase() || username.toLowerCase()
      })
      
      const wins = allGradedTrades.filter((t, i) => {
        if (!t.winner || t.winner === 'Even') return false
        const winnerLower = t.winner.toLowerCase()
        const userNameLower = username.toLowerCase()
        // Check if winner matches user's name or party name
        return winnerLower === userNameLower || 
               winnerLower.includes(userNameLower) || 
               userNameLower.includes(winnerLower) ||
               (userPartyNames[i] && winnerLower === userPartyNames[i])
      }).length
      
      const losses = allGradedTrades.filter((t, i) => {
        if (!t.winner || t.winner === 'Even') return false
        const winnerLower = t.winner.toLowerCase()
        const userNameLower = username.toLowerCase()
        // If there's a winner and it's NOT the user, it's a loss
        const isUserWinner = winnerLower === userNameLower || 
                             winnerLower.includes(userNameLower) || 
                             userNameLower.includes(winnerLower) ||
                             (userPartyNames[i] && winnerLower === userPartyNames[i])
        return !isUserWinner
      }).length
      
      const fair = allGradedTrades.filter(t => !t.winner || t.winner === 'Even').length
      
      setReportCardSummary({
        totalTrades: allGradedTrades.length,
        yearCount: sortedYears.length,
        overallGrade,
        wins,
        losses,
        fair,
        avgScore: avgScore?.toFixed(1)
      })
      
      // Cache trades for re-fetching with different modes
      setAnalyticsTradesCache({
        league_id: leagueId,
        sleeper_username: username,
        sleeper_user_id: profile?.sleeper_user_id,
        trades: allGradedTrades,
        managers: fetchData.managers || {},
        league: fetchData.leagueInfo
      })
      
      // Fetch comprehensive trade analytics
      setAnalyticsLoading(true)
      try {
        const analyticsRes = await fetch('/api/legacy/trade-analytics', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            league_id: leagueId,
            sleeper_username: username,
            sleeper_user_id: profile?.sleeper_user_id,
            trades: allGradedTrades,
            managers: fetchData.managers || {},
            mode: valuationMode,
            league: fetchData.leagueInfo
          })
        })
        const analyticsData = await analyticsRes.json()
        if (analyticsRes.ok) {
          setTradeAnalytics(analyticsData)
        }
      } catch (analyticsErr) {
        console.error('Trade analytics error:', analyticsErr)
      } finally {
        setAnalyticsLoading(false)
      }
      
    } catch (e) {
      console.error('Trade history report card error:', e)
    } finally {
      setReportCardLoading(false)
    }
  }

  // Generate AI trade ideas for the user
  const generateTradeHubIdeas = async (teamA: any, teamB: any) => {
    try {
      const league = leagues.find(l => l.league_id === tradeHubLeague)
      
      const res = await fetch('/api/legacy/trade-ideas', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          leagueId: tradeHubLeague,
          username,
          goals: `Generate trade ideas for ${teamA.displayName} based on their roster needs and the assets available across the league. Consider team needs, win-now vs rebuild status, and fair value.`,
          depth: 'fast',
          count: 3,
          managers: tradeHubManagers,
          focusTeam: teamA.displayName,
          leagueName: league?.name,
        })
      })
      
      const data = await res.json()
      if (data.ideas) {
        setTradeHubIdeas(data.ideas)
      }
    } catch (e) {
      console.error('Failed to generate trade ideas:', e)
    } finally {
      setTradeHubIdeasLoading(false)
    }
  }

  const handleTransfer = async (overrideLeagueId?: string) => {
    const leagueIdToUse = overrideLeagueId || transferLeagueId.trim()
    if (!leagueIdToUse) {
      setTransferError('Please enter a League ID')
      return
    }
    if (overrideLeagueId) {
      setTransferLeagueId(overrideLeagueId)
    }
    setTransferLoading(true)
    setTransferError('')
    setTransferPreview(null)
    try {
      const res = await fetch('/api/legacy/transfer', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ leagueId: leagueIdToUse })
      })
      const data = await res.json()
      if (!res.ok) {
        setTransferError(data.error || 'Failed to fetch league')
        return
      }
      setTransferPreview(data.preview)
    } catch {
      setTransferError('Network error - please try again')
    } finally {
      setTransferLoading(false)
    }
  }

  const getPlayerName = (id: string) => {
    const player = playerNames[id]
    return player?.name || id
  }

  const getPlayerPosition = (id: string) => {
    const player = playerNames[id]
    return player?.position || ''
  }

  // UX cooldowns (per action)
  const [rankCooldownMs, setRankCooldownMs] = useState(0)
  const [aiCoachCooldownMs, setAiCoachCooldownMs] = useState(0)
  const [shareCooldownMs, setShareCooldownMs] = useState(0)

  // Username is entered fresh each time - no localStorage persistence

  // Handle deep linking from email notifications, shared links, and back navigation
  useEffect(() => {
    const tab = searchParams.get('tab')
    const tradeId = searchParams.get('trade')
    const sharedLeague = searchParams.get('league')
    
    if (tab === 'notifications') {
      setShowTradeNotifs(true)
      
      if (tradeId) {
        setHighlightedTradeId(tradeId)
        const timer = setTimeout(() => setHighlightedTradeId(null), 10000)
        return () => clearTimeout(timer)
      }
    } else if (tab === 'rankings' && sharedLeague) {
      handleActiveTabChange('rankings')
      setPendingShareLeague(sharedLeague)
    } else if (tab && ['overview', 'trade', 'finder', 'waiver', 'compare', 'chat', 'share', 'rankings'].includes(tab)) {
      handleActiveTabChange(tab as Tab)
    }
  }, [searchParams])

  // Only pre-fill username from sessionStorage - don't auto-import
  // User should always see the username input screen and manually click to load
  useEffect(() => {
    if (typeof window !== 'undefined' && !username && importStatus === 'idle') {
      const saved = sessionStorage.getItem('af_legacy_username')
      if (saved) {
        setUsernameState(saved)
        // Don't auto-trigger import - let user click the button
      }
    }
  }, []) // eslint-disable-line react-hooks/exhaustive-deps
  
  // Load Fantrax username and leagues from sessionStorage on mount
  useEffect(() => {
    if (typeof window !== 'undefined') {
      const savedFantrax = sessionStorage.getItem('af_fantrax_username')
      if (savedFantrax && !fantraxUsername) {
        setFantraxUsername(savedFantrax)
        fetchFantraxLeagues(savedFantrax)
      }
    }
  }, []) // eslint-disable-line react-hooks/exhaustive-deps

  // Load custom platforms from localStorage on mount
  useEffect(() => {
    if (typeof window !== 'undefined') {
      try {
        const saved = localStorage.getItem('af_custom_platforms')
        if (saved) setCustomPlatforms(JSON.parse(saved))
      } catch {}
    }
  }, [])

  // Fetch CFB/Devy player data from CFBD API when Fantrax username is available
  useEffect(() => {
    const fetchC2cDevyRoster = async () => {
      if (!fantraxUsername || c2cDevyRoster.length > 0) return
      
      setC2cDevyLoading(true)
      try {
        const res = await fetch(`/api/legacy/cfb-players?action=fantrax-roster&username=${encodeURIComponent(fantraxUsername)}`)
        const data = await res.json()
        
        if (data.roster && data.roster.length > 0) {
          setC2cDevyRoster(data.roster)
          setC2cDevyLeague(data.league)
        }
      } catch (error) {
        console.error('Failed to fetch CFB devy roster:', error)
      } finally {
        setC2cDevyLoading(false)
      }
    }

    if (fantraxUsername && fantraxLeagues.some((l: any) => l.isDevy)) {
      fetchC2cDevyRoster()
    }
  }, [fantraxUsername, fantraxLeagues]) // eslint-disable-line react-hooks/exhaustive-deps
  
  // Helper to trigger a fresh import for saved username
  const triggerFreshImport = async (uname: string) => {
    const clean = uname.trim().toLowerCase()
    setLoading(true)
    setError('')
    
    try {
      const res = await fetch('/api/legacy/import', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sleeper_username: clean }),
      })
      const data = await res.json()
      
      if (!res.ok) {
        // If import fails, just load cached profile
        await loadProfile(clean)
        setLoading(false)
        return
      }
      
      if (data.job_id) {
        setJobId(data.job_id)
        setImportStatus('importing')
      } else if (data.profile) {
        // Already imported recently, data is fresh
        setProfile(data.profile)
        setStats(data.standard_stats ?? data.stats ?? null)
        setSpecialtyStats(data.specialty_stats ?? null)
        setLeagues(Array.isArray(data.league_history) ? data.league_history : [])
        setSeasonBreakdown(Array.isArray(data.season_breakdown) ? data.season_breakdown : [])
        setAiReport(data.latest_ai_report ?? null)
        setRankingPreview(data.ranking_preview ?? null);
        setImportStatus('complete');
        
        (window as any).gtag?.('event', 'legacy_import_complete', {
          event_category: 'Legacy',
          event_label: 'Import Complete',
          value: 1,
        })
        
        const tutorialSeen = localStorage.getItem('af-legacy-tutorial-seen')
        if (!tutorialSeen) {
          setTimeout(() => setShowTutorial(true), 500)
        }
      }
    } catch (e) {
      // Fallback to cached profile on error
      await loadProfile(clean)
    } finally {
      setLoading(false)
    }
  }

  // Auto-navigate to rankings tab with shared league after import completes
  useEffect(() => {
    if (importStatus === 'complete' && username && pendingShareLeague) {
      const sharedLeague = pendingShareLeague
      setPendingShareLeague(null)
      handleActiveTabChange('rankings')
      const loadAndRun = async () => {
        try {
          const res = await fetch(`/api/legacy/waiver/leagues?sleeper_username=${encodeURIComponent(username)}`)
          const data = await res.json()
          if (data.ok && data.leagues) {
            setRankingsDynastyLeagues(data.leagues)
            const leagueExists = data.leagues.some((l: any) => l.league_id === sharedLeague)
            if (leagueExists) {
              setRankingsSelectedLeague(sharedLeague)
              runRankingsAnalysis(sharedLeague)
            } else {
              setRankingsSelectedLeague(data.leagues[0]?.league_id || '')
              setRankingsError('The shared league was not found in your leagues. Showing your first league instead.')
            }
          }
        } catch {
          console.error('Failed to auto-load rankings from shared link')
        }
      }
      loadAndRun()
    }
  }, [importStatus, username, pendingShareLeague])

  // countdown tick
  useEffect(() => {
    const anyActive = rankCooldownMs > 0 || aiCoachCooldownMs > 0 || shareCooldownMs > 0
    if (!anyActive) return

    const interval = setInterval(() => {
      setRankCooldownMs((ms) => Math.max(0, ms - 250))
      setAiCoachCooldownMs((ms) => Math.max(0, ms - 250))
      setShareCooldownMs((ms) => Math.max(0, ms - 250))
    }, 250)

    return () => clearInterval(interval)
  }, [rankCooldownMs, aiCoachCooldownMs, shareCooldownMs])

  useEffect(() => {
    if (!username || importStatus !== 'importing') return

    let stop = false

    const pollStatus = async () => {
      if (stop) return

      try {
        const res = await fetch(
          `/api/legacy/import/status?sleeper_username=${encodeURIComponent(username)}`,
          { cache: 'no-store' }
        )
        const data = await res.json()
        const nextJob = data.job ?? data

        if (!stop && nextJob?.status) {
          setImportProgress(nextJob.progress || 0)

          if (nextJob.status === 'completed') {
            setImportStatus('complete');
            loadProfile(username);
            
            (window as any).gtag?.('event', 'legacy_import_complete', {
              event_category: 'Legacy',
              event_label: 'Import Complete',
              value: 1,
            })
            
            const tutorialSeen = localStorage.getItem('af-legacy-tutorial-seen')
            if (!tutorialSeen) {
              setTimeout(() => setShowTutorial(true), 500)
            }
            return
          } else if (nextJob.status === 'failed') {
            setError(nextJob.error || 'Import failed')
            setImportStatus('idle')
            return
          } else if (nextJob.status === 'queued' || nextJob.status === 'running') {
            fetch('/api/legacy/worker/run', { method: 'GET', cache: 'no-store' }).catch(() => {})
          }
        }
      } catch {}

      setTimeout(pollStatus, 3000)
    }

    pollStatus()

    return () => {
      stop = true
    }
  }, [username, importStatus])

  // Check quiz status when finder tab is opened
  useEffect(() => {
    if (activeTab === 'finder' && username && !quizChecked) {
      checkQuizStatus()
    }
  }, [activeTab, username, quizChecked]) // eslint-disable-line react-hooks/exhaustive-deps

  const handleImport = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!username.trim()) return
    setError('')
    setLoading(true)

    try {
      const res = await fetch('/api/legacy/import', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sleeper_username: username.trim() }),
      })
      const data = await res.json()

      if (!res.ok) {
        setError(data.error || 'Failed to start import')
        setLoading(false)
        return
      }

      setJobId(data.job_id)
      setImportStatus('importing')
      setProfile({
        sleeper_username: username,
        sleeper_user_id: data.sleeper_user_id,
        display_name: data.display_name,
        avatar: data.avatar,
        import_status: 'importing',
        import_progress: 0,
      })

      fetch('/api/legacy/session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          sleeper_username: username.trim(),
          sleeper_id: data.sleeper_user_id,
        }),
      }).catch(() => {})
      

      fetch('/api/legacy/worker/run', { method: 'GET', cache: 'no-store' }).catch(() => {})
    } catch {
      setError('Network error. Please try again.')
    } finally {
      setLoading(false)
    }
  }

  const loadProfile = async (uname: string) => {
    const clean = uname.trim().toLowerCase()
    const res = await fetch(`/api/legacy/profile?sleeper_username=${encodeURIComponent(clean)}`, {
      cache: 'no-store',
    })
    const data = await res.json()

    if (res.ok && data.profile) {
      console.log('LEGACY PROFILE DATA', data?.stats)
      setProfile(data.profile)
      setStats(data.standard_stats ?? data.stats ?? null)
      setSpecialtyStats(data.specialty_stats ?? null)
      setLeagues(Array.isArray(data.league_history) ? data.league_history : [])
      setSeasonBreakdown(Array.isArray(data.season_breakdown) ? data.season_breakdown : [])
      setAiReport(data.latest_ai_report ?? null)
      setRankingPreview(data.ranking_preview ?? null)

      fetch('/api/legacy/session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          sleeper_username: clean,
          sleeper_id: data.profile?.sleeper_user_id,
        }),
      }).catch(() => {})
    }
  }

  const loadAIReport = async (forceRefresh = false) => {
    if (!username) return
    setAiLoading(true)
    try {
      const res = await fetch('/api/legacy/ai/run', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sleeper_username: username, sleeper_user_id: profile?.sleeper_user_id, force_refresh: forceRefresh }),
      })
      const data = await res.json()
      if (data.success) {
        setAiReport(data.report)
      }
    } catch {
      console.error('Failed to load AI report')
    } finally {
      setAiLoading(false)
    }
  }

  useEffect(() => {
    if (importStatus === 'complete') {
      // Check if existing AI report is missing key fields (old format)
      const needsRefresh = !aiReport || aiReport.consistency_score == null || aiReport.consistency_score === undefined
      if (needsRefresh) {
        loadAIReport(true) // Force refresh to get new format with consistency_score
      }
    }
  }, [importStatus]) // eslint-disable-line react-hooks/exhaustive-deps

  // Check for new trades when import completes
  useEffect(() => {
    if (importStatus === 'complete' && username && tradeNotifications.length === 0) {
      checkForNewTrades()
    }
  }, [importStatus, username]) // eslint-disable-line react-hooks/exhaustive-deps

  // Trigger AI GM pre-analysis in background when import completes
  useEffect(() => {
    if (importStatus === 'complete' && username && leagues.length > 0) {
      const firstLeague = leagues[0]
      if (firstLeague) {
        fetch('/api/legacy/pre-analysis', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            username, 
            leagueId: firstLeague.league_id, 
            background: true 
          }),
        }).catch(() => {})
      }
    }
  }, [importStatus, username, leagues.length]) // eslint-disable-line react-hooks/exhaustive-deps

  const generateShareText = async (style: 'balanced' | 'humble' | 'trash_talk', type?: 'legacy' | 'trade' | 'rankings' | 'exposure') => {
    if (!username) return
    if (shareCooldownMs > 0) return

    const currentShareType = type || shareType
    
    // Validate required data exists for each share type
    if (currentShareType === 'trade' && !lastTradeResult && !shareTradeAnalysis) {
      setShareText('Enter a trade above and click "Analyze Trade" first.')
      return
    }
    if (currentShareType === 'rankings' && rankingsDynastyLeagues.length === 0) {
      setShareText('Please check your League Rankings tab first to see your standings.')
      return
    }
    if (currentShareType === 'exposure' && playerSearchResults.length === 0 && !sharePlayerResult) {
      setShareText('Search for a player above and click "Lookup" first.')
      return
    }
    
    setShareLoading(true)
    setShareStyle(style)
    if (type) setShareType(type)
    trackToolUse('share_generate', { username, style, share_type: currentShareType })
    
    try {
      // Build share data based on type
      const sharePayload: Record<string, unknown> = {
        sleeper_username: username,
        sleeper_user_id: profile?.sleeper_user_id,
        style,
        share_type: currentShareType,
        platform: 'x',
      }

      if (currentShareType === 'legacy') {
        sharePayload.ranking_preview = rankingPreview
      } else if (currentShareType === 'trade') {
        // Use inline share trade analysis OR existing trade result from Trade Evaluator
        if (shareTradeAnalysis) {
          sharePayload.trade_data = {
            side_a: shareTradeAnalysis.sideA || [],
            side_b: shareTradeAnalysis.sideB || [],
            grade: shareTradeAnalysis.grade,
            verdict: shareTradeAnalysis.verdict,
            league_type: shareTradeLeagueType,
          }
        } else if (lastTradeResult) {
          sharePayload.trade_data = {
            side_a: lastTradeResult.sideA?.map((p: { name: string }) => p.name) || [],
            side_b: lastTradeResult.sideB?.map((p: { name: string }) => p.name) || [],
            grade: lastTradeResult.grade,
            verdict: lastTradeResult.verdict,
            league_type: lastTradeResult.leagueType || 'dynasty',
          }
        }
      } else if (currentShareType === 'rankings' && rankingsDynastyLeagues.length > 0) {
        // Use the first dynasty league's data for rankings share
        const firstLeague = rankingsDynastyLeagues[0]
        sharePayload.rankings_data = {
          league_name: firstLeague.name || 'Dynasty League',
          rank: firstLeague.userRank,
          total_teams: firstLeague.totalTeams || firstLeague.total_rosters,
          roster_value: firstLeague.rosterValue,
          outlook: firstLeague.aiOutlook,
        }
      } else if (currentShareType === 'exposure') {
        // Use inline player stock search OR existing player search from Player Finder
        if (sharePlayerResult) {
          sharePayload.exposure_data = {
            player_name: sharePlayerResult.name,
            signal: sharePlayerResult.signal,
            trend: sharePlayerResult.trend,
            position: sharePlayerResult.position,
            team: sharePlayerResult.team,
            rank: sharePlayerResult.rank,
          }
        } else if (playerSearchResults.length > 0) {
          const topPlayer = playerSearchResults[0]
          sharePayload.exposure_data = {
            player_name: topPlayer.playerName,
            ownership_pct: topPlayer.ownershipPct,
            leagues_owned: topPlayer.ownedLeagues?.length || 0,
            total_leagues: leagues.length,
            signal: topPlayer.stock?.signal,
          }
        }
      }

      const res = await fetch('/api/legacy/share', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(sharePayload),
      })
      const data = await res.json()

      if (res.status === 429) {
        const ms = getRetryAfterMsFromPayload(data, 60)
        setShareCooldownMs(ms)
        setShareText(`Rate limited. Try again in ${formatCooldown(ms)}.`)
        setShareRemaining(data.remaining ?? 0)
        return
      }

      if (data.success) {
        setShareText(data.share_text)
        setShareRemaining(data.rate_limit?.remaining ?? null)
      } else if (!res.ok) {
        setShareText(data?.error || 'Failed to generate share text')
      }
    } catch {
      console.error('Failed to generate share text')
      setShareText('Failed to generate share text (network error)')
    } finally {
      setShareLoading(false)
    }
  }

  // Analyze trade for Share tab Trade Vote
  const analyzeShareTrade = async () => {
    if (!shareTradeSideA.trim() || !shareTradeSideB.trim()) return
    setShareTradeLoading(true)
    setShareTradeAnalysis(null)
    setShareTradeError('')
    try {
      const sideAPlayers = shareTradeSideA.split(',').map(p => p.trim()).filter(Boolean)
      const sideBPlayers = shareTradeSideB.split(',').map(p => p.trim()).filter(Boolean)
      
      const res = await fetch('/api/legacy/trade-vote-analyze', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          side_a: sideAPlayers,
          side_b: sideBPlayers,
          league_type: shareTradeLeagueType,
        }),
      })
      const data = await res.json()
      if (data.success) {
        setShareTradeAnalysis({
          grade: data.grade,
          verdict: data.verdict,
          sideA: sideAPlayers,
          sideB: sideBPlayers,
        })
      } else {
        setShareTradeError(data.error || 'Failed to analyze trade')
      }
    } catch (e) {
      console.error('Failed to analyze trade:', e)
      setShareTradeError('Network error - please try again')
    } finally {
      setShareTradeLoading(false)
    }
  }

  // Look up player stock for Share tab Player Stock
  const lookupSharePlayerStock = async () => {
    if (!sharePlayerSearch.trim()) return
    setSharePlayerLoading(true)
    setSharePlayerResult(null)
    setSharePlayerError('')
    try {
      const res = await fetch('/api/legacy/player-stock', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          player_name: sharePlayerSearch.trim(),
        }),
      })
      const data = await res.json()
      if (data.success) {
        setSharePlayerResult({
          name: data.player.name,
          sleeperId: data.player.sleeperId || data.player.id,
          position: data.player.position,
          team: data.player.team,
          value: data.player.value,
          trend: data.player.trend,
          signal: data.player.signal,
          rank: data.player.rank,
        })
      } else {
        setSharePlayerError(data.error || 'Player not found')
      }
    } catch (e) {
      console.error('Failed to lookup player stock:', e)
      setSharePlayerError('Network error - please try again')
    } finally {
      setSharePlayerLoading(false)
    }
  }

  const checkForNewTrades = async () => {
    if (!username) return
    setTradeNotifLoading(true)
    try {
      const res = await fetch('/api/legacy/trades/check', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sleeper_username: username, sleeper_user_id: profile?.sleeper_user_id }),
      })
      const data = await res.json()
      if (data.success) {
        setTradeNotifications(data.trades || [])
        setNewTradeCount(data.newCount || 0)
        if (data.newCount > 0) {
          setShowTradeNotifs(true)
        }
      }
    } catch (e) {
      console.error('Failed to check trades:', e)
    } finally {
      setTradeNotifLoading(false)
    }
  }

  const signUpForTradeAlerts = async () => {
    if (!emailForAlerts || !username) return
    setEmailSignupLoading(true)
    setEmailSignupError('')
    try {
      const res = await fetch('/api/legacy/email-preferences', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: emailForAlerts,
          sleeper_username: username,
          trade_alerts: true,
        }),
      })
      const data = await res.json()
      if (data.success) {
        setEmailSignupSuccess(true)
      } else {
        setEmailSignupError(data.error || 'Failed to sign up')
      }
    } catch (e) {
      setEmailSignupError('Network error - please try again')
    } finally {
      setEmailSignupLoading(false)
    }
  }

  // Check if user has completed the trade preferences quiz
  const checkQuizStatus = async () => {
    if (!username || quizChecked) return
    setQuizLoading(true)
    try {
      const res = await fetch(`/api/legacy/trade/preferences?sleeper_username=${encodeURIComponent(username)}`)
      const data = await res.json()
      setQuizChecked(true)
      setQuizCompleted(data.hasCompletedQuiz ?? false)
      if (data.quizTrades) {
        setQuizTrades(data.quizTrades)
      }
    } catch (e) {
      console.error('Failed to check quiz status:', e)
      setQuizChecked(true)
      setQuizCompleted(true) // Fallback to skip quiz on error
    } finally {
      setQuizLoading(false)
    }
  }

  // Submit quiz responses
  const submitQuiz = async () => {
    if (!username) return
    setQuizLoading(true)
    try {
      const responses = Object.entries(quizResponses).map(([id, choice]) => ({
        tradeId: parseInt(id),
        choice,
      }))
      const res = await fetch('/api/legacy/trade/preferences', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          sleeper_username: username,
          responses,
        }),
      })
      if (res.ok) {
        setQuizCompleted(true)
      }
    } catch (e) {
      console.error('Failed to submit quiz:', e)
    } finally {
      setQuizLoading(false)
    }
  }

  // Handle quiz answer selection
  const handleQuizAnswer = (tradeId: number, choice: 'A' | 'B') => {
    setQuizResponses(prev => ({ ...prev, [tradeId]: choice }))
    if (quizCurrentIndex < quizTrades.length - 1) {
      setTimeout(() => setQuizCurrentIndex(i => i + 1), 300)
    }
  }

  const loadTradeHistory = async (leagueId: string, loadMore = false) => {
    setTradeHistoryStatus(prev => ({
      ...prev,
      [leagueId]: { status: 'loading', tradesLoaded: prev[leagueId]?.tradesLoaded || 0 }
    }))
    
    try {
      const res = await fetch('/api/legacy/trade-history', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          league_id: leagueId,
          sleeper_username: username,
          sport: 'nfl',
          load_more: loadMore,
        }),
      })
      const data = await res.json()
      
      if (res.ok) {
        setTradeHistoryStatus(prev => ({
          ...prev,
          [leagueId]: {
            status: data.status,
            tradesLoaded: data.tradesLoaded || 0,
            message: data.message,
          }
        }))
        
        if (data.status === 'partial') {
          setTradeHistoryNotification({
            leagueId,
            message: `Learning from your first ${data.tradesLoaded} trades. More history available.`,
          })
          setTimeout(() => setTradeHistoryNotification(null), 5000)
        } else if (data.status === 'complete' && data.tradesLoaded > 0) {
          setTradeHistoryNotification({
            leagueId,
            message: `AI learned from ${data.tradesLoaded} of your past trades!`,
          })
          setTimeout(() => setTradeHistoryNotification(null), 4000)
        }
      }
    } catch (e) {
      console.error('Failed to load trade history:', e)
      setTradeHistoryStatus(prev => ({
        ...prev,
        [leagueId]: { status: 'error', tradesLoaded: 0, message: 'Failed to load' }
      }))
    }
  }

  const runTradeFinderAnalysis = async (leagueIdOverride?: string) => {
    const leagueId = leagueIdOverride || finderSelectedLeague
    if (!username || !leagueId) return

    setFinderLoading(true)
    setFinderError('')
    setFinderWarning('')
    setTradeSuggestions([])
    setFinderLeagueInfo(null)

    trackToolUse('trade_finder', { username, league_id: leagueId })

    try {
      // Keep this inside try so it can't fail "outside" the handler
      loadTradeHistory(leagueId)

      const res = await fetch('/api/legacy/trade/league-analyze', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          league_id: leagueId,
          sleeper_username: username,
          sport: 'nfl',
        }),
      })

      const data = await res.json()

      if (!res.ok) {
        setFinderError(data.error || 'Failed to analyze league')
        return
      }

      if (data.success) {
        setTradeSuggestions(data.tradeSuggestions || [])
        setFinderLeagueInfo({
          name: data.leagueName || 'League',
          scoringType: data.scoringType || 'PPR',
        })

        if (data.warning) setFinderWarning(data.warning)

        if (data.userRosterId) setFinderUserRosterId(data.userRosterId)
        if (data.userRoster) setFinderUserRoster(data.userRoster)
      }
    } catch (e) {
      setFinderError('Network error - please try again')
    } finally {
      setFinderLoading(false)
    }
  }

  const submitTradeFeedback = async (
    managerIdx: number,
    tradeIdx: number,
    trade: any,
    targetManager: string,
    rating: number
  ) => {
    const feedbackKey = `${finderSelectedLeague}-${managerIdx}-${tradeIdx}`
    setFeedbackLoading((prev) => ({ ...prev, [feedbackKey]: true }))
    
    try {
      const res = await fetch('/api/legacy/trade/feedback', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          sleeper_username: username,
          league_id: finderSelectedLeague,
          league_name: finderLeagueInfo?.name,
          target_manager: targetManager,
          you_give: trade.youGive || [],
          you_receive: trade.youReceive || [],
          ai_grade: trade.tradeGrade,
          rating,
        }),
      })
      
      if (res.ok) {
        setTradeFeedback((prev) => ({ ...prev, [feedbackKey]: rating }))
      }
    } catch (e) {
      console.error('Failed to submit feedback', e)
    } finally {
      setFeedbackLoading((prev) => ({ ...prev, [feedbackKey]: false }))
    }
  }

  const searchPlayers = async () => {
    if (!username || !playerSearchQuery || playerSearchQuery.length < 2) return
    setPlayerSearchLoading(true)
    setPlayerSearchError('')
    setPlayerSearchResults([])
    trackToolUse('player_finder', { username, query: playerSearchQuery })
    
    try {
      const res = await fetch('/api/legacy/player-finder', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          sleeper_username: username,
          query: playerSearchQuery,
          sport: 'nfl',
        }),
      })
      const data = await res.json()
      
      if (!res.ok) {
        setPlayerSearchError(data.error || 'Failed to search players')
        return
      }
      
      if (data.success) {
        setPlayerSearchResults(data.players || [])
        if (data.players?.length === 0) {
          setPlayerSearchError(`You don't own any player matching "${playerSearchQuery}" in your leagues`)
        }
      }
    } catch (e) {
      setPlayerSearchError('Network error - please try again')
    } finally {
      setPlayerSearchLoading(false)
    }
  }

  const runPlayoffBackfill = async () => {
    if (!username) return
    setBackfillLoading(true)
    setBackfillResult('')
    try {
      const res = await fetch('/api/legacy/backfill/playoffs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sleeper_username: username }),
      })
      const data = await res.json()

      if (!res.ok || !data?.success) {
        setBackfillResult(data?.error || 'Backfill failed')
        return
      }

      setBackfillResult(`Updated ${data.rosters_updated} rosters across ${data.leagues_updated} leagues. Reloading stats...`)
      await loadProfile(username)
    } catch (e) {
      setBackfillResult('Backfill failed (network error)')
    } finally {
      setBackfillLoading(false)
    }
  }

  const refreshRank = async () => {
    if (!username) return
    if (rankCooldownMs > 0) return

    setRankRefreshLoading(true)
    setRankRefreshError('')
    try {
      const res = await fetch(`/api/legacy/rank/refresh?sleeper_username=${encodeURIComponent(username)}`, {
        method: 'POST',
      })
      const data = await res.json()

      if (res.status === 429) {
        const ms = getRetryAfterMsFromPayload(data, 60)
        setRankCooldownMs(ms)
        setRankRefreshError(`Try again in ${formatCooldown(ms)}.`)
        setRankRemaining(data.remaining ?? 0)
        return
      }

      if (!res.ok) {
        setRankRefreshError(data.error || 'Refresh failed')
        return
      }

      setRankingPreview(data.ranking_preview)
      setRankRemaining(data.rate_limit?.remaining ?? null)
      setAiCoach(null)
    } catch {
      setRankRefreshError('Network error')
    } finally {
      setRankRefreshLoading(false)
    }
  }

  const askAiCoach = async () => {
    if (!username) return
    if (aiCoachCooldownMs > 0) return

    setAiCoachLoading(true)
    setAiCoachError('')
    trackToolUse('ai_coach', { username })
    try {
      const res = await fetch('/api/legacy/ai-coach', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          sleeper_username: username,
          sleeper_user_id: profile?.sleeper_user_id,
          stats,
          ranking_preview: rankingPreview,
          league_history: leagues.slice(0, 25),
        }),
      })
      const data = await res.json()

      if (res.status === 429) {
        const ms = getRetryAfterMsFromPayload(data, 60)
        setAiCoachCooldownMs(ms)
        setAiCoachError(`Try again in ${formatCooldown(ms)}.`)
        setAiCoachRemaining(data.remaining ?? 0)
        return
      }

      if (!res.ok) {
        setAiCoachError(data.error || 'AI coach request failed')
        return
      }

      setAiCoach(data.coach)
      setAiCoachRemaining(data.rate_limit?.remaining ?? null)
    } catch {
      setAiCoachError('Network error')
    } finally {
      setAiCoachLoading(false)
    }
  }

  const loadWaiverLeagues = async () => {
    if (!username) return
    setWaiverLeaguesLoading(true)
    try {
      const res = await fetch(`/api/legacy/waiver/leagues?sleeper_username=${encodeURIComponent(username)}`)
      const data = await res.json()
      if (data.ok && data.leagues) {
        setWaiverDynastyLeagues(data.leagues)
        if (data.leagues.length > 0 && !waiverSelectedLeague) {
          setWaiverSelectedLeague(data.leagues[0].league_id)
        }
      }
    } catch {
      console.error('Failed to load waiver leagues')
    } finally {
      setWaiverLeaguesLoading(false)
    }
  }

  const runWaiverAnalysis = async () => {
    if (!username || !waiverSelectedLeague) return
    setWaiverLoading(true)
    setWaiverError('')
    setWaiverAnalysis(null)
    trackToolUse('waiver_ai', { username, league_id: waiverSelectedLeague })
    try {
      const res = await fetch('/api/legacy/waiver/analyze', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          sleeperUser: buildSleeperUser(username, profile),
          league_id: waiverSelectedLeague,
          goal: waiverGoal || undefined,
        }),
      })
      const data = await res.json()
      if (!res.ok) {
        setWaiverError(data.error || 'Failed to analyze waivers')
        return
      }
      setWaiverAnalysis(data.analysis)
    } catch {
      setWaiverError('Network error')
    } finally {
      setWaiverLoading(false)
    }
  }

  const loadRankingsLeagues = async () => {
    if (!username) return
    setRankingsLeaguesLoading(true)
    try {
      const res = await fetch(`/api/legacy/waiver/leagues?sleeper_username=${encodeURIComponent(username)}`)
      const data = await res.json()
      if (data.ok && data.leagues) {
        setRankingsDynastyLeagues(data.leagues)
        if (data.leagues.length > 0 && !rankingsSelectedLeague) {
          setRankingsSelectedLeague(data.leagues[0].league_id)
        }
      }
    } catch {
      console.error('Failed to load rankings leagues')
    } finally {
      setRankingsLeaguesLoading(false)
    }
  }

  const sendChatMessage = async () => {
    if (!chatInput.trim() && !chatImagePreview) return
    setChatError('')
    setChatLoading(true)
    
    const userMessage: { role: 'user' | 'assistant'; content: string; imageUrl?: string } = {
      role: 'user',
      content: chatInput.trim() || 'Please analyze this image.',
      imageUrl: chatImagePreview || undefined,
    }
    
    const updatedMessages = [...chatMessages, userMessage]
    setChatMessages(updatedMessages)
    setChatInput('')
    const imageToSend = chatImagePreview
    setChatImagePreview(null)
    
    trackToolUse('ai_chat', { hasImage: !!imageToSend })
    
    try {
      const res = await fetch('/api/legacy/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          messages: updatedMessages,
          imageBase64: imageToSend,
          sleeperUsername: username || undefined,
          yahooUserId: yahooUserId || undefined,
          fantraxUsername: fantraxUsername || undefined,
          mflUsername: mflUsername || undefined,
          leagueId: chatLeagueId || undefined,
        }),
      })
      const data = await res.json()
      if (!res.ok) {
        setChatError(data.error || 'Failed to get response')
        return
      }
      setChatMessages([...updatedMessages, { role: 'assistant', content: data.response }])
      setTimeout(() => {
        chatContainerRef.current?.scrollTo({ top: chatContainerRef.current.scrollHeight, behavior: 'smooth' })
      }, 100)
    } catch {
      setChatError('Network error')
    } finally {
      setChatLoading(false)
    }
  }

  const handleChatImageUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (!file) return
    if (file.size > 10 * 1024 * 1024) {
      setChatError('Image must be under 10MB')
      return
    }
    const reader = new FileReader()
    reader.onload = () => {
      setChatImagePreview(reader.result as string)
    }
    reader.readAsDataURL(file)
  }

  const runRankingsAnalysis = async (leagueId?: string, retryCount = 0) => {
    const targetLeague = leagueId || rankingsSelectedLeague
    if (!username || !targetLeague) {
      if (!username) setRankingsError('Please enter your Sleeper username first.')
      if (!targetLeague) setRankingsError('Please select a league first.')
      return
    }
    setRankingsLoading(true)
    setRankingsError('')
    setRankingsData(null)
    trackToolUse('league_rankings', { username, league_id: targetLeague })

    const sleeperUser = buildSleeperUser(username, profile)

    try {
      const snapshotRes = await fetch('/api/legacy/snapshots/latest', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          league_id: targetLeague,
          sleeper_username: username,
          sleeperUser,
          snapshot_type: 'rankings_analyze',
        }),
      })

      if (snapshotRes.ok) {
        const snapData = await snapshotRes.json()
        if (snapData.ok && snapData.snapshot?.createdAt && snapData.payload) {
          const createdAt = new Date(snapData.snapshot.createdAt)
          const ageHours = (Date.now() - createdAt.getTime()) / (1000 * 60 * 60)
          if (ageHours < 24) {
            setRankingsData(snapData.payload)
            fetchDevyBoard(targetLeague, snapData.payload)
            fetchPlayoffForecast()
            fetchHistoricalRatings()
            fetchLeagueFormat()
            return
          }
        }
      }

      const res = await fetch('/api/legacy/rankings/analyze', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          sleeper_username: username,
          league_id: targetLeague,
          sleeperUser,
        }),
      })
      const data = await res.json()
      if (!res.ok) {
        if (retryCount === 0) {
          console.warn('[Rankings] First attempt failed, retrying...', data.error)
          setRankingsLoading(false)
          return runRankingsAnalysis(targetLeague, 1)
        }
        setRankingsError(data.error || 'Failed to analyze rankings')
        return
      }
      setRankingsData(data)
      fetchDevyBoard(targetLeague, data)
      fetchPlayoffForecast()
      fetchHistoricalRatings()
      fetchLeagueFormat()
    } catch (e: any) {
      if (retryCount === 0) {
        console.warn('[Rankings] Network error, retrying once...', e?.message)
        setRankingsLoading(false)
        return runRankingsAnalysis(targetLeague, 1)
      }
      setRankingsError('Network error ‚Äî please check your connection and try again.')
    } finally {
      setRankingsLoading(false)
    }
  }

  const fetchDevyBoard = async (leagueId: string, rankingsDataInput?: any) => {
    if (!leagueId) return
    setDevyBoardLoading(true)
    setDevyBoardError('')
    
    try {
      const selectedLeague = rankingsDynastyLeagues.find(l => l.league_id === leagueId)
      
      const res = await fetch('/api/legacy/devy-board', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          league_id: leagueId,
          user_id: username,
          league_settings: {
            scoring_type: selectedLeague?.scoring_settings?.rec ? 'ppr' : 'standard',
            is_superflex: selectedLeague?.roster_positions?.filter((p: string) => p === 'SUPER_FLEX').length > 0,
            te_premium: (selectedLeague?.scoring_settings?.bonus_rec_te || 0) > 0,
            roster_positions: selectedLeague?.roster_positions,
            total_teams: selectedLeague?.team_count || 12,
            league_type: 'dynasty',
          },
          roster: {
            players: rankingsDataInput?.userRoster || [],
            picks: rankingsDataInput?.userPicks || [],
          },
          team_record: rankingsDataInput?.userRecord,
        }),
      })
      
      const data = await res.json()
      if (!res.ok) {
        setDevyBoardError(data.error || 'Failed to generate devy board')
        return
      }
      setDevyBoardData(data)
      import("@/lib/telemetry/client").then(m => m.logLegacyToolUsage({ tool: "DevyAssistant", leagueId: rankingsSelectedLeague, action: "generate" })).catch(() => {})
    } catch {
      setDevyBoardError('Network error generating devy board')
    } finally {
      setDevyBoardLoading(false)
    }
  }

  const fetchPlayoffForecast = async (year?: number, forecastType?: 'traditional' | 'elo') => {
    if (!username || !rankingsSelectedLeague) return
    setPlayoffForecastLoading(true)
    try {
      const res = await fetch('/api/legacy/rankings/playoff-forecast', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          sleeper_username: username,
          league_id: rankingsSelectedLeague,
          forecast_year: year || playoffForecastYear,
          forecast_type: forecastType || playoffForecastType,
        }),
      })
      const data = await res.json()
      if (res.ok) {
        setPlayoffForecastData(data)
      }
    } catch (err) {
      console.error('Playoff forecast error:', err)
    } finally {
      setPlayoffForecastLoading(false)
    }
  }

  const fetchHistoricalRatings = async (season?: number) => {
    if (!username || !rankingsSelectedLeague) return
    setHistoricalRatingsLoading(true)
    try {
      const res = await fetch('/api/legacy/rankings/historical-ratings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          sleeper_username: username,
          league_id: rankingsSelectedLeague,
          season: season || historicalRatingsSeason,
        }),
      })
      const data = await res.json()
      if (res.ok) {
        setHistoricalRatingsData(data)
      }
    } catch (err) {
      console.error('Historical ratings error:', err)
    } finally {
      setHistoricalRatingsLoading(false)
    }
  }

  const fetchLeagueFormat = async () => {
    if (!username || !rankingsSelectedLeague) return
    setLeagueFormatLoading(true)
    try {
      const res = await fetch('/api/legacy/rankings/league-format', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          sleeper_username: username,
          league_id: rankingsSelectedLeague,
        }),
      })
      const data = await res.json()
      if (res.ok) {
        setLeagueFormatData(data)
      }
    } catch (err) {
      console.error('League format error:', err)
    } finally {
      setLeagueFormatLoading(false)
    }
  }

  const runSocialPulse = async () => {
    const players = pulsePlayerInput.split(',').map(p => p.trim()).filter(p => p.length > 0)
    if (players.length === 0) {
      setPulseError('Enter at least one player name')
      return
    }
    setPulseLoading(true)
    setPulseError('')
    setPulseData(null)
    trackToolUse('social_pulse', { players, format: pulseFormat })
    try {
      const res = await fetch('/api/legacy/social-pulse', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          sport: 'NFL',
          format: pulseFormat,
          idpEnabled: false,
          players,
        }),
      })
      const data = await res.json()
      if (res.status === 429) {
        setPulseError(`Rate limit hit. Try again in ${data?.retryAfterSec ?? 60}s.`)
        return
      }
      if (!res.ok || !data.success) {
        setPulseError(data?.error || 'Failed to fetch social pulse')
        return
      }
      setPulseData(data.data)
    } catch {
      setPulseError('Network error')
    } finally {
      setPulseLoading(false)
    }
  }

  const runManagerComparison = async () => {
    if (!username || !compareOpponent.trim()) return
    setCompareLoading(true)
    setCompareError('')
    trackToolUse('manager_compare', { username, opponent: compareOpponent })
    setCompareResult(null)
    try {
      const res = await fetch('/api/legacy/compare', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username_a: username,
          username_b: compareOpponent.trim(),
        }),
      })
      const data = await res.json()
      if (!res.ok) {
        setCompareError(data.error || 'Comparison failed')
        return
      }
      setCompareResult(data)
    } catch {
      setCompareError('Network error')
    } finally {
      setCompareLoading(false)
    }
  }

  const rerunAiAnalysis = async () => {
    if (!username || aiAnalysisLoading) return
    setAiAnalysisLoading(true)
    try {
      const res = await fetch('/api/legacy/ai/run', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sleeper_username: username, sleeper_user_id: profile?.sleeper_user_id }),
      })
      const data = await res.json()
      if (res.ok && data.report) {
        setAiReport(data.report)
      }
      setAiAnalysisRemaining(data?.rate_limit?.remaining ?? null)
    } catch {
      // silent fail
    } finally {
      setAiAnalysisLoading(false)
    }
  }

  const refreshCareerStats = async () => {
    if (!username || careerStatsLoading) return
    setCareerStatsLoading(true)
    try {
      const res = await fetch(`/api/legacy/profile?sleeper_username=${encodeURIComponent(username)}`)
      const data = await res.json()
      if (res.ok && data.stats) {
        setStats(data.standard_stats ?? data.stats)
        setSpecialtyStats(data.specialty_stats ?? null)
      }
      setCareerStatsRemaining(data?.rate_limit?.remaining ?? null)
    } catch {
      // silent fail
    } finally {
      setCareerStatsLoading(false)
    }
  }

  useEffect(() => {
    if (activeTab === 'share' && importStatus === 'complete' && !shareText) {
      generateShareText('balanced')
    }
  }, [activeTab, importStatus]) // eslint-disable-line react-hooks/exhaustive-deps

  const tabs: Array<{ id: Tab; label: string; icon: React.ReactNode; badge?: string }> = [
    { id: 'overview' as Tab, label: 'Overview', icon: <BarChart3 className="w-4 h-4" /> },
    { id: 'trade' as Tab, label: 'AI Trade Hub', icon: <ArrowLeftRight className="w-4 h-4" />, badge: 'AI' },
    { id: 'finder' as Tab, label: 'Trade Finder', icon: <Search className="w-4 h-4" />, badge: 'AI' },
    { id: 'player-finder' as Tab, label: 'Player Finder', icon: <Search className="w-4 h-4" /> },
    { id: 'waiver' as Tab, label: 'Waiver AI', icon: <TrendingUp className="w-4 h-4" />, badge: 'AI' },
    { id: 'rankings' as Tab, label: 'Rankings', icon: <Trophy className="w-4 h-4" /> },
    { id: 'pulse' as Tab, label: 'Pulse', icon: <Radio className="w-4 h-4" />, badge: 'Beta' },
    { id: 'compare' as Tab, label: 'Compare', icon: <Swords className="w-4 h-4" /> },
    { id: 'chat' as Tab, label: 'AI Chat', icon: <MessageCircle className="w-4 h-4" />, badge: 'AI' },
    { id: 'share' as Tab, label: 'Share', icon: <Share2 className="w-4 h-4" /> },
    { id: 'transfer' as Tab, label: 'Transfer', icon: <PackageOpen className="w-4 h-4" /> },
    { id: 'strategy' as Tab, label: 'Strategy', icon: <Target className="w-4 h-4" />, badge: 'AI' },
    { id: 'shop' as Tab, label: 'Shop', icon: <ShoppingBag className="w-4 h-4" /> },
  ]

  const isShareLocked = shareCooldownMs > 0
  const isRankLocked = rankCooldownMs > 0
  const isCoachLocked = aiCoachCooldownMs > 0

  const mainTabGroups: Record<MainTab, Tab[]> = {
    home: ['overview'],
    trade: ['trade', 'finder', 'player-finder', 'waiver'],
    strategy: ['strategy', 'rankings', 'pulse', 'compare'],
    alerts: [],
    profile: ['chat', 'share', 'transfer', 'shop'],
  }

  const subTabConfigs: Record<MainTab, Array<{ id: string; label: string; icon?: React.ReactNode; badge?: string }>> = {
    home: [],
    trade: [
      { id: 'trade', label: 'Trade Hub', icon: <ArrowLeftRight className="w-3.5 h-3.5" />, badge: 'AI' },
      { id: 'finder', label: 'Finder', icon: <Search className="w-3.5 h-3.5" />, badge: 'AI' },
      { id: 'player-finder', label: 'Players', icon: <Search className="w-3.5 h-3.5" /> },
      { id: 'waiver', label: 'Waiver', icon: <TrendingUp className="w-3.5 h-3.5" />, badge: 'AI' },
    ],
    strategy: [
      { id: 'strategy', label: 'Planner', icon: <Target className="w-3.5 h-3.5" />, badge: 'AI' },
      { id: 'rankings', label: 'Rankings', icon: <Trophy className="w-3.5 h-3.5" /> },
      { id: 'pulse', label: 'Pulse', icon: <Radio className="w-3.5 h-3.5" /> },
      { id: 'compare', label: 'Compare', icon: <Swords className="w-3.5 h-3.5" /> },
    ],
    alerts: [],
    profile: [
      { id: 'chat', label: 'AI Chat', icon: <MessageCircle className="w-3.5 h-3.5" />, badge: 'AI' },
      { id: 'share', label: 'Share', icon: <Share2 className="w-3.5 h-3.5" /> },
      { id: 'transfer', label: 'Transfer', icon: <PackageOpen className="w-3.5 h-3.5" /> },
      { id: 'shop', label: 'Shop', icon: <ShoppingBag className="w-3.5 h-3.5" /> },
    ],
  }

  const handleMobileTabChange = (tab: MainTab) => {
    setMobileMainTab(tab)
    const group = mainTabGroups[tab]
    if (group.length > 0) {
      setActiveTab(group[0])
    }
    setMoreMenuOpen(false)
  }

  const tabToMainTab = (t: Tab): MainTab => {
    for (const [main, subs] of Object.entries(mainTabGroups)) {
      if ((subs as Tab[]).includes(t)) return main as MainTab
    }
    return 'home'
  }

  const navigateToChat = (question: string, leagueId?: string) => {
    setChatInput(question)
    setChatLeagueId(leagueId || '')
    setActiveTab('chat')
    setMobileMainTab(tabToMainTab('chat'))
    setTimeout(() => {
      const input = document.querySelector<HTMLInputElement>('[data-chat-input]')
      input?.focus()
    }, 200)
  }

  const handleActiveTabChange = (t: Tab) => {
    setActiveTab(t)
    setMobileMainTab(tabToMainTab(t))
  }

  const mobileSubTabs = subTabConfigs[mobileMainTab]
  const showMobileSubNav = mobileSubTabs.length > 1 && importStatus === 'complete'
  const mobileAlertsActive = mobileMainTab === 'alerts'

  return (
    <main className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900/50 to-slate-900 pb-20 lg:pb-0 overflow-x-hidden">
      <div className="container mx-auto px-3 sm:px-4 md:px-6 py-4 sm:py-6 md:py-8 max-w-6xl">
        <div className="mb-8 flex items-center justify-between">
          <Link
            href="/"
            className="inline-flex items-center gap-2 rounded-full bg-white/5 hover:bg-white/10 border border-white/10 px-3 py-1.5 text-sm text-cyan-200 transition"
          >
            <span aria-hidden>‚Üê</span> Back to Home
          </Link>
        </div>

        {importStatus === 'idle' && (
          <div className="relative">
            {/* subtle background accents */}
            <div className="pointer-events-none absolute -top-10 left-1/2 h-64 w-64 -translate-x-1/2 rounded-full bg-cyan-500/15 blur-3xl" />
            <div className="pointer-events-none absolute top-24 left-1/3 h-64 w-64 -translate-x-1/2 rounded-full bg-purple-500/15 blur-3xl" />

            {pendingShareLeague && (
              <div className="mb-6 p-4 rounded-2xl bg-gradient-to-r from-amber-500/10 to-yellow-500/10 border border-amber-400/20">
                <div className="flex items-center gap-3">
                  <div className="w-8 h-8 rounded-lg bg-amber-500/20 flex items-center justify-center text-base flex-shrink-0">üèÜ</div>
                  <div>
                    <p className="text-sm font-semibold text-amber-200">Someone shared their league rankings with you!</p>
                    <p className="text-xs text-white/50 mt-0.5">Enter your Sleeper username below to see where you rank.</p>
                  </div>
                </div>
              </div>
            )}

            {/* hero grid */}
            <div className="grid lg:grid-cols-2 gap-8 items-center">
              {/* Left: Hero copy */}
              <div className="max-w-xl">
                <h2 className="text-2xl sm:text-3xl md:text-4xl font-extrabold text-white leading-tight">
                  Turn your fantasy history into a{" "}
                  <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-purple-300">
                    Legacy Profile
                  </span>
                </h2>

                <p className="mt-2 sm:mt-3 text-sm sm:text-base text-white/65">
                  Import your real leagues from Sleeper, Yahoo, MFL, or Fantrax to see career rankings, playoff accuracy, and how the AllFantasy AI evaluates your decisions over time.
                </p>

                {/* Trust line */}
                <p className="mt-4 text-sm text-white/50">
                  Built by real fantasy players ‚Äî not a corporation.
                </p>

                {/* Feature chips */}
                <div className="mt-5 flex flex-wrap gap-2">
                  <span className="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-emerald-500/10 border border-emerald-500/20 text-xs text-emerald-300">
                    üü¢ Career rank & trends
                  </span>
                  <span className="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-emerald-500/10 border border-emerald-500/20 text-xs text-emerald-300">
                    üü¢ Playoff & championship context
                  </span>
                  <span className="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-emerald-500/10 border border-emerald-500/20 text-xs text-emerald-300">
                    üü¢ AI coaching insights (live + learning)
                  </span>
                </div>
              </div>

              {/* Right: Import card */}
              <div className="max-w-xl w-full mx-auto lg:mx-0">
                <div className="relative rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl shadow-[0_20px_60px_rgba(0,0,0,0.45)] overflow-hidden">
                  {/* top glow line */}
                  <div className="h-1 bg-gradient-to-r from-cyan-400/60 via-purple-400/60 to-cyan-400/60" />

                  <div className="p-6 sm:p-8">
                    <div className="mb-5">
                      <h3 className="text-2xl font-bold text-white">Build Your Legacy Profile</h3>
                      <p className="mt-1 text-white/60 text-sm">
                        Connect your fantasy platform to instantly analyze your career.
                      </p>
                    </div>

                    {/* Platform Selector */}
                    <div className="flex gap-2 mb-6">
                      <button
                        type="button"
                        onClick={() => setPlatform('sleeper')}
                        className={`flex-1 py-2.5 px-3 rounded-xl font-semibold text-sm transition ${
                          platform === 'sleeper'
                            ? 'bg-gradient-to-r from-cyan-500/30 to-purple-500/30 border border-cyan-400/50 text-white'
                            : 'bg-black/30 border border-white/10 text-white/60 hover:text-white hover:border-white/30'
                        }`}
                      >
                        <span className="mr-1">üåô</span> Sleeper
                      </button>
                      <button
                        type="button"
                        onClick={() => setPlatform('yahoo')}
                        className={`flex-1 py-2.5 px-3 rounded-xl font-semibold text-sm transition ${
                          platform === 'yahoo'
                            ? 'bg-gradient-to-r from-purple-500/30 to-pink-500/30 border border-purple-400/50 text-white'
                            : 'bg-black/30 border border-white/10 text-white/60 hover:text-white hover:border-white/30'
                        }`}
                      >
                        <span className="mr-1">üèà</span> Yahoo
                      </button>
                      <button
                        type="button"
                        onClick={() => setPlatform('mfl')}
                        className={`flex-1 py-2.5 px-3 rounded-xl font-semibold text-sm transition ${
                          platform === 'mfl'
                            ? 'bg-gradient-to-r from-amber-500/30 to-orange-500/30 border border-amber-400/50 text-white'
                            : 'bg-black/30 border border-white/10 text-white/60 hover:text-white hover:border-white/30'
                        }`}
                      >
                        <span className="mr-1">üèÜ</span> MFL
                      </button>
                      <button
                        type="button"
                        onClick={() => setPlatform('fantrax')}
                        className={`flex-1 py-2.5 px-3 rounded-xl font-semibold text-sm transition ${
                          platform === 'fantrax'
                            ? 'bg-gradient-to-r from-green-500/30 to-emerald-500/30 border border-green-400/50 text-white'
                            : 'bg-black/30 border border-white/10 text-white/60 hover:text-white hover:border-white/30'
                        }`}
                      >
                        <span className="mr-1">üìä</span> Fantrax
                      </button>
                      <button
                        type="button"
                        onClick={() => setPlatform('espn')}
                        className={`flex-1 py-2.5 px-3 rounded-xl font-semibold text-sm transition ${
                          platform === 'espn'
                            ? 'bg-gradient-to-r from-red-500/30 to-rose-500/30 border border-red-400/50 text-white'
                            : 'bg-black/30 border border-white/10 text-white/60 hover:text-white hover:border-white/30'
                        }`}
                      >
                        <span className="mr-1">üî¥</span> ESPN
                      </button>
                    </div>

                    {platform === 'sleeper' && (
                      <form onSubmit={handleImport} className="space-y-4">
                        {showSleeperHelp && (
                          <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm" onClick={() => setShowSleeperHelp(false)}>
                            <div className="relative w-full max-w-lg rounded-3xl bg-gradient-to-br from-slate-900 to-slate-950 border border-cyan-500/30 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
                              <div className="h-1.5 bg-gradient-to-r from-cyan-400 via-purple-500 to-cyan-400" />
                              <div className="p-6">
                                <div className="flex items-center justify-between mb-4">
                                  <h3 className="text-xl font-bold text-white">Finding Your Sleeper Username</h3>
                                  <button onClick={() => setShowSleeperHelp(false)} className="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center text-white/60 hover:text-white transition">
                                    <X className="w-4 h-4" />
                                  </button>
                                </div>

                                <ul className="space-y-3 text-sm text-white/80 mb-5">
                                  <li className="flex gap-3">
                                    <span className="flex-shrink-0 w-6 h-6 rounded-full bg-cyan-500/20 text-cyan-300 flex items-center justify-center text-xs font-bold">1</span>
                                    <span>Open the <strong className="text-cyan-300">Sleeper app</strong> on your phone or go to <a href="https://sleeper.com" target="_blank" rel="noopener noreferrer" className="text-cyan-400 underline underline-offset-2 hover:text-cyan-300">sleeper.com</a></span>
                                  </li>
                                  <li className="flex gap-3">
                                    <span className="flex-shrink-0 w-6 h-6 rounded-full bg-cyan-500/20 text-cyan-300 flex items-center justify-center text-xs font-bold">2</span>
                                    <span>Tap your <strong className="text-cyan-300">profile icon</strong> (bottom-right on mobile, or top-right on web).</span>
                                  </li>
                                  <li className="flex gap-3">
                                    <span className="flex-shrink-0 w-6 h-6 rounded-full bg-cyan-500/20 text-cyan-300 flex items-center justify-center text-xs font-bold">3</span>
                                    <span>Your username is displayed at the top ‚Äî it's the <strong className="text-cyan-300">@handle</strong> shown under your display name.</span>
                                  </li>
                                  <li className="flex gap-3">
                                    <span className="flex-shrink-0 w-6 h-6 rounded-full bg-cyan-500/20 text-cyan-300 flex items-center justify-center text-xs font-bold">4</span>
                                    <span>Enter that username below. We only read <strong className="text-cyan-300">public league data</strong> ‚Äî no passwords needed.</span>
                                  </li>
                                </ul>

                                <div className="flex justify-end">
                                  <button onClick={() => setShowSleeperHelp(false)} className="px-5 py-2 rounded-xl bg-gradient-to-r from-cyan-500 to-purple-500 text-white font-medium text-sm hover:from-cyan-400 hover:to-purple-400 transition">
                                    Got it
                                  </button>
                                </div>
                              </div>
                            </div>
                          </div>
                        )}

                        <div>
                          <div className="flex items-center justify-between mb-2">
                            <label className="text-[11px] uppercase tracking-wide text-white/50">
                              Platform username or league ID
                            </label>
                            <button
                              type="button"
                              onClick={() => setShowSleeperHelp(true)}
                              className="flex items-center gap-1 text-[11px] text-cyan-400 hover:text-cyan-300 transition"
                            >
                              <HelpCircle className="w-3 h-3" />
                              How to find this
                            </button>
                          </div>

                          <input
                            type="text"
                            value={username}
                            onChange={(e) => setUsername(e.target.value)}
                            placeholder="your_username"
                            className="w-full px-4 py-3 rounded-2xl bg-black/30 border border-white/10 text-white placeholder-white/25 focus:outline-none focus:border-cyan-400/60 focus:ring-2 focus:ring-cyan-400/20 transition"
                          />

                          <p className="mt-2 text-[11px] text-white/45">
                            We only read public league history. No passwords. No posting. Ever.
                          </p>
                        </div>

                        <div className="space-y-2">
                          <button
                            type="submit"
                            disabled={loading || !username.trim()}
                            className="w-full py-3.5 rounded-2xl font-bold text-white transition disabled:opacity-50
                              bg-gradient-to-r from-cyan-500/80 to-purple-500/80 hover:from-cyan-400/90 hover:to-purple-400/90
                              shadow-[0_12px_35px_rgba(0,0,0,0.35)] text-base"
                          >
                            {loading ? 'Starting‚Ä¶' : 'üî• Build My Legacy Profile'}
                          </button>
                          <p className="text-center text-[11px] text-white/40">
                            Takes ~1 minute ¬∑ Free ¬∑ No signup required
                          </p>
                        </div>
                      </form>
                    )}

                    {platform === 'yahoo' && (
                      <div className="space-y-4">
                        {showYahooHelp && (
                          <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm" onClick={() => setShowYahooHelp(false)}>
                            <div className="relative w-full max-w-lg rounded-3xl bg-gradient-to-br from-slate-900 to-slate-950 border border-purple-500/30 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
                              <div className="h-1.5 bg-gradient-to-r from-purple-400 via-pink-500 to-purple-400" />
                              <div className="p-6">
                                <div className="flex items-center justify-between mb-4">
                                  <h3 className="text-xl font-bold text-white">Connecting Your Yahoo Account</h3>
                                  <button onClick={() => setShowYahooHelp(false)} className="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center text-white/60 hover:text-white transition">
                                    <X className="w-4 h-4" />
                                  </button>
                                </div>

                                <ul className="space-y-3 text-sm text-white/80 mb-5">
                                  <li className="flex gap-3">
                                    <span className="flex-shrink-0 w-6 h-6 rounded-full bg-purple-500/20 text-purple-300 flex items-center justify-center text-xs font-bold">1</span>
                                    <span>Click <strong className="text-purple-300">"Connect Yahoo Account"</strong> below to securely sign in with Yahoo.</span>
                                  </li>
                                  <li className="flex gap-3">
                                    <span className="flex-shrink-0 w-6 h-6 rounded-full bg-purple-500/20 text-purple-300 flex items-center justify-center text-xs font-bold">2</span>
                                    <span>You'll be redirected to <strong className="text-purple-300">Yahoo's login page</strong> ‚Äî sign in with your Yahoo Fantasy account.</span>
                                  </li>
                                  <li className="flex gap-3">
                                    <span className="flex-shrink-0 w-6 h-6 rounded-full bg-purple-500/20 text-purple-300 flex items-center justify-center text-xs font-bold">3</span>
                                    <span>Grant AllFantasy permission to <strong className="text-purple-300">read your league data</strong>. We never post or modify anything.</span>
                                  </li>
                                  <li className="flex gap-3">
                                    <span className="flex-shrink-0 w-6 h-6 rounded-full bg-purple-500/20 text-purple-300 flex items-center justify-center text-xs font-bold">4</span>
                                    <span>You'll be redirected back here, and your leagues will <strong className="text-purple-300">load automatically</strong>.</span>
                                  </li>
                                </ul>

                                <div className="rounded-xl bg-black/30 border border-white/10 p-3 mb-4">
                                  <p className="text-xs text-white/50 mb-1 uppercase tracking-wide font-medium">Privacy note</p>
                                  <p className="text-sm text-white/70">We use Yahoo's official OAuth ‚Äî your password is never shared with us. You can revoke access anytime from your Yahoo account settings.</p>
                                </div>

                                <div className="flex justify-end">
                                  <button onClick={() => setShowYahooHelp(false)} className="px-5 py-2 rounded-xl bg-gradient-to-r from-purple-500 to-pink-500 text-white font-medium text-sm hover:from-purple-400 hover:to-pink-400 transition">
                                    Got it
                                  </button>
                                </div>
                              </div>
                            </div>
                          </div>
                        )}

                        {yahooConnected ? (
                          <>
                            <div className="p-4 rounded-xl bg-green-500/10 border border-green-400/30">
                              <div className="flex items-center gap-3">
                                <span className="text-2xl">‚úÖ</span>
                                <div>
                                  <div className="text-white font-semibold">Yahoo Connected</div>
                                  <div className="text-sm text-gray-400">
                                    {yahooDisplayName || 'Connected to Yahoo Fantasy'}
                                  </div>
                                </div>
                              </div>
                            </div>
                            
                            {yahooLeagues.length > 0 && (
                              <div className="space-y-2">
                                <label className="text-[11px] uppercase tracking-wide text-white/50">
                                  Your Yahoo Leagues ({yahooLeagues.length})
                                </label>
                                <div className="max-h-48 overflow-y-auto space-y-2">
                                  {yahooLeagues.map((league: any) => (
                                    <div
                                      key={league.yahooLeagueKey}
                                      className="p-3 rounded-xl bg-black/30 border border-white/10 flex items-center justify-between"
                                    >
                                      <div>
                                        <div className="text-white font-medium text-sm">{league.name}</div>
                                        <div className="text-xs text-gray-400">
                                          {league.sport} ‚Ä¢ {league.season} ‚Ä¢ {league.numTeams} teams
                                        </div>
                                      </div>
                                      <span className={`px-2 py-0.5 rounded text-[10px] font-medium ${
                                        league.isFinished ? 'bg-gray-500/30 text-gray-300' : 'bg-green-500/30 text-green-300'
                                      }`}>
                                        {league.isFinished ? 'Complete' : 'Active'}
                                      </span>
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}
                            
                            <button
                              onClick={fetchYahooLeagues}
                              disabled={yahooLoading}
                              className="w-full py-3 rounded-2xl font-bold text-white transition disabled:opacity-50
                                bg-gradient-to-r from-purple-500/80 to-pink-500/80 hover:from-purple-400/90 hover:to-pink-400/90
                                shadow-[0_12px_35px_rgba(0,0,0,0.35)]"
                            >
                              {yahooLoading ? 'Loading Leagues...' : 'Refresh Leagues'}
                            </button>
                          </>
                        ) : (
                          <>
                            <div className="p-4 rounded-xl bg-purple-500/10 border border-purple-400/30">
                              <div className="flex items-center justify-between mb-2">
                                <p className="text-sm text-white/80">
                                  Connect your Yahoo account to import your fantasy leagues. We'll securely access your league data via Yahoo's official API.
                                </p>
                              </div>
                              <button
                                type="button"
                                onClick={() => setShowYahooHelp(true)}
                                className="flex items-center gap-1 text-[11px] text-purple-400 hover:text-purple-300 transition mt-1"
                              >
                                <HelpCircle className="w-3 h-3" />
                                How does this work?
                              </button>
                            </div>
                            
                            <button
                              onClick={connectYahoo}
                              disabled={yahooLoading}
                              className="w-full py-3 rounded-2xl font-bold text-white transition disabled:opacity-50
                                bg-gradient-to-r from-purple-500/80 to-pink-500/80 hover:from-purple-400/90 hover:to-pink-400/90
                                shadow-[0_12px_35px_rgba(0,0,0,0.35)]"
                            >
                              {yahooLoading ? 'Connecting...' : 'Connect Yahoo Account'}
                            </button>
                          </>
                        )}
                      </div>
                    )}

                    {platform === 'mfl' && (
                      <div className="space-y-4">
                        {showMflHelp && (
                          <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm" onClick={() => setShowMflHelp(false)}>
                            <div className="relative w-full max-w-lg rounded-3xl bg-gradient-to-br from-slate-900 to-slate-950 border border-amber-500/30 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
                              <div className="h-1.5 bg-gradient-to-r from-amber-400 via-orange-500 to-amber-400" />
                              <div className="p-6">
                                <div className="flex items-center justify-between mb-4">
                                  <h3 className="text-xl font-bold text-white">Connecting Your MFL Account</h3>
                                  <button onClick={() => setShowMflHelp(false)} className="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center text-white/60 hover:text-white transition">
                                    <X className="w-4 h-4" />
                                  </button>
                                </div>

                                <ul className="space-y-3 text-sm text-white/80 mb-5">
                                  <li className="flex gap-3">
                                    <span className="flex-shrink-0 w-6 h-6 rounded-full bg-amber-500/20 text-amber-300 flex items-center justify-center text-xs font-bold">1</span>
                                    <span>Enter your <strong className="text-amber-300">MFL username and password</strong> ‚Äî the same credentials you use to log in at <a href="https://www.myfantasyleague.com" target="_blank" rel="noopener noreferrer" className="text-amber-400 underline underline-offset-2 hover:text-amber-300">myfantasyleague.com</a></span>
                                  </li>
                                  <li className="flex gap-3">
                                    <span className="flex-shrink-0 w-6 h-6 rounded-full bg-amber-500/20 text-amber-300 flex items-center justify-center text-xs font-bold">2</span>
                                    <span>We authenticate directly via <strong className="text-amber-300">MFL's official API</strong> to find your leagues. Your credentials are never stored.</span>
                                  </li>
                                  <li className="flex gap-3">
                                    <span className="flex-shrink-0 w-6 h-6 rounded-full bg-amber-500/20 text-amber-300 flex items-center justify-center text-xs font-bold">3</span>
                                    <span>Once connected, select a <strong className="text-amber-300">year range</strong> to import. We'll pull all your leagues, rosters, and trade history.</span>
                                  </li>
                                  <li className="flex gap-3">
                                    <span className="flex-shrink-0 w-6 h-6 rounded-full bg-amber-500/20 text-amber-300 flex items-center justify-center text-xs font-bold">4</span>
                                    <span>MFL is the <strong className="text-amber-300">gold standard for dynasty</strong> ‚Äî we import everything from records to transactions.</span>
                                  </li>
                                </ul>

                                <div className="rounded-xl bg-black/30 border border-white/10 p-3 mb-4">
                                  <p className="text-xs text-white/50 mb-1 uppercase tracking-wide font-medium">Security note</p>
                                  <p className="text-sm text-white/70">Your MFL credentials are used only during authentication and are never stored. We only read league data ‚Äî nothing is ever modified.</p>
                                </div>

                                <div className="flex justify-end">
                                  <button onClick={() => setShowMflHelp(false)} className="px-5 py-2 rounded-xl bg-gradient-to-r from-amber-500 to-orange-500 text-white font-medium text-sm hover:from-amber-400 hover:to-orange-400 transition">
                                    Got it
                                  </button>
                                </div>
                              </div>
                            </div>
                          </div>
                        )}

                        {mflConnected ? (
                          <>
                            <div className="p-4 rounded-xl bg-green-500/10 border border-green-400/30">
                              <div className="flex items-center gap-3">
                                <span className="text-2xl">‚úÖ</span>
                                <div>
                                  <div className="text-white font-semibold">MFL Connected</div>
                                  <div className="text-sm text-gray-400">Logged in as {mflUsername}</div>
                                </div>
                              </div>
                            </div>
                            
                            {/* Year Range Selection */}
                            <div className="p-4 rounded-xl bg-amber-500/10 border border-amber-400/20">
                              <label className="text-[11px] uppercase tracking-wide text-white/50 block mb-3">
                                Import Year Range
                              </label>
                              <div className="flex items-center gap-3">
                                <select
                                  value={mflStartYear}
                                  onChange={(e) => setMflStartYear(parseInt(e.target.value))}
                                  className="flex-1 px-3 py-2 rounded-xl bg-black/30 border border-white/10 text-white text-sm focus:outline-none focus:border-amber-400/50"
                                >
                                  {Array.from({ length: 15 }, (_, i) => new Date().getFullYear() - 14 + i).map(year => (
                                    <option key={year} value={year}>{year}</option>
                                  ))}
                                </select>
                                <span className="text-white/40">to</span>
                                <select
                                  value={mflEndYear}
                                  onChange={(e) => setMflEndYear(parseInt(e.target.value))}
                                  className="flex-1 px-3 py-2 rounded-xl bg-black/30 border border-white/10 text-white text-sm focus:outline-none focus:border-amber-400/50"
                                >
                                  {Array.from({ length: 15 }, (_, i) => new Date().getFullYear() - 14 + i).map(year => (
                                    <option key={year} value={year}>{year}</option>
                                  ))}
                                </select>
                              </div>
                              <p className="text-[10px] text-white/40 mt-2">
                                Imports leagues, rosters, standings, and trade history for all selected years
                              </p>
                            </div>
                            
                            {/* Import Result */}
                            {mflImportResult && (
                              <div className="p-4 rounded-xl bg-green-500/10 border border-green-400/30 space-y-2">
                                <div className="text-sm font-semibold text-green-300">Import Complete!</div>
                                <div className="grid grid-cols-2 gap-2 text-xs">
                                  <div className="text-white/60">Years: <span className="text-white">{mflImportResult.yearsImported?.join(', ')}</span></div>
                                  <div className="text-white/60">Leagues: <span className="text-white">{mflImportResult.leaguesFound}</span></div>
                                  <div className="text-white/60">Trades: <span className="text-white">{mflImportResult.tradesImported}</span></div>
                                  <div className="text-white/60">Record: <span className="text-white">{mflImportResult.record?.wins}-{mflImportResult.record?.losses}-{mflImportResult.record?.ties}</span></div>
                                </div>
                              </div>
                            )}
                            
                            {mflLeagues.length > 0 && (
                              <div className="space-y-2">
                                <label className="text-[11px] uppercase tracking-wide text-white/50">
                                  Your MFL Leagues ({mflLeagues.length})
                                </label>
                                <div className="max-h-48 overflow-y-auto space-y-2">
                                  {mflLeagues.map((league: any) => (
                                    <div
                                      key={league.leagueId}
                                      className="p-3 rounded-xl bg-black/30 border border-white/10 flex items-center justify-between"
                                    >
                                      <div>
                                        <div className="text-white font-medium text-sm">{league.name}</div>
                                        <div className="text-xs text-gray-400">
                                          {league.franchiseName && `Playing as ${league.franchiseName}`}
                                        </div>
                                      </div>
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}
                            
                            <div className="flex gap-2">
                              <button
                                onClick={fetchMflLeagues}
                                disabled={mflLoading || mflImporting}
                                className="flex-1 py-3 rounded-2xl font-bold text-white transition disabled:opacity-50
                                  bg-white/10 border border-white/20 hover:bg-white/15"
                              >
                                {mflLoading ? 'Loading...' : 'Refresh'}
                              </button>
                              <button
                                onClick={async () => {
                                  setMflImporting(true)
                                  setMflImportResult(null)
                                  try {
                                    const res = await fetch('/api/mfl/import', {
                                      method: 'POST',
                                      headers: { 'Content-Type': 'application/json' },
                                      body: JSON.stringify({ startYear: mflStartYear, endYear: mflEndYear })
                                    })
                                    const data = await res.json()
                                    if (res.ok) {
                                      setMflImportResult(data)
                                      if (data.leagues) setMflLeagues(data.leagues)
                                    } else {
                                      setMflError(data.error || 'Import failed')
                                    }
                                  } catch (e: any) {
                                    setMflError(e.message)
                                  } finally {
                                    setMflImporting(false)
                                  }
                                }}
                                disabled={mflLoading || mflImporting}
                                className="flex-[2] py-3 rounded-2xl font-bold text-white transition disabled:opacity-50
                                  bg-gradient-to-r from-amber-500/80 to-orange-500/80 hover:from-amber-400/90 hover:to-orange-400/90
                                  shadow-[0_12px_35px_rgba(0,0,0,0.35)]"
                              >
                                {mflImporting ? 'Importing All Years...' : `üî• Import ${mflStartYear}‚Äì${mflEndYear}`}
                              </button>
                            </div>
                            
                            {mflError && (
                              <p className="text-sm text-red-400">{mflError}</p>
                            )}
                          </>
                        ) : (
                          <>
                            <div className="p-4 rounded-xl bg-amber-500/10 border border-amber-400/30">
                              <p className="text-sm text-white/80">
                                Connect your MyFantasyLeague account to import your dynasty leagues. We use secure authentication via MFL's official API.
                              </p>
                              <button
                                type="button"
                                onClick={() => setShowMflHelp(true)}
                                className="flex items-center gap-1 text-[11px] text-amber-400 hover:text-amber-300 transition mt-2"
                              >
                                <HelpCircle className="w-3 h-3" />
                                How does this work?
                              </button>
                            </div>
                            
                            <div className="space-y-3">
                              <div>
                                <label className="text-[11px] uppercase tracking-wide text-white/50">MFL Username</label>
                                <input
                                  type="text"
                                  value={mflUsername}
                                  onChange={(e) => setMflUsername(e.target.value)}
                                  placeholder="Your MFL username"
                                  className="w-full mt-1 px-4 py-3 rounded-2xl bg-black/30 border border-white/10 text-white placeholder-white/25 focus:outline-none focus:border-amber-400/60 focus:ring-2 focus:ring-amber-400/20 transition"
                                />
                              </div>
                              <div>
                                <label className="text-[11px] uppercase tracking-wide text-white/50">MFL Password</label>
                                <input
                                  type="password"
                                  value={mflPassword}
                                  onChange={(e) => setMflPassword(e.target.value)}
                                  placeholder="Your MFL password"
                                  className="w-full mt-1 px-4 py-3 rounded-2xl bg-black/30 border border-white/10 text-white placeholder-white/25 focus:outline-none focus:border-amber-400/60 focus:ring-2 focus:ring-amber-400/20 transition"
                                />
                              </div>
                            </div>
                            
                            <button
                              onClick={connectMfl}
                              disabled={mflLoading || !mflUsername.trim() || !mflPassword.trim()}
                              className="w-full py-3 rounded-2xl font-bold text-white transition disabled:opacity-50
                                bg-gradient-to-r from-amber-500/80 to-orange-500/80 hover:from-amber-400/90 hover:to-orange-400/90
                                shadow-[0_12px_35px_rgba(0,0,0,0.35)]"
                            >
                              {mflLoading ? 'Connecting...' : 'Connect MFL Account'}
                            </button>
                          </>
                        )}
                      </div>
                    )}

                    {platform === 'fantrax' && (
                      <div className="space-y-4">
                        {/* Fantrax Help Modal */}
                        {showFantraxHelp && (
                          <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm" onClick={() => setShowFantraxHelp(false)}>
                            <div className="relative w-full max-w-lg rounded-3xl bg-gradient-to-br from-slate-900 to-slate-950 border border-emerald-500/30 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
                              <div className="h-1.5 bg-gradient-to-r from-emerald-400 via-green-500 to-emerald-400" />
                              <div className="p-6">
                                <div className="flex items-center justify-between mb-4">
                                  <h3 className="text-xl font-bold text-white">Finding Your Fantrax User ID</h3>
                                  <button onClick={() => setShowFantraxHelp(false)} className="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center text-white/60 hover:text-white transition">
                                    <X className="w-4 h-4" />
                                  </button>
                                </div>
                                
                                <ul className="space-y-3 text-sm text-white/80 mb-5">
                                  <li className="flex gap-3">
                                    <span className="flex-shrink-0 w-6 h-6 rounded-full bg-emerald-500/20 text-emerald-300 flex items-center justify-center text-xs font-bold">1</span>
                                    <span>In order to log in to your Fantrax account, we need your <strong className="text-emerald-300">secret user ID</strong>.</span>
                                  </li>
                                  <li className="flex gap-3">
                                    <span className="flex-shrink-0 w-6 h-6 rounded-full bg-emerald-500/20 text-emerald-300 flex items-center justify-center text-xs font-bold">2</span>
                                    <span>To get this, go to your profile and find the section where you see your username.</span>
                                  </li>
                                  <li className="flex gap-3">
                                    <span className="flex-shrink-0 w-6 h-6 rounded-full bg-emerald-500/20 text-emerald-300 flex items-center justify-center text-xs font-bold">3</span>
                                    <span>At the <strong className="text-emerald-300">bottom right</strong> of that input field, you will see your user ID.</span>
                                  </li>
                                </ul>
                                
                                <div className="rounded-2xl overflow-hidden border border-white/10 mb-5">
                                  <img 
                                    src="/attached_assets/image_1770140689327.png" 
                                    alt="How to find Fantrax User ID" 
                                    className="w-full"
                                  />
                                </div>
                                
                                <div className="flex justify-end gap-3">
                                  <button onClick={() => setShowFantraxHelp(false)} className="px-4 py-2 rounded-xl text-sm text-white/60 hover:text-white transition">
                                    Skip
                                  </button>
                                  <button onClick={() => setShowFantraxHelp(false)} className="px-5 py-2 rounded-xl bg-gradient-to-r from-emerald-500 to-green-500 text-white font-medium text-sm hover:from-emerald-400 hover:to-green-400 transition">
                                    Finish
                                  </button>
                                </div>
                              </div>
                            </div>
                          </div>
                        )}
                        
                        <div>
                          <div className="flex items-center justify-between mb-2">
                            <label className="text-[11px] uppercase tracking-wide text-white/50">
                              Your Fantrax User ID
                            </label>
                            <button 
                              onClick={() => setShowFantraxHelp(true)}
                              className="flex items-center gap-1 text-[11px] text-emerald-400 hover:text-emerald-300 transition"
                            >
                              <HelpCircle className="w-3 h-3" />
                              How to find this
                            </button>
                          </div>
                          <input
                            type="text"
                            value={fantraxUsername}
                            onChange={(e) => setFantraxUsername(e.target.value)}
                            placeholder="e.g. dynastydaddy"
                            className="w-full px-4 py-3 rounded-2xl bg-black/30 border border-white/10 text-white placeholder-white/25 focus:outline-none focus:border-green-400/60 focus:ring-2 focus:ring-green-400/20 transition"
                          />
                          <p className="text-[10px] text-white/40 mt-1">Found under User Information in your Fantrax profile</p>
                        </div>
                        
                        <div>
                          <label className="text-[11px] uppercase tracking-wide text-white/50 block mb-2">
                            League Name (Optional)
                          </label>
                          <input
                            type="text"
                            value={fantraxLeagueName}
                            onChange={(e) => setFantraxLeagueName(e.target.value)}
                            placeholder="e.g. Peach Bowl C2C"
                            className="w-full px-4 py-3 rounded-2xl bg-black/30 border border-white/10 text-white placeholder-white/25 focus:outline-none focus:border-green-400/60 focus:ring-2 focus:ring-green-400/20 transition"
                          />
                          <p className="text-[10px] text-white/40 mt-1">Override auto-detected league name from CSV</p>
                        </div>
                        
                        <div className="flex items-center gap-3">
                          <label className="flex items-center gap-2 cursor-pointer">
                            <input
                              type="checkbox"
                              checked={fantraxIsDevy}
                              onChange={(e) => setFantraxIsDevy(e.target.checked)}
                              className="w-4 h-4 rounded border-white/20 bg-black/30 text-green-500 focus:ring-green-400/50"
                            />
                            <span className="text-sm text-white/70">Devy League</span>
                          </label>
                          <span className="text-[10px] text-white/40">(College players before NFL draft)</span>
                        </div>
                        
                        <div>
                          <label className="text-[11px] uppercase tracking-wide text-white/50 block mb-2">
                            Upload Fantrax CSV Exports
                          </label>
                          <div 
                            className="border-2 border-dashed border-white/20 rounded-2xl p-6 text-center hover:border-green-400/40 transition cursor-pointer"
                            onClick={() => document.getElementById('fantrax-file-input')?.click()}
                            onDragOver={(e) => {
                              e.preventDefault()
                              e.stopPropagation()
                              e.currentTarget.classList.add('border-green-400/60', 'bg-green-500/10')
                            }}
                            onDragLeave={(e) => {
                              e.preventDefault()
                              e.stopPropagation()
                              e.currentTarget.classList.remove('border-green-400/60', 'bg-green-500/10')
                            }}
                            onDrop={(e) => {
                              e.preventDefault()
                              e.stopPropagation()
                              e.currentTarget.classList.remove('border-green-400/60', 'bg-green-500/10')
                              const droppedFiles = Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.csv'))
                              if (droppedFiles.length > 0) {
                                setFantraxFiles(prev => [...prev, ...droppedFiles])
                              }
                            }}
                          >
                            <input
                              id="fantrax-file-input"
                              type="file"
                              multiple
                              accept=".csv"
                              className="hidden"
                              onChange={(e) => {
                                const files = Array.from(e.target.files || [])
                                setFantraxFiles(prev => [...prev, ...files])
                              }}
                            />
                            <div className="text-3xl mb-2">üìÅ</div>
                            <p className="text-white/60 text-sm">
                              Click or drag CSV files here
                            </p>
                            <p className="text-white/40 text-xs mt-1">
                              Export Standings, Roster from Fantrax
                            </p>
                          </div>
                          
                          {fantraxFiles.length > 0 && (
                            <div className="mt-3 space-y-1">
                              {fantraxFiles.map((file, idx) => (
                                <div key={idx} className="flex items-center justify-between px-3 py-2 bg-white/5 rounded-lg">
                                  <span className="text-sm text-white/70 truncate">{file.name}</span>
                                  <button
                                    onClick={(e) => {
                                      e.stopPropagation()
                                      setFantraxFiles(prev => prev.filter((_, i) => i !== idx))
                                    }}
                                    className="text-red-400 hover:text-red-300 text-sm"
                                  >
                                    ‚úï
                                  </button>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                        
                        <button
                          onClick={async () => {
                            if (!fantraxUsername.trim() || fantraxFiles.length === 0) return
                            setFantraxUploading(true)
                            setFantraxError(null)
                            try {
                              const formData = new FormData()
                              formData.append('username', fantraxUsername.trim())
                              formData.append('season', new Date().getFullYear().toString())
                              formData.append('sport', 'cfb')
                              if (fantraxLeagueName.trim()) {
                                formData.append('leagueName', fantraxLeagueName.trim())
                              }
                              formData.append('isDevy', fantraxIsDevy.toString())
                              fantraxFiles.forEach((file, idx) => {
                                formData.append(`file_${idx}`, file)
                              })
                              const res = await fetch('/api/legacy/fantrax', {
                                method: 'POST',
                                body: formData
                              })
                              const data = await res.json()
                              if (!res.ok) {
                                throw new Error(data.error || 'Failed to import')
                              }
                              setFantraxLeagues(prev => [...prev, data.league])
                              setFantraxFiles([])
                              // Save username to sessionStorage for persistence
                              if (typeof window !== 'undefined') {
                                sessionStorage.setItem('af_fantrax_username', fantraxUsername.trim())
                              }
                            } catch (err) {
                              setFantraxError(err instanceof Error ? err.message : 'Import failed')
                            } finally {
                              setFantraxUploading(false)
                            }
                          }}
                          disabled={fantraxUploading || !fantraxUsername.trim() || fantraxFiles.length === 0}
                          className="w-full py-3.5 rounded-2xl font-bold text-white transition disabled:opacity-50
                            bg-gradient-to-r from-green-500/80 to-emerald-500/80 hover:from-green-400/90 hover:to-emerald-400/90
                            shadow-[0_12px_35px_rgba(0,0,0,0.35)]"
                        >
                          {fantraxUploading ? 'Uploading...' : 'üìä Import Fantrax League'}
                        </button>
                        
                        <p className="text-center text-[11px] text-white/40">
                          Export CSV from Fantrax ‚Üí Standings & Roster pages
                        </p>
                        
                        {fantraxLoading && (
                          <div className="text-center text-white/50 text-sm py-4">
                            Loading your Fantrax leagues...
                          </div>
                        )}
                        
                        {fantraxLeagues.length > 0 && (
                          <div className="mt-4 space-y-3">
                            <label className="text-[11px] uppercase tracking-wide text-white/50">
                              Your Fantrax Leagues ({fantraxLeagues.length})
                            </label>
                            {fantraxLeagues.map((league: any, idx: number) => (
                              <div key={league.id || idx} className="p-4 rounded-xl bg-gradient-to-br from-green-500/10 to-emerald-500/5 border border-green-400/30">
                                <div className="flex items-start justify-between mb-3">
                                  <div>
                                    <div className="text-white font-bold text-lg flex items-center gap-2">
                                      {league.name}
                                      {league.isChampion && <span className="text-xl">üèÜ</span>}
                                      {league.isDevy && (
                                        <span className="px-2 py-0.5 bg-purple-500/20 text-purple-400 border border-purple-400/30 rounded text-[10px] font-semibold uppercase">
                                          Devy
                                        </span>
                                      )}
                                    </div>
                                    <div className="text-sm text-white/60 mt-1">
                                      {league.sport?.toUpperCase()} ¬∑ {league.season} ¬∑ {league.teamCount} teams
                                    </div>
                                  </div>
                                  {league.playoffFinish && (
                                    <span className={`px-2 py-1 rounded-lg text-xs font-semibold ${
                                      league.playoffFinish === 'Champion' 
                                        ? 'bg-yellow-500/20 text-yellow-400 border border-yellow-400/30' 
                                        : league.playoffFinish === 'Runner-up'
                                        ? 'bg-gray-400/20 text-gray-300 border border-gray-400/30'
                                        : 'bg-green-500/20 text-green-400 border border-green-400/30'
                                    }`}>
                                      {league.playoffFinish}
                                    </span>
                                  )}
                                </div>
                                
                                <div className="grid grid-cols-3 gap-3 text-center">
                                  <div className="bg-black/20 rounded-lg p-2">
                                    <div className="text-lg font-bold text-white">{league.record}</div>
                                    <div className="text-[10px] text-white/40 uppercase">Record</div>
                                  </div>
                                  <div className="bg-black/20 rounded-lg p-2">
                                    <div className="text-lg font-bold text-cyan-400">{league.pointsFor ? league.pointsFor.toFixed(1) : '‚Äî'}</div>
                                    <div className="text-[10px] text-white/40 uppercase">Points For</div>
                                  </div>
                                  <div className="bg-black/20 rounded-lg p-2">
                                    <div className="text-lg font-bold text-white/70">#{league.rank || '‚Äî'}</div>
                                    <div className="text-[10px] text-white/40 uppercase">Rank</div>
                                  </div>
                                </div>
                                
                                {league.roster && Array.isArray(league.roster) && league.roster.length > 0 && (
                                  <div className="mt-3 pt-3 border-t border-white/10">
                                    <div className="text-[10px] text-white/40 uppercase mb-2">
                                      Roster ({league.roster.length} players)
                                    </div>
                                    <div className="flex flex-wrap gap-1">
                                      {league.roster.slice(0, 8).map((player: any, pidx: number) => (
                                        <span key={pidx} className="px-1.5 py-0.5 bg-white/5 rounded text-[10px] text-white/60">
                                          <PlayerBadge name={player.name || ''} sleeperId={player.id || player.playerId} position={player.position} team={player.team} size="sm" showTeamLogo={false} />
                                        </span>
                                      ))}
                                      {league.roster.length > 8 && (
                                        <span className="px-2 py-0.5 bg-white/5 rounded text-[10px] text-white/40">
                                          +{league.roster.length - 8} more
                                        </span>
                                      )}
                                    </div>
                                  </div>
                                )}
                                
                                {league.transactions && (
                                  <div className="mt-3 pt-3 border-t border-white/10">
                                    <div className="text-[10px] text-white/40 uppercase mb-2">
                                      Transaction History
                                    </div>
                                    <div className="flex flex-wrap gap-2">
                                      {league.transactions.claims?.length > 0 && (
                                        <span className="px-2 py-1 bg-green-500/10 border border-green-400/20 rounded text-[10px] text-green-400">
                                          {league.transactions.claims.length} Claims
                                        </span>
                                      )}
                                      {league.transactions.drops?.length > 0 && (
                                        <span className="px-2 py-1 bg-red-500/10 border border-red-400/20 rounded text-[10px] text-red-400">
                                          {league.transactions.drops.length} Drops
                                        </span>
                                      )}
                                      {league.transactions.trades?.length > 0 && (
                                        <span className="px-2 py-1 bg-cyan-500/10 border border-cyan-400/20 rounded text-[10px] text-cyan-400">
                                          {league.transactions.trades.length} Trades
                                        </span>
                                      )}
                                      {league.transactions.userTransactions?.length > 0 && (
                                        <span className="px-2 py-1 bg-purple-500/10 border border-purple-400/20 rounded text-[10px] text-purple-400">
                                          {league.transactions.userTransactions.length} Your Transactions
                                        </span>
                                      )}
                                    </div>
                                  </div>
                                )}
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    )}

                    {platform === 'espn' && (
                      <div className="space-y-4">
                        {showEspnHelp && (
                          <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm" onClick={() => setShowEspnHelp(false)}>
                            <div className="relative w-full max-w-lg rounded-3xl bg-gradient-to-br from-slate-900 to-slate-950 border border-red-500/30 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
                              <div className="h-1.5 bg-gradient-to-r from-red-400 via-rose-500 to-red-400" />
                              <div className="p-6">
                                <div className="flex items-center justify-between mb-4">
                                  <h3 className="text-xl font-bold text-white">How to Import from ESPN</h3>
                                  <button onClick={() => setShowEspnHelp(false)} className="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center text-white/60 hover:text-white transition">
                                    <X className="w-4 h-4" />
                                  </button>
                                </div>

                                <ul className="space-y-3 text-sm text-white/80 mb-5">
                                  <li className="flex gap-3">
                                    <span className="flex-shrink-0 w-6 h-6 rounded-full bg-red-500/20 text-red-300 flex items-center justify-center text-xs font-bold">1</span>
                                    <span>Go to <a href="https://fantasy.espn.com" target="_blank" rel="noopener noreferrer" className="text-red-400 underline underline-offset-2 hover:text-red-300">fantasy.espn.com</a> and sign into your account.</span>
                                  </li>
                                  <li className="flex gap-3">
                                    <span className="flex-shrink-0 w-6 h-6 rounded-full bg-red-500/20 text-red-300 flex items-center justify-center text-xs font-bold">2</span>
                                    <span>Open your league. Your <strong className="text-red-300">League ID</strong> is the number in the URL after <code className="text-xs bg-black/40 px-1 py-0.5 rounded text-red-300">leagueId=</code></span>
                                  </li>
                                  <li className="flex gap-3">
                                    <span className="flex-shrink-0 w-6 h-6 rounded-full bg-red-500/20 text-red-300 flex items-center justify-center text-xs font-bold">3</span>
                                    <span>Your <strong className="text-red-300">Team Name</strong> is shown on the "My Team" page ‚Äî enter it exactly as displayed.</span>
                                  </li>
                                  <li className="flex gap-3">
                                    <span className="flex-shrink-0 w-6 h-6 rounded-full bg-red-500/20 text-red-300 flex items-center justify-center text-xs font-bold">4</span>
                                    <span>Your league must be <strong className="text-red-300">public</strong>. Check League Settings &gt; "Make League Viewable to Public."</span>
                                  </li>
                                </ul>

                                <div className="flex justify-end">
                                  <button onClick={() => setShowEspnHelp(false)} className="px-5 py-2 rounded-xl bg-gradient-to-r from-red-500 to-rose-500 text-white font-medium text-sm hover:from-red-400 hover:to-rose-400 transition">
                                    Got it
                                  </button>
                                </div>
                              </div>
                            </div>
                          </div>
                        )}

                        <div>
                          <div className="flex items-center justify-between mb-2">
                            <label className="text-[11px] uppercase tracking-wide text-white/50">
                              ESPN League ID
                            </label>
                            <button
                              onClick={() => setShowEspnHelp(true)}
                              className="flex items-center gap-1 text-[11px] text-red-400 hover:text-red-300 transition"
                            >
                              <HelpCircle className="w-3 h-3" />
                              How to find this
                            </button>
                          </div>
                          <input
                            type="text"
                            value={espnLeagueId}
                            onChange={(e) => {
                              const raw = e.target.value
                              const match = raw.match(/leagueId=(\d+)/)
                              setEspnLeagueId(match ? match[1] : raw)
                              setEspnError('')
                              setEspnResult(null)
                              setEspnAvailableTeams([])
                            }}
                            placeholder="e.g. 1467252495 or paste ESPN league URL"
                            className="w-full px-4 py-3 rounded-2xl bg-black/30 border border-white/10 text-white placeholder-white/25 focus:outline-none focus:border-red-400/60 focus:ring-2 focus:ring-red-400/20 transition"
                          />
                          <p className="text-[10px] text-white/40 mt-1">Paste your full ESPN league URL or just the numeric ID</p>
                        </div>

                        <div>
                          <label className="text-[11px] uppercase tracking-wide text-white/50 block mb-2">
                            Your Team Name
                          </label>
                          {espnAvailableTeams.length > 0 ? (
                            <select
                              value={espnTeamName}
                              onChange={(e) => { setEspnTeamName(e.target.value); setEspnError('') }}
                              className="w-full px-4 py-3 rounded-2xl bg-black/30 border border-white/10 text-white focus:outline-none focus:border-red-400/60 focus:ring-2 focus:ring-red-400/20 transition"
                            >
                              <option value="">Select your team...</option>
                              {espnAvailableTeams.map(name => (
                                <option key={name} value={name}>{name}</option>
                              ))}
                            </select>
                          ) : (
                            <input
                              type="text"
                              value={espnTeamName}
                              onChange={(e) => { setEspnTeamName(e.target.value); setEspnError('') }}
                              placeholder="e.g. ceejay's Competitive Team"
                              className="w-full px-4 py-3 rounded-2xl bg-black/30 border border-white/10 text-white placeholder-white/25 focus:outline-none focus:border-red-400/60 focus:ring-2 focus:ring-red-400/20 transition"
                            />
                          )}
                          <p className="text-[10px] text-white/40 mt-1">Exactly as it appears on your ESPN team page</p>
                        </div>

                        <button
                          type="button"
                          disabled={espnLoading || !espnLeagueId.trim() || !espnTeamName.trim()}
                          onClick={async () => {
                            setEspnLoading(true)
                            setEspnError('')
                            setEspnResult(null)
                            try {
                              const res = await fetch('/api/legacy/espn-import', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                  league_id: espnLeagueId.replace(/\D/g, ''),
                                  team_name: espnTeamName,
                                }),
                              })
                              const data = await res.json()
                              if (!res.ok) {
                                setEspnError(data.error || 'Import failed')
                                if (data.availableTeams) setEspnAvailableTeams(data.availableTeams)
                                return
                              }
                              setEspnResult(data)

                              const recordParts = (data.userTeam?.record || '0-0').split('-').map(Number)
                              const wins = recordParts[0] || 0
                              const losses = recordParts[1] || 0
                              const ties = recordParts[2] || 0
                              const totalGames = wins + losses + ties

                              setProfile({
                                sleeper_username: `espn_${data.league.leagueId}`,
                                sleeper_user_id: `espn_${data.userTeam?.teamId || ''}`,
                                display_name: data.userTeam?.name || espnTeamName,
                                avatar: '',
                                import_status: 'complete',
                                import_progress: 100,
                              })
                              setStats({
                                seasons_imported: 1,
                                seasons: 1,
                                leagues_played: 1,
                                leagues: 1,
                                wins,
                                losses,
                                ties,
                                record: data.userTeam?.record || '0-0',
                                win_percentage: totalGames > 0 ? Math.round((wins / totalGames) * 1000) / 10 : 0,
                                championships: 0,
                                playoffs: 0,
                                playoff_percentage: 0,
                                total_points_for: data.userTeam?.pointsFor || 0,
                                total_points: data.userTeam?.pointsFor || 0,
                              })
                              setLeagues([{
                                league_id: `espn_${data.league.leagueId}`,
                                name: data.league.name,
                                season: Number(data.league.season) || new Date().getFullYear(),
                                type: 'redraft',
                                scoring: data.league.scoringType || 'PPR',
                                team_count: data.league.numTeams,
                                record: data.userTeam?.record || `${wins}-${losses}`,
                                wins,
                                losses,
                                points_for: data.userTeam?.pointsFor || 0,
                                final_standing: null,
                                playoff_seed: null,
                                is_champion: false,
                                champion_name: '',
                                made_playoffs: false,
                              }])
                              setSeasonBreakdown([{
                                season: String(data.league.season),
                                leagues: 1,
                                wins,
                                losses,
                                ties,
                                championships: 0,
                                playoffs: 0,
                                points_for: data.userTeam?.pointsFor || 0,
                              }])
                              setAiReport(null)
                              setRankingPreview(null)
                              setImportStatus('complete')

                              ;(window as any).gtag?.('event', 'legacy_import_complete', {
                                event_category: 'Legacy',
                                event_label: 'ESPN Import Complete',
                                value: 1,
                              })
                            } catch {
                              setEspnError('Network error ‚Äî please try again')
                            } finally {
                              setEspnLoading(false)
                            }
                          }}
                          className="w-full py-3.5 rounded-2xl font-bold text-base transition-all
                                     bg-gradient-to-r from-red-500 to-rose-500 text-white shadow-lg shadow-red-500/20
                                     hover:from-red-400 hover:to-rose-400 hover:shadow-red-500/30
                                     disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                          {espnLoading ? 'Importing...' : 'Import ESPN League'}
                        </button>

                        {espnError && <p className="text-red-400 text-center text-sm">{espnError}</p>}

                        {espnResult && (
                          <div className="rounded-2xl bg-gradient-to-br from-green-500/10 to-emerald-500/5 border border-green-400/30 p-5 space-y-3">
                            <div className="flex items-center gap-2 text-green-400 font-semibold">
                              <CheckCircle2 className="w-5 h-5" />
                              League imported successfully
                            </div>
                            <div className="text-sm text-white/80 space-y-1">
                              <p><strong className="text-white">{espnResult.league.name}</strong></p>
                              <p className="text-white/60">{espnResult.league.numTeams} teams &middot; {espnResult.league.scoringType} &middot; {espnResult.league.season}</p>
                            </div>
                            <div className="text-sm text-white/80">
                              <p className="font-medium text-white mb-2">Your Team: {espnResult.userTeam.name} ({espnResult.userTeam.record})</p>
                              <div className="grid grid-cols-1 gap-1 max-h-48 overflow-y-auto pr-1">
                                {espnResult.userTeam.roster.map((p: any, i: number) => (
                                  <div key={i} className={`flex items-center justify-between text-xs py-1 px-2 rounded ${p.slot === 'Starter' ? 'bg-green-500/10' : 'bg-white/5'}`}>
                                    <span className="text-white/90 flex items-center gap-1.5"><MiniPlayerImg sleeperId={p.id} name={p.name} size={18} />{p.name}</span>
                                    <span className="flex items-center gap-2">
                                      <span className="text-white/40">{p.nflTeam}</span>
                                      <span className={`px-1.5 py-0.5 rounded text-[10px] font-medium ${
                                        p.position === 'QB' ? 'bg-red-500/20 text-red-300' :
                                        p.position === 'RB' ? 'bg-cyan-500/20 text-cyan-300' :
                                        p.position === 'WR' ? 'bg-green-500/20 text-green-300' :
                                        p.position === 'TE' ? 'bg-amber-500/20 text-amber-300' :
                                        'bg-white/10 text-white/50'
                                      }`}>{p.position}</span>
                                      <span className={`text-[10px] ${p.slot === 'Starter' ? 'text-green-400' : 'text-white/30'}`}>{p.slot}</span>
                                    </span>
                                  </div>
                                ))}
                              </div>
                            </div>
                          </div>
                        )}
                      </div>
                    )}

                    {error && platform === 'sleeper' && <p className="mt-4 text-red-400 text-center text-sm">{error}</p>}
                    {yahooError && platform === 'yahoo' && <p className="mt-4 text-red-400 text-center text-sm">{yahooError}</p>}
                    {mflError && platform === 'mfl' && <p className="mt-4 text-red-400 text-center text-sm">{mflError}</p>}
                    {fantraxError && platform === 'fantrax' && <p className="mt-4 text-red-400 text-center text-sm">{fantraxError}</p>}

                    {/* What happens next - 3 step row */}
                    <div className="mt-6 pt-5 border-t border-white/10">
                      <div className="text-[10px] uppercase tracking-widest text-white/40 text-center mb-3">What happens next</div>
                      <div className="flex items-center justify-between">
                        <div className="flex flex-col items-center text-center flex-1">
                          <div className="w-8 h-8 rounded-full bg-cyan-500/20 border border-cyan-400/30 flex items-center justify-center text-cyan-300 text-sm font-bold mb-1">1</div>
                          <span className="text-[10px] text-white/60">Connect</span>
                        </div>
                        <div className="flex-1 h-px bg-gradient-to-r from-cyan-400/30 to-purple-400/30" />
                        <div className="flex flex-col items-center text-center flex-1">
                          <div className="w-8 h-8 rounded-full bg-purple-500/20 border border-purple-400/30 flex items-center justify-center text-purple-300 text-sm font-bold mb-1">2</div>
                          <span className="text-[10px] text-white/60">Import</span>
                        </div>
                        <div className="flex-1 h-px bg-gradient-to-r from-purple-400/30 to-emerald-400/30" />
                        <div className="flex flex-col items-center text-center flex-1">
                          <div className="w-8 h-8 rounded-full bg-emerald-500/20 border border-emerald-400/30 flex items-center justify-center text-emerald-300 text-sm font-bold mb-1">3</div>
                          <span className="text-[10px] text-white/60">AI Report</span>
                        </div>
                      </div>
                    </div>

                    {/* footer micro */}
                    <div className="mt-5 flex items-center justify-between text-[11px] text-white/45">
                      <span>Powered by AllFantasy</span>
                      <span className="inline-flex items-center gap-1">
                        <span className="text-emerald-400">‚óè</span> Secure import
                      </span>
                    </div>
                  </div>

                  {/* soft corner glow */}
                  <div className="pointer-events-none absolute -bottom-20 -right-16 h-56 w-56 rounded-full bg-purple-500/15 blur-3xl" />
                </div>

                {/* AI Preview Panel - Below form on mobile, can be side column on very wide screens */}
                <div className="mt-6 lg:mt-0">
                  <div className="rounded-2xl border border-white/10 bg-gradient-to-br from-purple-500/5 to-cyan-500/5 p-5">
                    <div className="flex items-center gap-2 mb-4">
                      <Sparkles className="w-4 h-4 text-purple-400" />
                      <h4 className="text-sm font-semibold text-white">Preview: What the AI Generates</h4>
                    </div>
                    
                    {/* AI Report Card Preview */}
                    <div className="mb-3 p-4 rounded-xl bg-gradient-to-br from-cyan-500/10 to-purple-500/10 border border-cyan-400/20">
                      <div className="flex items-center justify-between mb-2">
                        <span className="text-xs font-semibold text-white">AI Report Card</span>
                        <span className="px-1.5 py-0.5 rounded text-[9px] bg-purple-500/30 text-purple-300">AI Generated</span>
                      </div>
                      <div className="grid grid-cols-3 gap-2 text-center">
                        <div className="p-2 rounded-lg bg-black/20">
                          <div className="text-xs text-white/50">Grade</div>
                          <div className="text-xl font-black text-emerald-400">A-</div>
                        </div>
                        <div className="p-2 rounded-lg bg-black/20">
                          <div className="text-xs text-white/50">Score</div>
                          <div className="text-xl font-black text-white">84</div>
                        </div>
                        <div className="p-2 rounded-lg bg-black/20">
                          <div className="text-xs text-white/50">Tier</div>
                          <div className="text-sm font-bold text-amber-300">Contender</div>
                        </div>
                      </div>
                    </div>
                    
                    {/* AI Insight Preview */}
                    <div className="mb-3 p-4 rounded-xl bg-black/20 border border-white/10">
                      <div className="flex items-center justify-between mb-2">
                        <span className="text-xs font-semibold text-white">AI Insight</span>
                        <span className="px-1.5 py-0.5 rounded text-[9px] bg-emerald-500/30 text-emerald-300 flex items-center gap-1">
                          <span className="w-1 h-1 rounded-full bg-emerald-400" />
                          High confidence
                        </span>
                      </div>
                      <p className="text-xs text-white/70 leading-relaxed">
                        "Strong playoff performer with elite roster construction. Your trade timing outperforms 73% of managers."
                      </p>
                    </div>
                    
                    {/* AI Trade Verdict Preview */}
                    <div className="p-4 rounded-xl bg-gradient-to-r from-emerald-500/10 to-green-500/5 border border-emerald-400/20">
                      <div className="flex items-center justify-between mb-2">
                        <span className="text-xs font-semibold text-white">AI Trade Verdict</span>
                        <span className="px-1.5 py-0.5 rounded text-[9px] bg-purple-500/30 text-purple-300">AI Generated</span>
                      </div>
                      <div className="text-lg font-black text-emerald-400 mb-2">SMASH ACCEPT</div>
                      <ul className="text-[11px] text-white/60 space-y-1">
                        <li className="flex items-start gap-1.5">
                          <CheckCircle2 className="w-3 h-3 text-emerald-400 mt-0.5 flex-shrink-0" />
                          You get the best dynasty asset in the deal
                        </li>
                        <li className="flex items-start gap-1.5">
                          <CheckCircle2 className="w-3 h-3 text-emerald-400 mt-0.5 flex-shrink-0" />
                          Age curve strongly favors your side
                        </li>
                      </ul>
                    </div>
                    
                    {/* AI Transparency Note */}
                    <div className="mt-4 pt-3 border-t border-white/10 space-y-1">
                      <p className="text-[11px] text-white/40 flex items-center gap-1.5">
                        <Info className="w-3 h-3" />
                        AI is learning ‚Äî built to get smarter from real user feedback.
                      </p>
                      <p className="text-[10px] text-white/30 italic pl-4">
                        Not perfect (yet). Always verify critical decisions.
                      </p>
                    </div>
                  </div>
                </div>

                {/* Footer line */}
                <p className="text-center text-[11px] text-white/40 mt-4 lg:col-span-2">
                  Powered by the AllFantasy AI ‚Äî live preview
                </p>
              </div>
            </div>

            {/* Below the fold sections */}
            <div className="mt-16 space-y-12">
              {/* What You'll See */}
              <div>
                <div className="text-center mb-8">
                  <h3 className="text-2xl font-bold text-white mb-2">What You'll See</h3>
                  <p className="text-sm text-white/50">Your complete fantasy profile, powered by AI</p>
                </div>
                <div className="grid md:grid-cols-3 gap-4">
                  <div className="group rounded-2xl border border-cyan-500/20 bg-gradient-to-br from-cyan-500/5 to-transparent p-5 hover:border-cyan-400/40 transition-all">
                    <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-500/30 to-cyan-600/20 flex items-center justify-center mb-3">
                      <BarChart3 className="w-5 h-5 text-cyan-400" />
                    </div>
                    <h4 className="font-semibold text-white mb-1">Career Snapshot</h4>
                    <p className="text-xs text-white/50 leading-relaxed">Your performance across leagues, seasons, and formats.</p>
                  </div>
                  <div className="group rounded-2xl border border-purple-500/20 bg-gradient-to-br from-purple-500/5 to-transparent p-5 hover:border-purple-400/40 transition-all">
                    <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500/30 to-purple-600/20 flex items-center justify-center mb-3">
                      <Sparkles className="w-5 h-5 text-purple-400" />
                    </div>
                    <h4 className="font-semibold text-white mb-1">AI Perspective</h4>
                    <p className="text-xs text-white/50 leading-relaxed">How the AI interprets your decisions ‚Äî with confidence indicators.</p>
                  </div>
                  <div className="group rounded-2xl border border-emerald-500/20 bg-gradient-to-br from-emerald-500/5 to-transparent p-5 hover:border-emerald-400/40 transition-all">
                    <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-emerald-500/30 to-emerald-600/20 flex items-center justify-center mb-3">
                      <TrendingUp className="w-5 h-5 text-emerald-400" />
                    </div>
                    <h4 className="font-semibold text-white mb-1">Trends Over Time</h4>
                    <p className="text-xs text-white/50 leading-relaxed">What's improved, what hasn't, and where you gain an edge.</p>
                  </div>
                </div>
              </div>

              {/* App Preview Showcase */}
              <div className="mt-8">
                <h3 className="text-xl font-bold text-white mb-2 text-center">Experience the AF Legacy App</h3>
                <p className="text-sm text-white/50 text-center mb-6">Sleeper-inspired design with AI-powered insights</p>
                
                {/* App Screen Carousel */}
                <div className="relative max-w-md mx-auto">
                  {/* Phone Frame */}
                  <div className="rounded-[2.5rem] border-4 border-gray-800 bg-[#1a1d26] shadow-2xl overflow-hidden">
                    {/* Status Bar */}
                    <div className="flex items-center justify-between px-6 py-2 bg-[#0f1117]">
                      <span className="text-[10px] text-white/60">9:41</span>
                      <div className="flex items-center gap-1">
                        <div className="w-4 h-2 border border-white/40 rounded-sm">
                          <div className="w-3/4 h-full bg-green-400 rounded-sm"></div>
                        </div>
                      </div>
                    </div>
                    
                    {/* App Header */}
                    <div className="px-4 py-3 border-b border-white/10">
                      <div className="flex items-center gap-3">
                        <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-500 to-purple-600 flex items-center justify-center text-white font-bold text-sm">AF</div>
                        <div>
                          <div className="font-bold text-white text-sm">Your Dynasty League</div>
                          <div className="flex items-center gap-1.5 mt-0.5">
                            <span className="px-1.5 py-0.5 rounded text-[8px] font-semibold bg-blue-500/20 text-blue-400">NFL</span>
                            <span className="px-1.5 py-0.5 rounded text-[8px] font-semibold bg-purple-500/20 text-purple-400">Dynasty</span>
                            <span className="px-1.5 py-0.5 rounded text-[8px] font-semibold bg-cyan-500/20 text-cyan-400">12 Teams</span>
                            <span className="px-1.5 py-0.5 rounded text-[8px] font-semibold bg-green-500/20 text-green-400">SF</span>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    {/* Tab Navigation */}
                    <div className="flex items-center gap-1 px-3 py-2 overflow-x-auto border-b border-white/5">
                      <button onClick={() => setPreviewScreen(0)} className={`px-3 py-1.5 rounded-lg text-[10px] font-semibold whitespace-nowrap transition ${previewScreen === 0 ? 'bg-cyan-500/20 text-cyan-400 border border-cyan-500/30' : 'text-white/50 hover:text-white/70'}`}>üèà ROSTER</button>
                      <button onClick={() => setPreviewScreen(1)} className={`px-3 py-1.5 rounded-lg text-[10px] font-semibold whitespace-nowrap transition ${previewScreen === 1 ? 'bg-cyan-500/20 text-cyan-400 border border-cyan-500/30' : 'text-white/50 hover:text-white/70'}`}>üë• LEAGUE</button>
                      <button onClick={() => setPreviewScreen(2)} className={`px-3 py-1.5 rounded-lg text-[10px] font-semibold whitespace-nowrap transition ${previewScreen === 2 ? 'bg-cyan-500/20 text-cyan-400 border border-cyan-500/30' : 'text-white/50 hover:text-white/70'}`}>üìã WAIVERS</button>
                      <button onClick={() => setPreviewScreen(3)} className={`px-3 py-1.5 rounded-lg text-[10px] font-semibold whitespace-nowrap transition ${previewScreen === 3 ? 'bg-cyan-500/20 text-cyan-400 border border-cyan-500/30' : 'text-white/50 hover:text-white/70'}`}>üîÑ TRADES</button>
                    </div>
                    
                    {/* Screen Content */}
                    <div className="p-3 min-h-[280px] bg-[#12151c]">
                      {/* Screen 0: Roster View */}
                      {previewScreen === 0 && (
                        <>
                          <div className="flex items-center justify-between mb-3">
                            <div className="flex items-center gap-2">
                              <div className="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-pink-500"></div>
                              <div>
                                <div className="text-xs font-bold text-white">Your Team</div>
                                <div className="text-[10px] text-white/40">3-1 Record</div>
                              </div>
                            </div>
                            <div className="flex items-center gap-2">
                              <div className="text-center px-2 py-1 rounded bg-white/5">
                                <div className="text-[8px] text-white/40">WAIVER</div>
                                <div className="text-[10px] font-bold text-cyan-400">#3</div>
                              </div>
                              <div className="text-center px-2 py-1 rounded bg-white/5">
                                <div className="text-[8px] text-white/40">TRADE</div>
                                <div className="text-[10px] font-bold text-green-400">2</div>
                              </div>
                            </div>
                          </div>
                          <div className="text-[9px] font-semibold text-white/40 mb-1 flex justify-between px-1">
                            <span>STARTERS</span>
                            <div className="flex gap-4"><span>OWN %</span><span>AI</span></div>
                          </div>
                          <div className="space-y-1">
                            {[
                              { pos: 'QB', name: 'J. Hurts', team: 'PHI', own: '94%', ai: 'üü¢' },
                              { pos: 'RB', name: 'B. Robinson', team: 'WAS', own: '78%', ai: 'üü¢' },
                              { pos: 'RB', name: 'J. Jacobs', team: 'GB', own: '65%', ai: 'üü°' },
                              { pos: 'WR', name: 'J. Chase', team: 'CIN', own: '99%', ai: 'üü¢' },
                              { pos: 'WR', name: 'A. Brown', team: 'PHI', own: '89%', ai: 'üü¢' },
                              { pos: 'TE', name: 'T. Kelce', team: 'KC', own: '97%', ai: 'üü°' },
                            ].map((p, i) => (
                              <div key={i} className="flex items-center justify-between py-1.5 px-2 rounded-lg bg-white/5">
                                <div className="flex items-center gap-2">
                                  <span className={`text-[8px] font-bold px-1.5 py-0.5 rounded ${p.pos === 'QB' ? 'bg-red-500/20 text-red-400' : p.pos === 'RB' ? 'bg-green-500/20 text-green-400' : p.pos === 'WR' ? 'bg-blue-500/20 text-blue-400' : 'bg-orange-500/20 text-orange-400'}`}>{p.pos}</span>
                                  <MiniPlayerImg name={p.name} size={18} />
                                  <div><div className="text-[10px] font-semibold text-white">{p.name}</div><div className="text-[8px] text-white/40">{p.team}</div></div>
                                </div>
                                <div className="flex items-center gap-4"><span className="text-[10px] text-white/60">{p.own}</span><span className="text-[10px]">{p.ai}</span></div>
                              </div>
                            ))}
                          </div>
                        </>
                      )}
                      
                      {/* Screen 1: League Standings */}
                      {previewScreen === 1 && (
                        <>
                          <div className="text-xs font-bold text-white mb-3">Standings</div>
                          <div className="space-y-1">
                            {[
                              { rank: 1, name: 'Threat Level Midnight', record: '4-0', pf: '542', waiver: '$100 (1)' },
                              { rank: 2, name: 'blitzinbeto', record: '3-1', pf: '498', waiver: '$100 (2)' },
                              { rank: 3, name: 'Your Team', record: '3-1', pf: '487', waiver: '$85 (3)', isYou: true },
                              { rank: 4, name: 'Injury Prone', record: '2-2', pf: '456', waiver: '$100 (4)' },
                              { rank: 5, name: 'DB4Life808', record: '2-2', pf: '445', waiver: '$100 (5)' },
                              { rank: 6, name: 'Team Do-do duty', record: '2-2', pf: '432', waiver: '$90 (6)' },
                              { rank: 7, name: 'They\'re Cute', record: '1-3', pf: '398', waiver: '$100 (7)' },
                            ].map((t, i) => (
                              <div key={i} className={`flex items-center justify-between py-1.5 px-2 rounded-lg ${t.isYou ? 'bg-cyan-500/20 border border-cyan-500/30' : 'bg-white/5'}`}>
                                <div className="flex items-center gap-2">
                                  <span className="text-[10px] font-bold text-white/60 w-4">{t.rank}</span>
                                  <div className="w-5 h-5 rounded-full bg-gradient-to-br from-gray-600 to-gray-700"></div>
                                  <div className="text-[10px] font-semibold text-white truncate max-w-[100px]">{t.name}</div>
                                </div>
                                <div className="flex items-center gap-3">
                                  <div className="text-right"><div className="text-[10px] font-bold text-white">{t.record}</div><div className="text-[8px] text-white/40">PF {t.pf}</div></div>
                                  <div className="text-[8px] text-cyan-400 w-16 text-right">{t.waiver}</div>
                                </div>
                              </div>
                            ))}
                          </div>
                        </>
                      )}
                      
                      {/* Screen 2: Waivers */}
                      {previewScreen === 2 && (
                        <>
                          <div className="flex items-center gap-2 mb-3">
                            <div className="flex gap-1">
                              {['ALL', 'QB', 'RB', 'WR', 'TE'].map((pos, i) => (
                                <button key={pos} className={`px-2 py-1 rounded text-[8px] font-semibold ${i === 0 ? 'bg-cyan-500/20 text-cyan-400' : 'bg-white/5 text-white/50'}`}>{pos}</button>
                              ))}
                            </div>
                          </div>
                          <div className="text-[9px] font-semibold text-white/40 mb-1 flex justify-between px-1">
                            <span>PLAYER</span>
                            <div className="flex gap-3"><span>PROJ</span><span>AI REC</span></div>
                          </div>
                          <div className="space-y-1">
                            {[
                              { name: 'G. Ward', pos: 'WR', team: 'PHI', proj: '12.4', rec: 'üî• ADD', color: 'green' },
                              { name: 'Q. McDuffie', pos: 'WR', team: 'GB', proj: '10.2', rec: 'ADD', color: 'green' },
                              { name: 'B. Watson', pos: 'TE', team: 'NYG', proj: '8.7', rec: 'WATCH', color: 'yellow' },
                              { name: 'A. Bloom', pos: 'TE', team: 'DAL', proj: '7.1', rec: 'WATCH', color: 'yellow' },
                              { name: 'J. Robinson', pos: 'RB', team: 'JAX', proj: '6.8', rec: 'AVOID', color: 'red' },
                              { name: 'N. Brown', pos: 'WR', team: 'WAS', proj: '5.9', rec: 'WATCH', color: 'yellow' },
                            ].map((p, i) => (
                              <div key={i} className="flex items-center justify-between py-1.5 px-2 rounded-lg bg-white/5">
                                <div className="flex items-center gap-2">
                                  <span className={`text-[8px] font-bold px-1.5 py-0.5 rounded ${p.pos === 'WR' ? 'bg-blue-500/20 text-blue-400' : p.pos === 'TE' ? 'bg-orange-500/20 text-orange-400' : 'bg-green-500/20 text-green-400'}`}>{p.pos}</span>
                                  <MiniPlayerImg name={p.name} size={18} />
                                  <div><div className="text-[10px] font-semibold text-white">{p.name}</div><div className="text-[8px] text-white/40">{p.team}</div></div>
                                </div>
                                <div className="flex items-center gap-3">
                                  <span className="text-[10px] text-white/60">{p.proj}</span>
                                  <span className={`text-[8px] font-bold px-1.5 py-0.5 rounded ${p.color === 'green' ? 'bg-green-500/20 text-green-400' : p.color === 'yellow' ? 'bg-yellow-500/20 text-yellow-400' : 'bg-red-500/20 text-red-400'}`}>{p.rec}</span>
                                </div>
                              </div>
                            ))}
                          </div>
                        </>
                      )}
                      
                      {/* Screen 3: Trades */}
                      {previewScreen === 3 && (
                        <>
                          <div className="flex items-center justify-between mb-3">
                            <div className="text-xs font-bold text-white">Active Trades</div>
                            <button className="px-2 py-1 rounded-lg text-[9px] font-semibold bg-cyan-500/20 text-cyan-400 border border-cyan-500/30">+ TRADE</button>
                          </div>
                          <div className="space-y-2">
                            <div className="p-2 rounded-lg bg-white/5 border border-white/10">
                              <div className="flex items-center justify-between mb-2">
                                <div className="flex items-center gap-1"><span className="text-[8px] px-1.5 py-0.5 rounded bg-orange-500/20 text-orange-400">OUTGOING</span><span className="text-[9px] text-white/60">2 days ago</span></div>
                                <span className="text-[8px] px-1.5 py-0.5 rounded bg-yellow-500/20 text-yellow-400">PENDING</span>
                              </div>
                              <div className="flex items-center justify-between">
                                <div className="flex items-center gap-1">
                                  <div className="w-6 h-6 rounded-full bg-gray-700"></div>
                                  <div><div className="text-[9px] font-semibold text-white">T. Allgeier</div><div className="text-[7px] text-white/40">RB</div></div>
                                  <span className="text-[8px] bg-purple-500/20 text-purple-400 px-1 rounded">1st 2026</span>
                                </div>
                                <span className="text-white/40">=</span>
                                <div className="flex items-center gap-1">
                                  <div className="w-6 h-6 rounded-full bg-gray-700"></div>
                                  <div><div className="text-[9px] font-semibold text-white">B. Young</div><div className="text-[7px] text-white/40">QB</div></div>
                                </div>
                              </div>
                              <div className="mt-2 pt-2 border-t border-white/5 flex items-center justify-between">
                                <span className="text-[8px] text-white/40">AI Analysis:</span>
                                <span className="text-[8px] font-bold text-green-400">Fair Trade üü¢</span>
                              </div>
                            </div>
                            <div className="p-2 rounded-lg bg-white/5 border border-white/10">
                              <div className="flex items-center justify-between mb-2">
                                <div className="flex items-center gap-1"><span className="text-[8px] px-1.5 py-0.5 rounded bg-cyan-500/20 text-cyan-400">INCOMING</span><span className="text-[9px] text-white/60">3 days ago</span></div>
                                <span className="text-[8px] px-1.5 py-0.5 rounded bg-green-500/20 text-green-400">ACCEPTED</span>
                              </div>
                              <div className="flex items-center justify-between">
                                <div className="flex items-center gap-1">
                                  <div className="w-6 h-6 rounded-full bg-gray-700"></div>
                                  <div><div className="text-[9px] font-semibold text-white">J. Dart</div><div className="text-[7px] text-white/40">QB</div></div>
                                </div>
                                <span className="text-white/40">=</span>
                                <div className="flex items-center gap-1">
                                  <div className="w-6 h-6 rounded-full bg-gray-700"></div>
                                  <div><div className="text-[9px] font-semibold text-white">T. Allgeier</div><div className="text-[7px] text-white/40">RB</div></div>
                                  <span className="text-[8px] bg-purple-500/20 text-purple-400 px-1 rounded">1st</span>
                                </div>
                              </div>
                            </div>
                          </div>
                        </>
                      )}
                    </div>
                    
                    {/* Chat Bar */}
                    <div className="px-3 py-2 border-t border-white/10 bg-[#0f1117]">
                      <div className="flex items-center gap-2">
                        <div className="flex-1 flex items-center gap-2 px-3 py-2 rounded-full bg-white/5 border border-white/10">
                          <span className="text-white/30 text-xs">üí¨</span>
                          <span className="text-[10px] text-white/40">Ask AI about your roster...</span>
                        </div>
                        <div className="w-8 h-8 rounded-full bg-gradient-to-br from-cyan-500 to-purple-500 flex items-center justify-center">
                          <span className="text-white text-xs">‚Üí</span>
                        </div>
                      </div>
                    </div>
                    
                    {/* Home Indicator */}
                    <div className="flex justify-center py-2 bg-[#0f1117]">
                      <div className="w-24 h-1 rounded-full bg-white/20"></div>
                    </div>
                  </div>
                  
                  {/* Navigation Arrows */}
                  <div className="absolute top-1/2 -left-12 transform -translate-y-1/2 hidden sm:block">
                    <button 
                      onClick={() => setPreviewScreen(prev => prev === 0 ? 3 : (prev - 1) as 0 | 1 | 2 | 3)}
                      className="w-8 h-8 rounded-full bg-white/10 border border-white/20 flex items-center justify-center text-white/60 hover:bg-white/20 transition"
                    >
                      ‚Üê
                    </button>
                  </div>
                  <div className="absolute top-1/2 -right-12 transform -translate-y-1/2 hidden sm:block">
                    <button 
                      onClick={() => setPreviewScreen(prev => prev === 3 ? 0 : (prev + 1) as 0 | 1 | 2 | 3)}
                      className="w-8 h-8 rounded-full bg-white/10 border border-white/20 flex items-center justify-center text-white/60 hover:bg-white/20 transition"
                    >
                      ‚Üí
                    </button>
                  </div>
                  
                  {/* Screen Indicators */}
                  <div className="flex justify-center gap-2 mt-4">
                    {[0, 1, 2, 3].map(i => (
                      <button 
                        key={i}
                        onClick={() => setPreviewScreen(i as 0 | 1 | 2 | 3)}
                        className={`w-2 h-2 rounded-full transition ${previewScreen === i ? 'bg-cyan-400' : 'bg-white/20 hover:bg-white/40'}`}
                      />
                    ))}
                  </div>
                </div>
                
                {/* Screen Flow Stepper */}
                <div className="flex items-center justify-center gap-1 sm:gap-2 mt-6 max-w-lg mx-auto overflow-x-auto">
                  {[
                    { id: 0, icon: 'üèà', label: 'Roster' },
                    { id: 1, icon: 'üë•', label: 'League' },
                    { id: 2, icon: 'üìã', label: 'Waivers' },
                    { id: 3, icon: 'üîÑ', label: 'Trades' },
                  ].map((screen, i) => (
                    <div key={screen.id} className="flex items-center">
                      <button
                        onClick={() => setPreviewScreen(screen.id as 0 | 1 | 2 | 3)}
                        className={`flex flex-col items-center p-2 sm:p-3 rounded-xl transition ${
                          previewScreen === screen.id 
                            ? 'bg-cyan-500/20 border border-cyan-400/50 scale-105' 
                            : 'bg-white/5 border border-white/10 hover:bg-white/10'
                        }`}
                      >
                        <span className="text-lg sm:text-xl">{screen.icon}</span>
                        <span className={`text-[9px] sm:text-[10px] font-semibold mt-1 ${previewScreen === screen.id ? 'text-cyan-400' : 'text-white/60'}`}>{screen.label}</span>
                      </button>
                      {i < 3 && (
                        <div className="mx-1 sm:mx-2 text-white/30 text-lg">‚Üí</div>
                      )}
                    </div>
                  ))}
                </div>
                
                {/* Chat Bar Highlight */}
                <div className="flex items-center justify-center gap-2 mt-4">
                  <div className="text-white/40 text-sm">‚Üì</div>
                  <div className="px-3 py-1.5 rounded-full bg-gradient-to-r from-cyan-500/20 to-purple-500/20 border border-cyan-500/30">
                    <span className="text-[10px] text-cyan-400 font-semibold">üí¨ AI Chat Available on Every Screen</span>
                  </div>
                  <div className="text-white/40 text-sm">‚Üì</div>
                </div>
              </div>

              {/* AI Transparency */}
              <div className="rounded-2xl border border-amber-500/20 bg-amber-500/5 p-6">
                <h3 className="text-lg font-semibold text-white mb-3">The AI isn't perfect ‚Äî and that's the point.</h3>
                <p className="text-sm text-white/60 mb-3">
                  AF Legacy is a live preview of the AI powering the AllFantasy app launching in 2026. 
                  Some insights are marked "learning" as the AI ingests more league data and improves.
                </p>
              </div>

              {/* Feedback CTA */}
              <div className="text-center">
                <h3 className="text-lg font-semibold text-white mb-2">Help the AI learn from your leagues</h3>
                <p className="text-sm text-white/50 mb-4">
                  Something feel right or off? One sentence helps the AI get smarter.
                </p>
                <button
                  onClick={() => setShowFeedback(true)}
                  className="inline-flex items-center gap-2 px-5 py-2.5 rounded-full bg-white/10 border border-white/20 text-sm font-medium text-white hover:bg-white/15 transition"
                >
                  <MessageSquareText className="h-4 w-4" />
                  Share Feedback
                </button>
              </div>

              {/* Secondary Actions */}
              <div className="flex flex-wrap justify-center gap-4 pt-4 border-t border-white/5">
                <a
                  href="/submit-league"
                  className="text-sm text-white/50 hover:text-white/70 transition"
                >
                  Submit League Idea
                </a>
                <a
                  href="/"
                  className="text-sm text-white/50 hover:text-white/70 transition"
                >
                  Join Early Access
                </a>
              </div>
            </div>
          </div>
        )}

        {importStatus === 'importing' && leagues.length === 0 && (() => {
          // Progress comes from backend: 5% start, then 5-95% based on seasons processed, then 100% when done
          // Adjusted thresholds to match actual progress pattern
          const steps = [
            { label: 'Connecting to Sleeper', threshold: 5 },
            { label: 'Loading leagues', threshold: 15 },
            { label: 'Calculating legacy stats', threshold: 40 },
            { label: 'Generating AI insights', threshold: 70 },
            { label: 'Preparing dashboard', threshold: 100 },
          ]
          // Find which step we're on based on progress
          const currentStepIdx = steps.findIndex(s => importProgress < s.threshold)
          const activeStep = currentStepIdx === -1 ? steps.length - 1 : Math.max(0, currentStepIdx)

          return (
            <div className="max-w-lg mx-auto px-4">
              {/* Premium Loading Card */}
              <div className="relative rounded-3xl bg-gradient-to-br from-slate-900/95 via-slate-900/90 to-slate-950/95 border border-cyan-500/25 backdrop-blur-xl shadow-[0_25px_80px_rgba(0,0,0,0.5)] overflow-hidden">
                {/* Gradient accent line */}
                <div className="h-1.5 bg-gradient-to-r from-cyan-400 via-purple-500 to-cyan-400" />
                
                <div className="p-6 sm:p-8">
                  {/* AllFantasy AI Mark */}
                  <div className="flex items-center justify-center gap-2 mb-6">
                    <div className="w-6 h-6 rounded-lg bg-gradient-to-br from-cyan-500 to-purple-500 flex items-center justify-center">
                      <span className="text-xs font-black text-white">AF</span>
                    </div>
                    <span className="text-sm font-semibold text-white/60">AllFantasy AI</span>
                  </div>

                  {/* Avatar + Name */}
                  <div className="text-center mb-6">
                    {profile?.avatar && (
                      <div className="relative inline-block mb-3">
                        <div className="absolute -inset-1.5 rounded-full bg-gradient-to-r from-cyan-400/50 to-purple-500/50 blur-md animate-pulse" />
                        <img
                          src={profile.avatar}
                          alt="Avatar"
                          className="relative w-20 h-20 rounded-full border-2 border-cyan-400/60 ring-2 ring-purple-500/40 object-cover"
                        />
                      </div>
                    )}
                    <h2 className="text-xl sm:text-2xl font-bold text-white">
                      {profile?.display_name || 'Building Your Legacy'}
                    </h2>
                    <p className="text-white/50 text-sm mt-1">Importing your fantasy history...</p>
                  </div>

                  {/* Progress Bar - Prominent */}
                  <div className="mb-6">
                    <div className="w-full bg-black/60 rounded-full h-4 border border-white/10 overflow-hidden">
                      <div
                        className="bg-gradient-to-r from-cyan-500 via-purple-500 to-cyan-400 h-4 rounded-full transition-all duration-500 relative"
                        style={{ width: `${importProgress}%` }}
                      >
                        <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent animate-shimmer" />
                      </div>
                    </div>
                    <div className="flex items-center justify-between mt-2">
                      <p className="text-cyan-400 text-lg font-bold">{importProgress}% complete</p>
                      <p className="text-white/40 text-xs">
                        {importProgress >= 90 ? 'Almost done...' : 
                         importProgress >= 70 ? '~30 sec remaining' :
                         importProgress >= 40 ? '~1 min remaining' :
                         '~2 min remaining'}
                      </p>
                    </div>
                  </div>

                  {/* Live Status Stepper */}
                  <div className="mb-6 p-4 rounded-2xl bg-black/30 border border-white/10">
                    <div className="text-xs uppercase tracking-widest text-white/40 mb-3 text-center">Live Status</div>
                    <div className="space-y-2">
                      {steps.map((step, idx) => {
                        const isComplete = importProgress >= step.threshold
                        const isActive = idx === activeStep
                        return (
                          <div key={idx} className={`flex items-center gap-3 px-3 py-2 rounded-xl transition-all ${
                            isActive ? 'bg-cyan-500/15 border border-cyan-400/30' : 
                            isComplete ? 'opacity-60' : 'opacity-40'
                          }`}>
                            <div className={`w-5 h-5 rounded-full flex items-center justify-center text-xs ${
                              isComplete ? 'bg-emerald-500/30 text-emerald-300' :
                              isActive ? 'bg-cyan-500/30 text-cyan-300 animate-pulse' :
                              'bg-white/10 text-white/40'
                            }`}>
                              {isComplete ? '‚úì' : isActive ? '‚Ä¢' : (idx + 1)}
                            </div>
                            <span className={`text-sm ${
                              isActive ? 'text-white font-medium' : 
                              isComplete ? 'text-white/60' : 'text-white/40'
                            }`}>{step.label}</span>
                            {isActive && (
                              <div className="ml-auto flex gap-1">
                                <span className="w-1.5 h-1.5 rounded-full bg-cyan-400 animate-bounce" style={{ animationDelay: '0ms' }} />
                                <span className="w-1.5 h-1.5 rounded-full bg-cyan-400 animate-bounce" style={{ animationDelay: '150ms' }} />
                                <span className="w-1.5 h-1.5 rounded-full bg-cyan-400 animate-bounce" style={{ animationDelay: '300ms' }} />
                              </div>
                            )}
                          </div>
                        )
                      })}
                    </div>
                  </div>

                  {/* What's Being Built Preview */}
                  <div className="mb-6">
                    <div className="text-xs uppercase tracking-widest text-white/40 mb-3 text-center">What You'll Get</div>
                    <div className="grid grid-cols-2 gap-2">
                      {[
                        { icon: 'üìä', label: 'Report Card' },
                        { icon: 'ü§ñ', label: 'AI Insights' },
                        { icon: 'üèÜ', label: 'Power Rankings' },
                        { icon: 'üîÑ', label: 'Trade Evaluator' },
                        { icon: 'üìà', label: 'Waiver AI' },
                        { icon: 'üí¨', label: 'AI Coaching' },
                      ].map((item, idx) => (
                        <div key={idx} className="flex items-center gap-2 px-3 py-2 rounded-xl bg-white/5 border border-white/10">
                          <span className="text-base">{item.icon}</span>
                          <span className="text-xs text-white/70">{item.label}</span>
                        </div>
                      ))}
                    </div>
                  </div>

                  {/* Trust + Transparency */}
                  <div className="space-y-2 text-center mb-4">
                    <div className="flex items-center justify-center gap-2 text-xs text-emerald-400/80">
                      <span>üîí</span>
                      <span>Read-only import ‚Ä¢ No passwords ‚Ä¢ Your leagues stay untouched</span>
                    </div>
                    <p className="text-[11px] text-white/35 italic leading-relaxed">
                      AI is learning ‚Äî built to get smarter from real user feedback. Not perfect (yet).
                    </p>
                  </div>

                  {/* Micro Feedback Prompt */}
                  <div className="pt-4 border-t border-white/10 text-center">
                    <button
                      onClick={() => setShowFeedback(true)}
                      className="text-xs text-white/40 hover:text-cyan-400 transition"
                    >
                      Spot something off later? Leave feedback to help the AI improve ‚Üí
                    </button>
                  </div>
                </div>
              </div>

              {/* Subtle brand footer */}
              <div className="text-center mt-4">
                <p className="text-[11px] text-white/30">Powered by AllFantasy AI ‚Äî live preview</p>
              </div>
            </div>
          )
        })()}

        {(importStatus === 'complete' || leagues.length > 0) &&
          (() => {
            const seasonsVal = String(stats?.seasons_imported ?? stats?.seasons ?? seasonBreakdown?.length ?? 0)
            const leaguesVal = String(stats?.leagues_played ?? stats?.leagues ?? leagues?.length ?? 0)
            const playoffsVal = String(stats?.playoffs ?? 0)
            const playoffPct = (stats as any)?.playoff_percentage ?? 0

            const gradeVal =
              (profile as any)?.ai_rating ??
              aiReport?.rating ??
              null

            const letterGrade = toLetterGrade(gradeVal)

            const letterTone =
              letterGrade?.startsWith('A')
                ? 'text-green-300 border-green-400/30'
                : letterGrade?.startsWith('B')
                ? 'text-cyan-300 border-cyan-400/30'
                : letterGrade?.startsWith('C')
                ? 'text-yellow-300 border-yellow-400/30'
                : 'text-red-300 border-red-400/30'

            return (
              <>
                <div className="mb-6">
                  <div className="relative rounded-3xl bg-gradient-to-br from-slate-900/80 to-slate-950/80 border border-cyan-500/20 backdrop-blur-xl shadow-[0_20px_60px_rgba(0,0,0,0.4)] overflow-hidden">
                    {/* Gradient accent line at top */}
                    <div className="h-[1.5px] bg-gradient-to-r from-cyan-400 via-purple-400 to-cyan-400" />
                    
                    <div className="p-5 sm:p-6">
                      <div className="flex flex-col sm:flex-row sm:items-center gap-4 sm:gap-6">
                        {/* Left: Avatar + Name */}
                        <div className="flex items-center gap-4 min-w-0">
                          {profile?.avatar && (
                            <div className="relative">
                              <div className="absolute -inset-1 rounded-full bg-gradient-to-r from-cyan-400/40 to-purple-400/40 blur-md" />
                              <img
                                src={profile.avatar}
                                alt="Avatar"
                                className="relative w-16 h-16 rounded-full border border-white/10 ring-2 ring-cyan-400/50 object-cover"
                              />
                            </div>
                          )}

                          <div className="min-w-0">
                            <div className="flex items-center gap-2 flex-wrap">
                              <h2 className="text-2xl sm:text-3xl font-bold text-white truncate">
                                {profile?.display_name ?? 'Your Legacy'}
                              </h2>

                              {gradeVal != null && (() => {
                                const gradeColors = getLetterGradeColor(letterGrade)
                                return (
                                  <span
                                    title="AI rating based on your imported legacy performance"
                                    className="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full bg-white/5 border border-white/10 text-xs text-white/70"
                                  >
                                    <span className="font-medium text-purple-200">{gradeVal}</span>
                                    {letterGrade && (
                                      <span className={`px-1.5 py-0.5 rounded-full ${gradeColors.bg} border ${gradeColors.border} text-xs font-bold ${gradeColors.text}`}>
                                        {letterGrade}
                                      </span>
                                    )}
                                  </span>
                                )
                              })()}
                            </div>

                            <div className="flex items-center gap-2 mt-1">
                              <p className="text-sm text-white/50 truncate">@{profile?.sleeper_username ?? username}</p>
                              <span className="px-2 py-0.5 rounded-full bg-emerald-500/10 border border-emerald-400/20 text-[10px] text-emerald-300 flex items-center gap-1">
                                <span className="w-1.5 h-1.5 rounded-full bg-emerald-400" />
                                High confidence
                              </span>
                            </div>
                          </div>
                        </div>

                        {/* Divider (only on larger screens) */}
                        <div className="hidden sm:block sm:flex-1" />
                        <div className="hidden sm:block h-10 w-px bg-white/10" />

                        {/* Right: Stats */}
                        {stats && (
                          <div className="grid grid-cols-3 gap-3 sm:gap-4 sm:flex sm:items-center sm:justify-end">
                            <div
                              title="Total leagues imported from your Sleeper history"
                              className="rounded-2xl bg-white/5 border border-white/10 px-4 py-3 text-center backdrop-blur-xl shadow-[0_10px_30px_rgba(0,0,0,0.2)]"
                            >
                              <div className="text-lg sm:text-xl font-bold text-cyan-300 leading-none">{leaguesVal}</div>
                              <div className="text-[11px] text-white/50 mt-1">Leagues</div>
                            </div>

                            <div
                              title="Wins ‚Äì Losses ‚Äì Ties"
                              className="rounded-2xl bg-white/5 border border-white/10 px-4 py-3 text-center backdrop-blur-xl shadow-[0_10px_30px_rgba(0,0,0,0.2)]"
                            >
                              <div className="text-lg sm:text-xl font-bold text-green-300 leading-none">
                                {stats.record}
                              </div>

                              <div className="mt-1 flex justify-center gap-2 text-[10px] text-white/50">
                                <span>W</span>
                                <span>‚Äì</span>
                                <span>L</span>
                                <span>‚Äì</span>
                                <span>T</span>
                              </div>

                              <div className="text-[11px] text-white/60 mt-1">W‚ÄìL‚ÄìT Record</div>
                            </div>

                            <div
                              title="Championships won"
                              className="rounded-2xl bg-white/5 border border-white/10 px-4 py-3 text-center backdrop-blur-xl shadow-[0_10px_30px_rgba(0,0,0,0.2)]"
                            >
                              <div className="text-lg sm:text-xl font-bold text-yellow-300 leading-none">
                                {stats.championships ?? 0}
                              </div>
                              <div className="text-[11px] text-white/50 mt-1">Ships</div>
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                </div>


                {/* Connected Platforms - Compact Chips */}
                <div className="mb-4 flex flex-wrap items-center gap-2">
                  {/* Sleeper Chip */}
                  <div className={cx(
                    'flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium transition-all',
                    leagues.length > 0 || username
                      ? 'bg-cyan-500/15 border border-cyan-400/40 text-cyan-300 shadow-[0_0_12px_rgba(6,182,212,0.15)]'
                      : 'bg-black/20 border border-white/5 text-white/30'
                  )}>
                    <span className="text-sm">üò¥</span>
                    <span>Sleeper</span>
                    {(leagues.length > 0 || username) && (
                      <span className="px-1.5 py-0.5 rounded-full bg-cyan-500/30 text-[10px]">{leagues.length}</span>
                    )}
                  </div>
                  
                  {/* Yahoo Chip */}
                  <div className={cx(
                    'flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium transition-all',
                    yahooConnected
                      ? 'bg-purple-500/15 border border-purple-400/40 text-purple-300 shadow-[0_0_12px_rgba(168,85,247,0.15)]'
                      : 'bg-black/20 border border-white/5 text-white/30'
                  )}>
                    <span className="text-sm">üèà</span>
                    <span>Yahoo</span>
                    {yahooConnected && yahooLeagues.length > 0 && (
                      <span className="px-1.5 py-0.5 rounded-full bg-purple-500/30 text-[10px]">{yahooLeagues.length}</span>
                    )}
                  </div>
                  
                  {/* MFL Chip */}
                  <div className={cx(
                    'flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium transition-all',
                    mflConnected
                      ? 'bg-amber-500/15 border border-amber-400/40 text-amber-300 shadow-[0_0_12px_rgba(245,158,11,0.15)]'
                      : 'bg-black/20 border border-white/5 text-white/30'
                  )}>
                    <span className="text-sm">üèÜ</span>
                    <span>MFL</span>
                    {mflConnected && mflLeagues.length > 0 && (
                      <span className="px-1.5 py-0.5 rounded-full bg-amber-500/30 text-[10px]">{mflLeagues.length}</span>
                    )}
                  </div>
                  
                  {/* Fantrax Chip */}
                  <div className={cx(
                    'flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium transition-all',
                    fantraxLeagues.length > 0
                      ? 'bg-emerald-500/15 border border-emerald-400/40 text-emerald-300 shadow-[0_0_12px_rgba(16,185,129,0.15)]'
                      : 'bg-black/20 border border-white/5 text-white/30'
                  )}>
                    <span className="text-sm">üìä</span>
                    <span>Fantrax</span>
                    {fantraxLeagues.length > 0 && (
                      <span className="px-1.5 py-0.5 rounded-full bg-emerald-500/30 text-[10px]">{fantraxLeagues.length}</span>
                    )}
                  </div>

                  {/* Custom Platform Chips */}
                  {customPlatforms.length > 0 && (
                    <div className="w-px h-5 bg-white/10 mx-1 hidden sm:block" />
                  )}
                  {customPlatforms.map((cp, idx) => (
                    <div
                      key={idx}
                      className="group flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-rose-500/15 border border-rose-400/40 text-rose-300 shadow-[0_0_12px_rgba(244,63,94,0.15)] transition-all"
                      title={cp.notes || cp.name}
                    >
                      <span className="text-sm">üîó</span>
                      <span>{cp.name}</span>
                      {cp.leagueCount > 0 && (
                        <span className="px-1.5 py-0.5 rounded-full bg-rose-500/30 text-[10px]">{cp.leagueCount}</span>
                      )}
                      <button
                        onClick={() => {
                          const updated = customPlatforms.filter((_, i) => i !== idx)
                          setCustomPlatforms(updated)
                          localStorage.setItem('af_custom_platforms', JSON.stringify(updated))
                        }}
                        className="opacity-0 group-hover:opacity-100 ml-0.5 w-4 h-4 rounded-full bg-white/10 hover:bg-red-500/30 flex items-center justify-center text-white/50 hover:text-red-300 transition-all text-[10px]"
                        title="Remove"
                      >
                        √ó
                      </button>
                    </div>
                  ))}

                  {/* Add Platform Button */}
                  <button
                    onClick={() => setShowAddPlatform(true)}
                    className="flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-medium bg-black/20 border border-dashed border-white/15 text-white/40 hover:text-white/70 hover:border-white/30 transition-all"
                    title="Add another platform"
                  >
                    <span className="text-sm">+</span>
                    <span>Add</span>
                  </button>

                  {/* Add Platform Modal */}
                  {showAddPlatform && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm" onClick={() => setShowAddPlatform(false)}>
                      <div className="relative w-full max-w-sm rounded-2xl bg-gradient-to-br from-slate-900 to-slate-950 border border-rose-500/30 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
                        <div className="h-1 bg-gradient-to-r from-rose-400 via-pink-500 to-rose-400" />
                        <div className="p-5">
                          <h3 className="text-lg font-bold text-white mb-4">Add Platform</h3>
                          <div className="space-y-3">
                            <div>
                              <label className="block text-xs text-white/50 mb-1">Platform Name</label>
                              <input
                                type="text"
                                value={newPlatformName}
                                onChange={(e) => setNewPlatformName(e.target.value)}
                                placeholder="e.g. NFL.com, CBS, RT Sports"
                                className="w-full px-3 py-2 rounded-lg bg-black/30 border border-white/10 text-white text-sm placeholder:text-white/25 focus:outline-none focus:border-rose-400/50"
                              />
                            </div>
                            <div>
                              <label className="block text-xs text-white/50 mb-1">Number of Leagues (optional)</label>
                              <input
                                type="number"
                                value={newPlatformLeagueCount}
                                onChange={(e) => setNewPlatformLeagueCount(e.target.value)}
                                placeholder="0"
                                min="0"
                                className="w-full px-3 py-2 rounded-lg bg-black/30 border border-white/10 text-white text-sm placeholder:text-white/25 focus:outline-none focus:border-rose-400/50"
                              />
                            </div>
                            <div>
                              <label className="block text-xs text-white/50 mb-1">Notes (optional)</label>
                              <input
                                type="text"
                                value={newPlatformNotes}
                                onChange={(e) => setNewPlatformNotes(e.target.value)}
                                placeholder="e.g. Dynasty league since 2019"
                                className="w-full px-3 py-2 rounded-lg bg-black/30 border border-white/10 text-white text-sm placeholder:text-white/25 focus:outline-none focus:border-rose-400/50"
                              />
                            </div>
                          </div>
                          <div className="flex gap-2 mt-5">
                            <button
                              onClick={() => setShowAddPlatform(false)}
                              className="flex-1 py-2 rounded-lg bg-white/5 border border-white/10 text-white/60 text-sm hover:bg-white/10 transition"
                            >
                              Cancel
                            </button>
                            <button
                              onClick={() => {
                                if (!newPlatformName.trim()) return
                                const updated = [...customPlatforms, {
                                  name: newPlatformName.trim(),
                                  leagueCount: parseInt(newPlatformLeagueCount) || 0,
                                  notes: newPlatformNotes.trim(),
                                }]
                                setCustomPlatforms(updated)
                                localStorage.setItem('af_custom_platforms', JSON.stringify(updated))
                                setNewPlatformName('')
                                setNewPlatformLeagueCount('')
                                setNewPlatformNotes('')
                                setShowAddPlatform(false)
                              }}
                              disabled={!newPlatformName.trim()}
                              className="flex-1 py-2 rounded-lg bg-gradient-to-r from-rose-500 to-pink-500 text-white text-sm font-medium hover:from-rose-400 hover:to-pink-400 transition disabled:opacity-40"
                            >
                              Add Platform
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                  
                  {/* Single Trust Line */}
                  <div className="flex-1 hidden sm:flex justify-end">
                    <span className="flex items-center gap-1.5 text-[11px] text-white/35">
                      <Shield className="w-3 h-3" />
                      Read-only ‚Ä¢ No passwords ‚Ä¢ Leagues untouched
                    </span>
                  </div>
                </div>
                {/* Mobile Trust Line */}
                <div className="sm:hidden mb-4 text-center text-[11px] text-white/35 flex items-center justify-center gap-1.5">
                  <Shield className="w-3 h-3" />
                  Read-only ‚Ä¢ No passwords ‚Ä¢ Leagues untouched
                </div>

                {/* Mobile Section Header */}
                <MobileSectionHeader mainTab={mobileMainTab} username={username || undefined} />

                {/* Mobile Sub-Tab Navigation (visible on mobile when bottom bar is active) */}
                {showMobileSubNav && (
                  <div className="mb-4 lg:hidden">
                    <SubTabNav
                      tabs={mobileSubTabs}
                      activeTab={activeTab}
                      onChange={(id) => handleActiveTabChange(id as Tab)}
                    />
                  </div>
                )}

                {/* Mobile: Alerts empty state when alerts tab is active */}
                {mobileMainTab === 'alerts' && (
                  <div className="lg:hidden">
                    <div className="flex flex-col items-center justify-center py-16 px-4 text-center">
                      <div className="w-16 h-16 rounded-2xl bg-amber-500/10 border border-amber-500/20 flex items-center justify-center mb-4">
                        <svg className="w-8 h-8 text-amber-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>
                      </div>
                      <h3 className="text-lg font-semibold text-white mb-2">Market Timing Alerts</h3>
                      <p className="text-sm text-white/50 max-w-xs mb-6">
                        AI-powered buy/sell signals and trade window alerts are coming soon. You&apos;ll get notified when the market shifts.
                      </p>
                      <div className="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-amber-500/10 border border-amber-500/20 text-amber-300 text-sm font-medium">
                        <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        Coming Soon
                      </div>
                    </div>
                  </div>
                )}

                {/* Desktop Tab Navigation - 5 Primary + More */}
                <div className="mb-6 relative z-30 hidden lg:block">
                  {(() => {
                    const primaryTabIds: Tab[] = ['overview', 'trade', 'waiver', 'chat', 'transfer']
                    const moreTabIds: Tab[] = ['finder', 'player-finder', 'rankings', 'pulse', 'compare', 'share', 'strategy']
                    const primaryTabs = tabs.filter(t => primaryTabIds.includes(t.id))
                    const moreTabs = tabs.filter(t => moreTabIds.includes(t.id))
                    const isMoreActive = moreTabIds.includes(activeTab)
                    const activeMoreTab = moreTabs.find(t => t.id === activeTab)
                    
                    const tabLabels: Record<string, string> = {
                      'overview': 'Overview',
                      'trade': 'AI Trade Hub',
                      'waiver': 'Waiver AI',
                      'chat': 'AI Chat',
                      'transfer': 'Transfer',
                    }
                    
                    return (
                      <div className="relative">
                        <div className="absolute left-0 top-0 bottom-0 w-6 sm:w-8 bg-gradient-to-r from-slate-950/80 to-transparent z-10 pointer-events-none lg:opacity-50" />
                        <div className="absolute right-0 top-0 bottom-0 w-6 sm:w-8 bg-gradient-to-l from-slate-950/80 to-transparent z-10 pointer-events-none lg:opacity-50" />
                        
                        <div className="flex flex-nowrap overflow-x-auto items-center gap-1.5 sm:gap-2 pb-1 -mb-1 scrollbar-hide px-2 sm:px-0">
                        {primaryTabs.map((tab) => {
                          const isActive = activeTab === tab.id
                          const displayLabel = tabLabels[tab.id] || tab.label
                          return (
                            <button
                              key={tab.id}
                              onClick={() => { handleActiveTabChange(tab.id); setMoreMenuOpen(false) }}
                              className={cx(
                                'group relative flex items-center gap-2 px-3 sm:px-4 py-2 rounded-xl whitespace-nowrap transition-all duration-150 text-sm min-h-[44px] touch-manipulation',
                                isActive
                                  ? 'bg-gradient-to-r from-cyan-500/15 to-purple-500/15 text-white'
                                  : 'bg-black/15 border border-white/5 text-white/40 hover:text-white/70 hover:bg-white/5 active:scale-[0.98]'
                              )}
                            >
                              {isActive && (
                                <div className="absolute bottom-0 left-3 right-3 h-[2px] bg-gradient-to-r from-cyan-400/80 to-purple-400/80 rounded-full" />
                              )}
                              <div className={cx(
                                'flex items-center justify-center w-7 h-7 rounded-xl transition-colors',
                                isActive 
                                  ? 'bg-white/10 text-cyan-300' 
                                  : 'bg-white/5 text-white/40 group-hover:bg-white/10 group-hover:text-white/60'
                              )}>
                                {tab.icon}
                              </div>
                              <span className={cx(
                                'hidden sm:inline transition-colors',
                                isActive ? 'font-semibold text-white tracking-tight' : 'font-medium text-white/50'
                              )}>
                                {displayLabel}
                              </span>
                              {tab.badge && (
                                <span className={cx(
                                  'px-1.5 py-0.5 rounded text-[9px] font-medium uppercase tracking-wide hidden sm:inline border',
                                  tab.badge === 'AI' ? 'bg-purple-500/20 text-purple-300/80 border-purple-500/20' :
                                  'bg-white/5 text-white/40 border-white/10'
                                )}>{tab.badge}</span>
                              )}
                            </button>
                          )
                        })}
                        
                        <div className="relative flex-shrink-0 z-20">
                          <button
                            ref={moreButtonRef}
                            type="button"
                            onClick={(e) => { 
                              e.stopPropagation(); 
                              if (!moreMenuOpen && moreButtonRef.current) {
                                const rect = moreButtonRef.current.getBoundingClientRect();
                                const isMobile = window.innerWidth < 640;
                                setMoreMenuPosition({
                                  top: rect.bottom + 8,
                                  right: isMobile ? 0 : (window.innerWidth - rect.right)
                                });
                              }
                              setMoreMenuOpen(!moreMenuOpen); 
                            }}
                            className={cx(
                              'group relative flex items-center gap-2 px-3 sm:px-4 py-2 rounded-xl whitespace-nowrap transition-all duration-150 text-sm min-h-[44px] touch-manipulation',
                              isMoreActive
                                ? 'bg-gradient-to-r from-purple-500/15 to-pink-500/15 text-white'
                                : 'bg-black/15 border border-white/5 text-white/40 hover:text-white/70 hover:bg-white/5 active:scale-[0.98]'
                            )}
                          >
                            {isMoreActive && (
                              <div className="absolute bottom-0 left-3 right-3 h-[2px] bg-gradient-to-r from-purple-400/80 to-pink-400/80 rounded-full" />
                            )}
                            <div className={cx(
                              'flex items-center justify-center w-7 h-7 rounded-xl transition-colors',
                              isMoreActive 
                                ? 'bg-white/10 text-purple-300' 
                                : 'bg-white/5 text-white/40 group-hover:bg-white/10 group-hover:text-white/60'
                            )}>
                              <ChevronRight className={cx('w-3.5 h-3.5 transition-transform opacity-70', moreMenuOpen ? 'rotate-90' : '')} />
                            </div>
                            <span className={cx(
                              'hidden sm:inline transition-colors',
                              isMoreActive ? 'font-semibold text-white tracking-tight' : 'font-medium text-white/50'
                            )}>
                              {isMoreActive && activeMoreTab ? activeMoreTab.label : 'More'}
                            </span>
                            {isMoreActive && (
                              <span className="w-1.5 h-1.5 rounded-full bg-purple-400/80 animate-[pulse_2s_ease-in-out_infinite] sm:hidden" />
                            )}
                          </button>
                          
                          {moreMenuOpen && moreMenuPosition && (
                            <>
                              <div className="fixed inset-0 z-[9998]" onClick={() => setMoreMenuOpen(false)} />
                              <div 
                                className={cx(
                                  'fixed z-[9999] rounded-2xl border border-white/8 bg-slate-950/95 backdrop-blur-2xl shadow-lg shadow-black/30 p-3 overflow-hidden',
                                  moreMenuPosition.right === 0 ? 'left-3 right-3' : 'min-w-[240px]'
                                )}
                                style={{
                                  top: `${moreMenuPosition.top}px`,
                                  ...(moreMenuPosition.right > 0 ? { right: `${moreMenuPosition.right}px` } : {}),
                                }}
                              >
                                <div className="text-[9px] uppercase tracking-[0.15em] text-white/30 px-3 py-2 mb-2 border-b border-white/10">More Tools</div>
                                <div className="space-y-1">
                                  {moreTabs.map((tab) => {
                                    const isActive = activeTab === tab.id
                                    return (
                                      <button
                                        key={tab.id}
                                        onClick={() => { handleActiveTabChange(tab.id); setMoreMenuOpen(false) }}
                                        className={cx(
                                          'w-full flex items-center gap-3 px-3 py-3 rounded-xl text-left transition-all duration-150 min-h-[44px]',
                                          isActive
                                            ? 'bg-white/10 text-white'
                                            : 'text-white/50 hover:bg-white/8 hover:text-white/80'
                                        )}
                                      >
                                        <div className={cx(
                                          'flex items-center justify-center w-7 h-7 rounded-xl transition-colors',
                                          isActive 
                                            ? 'bg-purple-500/25 text-purple-300' 
                                            : 'bg-white/5 text-white/50 group-hover:bg-white/10 group-hover:text-white/70'
                                        )}>
                                          {tab.icon}
                                        </div>
                                        <span className={cx('text-sm flex-1', isActive ? 'font-semibold text-white' : 'font-medium')}>{tab.label}</span>
                                        {tab.badge && (
                                          <span className={cx(
                                            'px-1.5 py-0.5 rounded text-[8px] font-medium uppercase border',
                                            tab.badge === 'AI' ? 'bg-purple-500/15 text-purple-300/70 border-purple-500/20' :
                                            tab.badge === 'Beta' ? 'bg-amber-500/15 text-amber-300/70 border-amber-500/20' :
                                            'bg-white/5 text-white/40 border-white/10'
                                          )}>{tab.badge}</span>
                                        )}
                                        {isActive && <CheckCircle2 className="w-3 h-3 text-purple-400/70 flex-shrink-0" />}
                                      </button>
                                    )
                                  })}
                                </div>
                              </div>
                            </>
                          )}
                        </div>
                      </div>
                      </div>
                    )
                  })()}
                  
                </div>

                <div className={mobileAlertsActive ? 'hidden lg:block' : ''}>
                {activeTab === 'overview' && (
                  <div className="space-y-8">
                    {/* Composite Profile + Report Card */}
                    {(() => {
                      const leagueRecords: LeagueRecord[] = (leagues || []).map(l => ({
                        league_id: l.league_id,
                        type: l.type,
                        scoring: l.scoring,
                        specialty_format: l.specialty_format,
                        is_sf: l.is_sf,
                        is_tep: l.is_tep,
                        team_count: l.team_count,
                        wins: l.wins,
                        losses: l.losses,
                        ties: l.ties ?? 0,
                        is_champion: l.is_champion,
                        made_playoffs: l.made_playoffs,
                      }))
                      const compositeProfile = leagueRecords.length > 0 ? computeCompositeProfile(leagueRecords) : null

                      if (!compositeProfile) return null

                      const bestLane = compositeProfile.lanes.length > 0
                        ? compositeProfile.lanes.reduce((best, l) => l.adjustedWinRate > best.adjustedWinRate ? l : best, compositeProfile.lanes[0])
                        : null
                      const weakestLane = compositeProfile.lanes.length > 0
                        ? compositeProfile.lanes.reduce((worst, l) => l.adjustedWinRate < worst.adjustedWinRate ? l : worst, compositeProfile.lanes[0])
                        : null

                      return (
                        <>
                          <HeroMetric 
                            value={`${compositeProfile.legacyScore}`}
                            label="Legacy Score (0‚Äì100)"
                            helper="Composite rating: win rate + playoffs + championships + difficulty"
                            accent="purple"
                          />
                          <p className="text-center text-sm sm:text-base text-white/60 -mt-4 mb-2">Your entire fantasy career ‚Äî analyzed, graded, and explained.</p>

                          <OverviewReportCard
                            profile={compositeProfile}
                            tierName={rankingPreview?.career?.tier_name || aiReport?.archetype}
                            tierLevel={rankingPreview?.career?.level}
                            careerXp={rankingPreview?.career?.total_xp}
                          />

                          <OverviewLanes lanes={compositeProfile.lanes} />

                          {weakestLane && (
                            <div className="rounded-2xl bg-gradient-to-r from-amber-500/10 via-orange-500/8 to-amber-500/10 border border-amber-400/25 p-5 sm:p-6">
                              <div className="flex items-center gap-3 mb-3">
                                <div className="w-9 h-9 rounded-xl bg-amber-500/20 flex items-center justify-center">
                                  <Target className="w-5 h-5 text-amber-300" />
                                </div>
                                <div>
                                  <h4 className="text-sm font-bold text-amber-200">Next Edge</h4>
                                  <p className="text-[11px] text-white/40">Your fastest path to a higher Legacy Score</p>
                                </div>
                              </div>
                              <div className="space-y-3">
                                <div className="rounded-xl bg-black/20 border border-white/5 p-3">
                                  <div className="text-xs text-white/50 mb-1">Focus Format</div>
                                  <div className="text-sm font-semibold text-white">{weakestLane.label}</div>
                                  <p className="text-xs text-white/50 mt-1">
                                    {weakestLane.adjustedWinRate}% adj. win rate ({weakestLane.leagues} league{weakestLane.leagues !== 1 ? 's' : ''}) ‚Äî this is where you have the most room to grow.
                                  </p>
                                </div>
                                <div className="rounded-xl bg-black/20 border border-white/5 p-3">
                                  <div className="text-xs text-white/50 mb-1">Action</div>
                                  <p className="text-sm text-white/80">{weakestLane.nextEdge}</p>
                                </div>
                                {bestLane && bestLane.leagueClass !== weakestLane.leagueClass && (
                                  <p className="text-[11px] text-white/40">
                                    Your strongest lane is <span className="text-emerald-300">{bestLane.label}</span> at {bestLane.adjustedWinRate}% ‚Äî apply those winning habits here.
                                  </p>
                                )}
                              </div>
                            </div>
                          )}

                          <OverviewInsights
                            profile={compositeProfile}
                            lanes={compositeProfile.lanes}
                            onTabChange={(tab) => setActiveTab(tab as Tab)}
                          />
                        </>
                      )
                    })()}

                    {rankingPreview && (() => {
                      const xp = safeNum(rankingPreview?.career?.xp, 0)
                      const level = safeNum(rankingPreview?.career?.level, 0)
                      const tier = safeNum(rankingPreview?.career?.tier, 1)
                      const tierName = rankingPreview?.career?.tier_name || 'Practice Squad'

                      const next = nextTierInfo(rankingPreview)

                      const XP_PER_LEVEL = Number(rankingPreview?.yearly_projection?.assumptions?.xp_per_level ?? 500)
                      const nextLevelXp = (level + 1) * XP_PER_LEVEL
                      const xpToNextLevel = Math.max(0, nextLevelXp - xp)
                      const levelProgress = Math.max(0, Math.min(1, (xp - level * XP_PER_LEVEL) / XP_PER_LEVEL))

                      return (
                        <div className="relative rounded-3xl bg-gradient-to-br from-slate-900/80 to-slate-950/80 border border-amber-500/20 backdrop-blur-xl shadow-[0_20px_60px_rgba(0,0,0,0.4)] overflow-hidden">
                          <div className="h-1.5 bg-gradient-to-r from-amber-400 via-orange-500 to-amber-400" />
                          <div className="p-6 sm:p-8">
                            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
                              <div className="flex items-center gap-3">
                                <div className="w-12 h-12 rounded-2xl bg-gradient-to-br from-amber-500/30 to-orange-500/30 flex items-center justify-center text-2xl">üèÜ</div>
                                <div>
                                  <h3 className="text-2xl font-bold text-white">Your Rank</h3>
                                  <div className="flex items-center gap-2 mt-1 flex-wrap">
                                    <button
                                      onClick={() => setShowRankExplain(true)}
                                      className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-amber-500/20 hover:bg-amber-500/30 border border-amber-400/30 text-[11px] text-amber-200 transition"
                                    >
                                      <span>‚ìò</span> Scoring
                                    </button>
                                    {rankRemaining != null && (
                                      <span className="px-2 py-0.5 rounded-full bg-black/30 border border-white/10 text-[10px] text-white/60">
                                        Refresh: {rankRemaining}
                                      </span>
                                    )}
                                    {aiCoachRemaining != null && (
                                      <span className="px-2 py-0.5 rounded-full bg-black/30 border border-white/10 text-[10px] text-white/60">
                                        Coach: {aiCoachRemaining}
                                      </span>
                                    )}
                                  </div>
                                </div>
                              </div>
                              <div className="flex flex-wrap gap-2">
                                <button onClick={refreshRank} disabled={rankRefreshLoading} className="px-4 py-2 text-sm rounded-xl bg-cyan-500/20 hover:bg-cyan-500/30 border border-cyan-400/30 text-cyan-200 transition disabled:opacity-50 font-medium">
                                  {rankRefreshLoading ? 'Refreshing‚Ä¶' : 'Refresh Rank'}
                                </button>
                                <button onClick={askAiCoach} disabled={aiCoachLoading} className="px-4 py-2 text-sm rounded-xl bg-purple-500/20 hover:bg-purple-500/30 border border-purple-400/30 text-purple-200 transition disabled:opacity-50 font-medium">
                                  {aiCoachLoading ? 'Asking‚Ä¶' : 'Ask AI Coach'}
                                </button>
                              </div>
                            </div>

                          {rankRefreshError && (
                            <div className="mb-3 px-3 py-2 rounded-xl bg-red-500/10 border border-red-400/25 text-sm text-red-300">{rankRefreshError}</div>
                          )}
                          {rankingPreview?.cache?.stale && (() => {
                            const prevXp = safeNum(rankingPreview?.cache?.previous_xp, 0)
                            const currXp = safeNum(rankingPreview?.career?.xp, 0)
                            const prevLevel = safeNum(rankingPreview?.cache?.previous_level, 0)
                            const currLevel = safeNum(rankingPreview?.career?.level, 0)
                            const newLeagues = safeNum(rankingPreview?.cache?.new_leagues, 0)
                            const xpGain = currXp - prevXp
                            const levelGain = currLevel - prevLevel

                            return (
                              <div className="mb-3 rounded-xl bg-amber-500/10 border border-amber-400/25 p-3">
                                <div className="flex items-center gap-2 mb-2">
                                  <span className="w-2 h-2 rounded-full bg-amber-400 animate-pulse" />
                                  <span className="text-xs font-semibold text-amber-200">New data available ‚Äî tap Refresh to update</span>
                                </div>
                                <div className="flex flex-wrap gap-3 text-[11px] text-white/60">
                                  {newLeagues > 0 && (
                                    <span>{newLeagues} new league{newLeagues !== 1 ? 's' : ''} imported</span>
                                  )}
                                  {xpGain > 0 && (
                                    <span>+{xpGain.toLocaleString()} XP pending</span>
                                  )}
                                  {levelGain > 0 && (
                                    <span>+{levelGain} level{levelGain !== 1 ? 's' : ''} gained</span>
                                  )}
                                  {xpGain === 0 && newLeagues === 0 && (
                                    <span>Recalculation available with latest data</span>
                                  )}
                                </div>
                              </div>
                            )
                          })()}

                          {/* Main content grid */}
                          <div className="grid lg:grid-cols-3 gap-4">
                            {/* Left: core rank */}
                            <div className="lg:col-span-2 rounded-2xl bg-black/15 border border-white/10 p-4">
                              {/* Hero line */}
                              <div className="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
                                <div className="min-w-0">
                                  <div className="text-xs uppercase tracking-wide text-white/45">Current Tier</div>
                                  <div className="mt-1 flex items-baseline gap-2 flex-wrap">
                                    <span className="text-3xl font-extrabold text-white">Tier {tier}</span>
                                    <span className="text-white/40 font-semibold">‚Ä¢</span>
                                    <span className="text-xl font-bold text-green-300 truncate max-w-[260px]">
                                      {tierName}
                                    </span>
                                  </div>

                                  <div className="mt-2 flex flex-wrap items-center gap-2">
                                    <span className="px-2.5 py-1 rounded-full bg-white/5 border border-white/10 text-xs text-white/70">
                                      Level <span className="font-semibold text-purple-200">{level}</span>
                                    </span>
                                    <span className="px-2.5 py-1 rounded-full bg-white/5 border border-white/10 text-xs text-white/70">
                                      Career XP <span className="font-semibold text-cyan-200">{xp.toLocaleString()}</span>
                                    </span>
                                  </div>
                                </div>

                                {/* Next level mini */}
                                <div className="rounded-2xl bg-white/5 border border-white/10 p-3 sm:text-right">
                                  <div className="text-[11px] text-white/50">Next level</div>
                                  <div className="text-sm font-semibold text-white/80">
                                    {xpToNextLevel.toLocaleString()} XP ‚Üí Level {level + 1}
                                  </div>
                                  <div className="mt-2 h-2 rounded-full bg-white/10 overflow-hidden">
                                    <div
                                      className="h-2 rounded-full bg-white/35"
                                      style={{ width: `${Math.round(levelProgress * 100)}%` }}
                                    />
                                  </div>
                                </div>
                              </div>

                              {/* Next tier progress (sleek progress card) */}
                              <div className="mt-4 rounded-2xl bg-gradient-to-r from-cyan-500/10 to-purple-500/10 border border-white/10 p-4">
                                <div className="flex items-start justify-between gap-3">
                                  <div className="min-w-0">
                                    <div className="text-sm font-semibold text-white/85">
                                      {next ? (
                                        <>
                                          Next Tier: <span className="text-purple-200">{next.nextTierName}</span>
                                        </>
                                      ) : (
                                        <>Next Tier</>
                                      )}
                                    </div>

                                    {next ? (
                                      <div className="text-xs text-white/65 mt-1">
                                        <span className="font-semibold text-cyan-200">{next.needed.toLocaleString()} XP</span> to reach{" "}
                                        <span className="font-semibold text-white/80">
                                          Tier {next.nextTier}
                                        </span>
                                      </div>
                                    ) : (
                                      <div className="text-xs text-white/55 mt-1">You're currently at the top tier.</div>
                                    )}
                                  </div>

                                  {/* Tiny tier badge on the right */}
                                  {next && (
                                    <div className="shrink-0 rounded-2xl bg-black/20 border border-white/10 px-3 py-2 text-xs text-white/70">
                                      <div className="flex items-center gap-2">
                                        <span className="px-2 py-0.5 rounded-full bg-white/5 border border-white/10 text-[11px] text-white/70">
                                          Tier {tier}
                                        </span>
                                        <span className="text-white/35">‚Üí</span>
                                        <span className="px-2 py-0.5 rounded-full bg-white/10 border border-white/15 text-[11px] font-semibold text-purple-100">
                                          Tier {next.nextTier}
                                        </span>
                                      </div>

                                      <div className="mt-1 text-[10px] text-white/45 text-right">
                                        {next.currentFloor.toLocaleString()} ‚Üí {next.nextCeil.toLocaleString()}
                                      </div>
                                    </div>
                                  )}
                                </div>

                                <div className="mt-3 h-2.5 rounded-full bg-white/10 overflow-hidden">
                                  <div
                                    className="h-2.5 rounded-full bg-gradient-to-r from-cyan-400/70 to-purple-400/70"
                                    style={{ width: `${Math.round((next?.progress ?? 0) * 100)}%` }}
                                  />
                                </div>

                                {next && (
                                  <div className="mt-2 flex items-center justify-between text-[11px] text-white/50">
                                    <span>Tier floor: {next.currentFloor.toLocaleString()} XP</span>
                                    <span>{Math.round(next.progress * 100)}%</span>
                                  </div>
                                )}
                              </div>
                            </div>

                            {/* Right: projections */}
                            <div className="rounded-2xl bg-black/15 border border-white/10 p-4">
                              <div className="text-sm font-semibold text-white/80 mb-2">XP Projection</div>

                              <div className="space-y-3">
                                <div className="rounded-2xl bg-white/5 border border-white/10 p-3">
                                  <div className="text-[11px] text-white/50">Expected / Season</div>
                                  <div className="text-lg font-bold text-white">
                                    {safeNum(rankingPreview?.yearly_projection?.baseline_year_xp, 0).toLocaleString()}
                                    <span className="text-xs text-white/50 ml-2">XP</span>
                                  </div>
                                </div>

                                <div className="rounded-2xl bg-white/5 border border-white/10 p-3">
                                  <div className="text-[11px] text-white/50">With AI (Low ‚Üí Mid ‚Üí High)</div>
                                  <div className="mt-1 flex items-baseline gap-2 flex-wrap">
                                    <span className="text-sm text-green-300">
                                      {safeNum(rankingPreview?.yearly_projection?.ai_low_year_xp, 0).toLocaleString()}
                                    </span>
                                    <span className="text-white/30">‚Üí</span>
                                    <span className="text-base font-bold text-cyan-200">
                                      {safeNum(rankingPreview?.yearly_projection?.ai_mid_year_xp, 0).toLocaleString()}
                                    </span>
                                    <span className="text-white/30">‚Üí</span>
                                    <span className="text-sm text-purple-200">
                                      {safeNum(rankingPreview?.yearly_projection?.ai_high_year_xp, 0).toLocaleString()}
                                    </span>
                                  </div>
                                </div>

                                <div className="text-[11px] text-white/50">
                                  * Projections are estimates from your imported history + difficulty multipliers.
                                </div>
                              </div>

                              <div className="mt-4 pt-3 border-t border-white/8">
                                <div className="text-sm font-semibold text-white/80 mb-2">How to Gain XP Faster</div>
                                <div className="space-y-2">
                                  <div className="flex items-start gap-2">
                                    <span className="w-1.5 h-1.5 rounded-full bg-emerald-400 flex-shrink-0 mt-1.5" />
                                    <p className="text-[11px] text-white/60 leading-relaxed">
                                      <span className="text-emerald-300 font-medium">Make playoffs</span> ‚Äî playoff appearances multiply your season XP. The deeper you go, the bigger the boost.
                                    </p>
                                  </div>
                                  <div className="flex items-start gap-2">
                                    <span className="w-1.5 h-1.5 rounded-full bg-amber-400 flex-shrink-0 mt-1.5" />
                                    <p className="text-[11px] text-white/60 leading-relaxed">
                                      <span className="text-amber-300 font-medium">Win championships</span> ‚Äî each title is a massive XP event. Prioritize win-now rosters in your best leagues.
                                    </p>
                                  </div>
                                  <div className="flex items-start gap-2">
                                    <span className="w-1.5 h-1.5 rounded-full bg-purple-400 flex-shrink-0 mt-1.5" />
                                    <p className="text-[11px] text-white/60 leading-relaxed">
                                      <span className="text-purple-300 font-medium">Play harder formats</span> ‚Äî SF, TEP, and 14+ team leagues earn difficulty bonuses on every XP event.
                                    </p>
                                  </div>
                                  <div className="flex items-start gap-2">
                                    <span className="w-1.5 h-1.5 rounded-full bg-cyan-400 flex-shrink-0 mt-1.5" />
                                    <p className="text-[11px] text-white/60 leading-relaxed">
                                      <span className="text-cyan-300 font-medium">Join more leagues</span> ‚Äî volume compounds with consistency. Each new league adds base XP per season.
                                    </p>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>

                          {/* AI Coach section */}
                          {aiCoachError && <p className="text-red-400 text-sm mt-3">{aiCoachError}</p>}

                          {aiCoach && (
                            <div className="mt-4 bg-gradient-to-br from-purple-500/10 to-cyan-500/10 rounded-xl p-4 border border-purple-500/20">
                              <h4 className="text-lg font-bold text-purple-300 mb-2">
                                {aiCoach.headline || 'AI Coach Advice'}
                              </h4>
                              {aiCoach.what_hurts_most && (
                                <div className="mb-3">
                                  <span className="text-red-400 text-sm font-semibold">What Hurts Most:</span>
                                  <ul className="text-gray-300 text-sm mt-1 space-y-1">
                                    {aiCoach.what_hurts_most.map((item: string, i: number) => (
                                      <li key={i}>‚Ä¢ {item}</li>
                                    ))}
                                  </ul>
                                </div>
                              )}
                              {aiCoach.quick_wins && (
                                <div className="mb-3">
                                  <span className="text-green-400 text-sm font-semibold">Quick Wins:</span>
                                  <ul className="text-gray-300 text-sm mt-1 space-y-1">
                                    {aiCoach.quick_wins.map((item: string, i: number) => (
                                      <li key={i}>‚Ä¢ {item}</li>
                                    ))}
                                  </ul>
                                </div>
                              )}
                              {aiCoach.season_plan && (
                                <div className="mb-3">
                                  <span className="text-cyan-400 text-sm font-semibold">Season Plan:</span>
                                  <ul className="text-gray-300 text-sm mt-1 space-y-1">
                                    {aiCoach.season_plan.map((item: string, i: number) => (
                                      <li key={i}>‚Ä¢ {item}</li>
                                    ))}
                                  </ul>
                                </div>
                              )}
                              {aiCoach.xp_uplift_strategy && (
                                <div>
                                  <span className="text-yellow-400 text-sm font-semibold">XP Uplift Strategy:</span>
                                  <ul className="text-gray-300 text-sm mt-1 space-y-1">
                                    {aiCoach.xp_uplift_strategy.map((item: string, i: number) => (
                                      <li key={i}>‚Ä¢ {item}</li>
                                    ))}
                                  </ul>
                                </div>
                              )}
                            </div>
                          )}

                          {/* Scoring modal (clean + user-specific explanation) */}
                          {showRankExplain && (() => {
                            const assumptions = rankingPreview?.yearly_projection?.assumptions ?? {}
                            const xpPerLevel = Number(assumptions?.xp_per_level ?? 500)
                            const computedLevel = Math.floor(xp / xpPerLevel)
                            const displayLevel = Number.isFinite(level) ? level : computedLevel
                            const tiers = assumptions?.tier_xp_thresholds ?? []
                            const currentTierRow = Array.isArray(tiers)
                              ? tiers.find((t: any) => Number(t?.tier) === Number(tier))
                              : null

                            return (
                              <div className="fixed inset-0 z-50 flex items-center justify-center px-4">
                                <div className="absolute inset-0 bg-black/60" onClick={() => setShowRankExplain(false)} />

                                <div className="relative w-full max-w-2xl rounded-3xl bg-slate-950/90 border border-white/10 backdrop-blur-xl shadow-[0_20px_60px_rgba(0,0,0,0.6)] p-5 sm:p-6">
                                  <div className="flex items-start justify-between gap-3">
                                    <div>
                                      <h4 className="text-xl font-bold text-white">How scoring works</h4>
                                      <p className="text-sm text-white/60 mt-1">
                                        Your Level and Tier are derived directly from Career XP.
                                      </p>
                                    </div>

                                    <button
                                      onClick={() => setShowRankExplain(false)}
                                      className="px-3 py-1.5 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 text-white/70 text-sm"
                                    >
                                      Close
                                    </button>
                                  </div>

                                  <div className="mt-4 space-y-4">
                                    <div className="rounded-2xl bg-white/5 border border-white/10 p-4">
                                      <div className="text-sm font-semibold text-white/80 mb-2">Why you're at this level</div>
                                      <ul className="text-sm text-white/70 space-y-1">
                                        <li>
                                          ‚Ä¢ Career XP: <span className="font-semibold text-white/90">{xp.toLocaleString()}</span>
                                        </li>
                                        <li>
                                          ‚Ä¢ XP per level: <span className="font-semibold text-white/90">{xpPerLevel.toLocaleString()}</span>
                                        </li>
                                        <li>
                                          ‚Ä¢ Level = floor(XP / XP per level) ‚Üí{" "}
                                          <span className="font-semibold text-purple-200">{displayLevel}</span>
                                        </li>
                                        <li>
                                          ‚Ä¢ Tier is the highest tier whose minLevel ‚â§ your level ‚Üí{" "}
                                          <span className="font-semibold text-green-200">
                                            Tier {tier} ({tierName})
                                          </span>
                                        </li>
                                        {currentTierRow?.minLevel != null && (
                                          <li>
                                            ‚Ä¢ Your tier begins at Level{" "}
                                            <span className="font-semibold text-white/90">{Number(currentTierRow.minLevel).toLocaleString()}</span>{" "}
                                            (‚âà{" "}
                                            <span className="font-semibold text-white/90">{Number(currentTierRow.minXp ?? 0).toLocaleString()}</span>{" "}
                                            XP)
                                          </li>
                                        )}
                                      </ul>
                                    </div>

                                    <div className="rounded-2xl bg-white/5 border border-white/10 p-4">
                                      <div className="text-sm font-semibold text-white/80 mb-2">How you earn XP (high-level)</div>
                                      <ul className="text-sm text-white/70 space-y-1">
                                        <li>‚Ä¢ Wins and win rate contribute steady XP.</li>
                                        <li>‚Ä¢ Playoff appearances and championships increase XP faster.</li>
                                        <li>‚Ä¢ League difficulty multipliers (when detected) boost XP per season.</li>
                                      </ul>
                                      <p className="text-[11px] text-white/50 mt-3">
                                        We'll keep tuning weights over time. Your Tier/Level is always consistent with your Career XP.
                                      </p>
                                    </div>

                                    {next && (
                                      <div className="rounded-2xl bg-gradient-to-r from-cyan-500/10 to-purple-500/10 border border-white/10 p-4">
                                        <div className="text-sm font-semibold text-white/80 mb-1">What you need for the next tier</div>
                                        <div className="text-sm text-white/70">
                                          You need{" "}
                                          <span className="font-bold text-cyan-200">{next.needed.toLocaleString()} XP</span> to reach{" "}
                                          <span className="font-bold text-purple-200">
                                            Tier {next.nextTier} ({next.nextTierName})
                                          </span>
                                          .
                                        </div>
                                        <div className="mt-3 h-2 rounded-full bg-white/10 overflow-hidden">
                                          <div
                                            className="h-2 rounded-full bg-gradient-to-r from-cyan-400/70 to-purple-400/70"
                                            style={{ width: `${Math.round(next.progress * 100)}%` }}
                                          />
                                        </div>
                                      </div>
                                    )}
                                  </div>
                                </div>
                              </div>
                            )
                          })()}
                          </div>
                        </div>
                      )
                    })()}

                    {aiReport && (
                      <div className="relative rounded-3xl bg-gradient-to-br from-slate-900/80 to-slate-950/80 border border-purple-500/20 backdrop-blur-xl shadow-[0_20px_60px_rgba(0,0,0,0.4)] overflow-hidden">
                        <div className="h-1.5 bg-gradient-to-r from-cyan-400 via-purple-500 to-cyan-400" />
                        <div className="p-6 sm:p-8">
                          <div className="flex items-center justify-between flex-wrap gap-4 mb-6">
                            <div className="flex items-center gap-3">
                              <div className="w-12 h-12 rounded-2xl bg-gradient-to-br from-cyan-500/30 to-purple-500/30 flex items-center justify-center text-2xl">ü§ñ</div>
                              <div>
                                <h3 className="text-2xl font-bold text-white">AI Analysis</h3>
                                <p className="text-xs text-white/50 mt-0.5">Your fantasy career decoded by AI</p>
                                <span className="inline-flex px-3 py-1 mt-1 rounded-full bg-gradient-to-r from-purple-500/30 to-cyan-500/30 border border-purple-400/40 text-sm text-purple-200 font-medium">
                                  {aiReport.archetype}
                                </span>
                              </div>
                            </div>
                            <div className="flex gap-2">
                              <button onClick={rerunAiAnalysis} disabled={aiAnalysisLoading} className="px-5 py-2.5 text-sm rounded-xl bg-cyan-500/20 hover:bg-cyan-500/30 border border-cyan-400/30 text-cyan-200 transition disabled:opacity-50 font-medium">
                                {aiAnalysisLoading ? 'Refreshing‚Ä¶' : 'Re-run'}
                              </button>
                              <button onClick={() => setShowAiExplain(true)} disabled={aiAnalysisLoading} className="px-5 py-2.5 text-sm rounded-xl bg-purple-500/20 hover:bg-purple-500/30 border border-purple-400/30 text-purple-200 transition disabled:opacity-50 font-medium">
                                How it works
                              </button>
                            </div>
                          </div>

                          <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <div className="rounded-2xl bg-black/40 border border-white/10 p-5">
                              <div className="text-xl sm:text-2xl font-black text-white leading-tight mb-2">"{aiReport.title}"</div>
                              <p className="text-xs text-white/60">Based on activity + outcomes.</p>
                            </div>
                            <div className="rounded-2xl bg-gradient-to-br from-cyan-500/20 to-cyan-500/5 border border-cyan-400/30 p-4 text-center">
                              <div className="text-xs uppercase tracking-wider text-cyan-300/70 mb-1">Consistency</div>
                              <div className="text-3xl font-black text-cyan-200">{aiReport.consistency_score ?? '‚Äî'}<span className="text-lg text-cyan-400/50">/100</span></div>
                              <div className="mt-2 h-2 rounded-full bg-black/40 overflow-hidden">
                                <div className="h-2 rounded-full bg-gradient-to-r from-cyan-500 to-cyan-300" style={{ width: `${Math.max(0, Math.min(100, Number(aiReport.consistency_score ?? 0)))}%` }} />
                              </div>
                              <p className="mt-2 text-[10px] text-cyan-300/60 leading-tight">How steady your performance is across seasons. Higher = less variance.</p>
                            </div>
                            <div className="rounded-2xl bg-gradient-to-br from-purple-500/20 to-purple-500/5 border border-purple-400/30 p-4 text-center">
                              <div className="text-xs uppercase tracking-wider text-purple-300/70 mb-1">AI Rating</div>
                              <div className="text-3xl font-black text-purple-200">{aiReport.rating ?? '‚Äî'}<span className="text-lg text-purple-400/50">/100</span></div>
                              <div className="mt-2 h-2 rounded-full bg-black/40 overflow-hidden">
                                <div className="h-2 rounded-full bg-gradient-to-r from-purple-500 to-purple-300" style={{ width: `${Math.max(0, Math.min(100, Number(aiReport.rating ?? 0)))}%` }} />
                              </div>
                              <p className="mt-2 text-[10px] text-purple-300/60 leading-tight">Overall career grade based on wins, playoffs, and championships.</p>
                            </div>
                            <div className="rounded-2xl bg-gradient-to-br from-amber-500/10 to-orange-500/5 border border-amber-400/20 p-4 flex flex-col justify-center">
                              <div className="text-xs uppercase tracking-wider text-amber-300/70 mb-1">Window Status</div>
                              {(aiReport as any).window_status ? (
                                <>
                                  <div className="flex items-center gap-2 mb-1">
                                    <span className="text-xl">{(aiReport as any).window_status_emoji || 'üèÜ'}</span>
                                    <span className="text-lg font-black text-amber-200">{(aiReport as any).window_status_label || (aiReport as any).window_status}</span>
                                  </div>
                                  <p className="text-[11px] text-white/60 leading-relaxed">
                                    {(aiReport as any).window_status === 'READY_TO_COMPETE' && 'Championship window OPEN. Buy proven talent, win now!'}
                                    {(aiReport as any).window_status === 'REBUILDING' && 'Building for 2026+. Stack picks and young WRs/QBs.'}
                                    {(aiReport as any).window_status === 'OVEREXTENDED' && 'Fragile contender. Shore up depth or sell before value craters.'}
                                    {(aiReport as any).window_status === 'AGING_CORE' && 'Window closing fast. Aggressively sell for picks.'}
                                    {(aiReport as any).window_status === 'DIRECTION_NEEDED' && 'Pick a lane ‚Äî push in or pivot out!'}
                                  </p>
                                  {(aiReport as any).offseason_label && (
                                    <div className={`mt-2 inline-flex px-2 py-0.5 rounded-full text-[10px] font-semibold ${
                                      (aiReport as any).offseason_label === 'Best 2025 Outlook' ? 'bg-green-500/30 text-green-300' :
                                      (aiReport as any).offseason_label === 'Most Fragile Contender' ? 'bg-yellow-500/30 text-yellow-300' :
                                      (aiReport as any).offseason_label === 'Best Rebuild Foundation' ? 'bg-blue-500/30 text-blue-300' :
                                      'bg-red-500/30 text-red-300'
                                    }`}>
                                      {(aiReport as any).offseason_label}
                                    </div>
                                  )}
                                </>
                              ) : (aiReport as any).team_status ? (
                                <>
                                  <div className="text-2xl font-black text-amber-200 mb-1">{(aiReport as any).team_status}</div>
                                  <p className="text-[11px] text-white/60 leading-relaxed">
                                    {(aiReport as any).team_status === 'CONTENDER' && 'Buy points, sell uncertainty. Win now!'}
                                    {(aiReport as any).team_status === 'REBUILDER' && 'Sell points, buy value. Stack for the future.'}
                                    {(aiReport as any).team_status === 'MIDDLE' && 'Pick a lane ‚Äî push in or pivot out!'}
                                  </p>
                                </>
                              ) : (
                                <>
                                  <div className="text-lg font-bold text-amber-200 mb-1">{aiReport.archetype || 'Balanced'}</div>
                                  <p className="text-[11px] text-white/60 leading-relaxed line-clamp-3">{aiReport.legacy_summary || 'Your fantasy manager archetype and playstyle.'}</p>
                                </>
                              )}
                              {aiAnalysisRemaining != null && (
                                <div className="mt-2 text-[10px] text-white/50">Runs left: <span className="text-white font-bold">{aiAnalysisRemaining}</span></div>
                              )}
                            </div>
                          </div>

                          {(aiReport as any).offseason_power_index != null && (
                            <div className="rounded-2xl bg-gradient-to-br from-indigo-500/15 to-violet-500/10 border border-indigo-400/30 p-5">
                              <div className="flex items-center justify-between mb-4">
                                <div className="flex items-center gap-3">
                                  <div className="w-10 h-10 rounded-xl bg-indigo-500/30 flex items-center justify-center text-xl">üìä</div>
                                  <div>
                                    <div className="text-lg font-bold text-indigo-200">Offseason Power Index</div>
                                    <div className="text-xs text-indigo-300/60">If the season started today, here's how you stack up</div>
                                  </div>
                                </div>
                                <div className="text-3xl font-black text-indigo-200">{(aiReport as any).offseason_power_index}<span className="text-lg text-indigo-400/50">/100</span></div>
                              </div>
                              {(aiReport as any).power_index_breakdown && (
                                <div>
                                  <div className="grid grid-cols-2 sm:grid-cols-4 gap-2">
                                    <div className="rounded-xl bg-black/30 p-3 text-center">
                                      <div className="text-[10px] uppercase text-white/50 mb-1">Roster Value</div>
                                      <div className="text-xl font-bold text-white">{(aiReport as any).power_index_breakdown.roster_value}</div>
                                      <div className="text-[10px] text-indigo-300/60">40% weight</div>
                                    </div>
                                    <div className="rounded-xl bg-black/30 p-3 text-center">
                                      <div className="text-[10px] uppercase text-white/50 mb-1">Positional</div>
                                      <div className="text-xl font-bold text-white">{(aiReport as any).power_index_breakdown.positional_scarcity}</div>
                                      <div className="text-[10px] text-indigo-300/60">25% weight</div>
                                    </div>
                                    <div className="rounded-xl bg-black/30 p-3 text-center">
                                      <div className="text-[10px] uppercase text-white/50 mb-1">Age Curve</div>
                                      <div className="text-xl font-bold text-white">{(aiReport as any).power_index_breakdown.age_curve}</div>
                                      <div className="text-[10px] text-indigo-300/60">20% weight</div>
                                    </div>
                                    <div className="rounded-xl bg-black/30 p-3 text-center">
                                      <div className="text-[10px] uppercase text-white/50 mb-1">Pick Capital</div>
                                      <div className="text-xl font-bold text-white">{(aiReport as any).power_index_breakdown.pick_capital}</div>
                                      <div className="text-[10px] text-indigo-300/60">15% weight</div>
                                    </div>
                                  </div>
                                  <div className="text-[10px] text-center text-white/40 mt-2">Weights show how much each category contributes to your total score</div>
                                </div>
                              )}
                            </div>
                          )}

                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="rounded-2xl bg-gradient-to-br from-emerald-500/15 to-emerald-500/5 border border-emerald-400/30 p-5">
                              <div className="flex items-center gap-2 mb-3">
                                <div className="w-8 h-8 rounded-lg bg-emerald-500/30 flex items-center justify-center text-base">üí™</div>
                                <div className="text-base font-bold text-emerald-200">Strengths</div>
                                <span className="ml-auto px-2 py-0.5 rounded-full bg-emerald-500/30 border border-emerald-400/40 text-[10px] text-emerald-200 font-medium">Top 3</span>
                              </div>
                              <ul className="space-y-2">
                                {aiReport.insights.strengths?.slice(0, 3).map((s, i) => (
                                  <li key={i} className="flex gap-2 text-sm text-white/80">
                                    <span className="w-5 h-5 rounded bg-emerald-500/30 flex items-center justify-center text-emerald-300 font-bold text-xs shrink-0">{i + 1}</span>
                                    <span>{s}</span>
                                  </li>
                                ))}
                              </ul>
                            </div>
                            <div className="rounded-2xl bg-gradient-to-br from-rose-500/15 to-rose-500/5 border border-rose-400/30 p-5">
                              <div className="flex items-center gap-2 mb-3">
                                <div className="w-8 h-8 rounded-lg bg-rose-500/30 flex items-center justify-center text-base">üéØ</div>
                                <div className="text-base font-bold text-rose-200">Areas to Improve</div>
                                <span className="ml-auto px-2 py-0.5 rounded-full bg-rose-500/30 border border-rose-400/40 text-[10px] text-rose-200 font-medium">Top 3</span>
                              </div>
                              <ul className="space-y-2">
                                {aiReport.insights.weaknesses?.slice(0, 3).map((w, i) => (
                                  <li key={i} className="flex gap-2 text-sm text-white/80">
                                    <span className="w-5 h-5 rounded bg-rose-500/30 flex items-center justify-center text-rose-300 font-bold text-xs shrink-0">{i + 1}</span>
                                    <span>{w}</span>
                                  </li>
                                ))}
                              </ul>
                            </div>
                          </div>
                        </div>
                      </div>
                    )}

                    {stats && (
                      <div className="relative rounded-3xl bg-gradient-to-br from-slate-900/80 to-slate-950/80 border border-cyan-500/20 backdrop-blur-xl shadow-[0_20px_60px_rgba(0,0,0,0.4)] overflow-hidden">
                        <div className="h-1.5 bg-gradient-to-r from-cyan-400 via-emerald-500 to-cyan-400" />
                        <div className="p-6 sm:p-8">
                          <div className="flex items-center justify-between flex-wrap gap-4 mb-6">
                            <div className="flex items-center gap-3">
                              <div className="w-12 h-12 rounded-2xl bg-gradient-to-br from-cyan-500/30 to-emerald-500/30 flex items-center justify-center text-2xl">üìä</div>
                              <div>
                                <h3 className="text-2xl font-bold text-white">Career Stats</h3>
                                <p className="text-sm text-white/50 mt-1">All-time totals from Sleeper</p>
                              </div>
                            </div>
                            <div className="flex items-center gap-3">
                              {careerStatsRemaining != null && (
                                <span className="text-xs text-white/50">Remaining: <span className="text-white font-bold">{careerStatsRemaining}</span></span>
                              )}
                              <button onClick={refreshCareerStats} disabled={careerStatsLoading} className="px-5 py-2.5 text-sm rounded-xl bg-cyan-500/20 hover:bg-cyan-500/30 border border-cyan-400/30 text-cyan-200 transition disabled:opacity-50 font-medium">
                                {careerStatsLoading ? 'Refreshing‚Ä¶' : 'Refresh'}
                              </button>
                            </div>
                          </div>

                          <div className="grid grid-cols-3 sm:grid-cols-6 gap-3">
                            <ToolStatCard label="Seasons" value={String(seasonsVal)} icon="üìÖ" accent="cyan" />
                            <ToolStatCard label="Leagues" value={String(leaguesVal)} icon="üèÜ" accent="purple" />
                            <ToolStatCard label="Win Rate" value={`${stats.win_percentage ?? 0}%`} icon="üìà" accent="emerald" />
                            <ToolStatCard label="Championships" value={String(stats.championships ?? 0)} icon="ü•á" accent="amber" />
                            <ToolStatCard label="Playoffs" value={`${playoffsVal} (${playoffPct}%)`} icon="üéØ" accent="cyan" />
                            <ToolStatCard label="Total Points" value={(stats.total_points_for ?? stats.total_points ?? 0).toLocaleString()} icon="‚ö°" accent="purple" />
                          </div>
                          
                          {specialtyStats && specialtyStats.total_leagues > 0 && (
                            <div className="mt-6 pt-6 border-t border-white/10">
                              <div className="flex items-center gap-2 mb-4">
                                <span className="text-lg">üé≤</span>
                                <h4 className="text-lg font-semibold text-white/80">Specialty Leagues</h4>
                                <span className="text-xs px-2 py-0.5 rounded-full bg-amber-500/20 text-amber-300 border border-amber-500/30">
                                  Not included in AI grading
                                </span>
                              </div>
                              <p className="text-xs text-white/50 mb-4">
                                Specialty formats like Guillotine, Best Ball, and Survivor are tracked separately because their unique rules create skewed records.
                              </p>
                              <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
                                {specialtyStats.by_format?.guillotine && (
                                  <div className="bg-rose-500/10 border border-rose-500/20 rounded-xl p-3 text-center">
                                    <div className="text-xl mb-1">üî™</div>
                                    <div className="text-xs text-rose-300 font-medium mb-1">Guillotine</div>
                                    <div className="text-sm text-white">{specialtyStats.by_format.guillotine.leagues} leagues</div>
                                  </div>
                                )}
                                {specialtyStats.by_format?.bestball && (
                                  <div className="bg-emerald-500/10 border border-emerald-500/20 rounded-xl p-3 text-center">
                                    <div className="text-xl mb-1">üéØ</div>
                                    <div className="text-xs text-emerald-300 font-medium mb-1">Best Ball</div>
                                    <div className="text-sm text-white">{specialtyStats.by_format.bestball.leagues} leagues</div>
                                  </div>
                                )}
                                {specialtyStats.by_format?.survivor && (
                                  <div className="bg-amber-500/10 border border-amber-500/20 rounded-xl p-3 text-center">
                                    <div className="text-xl mb-1">üèùÔ∏è</div>
                                    <div className="text-xs text-amber-300 font-medium mb-1">Survivor</div>
                                    <div className="text-sm text-white">{specialtyStats.by_format.survivor.leagues} leagues</div>
                                  </div>
                                )}
                                {specialtyStats.by_format?.draft_only && (
                                  <div className="bg-purple-500/10 border border-purple-500/20 rounded-xl p-3 text-center">
                                    <div className="text-xl mb-1">üìù</div>
                                    <div className="text-xs text-purple-300 font-medium mb-1">Draft Only</div>
                                    <div className="text-sm text-white">{specialtyStats.by_format.draft_only.leagues} leagues</div>
                                  </div>
                                )}
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                    )}

                    <LeagueHistoryAccordion
                      leagues={leagues}
                      backfillLoading={backfillLoading}
                      backfillResult={backfillResult}
                      onRefreshPlayoffData={runPlayoffBackfill}
                      getPlayerName={getPlayerName}
                      getPlayerPosition={getPlayerPosition}
                      navigateToChat={navigateToChat}
                    />

                    {/* AI-Powered Panels */}
                    {username && (
                      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                        <div className="rounded-2xl bg-gradient-to-b from-slate-900/90 to-slate-950/90 border border-cyan-500/20 p-4">
                          <InsightsPanel username={username} leagueId={reportCardLeague || leagues[0]?.league_id} />
                        </div>
                        <div className="rounded-2xl bg-gradient-to-b from-slate-900/90 to-slate-950/90 border border-yellow-500/20 p-4">
                          <BadgeDisplay username={username} />
                        </div>
                      </div>
                    )}

                    <div className="mt-6 rounded-2xl bg-gradient-to-b from-slate-900/90 to-slate-950/90 border border-purple-500/20 p-4">
                      <CommunityInsights />
                    </div>

                    {/* Portfolio Over Time Chart */}
                    {reportCardLeague && username && (
                      <div className="mt-6">
                        <PortfolioChart
                          leagueId={reportCardLeague}
                          userId={username}
                          isSuperFlex={leagues.find(l => l.league_id === reportCardLeague)?.is_sf === true}
                          mode={valuationMode === 'atTime' ? 'atTime' : 'hindsight'}
                        />
                      </div>
                    )}
                  </div>
                )}

                {activeTab === 'trade' && (
                  <div className="space-y-6">
                    {/* Tab Headline */}
                    <p className="text-center text-sm sm:text-base text-white/60">Know if a trade helps or hurts your team before you accept.</p>
                    {/* AI GM Status Indicator */}
                    {(tradeSelectedLeague || leagues[0]?.league_id) && (
                      <AIGMStatusIndicator
                        username={username}
                        leagueId={tradeSelectedLeague || leagues[0]?.league_id || ''}
                        onReady={(cache) => {
                          console.log('AI GM ready with cache:', cache)
                        }}
                      />
                    )}

                    {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                        TRADE REPORT CARD - Premium Header (Dynasty Dealmaker Style)
                        Shows verdict, grade, fairness, confidence at a glance
                    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
                    {inlineTradeResult ? (
                      <div className="relative rounded-3xl bg-gradient-to-br from-slate-900/95 via-purple-900/30 to-slate-900/95 border border-purple-500/30 shadow-[0_20px_60px_rgba(0,0,0,0.4)] overflow-hidden">
                        <div className="h-1.5 bg-gradient-to-r from-purple-500 via-cyan-400 to-purple-500" />
                        
                        <div className="p-6 sm:p-8">
                          {/* Report Card Title */}
                          <div className="flex items-center gap-2 mb-6">
                            <span className="text-2xl">üìã</span>
                            <h2 className="text-xl sm:text-2xl font-bold text-white">Trade Report Card</h2>
                            <span className="ml-auto px-3 py-1 rounded-full bg-purple-500/20 border border-purple-400/30 text-purple-300 text-xs font-semibold">
                              AI Analysis
                            </span>
                          </div>

                          {/* Main Verdict Row */}
                          <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            {/* Verdict Badge */}
                            <div className="col-span-2 lg:col-span-1 rounded-2xl bg-gradient-to-br from-white/5 to-white/[0.02] border border-white/10 p-5 text-center">
                              <div className="text-xs uppercase tracking-wider text-white/50 mb-2">Verdict</div>
                              <div className={`text-2xl sm:text-3xl font-black ${
                                inlineTradeResult.verdict?.toLowerCase().includes('fair') ? 'text-emerald-400' :
                                inlineTradeResult.verdict?.toLowerCase().includes('favors a') || inlineTradeResult.verdict?.toLowerCase().includes('accept') ? 'text-cyan-400' :
                                inlineTradeResult.verdict?.toLowerCase().includes('favors b') || inlineTradeResult.verdict?.toLowerCase().includes('decline') ? 'text-rose-400' : 
                                'text-amber-400'
                              }`}>
                                {inlineTradeResult.verdict?.toLowerCase().includes('fair') ? '‚úì Fair' :
                                 inlineTradeResult.verdict?.toLowerCase().includes('favors a') ? '‚Üë Strong' :
                                 inlineTradeResult.verdict?.toLowerCase().includes('accept') ? '‚úì Accept' :
                                 inlineTradeResult.verdict?.toLowerCase().includes('decline') ? '‚úó Risky' :
                                 inlineTradeResult.verdict || '‚Äî'}
                              </div>
                            </div>

                            {/* Trade Grade */}
                            <div className="rounded-2xl bg-gradient-to-br from-white/5 to-white/[0.02] border border-white/10 p-5 text-center">
                              <div className="text-xs uppercase tracking-wider text-white/50 mb-2">Grade</div>
                              <div className={`text-4xl sm:text-5xl font-black ${
                                inlineTradeResult.grade?.startsWith('A') ? 'text-emerald-400' :
                                inlineTradeResult.grade?.startsWith('B') ? 'text-cyan-400' :
                                inlineTradeResult.grade?.startsWith('C') ? 'text-amber-400' :
                                'text-rose-400'
                              }`}>
                                {inlineTradeResult.grade || '‚Äî'}
                              </div>
                            </div>

                            {/* Fairness Score */}
                            <div className="rounded-2xl bg-gradient-to-br from-white/5 to-white/[0.02] border border-white/10 p-5 text-center">
                              <div className="text-xs uppercase tracking-wider text-white/50 mb-2">Balance</div>
                              <div className="text-3xl sm:text-4xl font-bold text-white">
                                {inlineTradeResult.fairnessScore ?? inlineTradeResult.balanceScore ?? '‚Äî'}
                                {(inlineTradeResult.fairnessScore || inlineTradeResult.balanceScore) && <span className="text-lg text-white/50">/100</span>}
                              </div>
                            </div>

                            {/* Confidence & Risk ‚Äî Trust Badge */}
                            <div className="rounded-2xl bg-gradient-to-br from-white/5 to-white/[0.02] border border-white/10 p-5 flex flex-col items-center justify-center">
                              <div className="text-xs uppercase tracking-wider text-white/50 mb-2">Confidence</div>
                              {(() => {
                                const trustData = inlineTradeResult.confidenceRisk
                                  ? convertConfidenceRiskToTrustData(inlineTradeResult.confidenceRisk)
                                  : {
                                      state: (inlineTradeResult.confidence === 'high' || (typeof inlineTradeResult.confidence === 'number' && inlineTradeResult.confidence >= 80))
                                        ? 'high' as const : 'learning' as const,
                                      score: typeof inlineTradeResult.confidence === 'number' ? inlineTradeResult.confidence : 50,
                                      riskChips: [],
                                      explanation: '',
                                    }
                                return (
                                  <ConfidenceBadge
                                    data={trustData}
                                    size="sm"
                                    onTap={() => {
                                      setTrustSheetData({
                                        ...trustData,
                                        dataSources: buildDataSources({
                                          hasHistorical: true,
                                          hasMarket: true,
                                          hasLeagueContext: !!leagues.length,
                                        }),
                                      })
                                      setTrustSheetOpen(true)
                                    }}
                                  />
                                )
                              })()}
                            </div>
                          </div>

                          {/* At a Glance Row */}
                          <div className="flex flex-wrap gap-3 mb-6">
                            {inlineTradeResult.netDelta && (
                              <div className="px-4 py-2 rounded-xl bg-black/30 border border-white/10">
                                <span className="text-xs text-white/50">Net Value: </span>
                                <span className={`font-semibold ${
                                  parseFloat(String(inlineTradeResult.netDelta)) > 0 ? 'text-emerald-400' :
                                  parseFloat(String(inlineTradeResult.netDelta)) < 0 ? 'text-rose-400' : 'text-white'
                                }`}>
                                  {parseFloat(String(inlineTradeResult.netDelta)) > 0 ? '+' : ''}{inlineTradeResult.netDelta}
                                </span>
                              </div>
                            )}
                            {inlineTradeResult.windowFit && (
                              <div className="px-4 py-2 rounded-xl bg-black/30 border border-white/10">
                                <span className="text-xs text-white/50">Window: </span>
                                <span className="font-semibold text-cyan-400">{inlineTradeResult.windowFit}</span>
                              </div>
                            )}
                            {inlineTradeResult.riskFlags && inlineTradeResult.riskFlags.length > 0 && (
                              <div className="px-4 py-2 rounded-xl bg-rose-500/10 border border-rose-500/20">
                                <span className="text-xs text-rose-300/70">Risks: </span>
                                <span className="font-semibold text-rose-400">{inlineTradeResult.riskFlags.length}</span>
                              </div>
                            )}
                          </div>

                          {inlineTradeResult.offseasonContext?.offseason && (
                            <div className="mb-4 rounded-xl border border-amber-500/30 bg-amber-500/10 px-4 py-3 flex items-start gap-3">
                              <div className="shrink-0 mt-0.5 w-5 h-5 rounded-full bg-amber-500/20 flex items-center justify-center">
                                <span className="text-amber-300 text-xs font-bold">!</span>
                              </div>
                              <div>
                                <div className="text-sm font-semibold text-amber-200">{inlineTradeResult.offseasonContext.offseasonBadge}</div>
                                <div className="text-xs text-amber-200/60 mt-0.5">{inlineTradeResult.offseasonContext.offseasonNote}</div>
                              </div>
                            </div>
                          )}

                          {inlineTradeResult.acceptanceBuckets && Array.isArray(inlineTradeResult.acceptanceBuckets) && inlineTradeResult.acceptanceBuckets.length > 0 && (
                            <div className="mb-6 rounded-xl border border-white/10 bg-white/[0.02] p-4">
                              <div className="text-xs font-semibold text-white/70 uppercase tracking-wider mb-3">Acceptance Drivers</div>
                              <div className="grid grid-cols-1 sm:grid-cols-5 gap-2">
                                {inlineTradeResult.acceptanceBuckets.map((b: any) => {
                                  const d = Number(b.delta) || 0
                                  return (
                                  <div key={b.key || b.label} className="rounded-lg bg-black/30 border border-white/5 px-3 py-2">
                                    <div className="text-[10px] text-white/40 uppercase tracking-wider">{b.label || '‚Äî'}</div>
                                    <div className="flex items-baseline gap-1 mt-0.5">
                                      <span className="text-lg font-bold text-white">{b.value ?? '‚Äî'}</span>
                                      <span className={`text-[10px] font-medium ${d > 0 ? 'text-emerald-400' : d < 0 ? 'text-rose-400' : 'text-white/30'}`}>
                                        {d > 0 ? '+' : ''}{(d * 100).toFixed(0)}%
                                      </span>
                                    </div>
                                    <div className="text-[9px] text-white/35 mt-0.5 line-clamp-2">{b.note || ''}</div>
                                  </div>
                                  )
                                })}
                              </div>
                            </div>
                          )}

                          {inlineTradeResult.confidenceRisk && (
                            <div className="mb-6">
                              {(() => {
                                const trustData = convertConfidenceRiskToTrustData(inlineTradeResult.confidenceRisk)
                                return (
                                  <div className="rounded-xl border border-white/[0.06] bg-white/[0.02] p-4 space-y-3">
                                    <div className="flex items-center justify-between">
                                      <ConfidenceBadge
                                        data={trustData}
                                        size="md"
                                        onTap={() => {
                                          setTrustSheetData({
                                            ...trustData,
                                            dataSources: buildDataSources({
                                              hasHistorical: true,
                                              hasMarket: true,
                                              hasLeagueContext: !!leagues.length,
                                            }),
                                          })
                                          setTrustSheetOpen(true)
                                        }}
                                      />
                                    </div>
                                    {trustData.riskChips.length > 0 && (
                                      <div className="flex flex-wrap gap-1.5">
                                        {trustData.riskChips.map((chip) => (
                                          <span
                                            key={chip.tag}
                                            className="inline-flex items-center px-2 py-0.5 rounded-lg text-[10px] font-medium border bg-white/5 border-white/10 text-white/50 cursor-help"
                                            title={chip.tooltip}
                                          >
                                            {chip.label}
                                          </span>
                                        ))}
                                      </div>
                                    )}
                                    {trustData.explanation && (
                                      <p className="text-[11px] text-white/40 leading-relaxed">{trustData.explanation}</p>
                                    )}
                                  </div>
                                )
                              })()}
                            </div>
                          )}

                          {/* AI Validation Pipeline Visual */}
                          <div className="mb-6 p-4 rounded-2xl bg-black/20 border border-white/5">
                            <div className="text-xs uppercase tracking-wider text-white/40 mb-3">AI Evaluation Pipeline</div>
                            <div className="flex flex-wrap items-center gap-2 sm:gap-3">
                              {[
                                { label: 'Values', icon: 'üí∞' },
                                { label: 'Context', icon: 'üìä' },
                                { label: 'Window', icon: 'üéØ' },
                                { label: 'Fairness', icon: '‚öñÔ∏è' },
                                { label: 'Verdict', icon: '‚úì' }
                              ].map((step, idx) => (
                                <div key={idx} className="flex items-center gap-2">
                                  <div className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-emerald-500/20 border border-emerald-500/30">
                                    <span className="text-emerald-400">‚úì</span>
                                    <span className="text-xs text-emerald-300">{step.label}</span>
                                  </div>
                                  {idx < 4 && <span className="text-white/20 hidden sm:inline">‚Üí</span>}
                                </div>
                              ))}
                            </div>
                          </div>

                          {/* Why the AI Decided This */}
                          {(inlineTradeResult.expertAnalysis || (inlineTradeResult.why && inlineTradeResult.why.length > 0)) && (
                            <div className="rounded-2xl bg-gradient-to-br from-cyan-500/10 to-purple-500/10 border border-cyan-500/20 overflow-hidden">
                              <div className="p-5">
                                <h4 className="text-sm font-semibold text-cyan-400 mb-3 flex items-center gap-2">
                                  <span>üß†</span> Why the AI says this
                                </h4>
                                
                                {/* Top 3 Bullet Points */}
                                <ul className="space-y-2 mb-4">
                                  {(inlineTradeResult.why || []).slice(0, 3).map((point: string, idx: number) => (
                                    <li key={idx} className="flex items-start gap-3 text-sm text-gray-200">
                                      <span className="w-5 h-5 rounded-full bg-purple-500/30 flex items-center justify-center text-xs text-purple-300 flex-shrink-0 mt-0.5">
                                        {idx + 1}
                                      </span>
                                      <span className="leading-relaxed">{point}</span>
                                    </li>
                                  ))}
                                </ul>

                                {/* Expand/Collapse Full Reasoning */}
                                {inlineTradeResult.expertAnalysis && (
                                  <details className="group">
                                    <summary className="cursor-pointer text-xs text-cyan-400 hover:text-cyan-300 transition flex items-center gap-1">
                                      <span className="group-open:rotate-90 transition-transform">‚ñ∂</span>
                                      View full reasoning
                                    </summary>
                                    <div className="mt-3 pt-3 border-t border-white/10">
                                      <p className="text-sm text-gray-300 leading-relaxed">{inlineTradeResult.expertAnalysis}</p>
                                    </div>
                                  </details>
                                )}
                              </div>
                            </div>
                          )}
                        </div>

                        {/* Trade Sides Section */}
                        <div className="px-6 sm:px-8 pb-6 sm:pb-8">
                          <h4 className="text-sm font-semibold text-white/70 mb-4 flex items-center gap-2">
                            <span>üîÑ</span> Trade Breakdown
                          </h4>
                          
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            {/* Side A Card */}
                            <div className="rounded-2xl bg-gradient-to-br from-cyan-500/10 to-cyan-500/5 border border-cyan-500/20 p-4">
                              <div className="flex items-center gap-2 mb-3">
                                <div className="w-8 h-8 rounded-lg bg-cyan-500/30 flex items-center justify-center text-sm">üë§</div>
                                <span className="font-semibold text-cyan-400">You Get</span>
                              </div>
                              <div className="flex flex-wrap gap-2">
                                {inlineSideA.split(',').filter(Boolean).map((item: string, idx: number) => (
                                  <span key={idx} className="px-3 py-1.5 rounded-lg bg-black/40 border border-cyan-500/30 text-sm text-white">
                                    {item.trim()}
                                  </span>
                                ))}
                              </div>
                              {inlineTradeResult.sideAValue && (
                                <div className="mt-3 pt-3 border-t border-cyan-500/20 text-right">
                                  <span className="text-xs text-white/50">Total Value: </span>
                                  <span className="text-lg font-bold text-cyan-400">{inlineTradeResult.sideAValue}</span>
                                </div>
                              )}
                            </div>

                            {/* Side B Card */}
                            <div className="rounded-2xl bg-gradient-to-br from-purple-500/10 to-purple-500/5 border border-purple-500/20 p-4">
                              <div className="flex items-center gap-2 mb-3">
                                <div className="w-8 h-8 rounded-lg bg-purple-500/30 flex items-center justify-center text-sm">üë•</div>
                                <span className="font-semibold text-purple-400">You Give</span>
                              </div>
                              <div className="flex flex-wrap gap-2">
                                {inlineSideB.split(',').filter(Boolean).map((item: string, idx: number) => (
                                  <span key={idx} className="px-3 py-1.5 rounded-lg bg-black/40 border border-purple-500/30 text-sm text-white">
                                    {item.trim()}
                                  </span>
                                ))}
                              </div>
                              {inlineTradeResult.sideBValue && (
                                <div className="mt-3 pt-3 border-t border-purple-500/20 text-right">
                                  <span className="text-xs text-white/50">Total Value: </span>
                                  <span className="text-lg font-bold text-purple-400">{inlineTradeResult.sideBValue}</span>
                                </div>
                              )}
                            </div>
                          </div>

                          {/* Value Balance Bar */}
                          {(inlineTradeResult.sideAValue || inlineTradeResult.sideBValue) && (
                            <div className="mb-6">
                              <div className="text-xs text-white/50 mb-2 text-center">Value Balance</div>
                              <div className="h-3 rounded-full bg-black/30 overflow-hidden flex">
                                <div 
                                  className="h-full bg-gradient-to-r from-cyan-500 to-cyan-400 transition-all"
                                  style={{ 
                                    width: inlineTradeResult.sideAValue && inlineTradeResult.sideBValue 
                                      ? `${Math.min(100, Math.max(0, (parseFloat(String(inlineTradeResult.sideAValue)) / (parseFloat(String(inlineTradeResult.sideAValue)) + parseFloat(String(inlineTradeResult.sideBValue)))) * 100))}%`
                                      : '50%'
                                  }}
                                />
                                <div 
                                  className="h-full bg-gradient-to-r from-purple-400 to-purple-500 transition-all flex-1"
                                />
                              </div>
                              <div className="flex justify-between mt-1 text-[10px] text-white/40">
                                <span>You Get</span>
                                <span>You Give</span>
                              </div>
                            </div>
                          )}

                          {/* Risk Flags as Pills */}
                          {inlineTradeResult.riskFlags && inlineTradeResult.riskFlags.length > 0 && (
                            <div className="mb-6">
                              <h5 className="text-xs font-semibold text-rose-400 mb-3 flex items-center gap-2">
                                <span>‚ö†Ô∏è</span> Risk & Context Flags
                              </h5>
                              <AIRiskFlags risks={inlineTradeResult.riskFlags} compact />
                            </div>
                          )}

                          {/* Suggested Tweaks */}
                          {inlineTradeResult.suggestedTweaks && inlineTradeResult.suggestedTweaks.length > 0 && (
                            <div>
                              <h5 className="text-xs font-semibold text-amber-400 mb-3 flex items-center gap-2">
                                <span>üí°</span> Suggested Tweaks
                              </h5>
                              <div className="space-y-2">
                                {inlineTradeResult.suggestedTweaks.map((tweak: any, idx: number) => (
                                  <div key={idx} className="p-3 rounded-xl bg-amber-500/10 border border-amber-500/20 flex items-center justify-between gap-3">
                                    <span className="text-sm text-amber-200">{typeof tweak === 'string' ? tweak : tweak.change}</span>
                                    {tweak.impact && (
                                      <span className="text-xs text-amber-400 whitespace-nowrap">+{tweak.impact}</span>
                                    )}
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}

                          {/* Counter Suggestions (Clickable) */}
                          <TradeCounterSuggestions
                            counters={inlineTradeResult?.counters}
                            onAddCandidateToGive={addCounterCandidateToGive}
                            onAddCandidateToGet={addCounterCandidateToGet}
                            engineRequest={inlineTradeResult?.engineRequest}
                            championshipEquity={inlineTradeResult?.championshipEquity}
                          />

                          {/* Share for Token CTA */}
                          <div className="mt-6 pt-6 border-t border-white/10">
                            <div className="rounded-2xl bg-gradient-to-r from-purple-500/10 via-cyan-500/10 to-purple-500/10 border border-purple-500/20 p-4">
                              <div className="flex flex-col sm:flex-row items-center justify-between gap-4">
                                <div className="flex items-center gap-3">
                                  <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-cyan-500 flex items-center justify-center text-lg">
                                    üéÅ
                                  </div>
                                  <div>
                                    <div className="text-sm font-semibold text-white">Share this trade result</div>
                                    <div className="text-xs text-purple-300">Unlock 1 free AI token</div>
                                  </div>
                                </div>
                                <button
                                  onClick={() => handleShareReward('trade_result')}
                                  disabled={shareRewardLoading || !canShareToday}
                                  className={`px-5 py-2.5 rounded-xl font-semibold text-sm transition-all flex items-center gap-2 ${
                                    canShareToday 
                                      ? 'bg-gradient-to-r from-purple-500 to-cyan-500 text-white hover:from-purple-600 hover:to-cyan-600 shadow-lg shadow-purple-500/25'
                                      : 'bg-white/10 text-white/50 cursor-not-allowed'
                                  }`}
                                >
                                  {shareRewardLoading ? (
                                    <>
                                      <svg className="w-4 h-4 animate-spin" viewBox="0 0 24 24" fill="none">
                                        <circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="3" strokeDasharray="32" strokeLinecap="round" />
                                      </svg>
                                      Sharing...
                                    </>
                                  ) : canShareToday ? (
                                    <>
                                      <Share2 className="w-4 h-4" />
                                      Share to Twitter
                                    </>
                                  ) : (
                                    'Already claimed today'
                                  )}
                                </button>
                              </div>
                              {shareRewardMessage && (
                                <div className={`mt-3 text-sm px-3 py-2 rounded-lg ${
                                  shareRewardMessage.type === 'success' ? 'bg-emerald-500/20 text-emerald-300' :
                                  shareRewardMessage.type === 'error' ? 'bg-rose-500/20 text-rose-300' :
                                  'bg-cyan-500/20 text-cyan-300'
                                }`}>
                                  {shareRewardMessage.text}
                                </div>
                              )}
                              {shareRewardTokens > 0 && (
                                <div className="mt-2 text-xs text-purple-300 text-center">
                                  You have {shareRewardTokens} unredeemed token{shareRewardTokens > 1 ? 's' : ''}
                                </div>
                              )}
                            </div>
                          </div>
                        </div>
                      </div>
                    ) : (
                      /* Trade History Report Card */
                      <div className="relative rounded-3xl bg-gradient-to-br from-slate-900/80 to-slate-950/80 border border-white/10 overflow-hidden">
                        <div className="h-1 bg-gradient-to-r from-purple-500/50 via-cyan-400/50 to-purple-500/50" />
                        <div className="p-6 sm:p-8">
                          <div className="text-center mb-6">
                            <div className="w-14 h-14 mx-auto mb-3 rounded-2xl bg-gradient-to-br from-purple-500/20 to-cyan-500/20 flex items-center justify-center text-2xl">
                              üìã
                            </div>
                            <h3 className="text-lg font-semibold text-white mb-1">Trade History Report Card</h3>
                            <p className="text-sm text-white/50">
                              Select a league ‚Äî this will power the entire AI Trade Hub (Trade Hub, Trade Ideas)
                            </p>
                          </div>

                          {/* League Selector (single source of truth for the whole tab) */}
                          <div className="max-w-md mx-auto mb-4">
                            <select
                              value={reportCardLeague}
                              onChange={(e) => {
                                const leagueId = e.target.value

                                // 1) Set the global league
                                setReportCardLeague(leagueId)

                                // 2) Default to ALL SEASONS on change (most useful view)
                                setReportCardYear('all')
                                setReportCardAvailableYears([])

                                if (!leagueId) return

                                // 3) Clear stale state (prevents jitter / double-loading)
                                setTradeSuggestions([])
                                setTradeHubManagers([])

                                // 4) Load Trade History Report Card (this section)
                                loadTradeHistoryReportCard(leagueId, 'all')

                                // 5) Lock the rest of AI Trade Hub to this league
                                loadTradeHubManagers(leagueId)

                                // 6) Deterministic league analyze (sets finderUserRosterId + suggestions)
                                runTradeFinderAnalysis(leagueId)
                              }}
                              disabled={reportCardLoading}
                              className="w-full h-12 px-4 rounded-xl bg-black/50 border border-white/20 text-white text-sm focus:outline-none focus:border-purple-400/60 disabled:opacity-50"
                            >
                              <option value="">Choose a league...</option>
                              {leagues.map((lg) => (
                                <option key={lg.league_id} value={lg.league_id}>
                                  {lg.name} ({lg.season})
                                </option>
                              ))}
                            </select>
                          </div>

                          {/* Season Selector */}
                          {reportCardLeague && (
                            <div className="max-w-md mx-auto mb-2">
                              <label className="block text-xs font-medium text-white/60 mb-2">Season</label>

                              <select
                                value={reportCardYear}
                                onChange={(e) => {
                                  const seasonMode = e.target.value as ReportCardSeasonMode
                                  setReportCardYear(seasonMode)
                                  loadTradeHistoryReportCard(reportCardLeague, seasonMode)
                                }}
                                disabled={reportCardLoading}
                                className="w-full h-11 px-4 rounded-xl bg-black/50 border border-white/20 text-white text-sm focus:outline-none focus:border-purple-400/60 disabled:opacity-50"
                              >
                                {/* ‚úÖ All Seasons (default) */}
                                <option value="all">All Seasons</option>

                                {/* ‚úÖ Current season */}
                                <option value="current">Current Season</option>

                                {/* Past seasons (only if you have them) */}
                                {reportCardAvailableYears
                                  .filter((y) => y !== 'current' && y !== 'all')
                                  .map((y) => (
                                    <option key={y} value={y}>
                                      {y}
                                    </option>
                                  ))}
                              </select>

                              <p className="mt-2 text-xs text-white/40 text-center">
                                Tip: "All Seasons" compiles every trade you've made in this league into one AI report card.
                              </p>
                            </div>
                          )}
                          
                          {/* Loading State - Enhanced */}
                          {reportCardLoading && (
                            <div className="relative py-10 px-6">
                              {/* Animated Background */}
                              <div className="absolute inset-0 bg-gradient-to-br from-purple-900/30 via-indigo-900/20 to-cyan-900/30 rounded-2xl overflow-hidden">
                                <div className="absolute inset-0 opacity-30">
                                  <div className="absolute top-0 left-1/4 w-32 h-32 bg-purple-500/20 rounded-full blur-3xl animate-pulse" />
                                  <div className="absolute bottom-0 right-1/4 w-40 h-40 bg-cyan-500/20 rounded-full blur-3xl animate-pulse" style={{ animationDelay: '0.5s' }} />
                                </div>
                              </div>
                              
                              <div className="relative z-10 flex flex-col items-center">
                                {/* Animated Icon Stack */}
                                <div className="relative w-20 h-20 mb-6">
                                  <div className="absolute inset-0 rounded-2xl bg-gradient-to-br from-purple-500/30 to-cyan-500/30 animate-pulse" />
                                  <div className="absolute inset-1 rounded-xl bg-black/50 flex items-center justify-center">
                                    <div className="relative">
                                      <span className="text-3xl">üìä</span>
                                      <div className="absolute -bottom-1 -right-1 w-5 h-5 bg-gradient-to-br from-amber-400 to-orange-500 rounded-full flex items-center justify-center animate-bounce">
                                        <span className="text-xs">‚úì</span>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                                
                                {/* Title */}
                                <h4 className="text-lg font-bold text-white mb-2">Analyzing Your Trades</h4>
                                <p className="text-white/50 text-sm mb-6 text-center max-w-xs">AI is grading each trade against current market values</p>
                                
                                {/* Progress Steps */}
                                <div className="flex items-center gap-3 mb-4">
                                  <div className="flex items-center gap-2">
                                    <div className="w-8 h-8 rounded-full bg-emerald-500/20 border border-emerald-500/50 flex items-center justify-center">
                                      <span className="text-emerald-400 text-xs">‚úì</span>
                                    </div>
                                    <span className="text-xs text-white/60">Fetching</span>
                                  </div>
                                  <div className="w-6 h-px bg-white/20" />
                                  <div className="flex items-center gap-2">
                                    <div className="w-8 h-8 rounded-full bg-cyan-500/30 border border-cyan-400/50 flex items-center justify-center animate-pulse">
                                      <div className="w-3 h-3 border-2 border-cyan-400 border-t-transparent rounded-full animate-spin" />
                                    </div>
                                    <span className="text-xs text-cyan-300">Grading</span>
                                  </div>
                                  <div className="w-6 h-px bg-white/20" />
                                  <div className="flex items-center gap-2">
                                    <div className="w-8 h-8 rounded-full bg-white/5 border border-white/20 flex items-center justify-center">
                                      <span className="text-white/30 text-xs">3</span>
                                    </div>
                                    <span className="text-xs text-white/40">Complete</span>
                                  </div>
                                </div>
                                
                                {/* Shimmer Bar */}
                                <div className="w-full max-w-xs h-1.5 bg-white/10 rounded-full overflow-hidden">
                                  <div className="h-full bg-gradient-to-r from-purple-500 via-cyan-400 to-purple-500 rounded-full animate-shimmer" 
                                       style={{ 
                                         width: '60%',
                                         backgroundSize: '200% 100%',
                                         animation: 'shimmer 2s linear infinite'
                                       }} 
                                  />
                                </div>
                              </div>
                            </div>
                          )}
                          
                          {/* No Trades Found */}
                          {reportCardSummary?.noTrades && (
                            <div className="text-center py-8">
                              <div className="text-3xl mb-3">üîç</div>
                              <p className="text-white/60 text-sm">{reportCardSummary.message}</p>
                            </div>
                          )}
                          
                          {/* Report Card Summary - Enhanced Visuals */}
                          {reportCardSummary && !reportCardSummary.noTrades && !reportCardLoading && (
                            <div className="space-y-8">
                              
                              {/* SECTION 1: Grade Card with Animated Cloud Background */}
                              {(() => {
                                const grade = tradeAnalytics?.gradeCard?.grade || reportCardSummary.overallGrade
                                const isAGrade = ['A+', 'A'].includes(grade)
                                const isBGrade = ['A-', 'B+', 'B'].includes(grade)
                                const isCGrade = ['B-', 'C+', 'C'].includes(grade)
                                const isDGrade = ['C-', 'D+', 'D'].includes(grade)
                                
                                const cloudColor = isAGrade ? 'bg-emerald-500' : isBGrade ? 'bg-cyan-500' : isCGrade ? 'bg-amber-500' : isDGrade ? 'bg-orange-500' : 'bg-rose-500'
                                const cloudColor2 = isAGrade ? 'bg-teal-400' : isBGrade ? 'bg-blue-400' : isCGrade ? 'bg-yellow-400' : isDGrade ? 'bg-amber-400' : 'bg-pink-400'
                                const cloudColor3 = isAGrade ? 'bg-cyan-400' : isBGrade ? 'bg-indigo-400' : isCGrade ? 'bg-orange-400' : isDGrade ? 'bg-yellow-400' : 'bg-red-400'
                                const gradeTextColor = isAGrade ? 'text-emerald-400' : isBGrade ? 'text-cyan-400' : isCGrade ? 'text-amber-400' : isDGrade ? 'text-orange-400' : 'text-rose-400'
                                const scoreTextColor = isAGrade ? 'text-emerald-300' : isBGrade ? 'text-cyan-300' : isCGrade ? 'text-amber-300' : isDGrade ? 'text-orange-300' : 'text-rose-300'
                                const borderColor = isAGrade ? 'border-emerald-400/40' : isBGrade ? 'border-cyan-400/40' : isCGrade ? 'border-amber-400/40' : isDGrade ? 'border-orange-400/40' : 'border-rose-400/40'
                                
                                return (
                                  <div className="relative overflow-hidden rounded-3xl min-h-[420px] sm:min-h-[480px]">
                                    {/* Base dark gradient */}
                                    <div className="absolute inset-0 bg-gradient-to-b from-slate-900/95 via-slate-950 to-black" />
                                    
                                    {/* Central floating cloud effect */}
                                    <div className="absolute inset-0 overflow-hidden">
                                      {/* Main centered cloud glow */}
                                      <div className={`absolute w-[500px] h-[500px] rounded-full ${cloudColor} animate-cloud-center left-1/2 top-1/2`} style={{ filter: 'blur(100px)', opacity: 0.35 }} />
                                      <div className={`absolute w-[350px] h-[350px] rounded-full ${cloudColor2} animate-cloud-center left-1/2 top-1/2`} style={{ filter: 'blur(80px)', opacity: 0.25, animationDelay: '2s' }} />
                                      
                                      {/* Floating accent clouds */}
                                      <div className={`absolute w-[200px] h-[200px] rounded-full ${cloudColor3} animate-float-cloud-slow`} style={{ top: '10%', left: '10%', filter: 'blur(60px)', opacity: 0.2 }} />
                                      <div className={`absolute w-[180px] h-[180px] rounded-full ${cloudColor2} animate-float-cloud-slow`} style={{ bottom: '15%', right: '15%', filter: 'blur(60px)', opacity: 0.2, animationDelay: '5s' }} />
                                    </div>
                                    
                                    {/* Radial vignette overlay */}
                                    <div className="absolute inset-0 grade-card-vignette" />
                                    
                                    {/* Floating Card Content */}
                                    <div className="relative z-10 flex flex-col items-center justify-center h-full py-10 sm:py-14 px-6">
                                      {/* Inner floating card */}
                                      <div className="animate-float-card bg-gradient-to-b from-white/[0.08] to-white/[0.02] backdrop-blur-xl rounded-2xl border border-white/10 shadow-2xl shadow-black/50 px-10 sm:px-16 py-10 sm:py-12 flex flex-col items-center">
                                      {/* Header */}
                                      <div className="text-center mb-8">
                                        <div className="text-[10px] sm:text-xs uppercase tracking-[0.3em] text-rose-400/90 font-semibold mb-2">Dynasty Trade Report</div>
                                        <div className="text-xl sm:text-2xl font-bold text-white">{profile?.sleeper_username || username}</div>
                                        <div className="text-sm text-white/50 mt-1">{leagues.find(l => l.league_id === reportCardLeague)?.name || 'Your League'}</div>
                                      </div>
                                      
                                      {/* Dashed circle with grade */}
                                      <div className="relative flex items-center justify-center mb-8">
                                        <div className={`w-44 h-44 sm:w-52 sm:h-52 rounded-full border-2 border-dashed ${borderColor} flex items-center justify-center`}>
                                          <div className={`text-7xl sm:text-8xl font-black tracking-tight ${gradeTextColor} drop-shadow-[0_0_30px_rgba(255,255,255,0.15)]`}>
                                            {grade}
                                          </div>
                                        </div>
                                      </div>
                                      
                                      {/* Score */}
                                      <div className={`text-4xl sm:text-5xl font-bold mb-2 ${scoreTextColor}`}>
                                        {tradeAnalytics?.gradeCard?.score ?? (reportCardSummary.totalTrades > 0 ? Math.round(parseFloat(reportCardSummary.avgScore || '0') * 10) : 0)}
                                        <span className="text-lg text-white/40 font-normal">/100</span>
                                      </div>
                                      
                                      {/* Label */}
                                      <div className="text-lg sm:text-xl text-white font-medium mb-8">
                                        {tradeAnalytics?.gradeCard?.label || (
                                          ['A+', 'A'].includes(grade) ? 'Elite Trader' :
                                          ['A-', 'B+'].includes(grade) ? 'Great Trader' :
                                          ['B', 'B-'].includes(grade) ? 'Above Average Trader' :
                                          ['C+', 'C'].includes(grade) ? 'Average Trader' :
                                          ['C-', 'D+'].includes(grade) ? 'Below Average Trader' :
                                          'Needs Improvement'
                                        )}
                                      </div>
                                      
                                      {/* Stats dots */}
                                      <div className="flex items-center justify-center gap-6 text-sm text-white/60">
                                        <div className="flex items-center gap-2">
                                          <span className={`w-2 h-2 rounded-full ${isAGrade ? 'bg-emerald-400' : isBGrade ? 'bg-cyan-400' : isCGrade ? 'bg-amber-400' : isDGrade ? 'bg-orange-400' : 'bg-rose-400'}`} />
                                          <span>{reportCardSummary.totalTrades} trades analyzed</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                          <span className={`w-2 h-2 rounded-full ${isAGrade ? 'bg-emerald-400' : isBGrade ? 'bg-cyan-400' : isCGrade ? 'bg-amber-400' : isDGrade ? 'bg-orange-400' : 'bg-rose-400'}`} />
                                          <span>{reportCardYear === 'current' ? 'Current Season' : reportCardYear === 'all' ? 'All Seasons' : reportCardYear}</span>
                                        </div>
                                      </div>
                                      </div>{/* End inner floating card */}
                                    </div>
                                  </div>
                                )
                              })()}

                              {/* SECTION 1.5: Three-Lens Report Card */}
                              {tradeAnalytics?.reportCard?.threeLens && (
                                <div className="space-y-4">
                                  <div className="text-center mb-2">
                                    <h3 className="text-lg font-bold text-white">Performance Breakdown</h3>
                                    <p className="text-xs text-white/40">35% Market + 35% Lineup Impact + 30% Decision Quality</p>
                                  </div>

                                  <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                    {/* Market Performance Lens */}
                                    {(() => {
                                      const m = tradeAnalytics.reportCard.threeLens.market
                                      const trendIcon = m.trend === 'improved' ? 'üìà' : m.trend === 'declined' ? 'üìâ' : '‚û°Ô∏è'
                                      const trendColor = m.trend === 'improved' ? 'text-emerald-400' : m.trend === 'declined' ? 'text-rose-400' : 'text-white/60'
                                      return (
                                        <div className="rounded-2xl bg-gradient-to-br from-indigo-900/40 to-indigo-950/30 border border-indigo-500/30 p-5 text-center">
                                          <div className="text-2xl mb-2">üíπ</div>
                                          <div className="text-xs uppercase tracking-widest text-indigo-300/70 font-semibold mb-3">Market Value</div>
                                          <div className="text-3xl font-black text-indigo-300 mb-1">{m.currentGrade}</div>
                                          <div className="text-xs text-white/50 mb-3">Score: {m.score}/100</div>
                                          <div className="space-y-1 text-xs">
                                            <div className="flex justify-between">
                                              <span className="text-white/50">At-Time</span>
                                              <span className="text-white/70">{m.atTimeGrade} ({m.atTimeDelta >= 0 ? '+' : ''}{m.atTimeDelta.toLocaleString()})</span>
                                            </div>
                                            <div className="flex justify-between">
                                              <span className="text-white/50">Current</span>
                                              <span className="text-white/70">{m.currentGrade} ({m.currentDelta >= 0 ? '+' : ''}{m.currentDelta.toLocaleString()})</span>
                                            </div>
                                            <div className={`flex items-center justify-center gap-1 mt-2 ${trendColor}`}>
                                              <span>{trendIcon}</span>
                                              <span className="capitalize">{m.trend}</span>
                                            </div>
                                          </div>
                                        </div>
                                      )
                                    })()}

                                    {/* Lineup Impact Lens */}
                                    {(() => {
                                      const li = tradeAnalytics.reportCard.threeLens.lineupImpact
                                      return (
                                        <div className="rounded-2xl bg-gradient-to-br from-cyan-900/40 to-cyan-950/30 border border-cyan-500/30 p-5 text-center">
                                          <div className="text-2xl mb-2">‚ö°</div>
                                          <div className="text-xs uppercase tracking-widest text-cyan-300/70 font-semibold mb-3">Lineup Impact</div>
                                          <div className="text-3xl font-black text-cyan-300 mb-1">{li.grade}</div>
                                          <div className="text-xs text-white/50 mb-3">Score: {li.score}/100</div>
                                          <div className="space-y-1 text-xs">
                                            <div className="flex justify-between">
                                              <span className="text-white/50">Starter Upgrades</span>
                                              <span className="text-white/70">{li.starterUpgradeCount}/{li.totalPlayersReceived}</span>
                                            </div>
                                            <div className="flex justify-between">
                                              <span className="text-white/50">Est. PPG Delta</span>
                                              <span className={`${li.estimatedPPGDelta >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{li.estimatedPPGDelta >= 0 ? '+' : ''}{li.estimatedPPGDelta}</span>
                                            </div>
                                            <div className="flex justify-between">
                                              <span className="text-white/50">Realized PPG</span>
                                              <span className={`${li.realizedPPGDelta >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{li.realizedPPGDelta >= 0 ? '+' : ''}{li.realizedPPGDelta}</span>
                                            </div>
                                          </div>
                                        </div>
                                      )
                                    })()}

                                    {/* Decision Quality Lens */}
                                    {(() => {
                                      const dq = tradeAnalytics.reportCard.threeLens.decisionQuality
                                      const goalEmoji = dq.inferredGoal === 'rebuild' ? 'üèóÔ∏è' : dq.inferredGoal === 'win-now' ? 'üèÜ' : dq.inferredGoal === 'balanced' ? '‚öñÔ∏è' : '‚ùì'
                                      return (
                                        <div className="rounded-2xl bg-gradient-to-br from-amber-900/40 to-amber-950/30 border border-amber-500/30 p-5 text-center">
                                          <div className="text-2xl mb-2">üß†</div>
                                          <div className="text-xs uppercase tracking-widest text-amber-300/70 font-semibold mb-3">Decision Quality</div>
                                          <div className="text-3xl font-black text-amber-300 mb-1">{dq.grade}</div>
                                          <div className="text-xs text-white/50 mb-3">Score: {dq.score}/100</div>
                                          <div className="space-y-1 text-xs">
                                            <div className="flex justify-between">
                                              <span className="text-white/50">Strategy</span>
                                              <span className="text-white/70">{goalEmoji} {dq.inferredGoal === 'win-now' ? 'Win Now' : dq.inferredGoal.charAt(0).toUpperCase() + dq.inferredGoal.slice(1)}</span>
                                            </div>
                                            <div className="flex justify-between">
                                              <span className="text-white/50">Alignment</span>
                                              <span className="text-white/70">{dq.goalAlignment}%</span>
                                            </div>
                                          </div>
                                          <div className="mt-3 text-[10px] text-white/40 leading-relaxed">{dq.reasoning}</div>
                                        </div>
                                      )
                                    })()}
                                  </div>

                                  {/* Composite Score Bar */}
                                  {(() => {
                                    const comp = tradeAnalytics.reportCard.threeLens.composite
                                    const barColor = comp.score >= 80 ? 'from-emerald-500 to-emerald-400' : comp.score >= 60 ? 'from-cyan-500 to-cyan-400' : comp.score >= 45 ? 'from-amber-500 to-amber-400' : 'from-rose-500 to-rose-400'
                                    return (
                                      <div className="rounded-xl bg-slate-800/60 border border-slate-700/40 p-4 mt-2">
                                        <div className="flex items-center justify-between mb-2">
                                          <span className="text-xs text-white/60 uppercase tracking-wider font-medium">Composite Grade</span>
                                          <span className="text-sm font-bold text-white">{comp.grade} ‚Äî {comp.label}</span>
                                        </div>
                                        <div className="h-2 bg-slate-700/60 rounded-full overflow-hidden">
                                          <div className={`h-full rounded-full bg-gradient-to-r ${barColor} transition-all duration-700`} style={{ width: `${comp.score}%` }} />
                                        </div>
                                        <div className="text-right text-xs text-white/40 mt-1">{comp.score}/100</div>
                                      </div>
                                    )
                                  })()}
                                </div>
                              )}

                              {/* SECTION 1.6: Skill Radar Chart */}
                              {tradeAnalytics?.reportCard?.skillRadar && (
                                <div className="rounded-2xl bg-gradient-to-br from-slate-900/90 via-slate-900/80 to-slate-800/70 border border-slate-700/50 p-6 backdrop-blur-sm">
                                  <div className="flex items-center justify-center gap-2 mb-1">
                                    <span className="text-2xl">üéØ</span>
                                    <h3 className="text-xl font-bold text-white">Skill Breakdown</h3>
                                  </div>
                                  <p className="text-sm text-white/40 text-center mb-6">How you perform across four key trading skills</p>

                                  {/* CSS-based radar visualization */}
                                  {(() => {
                                    const radar = tradeAnalytics.reportCard.skillRadar
                                    const skills = [
                                      { label: 'Market Timing', value: radar.marketTiming, color: 'text-indigo-400', bg: 'bg-indigo-400' },
                                      { label: 'Starter Upgrades', value: radar.starterUpgradeEfficiency, color: 'text-cyan-400', bg: 'bg-cyan-400' },
                                      { label: 'Risk Mgmt', value: radar.riskManagement, color: 'text-emerald-400', bg: 'bg-emerald-400' },
                                      { label: 'Negotiation', value: radar.negotiationEfficiency, color: 'text-amber-400', bg: 'bg-amber-400' },
                                    ]
                                    return (
                                      <div className="space-y-4">
                                        {skills.map((skill) => (
                                          <div key={skill.label}>
                                            <div className="flex items-center justify-between mb-1.5">
                                              <span className={`text-sm font-medium ${skill.color}`}>{skill.label}</span>
                                              <span className="text-sm font-bold text-white">{skill.value}%</span>
                                            </div>
                                            <div className="h-2.5 bg-slate-700/60 rounded-full overflow-hidden">
                                              <div
                                                className={`h-full rounded-full ${skill.bg} transition-all duration-700`}
                                                style={{ width: `${skill.value}%`, opacity: 0.85 }}
                                              />
                                            </div>
                                          </div>
                                        ))}
                                      </div>
                                    )
                                  })()}
                                </div>
                              )}

                              {/* SECTION 1.7: AI Counter Projection */}
                              {tradeAnalytics?.reportCard?.aiCounterProjection && (
                                <div className="rounded-2xl bg-gradient-to-br from-violet-900/30 to-violet-950/20 border border-violet-500/30 p-6">
                                  <div className="flex items-center justify-center gap-2 mb-1">
                                    <span className="text-2xl">ü§ñ</span>
                                    <h3 className="text-xl font-bold text-white">AI Counter-Proposal Projection</h3>
                                  </div>
                                  <p className="text-sm text-white/40 text-center mb-5">What if you had followed the AI&apos;s suggested counters?</p>

                                  {tradeAnalytics.reportCard.aiCounterProjection.available ? (
                                    <div className="space-y-4">
                                      <div className="grid grid-cols-2 gap-3">
                                        <div className="p-4 rounded-xl bg-slate-800/60 border border-slate-700/40 text-center">
                                          <div className="text-xs text-white/50 uppercase tracking-wider mb-2">Your Actual Value</div>
                                          <div className={`text-2xl font-black ${tradeAnalytics.reportCard.aiCounterProjection.actualNetValue >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                                            {tradeAnalytics.reportCard.aiCounterProjection.actualNetValue >= 0 ? '+' : ''}{tradeAnalytics.reportCard.aiCounterProjection.actualNetValue.toLocaleString()}
                                          </div>
                                        </div>
                                        <div className="p-4 rounded-xl bg-slate-800/60 border border-slate-700/40 text-center">
                                          <div className="text-xs text-white/50 uppercase tracking-wider mb-2">If AI Counters Used</div>
                                          <div className={`text-2xl font-black ${tradeAnalytics.reportCard.aiCounterProjection.projectedNetIfFollowed >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                                            {tradeAnalytics.reportCard.aiCounterProjection.projectedNetIfFollowed >= 0 ? '+' : ''}{tradeAnalytics.reportCard.aiCounterProjection.projectedNetIfFollowed.toLocaleString()}
                                          </div>
                                        </div>
                                      </div>

                                      <div className={`rounded-xl p-4 text-center ${tradeAnalytics.reportCard.aiCounterProjection.netDifference > 0 ? 'bg-violet-500/15 border border-violet-500/30' : 'bg-emerald-500/15 border border-emerald-500/30'}`}>
                                        <div className="text-xs text-white/50 uppercase tracking-wider mb-1">Net Difference</div>
                                        <div className={`text-3xl font-black ${tradeAnalytics.reportCard.aiCounterProjection.netDifference > 0 ? 'text-violet-400' : 'text-emerald-400'}`}>
                                          {tradeAnalytics.reportCard.aiCounterProjection.netDifference > 0 ? '+' : ''}{tradeAnalytics.reportCard.aiCounterProjection.netDifference.toLocaleString()}
                                        </div>
                                      </div>

                                      <div className="text-xs text-white/50 text-center px-4">
                                        {tradeAnalytics.reportCard.aiCounterProjection.message}
                                      </div>
                                      <div className="text-[10px] text-white/30 text-center">
                                        Based on {tradeAnalytics.reportCard.aiCounterProjection.tradesWithCounters} of {tradeAnalytics.reportCard.aiCounterProjection.totalTrades} trades with AI counters
                                      </div>
                                    </div>
                                  ) : (
                                    <div className="text-center py-4">
                                      <div className="text-3xl mb-3">üí°</div>
                                      <p className="text-sm text-white/50 max-w-xs mx-auto">{tradeAnalytics.reportCard.aiCounterProjection.message}</p>
                                    </div>
                                  )}
                                </div>
                              )}

                              {/* SECTION 2: Your Trading Stats ‚Äî Multi-Dimensional */}
                              <div className="rounded-2xl bg-gradient-to-br from-slate-900/90 via-slate-900/80 to-slate-800/70 border border-slate-700/50 p-6 backdrop-blur-sm">
                                <div className="flex items-center justify-center gap-2 mb-1">
                                  <span className="text-2xl">üìä</span>
                                  <h3 className="text-xl font-bold text-white">Your Trading Stats</h3>
                                </div>
                                <p className="text-sm text-white/40 text-center mb-4">Three lenses on every trade ‚Äî no ambiguity</p>

                                {/* Tab Selector */}
                                <div className="flex rounded-xl bg-slate-800/80 border border-slate-700/50 p-1 mb-5">
                                  {([
                                    { key: 'atTime' as const, label: 'At the Time', icon: 'üìã' },
                                    { key: 'hindsight' as const, label: 'With Hindsight', icon: 'üîÆ' },
                                    { key: 'lineupImpact' as const, label: 'Lineup Impact', icon: '‚ö°' },
                                  ]).map(tab => (
                                    <button
                                      key={tab.key}
                                      onClick={() => setStatsTab(tab.key)}
                                      className={`flex-1 py-2.5 px-2 rounded-lg text-xs font-semibold transition-all duration-200 ${
                                        statsTab === tab.key
                                          ? 'bg-slate-700 text-white shadow-lg'
                                          : 'text-white/50 hover:text-white/70'
                                      }`}
                                    >
                                      <span className="mr-1">{tab.icon}</span>
                                      <span className="hidden sm:inline">{tab.label}</span>
                                      <span className="sm:hidden">{tab.key === 'atTime' ? 'At Time' : tab.key === 'hindsight' ? 'Hindsight' : 'Lineup'}</span>
                                    </button>
                                  ))}
                                </div>

                                {/* Tab Description */}
                                <div className="text-center mb-4">
                                  <p className="text-[11px] text-white/40">
                                    {statsTab === 'atTime' && 'What the world thought at the time of each trade'}
                                    {statsTab === 'hindsight' && 'How values have changed since ‚Äî the "real" outcome'}
                                    {statsTab === 'lineupImpact' && 'Estimated PPG gained/lost in your starting lineup'}
                                  </p>
                                </div>

                                {/* Stats Content ‚Äî reads from multiDimensional[statsTab] */}
                                {(() => {
                                  const md = tradeAnalytics?.tradingStats?.multiDimensional?.[statsTab]
                                  if (!md) return (
                                    <div className="text-center py-6">
                                      <div className="text-2xl mb-2">üìä</div>
                                      <p className="text-sm text-white/50">Stats are loading or not yet available for this view.</p>
                                    </div>
                                  )
                                  const isLineup = statsTab === 'lineupImpact'
                                  const netLabel = isLineup ? 'Net PPG Delta' : 'Net Value Delta'
                                  const avgLabel = isLineup ? 'Avg PPG/Trade' : 'Avg Value/Trade'
                                  const netValue = md.netValue || 0
                                  const avgPerTrade = md.avgPerTrade || 0
                                  const unit = isLineup ? ' PPG' : ''

                                  return (
                                    <div className="space-y-5">
                                      {/* Net Value - Hero Stat */}
                                      <div className={`relative p-6 rounded-2xl text-center overflow-hidden ${
                                        netValue >= 0
                                          ? 'bg-gradient-to-br from-emerald-500/20 via-emerald-600/10 to-transparent border border-emerald-500/30'
                                          : 'bg-gradient-to-br from-rose-500/20 via-rose-600/10 to-transparent border border-rose-500/30'
                                      }`}>
                                        <div className={`absolute inset-0 ${netValue >= 0 ? 'bg-emerald-500/5' : 'bg-rose-500/5'}`} />
                                        <div className="relative">
                                          <div className="text-xs text-white/60 uppercase tracking-widest mb-3 font-medium">{netLabel}</div>
                                          <div className={`text-5xl sm:text-6xl font-black tracking-tight ${netValue >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                                            {netValue >= 0 ? '+' : ''}{isLineup ? netValue.toFixed(1) : netValue.toLocaleString()}{unit}
                                          </div>
                                          <div className="flex items-center justify-center gap-1.5 mt-3">
                                            <span className={`inline-block w-2 h-2 rounded-full ${netValue >= 0 ? 'bg-emerald-400' : 'bg-rose-400'} animate-pulse`} />
                                            <span className="text-xs text-white/50">
                                              {statsTab === 'atTime' && 'Based on values at the time of trade'}
                                              {statsTab === 'hindsight' && 'Based on current AF values'}
                                              {statsTab === 'lineupImpact' && 'Estimated from value delta proxy'}
                                            </span>
                                          </div>
                                        </div>
                                      </div>

                                      {/* Wins / Losses / Even */}
                                      <div className="flex gap-2">
                                        <div className="flex-1 p-4 rounded-2xl bg-gradient-to-br from-emerald-500/20 to-emerald-600/5 border border-emerald-500/40 text-center relative overflow-hidden group hover:scale-[1.02] transition-transform">
                                          <div className="absolute inset-0 bg-emerald-400/10 opacity-0 group-hover:opacity-100 transition-opacity" />
                                          <div className="relative">
                                            <div className="text-4xl font-black text-emerald-400 mb-1">{md.wins}</div>
                                            <div className="text-[11px] text-emerald-300/80 uppercase tracking-widest font-semibold">Wins</div>
                                          </div>
                                        </div>
                                        <div className="flex-1 p-4 rounded-2xl bg-gradient-to-br from-rose-500/20 to-rose-600/5 border border-rose-500/40 text-center relative overflow-hidden group hover:scale-[1.02] transition-transform">
                                          <div className="absolute inset-0 bg-rose-400/10 opacity-0 group-hover:opacity-100 transition-opacity" />
                                          <div className="relative">
                                            <div className="text-4xl font-black text-rose-400 mb-1">{md.losses}</div>
                                            <div className="text-[11px] text-rose-300/80 uppercase tracking-widest font-semibold">Losses</div>
                                          </div>
                                        </div>
                                        <div className="flex-1 p-4 rounded-2xl bg-gradient-to-br from-slate-600/30 to-slate-700/10 border border-slate-500/40 text-center relative overflow-hidden group hover:scale-[1.02] transition-transform">
                                          <div className="absolute inset-0 bg-slate-400/10 opacity-0 group-hover:opacity-100 transition-opacity" />
                                          <div className="relative">
                                            <div className="text-4xl font-black text-slate-300 mb-1">{md.even}</div>
                                            <div className="text-[11px] text-slate-400 uppercase tracking-widest font-semibold">Even</div>
                                          </div>
                                        </div>
                                      </div>

                                      {/* Win Definitions Note */}
                                      <div className="text-[10px] text-white/30 text-center px-4">
                                        {statsTab === 'atTime' && `Win = net delta > +300 at time of trade ¬∑ Loss = net delta < -300`}
                                        {statsTab === 'hindsight' && `Win = current net delta > +300 ¬∑ Loss = current net delta < -300`}
                                        {statsTab === 'lineupImpact' && `Win = est. PPG gain > +0.5 ¬∑ Loss = est. PPG loss < -0.5`}
                                      </div>

                                      {/* Win Rate & Avg Per Trade */}
                                      <div className="grid grid-cols-2 gap-3">
                                        <div className="p-4 rounded-xl bg-slate-800/70 border border-slate-700/50 relative overflow-hidden">
                                          <div className="text-xs text-white/60 uppercase tracking-wider mb-2 font-medium">Win Rate</div>
                                          <div className={`text-4xl font-black ${md.winRate >= 50 ? 'text-emerald-400' : 'text-rose-400'}`}>
                                            {md.winRate}%
                                          </div>
                                          <div className="mt-3 h-1.5 bg-slate-700/60 rounded-full overflow-hidden">
                                            <div
                                              className={`h-full rounded-full transition-all duration-500 ${md.winRate >= 50 ? 'bg-gradient-to-r from-emerald-500 to-emerald-400' : 'bg-gradient-to-r from-rose-500 to-rose-400'}`}
                                              style={{ width: `${Math.min(100, md.winRate)}%` }}
                                            />
                                          </div>
                                        </div>
                                        <div className="p-4 rounded-xl bg-slate-800/70 border border-slate-700/50">
                                          <div className="text-xs text-white/60 uppercase tracking-wider mb-2 font-medium">{avgLabel}</div>
                                          <div className={`text-4xl font-black ${avgPerTrade >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                                            {avgPerTrade >= 0 ? '+' : ''}{isLineup ? avgPerTrade.toFixed(1) : avgPerTrade.toLocaleString()}{unit}
                                          </div>
                                          <div className="mt-2 text-[10px] text-white/40">per transaction</div>
                                        </div>
                                      </div>
                                    </div>
                                  )
                                })()}
                              </div>

                              {/* Show More AF Recap - Collapsible Trading Journey */}
                              <div className="rounded-2xl bg-gradient-to-br from-slate-900/90 via-slate-900/80 to-slate-800/70 border border-slate-700/50 overflow-hidden">
                                <button
                                  onClick={() => setShowMoreRecap(!showMoreRecap)}
                                  className="w-full p-4 flex items-center justify-between hover:bg-slate-800/30 transition-colors"
                                >
                                  <div className="flex items-center gap-2">
                                    <span className="text-lg">üìà</span>
                                    <span className="text-sm font-medium text-white">Show More AF Recap</span>
                                  </div>
                                  <span className={`text-white/60 transition-transform duration-300 ${showMoreRecap ? 'rotate-180' : ''}`}>
                                    ‚ñº
                                  </span>
                                </button>
                                
                                {showMoreRecap && (
                                  <div className="p-6 pt-2 border-t border-slate-700/30">
                                    {/* Your Trading Journey */}
                                    <h3 className="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-cyan-400 text-center mb-1">
                                      Your Trading Journey
                                    </h3>
                                    <p className="text-sm text-white/40 text-center mb-6">Cumulative value over time</p>
                                    
                                    {/* Chart */}
                                    {(() => {
                                      // Get all graded trades sorted by timestamp
                                      const allTrades = Object.values(reportCardTradesByYear)
                                        .flat()
                                        .filter((t: any) => t.userInvolved && t.timestamp)
                                        .sort((a: any, b: any) => a.timestamp - b.timestamp)
                                      
                                      if (allTrades.length === 0) {
                                        return (
                                          <div className="text-center text-white/40 py-8">
                                            No trade data available for chart
                                          </div>
                                        )
                                      }
                                      
                                      // Calculate cumulative values
                                      const gradeValues: Record<string, number> = {
                                        'A+': 3500, 'A': 3000, 'A-': 2500,
                                        'B+': 2000, 'B': 1500, 'B-': 1000,
                                        'C+': 500, 'C': 0, 'C-': -500,
                                        'D+': -1000, 'D': -1500, 'D-': -2000,
                                        'F': -3000
                                      }
                                      
                                      let cumulative = 0
                                      const chartData = allTrades.map((trade: any) => {
                                        const value = gradeValues[trade.grade] || 0
                                        cumulative += value
                                        return {
                                          timestamp: trade.timestamp,
                                          date: new Date(trade.timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' }),
                                          value: cumulative,
                                          grade: trade.grade,
                                          isWin: ['A+', 'A', 'A-', 'B+', 'B', 'B-'].includes(trade.grade)
                                        }
                                      })
                                      
                                      const minValue = Math.min(...chartData.map(d => d.value), 0)
                                      const maxValue = Math.max(...chartData.map(d => d.value), 0)
                                      const range = Math.max(Math.abs(maxValue), Math.abs(minValue)) * 1.2 || 1000
                                      
                                      // SVG chart dimensions
                                      const width = 100
                                      const height = 50
                                      const padding = 5
                                      
                                      // Create path for area chart
                                      const points = chartData.map((d, i) => {
                                        const x = padding + (i / (chartData.length - 1 || 1)) * (width - padding * 2)
                                        const y = height / 2 - (d.value / range) * (height / 2 - padding)
                                        return { x, y, ...d }
                                      })
                                      
                                      const linePath = points.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ')
                                      const areaPath = `${linePath} L ${points[points.length - 1]?.x || width - padding} ${height / 2} L ${padding} ${height / 2} Z`
                                      
                                      const finalValue = chartData[chartData.length - 1]?.value || 0
                                      
                                      return (
                                        <>
                                          <div className="relative rounded-xl bg-slate-800/50 border border-slate-700/40 p-4 mb-4">
                                            {/* Y-axis labels */}
                                            <div className="absolute left-2 top-4 text-[10px] text-white/40">{Math.round(range / 1000)}k</div>
                                            <div className="absolute left-2 top-1/2 -translate-y-1/2 text-[10px] text-white/40">0</div>
                                            <div className="absolute left-2 bottom-4 text-[10px] text-white/40">-{Math.round(range / 1000)}k</div>
                                            
                                            {/* Chart */}
                                            <div className="ml-8">
                                              <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-48" preserveAspectRatio="none">
                                                {/* Zero line */}
                                                <line x1={padding} y1={height / 2} x2={width - padding} y2={height / 2} stroke="rgba(255,255,255,0.1)" strokeDasharray="2,2" />
                                                
                                                {/* Gradient definitions */}
                                                <defs>
                                                  <linearGradient id="areaGradientPositive" x1="0%" y1="0%" x2="0%" y2="100%">
                                                    <stop offset="0%" stopColor="rgb(16, 185, 129)" stopOpacity="0.4" />
                                                    <stop offset="100%" stopColor="rgb(16, 185, 129)" stopOpacity="0.05" />
                                                  </linearGradient>
                                                  <linearGradient id="areaGradientNegative" x1="0%" y1="0%" x2="0%" y2="100%">
                                                    <stop offset="0%" stopColor="rgb(244, 63, 94)" stopOpacity="0.05" />
                                                    <stop offset="100%" stopColor="rgb(244, 63, 94)" stopOpacity="0.4" />
                                                  </linearGradient>
                                                </defs>
                                                
                                                {/* Area fill */}
                                                <path d={areaPath} fill={finalValue >= 0 ? "url(#areaGradientPositive)" : "url(#areaGradientNegative)"} />
                                                
                                                {/* Line */}
                                                <path d={linePath} fill="none" stroke={finalValue >= 0 ? "rgb(16, 185, 129)" : "rgb(244, 63, 94)"} strokeWidth="0.5" />
                                              </svg>
                                            </div>
                                            
                                            {/* X-axis dates */}
                                            <div className="ml-8 flex justify-between text-[9px] text-white/40 mt-1">
                                              {chartData.filter((_, i) => i === 0 || i === Math.floor(chartData.length / 2) || i === chartData.length - 1).map((d, i) => (
                                                <span key={i}>{d.date}</span>
                                              ))}
                                            </div>
                                          </div>
                                          
                                          {/* Final Position */}
                                          <div className="flex items-center justify-between p-4 rounded-xl bg-slate-800/50 border border-slate-700/40 mb-4">
                                            <span className="text-white/70 font-medium">Final Position</span>
                                            <span className={`text-3xl font-black ${finalValue >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                                              {finalValue >= 0 ? '+' : ''}{finalValue.toLocaleString()}
                                            </span>
                                          </div>
                                          
                                          {/* Recent Trades Dots */}
                                          <div>
                                            <div className="text-xs text-white/50 uppercase tracking-wider mb-3">Recent Trades</div>
                                            <div className="flex flex-wrap gap-1.5">
                                              {chartData.slice(-20).map((trade, i) => (
                                                <div
                                                  key={i}
                                                  className={`w-3 h-3 rounded-full ${
                                                    trade.isWin 
                                                      ? 'bg-emerald-500' 
                                                      : trade.grade === 'C' || trade.grade === 'C+' || trade.grade === 'C-'
                                                        ? 'bg-amber-500'
                                                        : 'bg-rose-500'
                                                  }`}
                                                  title={`${trade.date}: ${trade.grade}`}
                                                />
                                              ))}
                                            </div>
                                          </div>
                                        </>
                                      )
                                    })()}
                                    
                                    {/* Trading Partners Section */}
                                    {(() => {
                                      // Build trading partners from graded trades
                                      const allTrades = Object.values(reportCardTradesByYear)
                                        .flat()
                                        .filter((t: any) => t.userInvolved)
                                      
                                      if (allTrades.length === 0) return null
                                      
                                      const gradeValues: Record<string, number> = {
                                        'A+': 3500, 'A': 3000, 'A-': 2500,
                                        'B+': 2000, 'B': 1500, 'B-': 1000,
                                        'C+': 500, 'C': 0, 'C-': -500,
                                        'D+': -1000, 'D': -1500, 'D-': -2000,
                                        'F': -3000
                                      }
                                      
                                      const partnerMap: Record<string, { name: string; trades: number; netValue: number; grades: string[] }> = {}
                                      
                                      allTrades.forEach((trade: any) => {
                                        const userParty = trade.parties?.find((p: any) => p.rosterId === trade.userRosterId)
                                        const otherParties = trade.parties?.filter((p: any) => p.rosterId !== trade.userRosterId) || []
                                        
                                        otherParties.forEach((partner: any) => {
                                          const name = partner.displayName || partner.userId || 'Unknown'
                                          if (!partnerMap[name]) {
                                            partnerMap[name] = { name, trades: 0, netValue: 0, grades: [] }
                                          }
                                          partnerMap[name].trades++
                                          partnerMap[name].netValue += gradeValues[trade.grade] || 0
                                          partnerMap[name].grades.push(trade.grade)
                                        })
                                      })
                                      
                                      const partners = Object.values(partnerMap).sort((a, b) => b.netValue - a.netValue)
                                      if (partners.length === 0) return null
                                      
                                      const bestMark = partners[0]
                                      const nemesis = partners[partners.length - 1]
                                      
                                      const getGradeForValue = (netValue: number): string => {
                                        if (netValue >= 3000) return 'A+'
                                        if (netValue >= 2000) return 'A'
                                        if (netValue >= 1000) return 'A-'
                                        if (netValue >= 500) return 'B+'
                                        if (netValue >= 0) return 'B'
                                        if (netValue >= -500) return 'C'
                                        if (netValue >= -1500) return 'C-'
                                        if (netValue >= -2500) return 'D'
                                        if (netValue >= -3500) return 'D-'
                                        return 'F'
                                      }
                                      
                                      const getGradeColor = (grade: string): string => {
                                        if (['A+', 'A', 'A-'].includes(grade)) return 'bg-emerald-500'
                                        if (['B+', 'B', 'B-'].includes(grade)) return 'bg-green-600'
                                        if (['C+', 'C'].includes(grade)) return 'bg-amber-500'
                                        if (['C-', 'D+'].includes(grade)) return 'bg-orange-500'
                                        if (['D', 'D-'].includes(grade)) return 'bg-orange-600'
                                        return 'bg-rose-500'
                                      }
                                      
                                      return (
                                        <div className="mt-8 pt-6 border-t border-slate-700/40">
                                          <h3 className="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400 text-center mb-1">
                                            Trading Partners
                                          </h3>
                                          <p className="text-sm text-white/40 text-center mb-6">Who you've been dealing with</p>
                                          
                                          {/* Best Mark & Nemesis */}
                                          <div className="grid grid-cols-2 gap-3 mb-5">
                                            {bestMark && bestMark.netValue > 0 && (
                                              <div className="p-4 rounded-xl bg-gradient-to-br from-emerald-500/20 to-emerald-600/5 border border-emerald-500/40 relative overflow-hidden">
                                                <div className="absolute top-3 right-3 text-xl">‚≠ê</div>
                                                <div className="text-xs text-emerald-400/80 uppercase tracking-wider font-semibold mb-2">Your Best Mark</div>
                                                <div className="font-bold text-white text-lg truncate">{bestMark.name}</div>
                                                <div className="text-2xl font-black text-emerald-400">+{bestMark.netValue.toLocaleString()}</div>
                                              </div>
                                            )}
                                            {nemesis && nemesis.netValue < 0 && (
                                              <div className="p-4 rounded-xl bg-gradient-to-br from-rose-500/20 to-rose-600/5 border border-rose-500/40 relative overflow-hidden">
                                                <div className="absolute top-3 right-3 text-xl">‚ò†Ô∏è</div>
                                                <div className="text-xs text-rose-400/80 uppercase tracking-wider font-semibold mb-2">Your Nemesis</div>
                                                <div className="font-bold text-white text-lg truncate">{nemesis.name}</div>
                                                <div className="text-2xl font-black text-rose-400">{nemesis.netValue.toLocaleString()}</div>
                                              </div>
                                            )}
                                          </div>
                                          
                                          {/* Partner List */}
                                          <div className="space-y-2">
                                            {partners.map((partner, idx) => {
                                              const grade = getGradeForValue(partner.netValue)
                                              return (
                                                <div 
                                                  key={idx} 
                                                  className={`p-3 rounded-xl flex items-center gap-3 transition-all hover:scale-[1.01] ${
                                                    partner.netValue > 500 
                                                      ? 'bg-gradient-to-r from-emerald-500/15 to-transparent border border-emerald-500/30' 
                                                      : partner.netValue < -500 
                                                        ? 'bg-gradient-to-r from-rose-500/15 to-transparent border border-rose-500/30'
                                                        : 'bg-slate-800/50 border border-slate-700/40'
                                                  }`}
                                                >
                                                  {/* Rank */}
                                                  <div className={`w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold ${
                                                    idx === 0 ? 'bg-gradient-to-br from-emerald-500 to-emerald-600 text-white' :
                                                    idx === 1 ? 'bg-gradient-to-br from-emerald-600 to-emerald-700 text-white' :
                                                    idx === 2 ? 'bg-gradient-to-br from-teal-600 to-teal-700 text-white' :
                                                    'bg-slate-700/80 text-white/70'
                                                  }`}>
                                                    {idx + 1}
                                                  </div>
                                                  
                                                  {/* Name & Trades */}
                                                  <div className="flex-1 min-w-0">
                                                    <div className="font-semibold text-white truncate">{partner.name}</div>
                                                    <div className="text-xs text-white/50">{partner.trades} trade{partner.trades !== 1 ? 's' : ''}</div>
                                                  </div>
                                                  
                                                  {/* Net Value */}
                                                  <div className="text-right mr-2">
                                                    <div className={`text-lg font-bold ${partner.netValue >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                                                      {partner.netValue >= 0 ? '+' : ''}{partner.netValue.toLocaleString()}
                                                    </div>
                                                    <div className="text-[10px] text-white/40">net value</div>
                                                  </div>
                                                  
                                                  {/* Grade Badge */}
                                                  <div className={`w-10 h-10 rounded-lg flex items-center justify-center font-bold text-white text-sm ${getGradeColor(grade)}`}>
                                                    {grade}
                                                  </div>
                                                </div>
                                              )
                                            })}
                                          </div>
                                        </div>
                                      )
                                    })()}
                                    
                                    {/* Best & Worst Trade Section */}
                                    {(() => {
                                      const allTrades = Object.values(reportCardTradesByYear)
                                        .flat()
                                        .filter((t: any) => t.userInvolved && t.grade)
                                      
                                      if (allTrades.length === 0) return null
                                      
                                      const gradeValues: Record<string, number> = {
                                        'A+': 3500, 'A': 3000, 'A-': 2500,
                                        'B+': 2000, 'B': 1500, 'B-': 1000,
                                        'C+': 500, 'C': 0, 'C-': -500,
                                        'D+': -1000, 'D': -1500, 'D-': -2000,
                                        'F': -3000
                                      }
                                      
                                      const tradesWithValue = allTrades.map((t: any) => ({
                                        ...t,
                                        estimatedValue: gradeValues[t.grade] || 0
                                      }))
                                      
                                      const bestTrade = tradesWithValue.reduce((best: any, t: any) => 
                                        t.estimatedValue > (best?.estimatedValue || -Infinity) ? t : best, null)
                                      const worstTrade = tradesWithValue.reduce((worst: any, t: any) => 
                                        t.estimatedValue < (worst?.estimatedValue || Infinity) ? t : worst, null)
                                      
                                      const renderTradeCard = (trade: any, type: 'best' | 'worst') => {
                                        if (!trade) return null
                                        
                                        const userParty = trade.parties?.find((p: any) => p.rosterId === trade.userRosterId)
                                        const otherParty = trade.parties?.find((p: any) => p.rosterId !== trade.userRosterId)
                                        
                                        const playersGiven = otherParty?.playersReceived || []
                                        const playersReceived = userParty?.playersReceived || []
                                        const picksGiven = otherParty?.picksReceived || []
                                        const picksReceived = userParty?.picksReceived || []
                                        
                                        const isBest = type === 'best'
                                        const value = trade.estimatedValue
                                        
                                        return (
                                          <div className={`p-6 rounded-2xl relative overflow-hidden ${
                                            isBest 
                                              ? 'bg-gradient-to-br from-emerald-500/20 via-emerald-600/10 to-transparent border border-emerald-500/30'
                                              : 'bg-gradient-to-br from-rose-500/20 via-rose-600/10 to-transparent border border-rose-500/30'
                                          }`}>
                                            {/* Header */}
                                            <div className="text-center mb-4">
                                              <div className={`text-xs uppercase tracking-widest font-semibold mb-1 ${isBest ? 'text-emerald-400/80' : 'text-rose-400/80'}`}>
                                                {isBest ? 'Your Greatest Victory' : 'Your Biggest Regret'}
                                              </div>
                                              <h4 className="text-2xl font-bold text-white">{isBest ? 'Best Trade' : 'Worst Trade'}</h4>
                                              <div className="text-xs text-white/40">With Hindsight</div>
                                            </div>
                                            
                                            {/* Value */}
                                            <div className={`text-5xl font-black text-center mb-2 ${isBest ? 'text-emerald-400' : 'text-rose-400'}`}>
                                              {value >= 0 ? '+' : ''}{value.toLocaleString()}
                                            </div>
                                            <div className="text-xs text-white/50 text-center mb-4">dynasty value {isBest ? 'gained' : 'lost'}</div>
                                            
                                            {/* Trade Details */}
                                            <div className="text-center text-sm text-white/60 mb-1">vs {otherParty?.displayName || 'Unknown'}</div>
                                            <div className="text-center text-xs text-white/40 mb-4">
                                              {new Date(trade.timestamp).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
                                            </div>
                                            
                                            {/* Assets */}
                                            <div className="bg-slate-800/60 rounded-xl p-4 space-y-3">
                                              {/* You Gave */}
                                              {(playersGiven.length > 0 || picksGiven.length > 0) && (
                                                <div>
                                                  <div className="flex items-center gap-2 mb-2">
                                                    <span className="w-2 h-2 rounded-full bg-rose-500"></span>
                                                    <span className="text-xs text-rose-400 uppercase tracking-wider font-semibold">You Gave</span>
                                                  </div>
                                                  {playersGiven.map((p: any, i: number) => (
                                                    <div key={i} className="flex justify-between items-center py-1 text-sm">
                                                      <PlayerBadge name={p.name} sleeperId={p.id} position={p.position} team={p.team} size="sm" showTeamLogo={false} />
                                                    </div>
                                                  ))}
                                                  {picksGiven.map((p: any, i: number) => (
                                                    <div key={i} className="flex justify-between items-center py-1 text-sm">
                                                      <span className="text-white/70">{p.season} {p.slot ? `${p.round}.${String(p.slot).padStart(2, '0')}` : `Round ${p.round}`}</span>
                                                    </div>
                                                  ))}
                                                </div>
                                              )}
                                              
                                              {/* You Received */}
                                              {(playersReceived.length > 0 || picksReceived.length > 0) && (
                                                <div className={playersGiven.length > 0 || picksGiven.length > 0 ? 'pt-2 border-t border-slate-700/50' : ''}>
                                                  <div className="flex items-center gap-2 mb-2">
                                                    <span className="w-2 h-2 rounded-full bg-emerald-500"></span>
                                                    <span className="text-xs text-emerald-400 uppercase tracking-wider font-semibold">You Received</span>
                                                  </div>
                                                  {playersReceived.map((p: any, i: number) => (
                                                    <div key={i} className="flex justify-between items-center py-1 text-sm">
                                                      <PlayerBadge name={p.name} sleeperId={p.id} position={p.position} team={p.team} size="sm" showTeamLogo={false} />
                                                    </div>
                                                  ))}
                                                  {picksReceived.map((p: any, i: number) => (
                                                    <div key={i} className="flex justify-between items-center py-1 text-sm">
                                                      <span className="text-white/70">{p.season} {p.slot ? `${p.round}.${String(p.slot).padStart(2, '0')}` : `Round ${p.round}`}</span>
                                                    </div>
                                                  ))}
                                                </div>
                                              )}
                                            </div>
                                          </div>
                                        )
                                      }
                                      
                                      return (
                                        <div className="mt-8 pt-6 border-t border-slate-700/40">
                                          <h3 className="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-amber-400 to-orange-400 text-center mb-6">
                                            Highlight Reel
                                          </h3>
                                          
                                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            {renderTradeCard(bestTrade, 'best')}
                                            {renderTradeCard(worstTrade, 'worst')}
                                          </div>
                                        </div>
                                      )
                                    })()}
                                    
                                    {/* Waiver Wire Activity Section */}
                                    {waiverActivity && (waiverActivity.totalAdds > 0 || waiverActivity.totalDrops > 0) && (
                                      <div className="mt-8 pt-6 border-t border-slate-700/40">
                                        <h3 className="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-400 text-center mb-1">
                                          Waiver Wire Activity
                                        </h3>
                                        <p className="text-sm text-white/40 text-center mb-6">Your adds and drops from the wire</p>
                                        
                                        {/* Stats Row */}
                                        <div className="flex justify-center gap-8 mb-6">
                                          <div className="text-center">
                                            <div className="text-4xl font-black text-emerald-400">{waiverActivity.totalAdds}</div>
                                            <div className="text-xs text-white/50 uppercase tracking-wider">Your Adds</div>
                                          </div>
                                          <div className="text-center">
                                            <div className="text-4xl font-black text-rose-400">{waiverActivity.totalDrops}</div>
                                            <div className="text-xs text-white/50 uppercase tracking-wider">Your Drops</div>
                                          </div>
                                        </div>
                                        
                                        {/* Best Waiver Addition */}
                                        {waiverActivity.adds?.length > 0 && (() => {
                                          // Sort by most recent first (best adds would need value data, for now show most recent)
                                          const recentAdd = waiverActivity.adds[0]
                                          return (
                                            <div className="p-4 rounded-xl bg-gradient-to-r from-emerald-500/15 to-transparent border border-emerald-500/30 mb-3">
                                              <div className="flex items-center gap-2 mb-3">
                                                <span className="text-emerald-400 text-lg">+</span>
                                                <span className="text-xs text-emerald-400 uppercase tracking-wider font-semibold">Best Waiver Addition</span>
                                              </div>
                                              <div className="flex items-center justify-between">
                                                <div>
                                                  <div className="flex items-center gap-2">
                                                    <span className="font-bold text-white text-lg">{recentAdd.playerName}</span>
                                                    <span className="px-2 py-0.5 rounded text-[10px] font-bold bg-slate-700 text-white/70">{recentAdd.position}</span>
                                                  </div>
                                                  <div className="text-xs text-white/50">
                                                    Picked up {new Date(recentAdd.timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                                  </div>
                                                  <div className="text-[10px] text-white/40 mt-1">Your highest-value waiver pickup</div>
                                                </div>
                                              </div>
                                            </div>
                                          )
                                        })()}
                                        
                                        {/* Worst Drop */}
                                        {waiverActivity.drops?.length > 0 && (() => {
                                          const recentDrop = waiverActivity.drops[0]
                                          return (
                                            <div className="p-4 rounded-xl bg-gradient-to-r from-rose-500/15 to-transparent border border-rose-500/30">
                                              <div className="flex items-center gap-2 mb-3">
                                                <span className="text-rose-400 text-lg">üóë</span>
                                                <span className="text-xs text-rose-400 uppercase tracking-wider font-semibold">Worst Drop</span>
                                              </div>
                                              <div className="flex items-center justify-between">
                                                <div>
                                                  <div className="flex items-center gap-2">
                                                    <span className="font-bold text-white text-lg">{recentDrop.playerName}</span>
                                                    <span className="px-2 py-0.5 rounded text-[10px] font-bold bg-slate-700 text-white/70">{recentDrop.position}</span>
                                                  </div>
                                                  <div className="text-xs text-white/50">
                                                    Dropped {new Date(recentDrop.timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                                  </div>
                                                  <div className="text-[10px] text-white/40 mt-1">Your most valuable drop no longer on your roster</div>
                                                </div>
                                              </div>
                                            </div>
                                          )
                                        })()}
                                        
                                        {/* Waiver Wire MVP */}
                                        {waiverMVP && waiverMVP.timesAdded >= 2 && (
                                          <div className="mt-6 p-5 rounded-xl bg-gradient-to-br from-amber-500/10 via-orange-500/10 to-yellow-500/10 border border-amber-500/30">
                                            <div className="flex items-center gap-2 mb-4">
                                              <span className="text-2xl">üèÜ</span>
                                              <div>
                                                <span className="text-sm font-bold text-transparent bg-clip-text bg-gradient-to-r from-amber-400 to-yellow-300 uppercase tracking-wider">League Waiver Wire MVP</span>
                                                <p className="text-[10px] text-white/40 mt-0.5">Most sought-after player on your league's waiver wire</p>
                                              </div>
                                            </div>
                                            
                                            <div className="flex items-center gap-4 mb-4">
                                              <div className="flex-shrink-0 w-16 h-16 rounded-xl bg-gradient-to-br from-amber-500/30 to-orange-500/30 flex items-center justify-center">
                                                <span className="text-3xl font-black text-amber-300">{waiverMVP.timesAdded}</span>
                                              </div>
                                              <div>
                                                <div className="flex items-center gap-2">
                                                  <span className="font-bold text-white text-xl">{waiverMVP.playerName}</span>
                                                  <span className="px-2 py-0.5 rounded text-[10px] font-bold bg-amber-500/30 text-amber-300">{waiverMVP.position}</span>
                                                  {waiverMVP.team && waiverMVP.team !== 'FA' && (
                                                    <span className="px-2 py-0.5 rounded text-[10px] font-medium bg-slate-700/70 text-white/60">{waiverMVP.team}</span>
                                                  )}
                                                </div>
                                                <div className="text-sm text-white/60 mt-1">
                                                  Added <span className="text-amber-400 font-semibold">{waiverMVP.timesAdded}x</span>
                                                  {waiverMVP.timesDropped > 0 && (
                                                    <span> &middot; Dropped <span className="text-rose-400 font-semibold">{waiverMVP.timesDropped}x</span></span>
                                                  )}
                                                </div>
                                              </div>
                                            </div>
                                            
                                            {/* Journey Timeline */}
                                            {waiverMVP.journey && waiverMVP.journey.length > 0 && (
                                              <div className="mt-4 pt-4 border-t border-amber-500/20">
                                                <div className="text-xs text-white/50 uppercase tracking-wider mb-3">Journey Through Your League</div>
                                                <div className="flex flex-wrap gap-2">
                                                  {waiverMVP.journey.slice(0, 10).map((event: any, idx: number) => (
                                                    <div 
                                                      key={idx} 
                                                      className={`px-2.5 py-1.5 rounded-lg text-xs flex items-center gap-1.5 ${
                                                        event.type === 'add' 
                                                          ? 'bg-emerald-500/20 text-emerald-300 border border-emerald-500/30' 
                                                          : 'bg-rose-500/20 text-rose-300 border border-rose-500/30'
                                                      }`}
                                                    >
                                                      <span className="font-semibold">{event.type === 'add' ? '+' : '-'}</span>
                                                      <span className="truncate max-w-[100px]">{event.teamName}</span>
                                                      <span className="text-white/40">{event.date}</span>
                                                    </div>
                                                  ))}
                                                  {waiverMVP.journey.length > 10 && (
                                                    <div className="px-2.5 py-1.5 rounded-lg text-xs bg-slate-700/50 text-white/50">
                                                      +{waiverMVP.journey.length - 10} more
                                                    </div>
                                                  )}
                                                </div>
                                              </div>
                                            )}
                                          </div>
                                        )}
                                      </div>
                                    )}
                                  </div>
                                )}
                              </div>

                              {/* SECTION 3: Trading Partners ‚Äî Enhanced */}
                              {tradeAnalytics?.tradingPartners?.all?.length > 0 && (
                                <div className="rounded-2xl bg-slate-900/80 border border-slate-700/50 p-6">
                                  <div className="flex items-center justify-center gap-2 mb-1">
                                    <span className="text-2xl">ü§ù</span>
                                    <h3 className="text-xl font-bold text-white">Trading Partners</h3>
                                  </div>
                                  <p className="text-sm text-white/40 text-center mb-6">Weighted by sample size ‚Äî more trades = more confidence</p>
                                  
                                  {/* Best Mark & Nemesis ‚Äî Enhanced */}
                                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-5">
                                    {tradeAnalytics?.tradingPartners?.bestMark && (
                                      <div className="p-5 rounded-2xl bg-gradient-to-br from-emerald-500/15 to-emerald-600/5 border border-emerald-500/30 relative overflow-hidden">
                                        <div className="absolute top-4 right-4 text-2xl">‚≠ê</div>
                                        <div className="text-xs text-emerald-400/80 uppercase tracking-widest font-semibold mb-3">Your Best Mark</div>
                                        <div className="font-bold text-white text-xl truncate mb-1">{tradeAnalytics.tradingPartners.bestMark.name}</div>
                                        <div className="flex items-baseline gap-2 mb-2">
                                          <span className="text-3xl font-black text-emerald-400">+{tradeAnalytics.tradingPartners.bestMark.netValue?.toLocaleString()}</span>
                                          <span className="text-xs text-white/40">net value</span>
                                        </div>
                                        <div className="flex items-center gap-3 text-xs text-white/50">
                                          <span>{tradeAnalytics.tradingPartners.bestMark.trades} trade{tradeAnalytics.tradingPartners.bestMark.trades !== 1 ? 's' : ''}</span>
                                          <span>¬∑</span>
                                          <span>Avg {tradeAnalytics.tradingPartners.bestMark.avgPerTrade >= 0 ? '+' : ''}{tradeAnalytics.tradingPartners.bestMark.avgPerTrade?.toLocaleString()}/trade</span>
                                        </div>
                                        {tradeAnalytics.tradingPartners.bestMark.styleMatch && (
                                          <div className="mt-3 pt-3 border-t border-emerald-500/20">
                                            <div className="flex items-center gap-2 mb-2">
                                              <span className="text-[10px] uppercase tracking-wider text-emerald-300/60 font-semibold">Style Match</span>
                                              <span className={`text-[10px] px-2 py-0.5 rounded-full font-medium ${
                                                tradeAnalytics.tradingPartners.bestMark.styleMatch.score >= 70 ? 'bg-emerald-500/20 text-emerald-300' :
                                                tradeAnalytics.tradingPartners.bestMark.styleMatch.score >= 40 ? 'bg-amber-500/20 text-amber-300' :
                                                'bg-slate-600/30 text-white/50'
                                              }`}>{tradeAnalytics.tradingPartners.bestMark.styleMatch.label}</span>
                                            </div>
                                            <div className="flex flex-wrap gap-1">
                                              {tradeAnalytics.tradingPartners.bestMark.styleMatch.drivers?.map((d: string, i: number) => (
                                                <span key={i} className="text-[10px] px-2 py-0.5 rounded-full bg-emerald-500/10 text-emerald-300/80 border border-emerald-500/20">{d}</span>
                                              ))}
                                            </div>
                                          </div>
                                        )}
                                      </div>
                                    )}
                                    {tradeAnalytics?.tradingPartners?.nemesis && (
                                      <div className="p-5 rounded-2xl bg-gradient-to-br from-rose-500/15 to-rose-600/5 border border-rose-500/30 relative overflow-hidden">
                                        <div className="absolute top-4 right-4 text-2xl">‚ò†Ô∏è</div>
                                        <div className="text-xs text-rose-400/80 uppercase tracking-widest font-semibold mb-3">Your Nemesis</div>
                                        <div className="font-bold text-white text-xl truncate mb-1">{tradeAnalytics.tradingPartners.nemesis.name}</div>
                                        <div className="flex items-baseline gap-2 mb-2">
                                          <span className="text-3xl font-black text-rose-400">{tradeAnalytics.tradingPartners.nemesis.netValue?.toLocaleString()}</span>
                                          <span className="text-xs text-white/40">net value</span>
                                        </div>
                                        <div className="flex items-center gap-3 text-xs text-white/50">
                                          <span>{tradeAnalytics.tradingPartners.nemesis.trades} trade{tradeAnalytics.tradingPartners.nemesis.trades !== 1 ? 's' : ''}</span>
                                          <span>¬∑</span>
                                          <span>Avg {tradeAnalytics.tradingPartners.nemesis.avgPerTrade >= 0 ? '+' : ''}{tradeAnalytics.tradingPartners.nemesis.avgPerTrade?.toLocaleString()}/trade</span>
                                        </div>
                                        {tradeAnalytics.tradingPartners.nemesis.styleMatch && (
                                          <div className="mt-3 pt-3 border-t border-rose-500/20">
                                            <div className="flex items-center gap-2 mb-2">
                                              <span className="text-[10px] uppercase tracking-wider text-rose-300/60 font-semibold">Style Match</span>
                                              <span className={`text-[10px] px-2 py-0.5 rounded-full font-medium ${
                                                tradeAnalytics.tradingPartners.nemesis.styleMatch.score >= 70 ? 'bg-emerald-500/20 text-emerald-300' :
                                                tradeAnalytics.tradingPartners.nemesis.styleMatch.score >= 40 ? 'bg-amber-500/20 text-amber-300' :
                                                'bg-slate-600/30 text-white/50'
                                              }`}>{tradeAnalytics.tradingPartners.nemesis.styleMatch.label}</span>
                                            </div>
                                            <div className="flex flex-wrap gap-1">
                                              {tradeAnalytics.tradingPartners.nemesis.styleMatch.drivers?.map((d: string, i: number) => (
                                                <span key={i} className="text-[10px] px-2 py-0.5 rounded-full bg-rose-500/10 text-rose-300/80 border border-rose-500/20">{d}</span>
                                              ))}
                                            </div>
                                          </div>
                                        )}
                                      </div>
                                    )}
                                  </div>
                                  
                                  {/* Partner List ‚Äî Expandable */}
                                  <div className="space-y-2 max-h-[500px] overflow-y-auto">
                                    {tradeAnalytics?.tradingPartners?.all?.map((partner: any, idx: number) => (
                                      <div key={idx} className="group">
                                        <div className={`p-3 rounded-xl flex items-center gap-3 ${
                                          partner.netValue > 300 ? 'bg-emerald-500/10 border border-emerald-500/20' :
                                          partner.netValue < -300 ? 'bg-rose-500/10 border border-rose-500/20' :
                                          'bg-slate-800/60 border border-slate-700/40'
                                        }`}>
                                          <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${
                                            idx === 0 ? 'bg-emerald-500 text-white' :
                                            idx === 1 ? 'bg-emerald-600/70 text-white' :
                                            idx === 2 ? 'bg-emerald-700/50 text-white' :
                                            idx >= (tradeAnalytics.tradingPartners.all.length - 2) ? 'bg-rose-600/70 text-white' :
                                            'bg-slate-700 text-white/70'
                                          }`}>
                                            {partner.rank}
                                          </div>
                                          <div className="flex-1 min-w-0">
                                            <div className="font-medium text-white truncate">{partner.name}</div>
                                            <div className="flex items-center gap-2 text-xs text-white/50">
                                              <span>{partner.trades} trade{partner.trades !== 1 ? 's' : ''}</span>
                                              {partner.styleMatch?.label && (
                                                <>
                                                  <span>¬∑</span>
                                                  <span className={`${
                                                    partner.styleMatch.score >= 70 ? 'text-emerald-400' :
                                                    partner.styleMatch.score >= 40 ? 'text-amber-400' :
                                                    'text-white/40'
                                                  }`}>{partner.styleMatch.label}</span>
                                                </>
                                              )}
                                            </div>
                                          </div>
                                          <div className="text-right">
                                            <div className={`font-bold ${partner.netValue >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                                              {partner.netValue >= 0 ? '+' : ''}{partner.netValue?.toLocaleString()}
                                            </div>
                                            <div className="text-[10px] text-white/40">
                                              avg {partner.avgPerTrade >= 0 ? '+' : ''}{partner.avgPerTrade?.toLocaleString()}/trade
                                            </div>
                                          </div>
                                          <div className={`w-10 h-10 rounded-lg flex items-center justify-center font-bold text-sm ${
                                            ['A+', 'A'].includes(partner.avgGrade) ? 'bg-emerald-500 text-white' :
                                            ['A-', 'B+'].includes(partner.avgGrade) ? 'bg-emerald-600/80 text-white' :
                                            ['B', 'B-'].includes(partner.avgGrade) ? 'bg-amber-500/80 text-white' :
                                            ['C+', 'C'].includes(partner.avgGrade) ? 'bg-amber-600/80 text-white' :
                                            ['C-', 'D+'].includes(partner.avgGrade) ? 'bg-orange-500 text-white' :
                                            'bg-rose-500 text-white'
                                          }`}>
                                            {partner.avgGrade}
                                          </div>
                                        </div>
                                        
                                        {/* Expandable "How to trade" panel */}
                                        {partner.styleMatch && (partner.styleMatch.insights?.length > 0 || partner.styleMatch.dealShapes?.length > 0) && (
                                          <details className="mt-0.5">
                                            <summary className="cursor-pointer px-4 py-2 text-xs text-purple-400 hover:text-purple-300 transition-colors font-medium flex items-center gap-1">
                                              <span>üéØ</span> How to trade with {partner.name.split(' ')[0]}
                                            </summary>
                                            <div className="px-4 pb-3 space-y-3 animate-in fade-in slide-in-from-top-1 duration-200">
                                              {/* Manager Profile Drivers */}
                                              {partner.styleMatch.drivers?.length > 0 && (
                                                <div>
                                                  <div className="text-[10px] uppercase tracking-wider text-white/40 font-semibold mb-1.5">Manager Profile</div>
                                                  <div className="flex flex-wrap gap-1.5">
                                                    {partner.styleMatch.drivers.map((d: string, i: number) => (
                                                      <span key={i} className="text-[11px] px-2.5 py-1 rounded-full bg-purple-500/15 text-purple-300 border border-purple-500/25">{d}</span>
                                                    ))}
                                                  </div>
                                                </div>
                                              )}
                                              
                                              {/* Scouting Report */}
                                              {partner.styleMatch.insights?.length > 0 && (
                                                <div>
                                                  <div className="text-[10px] uppercase tracking-wider text-white/40 font-semibold mb-1.5">Scouting Report</div>
                                                  <div className="space-y-1">
                                                    {partner.styleMatch.insights.map((insight: string, i: number) => (
                                                      <div key={i} className="text-xs text-white/60 flex items-start gap-2">
                                                        <span className="text-purple-400 mt-0.5">‚Ä¢</span>
                                                        <span>{insight}</span>
                                                      </div>
                                                    ))}
                                                  </div>
                                                </div>
                                              )}
                                              
                                              {/* Suggested Deal Shapes */}
                                              {partner.styleMatch.dealShapes?.length > 0 && (
                                                <div>
                                                  <div className="text-[10px] uppercase tracking-wider text-white/40 font-semibold mb-1.5">Suggested Approaches</div>
                                                  <div className="space-y-1.5">
                                                    {partner.styleMatch.dealShapes.map((deal: string, i: number) => (
                                                      <div key={i} className="text-xs p-2.5 rounded-lg bg-slate-800/60 border border-purple-500/15 text-white/70 flex items-start gap-2">
                                                        <span className="text-purple-400">{i === 0 ? '1Ô∏è‚É£' : '2Ô∏è‚É£'}</span>
                                                        <span>{deal}</span>
                                                      </div>
                                                    ))}
                                                  </div>
                                                </div>
                                              )}
                                            </div>
                                          </details>
                                        )}
                                      </div>
                                    ))}
                                  </div>
                                </div>
                              )}

                              {/* SECTION 4: Best & Worst Trade */}
                              {/* Valuation Mode Toggle */}
                              <div className="flex items-center justify-center gap-2 mb-6">
                                <span className="text-xs text-white/50">View trades:</span>
                                <button
                                  onClick={() => setValuationMode('atTime')}
                                  className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
                                    valuationMode === 'atTime'
                                      ? 'bg-blue-500 text-white shadow-lg shadow-blue-500/25'
                                      : 'bg-white/10 text-white/70 hover:bg-white/20'
                                  }`}
                                >
                                  At the Time
                                </button>
                                <button
                                  onClick={() => setValuationMode('hindsight')}
                                  className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
                                    valuationMode === 'hindsight'
                                      ? 'bg-purple-500 text-white shadow-lg shadow-purple-500/25'
                                      : 'bg-white/10 text-white/70 hover:bg-white/20'
                                  }`}
                                >
                                  With Hindsight
                                </button>
                              </div>

                              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {/* Best Trade */}
                                {tradeAnalytics?.bestTrade && (
                                  <div className="relative overflow-hidden rounded-2xl bg-gradient-to-br from-teal-950/80 to-emerald-950/80 border border-teal-500/30 p-6">
                                    <div className="absolute top-0 right-0 w-32 h-32 bg-teal-500/10 rounded-full blur-2xl" />
                                    <div className="relative z-10">
                                      <div className="text-xs text-teal-300/70 uppercase tracking-widest mb-2">Your Greatest Victory</div>
                                      <h4 className="text-xl font-bold text-white mb-1">Best Trade</h4>
                                      <p className="text-xs text-white/50 mb-4">{valuationMode === 'hindsight' ? 'With Hindsight' : 'At the Time'}</p>
                                      <div className="text-4xl sm:text-5xl font-bold text-teal-400 mb-2">
                                        +{tradeAnalytics.bestTrade.value?.toLocaleString()}
                                      </div>
                                      <div className="text-sm text-white/50 mb-1">dynasty value gained</div>
                                      <div className="flex items-center gap-2 text-sm text-white/60 mb-4">
                                        <span className="w-4 border-t border-white/20"></span>
                                        <span>vs {tradeAnalytics.bestTrade.opponent}</span>
                                      </div>
                                      <div className="text-xs text-white/40">{tradeAnalytics.bestTrade.date}</div>
                                    </div>
                                  </div>
                                )}
                                
                                {/* Worst Trade */}
                                {tradeAnalytics?.worstTrade && (
                                  <div className="relative overflow-hidden rounded-2xl bg-gradient-to-br from-rose-950/80 to-pink-950/80 border border-rose-500/30 p-6">
                                    <div className="absolute top-0 right-0 w-32 h-32 bg-rose-500/10 rounded-full blur-2xl" />
                                    <div className="relative z-10">
                                      <div className="text-xs text-rose-300/70 uppercase tracking-widest mb-2">Your Biggest Regret</div>
                                      <h4 className="text-xl font-bold text-white mb-1">Worst Trade</h4>
                                      <p className="text-xs text-white/50 mb-4">{valuationMode === 'hindsight' ? 'With Hindsight' : 'At the Time'}</p>
                                      <div className="text-4xl sm:text-5xl font-bold text-rose-400 mb-2">
                                        {tradeAnalytics.worstTrade.value?.toLocaleString()}
                                      </div>
                                      <div className="text-sm text-white/50 mb-1">dynasty value lost</div>
                                      <div className="flex items-center gap-2 text-sm text-white/60 mb-4">
                                        <span className="w-4 border-t border-white/20"></span>
                                        <span>vs {tradeAnalytics.worstTrade.opponent}</span>
                                      </div>
                                      <div className="text-xs text-white/40">{tradeAnalytics.worstTrade.date}</div>
                                    </div>
                                  </div>
                                )}
                              </div>

                              {/* SECTION 5: Data-Driven League Awards */}
                              {tradeAnalytics?.leagueAwards && (() => {
                                const awards = tradeAnalytics.leagueAwards;

                                const awardCards: React.ReactNode[] = [];

                                if (awards.bestNegotiator) {
                                  awardCards.push(
                                    <div key="bestNegotiator" className="p-5 rounded-2xl bg-gradient-to-br from-blue-900/30 to-slate-900/50 border border-blue-500/30 relative overflow-hidden">
                                      <div className="absolute top-3 right-3 text-3xl opacity-30">üß†</div>
                                      <div className="text-3xl mb-2">üß†</div>
                                      <h4 className="text-lg font-bold text-blue-300">Best Negotiator</h4>
                                      <p className="text-[11px] text-white/40 mb-4">Highest win rate at lowest overpay</p>
                                      <div className="text-[10px] text-blue-300/50 uppercase tracking-wider mb-0.5">Your best target</div>
                                      <div className="text-xl font-bold text-white truncate mb-3">{awards.bestNegotiator.name}</div>
                                      <div className="grid grid-cols-2 gap-2 mb-3">
                                        <div className="p-2 rounded-lg bg-blue-500/10">
                                          <div className="text-[10px] text-blue-300/60 uppercase">Win Rate</div>
                                          <div className="text-lg font-bold text-blue-300">{awards.bestNegotiator.winRate}%</div>
                                        </div>
                                        <div className="p-2 rounded-lg bg-blue-500/10">
                                          <div className="text-[10px] text-blue-300/60 uppercase">Avg Overpay</div>
                                          <div className="text-lg font-bold text-blue-300">{awards.bestNegotiator.avgOverpay === 0 ? 'None' : awards.bestNegotiator.avgOverpay}</div>
                                        </div>
                                      </div>
                                      <div className="text-[10px] text-white/30 border-t border-blue-500/15 pt-2">{awards.bestNegotiator.method}</div>
                                    </div>
                                  );
                                }

                                if (awards.marketSniper) {
                                  awardCards.push(
                                    <div key="marketSniper" className="p-5 rounded-2xl bg-gradient-to-br from-emerald-900/30 to-slate-900/50 border border-emerald-500/30 relative overflow-hidden">
                                      <div className="absolute top-3 right-3 text-3xl opacity-30">üéØ</div>
                                      <div className="text-3xl mb-2">üéØ</div>
                                      <h4 className="text-lg font-bold text-emerald-300">Market Sniper</h4>
                                      <p className="text-[11px] text-white/40 mb-4">Best timing vs market shifts</p>
                                      <div className="text-xl font-bold text-white truncate mb-3">{awards.marketSniper.name}</div>
                                      <div className="grid grid-cols-2 gap-2 mb-3">
                                        <div className="p-2 rounded-lg bg-emerald-500/10">
                                          <div className="text-[10px] text-emerald-300/60 uppercase">Avg Market Gain</div>
                                          <div className="text-lg font-bold text-emerald-300">{awards.marketSniper.avgShift >= 0 ? '+' : ''}{awards.marketSniper.avgShift}</div>
                                        </div>
                                        <div className="p-2 rounded-lg bg-emerald-500/10">
                                          <div className="text-[10px] text-emerald-300/60 uppercase">Best Single</div>
                                          <div className="text-lg font-bold text-emerald-300">{awards.marketSniper.bestShift >= 0 ? '+' : ''}{awards.marketSniper.bestShift}</div>
                                        </div>
                                      </div>
                                      <div className="text-[10px] text-white/30 border-t border-emerald-500/15 pt-2">{awards.marketSniper.method}</div>
                                    </div>
                                  );
                                }

                                if (awards.starterBuilder) {
                                  awardCards.push(
                                    <div key="starterBuilder" className="p-5 rounded-2xl bg-gradient-to-br from-amber-900/30 to-slate-900/50 border border-amber-500/30 relative overflow-hidden">
                                      <div className="absolute top-3 right-3 text-3xl opacity-30">üìà</div>
                                      <div className="text-3xl mb-2">üìà</div>
                                      <h4 className="text-lg font-bold text-amber-300">Starter Builder</h4>
                                      <p className="text-[11px] text-white/40 mb-4">Most net starting PPG gained</p>
                                      <div className="text-xl font-bold text-white truncate mb-3">{awards.starterBuilder.name}</div>
                                      <div className="grid grid-cols-2 gap-2 mb-3">
                                        <div className="p-2 rounded-lg bg-amber-500/10">
                                          <div className="text-[10px] text-amber-300/60 uppercase">Net PPG</div>
                                          <div className="text-lg font-bold text-amber-300">{awards.starterBuilder.netPPG >= 0 ? '+' : ''}{awards.starterBuilder.netPPG}</div>
                                        </div>
                                        <div className="p-2 rounded-lg bg-amber-500/10">
                                          <div className="text-[10px] text-amber-300/60 uppercase">Per Trade</div>
                                          <div className="text-lg font-bold text-amber-300">{awards.starterBuilder.ppgPerTrade >= 0 ? '+' : ''}{awards.starterBuilder.ppgPerTrade}</div>
                                        </div>
                                      </div>
                                      <div className="text-[10px] text-white/30 border-t border-amber-500/15 pt-2">{awards.starterBuilder.method}</div>
                                    </div>
                                  );
                                }

                                if (awards.riskKing) {
                                  awardCards.push(
                                    <div key="riskKing" className="p-5 rounded-2xl bg-gradient-to-br from-red-900/30 to-slate-900/50 border border-red-500/30 relative overflow-hidden">
                                      <div className="absolute top-3 right-3 text-3xl opacity-30">üé≤</div>
                                      <div className="text-3xl mb-2">üé≤</div>
                                      <h4 className="text-lg font-bold text-red-300">Risk King</h4>
                                      <p className="text-[11px] text-white/40 mb-4">Highest volatility profit (long-term winner)</p>
                                      <div className="text-xl font-bold text-white truncate mb-3">{awards.riskKing.name}</div>
                                      <div className="grid grid-cols-2 gap-2 mb-3">
                                        <div className="p-2 rounded-lg bg-red-500/10">
                                          <div className="text-[10px] text-red-300/60 uppercase">Volatility</div>
                                          <div className="text-lg font-bold text-red-300">{awards.riskKing.volatility?.toLocaleString()}</div>
                                        </div>
                                        <div className="p-2 rounded-lg bg-red-500/10">
                                          <div className="text-[10px] text-red-300/60 uppercase">Net Profit</div>
                                          <div className="text-lg font-bold text-emerald-400">+{awards.riskKing.netProfit?.toLocaleString()}</div>
                                        </div>
                                      </div>
                                      <div className="text-[10px] text-white/30 border-t border-red-500/15 pt-2">{awards.riskKing.method}</div>
                                    </div>
                                  );
                                }

                                if (awards.theFleecer) {
                                  awardCards.push(
                                    <div key="theFleecer" className="p-5 rounded-2xl bg-gradient-to-br from-purple-900/30 to-slate-900/50 border border-purple-500/30 relative overflow-hidden">
                                      <div className="absolute top-3 right-3 text-3xl opacity-30">ü¶ä</div>
                                      <div className="text-3xl mb-2">ü¶ä</div>
                                      <h4 className="text-lg font-bold text-purple-300">The Fleecer</h4>
                                      <p className="text-[11px] text-white/40 mb-4">Highest avg fairness delta (high confidence only)</p>
                                      <div className="text-xl font-bold text-white truncate mb-3">{awards.theFleecer.name}</div>
                                      <div className="grid grid-cols-2 gap-2 mb-3">
                                        <div className="p-2 rounded-lg bg-purple-500/10">
                                          <div className="text-[10px] text-purple-300/60 uppercase">Avg Delta</div>
                                          <div className="text-lg font-bold text-purple-300">{awards.theFleecer.avgFairnessDelta >= 0 ? '+' : ''}{awards.theFleecer.avgFairnessDelta?.toLocaleString()}</div>
                                        </div>
                                        <div className="p-2 rounded-lg bg-purple-500/10">
                                          <div className="text-[10px] text-purple-300/60 uppercase">High-Conf Trades</div>
                                          <div className="text-lg font-bold text-purple-300">{awards.theFleecer.highConfCount}</div>
                                        </div>
                                      </div>
                                      <div className="text-[10px] text-white/30 border-t border-purple-500/15 pt-2">{awards.theFleecer.method}</div>
                                    </div>
                                  );
                                }

                                if (awardCards.length === 0) return null;

                                return (
                                  <div className="rounded-2xl bg-slate-900/80 border border-slate-700/50 p-6">
                                    <div className="flex items-center justify-center gap-2 mb-1">
                                      <span className="text-2xl">üèÜ</span>
                                      <h3 className="text-xl font-bold text-white">League Awards</h3>
                                    </div>
                                    <p className="text-sm text-white/40 text-center mb-6">Your trading performance ‚Äî every award backed by real metrics</p>
                                    
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                      {awardCards}
                                    </div>
                                  </div>
                                );
                              })()}

                              {/* SECTION 6: All Trades ‚Äî Sort + Expandable Drivers */}
                              {tradeAnalytics?.allTrades?.length > 0 && (
                                <div className="rounded-2xl bg-slate-900/80 border border-slate-700/50 p-6">
                                  <div className="flex items-center justify-center gap-2 mb-1">
                                    <span className="text-2xl">üìã</span>
                                    <h3 className="text-xl font-bold text-white">All Trades</h3>
                                  </div>
                                  <p className="text-sm text-white/40 text-center mb-4">{tradeAnalytics.allTrades.length} trades analyzed ‚Äî expand any row to see drivers</p>
                                  
                                  {/* Filter Buttons */}
                                  <div className="flex flex-wrap justify-center gap-2 mb-3">
                                    {([
                                      ['all', 'All', tradeAnalytics.allTrades.length, 'purple'] as const,
                                      ['wins', 'Wins', tradeAnalytics.allTrades.filter((t: any) => t.netValue > 300).length, 'emerald'] as const,
                                      ['losses', 'Losses', tradeAnalytics.allTrades.filter((t: any) => t.netValue < -300).length, 'rose'] as const,
                                      ['even', 'Even', tradeAnalytics.allTrades.filter((t: any) => t.netValue >= -300 && t.netValue <= 300).length, 'slate'] as const,
                                    ] as const).map(([key, label, count, color]) => (
                                      <button
                                        key={key}
                                        onClick={() => setTradeFilter(key)}
                                        className={`px-3 py-1.5 rounded-lg text-xs font-medium transition ${
                                          tradeFilter === key
                                            ? `bg-${color}-500 text-white`
                                            : 'bg-slate-800 text-white/60 hover:bg-slate-700'
                                        }`}
                                        style={tradeFilter === key ? {
                                          backgroundColor: color === 'purple' ? '#a855f7' : color === 'emerald' ? '#10b981' : color === 'rose' ? '#f43f5e' : '#64748b'
                                        } : {}}
                                      >
                                        {label} ({count})
                                      </button>
                                    ))}
                                  </div>

                                  {/* Sort Toggles */}
                                  <div className="flex flex-wrap justify-center gap-1.5 mb-5">
                                    <span className="text-[10px] text-white/30 uppercase tracking-wider self-center mr-1">Sort:</span>
                                    {([
                                      ['recent', 'Recent'],
                                      ['impactful', 'Most Impactful'],
                                      ['controversial', 'Most Controversial'],
                                      ['marketShift', 'Biggest Market Shift'],
                                    ] as const).map(([key, label]) => (
                                      <button
                                        key={key}
                                        onClick={() => setTradeSort(key)}
                                        className={`px-2.5 py-1 rounded-full text-[11px] font-medium transition ${
                                          tradeSort === key
                                            ? 'bg-purple-500/30 text-purple-300 border border-purple-500/50'
                                            : 'bg-slate-800/60 text-white/40 border border-slate-700/30 hover:text-white/60'
                                        }`}
                                      >
                                        {label}
                                      </button>
                                    ))}
                                  </div>
                                  
                                  <div className="space-y-1.5 max-h-[600px] overflow-y-auto">
                                    {tradeAnalytics.allTrades
                                      .filter((trade: any) => {
                                        if (tradeFilter === 'wins') return trade.netValue > 300
                                        if (tradeFilter === 'losses') return trade.netValue < -300
                                        if (tradeFilter === 'even') return trade.netValue >= -300 && trade.netValue <= 300
                                        return true
                                      })
                                      .sort((a: any, b: any) => {
                                        if (tradeSort === 'impactful') return Math.abs(b.netValue) - Math.abs(a.netValue)
                                        if (tradeSort === 'controversial') return (b.controversyScore || 0) - (a.controversyScore || 0)
                                        if (tradeSort === 'marketShift') return Math.abs(b.marketShift || 0) - Math.abs(a.marketShift || 0)
                                        return (b.timestamp || 0) - (a.timestamp || 0)
                                      })
                                      .map((trade: any, idx: number) => (
                                      <details key={trade.id || idx} className="group">
                                        <summary className={`p-3 rounded-xl flex items-center gap-3 cursor-pointer list-none ${
                                          ['A+', 'A', 'A-'].includes(trade.grade) ? 'bg-emerald-500/10 border border-emerald-500/20' :
                                          ['D', 'D-', 'F'].includes(trade.grade) ? 'bg-rose-500/10 border border-rose-500/20' :
                                          'bg-slate-800/60 border border-slate-700/40'
                                        } hover:bg-slate-800/80 transition`}>
                                          <div className={`w-10 h-10 rounded-lg flex items-center justify-center font-bold text-sm flex-shrink-0 ${
                                            ['A+', 'A'].includes(trade.grade) ? 'bg-emerald-500 text-white' :
                                            ['A-', 'B+'].includes(trade.grade) ? 'bg-emerald-600/80 text-white' :
                                            ['B', 'B-'].includes(trade.grade) ? 'bg-amber-500/80 text-white' :
                                            ['C+', 'C'].includes(trade.grade) ? 'bg-amber-600/80 text-white' :
                                            ['C-', 'D+'].includes(trade.grade) ? 'bg-orange-500 text-white' :
                                            'bg-rose-500 text-white'
                                          }`}>
                                            {trade.grade}
                                          </div>
                                          <div className="flex-1 min-w-0">
                                            <div className="font-medium text-white">vs {trade.opponent}</div>
                                            <div className="flex items-center gap-2 text-xs text-white/50">
                                              <span>{trade.date}</span>
                                              <span>‚Ä¢</span>
                                              <span>{trade.playersOut} out / {trade.playersIn} in</span>
                                              {trade.marketShift !== 0 && (
                                                <>
                                                  <span>‚Ä¢</span>
                                                  <span className={trade.marketShift > 0 ? 'text-emerald-400' : 'text-rose-400'}>
                                                    {trade.marketShift > 0 ? '‚Üë' : '‚Üì'}{Math.abs(trade.marketShift)} shift
                                                  </span>
                                                </>
                                              )}
                                            </div>
                                          </div>
                                          <div className="text-right flex-shrink-0">
                                            <div className={`font-bold ${trade.netValue >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                                              {trade.netValue >= 0 ? '+' : ''}{trade.netValue?.toLocaleString()}
                                            </div>
                                            <div className="text-[10px] text-white/40">net value</div>
                                          </div>
                                          <div className="text-white/30 group-open:rotate-180 transition-transform flex-shrink-0">‚ñº</div>
                                        </summary>
                                        
                                        {/* Expanded Driver Panel */}
                                        <div className="mx-2 mb-2 mt-0.5 p-4 rounded-xl bg-slate-950/60 border border-slate-700/30 space-y-4 animate-in fade-in slide-in-from-top-1 duration-200">
                                          {/* Grade Comparison Row */}
                                          <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-3">
                                              <div className="text-center">
                                                <div className="text-[10px] text-white/40 uppercase">At Time</div>
                                                <div className={`text-lg font-bold ${
                                                  ['A+', 'A', 'A-', 'B+'].includes(trade.atTimeGrade) ? 'text-emerald-400' :
                                                  ['D', 'D-', 'F'].includes(trade.atTimeGrade) ? 'text-rose-400' : 'text-amber-400'
                                                }`}>{trade.atTimeGrade}</div>
                                              </div>
                                              <div className="text-white/30">‚Üí</div>
                                              <div className="text-center">
                                                <div className="text-[10px] text-white/40 uppercase">Now</div>
                                                <div className={`text-lg font-bold ${
                                                  ['A+', 'A', 'A-', 'B+'].includes(trade.hindsightGrade) ? 'text-emerald-400' :
                                                  ['D', 'D-', 'F'].includes(trade.hindsightGrade) ? 'text-rose-400' : 'text-amber-400'
                                                }`}>{trade.hindsightGrade}</div>
                                              </div>
                                            </div>
                                            {trade.comparison && (
                                              <div className="text-xs text-white/50 text-right max-w-[60%]">{trade.comparison}</div>
                                            )}
                                          </div>

                                          {/* Metric Summary */}
                                          <div className="grid grid-cols-4 gap-2">
                                            <div className="p-2 rounded-lg bg-slate-800/60 text-center">
                                              <div className="text-[9px] text-white/40 uppercase">At-Time</div>
                                              <div className={`text-sm font-bold ${trade.atTimeDelta >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                                                {trade.atTimeDelta >= 0 ? '+' : ''}{trade.atTimeDelta?.toLocaleString()}
                                              </div>
                                            </div>
                                            <div className="p-2 rounded-lg bg-slate-800/60 text-center">
                                              <div className="text-[9px] text-white/40 uppercase">Hindsight</div>
                                              <div className={`text-sm font-bold ${trade.hindsightDelta >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                                                {trade.hindsightDelta >= 0 ? '+' : ''}{trade.hindsightDelta?.toLocaleString()}
                                              </div>
                                            </div>
                                            <div className="p-2 rounded-lg bg-slate-800/60 text-center">
                                              <div className="text-[9px] text-white/40 uppercase">Mkt Shift</div>
                                              <div className={`text-sm font-bold ${trade.marketShift >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                                                {trade.marketShift >= 0 ? '+' : ''}{trade.marketShift?.toLocaleString()}
                                              </div>
                                            </div>
                                            <div className="p-2 rounded-lg bg-slate-800/60 text-center">
                                              <div className="text-[9px] text-white/40 uppercase">Confidence</div>
                                              <div className="text-sm font-bold text-purple-300">{trade.confidence}%</div>
                                            </div>
                                          </div>

                                          {/* Asset Drivers ‚Äî You Received */}
                                          {trade.drivers?.received?.length > 0 && (
                                            <div>
                                              <div className="flex items-center justify-between mb-2">
                                                <div className="text-[10px] text-emerald-400/70 uppercase tracking-wider font-semibold">You Received</div>
                                                <div className="text-[10px] text-white/30">Total: {trade.drivers.receivedTotal?.toLocaleString()}</div>
                                              </div>
                                              <div className="space-y-1">
                                                {trade.drivers.received.map((asset: any, ai: number) => (
                                                  <div key={ai} className="flex items-center gap-2 p-2 rounded-lg bg-emerald-500/5 border border-emerald-500/10">
                                                    <MiniPlayerImg sleeperId={asset.id} name={asset.name} size={18} />
                                                    <div className="flex-1 min-w-0">
                                                      <div className="flex items-center gap-1.5">
                                                        <span className="text-xs font-medium text-white truncate">{asset.name}</span>
                                                        {asset.position && <span className="text-[9px] px-1.5 py-0.5 rounded bg-slate-700/50 text-white/50">{asset.position}</span>}
                                                        <span className="text-[9px] px-1.5 py-0.5 rounded bg-slate-700/30 text-white/30">{asset.source}</span>
                                                      </div>
                                                    </div>
                                                    <div className="flex items-center gap-3 text-[10px] flex-shrink-0">
                                                      <div className="text-center">
                                                        <div className="text-white/30">MKT</div>
                                                        <div className="text-white/70 font-mono">{asset.market}</div>
                                                      </div>
                                                      <div className="text-center">
                                                        <div className="text-white/30">IMP</div>
                                                        <div className="text-blue-300/80 font-mono">{asset.impact}</div>
                                                      </div>
                                                      <div className="text-center">
                                                        <div className="text-white/30">VORP</div>
                                                        <div className="text-purple-300/80 font-mono">{asset.vorp}</div>
                                                      </div>
                                                      <div className="text-center">
                                                        <div className="text-white/30">VOL</div>
                                                        <div className={`font-mono ${asset.volatility > 0.5 ? 'text-amber-400' : 'text-white/50'}`}>{asset.volatility?.toFixed(2)}</div>
                                                      </div>
                                                    </div>
                                                  </div>
                                                ))}
                                              </div>
                                            </div>
                                          )}

                                          {/* Asset Drivers ‚Äî You Gave */}
                                          {trade.drivers?.gave?.length > 0 && (
                                            <div>
                                              <div className="flex items-center justify-between mb-2">
                                                <div className="text-[10px] text-rose-400/70 uppercase tracking-wider font-semibold">You Gave</div>
                                                <div className="text-[10px] text-white/30">Total: {trade.drivers.gaveTotal?.toLocaleString()}</div>
                                              </div>
                                              <div className="space-y-1">
                                                {trade.drivers.gave.map((asset: any, ai: number) => (
                                                  <div key={ai} className="flex items-center gap-2 p-2 rounded-lg bg-rose-500/5 border border-rose-500/10">
                                                    <MiniPlayerImg sleeperId={asset.id} name={asset.name} size={18} />
                                                    <div className="flex-1 min-w-0">
                                                      <div className="flex items-center gap-1.5">
                                                        <span className="text-xs font-medium text-white truncate">{asset.name}</span>
                                                        {asset.position && <span className="text-[9px] px-1.5 py-0.5 rounded bg-slate-700/50 text-white/50">{asset.position}</span>}
                                                        <span className="text-[9px] px-1.5 py-0.5 rounded bg-slate-700/30 text-white/30">{asset.source}</span>
                                                      </div>
                                                    </div>
                                                    <div className="flex items-center gap-3 text-[10px] flex-shrink-0">
                                                      <div className="text-center">
                                                        <div className="text-white/30">MKT</div>
                                                        <div className="text-white/70 font-mono">{asset.market}</div>
                                                      </div>
                                                      <div className="text-center">
                                                        <div className="text-white/30">IMP</div>
                                                        <div className="text-blue-300/80 font-mono">{asset.impact}</div>
                                                      </div>
                                                      <div className="text-center">
                                                        <div className="text-white/30">VORP</div>
                                                        <div className="text-purple-300/80 font-mono">{asset.vorp}</div>
                                                      </div>
                                                      <div className="text-center">
                                                        <div className="text-white/30">VOL</div>
                                                        <div className={`font-mono ${asset.volatility > 0.5 ? 'text-amber-400' : 'text-white/50'}`}>{asset.volatility?.toFixed(2)}</div>
                                                      </div>
                                                    </div>
                                                  </div>
                                                ))}
                                              </div>
                                            </div>
                                          )}

                                          {/* Verdict */}
                                          {trade.verdict && (
                                            <div className="text-xs text-white/40 pt-2 border-t border-slate-700/30 italic">
                                              {trade.verdict}
                                            </div>
                                          )}
                                        </div>
                                      </details>
                                    ))}
                                  </div>
                                </div>
                              )}

                              {/* Original Trades By Year (collapsed) */}
                              <details className="rounded-2xl bg-slate-900/80 border border-slate-700/50 overflow-hidden">
                                <summary className="p-4 cursor-pointer hover:bg-slate-800/50 transition flex items-center justify-between">
                                  <span className="font-medium text-white">Trades By Season</span>
                                  <span className="text-white/50 text-sm">{Object.keys(reportCardTradesByYear).length} seasons</span>
                                </summary>
                                <div className="p-4 pt-0 space-y-4 max-h-[400px] overflow-y-auto">
                                  {Object.entries(reportCardTradesByYear)
                                    .sort(([a], [b]) => parseInt(b) - parseInt(a))
                                    .map(([year, trades]) => (
                                      <div key={year}>
                                        <h4 className="text-sm font-medium text-white/70 mb-2 flex items-center gap-2">
                                          <span className="px-2 py-0.5 rounded bg-purple-500/20 text-purple-300 text-xs font-bold">{year}</span>
                                          <span className="text-white/40 text-xs">{trades.length} trade{trades.length !== 1 ? 's' : ''}</span>
                                        </h4>
                                        <div className="space-y-2">
                                          {trades.map((trade: any, idx: number) => (
                                            <div key={trade.transactionId || idx} className="p-3 rounded-xl bg-black/30 border border-white/10">
                                              <div className="flex items-center justify-between gap-3">
                                                <div className="flex-1 min-w-0">
                                                  <div className="flex items-center gap-2 mb-1">
                                                    <span className={`px-2 py-0.5 rounded text-xs font-bold ${
                                                      ['A+', 'A', 'A-', 'B+'].includes(trade.grade) ? 'bg-emerald-500/20 text-emerald-400' :
                                                      ['D', 'F'].includes(trade.grade) ? 'bg-rose-500/20 text-rose-400' :
                                                      'bg-amber-500/20 text-amber-400'
                                                    }`}>
                                                      {trade.grade}
                                                    </span>
                                                    <span className="text-xs text-white/40">
                                                      Week {trade.week} ‚Ä¢ {new Date(trade.timestamp).toLocaleDateString()}
                                                    </span>
                                                  </div>
                                                  <div className="text-xs text-white/60 line-clamp-2">
                                                    {trade.parties?.map((p: any) => 
                                                      p.playersReceived?.map((player: any) => player.name).join(', ')
                                                    ).filter(Boolean).join(' ‚Üî ') || 'Trade details'}
                                                  </div>
                                                  {trade.verdict && (
                                                    <div className="text-xs text-white/40 mt-1 line-clamp-1">{trade.verdict}</div>
                                                  )}
                                                  {/* What I Should've Done Instead */}
                                                  <TradeAlternatives
                                                    trade={{
                                                      transactionId: trade.transactionId,
                                                      timestamp: trade.timestamp,
                                                      week: trade.week,
                                                      parties: trade.parties || []
                                                    }}
                                                    userId={profile?.sleeper_user_id || username || ''}
                                                    isSuperFlex={leagues.find(l => l.league_id === reportCardLeague)?.is_sf === true}
                                                  />
                                                </div>
                                              </div>
                                            </div>
                                          ))}
                                        </div>
                                      </div>
                                    ))}
                                </div>
                              </details>
                            </div>
                          )}
                          
                          {/* Initial State */}
                          {!reportCardLeague && !reportCardLoading && (
                            <div className="text-center py-4 text-white/40 text-sm">
                              Select a league above to generate your trade report card
                            </div>
                          )}
                        </div>
                      </div>
                    )}

                    {/* Loading State */}
                    {inlineTradeLoading && (
                      <div className="relative rounded-3xl bg-gradient-to-br from-slate-900/95 via-purple-900/20 to-slate-900/95 border border-purple-500/30 overflow-hidden">
                        <div className="h-1.5 bg-gradient-to-r from-purple-500 via-cyan-400 to-purple-500 animate-pulse" />
                        <div className="p-8 sm:p-12 text-center">
                          <div className="w-16 h-16 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-purple-500/30 to-cyan-500/30 flex items-center justify-center">
                            <span className="text-3xl animate-bounce">‚öñÔ∏è</span>
                          </div>
                          <h3 className="text-lg font-semibold text-white mb-2">Generating Trade Report<span className="animate-pulse">...</span></h3>
                          <p className="text-sm text-white/50">Analyzing values, context, and fairness</p>
                          <div className="mt-4 flex justify-center gap-1">
                            {['Values', 'Context', 'Fairness'].map((step, idx) => (
                              <span key={idx} className="px-3 py-1 rounded-full bg-purple-500/20 text-purple-300 text-xs animate-pulse" style={{ animationDelay: `${idx * 200}ms` }}>
                                {step}
                              </span>
                            ))}
                          </div>
                        </div>
                      </div>
                    )}

                    {activeTradeLeagueId && (
                      <ExploitMyLeague
                        leagueId={activeTradeLeagueId}
                        teams={tradeHubManagers.map((m: any) => ({
                          username: m.username || m.displayName || null,
                          rosterId: m.rosterId,
                          rosterExposure: m.rosterExposure || {},
                        }))}
                      />
                    )}

                    {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                        TRADE HUB - Dropdown-Based Trade Builder
                    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
                    <div className="rounded-2xl bg-black/30 border border-white/10 overflow-hidden">
                      <div className="p-4 sm:p-6 border-b border-white/5">
                        <div className="flex items-center justify-between flex-wrap gap-3">
                          <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500/30 to-cyan-500/30 flex items-center justify-center text-xl">‚öñÔ∏è</div>
                            <div>
                              <h3 className="text-lg font-bold text-white">Trade Hub</h3>
                              <p className="text-xs text-white/50">Build trades with real roster data</p>
                            </div>
                          </div>
                          
                          {/* Control Pills */}
                          <div className="flex flex-wrap items-center gap-2">
                            {/* Format Toggle */}
                            <div className="flex rounded-lg overflow-hidden border border-white/20">
                              <button
                                onClick={() => setInlineTradeFormat('dynasty')}
                                className={`px-3 py-1.5 text-xs font-medium transition ${
                                  inlineTradeFormat === 'dynasty'
                                    ? 'bg-purple-500/40 text-purple-200'
                                    : 'bg-black/30 text-white/50 hover:text-white'
                                }`}
                              >
                                Dynasty
                              </button>
                              <button
                                onClick={() => setInlineTradeFormat('redraft')}
                                className={`px-3 py-1.5 text-xs font-medium transition ${
                                  inlineTradeFormat === 'redraft'
                                    ? 'bg-cyan-500/40 text-cyan-200'
                                    : 'bg-black/30 text-white/50 hover:text-white'
                                }`}
                              >
                                Redraft
                              </button>
                            </div>

                            {!activeTradeLeagueId && (
                              <select
                                value={manualNumTeams}
                                onChange={(e) => setManualNumTeams(Number(e.target.value) as LeagueSize)}
                                className="rounded-lg bg-black/30 border border-white/20 px-2 py-1.5 text-xs text-white focus:outline-none"
                              >
                                {LEAGUE_SIZES.map((n) => (
                                  <option key={n} value={n}>
                                    {n} teams
                                  </option>
                                ))}
                              </select>
                            )}
                          </div>
                        </div>
                      </div>

                      <div className="p-4 sm:p-6">
                        {effectiveNumTeams >= 24 && (
                          <div className="mb-4 p-3 rounded-xl bg-amber-500/10 border border-amber-500/20 text-xs text-amber-200/90">
                            {effectiveNumTeams}-team note: scarcity is extreme. Starters + secure roles are worth much more than in 12-team.
                          </div>
                        )}
                        {/* ‚úÖ League is controlled by the Trade History Report Card */}
                        <div className="mb-6">
                          <label className="block text-xs font-medium text-white/60 mb-2">League</label>

                          {!activeTradeLeagueId ? (
                            <div className="p-3 rounded-xl bg-white/5 border border-white/10 text-sm text-white/60">
                              Select a league in <span className="text-white/80 font-medium">Trade History Report Card</span> to unlock Trade Hub.
                            </div>
                          ) : (
                            <div className="flex items-center justify-between gap-3">
                              <div>
                                <div className="text-xs font-medium text-white/60">League</div>
                                <div className="text-sm text-white">
                                  {leagues.find(l => l.league_id === activeTradeLeagueId)?.name || "‚Äî"}
                                  <span className="ml-2 text-xs text-white/50">({effectiveNumTeams} teams)</span>
                                </div>
                              </div>

                              <button
                                type="button"
                                onClick={() => activeTradeLeagueId && loadTradeHubManagers(activeTradeLeagueId)}
                                disabled={!activeTradeLeagueId}
                                className="px-3 py-1.5 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 text-white/70 text-xs transition disabled:opacity-50"
                              >
                                Refresh
                              </button>
                            </div>
                          )}
                        </div>

                        {/* Trade Goal Selector */}
                        {activeTradeLeagueId && (
                          <div className="mb-6">
                            <label className="block text-xs font-medium text-white/60 mb-2">Trade Goal</label>
                            <div className="flex flex-wrap gap-2">
                              {[
                                { id: 'win_now', label: 'Win Now', icon: 'üèÜ' },
                                { id: 'rebuild', label: 'Rebuild', icon: 'üî®' },
                                { id: 'consolidate', label: 'Consolidate', icon: 'üì¶' },
                                { id: 'add_depth', label: 'Add Depth', icon: 'üìä' },
                                { id: 'acquire_picks', label: 'Acquire Picks', icon: 'üéØ' },
                              ].map((goal) => (
                                <button
                                  key={goal.id}
                                  onClick={() => setTradeHubGoal(tradeHubGoal === goal.id ? '' : goal.id)}
                                  className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${
                                    tradeHubGoal === goal.id
                                      ? 'bg-gradient-to-r from-purple-500 to-cyan-500 text-white'
                                      : 'bg-white/5 border border-white/10 text-white/60 hover:bg-white/10 hover:text-white'
                                  }`}
                                >
                                  <span className="mr-1">{goal.icon}</span>
                                  {goal.label}
                                </button>
                              ))}
                            </div>
                            {tradeHubGoal && (
                              <p className="text-xs text-white/40 mt-2">
                                {tradeHubGoal === 'win_now' && 'AI will focus on proven, productive players'}
                                {tradeHubGoal === 'rebuild' && 'AI will prioritize youth and draft capital'}
                                {tradeHubGoal === 'consolidate' && 'AI will help package depth for stars'}
                                {tradeHubGoal === 'add_depth' && 'AI will target multiple pieces for flexibility'}
                                {tradeHubGoal === 'acquire_picks' && 'AI will favor trades that add draft picks'}
                              </p>
                            )}
                          </div>
                        )}

                        {/* Loading State */}
                        {tradeHubLoading && (
                          <div className="flex items-center justify-center py-8">
                            <div className="animate-spin text-2xl mr-3">‚öôÔ∏è</div>
                            <span className="text-white/60">Loading league data...</span>
                          </div>
                        )}

                        {/* Trade Builder - Shows after league is loaded */}
                        {tradeHubManagers.length > 0 && !tradeHubLoading && (
                          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            {/* Team A (You) */}
                            <div className="rounded-xl bg-cyan-500/5 border border-cyan-500/20 p-4">
                              <div className="flex items-center gap-2 mb-4">
                                <span className="w-7 h-7 rounded-lg bg-cyan-500/30 flex items-center justify-center text-xs font-bold text-cyan-400">A</span>
                                <span className="text-sm font-semibold text-cyan-400">You Get</span>
                              </div>

                              {/* Team A Manager Selector */}
                              <div className="mb-4">
                                <label className="block text-xs text-white/50 mb-1">From Team</label>
                                <select
                                  value={tradeHubTeamA}
                                  onChange={(e) => {
                                    setTradeHubTeamA(e.target.value)
                                    setTradeHubPlayersA([])
                                    setTradeHubPicksA([])
                                    setTradeHubFaabA(0)
                                  }}
                                  className="w-full h-10 px-3 rounded-lg bg-black/50 border border-cyan-500/30 text-white text-sm focus:outline-none focus:border-cyan-400/60"
                                >
                                  {tradeHubManagers.map((m) => (
                                    <option key={m.rosterId} value={m.rosterId}>
                                      {m.displayName} ({m.record.wins}-{m.record.losses})
                                    </option>
                                  ))}
                                </select>
                              </div>

                              {/* Players Selector */}
                              {(() => {
                                const teamA = tradeHubManagers.find(m => String(m.rosterId) === tradeHubTeamA)
                                if (!teamA) return null
                                return (
                                  <>
                                    {/* Selected Players */}
                                    {tradeHubPlayersA.length > 0 && (
                                      <div className="mb-2" ref={sideARef}>
                                        <label className="block text-xs text-cyan-400 mb-1">Selected Players</label>
                                        <div className="flex flex-wrap gap-1">
                                          {tradeHubPlayersA.map((pid: string) => {
                                            const p = teamA.players.find((pl: any) => pl.id === pid)
                                            return (
                                              <button
                                                key={pid}
                                                onClick={() => setTradeHubPlayersA(tradeHubPlayersA.filter(id => id !== pid))}
                                                className={`flex items-center gap-1 px-2 py-1 text-xs rounded bg-cyan-500/20 text-cyan-300 border border-cyan-500/40 hover:bg-red-500/30 hover:border-red-500/50 hover:text-red-300 transition-all duration-500 ${recentlyAddedIds.includes(pid) ? "ring-2 ring-emerald-400 animate-pulse" : ""}`}
                                              >
                                                <PlayerBadge name={p?.name || pid} sleeperId={pid} position={p?.pos} team={p?.team} size="sm" showTeamLogo={false} />
                                                <span className="text-red-400">√ó</span>
                                              </button>
                                            )
                                          })}
                                        </div>
                                      </div>
                                    )}
                                    
                                    <div className="mb-3">
                                      <label className="block text-xs text-white/50 mb-1">Players ({tradeHubPlayersA.length} selected)</label>
                                      {teamA.players.length > 0 ? (
                                        <div className="w-full max-h-32 rounded-lg bg-black/50 border border-cyan-500/30 overflow-y-auto">
                                          {teamA.players
                                          .filter((p: any) => !tradeHubPlayersA.includes(p.id))
                                          .map((p: any) => (
                                              <button
                                                key={p.id}
                                                onClick={() => setTradeHubPlayersA([...tradeHubPlayersA, p.id])}
                                                className="w-full flex items-center gap-2 px-2 py-1.5 text-xs text-white/80 hover:bg-cyan-500/20 transition-colors border-b border-white/5 last:border-b-0"
                                              >
                                                <span className="text-cyan-400 font-bold">+</span>
                                                <PlayerBadge name={p.name} sleeperId={p.id} position={p.pos} team={p.team} size="sm" className="flex-1" />
                                              </button>
                                          ))}
                                        </div>
                                      ) : (
                                        <div className="w-full h-20 px-3 py-4 rounded-lg bg-black/50 border border-cyan-500/30 text-white/40 text-xs flex items-center justify-center text-center">
                                          No roster data available.<br />
                                          BestBall leagues often don&apos;t have accessible rosters.
                                        </div>
                                      )}
                                    </div>

                                    {/* Selected Draft Picks */}
                                    {tradeHubPicksA.length > 0 && (
                                      <div className="mb-2">
                                        <label className="block text-xs text-amber-400 mb-1">Selected Picks</label>
                                        <div className="flex flex-wrap gap-1">
                                          {tradeHubPicksA.map((pickKey: string) => {
                                            const [season, round, owner, slot] = pickKey.split('|')
                                            const ordinal = ['1st', '2nd', '3rd', '4th', '5th', '6th', '7th', '8th', '9th', '10th'][parseInt(round) - 1] || `${round}th`
                                            const pickPos = slot ? `${round}.${slot.padStart(2, '0')}` : ''
                                            const ownerStr = owner !== teamA.displayName ? ` (${owner})` : ''
                                            return (
                                              <button
                                                key={pickKey}
                                                onClick={() => setTradeHubPicksA(tradeHubPicksA.filter(k => k !== pickKey))}
                                                className="flex items-center gap-1 px-2 py-1 text-xs rounded bg-amber-500/20 text-amber-300 border border-amber-500/40 hover:bg-red-500/30 hover:border-red-500/50 hover:text-red-300 transition-colors"
                                              >
                                                <span>{season} {ordinal} Rd{pickPos ? ` - ${pickPos}` : ''}{ownerStr}</span>
                                                <span className="text-red-400">√ó</span>
                                              </button>
                                            )
                                          })}
                                        </div>
                                      </div>
                                    )}

                                    {/* Draft Picks */}
                                    {inlineTradeFormat === 'dynasty' && teamA.draftPicks.length > 0 && (
                                      <div className="mb-3">
                                        <label className="block text-xs text-white/50 mb-1">Draft Picks ({tradeHubPicksA.length} selected)</label>
                                        <div className="w-full max-h-24 rounded-lg bg-black/50 border border-cyan-500/30 overflow-y-auto">
                                          {teamA.draftPicks.filter((pick: any) => {
                                            const key = `${pick.season}|${pick.round}|${pick.originalOwner}|${pick.slot || ''}`
                                            return !tradeHubPicksA.includes(key)
                                          }).map((pick: any, idx: number) => {
                                            const key = `${pick.season}|${pick.round}|${pick.originalOwner}|${pick.slot || ''}`
                                            const ordinal = ['1st', '2nd', '3rd', '4th', '5th', '6th', '7th', '8th', '9th', '10th'][pick.round - 1] || `${pick.round}th`
                                            const pickPos = pick.slot ? `${pick.round}.${String(pick.slot).padStart(2, '0')}` : ''
                                            const ownerStr = pick.originalOwner !== teamA.displayName ? ` (${pick.originalOwner})` : ''
                                            const label = `${pick.season} ${ordinal} Rd${pickPos ? ` - ${pickPos}` : ''}${ownerStr}`
                                            return (
                                              <button
                                                key={key + idx}
                                                onClick={() => setTradeHubPicksA([...tradeHubPicksA, key])}
                                                className="w-full flex items-center gap-2 px-2 py-1.5 text-xs text-white/80 hover:bg-amber-500/20 transition-colors border-b border-white/5 last:border-b-0"
                                              >
                                                <span className="text-amber-400 font-bold">+</span>
                                                <span className="flex-1 text-left">{label}</span>
                                              </button>
                                            )
                                          })}
                                        </div>
                                      </div>
                                    )}

                                    {/* FAAB */}
                                    {teamA.faab.remaining > 0 && (
                                      <div>
                                        <label className="block text-xs text-white/50 mb-1">FAAB (${teamA.faab.remaining} available)</label>
                                        <input
                                          type="number"
                                          min={0}
                                          max={teamA.faab.remaining}
                                          value={tradeHubFaabA}
                                          onChange={(e) => setTradeHubFaabA(Math.min(teamA.faab.remaining, parseInt(e.target.value) || 0))}
                                          className="w-full h-9 px-3 rounded-lg bg-black/50 border border-cyan-500/30 text-white text-sm focus:outline-none focus:border-cyan-400/60"
                                        />
                                      </div>
                                    )}
                                  </>
                                )
                              })()}
                            </div>

                            {/* Team B (Trade Partner) */}
                            <div className="rounded-xl bg-purple-500/5 border border-purple-500/20 p-4">
                              <div className="flex items-center gap-2 mb-4">
                                <span className="w-7 h-7 rounded-lg bg-purple-500/30 flex items-center justify-center text-xs font-bold text-purple-400">B</span>
                                <span className="text-sm font-semibold text-purple-400">You Give</span>
                              </div>

                              {/* Team B Manager Selector */}
                              <div className="mb-4">
                                <label className="block text-xs text-white/50 mb-1">To Team</label>
                                <select
                                  value={tradeHubTeamB}
                                  onChange={(e) => {
                                    setTradeHubTeamB(e.target.value)
                                    setTradeHubPlayersB([])
                                    setTradeHubPicksB([])
                                    setTradeHubFaabB(0)
                                  }}
                                  className="w-full h-10 px-3 rounded-lg bg-black/50 border border-purple-500/30 text-white text-sm focus:outline-none focus:border-purple-400/60"
                                >
                                  <option value="">Select trade partner...</option>
                                  {tradeHubManagers
                                    .filter(m => String(m.rosterId) !== tradeHubTeamA)
                                    .map((m) => (
                                      <option key={m.rosterId} value={m.rosterId}>
                                        {m.displayName} ({m.record.wins}-{m.record.losses})
                                      </option>
                                    ))}
                                </select>
                              </div>

                              {/* Players Selector */}
                              {(() => {
                                const teamB = tradeHubManagers.find(m => String(m.rosterId) === tradeHubTeamB)
                                if (!teamB) return (
                                  <div className="text-center py-8 text-white/30 text-sm">
                                    Select a trade partner to see their assets
                                  </div>
                                )
                                return (
                                  <>
                                    <div className="mb-3">
                                      <label className="block text-xs text-white/50 mb-1">Players ({tradeHubPlayersB.length} selected)</label>
                                      {/* Selected Players */}
                                      {tradeHubPlayersB.length > 0 && (
                                        <div className="mb-2" ref={sideBRef}>
                                          <label className="block text-xs text-purple-400 mb-1">Selected Players</label>
                                          <div className="flex flex-wrap gap-1">
                                            {tradeHubPlayersB.map((pid: string) => {
                                              const p = teamB.players.find((pl: any) => pl.id === pid)
                                              return (
                                                <button
                                                  key={pid}
                                                  onClick={() => setTradeHubPlayersB(tradeHubPlayersB.filter(id => id !== pid))}
                                                  className={`flex items-center gap-1 px-2 py-1 text-xs rounded bg-purple-500/20 text-purple-300 border border-purple-500/40 hover:bg-red-500/30 hover:border-red-500/50 hover:text-red-300 transition-all duration-500 ${recentlyAddedIds.includes(pid) ? "ring-2 ring-emerald-400 animate-pulse" : ""}`}
                                                >
                                                  <PlayerBadge name={p?.name || pid} sleeperId={pid} position={p?.pos} team={p?.team} size="sm" showTeamLogo={false} />
                                                  <span className="text-red-400">√ó</span>
                                                </button>
                                              )
                                            })}
                                          </div>
                                        </div>
                                      )}
                                      
                                      {teamB.players.length > 0 ? (
                                        <div className="w-full max-h-32 rounded-lg bg-black/50 border border-purple-500/30 overflow-y-auto">
                                          {teamB.players.filter((p: any) => !tradeHubPlayersB.includes(p.id)).map((p: any) => (
                                            <button
                                              key={p.id}
                                              onClick={() => setTradeHubPlayersB([...tradeHubPlayersB, p.id])}
                                              className="w-full flex items-center gap-2 px-2 py-1.5 text-xs text-white/80 hover:bg-purple-500/20 transition-colors border-b border-white/5 last:border-b-0"
                                            >
                                              <span className="text-purple-400 font-bold">+</span>
                                              <PlayerBadge name={p.name} sleeperId={p.id} position={p.pos} team={p.team} size="sm" className="flex-1" />
                                            </button>
                                          ))}
                                        </div>
                                      ) : (
                                        <div className="w-full h-20 px-3 py-4 rounded-lg bg-black/50 border border-purple-500/30 text-white/40 text-xs flex items-center justify-center text-center">
                                          No roster data available.<br />
                                          BestBall leagues often don&apos;t have accessible rosters.
                                        </div>
                                      )}
                                    </div>

                                    {/* Selected Draft Picks */}
                                    {tradeHubPicksB.length > 0 && (
                                      <div className="mb-2">
                                        <label className="block text-xs text-amber-400 mb-1">Selected Picks</label>
                                        <div className="flex flex-wrap gap-1">
                                          {tradeHubPicksB.map((pickKey: string) => {
                                            const [season, round, owner, slot] = pickKey.split('|')
                                            const ordinal = ['1st', '2nd', '3rd', '4th', '5th', '6th', '7th', '8th', '9th', '10th'][parseInt(round) - 1] || `${round}th`
                                            const pickPos = slot ? `${round}.${slot.padStart(2, '0')}` : ''
                                            const ownerStr = owner !== teamB.displayName ? ` (${owner})` : ''
                                            return (
                                              <button
                                                key={pickKey}
                                                onClick={() => setTradeHubPicksB(tradeHubPicksB.filter(k => k !== pickKey))}
                                                className="flex items-center gap-1 px-2 py-1 text-xs rounded bg-amber-500/20 text-amber-300 border border-amber-500/40 hover:bg-red-500/30 hover:border-red-500/50 hover:text-red-300 transition-colors"
                                              >
                                                <span>{season} {ordinal} Rd{pickPos ? ` - ${pickPos}` : ''}{ownerStr}</span>
                                                <span className="text-red-400">√ó</span>
                                              </button>
                                            )
                                          })}
                                        </div>
                                      </div>
                                    )}

                                    {/* Draft Picks */}
                                    {inlineTradeFormat === 'dynasty' && teamB.draftPicks.length > 0 && (
                                      <div className="mb-3">
                                        <label className="block text-xs text-white/50 mb-1">Draft Picks ({tradeHubPicksB.length} selected)</label>
                                        <div className="w-full max-h-24 rounded-lg bg-black/50 border border-purple-500/30 overflow-y-auto">
                                          {teamB.draftPicks.filter((pick: any) => {
                                            const key = `${pick.season}|${pick.round}|${pick.originalOwner}|${pick.slot || ''}`
                                            return !tradeHubPicksB.includes(key)
                                          }).map((pick: any, idx: number) => {
                                            const key = `${pick.season}|${pick.round}|${pick.originalOwner}|${pick.slot || ''}`
                                            const ordinal = ['1st', '2nd', '3rd', '4th', '5th', '6th', '7th', '8th', '9th', '10th'][pick.round - 1] || `${pick.round}th`
                                            const pickPos = pick.slot ? `${pick.round}.${String(pick.slot).padStart(2, '0')}` : ''
                                            const ownerStr = pick.originalOwner !== teamB.displayName ? ` (${pick.originalOwner})` : ''
                                            const label = `${pick.season} ${ordinal} Rd${pickPos ? ` - ${pickPos}` : ''}${ownerStr}`
                                            return (
                                              <button
                                                key={key + idx}
                                                onClick={() => setTradeHubPicksB([...tradeHubPicksB, key])}
                                                className="w-full flex items-center gap-2 px-2 py-1.5 text-xs text-white/80 hover:bg-amber-500/20 transition-colors border-b border-white/5 last:border-b-0"
                                              >
                                                <span className="text-amber-400 font-bold">+</span>
                                                <span className="flex-1 text-left">{label}</span>
                                              </button>
                                            )
                                          })}
                                        </div>
                                      </div>
                                    )}

                                    {/* FAAB */}
                                    {teamB.faab.remaining > 0 && (
                                      <div>
                                        <label className="block text-xs text-white/50 mb-1">FAAB (${teamB.faab.remaining} available)</label>
                                        <input
                                          type="number"
                                          min={0}
                                          max={teamB.faab.remaining}
                                          value={tradeHubFaabB}
                                          onChange={(e) => setTradeHubFaabB(Math.min(teamB.faab.remaining, parseInt(e.target.value) || 0))}
                                          className="w-full h-9 px-3 rounded-lg bg-black/50 border border-purple-500/30 text-white text-sm focus:outline-none focus:border-purple-400/60"
                                        />
                                      </div>
                                    )}
                                  </>
                                )
                              })()}
                            </div>
                          </div>
                        )}

                        {/* LIVE TRADE PREVIEW PANEL */}
                        {(tradeHubLivePreview || tradeHubLiveLoading) && tradeHubManagers.length > 0 && !tradeHubLoading && (
                          <div className={`mt-4 rounded-2xl border overflow-hidden transition-all ${tradeHubLiveLoading ? 'border-purple-500/20 bg-purple-900/10' : 'border-purple-500/30 bg-gradient-to-br from-slate-900/95 via-purple-900/20 to-slate-900/95'}`}>
                            <div className="h-0.5 bg-gradient-to-r from-purple-500 via-cyan-400 to-purple-500" style={tradeHubLiveLoading ? { animation: 'pulse 1.5s ease-in-out infinite' } : {}} />
                            <div className="p-4 space-y-4">
                              {/* Header + Accept Rate */}
                              <div className="flex items-center justify-between">
                                <div className="flex items-center gap-2">
                                  <span className="text-lg">‚ö°</span>
                                  <span className="text-sm font-bold text-white">Live Preview</span>
                                  {tradeHubLiveLoading && <span className="animate-spin text-xs">‚è≥</span>}
                                </div>
                                {tradeHubLivePreview && (
                                  <div className="flex items-center gap-3">
                                    <div className="text-right">
                                      <div className="text-[9px] text-white/40 uppercase tracking-wider">Accept Rate</div>
                                      <div className={`text-2xl font-black ${
                                        tradeHubLivePreview.acceptProbability >= 60 ? 'text-emerald-400' :
                                        tradeHubLivePreview.acceptProbability >= 40 ? 'text-amber-400' :
                                        tradeHubLivePreview.acceptProbability >= 25 ? 'text-orange-400' : 'text-rose-400'
                                      }`}>
                                        {tradeHubLivePreview.acceptProbability}%
                                      </div>
                                    </div>
                                  </div>
                                )}
                              </div>

                              {tradeHubLivePreview && (
                                <>
                                  {/* Accept Rate Bar */}
                                  <div className="relative h-3 rounded-full bg-slate-800 overflow-hidden">
                                    <div
                                      className="absolute inset-y-0 left-0 rounded-full transition-all duration-500"
                                      style={{
                                        width: `${Math.min(100, tradeHubLivePreview.acceptProbability)}%`,
                                        backgroundColor: tradeHubLivePreview.acceptProbability >= 60 ? '#10b981' :
                                          tradeHubLivePreview.acceptProbability >= 40 ? '#f59e0b' :
                                          tradeHubLivePreview.acceptProbability >= 25 ? '#f97316' : '#ef4444',
                                      }}
                                    />
                                    <div className="absolute inset-y-0 left-1/2 w-px bg-white/20" />
                                  </div>

                                  {/* Quick Stats Row */}
                                  <div className="grid grid-cols-4 gap-2">
                                    <div className="p-2 rounded-lg bg-slate-800/60 text-center">
                                      <div className="text-[9px] text-white/40 uppercase">Verdict</div>
                                      <div className={`text-xs font-bold mt-0.5 ${
                                        tradeHubLivePreview.verdict === 'FAIR' ? 'text-emerald-400' :
                                        tradeHubLivePreview.verdict === 'GOOD' || tradeHubLivePreview.lean === 'LEAN_ACCEPT' ? 'text-cyan-400' :
                                        tradeHubLivePreview.lean === 'LEAN_DECLINE' ? 'text-rose-400' : 'text-amber-400'
                                      }`}>{tradeHubLivePreview.verdict}</div>
                                    </div>
                                    <div className="p-2 rounded-lg bg-slate-800/60 text-center">
                                      <div className="text-[9px] text-white/40 uppercase">Fairness</div>
                                      <div className={`text-xs font-bold mt-0.5 ${tradeHubLivePreview.fairnessDelta >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                                        {tradeHubLivePreview.fairnessDelta >= 0 ? '+' : ''}{tradeHubLivePreview.fairnessDelta}
                                      </div>
                                    </div>
                                    <div className="p-2 rounded-lg bg-slate-800/60 text-center">
                                      <div className="text-[9px] text-white/40 uppercase">Market</div>
                                      <div className={`text-xs font-bold mt-0.5 ${tradeHubLivePreview.marketDeltaPct >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                                        {tradeHubLivePreview.marketDeltaPct >= 0 ? '+' : ''}{tradeHubLivePreview.marketDeltaPct}%
                                      </div>
                                    </div>
                                    <div className="p-2 rounded-lg bg-slate-800/60 text-center">
                                      <div className="text-[9px] text-white/40 uppercase">Confidence</div>
                                      <div className="text-xs font-bold mt-0.5 text-purple-300">{tradeHubLivePreview.confidence}%</div>
                                    </div>
                                  </div>

                                  {/* 4-Factor Score Bar */}
                                  <div className="space-y-1.5">
                                    <div className="text-[10px] text-white/40 uppercase tracking-wider">4-Factor Breakdown</div>
                                    {[
                                      { label: 'Lineup Impact', value: tradeHubLivePreview.scores?.lineupImpact, weight: '40%', color: '#3b82f6' },
                                      { label: 'VORP', value: tradeHubLivePreview.scores?.vorp, weight: '25%', color: '#a855f7' },
                                      { label: 'Market', value: tradeHubLivePreview.scores?.market, weight: '20%', color: '#10b981' },
                                      { label: 'Behavior', value: tradeHubLivePreview.scores?.behavior, weight: '15%', color: '#f59e0b' },
                                    ].map(f => (
                                      <div key={f.label} className="flex items-center gap-2">
                                        <div className="w-20 text-[10px] text-white/50 truncate">{f.label}</div>
                                        <div className="flex-1 h-2 rounded-full bg-slate-800 overflow-hidden">
                                          <div className="h-full rounded-full transition-all duration-500" style={{ width: `${f.value}%`, backgroundColor: f.color }} />
                                        </div>
                                        <div className="w-10 text-[10px] text-white/50 text-right">{f.value}</div>
                                        <div className="w-8 text-[9px] text-white/30 text-right">{f.weight}</div>
                                      </div>
                                    ))}
                                  </div>

                                  {/* SLOT DELTA MAP */}
                                  {tradeHubLivePreview.slotMap?.deltas?.length > 0 && (
                                    <div>
                                      <button
                                        onClick={() => setTradeHubExpandedSlotMap(!tradeHubExpandedSlotMap)}
                                        className="flex items-center gap-2 w-full text-left"
                                      >
                                        <span className="text-sm">üó∫Ô∏è</span>
                                        <span className="text-[10px] text-white/40 uppercase tracking-wider flex-1">Slot Delta Map ‚Äî Your Starting Lineup</span>
                                        <span className={`text-xs font-bold ${
                                          tradeHubLivePreview.lineupDelta?.deltaYou >= 0 ? 'text-emerald-400' : 'text-rose-400'
                                        }`}>
                                          {tradeHubLivePreview.lineupDelta?.deltaYou >= 0 ? '+' : ''}{tradeHubLivePreview.lineupDelta?.deltaYou?.toFixed(1)} PPG
                                        </span>
                                        <span className={`text-white/30 transition-transform ${tradeHubExpandedSlotMap ? 'rotate-180' : ''}`}>‚ñº</span>
                                      </button>
                                      {tradeHubExpandedSlotMap && (
                                        <div className="mt-2 space-y-1">
                                          {tradeHubLivePreview.slotMap.deltas.map((d: any, i: number) => (
                                            <div key={i} className={`flex items-center gap-2 p-1.5 rounded-lg text-xs ${
                                              d.delta > 0.1 ? 'bg-emerald-500/10 border border-emerald-500/15' :
                                              d.delta < -0.1 ? 'bg-rose-500/10 border border-rose-500/15' :
                                              'bg-slate-800/40 border border-slate-700/20'
                                            }`}>
                                              <div className="w-16 text-[10px] font-mono text-white/50">{d.slot}</div>
                                              <div className="flex-1 flex items-center gap-1 min-w-0">
                                                <span className="text-white/40 truncate text-[11px]">{d.beforePlayer || '‚Äî'}</span>
                                                {d.beforePlayer !== d.afterPlayer && (
                                                  <>
                                                    <span className="text-white/20">‚Üí</span>
                                                    <span className={`truncate text-[11px] font-medium ${d.delta > 0 ? 'text-emerald-300' : d.delta < 0 ? 'text-rose-300' : 'text-white/60'}`}>
                                                      {d.afterPlayer || '‚Äî'}
                                                    </span>
                                                  </>
                                                )}
                                              </div>
                                              <div className={`w-14 text-right font-mono text-[11px] font-bold ${
                                                d.delta > 0.1 ? 'text-emerald-400' : d.delta < -0.1 ? 'text-rose-400' : 'text-white/30'
                                              }`}>
                                                {d.delta > 0 ? '+' : ''}{d.delta.toFixed(1)}
                                              </div>
                                            </div>
                                          ))}
                                        </div>
                                      )}
                                    </div>
                                  )}

                                  {/* OPPONENT BIAS METER */}
                                  {tradeHubLivePreview.opponentTendency && (
                                    <div>
                                      <div className="flex items-center gap-2 mb-2">
                                        <span className="text-sm">üéØ</span>
                                        <span className="text-[10px] text-white/40 uppercase tracking-wider">Opponent Bias Meter</span>
                                        <span className="text-[9px] text-white/25">({tradeHubLivePreview.opponentTendency.sampleSize} trades)</span>
                                      </div>
                                      <div className="grid grid-cols-2 gap-2">
                                        {/* Position Biases */}
                                        {Object.entries(tradeHubLivePreview.opponentTendency.positionBias as Record<string, number>)
                                          .filter(([, v]) => Math.abs(v) > 0.05)
                                          .sort(([, a], [, b]) => Math.abs(b) - Math.abs(a))
                                          .map(([pos, bias]) => (
                                            <div key={pos} className="flex items-center gap-2 p-2 rounded-lg bg-slate-800/50">
                                              <span className="text-[10px] font-bold w-8 text-white/60">{pos}</span>
                                              <div className="flex-1 h-1.5 rounded-full bg-slate-700 relative overflow-hidden">
                                                <div
                                                  className="absolute inset-y-0 rounded-full"
                                                  style={{
                                                    left: bias >= 0 ? '50%' : `${50 + bias * 50}%`,
                                                    width: `${Math.abs(bias) * 50}%`,
                                                    backgroundColor: bias > 0 ? '#10b981' : '#f43f5e',
                                                  }}
                                                />
                                                <div className="absolute inset-y-0 left-1/2 w-px bg-white/20" />
                                              </div>
                                              <span className={`text-[10px] font-mono w-8 text-right ${bias > 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                                                {bias > 0 ? '+' : ''}{(bias * 100).toFixed(0)}
                                              </span>
                                            </div>
                                          ))}
                                        {/* Other traits */}
                                        <div className="p-2 rounded-lg bg-slate-800/50 flex items-center justify-between">
                                          <span className="text-[10px] text-white/50">Overpay</span>
                                          <span className={`text-[10px] font-bold ${
                                            tradeHubLivePreview.opponentTendency.overpayThreshold < -0.3 ? 'text-emerald-400' : 'text-amber-400'
                                          }`}>
                                            {tradeHubLivePreview.opponentTendency.overpayThreshold < -0.5 ? 'High' :
                                             tradeHubLivePreview.opponentTendency.overpayThreshold < -0.2 ? 'Medium' : 'Low'}
                                          </span>
                                        </div>
                                        <div className="p-2 rounded-lg bg-slate-800/50 flex items-center justify-between">
                                          <span className="text-[10px] text-white/50">Risk</span>
                                          <span className={`text-[10px] font-bold ${
                                            tradeHubLivePreview.opponentTendency.riskTolerance > 0.3 ? 'text-emerald-400' : 'text-amber-400'
                                          }`}>
                                            {tradeHubLivePreview.opponentTendency.riskTolerance > 0.3 ? 'High' :
                                             tradeHubLivePreview.opponentTendency.riskTolerance > -0.1 ? 'Medium' : 'Low'}
                                          </span>
                                        </div>
                                      </div>
                                    </div>
                                  )}

                                  {/* SWEETENER SUGGESTIONS */}
                                  {tradeHubLivePreview.sweeteners?.length > 0 && (
                                    <div>
                                      <div className="flex items-center gap-2 mb-2">
                                        <span className="text-sm">üç¨</span>
                                        <span className="text-[10px] text-white/40 uppercase tracking-wider">Sweetener Suggestions</span>
                                      </div>
                                      <div className="space-y-1.5">
                                        {tradeHubLivePreview.sweeteners.map((s: any, i: number) => (
                                          <button
                                            key={i}
                                            onClick={() => {
                                              if (s.asset?.id && !tradeHubPlayersB.includes(s.asset.id)) {
                                                setTradeHubPlayersB([...tradeHubPlayersB, s.asset.id])
                                              }
                                            }}
                                            className="w-full flex items-center gap-2 p-2 rounded-lg bg-amber-500/5 border border-amber-500/15 hover:bg-amber-500/15 transition text-left"
                                          >
                                            <div className="flex-1 min-w-0">
                                              <div className="text-xs text-white font-medium truncate">{s.asset?.name || '?'}</div>
                                              <div className="text-[10px] text-white/40">{s.asset?.pos}</div>
                                            </div>
                                            <div className="flex items-center gap-3 flex-shrink-0">
                                              <div className="text-center">
                                                <div className="text-[9px] text-white/30">Accept</div>
                                                <div className="text-xs font-bold text-emerald-400">+{Math.round(s.acceptDelta * 100)}%</div>
                                              </div>
                                              <div className="text-center">
                                                <div className="text-[9px] text-white/30">Fairness</div>
                                                <div className={`text-xs font-bold ${s.fairnessImpact <= -5 ? 'text-rose-400' : 'text-amber-400'}`}>
                                                  {s.fairnessImpact >= 0 ? '+' : ''}{s.fairnessImpact}
                                                </div>
                                              </div>
                                              <span className="text-amber-400 text-xs">+ Add</span>
                                            </div>
                                          </button>
                                        ))}
                                      </div>
                                    </div>
                                  )}

                                  {/* Accept Drivers */}
                                  {tradeHubLivePreview.acceptDrivers?.length > 0 && (
                                    <div>
                                      <div className="text-[10px] text-white/40 uppercase tracking-wider mb-1.5">Accept Signals</div>
                                      <div className="flex flex-wrap gap-1.5">
                                        {tradeHubLivePreview.acceptDrivers.slice(0, 6).map((d: any, i: number) => (
                                          <div key={i} className={`px-2 py-1 rounded-full text-[10px] border ${
                                            d.direction === 'UP' ? 'border-emerald-500/30 text-emerald-300 bg-emerald-500/10' :
                                            d.direction === 'DOWN' ? 'border-rose-500/30 text-rose-300 bg-rose-500/10' :
                                            'border-slate-600/30 text-white/40 bg-slate-800/30'
                                          }`}>
                                            {d.emoji} {d.name}: {d.direction === 'UP' ? '‚Üë' : d.direction === 'DOWN' ? '‚Üì' : '‚Äî'}
                                          </div>
                                        ))}
                                      </div>
                                    </div>
                                  )}

                                  {/* Risk Flags */}
                                  {tradeHubLivePreview.riskFlags?.length > 0 && (
                                    <div className="flex flex-wrap gap-1.5">
                                      {tradeHubLivePreview.riskFlags.map((flag: string, i: number) => (
                                        <div key={i} className="px-2 py-1 rounded-full text-[10px] border border-amber-500/30 text-amber-300 bg-amber-500/10">
                                          ‚ö†Ô∏è {flag}
                                        </div>
                                      ))}
                                    </div>
                                  )}
                                </>
                              )}
                            </div>
                          </div>
                        )}

                        {/* Generate Trade Button */}
                        {tradeHubManagers.length > 0 && !tradeHubLoading && (
                          <div className="mt-6 space-y-3">
                            <button
                              onClick={generateTradeHubReport}
                              disabled={inlineTradeLoading || !tradeHubTeamB || (tradeHubPlayersA.length === 0 && tradeHubPicksA.length === 0 && tradeHubFaabA === 0 && tradeHubPlayersB.length === 0 && tradeHubPicksB.length === 0 && tradeHubFaabB === 0)}
                              className="w-full py-3.5 rounded-xl font-bold text-white transition disabled:opacity-50 disabled:cursor-not-allowed
                                bg-gradient-to-r from-purple-500 to-cyan-500 hover:from-purple-400 hover:to-cyan-400
                                shadow-[0_8px_30px_rgba(0,0,0,0.3)] flex items-center justify-center gap-2"
                            >
                              {inlineTradeLoading ? (
                                <>
                                  <span className="animate-spin">‚öôÔ∏è</span> Analyzing Trade...
                                </>
                              ) : (
                                <>
                                  <span>üìã</span> Generate Full AI Report
                                </>
                              )}
                            </button>

                            {/* Trade Ideas Link - Lights up when available */}
                            {showTradeHubIdeas && (
                              <div className={`p-4 rounded-xl border transition-all ${tradeHubIdeasLoading ? 'border-purple-500/30 bg-purple-500/5' : 'border-emerald-500/30 bg-emerald-500/10'}`}>
                                <div className="flex items-center gap-3">
                                  {tradeHubIdeasLoading ? (
                                    <>
                                      <span className="animate-pulse text-xl">üí°</span>
                                      <span className="text-sm text-purple-300">AI is generating trade ideas for you...</span>
                                    </>
                                  ) : tradeHubIdeas.length > 0 ? (
                                    <>
                                      <span className="text-xl">‚ú®</span>
                                      <div className="flex-1">
                                        <div className="text-sm font-medium text-emerald-400">{tradeHubIdeas.length} Trade Ideas Ready</div>
                                        <div className="text-xs text-white/50">AI-generated suggestions based on your league</div>
                                      </div>
                                      <button
                                        onClick={() => handleActiveTabChange('finder')}
                                        className="px-4 py-2 rounded-lg bg-emerald-500/20 text-emerald-300 text-sm font-medium hover:bg-emerald-500/30 transition"
                                      >
                                        View Ideas
                                      </button>
                                    </>
                                  ) : null}
                                </div>
                              </div>
                            )}
                          </div>
                        )}

                        {/* No League Selected State */}
                        {!tradeHubLeague && leagues.length > 0 && (
                          <div className="text-center py-8">
                            <div className="text-4xl mb-3">üìã</div>
                            <div className="text-white/60 text-sm">Select a league above to build a trade with real roster data</div>
                          </div>
                        )}

                        {/* No Leagues Available */}
                        {leagues.length === 0 && (
                          <div className="text-center py-8">
                            <div className="text-4xl mb-3">üèà</div>
                            <div className="text-white/60 text-sm">Import leagues from the Overview tab to use the Trade Hub</div>
                          </div>
                        )}

                        {inlineTradeError && (
                          <div className="mt-4 p-3 rounded-xl bg-rose-500/10 border border-rose-500/20 text-sm text-rose-400 text-center">
                            {inlineTradeError}
                          </div>
                        )}

                        {/* Trade Hub Report Card - Inline Results */}
                        {inlineTradeResult && !inlineTradeLoading && (
                          <div className="mt-6 rounded-2xl bg-gradient-to-br from-slate-900/95 via-purple-900/30 to-slate-900/95 border border-purple-500/30 overflow-hidden">
                            <div className="h-1 bg-gradient-to-r from-purple-500 via-cyan-400 to-purple-500" />
                            <div className="p-5">
                              <div className="flex items-center gap-2 mb-4">
                                <span className="text-xl">üìã</span>
                                <h4 className="text-lg font-bold text-white">Trade Report</h4>
                              </div>

                              {/* Quick Stats Row */}
                              <div className="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
                                <div className="rounded-xl bg-white/5 border border-white/10 p-3 text-center">
                                  <div className="text-[10px] uppercase tracking-wider text-white/40 mb-1">Verdict</div>
                                  <div className={`text-lg font-bold ${
                                    inlineTradeResult.verdict?.toLowerCase().includes('fair') ? 'text-emerald-400' :
                                    inlineTradeResult.verdict?.toLowerCase().includes('favors a') || inlineTradeResult.verdict?.toLowerCase().includes('accept') ? 'text-cyan-400' :
                                    inlineTradeResult.verdict?.toLowerCase().includes('favors b') || inlineTradeResult.verdict?.toLowerCase().includes('decline') ? 'text-rose-400' : 
                                    'text-amber-400'
                                  }`}>
                                    {inlineTradeResult.verdict?.toLowerCase().includes('fair') ? '‚úì Fair' :
                                     inlineTradeResult.verdict?.toLowerCase().includes('favors a') ? '‚Üë Strong' :
                                     inlineTradeResult.verdict?.toLowerCase().includes('accept') ? '‚úì Accept' :
                                     inlineTradeResult.verdict?.toLowerCase().includes('decline') ? '‚úó Risky' :
                                     inlineTradeResult.verdict || '‚Äî'}
                                  </div>
                                </div>
                                <div className="rounded-xl bg-white/5 border border-white/10 p-3 text-center">
                                  <div className="text-[10px] uppercase tracking-wider text-white/40 mb-1">Grade</div>
                                  <div className={`text-2xl font-black ${
                                    inlineTradeResult.grade?.startsWith('A') ? 'text-emerald-400' :
                                    inlineTradeResult.grade?.startsWith('B') ? 'text-cyan-400' :
                                    inlineTradeResult.grade?.startsWith('C') ? 'text-amber-400' :
                                    'text-rose-400'
                                  }`}>
                                    {inlineTradeResult.grade || '‚Äî'}
                                  </div>
                                </div>
                                <div className="rounded-xl bg-white/5 border border-white/10 p-3 text-center">
                                  <div className="text-[10px] uppercase tracking-wider text-white/40 mb-1">Fairness</div>
                                  <div className="text-lg font-bold text-white">
                                    {inlineTradeResult.fairnessScore ?? inlineTradeResult.balanceScore ?? '‚Äî'}
                                    {(inlineTradeResult.fairnessScore || inlineTradeResult.balanceScore) && <span className="text-sm text-white/50">/100</span>}
                                  </div>
                                </div>
                                <div className="rounded-xl bg-white/5 border border-white/10 p-3 text-center">
                                  <div className="text-[10px] uppercase tracking-wider text-white/40 mb-1">Confidence</div>
                                  <div className={`text-lg font-bold ${
                                    (inlineTradeResult.confidence === 'high' || (typeof inlineTradeResult.confidence === 'number' && inlineTradeResult.confidence >= 80)) 
                                      ? 'text-emerald-400' : 'text-amber-400'
                                  }`}>
                                    {(inlineTradeResult.confidence === 'high' || (typeof inlineTradeResult.confidence === 'number' && inlineTradeResult.confidence >= 80)) 
                                      ? 'üü¢ High' : 'üü° Medium'}
                                  </div>
                                </div>
                              </div>

                              {inlineTradeResult.offseasonContext?.offseason && (
                                <div className="rounded-xl border border-amber-500/30 bg-amber-500/10 px-4 py-2.5 flex items-center gap-2">
                                  <span className="text-amber-300 text-xs font-bold">!</span>
                                  <div>
                                    <span className="text-xs font-semibold text-amber-200">{inlineTradeResult.offseasonContext.offseasonBadge}</span>
                                    <span className="text-[10px] text-amber-200/50 ml-2">{inlineTradeResult.offseasonContext.offseasonNote}</span>
                                  </div>
                                </div>
                              )}

                              {inlineTradeResult.acceptanceBuckets && Array.isArray(inlineTradeResult.acceptanceBuckets) && inlineTradeResult.acceptanceBuckets.length > 0 && (
                                <div className="rounded-xl bg-black/30 border border-white/10 p-4">
                                  <div className="text-xs font-semibold text-white/60 uppercase tracking-wider mb-3">Acceptance Drivers</div>
                                  <div className="grid grid-cols-5 gap-1.5">
                                    {inlineTradeResult.acceptanceBuckets.map((b: any) => {
                                      const d = Number(b.delta) || 0
                                      return (
                                      <div key={b.key || b.label} className="text-center">
                                        <div className="text-[9px] text-white/40 uppercase truncate">{b.label || '‚Äî'}</div>
                                        <div className="text-base font-bold text-white">{b.value ?? '‚Äî'}</div>
                                        <div className={`text-[9px] ${d > 0 ? 'text-emerald-400' : d < 0 ? 'text-rose-400' : 'text-white/30'}`}>
                                          {d > 0 ? '+' : ''}{(d * 100).toFixed(0)}%
                                        </div>
                                      </div>
                                      )
                                    })}
                                  </div>
                                </div>
                              )}

                              {/* Analysis Summary */}
                              {(inlineTradeResult.expertAnalysis || inlineTradeResult.why?.length > 0) && (
                                <div className="rounded-xl bg-black/30 border border-white/10 p-4">
                                  <div className="text-xs font-semibold text-white/60 uppercase tracking-wider mb-2">AI Analysis</div>
                                  {inlineTradeResult.why?.slice(0, 3).map((point: string, idx: number) => (
                                    <p key={idx} className="text-sm text-white/80 mb-1">‚Ä¢ {point}</p>
                                  ))}
                                  {inlineTradeResult.expertAnalysis && (
                                    <p className="text-sm text-white/70 mt-2">{inlineTradeResult.expertAnalysis.slice(0, 300)}...</p>
                                  )}
                                </div>
                              )}
                            </div>
                          </div>
                        )}
                      </div>
                    </div>

                    {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                        TRADE IDEAS GENERATOR
                    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
                    <div className="rounded-2xl bg-black/30 border border-white/10 overflow-hidden">
                      <div className="p-4 sm:p-6 border-b border-white/5">
                        <div className="flex items-center justify-between flex-wrap gap-3">
                          <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-500/30 to-purple-500/30 flex items-center justify-center text-xl">üéØ</div>
                            <div>
                              <h3 className="text-lg font-bold text-white">Trade Ideas Generator</h3>
                              <p className="text-xs text-white/50">Describe your goals for AI suggestions</p>
                            </div>
                          </div>

                          {/* Control Pills */}
                          <div className="flex flex-wrap items-center gap-2">
                            {/* Analysis Depth */}
                            <div className="flex rounded-lg overflow-hidden border border-white/20">
                              <button
                                onClick={() => setTradeAnalysisDepth('fast')}
                                className={`px-3 py-1.5 text-xs font-medium transition ${
                                  tradeAnalysisDepth === 'fast'
                                    ? 'bg-cyan-500/40 text-cyan-200'
                                    : 'bg-black/30 text-white/50 hover:text-white'
                                }`}
                              >
                                ‚ö° Fast
                              </button>
                              <button
                                onClick={() => setTradeAnalysisDepth('deep')}
                                className={`px-3 py-1.5 text-xs font-medium transition ${
                                  tradeAnalysisDepth === 'deep'
                                    ? 'bg-purple-500/40 text-purple-200'
                                    : 'bg-black/30 text-white/50 hover:text-white'
                                }`}
                              >
                                üî¨ Deep
                              </button>
                            </div>

                            {/* Ideas Count */}
                            <div className="flex rounded-lg overflow-hidden border border-white/20">
                              {[3, 5, 7].map((num) => (
                                <button
                                  key={num}
                                  onClick={() => setTradeIdeasCount(num)}
                                  className={`px-2.5 py-1.5 text-xs font-medium transition ${
                                    tradeIdeasCount === num
                                      ? 'bg-cyan-500/40 text-cyan-200'
                                      : 'bg-black/30 text-white/50 hover:text-white'
                                  }`}
                                >
                                  {num}
                                </button>
                              ))}
                            </div>
                          </div>
                        </div>
                      </div>

                      <div className="p-4 sm:p-6">
                        {/* ‚úÖ League is controlled by the Trade History Report Card */}
                        <div className="mb-4">
                          <label className="block text-xs font-medium text-white/60 mb-2">League</label>

                          {!activeTradeLeagueId ? (
                            <div className="p-3 rounded-xl bg-white/5 border border-white/10 text-sm text-white/60">
                              Select a league in <span className="text-white/80 font-medium">Trade History Report Card</span> to generate league-specific trade ideas.
                            </div>
                          ) : (
                            <div className="p-3 rounded-xl bg-black/40 border border-white/10 text-sm text-white/80 flex items-center justify-between">
                              <span>‚úÖ League selected</span>
                              <span className="text-white/50 text-xs">{leagues.find(l => l.league_id === activeTradeLeagueId)?.name || activeTradeLeagueId}</span>
                            </div>
                          )}
                          {activeTradeLeagueId && (() => {
                            const league = leagues.find(l => l.league_id === activeTradeLeagueId)
                            if (!league) return null
                            const isContending = league.wins > league.losses
                            return (
                              <div className="mt-2 flex items-center gap-2">
                                <span className={`px-2 py-1 text-xs rounded-full ${isContending ? 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30' : 'bg-amber-500/20 text-amber-400 border border-amber-500/30'}`}>
                                  {isContending ? 'üèÜ Contending' : 'üî® Rebuilding'}
                                </span>
                                <span className="text-xs text-white/40">{league.type} ‚Ä¢ {league.scoring}</span>
                              </div>
                            )
                          })()}
                        </div>

                        {/* Trade Goals Input */}
                        <textarea
                          value={tradeGoals}
                          onChange={(e) => setTradeGoals(e.target.value)}
                          placeholder="What are your trade goals? e.g., 'Get younger at WR' or 'Win now' or 'Acquire draft picks'"
                          className="w-full px-4 py-3 rounded-xl bg-black/50 border border-white/20 text-white placeholder-white/30 focus:outline-none focus:border-cyan-400/60 focus:ring-2 focus:ring-cyan-400/20 transition min-h-[80px] resize-none text-sm mb-4"
                        />

                        {/* Generate Button */}
                        <button
                          onClick={generateTradeIdeas}
                          disabled={tradeIdeasLoading || !tradeSelectedLeague}
                          className="w-full py-3 rounded-xl font-bold text-white transition disabled:opacity-50 disabled:cursor-not-allowed
                            bg-gradient-to-r from-cyan-500 to-purple-500 hover:from-cyan-400 hover:to-purple-400
                            shadow-[0_8px_30px_rgba(0,0,0,0.3)] flex items-center justify-center gap-2"
                        >
                          {tradeIdeasLoading ? (
                            <>
                              <span className="animate-spin">‚ö°</span> Generating Ideas...
                            </>
                          ) : (
                            <>
                              <span>‚ú®</span> Generate Trade Ideas
                            </>
                          )}
                        </button>

                        {tradeIdeasError && (
                          <div className="mt-3 p-3 rounded-xl bg-rose-500/10 border border-rose-500/20 text-sm text-rose-400 text-center">
                            {tradeIdeasError}
                          </div>
                        )}

                        {/* Generated Trade Proposals */}
                        {tradeIdeasResults.length > 0 ? (
                          <div className="mt-6 space-y-4">
                            <div className="flex items-center gap-2 mb-4">
                              <span className="text-sm font-semibold text-white">üí° Trade Proposals</span>
                              <span className="px-2 py-0.5 text-[10px] rounded-full bg-purple-500/20 text-purple-300 border border-purple-400/30">
                                {tradeIdeasResults.length} found
                              </span>
                            </div>
                            {tradeIdeasResults.map((idea: any, idx: number) => (
                              <div key={idx} className="rounded-xl bg-gradient-to-br from-slate-900/90 to-slate-800/90 border border-white/10 hover:border-cyan-500/30 transition overflow-hidden">
                                {/* Header with acceptance probability */}
                                <div className="p-3 sm:p-4 border-b border-white/10 flex items-start justify-between gap-2">
                                  <div className="flex items-start gap-2 sm:gap-3 min-w-0 flex-1">
                                    <span className="text-lg sm:text-xl flex-shrink-0 mt-0.5">{idea.icon || 'üí°'}</span>
                                    <div className="min-w-0">
                                      <h5 className="font-semibold text-white text-xs sm:text-sm leading-tight">{idea.title}</h5>
                                      <p className="text-[10px] sm:text-xs text-white/50 truncate">
                                        Send to: <span className="text-cyan-400">{idea.targetManager}</span>
                                        {idea.targetRecord && <span className="text-white/40"> ({idea.targetRecord})</span>}
                                        {idea.targetTradeCount > 0 && <span className="text-white/30 hidden sm:inline"> ‚Ä¢ {idea.targetTradeCount} trades</span>}
                                      </p>
                                    </div>
                                  </div>
                                  <div className="text-right flex-shrink-0">
                                    <div className={`text-xl sm:text-2xl font-bold ${
                                      idea.acceptanceProbability >= 70 ? 'text-emerald-400' :
                                      idea.acceptanceProbability >= 50 ? 'text-amber-400' : 
                                      idea.acceptanceProbability >= 30 ? 'text-orange-400' : 'text-rose-400'
                                    }`}>
                                      {idea.acceptanceProbability}%
                                    </div>
                                    <div className="text-[9px] sm:text-[10px] text-white/40 uppercase tracking-wider">Accept Rate</div>
                                  </div>
                                </div>
                                
                                {/* Trade Details - Send & Receive */}
                                <div className="p-3 sm:p-4 grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                                  {/* You Send */}
                                  <div className="space-y-1.5 sm:space-y-2">
                                    <div className="flex items-center justify-between">
                                      <div className="flex items-center gap-1.5 text-[10px] sm:text-xs text-rose-400 uppercase tracking-wider font-semibold">
                                        <span>üì§</span> You Send
                                      </div>
                                      {idea.totalSendValue > 0 && (
                                        <span className="text-[10px] text-rose-400/70 font-mono">
                                          Total: {idea.totalSendValue.toLocaleString()}
                                        </span>
                                      )}
                                    </div>
                                    <div className="space-y-1 sm:space-y-1.5">
                                      {idea.send?.map((player: any, pIdx: number) => (
                                        <div key={pIdx} className="flex items-center gap-1.5 sm:gap-2 p-1.5 sm:p-2 rounded-lg bg-rose-500/10 border border-rose-500/20">
                                          <PlayerBadge name={player.name} sleeperId={player.id} position={player.position} team={player.team} size="sm" className="flex-1 min-w-0" />
                                          {player.value > 0 && (
                                            <span className="text-[9px] sm:text-[10px] px-1 sm:px-1.5 py-0.5 rounded bg-rose-500/20 text-rose-300 font-mono flex-shrink-0">{player.value.toLocaleString()}</span>
                                          )}
                                        </div>
                                      ))}
                                      {idea.picksSend?.map((pick: any, pIdx: number) => (
                                        <div key={`pick-s-${pIdx}`} className="flex items-center gap-1.5 sm:gap-2 p-1.5 sm:p-2 rounded-lg bg-rose-500/10 border border-rose-500/20">
                                          <span className="px-1 py-0.5 text-[9px] sm:text-[10px] rounded bg-amber-500/30 text-amber-300 font-semibold flex-shrink-0">PICK</span>
                                          <span className="text-xs sm:text-sm text-white font-medium flex-1 min-w-0 truncate">{pick.season} {pick.slot ? `${pick.round}.${String(pick.slot).padStart(2, '0')}` : `Round ${pick.round}`}</span>
                                          <span className="text-[9px] sm:text-[10px] px-1 sm:px-1.5 py-0.5 rounded bg-amber-500/20 text-amber-300 font-mono flex-shrink-0">{pick.value?.toLocaleString()}</span>
                                        </div>
                                      ))}
                                      {idea.faabSend > 0 && (
                                        <div className="flex items-center gap-1.5 sm:gap-2 p-1.5 sm:p-2 rounded-lg bg-rose-500/10 border border-rose-500/20">
                                          <span className="px-1 py-0.5 text-[9px] sm:text-[10px] rounded bg-green-500/30 text-green-300 font-semibold flex-shrink-0">FAAB</span>
                                          <span className="text-xs sm:text-sm text-white font-medium flex-1">${idea.faabSend}</span>
                                        </div>
                                      )}
                                    </div>
                                  </div>
                                  
                                  {/* You Receive */}
                                  <div className="space-y-1.5 sm:space-y-2">
                                    <div className="flex items-center justify-between">
                                      <div className="flex items-center gap-1.5 text-[10px] sm:text-xs text-emerald-400 uppercase tracking-wider font-semibold">
                                        <span>üì•</span> You Receive
                                      </div>
                                      {idea.totalReceiveValue > 0 && (
                                        <span className="text-[10px] text-emerald-400/70 font-mono">
                                          Total: {idea.totalReceiveValue.toLocaleString()}
                                        </span>
                                      )}
                                    </div>
                                    <div className="space-y-1 sm:space-y-1.5">
                                      {idea.receive?.map((player: any, pIdx: number) => (
                                        <div key={pIdx} className="flex items-center gap-1.5 sm:gap-2 p-1.5 sm:p-2 rounded-lg bg-emerald-500/10 border border-emerald-500/20">
                                          <PlayerBadge name={player.name} sleeperId={player.id} position={player.position} team={player.team} size="sm" className="flex-1 min-w-0" />
                                          {player.value > 0 && (
                                            <span className="text-[9px] sm:text-[10px] px-1 sm:px-1.5 py-0.5 rounded bg-emerald-500/20 text-emerald-300 font-mono flex-shrink-0">{player.value.toLocaleString()}</span>
                                          )}
                                        </div>
                                      ))}
                                      {idea.picksReceive?.map((pick: any, pIdx: number) => (
                                        <div key={`pick-r-${pIdx}`} className="flex items-center gap-1.5 sm:gap-2 p-1.5 sm:p-2 rounded-lg bg-emerald-500/10 border border-emerald-500/20">
                                          <span className="px-1 py-0.5 text-[9px] sm:text-[10px] rounded bg-amber-500/30 text-amber-300 font-semibold flex-shrink-0">PICK</span>
                                          <span className="text-xs sm:text-sm text-white font-medium flex-1 min-w-0 truncate">{pick.season} {pick.slot ? `${pick.round}.${String(pick.slot).padStart(2, '0')}` : `Round ${pick.round}`}</span>
                                          <span className="text-[9px] sm:text-[10px] px-1 sm:px-1.5 py-0.5 rounded bg-amber-500/20 text-amber-300 font-mono flex-shrink-0">{pick.value?.toLocaleString()}</span>
                                        </div>
                                      ))}
                                      {idea.faabReceive > 0 && (
                                        <div className="flex items-center gap-1.5 sm:gap-2 p-1.5 sm:p-2 rounded-lg bg-emerald-500/10 border border-emerald-500/20">
                                          <span className="px-1 py-0.5 text-[9px] sm:text-[10px] rounded bg-green-500/30 text-green-300 font-semibold flex-shrink-0">FAAB</span>
                                          <span className="text-xs sm:text-sm text-white font-medium flex-1">${idea.faabReceive}</span>
                                        </div>
                                      )}
                                    </div>
                                  </div>
                                </div>
                                
                                {/* Value Summary Bar */}
                                {(idea.totalSendValue > 0 || idea.totalReceiveValue > 0) && (
                                  <div className="px-3 sm:px-4 pb-2">
                                    <div className="flex items-center justify-around text-[9px] sm:text-[10px] p-2 rounded-lg bg-white/5 border border-white/10 gap-2">
                                      <div className="flex items-center gap-1">
                                        <span className="text-white/50">Diff:</span>
                                        <span className={idea.valueDiff >= 0 ? 'text-emerald-400 font-semibold' : 'text-rose-400 font-semibold'}>
                                          {idea.valueDiff >= 0 ? '+' : ''}{idea.valueDiff?.toLocaleString()}
                                        </span>
                                      </div>
                                      <span className="text-white/20">|</span>
                                      <div className="flex items-center gap-1">
                                        <span className="text-white/50">Fairness:</span>
                                        <span className={idea.fairnessScore >= 85 ? 'text-emerald-400' : idea.fairnessScore >= 70 ? 'text-amber-400' : 'text-rose-400'}>
                                          {idea.fairnessScore}%
                                        </span>
                                      </div>
                                    </div>
                                  </div>
                                )}
                                
                                {/* Analysis Section */}
                                <div className="p-3 sm:p-4 pt-0 space-y-2 sm:space-y-3">
                                  {idea.whyForYou && (
                                    <div className="p-2.5 sm:p-3 rounded-lg bg-cyan-500/5 border border-cyan-500/20">
                                      <div className="text-[9px] sm:text-[10px] text-cyan-400 uppercase tracking-wider font-semibold mb-1">Why You Should Make This Trade</div>
                                      <p className="text-[11px] sm:text-xs text-white/70 leading-relaxed">{idea.whyForYou}</p>
                                    </div>
                                  )}
                                  
                                  {idea.whyTheyAccept && (
                                    <div className="p-2.5 sm:p-3 rounded-lg bg-purple-500/5 border border-purple-500/20">
                                      <div className="text-[9px] sm:text-[10px] text-purple-400 uppercase tracking-wider font-semibold mb-1">Why They Would Accept</div>
                                      <p className="text-[11px] sm:text-xs text-white/70 leading-relaxed">{idea.whyTheyAccept}</p>
                                    </div>
                                  )}
                                  
                                  {/* Value Analysis */}
                                  {idea.valueAnalysis && (
                                    <div className="text-xs text-white/50 italic border-t border-white/5 pt-2">
                                      üí∞ {idea.valueAnalysis}
                                    </div>
                                  )}
                                </div>
                                
                                {/* Urgency Badge */}
                                {idea.urgency === 'high' && (
                                  <div className="px-4 pb-3">
                                    <span className="inline-flex items-center gap-1 px-2 py-1 text-[10px] rounded-full bg-orange-500/20 text-orange-400 border border-orange-500/30">
                                      üî• High Priority - Act Fast
                                    </span>
                                  </div>
                                )}
                              </div>
                            ))}
                          </div>
                        ) : tradeIdeasLoading ? null : tradeIdeasError ? null : tradeIdeasOpportunities.length > 0 ? (
                          <div className="mt-6 space-y-3">
                            <div className="text-center py-2">
                              <p className="text-sm font-medium text-white/70">No clean market wins today. Best options are:</p>
                            </div>
                            {tradeIdeasOpportunities.map((opp: any, idx: number) => (
                              <div key={idx} className="p-3 sm:p-4 rounded-xl bg-gradient-to-b from-slate-900/80 to-slate-800/50 border border-white/10 space-y-2">
                                <div className="flex items-start justify-between gap-2">
                                  <div className="flex items-start gap-2 min-w-0 flex-1">
                                    <span className="text-lg sm:text-xl flex-shrink-0">{opp.icon}</span>
                                    <div className="min-w-0">
                                      <h4 className="text-xs sm:text-sm font-bold text-white leading-tight">{opp.title}</h4>
                                      {opp.targetManager && <span className="text-[10px] text-white/40 truncate block">Target: {opp.targetManager}</span>}
                                    </div>
                                  </div>
                                  <div className="flex items-center gap-1 flex-shrink-0">
                                    {opp.actionable && <span className="px-1 py-0.5 rounded text-[8px] sm:text-[9px] font-bold bg-emerald-500/20 text-emerald-300 border border-emerald-500/20">GO</span>}
                                    <span className={`px-1.5 py-0.5 rounded text-[9px] font-bold ${opp.confidence >= 60 ? 'bg-emerald-500/20 text-emerald-300' : opp.confidence >= 40 ? 'bg-amber-500/20 text-amber-300' : 'bg-slate-500/20 text-slate-300'}`}>{opp.confidence}%</span>
                                  </div>
                                </div>
                                <p className="text-xs text-white/50">{opp.description}</p>
                                {opp.relevantPlayers?.length > 0 && (
                                  <div className="space-y-1">
                                    {opp.relevantPlayers.map((player: any, pIdx: number) => (
                                      <div key={pIdx} className="flex items-center gap-2 p-1.5 rounded-lg bg-black/20 border border-white/5">
                                        <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded flex-shrink-0 ${
                                          player.position === 'QB' ? 'bg-red-500/20 text-red-300' :
                                          player.position === 'RB' ? 'bg-blue-500/20 text-blue-300' :
                                          player.position === 'WR' ? 'bg-green-500/20 text-green-300' :
                                          player.position === 'TE' ? 'bg-orange-500/20 text-orange-300' :
                                          'bg-purple-500/20 text-purple-300'
                                        }`}>{player.position}</span>
                                        <MiniPlayerImg sleeperId={player.id} name={player.name} size={18} />
                                        <span className="text-xs text-white font-medium flex-1 truncate">{player.name}</span>
                                        {player.value > 0 && <span className="text-[10px] text-white/30 font-mono">{player.value.toLocaleString()}</span>}
                                      </div>
                                    ))}
                                    <p className="text-[10px] text-white/30 italic mt-1">{opp.relevantPlayers[0]?.reason}</p>
                                  </div>
                                )}
                              </div>
                            ))}
                          </div>
                        ) : (
                          <div className="mt-6 p-8 rounded-xl bg-gradient-to-b from-slate-900/80 to-slate-800/50 border border-white/10 text-center">
                            <div className="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-br from-purple-500/20 to-cyan-500/20 flex items-center justify-center">
                              <span className="text-3xl">üèÜ</span>
                            </div>
                            <h4 className="text-lg font-bold text-white mb-2">Your Team is Well-Balanced</h4>
                            <p className="text-sm text-white/50 mb-4">
                              No urgent moves needed right now. Check back as values shift!
                            </p>
                          </div>
                        )}
                      </div>
                    </div>

                    {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                        GOAL-DRIVEN AI TRADE PROPOSAL GENERATOR
                    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
                    {tradeHubLeague && (
                    <div className="rounded-2xl bg-black/30 border border-white/10 overflow-hidden">
                      <div className="p-4 sm:p-6 border-b border-white/5">
                        <div className="flex items-center gap-3">
                          <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-violet-500/30 to-amber-500/30 flex items-center justify-center text-xl">üß†</div>
                          <div>
                            <h3 className="text-lg font-bold text-white">Goal-Driven Trade Proposals</h3>
                            <p className="text-xs text-white/50">Tell the AI what you need ‚Äî it finds the best partners and builds the deals</p>
                          </div>
                        </div>
                      </div>

                      <div className="p-4 sm:p-6 space-y-4">
                        <div>
                          <label className="block text-xs font-medium text-white/60 mb-2">What do you want to accomplish?</label>
                          <div className="grid grid-cols-2 sm:grid-cols-3 gap-2">
                            {[
                              { value: 'rb_depth', label: 'Add RB Depth', icon: 'üèÉ' },
                              { value: 'wr_depth', label: 'Add WR Depth', icon: 'üéØ' },
                              { value: 'qb_upgrade', label: 'Upgrade QB', icon: 'üèà' },
                              { value: 'te_upgrade', label: 'Upgrade TE', icon: 'ü§ö' },
                              { value: 'get_younger_rb', label: 'Get Younger (RB)', icon: '‚ö°' },
                              { value: 'get_younger_wr', label: 'Get Younger (WR)', icon: '‚ú®' },
                              { value: 'acquire_picks', label: 'Acquire Picks', icon: 'üìã' },
                              { value: 'win_now', label: 'Win Now', icon: 'üèÜ' },
                              { value: 'rebuild', label: 'Rebuild', icon: 'üî®' },
                            ].map(g => (
                              <button
                                key={g.value}
                                onClick={() => setGoalProposalGoal(goalProposalGoal === g.value ? '' : g.value)}
                                className={`flex items-center gap-2 px-3 py-2.5 rounded-xl text-xs font-medium transition-all ${
                                  goalProposalGoal === g.value
                                    ? 'bg-violet-500/25 border border-violet-400/50 text-violet-200 ring-1 ring-violet-400/20 shadow-lg shadow-violet-500/10'
                                    : 'bg-white/5 border border-white/10 text-white/70 hover:bg-white/10 hover:border-white/20'
                                }`}
                              >
                                <span>{g.icon}</span>
                                <span>{g.label}</span>
                              </button>
                            ))}
                          </div>
                        </div>

                        <button
                          onClick={generateGoalProposals}
                          disabled={goalProposalLoading || !goalProposalGoal}
                          className="w-full py-3.5 rounded-xl font-bold text-white transition disabled:opacity-50 disabled:cursor-not-allowed
                            bg-gradient-to-r from-violet-500 to-amber-500 hover:from-violet-400 hover:to-amber-400
                            shadow-[0_8px_30px_rgba(0,0,0,0.3)] flex items-center justify-center gap-2"
                        >
                          {goalProposalLoading ? (
                            <><span className="animate-spin">‚öôÔ∏è</span> Finding Partners &amp; Building Deals...</>
                          ) : (
                            <><span>üß†</span> Find Trade Partners</>
                          )}
                        </button>

                        {goalProposalError && (
                          <div className="p-3 rounded-xl bg-rose-500/10 border border-rose-500/20 text-sm text-rose-400 text-center">
                            {goalProposalError}
                          </div>
                        )}

                        {goalProposalResult && goalProposalResult.partners?.length > 0 && (
                          <div className="space-y-4 mt-2">
                            <div className="flex items-center justify-between flex-wrap gap-2">
                              <div className="flex items-center gap-2">
                                <span className="text-sm font-semibold text-white">{goalProposalResult.goalDescription}</span>
                                <span className="px-2 py-0.5 text-[10px] rounded-full bg-violet-500/20 text-violet-300 border border-violet-400/30">
                                  {goalProposalResult.partners.length} partners found
                                </span>
                              </div>
                              <span className="text-[10px] text-white/40">
                                {goalProposalResult.stats?.proposalsBuilt || 0} proposals built
                              </span>
                            </div>

                            {goalProposalResult.partners.map((partner: any, pIdx: number) => {
                              const isExpanded = goalProposalExpandedPartner === pIdx
                              return (
                                <div key={partner.rosterId} className="rounded-xl bg-black/40 border border-white/10 overflow-hidden">
                                  <button
                                    onClick={() => setGoalProposalExpandedPartner(isExpanded ? null : pIdx)}
                                    className="w-full p-4 flex items-center justify-between gap-3 text-left hover:bg-white/5 transition"
                                  >
                                    <div className="flex items-center gap-3 min-w-0">
                                      <div className="w-8 h-8 rounded-full bg-gradient-to-br from-violet-500/30 to-amber-500/30 flex items-center justify-center text-sm font-bold text-white/80">
                                        {pIdx + 1}
                                      </div>
                                      <div className="min-w-0">
                                        <div className="text-sm font-semibold text-white truncate">{partner.displayName}</div>
                                        <div className="flex flex-wrap gap-1 mt-1">
                                          <span className={`px-1.5 py-0.5 text-[9px] rounded font-medium ${
                                            partner.contenderTier === 'contender' ? 'bg-emerald-500/20 text-emerald-300' :
                                            partner.contenderTier === 'rebuild' ? 'bg-amber-500/20 text-amber-300' :
                                            'bg-white/10 text-white/50'
                                          }`}>
                                            {partner.contenderTier === 'contender' ? 'Contender' : partner.contenderTier === 'rebuild' ? 'Rebuilding' : 'Middle'}
                                          </span>
                                          {partner.record && (
                                            <span className="px-1.5 py-0.5 text-[9px] rounded bg-white/10 text-white/50">
                                              {partner.record.wins}-{partner.record.losses}
                                            </span>
                                          )}
                                        </div>
                                      </div>
                                    </div>
                                    <div className="flex items-center gap-2 flex-shrink-0">
                                      <span className="px-2 py-1 text-[10px] rounded-full bg-violet-500/15 text-violet-300 border border-violet-500/20">
                                        {partner.proposals?.length || 0} proposals
                                      </span>
                                      <span className={`text-white/40 transition-transform ${isExpanded ? 'rotate-180' : ''}`}>&#9660;</span>
                                    </div>
                                  </button>

                                  {isExpanded && partner.matchReasons?.length > 0 && (
                                    <div className="px-4 pb-2 flex flex-wrap gap-1">
                                      {partner.matchReasons.map((r: string, rIdx: number) => (
                                        <span key={rIdx} className="px-2 py-0.5 text-[10px] rounded-full bg-violet-500/10 text-violet-300/80 border border-violet-500/15">
                                          {r}
                                        </span>
                                      ))}
                                    </div>
                                  )}

                                  {isExpanded && partner.proposals?.map((proposal: any, tIdx: number) => {
                                    const tierIcon = proposal.tier === 'safe' ? 'üõ°Ô∏è' : proposal.tier === 'aggressive' ? 'üî•' : 'üí°'
                                    const tierBg = proposal.tier === 'safe'
                                      ? 'from-emerald-500/10 to-emerald-500/5 border-emerald-500/20'
                                      : proposal.tier === 'aggressive'
                                      ? 'from-amber-500/10 to-amber-500/5 border-amber-500/20'
                                      : 'from-purple-500/10 to-purple-500/5 border-purple-500/20'
                                    const tierBadge = proposal.tier === 'safe'
                                      ? 'bg-emerald-500/20 text-emerald-300'
                                      : proposal.tier === 'aggressive'
                                      ? 'bg-amber-500/20 text-amber-300'
                                      : 'bg-purple-500/20 text-purple-300'
                                    return (
                                      <div key={tIdx} className={`mx-4 mb-4 rounded-xl bg-gradient-to-br ${tierBg} border overflow-hidden`}>
                                        <div className="p-2.5 sm:p-3 border-b border-white/5 flex items-center justify-between gap-2">
                                          <div className="flex items-center gap-1.5 sm:gap-2 min-w-0">
                                            <span className="text-sm sm:text-base flex-shrink-0">{tierIcon}</span>
                                            <span className={`px-2 py-0.5 sm:px-2.5 sm:py-1 rounded-full text-[9px] sm:text-[10px] font-bold uppercase tracking-wider ${tierBadge} truncate`}>
                                              {proposal.tierLabel}
                                            </span>
                                          </div>
                                          <div className="flex items-center gap-2 sm:gap-3 text-[10px] sm:text-[11px] flex-shrink-0">
                                            <span className="text-white/50"><span className="text-white font-semibold">{proposal.fairnessScore}</span></span>
                                            <span className={`font-semibold ${
                                              proposal.acceptProb >= 60 ? 'text-emerald-400' :
                                              proposal.acceptProb >= 35 ? 'text-amber-400' :
                                              'text-rose-400'
                                            }`}>{proposal.acceptProb}%</span>
                                          </div>
                                        </div>

                                        <div className="p-3">
                                          <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                                            <div>
                                              <div className="text-[10px] uppercase tracking-wider text-rose-400/60 mb-1.5 font-semibold">You Send</div>
                                              <div className="space-y-1">
                                                {proposal.give?.map((a: any, aIdx: number) => (
                                                  <div key={aIdx} className="flex items-center gap-1.5 p-1.5 rounded-lg bg-rose-500/10 border border-rose-500/15 text-xs">
                                                    <span className={`px-1 py-0.5 text-[9px] rounded font-semibold ${
                                                      a.type === 'PICK' ? 'bg-amber-500/30 text-amber-300' :
                                                      a.pos === 'QB' ? 'bg-red-500/30 text-red-300' :
                                                      a.pos === 'RB' ? 'bg-cyan-500/30 text-cyan-300' :
                                                      a.pos === 'WR' ? 'bg-green-500/30 text-green-300' :
                                                      a.pos === 'TE' ? 'bg-orange-500/30 text-orange-300' :
                                                      'bg-white/20 text-white/60'
                                                    }`}>{a.type === 'PICK' ? 'PICK' : a.pos || '?'}</span>
                                                    {a.type !== 'PICK' && <MiniPlayerImg sleeperId={a.id} name={a.name} size={18} />}
                                                    <span className="text-white/80 flex-1 truncate">{a.name}</span>
                                                    <span className="text-white/30 font-mono text-[10px]">{a.value?.toLocaleString()}</span>
                                                  </div>
                                                ))}
                                              </div>
                                              <div className="text-right text-[10px] text-rose-400/50 font-mono mt-1">Total: {proposal.giveTotal?.toLocaleString()}</div>
                                            </div>
                                            <div>
                                              <div className="text-[10px] uppercase tracking-wider text-emerald-400/60 mb-1.5 font-semibold">You Get</div>
                                              <div className="space-y-1">
                                                {proposal.receive?.map((a: any, aIdx: number) => (
                                                  <div key={aIdx} className="flex items-center gap-1.5 p-1.5 rounded-lg bg-emerald-500/10 border border-emerald-500/15 text-xs">
                                                    <span className={`px-1 py-0.5 text-[9px] rounded font-semibold ${
                                                      a.type === 'PICK' ? 'bg-amber-500/30 text-amber-300' :
                                                      a.pos === 'QB' ? 'bg-red-500/30 text-red-300' :
                                                      a.pos === 'RB' ? 'bg-cyan-500/30 text-cyan-300' :
                                                      a.pos === 'WR' ? 'bg-green-500/30 text-green-300' :
                                                      a.pos === 'TE' ? 'bg-orange-500/30 text-orange-300' :
                                                      'bg-white/20 text-white/60'
                                                    }`}>{a.type === 'PICK' ? 'PICK' : a.pos || '?'}</span>
                                                    {a.type !== 'PICK' && <MiniPlayerImg sleeperId={a.id} name={a.name} size={18} />}
                                                    <span className="text-white/80 flex-1 truncate">{a.name}</span>
                                                    <span className="text-white/30 font-mono text-[10px]">{a.value?.toLocaleString()}</span>
                                                  </div>
                                                ))}
                                              </div>
                                              <div className="text-right text-[10px] text-emerald-400/50 font-mono mt-1">Total: {proposal.receiveTotal?.toLocaleString()}</div>
                                            </div>
                                          </div>

                                          {proposal.topDrivers?.length > 0 && (
                                            <div className="rounded-lg bg-black/30 border border-white/10 p-2.5 mb-3">
                                              <div className="text-[10px] text-white/40 font-semibold uppercase mb-1.5">Key Drivers</div>
                                              <div className="flex flex-wrap gap-1.5">
                                                {proposal.topDrivers.slice(0, 3).map((d: any, dIdx: number) => (
                                                  <span key={dIdx} className={`inline-flex items-center gap-1 px-2 py-1 rounded-full text-[10px] ${
                                                    d.direction === 'for' ? 'bg-emerald-500/15 text-emerald-300/80' : 'bg-rose-500/15 text-rose-300/80'
                                                  }`}>
                                                    <span>{d.emoji}</span> {d.name}
                                                  </span>
                                                ))}
                                              </div>
                                            </div>
                                          )}

                                          {proposal.dmCopy && (
                                            <div className="rounded-lg bg-black/30 border border-white/10 p-3 space-y-2">
                                              <div className="text-[10px] text-violet-400/70 font-semibold uppercase mb-0.5">Message to Send</div>
                                              <p className="text-xs text-white/70 italic">&quot;{proposal.dmCopy.opener}&quot;</p>
                                              <p className="text-[11px] text-white/50">{proposal.dmCopy.rationale}</p>
                                              {proposal.dmCopy.fallback && (
                                                <div className="mt-1 pt-1 border-t border-white/5">
                                                  <div className="text-[10px] text-amber-400/60 font-semibold">If They Hesitate</div>
                                                  <p className="text-[11px] text-white/50 italic">&quot;{proposal.dmCopy.fallback}&quot;</p>
                                                </div>
                                              )}
                                            </div>
                                          )}

                                          {proposal.sweeteners?.length > 0 && (
                                            <div className="mt-2 flex flex-wrap gap-1.5">
                                              <span className="text-[10px] text-white/40">Sweeteners:</span>
                                              {proposal.sweeteners.map((s: any, sIdx: number) => (
                                                <span key={sIdx} className="px-2 py-0.5 text-[10px] rounded-full bg-amber-500/10 text-amber-300/70 border border-amber-500/15">
                                                  {s.suggestion} (+{s.expectedDelta}%)
                                                </span>
                                              ))}
                                            </div>
                                          )}

                                          {proposal.counterPath?.adjustments?.length > 0 && (
                                            <div className="mt-2 rounded-lg bg-cyan-500/5 border border-cyan-500/15 p-2.5">
                                              <div className="text-[10px] text-cyan-400/70 font-semibold uppercase mb-1">Counter Path</div>
                                              <p className="text-[11px] text-white/50 mb-1">{proposal.counterPath.description}</p>
                                              {proposal.counterPath.adjustments.map((adj: any, aIdx: number) => (
                                                <div key={aIdx} className="text-[10px] text-white/40 ml-2">
                                                  &bull; {adj.description} ({adj.expectedDelta > 0 ? '+' : ''}{adj.expectedDelta}%)
                                                </div>
                                              ))}
                                            </div>
                                          )}
                                        </div>
                                      </div>
                                    )
                                  })}
                                </div>
                              )
                            })}
                          </div>
                        )}

                        {goalProposalResult && goalProposalResult.partners?.length === 0 && (
                          <div className="p-6 rounded-xl bg-gradient-to-b from-slate-900/80 to-slate-800/50 border border-white/10 text-center">
                            <span className="text-3xl mb-2 block">ü§î</span>
                            <h4 className="text-sm font-bold text-white mb-1">No Strong Matches Found</h4>
                            <p className="text-xs text-white/50">Try a different goal ‚Äî your league may not have the right trade partners for this strategy right now.</p>
                          </div>
                        )}
                      </div>
                    </div>
                    )}

                    {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                        AI TRADE PROPOSAL GENERATOR
                    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
                    {tradeHubManagers.length > 0 && tradeHubTeamA && (
                    <div className="rounded-2xl bg-black/30 border border-white/10 overflow-hidden">
                      <div className="p-4 sm:p-6 border-b border-white/5">
                        <div className="flex items-center gap-3">
                          <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-emerald-500/30 to-cyan-500/30 flex items-center justify-center text-xl">üéØ</div>
                          <div>
                            <h3 className="text-lg font-bold text-white">AI Trade Proposal Generator</h3>
                            <p className="text-xs text-white/50">Pick what you want, AI builds the deal</p>
                          </div>
                        </div>
                      </div>

                      <div className="p-4 sm:p-6 space-y-4">
                        <div>
                          <label className="block text-xs font-medium text-white/60 mb-2">Select Opponent Team</label>
                          <select
                            value={proposalTargetTeam}
                            onChange={(e) => {
                              setProposalTargetTeam(e.target.value)
                              setProposalDesiredAssets([])
                              setProposalResults([])
                              setProposalError('')
                            }}
                            className="w-full px-4 py-3 rounded-xl bg-black/50 border border-white/20 text-white focus:outline-none focus:border-cyan-400/60 focus:ring-2 focus:ring-cyan-400/20 transition text-sm"
                          >
                            <option value="">Choose a team...</option>
                            {tradeHubManagers
                              .filter((m: any) => String(m.rosterId) !== tradeHubTeamA)
                              .map((m: any) => (
                                <option key={m.rosterId} value={String(m.rosterId)}>
                                  {m.displayName} ({m.record?.wins ?? 0}-{m.record?.losses ?? 0})
                                </option>
                              ))
                            }
                          </select>
                        </div>

                        {proposalTargetTeam && (() => {
                          const target = tradeHubManagers.find((m: any) => String(m.rosterId) === proposalTargetTeam)
                          if (!target) return null
                          return (
                            <div className="space-y-3">
                              <div className="flex items-center justify-between">
                                <label className="text-xs font-medium text-white/60">Tap assets you want to acquire</label>
                                {proposalDesiredAssets.length > 0 && (
                                  <span className="text-xs px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-400 border border-emerald-500/30">
                                    {proposalDesiredAssets.length} selected
                                  </span>
                                )}
                              </div>

                              <div className="space-y-2">
                                <div className="text-[10px] uppercase tracking-wider text-white/40 font-semibold">Players</div>
                                <div className="grid grid-cols-2 sm:grid-cols-3 gap-1.5 max-h-[240px] overflow-y-auto pr-1">
                                  {target.players?.map((p: any) => {
                                    const isSelected = proposalDesiredAssets.some((a: any) => a.type === 'player' && a.name === p.name)
                                    return (
                                      <button
                                        key={p.id}
                                        onClick={() => toggleProposalAsset({ type: 'player', name: p.name, pos: p.pos, team: p.team })}
                                        className={`flex items-center gap-1.5 px-2.5 py-2 rounded-lg text-left text-xs transition-all ${
                                          isSelected
                                            ? 'bg-emerald-500/20 border border-emerald-400/40 text-emerald-300 ring-1 ring-emerald-400/20'
                                            : 'bg-white/5 border border-white/10 text-white/80 hover:bg-white/10 hover:border-white/20'
                                        }`}
                                      >
                                        <PlayerBadge name={p.name} sleeperId={p.id} position={p.pos} team={p.team} size="sm" showPosition={false} />
                                        {isSelected && <span className="text-emerald-400 text-xs flex-shrink-0">‚úì</span>}
                                      </button>
                                    )
                                  })}
                                </div>
                              </div>

                              {target.draftPicks?.length > 0 && (
                                <div className="space-y-2">
                                  <div className="text-[10px] uppercase tracking-wider text-white/40 font-semibold">Draft Picks</div>
                                  <div className="grid grid-cols-2 sm:grid-cols-3 gap-1.5">
                                    {target.draftPicks?.map((pk: any, idx: number) => {
                                      const pickSlotLabel = pk.slot ? `${pk.round}.${String(pk.slot).padStart(2, '0')}` : `Rd ${pk.round}`
                                      const pickName = `${pk.season} ${pickSlotLabel}${pk.originalOwner && pk.originalOwner !== target.displayName ? ` (${pk.originalOwner})` : ''}`
                                      const isSelected = proposalDesiredAssets.some((a: any) => a.type === 'pick' && a.pickYear === parseInt(pk.season) && a.pickRound === pk.round && a.originalOwner === (pk.originalOwner || target.displayName))
                                      return (
                                        <button
                                          key={idx}
                                          onClick={() => toggleProposalAsset({ type: 'pick', name: pickName, pickYear: parseInt(pk.season), pickRound: pk.round, pickSlot: pk.slot, originalOwner: pk.originalOwner || target.displayName })}
                                          className={`flex items-center gap-1.5 px-2.5 py-2 rounded-lg text-left text-xs transition-all ${
                                            isSelected
                                              ? 'bg-amber-500/20 border border-amber-400/40 text-amber-300 ring-1 ring-amber-400/20'
                                              : 'bg-white/5 border border-white/10 text-white/80 hover:bg-white/10 hover:border-white/20'
                                          }`}
                                        >
                                          <span className="px-1 py-0.5 text-[9px] rounded bg-amber-500/30 text-amber-300 font-semibold">PICK</span>
                                          <span className="truncate flex-1">{pickName}</span>
                                          {isSelected && <span className="text-amber-400 text-xs flex-shrink-0">‚úì</span>}
                                        </button>
                                      )
                                    })}
                                  </div>
                                </div>
                              )}

                              {proposalDesiredAssets.length > 0 && (
                                <div className="rounded-xl bg-gradient-to-r from-emerald-500/10 to-cyan-500/10 border border-emerald-500/20 p-3">
                                  <div className="text-[10px] uppercase tracking-wider text-emerald-400/70 mb-2 font-semibold">You Want</div>
                                  <div className="flex flex-wrap gap-1.5">
                                    {proposalDesiredAssets.map((a, idx) => (
                                      <span key={idx} className="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs bg-emerald-500/20 text-emerald-300 border border-emerald-400/30">
                                        {a.type === 'pick' ? 'üìã' : 'üèà'} {a.name}
                                        <button onClick={() => toggleProposalAsset(a)} className="ml-0.5 text-emerald-400/60 hover:text-rose-400 transition">√ó</button>
                                      </span>
                                    ))}
                                  </div>
                                </div>
                              )}

                              <button
                                onClick={generateTradeProposals}
                                disabled={proposalLoading || proposalDesiredAssets.length === 0}
                                className="w-full py-3.5 rounded-xl font-bold text-white transition disabled:opacity-50 disabled:cursor-not-allowed
                                  bg-gradient-to-r from-emerald-500 to-cyan-500 hover:from-emerald-400 hover:to-cyan-400
                                  shadow-[0_8px_30px_rgba(0,0,0,0.3)] flex items-center justify-center gap-2"
                              >
                                {proposalLoading ? (
                                  <>
                                    <span className="animate-spin">‚öôÔ∏è</span> Building Proposals...
                                  </>
                                ) : (
                                  <>
                                    <span>üéØ</span> Generate 3 Trade Proposals
                                  </>
                                )}
                              </button>
                            </div>
                          )
                        })()}

                        {proposalError && (
                          <div className="p-3 rounded-xl bg-rose-500/10 border border-rose-500/20 text-sm text-rose-400 text-center">
                            {proposalError}
                          </div>
                        )}

                        {proposalResults.length > 0 && (
                          <div className="space-y-4 mt-2">
                            <div className="flex items-center justify-between flex-wrap gap-2">
                              <div className="flex items-center gap-2">
                                <span className="text-sm font-semibold text-white">AI Trade Proposals</span>
                                <span className="px-2 py-0.5 text-[10px] rounded-full bg-emerald-500/20 text-emerald-300 border border-emerald-400/30">
                                  {proposalResults.length} options
                                </span>
                              </div>
                              <label className="flex items-center gap-2 cursor-pointer select-none">
                                <span className="text-[11px] text-white/60">Optimize for Acceptance</span>
                                <div className="relative">
                                  <input
                                    type="checkbox"
                                    className="sr-only"
                                    checked={optimizeForAcceptance}
                                    onChange={() => setOptimizeForAcceptance(v => !v)}
                                  />
                                  <div className={`w-8 h-4 rounded-full transition ${optimizeForAcceptance ? 'bg-purple-500' : 'bg-white/20'}`} />
                                  <div className={`absolute top-0.5 left-0.5 w-3 h-3 rounded-full bg-white transition-transform ${optimizeForAcceptance ? 'translate-x-4' : ''}`} />
                                </div>
                              </label>
                            </div>

                            {(optimizeForAcceptance && proposalBestAcceptIdx !== null
                              ? [proposalResults[proposalBestAcceptIdx], ...proposalResults.filter((_: any, i: number) => i !== proposalBestAcceptIdx)]
                              : proposalResults
                            ).map((proposal: any, idx: number) => {
                              if (!proposal) return null
                              const isBestAcceptance = optimizeForAcceptance && idx === 0 && proposalBestAcceptIdx !== null
                              const labelColor = proposal.label === 'Slight Edge' ? 'emerald' :
                                proposal.label === 'Fair & Balanced' ? 'cyan' : 'amber'
                              const borderClass = isBestAcceptance ? 'border-purple-500/40 ring-1 ring-purple-500/20' : `border-${labelColor}-500/30`
                              const bgGrad = proposal.label === 'Slight Edge' ? 'from-emerald-500/10 to-emerald-500/5' :
                                proposal.label === 'Fair & Balanced' ? 'from-cyan-500/10 to-cyan-500/5' :
                                'from-amber-500/10 to-amber-500/5'
                              const labelBg = proposal.label === 'Slight Edge' ? 'bg-emerald-500/30 text-emerald-200' :
                                proposal.label === 'Fair & Balanced' ? 'bg-cyan-500/30 text-cyan-200' :
                                'bg-amber-500/30 text-amber-200'
                              const labelIcon = proposal.label === 'Slight Edge' ? 'üìä' :
                                proposal.label === 'Fair & Balanced' ? 'ü§ù' : 'üéÅ'
                              return (
                                <div key={`${proposal.label}-${idx}`} className={`rounded-xl bg-gradient-to-br ${bgGrad} border ${borderClass} overflow-hidden`}>
                                  {isBestAcceptance && (
                                    <div className="px-4 py-1.5 bg-purple-500/15 border-b border-purple-500/20 flex items-center gap-2">
                                      <span className="text-[10px] font-bold uppercase tracking-wider text-purple-300">Best Acceptance Chance</span>
                                    </div>
                                  )}
                                  <div className="p-3 sm:p-4 border-b border-white/5 flex items-center justify-between gap-2">
                                    <div className="flex items-center gap-1.5 sm:gap-2">
                                      <span className="text-base sm:text-lg flex-shrink-0">{labelIcon}</span>
                                      <span className={`px-2 py-0.5 sm:px-3 sm:py-1 rounded-full text-[10px] sm:text-xs font-bold ${labelBg}`}>
                                        {proposal.label}
                                      </span>
                                    </div>
                                    <div className="flex items-center gap-2 sm:gap-3 text-[10px] sm:text-xs flex-shrink-0">
                                      <span className="text-white/50"><span className="text-white font-semibold">{proposal.fairnessScore}</span></span>
                                      {proposal.acceptanceModel && (
                                        <AcceptanceMeter data={proposal.acceptanceModel as AcceptanceModelData} compact />
                                      )}
                                    </div>
                                  </div>

                                  <div className="p-4">
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                                      <div>
                                        <div className="text-[10px] uppercase tracking-wider text-rose-400/60 mb-1.5 font-semibold">You Send</div>
                                        <div className="space-y-1">
                                          {proposal.myOffer?.map((a: any, aIdx: number) => (
                                            <div key={aIdx} className="flex items-center gap-1.5 p-1.5 rounded-lg bg-rose-500/10 border border-rose-500/15 text-xs">
                                              <span className={`px-1 py-0.5 text-[9px] rounded font-semibold ${
                                                a.type === 'pick' ? 'bg-amber-500/30 text-amber-300' :
                                                a.pos === 'QB' ? 'bg-red-500/30 text-red-300' :
                                                a.pos === 'RB' ? 'bg-cyan-500/30 text-cyan-300' :
                                                a.pos === 'WR' ? 'bg-green-500/30 text-green-300' :
                                                a.pos === 'TE' ? 'bg-orange-500/30 text-orange-300' :
                                                'bg-white/20 text-white/60'
                                              }`}>{a.type === 'pick' ? 'PICK' : a.pos || '?'}</span>
                                              {a.type !== 'pick' && <MiniPlayerImg sleeperId={a.id} name={a.name} size={18} />}
                                              <span className="text-white/80 flex-1 min-w-0 truncate">{a.name}</span>
                                              <span className="text-white/30 font-mono text-[10px] flex-shrink-0">{a.value?.toLocaleString()}</span>
                                            </div>
                                          ))}
                                        </div>
                                        <div className="text-right text-[10px] text-rose-400/50 font-mono mt-1">Total: {proposal.myTotal?.toLocaleString()}</div>
                                      </div>
                                      <div>
                                        <div className="text-[10px] uppercase tracking-wider text-emerald-400/60 mb-1.5 font-semibold">You Get</div>
                                        <div className="space-y-1">
                                          {proposal.theirOffer?.map((a: any, aIdx: number) => (
                                            <div key={aIdx} className="flex items-center gap-1.5 p-1.5 rounded-lg bg-emerald-500/10 border border-emerald-500/15 text-xs">
                                              <span className={`px-1 py-0.5 text-[9px] rounded font-semibold flex-shrink-0 ${
                                                a.type === 'pick' ? 'bg-amber-500/30 text-amber-300' :
                                                a.pos === 'QB' ? 'bg-red-500/30 text-red-300' :
                                                a.pos === 'RB' ? 'bg-cyan-500/30 text-cyan-300' :
                                                a.pos === 'WR' ? 'bg-green-500/30 text-green-300' :
                                                a.pos === 'TE' ? 'bg-orange-500/30 text-orange-300' :
                                                'bg-white/20 text-white/60'
                                              }`}>{a.type === 'pick' ? 'PICK' : a.pos || '?'}</span>
                                              {a.type !== 'pick' && <MiniPlayerImg sleeperId={a.id} name={a.name} size={18} />}
                                              <span className="text-white/80 flex-1 min-w-0 truncate">{a.name}</span>
                                              <span className="text-white/30 font-mono text-[10px]">{a.value?.toLocaleString()}</span>
                                            </div>
                                          ))}
                                        </div>
                                        <div className="text-right text-[10px] text-emerald-400/50 font-mono mt-1">Total: {proposal.theirTotal?.toLocaleString()}</div>
                                      </div>
                                    </div>

                                    {proposal.theirPitch && (
                                      <div className="rounded-lg bg-black/30 border border-white/10 p-3 space-y-2">
                                        {proposal.yourAdvantage && (
                                          <div>
                                            <div className="text-[10px] text-emerald-400/70 font-semibold uppercase mb-0.5">Your Advantage</div>
                                            <p className="text-xs text-white/70">{proposal.yourAdvantage}</p>
                                          </div>
                                        )}
                                        <div>
                                          <div className="text-[10px] text-cyan-400/70 font-semibold uppercase mb-0.5">Why They&apos;d Accept</div>
                                          <p className="text-xs text-white/70">{proposal.theirPitch}</p>
                                        </div>
                                        {proposal.tradePitch && (
                                          <div>
                                            <div className="text-[10px] text-purple-400/70 font-semibold uppercase mb-0.5">Trade Pitch</div>
                                            <p className="text-xs text-white/60 italic">&quot;{proposal.tradePitch}&quot;</p>
                                          </div>
                                        )}
                                        {proposal.fairnessNote && (
                                          <div className="mt-1 pt-2 border-t border-white/5">
                                            <p className="text-[10px] text-amber-400/70 italic">{proposal.fairnessNote}</p>
                                          </div>
                                        )}
                                      </div>
                                    )}

                                    {proposal.acceptanceModel && (
                                      <div className="mt-3">
                                        <AcceptanceMeter
                                          data={proposal.acceptanceModel as AcceptanceModelData}
                                          showOptimizations={true}
                                        />
                                      </div>
                                    )}
                                  </div>
                                </div>
                              )
                            })}
                          </div>
                        )}
                      </div>
                    </div>
                    )}
                  </div>
                )}

                {activeTab === 'finder' && (
                  <TradeFinderV2
                    leagues={leagues.map(lg => ({
                      league_id: lg.league_id,
                      name: lg.name,
                      season: lg.season,
                      type: lg.type,
                      scoring: lg.scoring,
                      is_sf: lg.is_sf,
                      team_count: lg.team_count,
                    }))}
                    username={username}
                    sleeperUserId={profile?.sleeper_user_id}
                    selectedLeague={finderSelectedLeague}
                    onLeagueChange={setFinderSelectedLeague}
                    userRosterId={finderUserRosterId}
                  />
                )}

                {/* LEGACY_FINDER_REMOVED_MARKER */}
                {false && (
                  <>
                  {/* Hero Metric - old finder code preserved but hidden */}
                  {(() => {
                    const top = selectTopTradeCandidate(tradeSuggestions ?? []);
                    return (
                      <HeroMetricAI
                        value={formatTradeHeadline(top)}
                        label="Top Trade"
                        helper="Best offer that fits league fairness + opponent needs"
                        accent="cyan"
                        confidence={top?.ai?.confidence}
                        whyBullets={[
                          ...(top?.explanation?.whyYouAccept ?? []),
                          ...(top?.ai?.targetWhy ?? []),
                        ].filter(Boolean).slice(0, 4)}
                      />
                    );
                  })()}
                  {/* Tab Headline */}
                  <p className="text-center text-sm sm:text-base text-white/60 mb-4">Discover trades that actually improve your roster.</p>
                  <div className="bg-black/30 border border-cyan-500/20 rounded-2xl p-4 sm:p-6">
                    <h3 className="text-lg sm:text-xl font-bold text-cyan-400 mb-3 sm:mb-4">Trade Finder</h3>
                    <p className="text-sm sm:text-base text-gray-400 mb-4">
                      AI analyzes all teams in your league and finds the best trade opportunities for you.
                    </p>
                    
                    {/* Trade History Learning Notification */}
                    {tradeHistoryNotification?.leagueId === finderSelectedLeague && tradeHistoryNotification != null && (
                      <div className="mb-4 p-3 bg-gradient-to-r from-emerald-500/20 to-cyan-500/20 border border-emerald-500/30 rounded-xl flex items-center gap-3 animate-pulse">
                        <span className="text-xl">üß†</span>
                        <span className="text-emerald-300 text-sm">{tradeHistoryNotification!.message}</span>
                        <button 
                          onClick={() => setTradeHistoryNotification(null)}
                          className="ml-auto text-white/50 hover:text-white"
                        >
                          √ó
                        </button>
                      </div>
                    )}
                    
                    {/* Trade History Status Badge */}
                    {finderSelectedLeague && tradeHistoryStatus[finderSelectedLeague] && (
                      <div className="mb-4 flex items-center gap-2 text-xs">
                        <span className="text-white/50">Trade History:</span>
                        {tradeHistoryStatus[finderSelectedLeague].status === 'complete' && (
                          <span className="px-2 py-0.5 bg-emerald-500/20 text-emerald-400 rounded-full">
                            {tradeHistoryStatus[finderSelectedLeague].tradesLoaded} trades learned
                          </span>
                        )}
                        {tradeHistoryStatus[finderSelectedLeague].status === 'partial' && (
                          <button
                            onClick={() => loadTradeHistory(finderSelectedLeague, true)}
                            className="px-2 py-0.5 bg-cyan-500/20 text-cyan-400 rounded-full hover:bg-cyan-500/30 transition"
                          >
                            Load more history ({tradeHistoryStatus[finderSelectedLeague].tradesLoaded}+ trades)
                          </button>
                        )}
                        {tradeHistoryStatus[finderSelectedLeague].status === 'loading' && (
                          <span className="px-2 py-0.5 bg-yellow-500/20 text-yellow-400 rounded-full animate-pulse">
                            Loading history...
                          </span>
                        )}
                      </div>
                    )}

                    {/* Smart Trade Recommendations - AI-powered personalized suggestions */}
                    {username && finderSelectedLeague && (
                      <div className="mb-6">
                        <SmartRecommendations
                          username={username}
                          leagueId={finderSelectedLeague}
                          sport="nfl"
                        />
                      </div>
                    )}

                    {/* Trade Preferences Quiz - Show if not completed */}
                    {!quizChecked && username && (
                      <div className="mb-6 p-4 bg-purple-500/10 border border-purple-500/30 rounded-xl">
                        <button
                          onClick={checkQuizStatus}
                          className="text-purple-300 hover:text-purple-200 transition"
                        >
                          Loading preferences...
                        </button>
                      </div>
                    )}
                    
                    {quizChecked && !quizCompleted && quizTrades.length > 0 && (
                      <div className="mb-6 p-6 bg-gradient-to-br from-purple-500/20 to-cyan-500/20 border border-purple-500/30 rounded-2xl">
                        <div className="flex items-center gap-3 mb-4">
                          <div className="w-10 h-10 rounded-xl bg-purple-500/30 flex items-center justify-center text-xl">üéØ</div>
                          <div>
                            <h4 className="text-lg font-bold text-white">Calibrate Your Trade Style</h4>
                            <p className="text-sm text-white/60">Answer {quizTrades.length} quick questions so AI knows your preferences</p>
                          </div>
                        </div>
                        
                        {/* Progress bar */}
                        <div className="mb-4">
                          <div className="flex justify-between text-xs text-white/50 mb-1">
                            <span>Question {Math.min(quizCurrentIndex + 1, quizTrades.length)} of {quizTrades.length}</span>
                            <span>{Object.keys(quizResponses).length} answered</span>
                          </div>
                          <div className="h-2 bg-white/10 rounded-full overflow-hidden">
                            <div 
                              className="h-full bg-gradient-to-r from-purple-500 to-cyan-500 transition-all duration-300"
                              style={{ width: `${(Object.keys(quizResponses).length / quizTrades.length) * 100}%` }}
                            />
                          </div>
                        </div>
                        
                        {/* Current trade question */}
                        {quizTrades[quizCurrentIndex] && (
                          <div className="space-y-4">
                            <p className="text-white font-medium">{quizTrades[quizCurrentIndex].scenario}</p>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                              {/* Side A */}
                              <button
                                onClick={() => handleQuizAnswer(quizTrades[quizCurrentIndex].id, 'A')}
                                className={`p-4 rounded-xl border-2 transition-all text-left ${
                                  quizResponses[quizTrades[quizCurrentIndex].id] === 'A'
                                    ? 'border-cyan-400 bg-cyan-500/20'
                                    : 'border-white/20 bg-black/30 hover:border-white/40'
                                }`}
                              >
                                <div className="text-sm font-bold text-cyan-400 mb-2">{quizTrades[quizCurrentIndex].sideA.label}</div>
                                <div className="space-y-1">
                                  {quizTrades[quizCurrentIndex].sideA.assets.map((asset: string, i: number) => (
                                    <div key={i} className="text-white/80 text-sm">{asset}</div>
                                  ))}
                                </div>
                              </button>
                              
                              {/* Side B */}
                              <button
                                onClick={() => handleQuizAnswer(quizTrades[quizCurrentIndex].id, 'B')}
                                className={`p-4 rounded-xl border-2 transition-all text-left ${
                                  quizResponses[quizTrades[quizCurrentIndex].id] === 'B'
                                    ? 'border-purple-400 bg-purple-500/20'
                                    : 'border-white/20 bg-black/30 hover:border-white/40'
                                }`}
                              >
                                <div className="text-sm font-bold text-purple-400 mb-2">{quizTrades[quizCurrentIndex].sideB.label}</div>
                                <div className="space-y-1">
                                  {quizTrades[quizCurrentIndex].sideB.assets.map((asset: string, i: number) => (
                                    <div key={i} className="text-white/80 text-sm">{asset}</div>
                                  ))}
                                </div>
                              </button>
                            </div>
                            
                            {/* Navigation */}
                            <div className="flex justify-between items-center pt-2">
                              <button
                                onClick={() => setQuizCurrentIndex(i => Math.max(0, i - 1))}
                                disabled={quizCurrentIndex === 0}
                                className="text-sm text-white/50 hover:text-white/80 disabled:opacity-30 disabled:cursor-not-allowed"
                              >
                                ‚Üê Previous
                              </button>
                              
                              {Object.keys(quizResponses).length >= 5 && (
                                <button
                                  onClick={submitQuiz}
                                  disabled={quizLoading}
                                  className="px-4 py-2 bg-gradient-to-r from-purple-500 to-cyan-500 text-white text-sm font-semibold rounded-lg hover:opacity-90 transition disabled:opacity-50"
                                >
                                  {quizLoading ? 'Saving...' : `Finish (${Object.keys(quizResponses).length}/${quizTrades.length} answered)`}
                                </button>
                              )}
                              
                              <button
                                onClick={() => setQuizCurrentIndex(i => Math.min(quizTrades.length - 1, i + 1))}
                                disabled={quizCurrentIndex >= quizTrades.length - 1}
                                className="text-sm text-white/50 hover:text-white/80 disabled:opacity-30 disabled:cursor-not-allowed"
                              >
                                Next ‚Üí
                              </button>
                            </div>
                            
                            {/* Skip option */}
                            <div className="text-center pt-2">
                              <button
                                onClick={() => setQuizCompleted(true)}
                                className="text-xs text-white/30 hover:text-white/50 transition"
                              >
                                Skip for now (use defaults)
                              </button>
                            </div>
                          </div>
                        )}
                      </div>
                    )}
                    
                    {quizChecked && quizCompleted && (
                      <div className="mb-4 flex items-center gap-2 text-sm text-green-400/80">
                        <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/></svg>
                        Trade preferences calibrated - AI will tailor suggestions to your style
                      </div>
                    )}

                    {/* League selector */}
                    <div className="mb-6">
                      <label className="block text-sm font-medium text-white/70 mb-2">Select a league to analyze:</label>
                      <div className="flex flex-col sm:flex-row gap-3">
                        <select
                          value={finderSelectedLeague}
                          onChange={(e) => setFinderSelectedLeague(e.target.value)}
                          className="flex-1 px-4 py-3 rounded-xl bg-black/50 border border-white/20 text-white focus:outline-none focus:border-cyan-500/50"
                        >
                          <option value="">-- Select League --</option>
                          {leagues
                            .filter((l) => l.season === 2024 || l.season === 2025)
                            .map((l) => {
                              const tags: string[] = []
                              if (l.team_count) tags.push(`${l.team_count}T`)
                              if (l.is_sf) tags.push('SF')
                              if (l.is_tep) tags.push(`TEP${l.tep_bonus ? `+${l.tep_bonus}` : ''}`)
                              if (l.scoring && l.scoring !== 'Unknown') tags.push(l.scoring)
                              const tagStr = tags.length > 0 ? ` [${tags.join(', ')}]` : ''
                              return (
                                <option key={l.league_id} value={l.league_id}>
                                  {l.name} ({l.season}) - {l.type || 'Dynasty'}{tagStr}
                                </option>
                              )
                            })}
                        </select>
                        <button
                          onClick={() => runTradeFinderAnalysis()}
                          disabled={!finderSelectedLeague || finderLoading}
                          className="px-6 py-3 bg-gradient-to-r from-cyan-500 to-purple-500 text-white font-semibold rounded-xl hover:from-cyan-400 hover:to-purple-400 transition disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                          {finderLoading ? 'Analyzing...' : 'Find Trades'}
                        </button>
                      </div>
                    </div>

                    {/* Error display */}
                    {finderError && (
                      <div className="mb-4 p-4 bg-red-500/10 border border-red-500/30 rounded-xl text-red-300 text-sm">
                        {finderError}
                      </div>
                    )}

                    {/* Warning display */}
                    {finderWarning && !finderLoading && (
                      <div className="mb-4 p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-xl text-yellow-300 text-sm">
                        {finderWarning}
                      </div>
                    )}

                    {/* Loading state */}
                    {finderLoading && (
                      <div className="flex items-center justify-center py-12">
                        <div className="flex flex-col items-center gap-3">
                          <div className="w-8 h-8 border-2 border-cyan-500 border-t-transparent rounded-full animate-spin"></div>
                          <span className="text-white/60 text-sm">Analyzing all rosters in your league...</span>
                        </div>
                      </div>
                    )}

                    {/* Results */}
                    {!finderLoading && tradeSuggestions.length > 0 && (
                      <div className="space-y-4">
                        <div className="flex items-center justify-between mb-4">
                          <h4 className="text-lg font-semibold text-white">
                            {finderLeagueInfo?.name} - Trade Opportunities
                          </h4>
                          <span className="text-xs text-white/50">{finderLeagueInfo?.scoringType}</span>
                        </div>

                        {tradeSuggestions.map((suggestion, idx) => (
                          <div key={idx} className="bg-black/40 border border-white/10 rounded-xl p-4">
                            {/* Manager header */}
                            <div className="flex items-center gap-3 mb-3">
                              {suggestion.targetAvatar ? (
                                <img src={suggestion.targetAvatar} alt="" className="w-10 h-10 rounded-full" />
                              ) : (
                                <div className="w-10 h-10 rounded-full bg-gradient-to-br from-cyan-500 to-purple-500 flex items-center justify-center text-white font-bold">
                                  {(suggestion.targetDisplayName || 'M')[0].toUpperCase()}
                                </div>
                              )}
                              <div>
                                <div className="font-semibold text-white">{suggestion.targetDisplayName}</div>
                                <div className="text-xs text-white/50">@{suggestion.targetManager}</div>
                              </div>
                              <div className={cx(
                                'ml-auto px-3 py-1 rounded-full text-xs font-medium',
                                suggestion.overallFit === 'High' && 'bg-green-500/20 text-green-300',
                                suggestion.overallFit === 'Medium' && 'bg-yellow-500/20 text-yellow-300',
                                suggestion.overallFit === 'Low' && 'bg-red-500/20 text-red-300'
                              )}>
                                {suggestion.overallFit} Fit
                              </div>
                            </div>

                            {/* Their needs vs your surplus */}
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
                              <div className="bg-black/30 rounded-lg p-3">
                                <div className="text-xs text-red-400 font-medium mb-1">Their Needs</div>
                                <div className="text-sm text-white/80">{(suggestion.theirNeeds || []).join(', ') || 'No specific needs identified'}</div>
                              </div>
                              <div className="bg-black/30 rounded-lg p-3">
                                <div className="text-xs text-green-400 font-medium mb-1">Your Surplus</div>
                                <div className="text-sm text-white/80">{(suggestion.yourSurplus || []).join(', ') || 'No surplus identified'}</div>
                              </div>
                            </div>

                            {/* Suggested trades */}
                            {suggestion.suggestedTrades?.map((trade: any, tIdx: number) => (
                              <div key={tIdx} className="bg-gradient-to-r from-cyan-500/10 to-purple-500/10 border border-white/10 rounded-lg p-3 mb-2">
                                <div className="flex items-start justify-between gap-4 mb-2">
                                  <div className="flex-1">
                                    <div className="text-xs text-cyan-400 font-medium">You Give:</div>
                                    <div className="text-sm text-white">{trade.youGive?.join(' + ')}</div>
                                  </div>
                                  <div className="text-2xl text-white/30">‚Üí</div>
                                  <div className="flex-1">
                                    <div className="text-xs text-purple-400 font-medium">You Receive:</div>
                                    <div className="text-sm text-white">{trade.youReceive?.join(' + ')}</div>
                                  </div>
                                  <div className={cx(
                                    'px-2 py-1 rounded text-xs font-bold',
                                    trade.tradeGrade?.startsWith('A') && 'bg-green-500/30 text-green-300',
                                    trade.tradeGrade?.startsWith('B') && 'bg-cyan-500/30 text-cyan-300',
                                    trade.tradeGrade?.startsWith('C') && 'bg-yellow-500/30 text-yellow-300'
                                  )}>
                                    {trade.tradeGrade}
                                  </div>
                                </div>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 text-xs">
                                  <div>
                                    <span className="text-green-400">Why they accept:</span>{' '}
                                    <span className="text-white/70">{trade.whyTheyAccept}</span>
                                  </div>
                                  <div>
                                    <span className="text-purple-400">Why you win:</span>{' '}
                                    <span className="text-white/70">{trade.whyYouWin}</span>
                                  </div>
                                </div>
                                
                                {/* Expandable details section */}
                                <div className="mt-3 pt-3 border-t border-white/10">
                                  <button
                                    onClick={() => setExpandedTrades(prev => ({
                                      ...prev,
                                      [`${finderSelectedLeague}-${idx}-${tIdx}`]: !prev[`${finderSelectedLeague}-${idx}-${tIdx}`]
                                    }))}
                                    className="flex items-center gap-2 text-xs text-cyan-400 hover:text-cyan-300 transition mb-2"
                                  >
                                    <svg 
                                      className={`w-4 h-4 transition-transform ${expandedTrades[`${finderSelectedLeague}-${idx}-${tIdx}`] ? 'rotate-180' : ''}`} 
                                      fill="none" 
                                      stroke="currentColor" 
                                      viewBox="0 0 24 24"
                                    >
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                    </svg>
                                    {expandedTrades[`${finderSelectedLeague}-${idx}-${tIdx}`] ? 'Hide Details' : 'Show Why This Trade Works'}
                                  </button>
                                  
                                  {expandedTrades[`${finderSelectedLeague}-${idx}-${tIdx}`] && (
                                    <div className="space-y-3 mt-3 pl-2 border-l-2 border-cyan-500/30">
                                      {/* League Context */}
                                      {(finderLeagueInfo?.scoringType || suggestion.leagueContext) && (
                                        <div className="bg-black/30 rounded-lg p-3">
                                          <div className="text-xs text-cyan-400 font-medium mb-1">League Settings Impact</div>
                                          <div className="text-xs text-white/70">
                                            {finderLeagueInfo?.scoringType || 'Standard'} scoring affects this trade because{' '}
                                            {finderLeagueInfo?.scoringType?.includes('PPR') 
                                              ? 'high-target players are more valuable in PPR formats.'
                                              : finderLeagueInfo?.scoringType?.includes('SF') || finderLeagueInfo?.scoringType?.includes('Superflex')
                                                ? 'QBs carry premium value in Superflex leagues.'
                                                : 'touchdown-dependent players carry more risk in standard scoring.'}
                                          </div>
                                        </div>
                                      )}
                                      
                                      {/* Player Breakdowns */}
                                      {trade.playerAnalysis && Array.isArray(trade.playerAnalysis) && trade.playerAnalysis.length > 0 && (
                                        <div className="space-y-2">
                                          <div className="text-xs text-purple-400 font-medium">Player Analysis</div>
                                          {trade.playerAnalysis.map((player: any, pIdx: number) => (
                                            <div key={pIdx} className="bg-black/30 rounded-lg p-2 text-xs">
                                              <PlayerBadge name={player.name} sleeperId={player.id || player.playerId} position={player.position} team={player.team} size="sm" />
                                              <div className="grid grid-cols-2 gap-2 mt-1">
                                                {player.injuryHistory && (
                                                  <div>
                                                    <span className="text-red-400">Injury:</span>{' '}
                                                    <span className="text-white/60">{player.injuryHistory}</span>
                                                  </div>
                                                )}
                                                {player.injuryRisk && (
                                                  <div>
                                                    <span className="text-yellow-400">Risk:</span>{' '}
                                                    <span className={`${
                                                      player.injuryRisk === 'Low' ? 'text-green-400' :
                                                      player.injuryRisk === 'Moderate' ? 'text-yellow-400' :
                                                      player.injuryRisk === 'High' ? 'text-orange-400' : 'text-red-400'
                                                    }`}>{player.injuryRisk}</span>
                                                  </div>
                                                )}
                                                {player.qbSituation && (
                                                  <div>
                                                    <span className="text-blue-400">QB:</span>{' '}
                                                    <span className="text-white/60">{player.qbSituation}</span>
                                                  </div>
                                                )}
                                                {player.offensiveLine && (
                                                  <div>
                                                    <span className="text-green-400">O-Line:</span>{' '}
                                                    <span className="text-white/60">{player.offensiveLine}</span>
                                                  </div>
                                                )}
                                              </div>
                                              {player.valueReasoning && (
                                                <div className="mt-1 text-white/50 italic">{player.valueReasoning}</div>
                                              )}
                                            </div>
                                          ))}
                                        </div>
                                      )}
                                      
                                      {/* Detailed Reasoning */}
                                      {trade.detailedReasoning && (
                                        <div className="bg-black/30 rounded-lg p-3">
                                          <div className="text-xs text-yellow-400 font-medium mb-1">Full Analysis</div>
                                          <div className="text-xs text-white/70">{trade.detailedReasoning}</div>
                                        </div>
                                      )}
                                      
                                      {/* Risk Flags */}
                                      {trade.riskFlags && Array.isArray(trade.riskFlags) && trade.riskFlags.length > 0 && (
                                        <div className="bg-red-500/10 border border-red-500/30 rounded-lg p-3">
                                          <div className="text-xs text-red-400 font-medium mb-1">Risk Flags</div>
                                          <ul className="text-xs text-white/70 list-disc list-inside">
                                            {trade.riskFlags.map((flag: string, fIdx: number) => (
                                              <li key={fIdx}>{flag}</li>
                                            ))}
                                          </ul>
                                        </div>
                                      )}
                                    </div>
                                  )}
                                </div>

                                {/* Trade Rating */}
                                <div className="mt-3 pt-3 border-t border-white/10 flex items-center justify-between">
                                  <span className="text-xs text-white/50">Rate this trade suggestion:</span>
                                  <div className="flex items-center gap-1">
                                    {tradeFeedback[`${finderSelectedLeague}-${idx}-${tIdx}`] ? (
                                      <span className="text-xs text-green-400 flex items-center gap-1">
                                        <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/></svg>
                                        Rated {tradeFeedback[`${finderSelectedLeague}-${idx}-${tIdx}`]}/5
                                      </span>
                                    ) : feedbackLoading[`${finderSelectedLeague}-${idx}-${tIdx}`] ? (
                                      <span className="text-xs text-white/50">Saving...</span>
                                    ) : (
                                      [1, 2, 3, 4, 5].map((star) => (
                                        <button
                                          key={star}
                                          onClick={() => submitTradeFeedback(idx, tIdx, trade, suggestion.targetManager, star)}
                                          className="w-7 h-7 rounded-lg bg-white/5 hover:bg-white/15 flex items-center justify-center text-sm transition-all hover:scale-110"
                                          title={`Rate ${star}/5`}
                                        >
                                          <span className={star <= 2 ? 'text-red-400' : star === 3 ? 'text-yellow-400' : 'text-green-400'}>
                                            {star}
                                          </span>
                                        </button>
                                      ))
                                    )}
                                  </div>
                                </div>
                                <button
                                  onClick={() => navigateToChat(`Should I trade ${trade.youGive?.join(' + ')} for ${trade.youReceive?.join(' + ')} with ${suggestion.targetDisplayName}? The trade grade is ${trade.tradeGrade}. ${trade.whyYouWin || ''}`, finderSelectedLeague)}
                                  className="mt-2 w-full flex items-center justify-center gap-1.5 px-3 py-1.5 rounded-lg bg-cyan-500/10 border border-cyan-400/20 text-cyan-300 text-[11px] font-medium hover:bg-cyan-500/20 transition"
                                >
                                  üí¨ Ask AI more about this trade
                                </button>
                              </div>
                            ))}
                          </div>
                        ))}
                      </div>
                    )}

                    {/* No results */}
                    {!finderLoading && finderSelectedLeague && tradeSuggestions.length === 0 && !finderError && finderLeagueInfo && (
                      <div className="mt-4 p-5 rounded-xl bg-gradient-to-b from-slate-900/80 to-slate-800/50 border border-white/10 text-center space-y-3">
                        <p className="text-sm font-medium text-white/70">No clean market wins today in this league.</p>
                        <p className="text-xs text-white/40">Try the Trade Hub above to build custom trades, or use the AI Trade Ideas generator with a different strategy.</p>
                        <div className="flex gap-2 justify-center">
                          <button
                            onClick={() => { setFinderSelectedLeague('') }}
                            className="px-3 py-1.5 rounded-lg text-xs font-medium bg-purple-500/20 text-purple-300 border border-purple-500/20 hover:bg-purple-500/30 transition"
                          >
                            Try Another League
                          </button>
                        </div>
                      </div>
                    )}

                  </div>
                  </>
                )}

                {activeTab === 'player-finder' && (
                  <>
                  {/* Hero Metric */}
                  <HeroMetric 
                    value={playerSearchResults?.length ? `${playerSearchResults.length}` : '‚Äî'}
                    label="Leagues Found"
                    helper="Where you own this player"
                    accent="cyan"
                  />
                  {/* Tab Headline */}
                  <p className="text-center text-sm sm:text-base text-white/60 mb-4">Find players by value, momentum, and roster fit ‚Äî not hype.</p>
                  <div className="bg-black/30 border border-cyan-500/20 rounded-2xl p-4 sm:p-6">
                    <div className="flex items-start sm:items-center gap-3 mb-4">
                      <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500/30 to-cyan-500/30 flex items-center justify-center text-xl flex-shrink-0">üîç</div>
                      <div>
                        <h3 className="text-lg sm:text-xl font-bold text-cyan-400">Player Finder</h3>
                        <p className="text-xs sm:text-sm text-gray-400">Find which of your leagues you own a specific player in</p>
                      </div>
                    </div>

                    <div className="flex flex-col sm:flex-row gap-3 mb-6">
                      <input
                        type="text"
                        placeholder="Search player name (e.g., Ja'Marr Chase)"
                        value={playerSearchQuery}
                        onChange={(e) => setPlayerSearchQuery(e.target.value)}
                        onKeyDown={(e) => e.key === 'Enter' && searchPlayers()}
                        className="flex-1 px-4 py-3 bg-black/40 border border-white/10 rounded-xl text-white placeholder-white/40 focus:border-cyan-500/50 focus:outline-none min-h-[48px]"
                      />
                      <button
                        onClick={searchPlayers}
                        disabled={playerSearchLoading || playerSearchQuery.length < 2}
                        className="w-full sm:w-auto px-6 py-3 bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-semibold rounded-xl hover:from-cyan-400 hover:to-blue-400 transition disabled:opacity-50 disabled:cursor-not-allowed min-h-[48px]"
                      >
                        {playerSearchLoading ? 'Searching...' : 'Search'}
                      </button>
                    </div>

                    {playerSearchLoading && (
                      <div className="mb-6">
                        <div className="flex items-center gap-3 mb-2">
                          <div className="animate-spin rounded-full h-5 w-5 border-2 border-cyan-500 border-t-transparent"></div>
                          <span className="text-cyan-300 text-sm">Searching across your leagues...</span>
                        </div>
                        <div className="w-full h-2 bg-black/40 rounded-full overflow-hidden">
                          <div className="h-full bg-gradient-to-r from-cyan-500 to-blue-500 rounded-full animate-pulse" style={{ width: '60%' }}></div>
                        </div>
                        <p className="text-xs text-white/40 mt-2">This may take a moment depending on how many leagues you have</p>
                      </div>
                    )}

                    {playerSearchError && (
                      <div className="mb-4 p-3 bg-red-500/20 border border-red-500/30 rounded-xl text-red-300 text-sm">
                        {playerSearchError}
                      </div>
                    )}

                    {selectedPlayerCard && (
                      <div className="mb-6">
                        <PlayerProfileCard
                          player={selectedPlayerCard}
                          onClose={() => setSelectedPlayerCard(null)}
                        />
                      </div>
                    )}

                    {playerSearchResults.length > 0 && (
                      <div className="space-y-2">
                        {playerSearchResults.map((player) => {
                          const isSelected = selectedPlayerCard?.playerId === player.playerId
                          return (
                            <button
                              key={player.playerId}
                              onClick={() => setSelectedPlayerCard(isSelected ? null : player)}
                              className={`w-full p-3 sm:p-4 flex flex-col sm:flex-row sm:items-center justify-between gap-2 sm:gap-4 rounded-xl transition ${
                                isSelected
                                  ? 'bg-cyan-500/10 border border-cyan-400/30'
                                  : 'bg-black/40 border border-white/10 hover:bg-white/5'
                              }`}
                            >
                              <div className="flex flex-wrap items-center gap-2">
                                <PlayerBadge name={player.playerName} sleeperId={player.playerId} position={player.position} team={player.team} size="md" />
                                
                                {player.stock && (
                                  <span className={`flex items-center gap-1 text-xs px-2 py-0.5 rounded font-bold ${
                                    player.stock.direction === 'up' ? 'bg-green-500/30 text-green-300' :
                                    player.stock.direction === 'down' ? 'bg-red-500/30 text-red-300' :
                                    'bg-gray-500/30 text-gray-300'
                                  }`}>
                                    {player.stock.direction === 'up' ? 'üìà' : player.stock.direction === 'down' ? 'üìâ' : '‚ûñ'}
                                  </span>
                                )}
                                
                                {player.stock && (
                                  <span className={`flex items-center gap-1 text-xs px-2 py-0.5 rounded font-semibold ${
                                    player.stock.signal === 'strong_sell' ? 'bg-red-600/40 text-red-200 border border-red-500/50' :
                                    player.stock.signal === 'sell' ? 'bg-orange-500/30 text-orange-300' :
                                    player.stock.signal === 'strong_buy' ? 'bg-green-600/40 text-green-200 border border-green-500/50' :
                                    player.stock.signal === 'buy' ? 'bg-emerald-500/30 text-emerald-300' :
                                    'bg-gray-500/20 text-gray-400'
                                  }`}>
                                    {player.stock.signal === 'strong_sell' ? 'üî• SELL NOW' :
                                     player.stock.signal === 'sell' ? 'Sell' :
                                     player.stock.signal === 'strong_buy' ? 'üíé BUY' :
                                     player.stock.signal === 'buy' ? 'Buy' :
                                     'Hold'}
                                  </span>
                                )}
                                
                                {player.injuryStatus && player.injuryStatus !== 'Active' && (
                                  <span className={`flex items-center gap-1 text-xs px-2 py-0.5 rounded ${
                                    player.injuryStatus === 'IR' || player.injuryStatus === 'Out' 
                                      ? 'bg-red-500/30 text-red-300' 
                                      : player.injuryStatus === 'Doubtful' || player.injuryStatus === 'Questionable'
                                      ? 'bg-yellow-500/30 text-yellow-300'
                                      : 'bg-orange-500/30 text-orange-300'
                                  }`}>
                                    ‚ö†Ô∏è {player.injuryStatus}
                                  </span>
                                )}
                              </div>
                              
                              <div className="flex items-center justify-between sm:justify-end gap-3">
                                {player.ownership && (
                                  <div className="flex items-center gap-2">
                                    <div className="text-right">
                                      <div className="text-cyan-400 font-bold text-sm sm:text-base">{player.ownership.percentage}%</div>
                                      <div className="text-white/40 text-[10px]">ownership</div>
                                    </div>
                                    <div className="w-12 h-2 bg-black/50 rounded-full overflow-hidden">
                                      <div 
                                        className={`h-full rounded-full transition-all ${
                                          player.ownership.percentage >= 50 ? 'bg-red-500' :
                                          player.ownership.percentage >= 30 ? 'bg-orange-500' :
                                          player.ownership.percentage >= 15 ? 'bg-cyan-500' :
                                          'bg-green-500'
                                        }`}
                                        style={{ width: `${Math.min(player.ownership.percentage, 100)}%` }}
                                      />
                                    </div>
                                  </div>
                                )}
                                <span className="text-white/60 text-xs">
                                  {player.leagues.length}/{player.ownership?.total || 0}
                                </span>
                                <svg className={`w-4 h-4 text-white/40 transition ${isSelected ? 'text-cyan-400' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                                </svg>
                              </div>
                            </button>
                          )
                        })}
                      </div>
                    )}

                    {!playerSearchLoading && playerSearchResults.length === 0 && !playerSearchError && (
                      <div className="text-center py-12 text-white/50">
                        <div className="text-4xl mb-3">üîç</div>
                        <p>Search for a player to see which of your teams have them</p>
                        <p className="text-sm mt-2">Shows ownership %, stock signals based on your trade activity, and AI buy/sell recommendations</p>
                      </div>
                    )}
                  </div>
                  </>
                )}

                {activeTab === 'waiver' && (
                  <>
                  {waiverAnalysis?.meta?.fallbackMode && (
                    <div className="mb-4 rounded-xl border border-yellow-600/30 bg-yellow-900/15 px-4 py-3 text-yellow-300 text-xs">
                      {waiverAnalysis.meta.rankingSourceNote}
                    </div>
                  )}
                  {waiverAnalysis?.one_move ? (
                    <HeroMetricAI
                      value={waiverAnalysis.one_move.player_name}
                      label={waiverAnalysis.one_move.recommendation}
                      helper="If you only do one move this week"
                      accent="emerald"
                      confidence={
                        waiverAnalysis.one_move.composite_score >= 70 ? 'high' :
                        waiverAnalysis.one_move.composite_score >= 45 ? 'medium' : 'low'
                      }
                      whyBullets={waiverAnalysis.one_move.top_drivers?.filter((d: any) => d.direction === 'positive').map((d: any) => d.detail) || []}
                    />
                  ) : (
                    <HeroMetric value="--" label="Waiver AI" helper="Select a league to find your best pickups" accent="emerald" />
                  )}
                  <p className="text-center text-sm sm:text-base text-white/60 mb-4">League-specific, goal-aware analysis with 4 scoring dimensions ‚Äî not generic advice.</p>

                  <div className="bg-black/30 border border-cyan-500/20 rounded-2xl p-4 sm:p-6 space-y-5">
                    <div className="flex items-start sm:items-center gap-3">
                      <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-green-500/30 to-emerald-500/30 flex items-center justify-center text-xl flex-shrink-0">
                        <span className="text-emerald-400 text-base">&#x2197;</span>
                      </div>
                      <div>
                        <h3 className="text-lg sm:text-xl font-bold text-cyan-400">Waiver AI</h3>
                        <p className="text-xs sm:text-sm text-gray-400">Find the best adds for your team and league</p>
                      </div>
                    </div>

                    {waiverDynastyLeagues.length === 0 && !waiverLeaguesLoading && (
                      <button onClick={loadWaiverLeagues} className="px-5 py-2.5 bg-cyan-500/20 hover:bg-cyan-500/30 border border-cyan-400/30 text-cyan-200 rounded-xl transition font-medium">
                        Find Leagues
                      </button>
                    )}

                    {waiverLeaguesLoading && <div className="text-gray-400">Loading leagues...</div>}

                    {waiverDynastyLeagues.length > 0 && (
                      <div className="space-y-4">
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                          <div>
                            <label className="block text-xs text-white/50 mb-1.5">League</label>
                            <select
                              value={waiverSelectedLeague}
                              onChange={(e) => { setWaiverSelectedLeague(e.target.value); setWaiverAnalysis(null) }}
                              className="w-full px-4 py-3 rounded-xl bg-black/50 border border-white/20 text-white text-sm focus:outline-none focus:border-cyan-500/50"
                            >
                              {waiverDynastyLeagues.map((lg) => (
                                <option key={lg.league_id} value={lg.league_id}>
                                  {lg.name} ({lg.season}) - {lg.team_count}T{lg.is_sf ? ' SF' : ''}{lg.league_type ? ` ${lg.league_type}` : ''}
                                </option>
                              ))}
                            </select>
                          </div>
                          <div>
                            <label className="block text-xs text-white/50 mb-1.5">Your Goal</label>
                            <select
                              value={waiverGoal}
                              onChange={(e) => setWaiverGoal(e.target.value as any)}
                              className="w-full px-4 py-3 rounded-xl bg-black/50 border border-white/20 text-white text-sm focus:outline-none focus:border-cyan-500/50"
                            >
                              <option value="">Auto-detect from standings</option>
                              <option value="win-now">Win Now</option>
                              <option value="balanced">Balanced</option>
                              <option value="rebuild">Rebuild</option>
                            </select>
                          </div>
                        </div>

                        <button
                          onClick={runWaiverAnalysis}
                          disabled={waiverLoading || !waiverSelectedLeague}
                          className="w-full sm:w-auto px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-500 text-white font-semibold rounded-xl hover:from-green-400 hover:to-emerald-400 transition disabled:opacity-50"
                        >
                          {waiverLoading ? 'Analyzing Waivers...' : 'Analyze Free Agents'}
                        </button>

                        {waiverLoading && (
                          <div className="p-4 rounded-xl bg-gradient-to-r from-green-500/10 to-emerald-500/10 border border-green-500/30">
                            <div className="flex items-center gap-3 mb-3">
                              <div className="w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center"><span className="animate-spin text-lg">&#9881;</span></div>
                              <div>
                                <div className="text-sm font-semibold text-white">Scanning your league</div>
                                <div className="text-xs text-white/50">Computing needs, scoring candidates, generating narrative...</div>
                              </div>
                            </div>
                            <div className="h-1.5 rounded-full bg-white/10 overflow-hidden">
                              <div className="h-full bg-gradient-to-r from-green-500 to-emerald-400 rounded-full animate-pulse" style={{ width: '60%' }}></div>
                            </div>
                          </div>
                        )}

                        {waiverError && <p className="text-red-400 text-sm">{waiverError}</p>}
                      </div>
                    )}
                  </div>

                  {waiverAnalysis && (
                    <div className="space-y-5 mt-5">
                      {waiverAnalysis.biggest_need && (
                        <div className="rounded-2xl bg-gradient-to-r from-amber-500/15 to-orange-500/10 border border-amber-400/30 p-4 sm:p-5">
                          <div className="flex items-center gap-2 mb-2">
                            <span className="text-amber-400 text-base">&#x1F3AF;</span>
                            <span className="text-sm font-bold text-amber-300">Your Biggest Need This Week</span>
                          </div>
                          <div className="text-xl sm:text-2xl font-black text-white">
                            {waiverAnalysis.biggest_need.slot.replace(/_/g, ' ')}
                            <span className="text-amber-300 ml-2 text-lg">(+{waiverAnalysis.biggest_need.gap_ppg} PPG gap)</span>
                          </div>
                          {waiverAnalysis.biggest_need.current_player && (
                            <p className="text-xs text-white/50 mt-1">Current: {waiverAnalysis.biggest_need.current_player}</p>
                          )}
                          {(waiverAnalysis.weakest_slots || []).length > 1 && (
                            <div className="flex flex-wrap gap-2 mt-3">
                              {waiverAnalysis.weakest_slots.slice(1, 3).map((s: any, i: number) => (
                                <span key={i} className="px-2.5 py-1 rounded-lg bg-black/20 border border-white/10 text-[10px] text-white/60">
                                  {s.slot.replace(/_/g, ' ')} ({s.position}, +{s.gap_ppg} PPG)
                                </span>
                              ))}
                            </div>
                          )}
                        </div>
                      )}

                      {(waiverAnalysis.bye_week_alerts || []).length > 0 && (
                        <div className="flex flex-wrap gap-2">
                          {waiverAnalysis.bye_week_alerts.map((alert: any, i: number) => (
                            <div key={i} className={`px-3 py-2 rounded-xl border text-xs ${
                              alert.severity === 'critical' ? 'bg-rose-500/10 border-rose-400/30 text-rose-300' :
                              alert.severity === 'moderate' ? 'bg-amber-500/10 border-amber-400/30 text-amber-300' :
                              'bg-white/5 border-white/10 text-white/60'
                            }`}>
                              <span className="font-semibold">Wk {alert.week}</span>: {alert.players_out.length} starters on bye ({alert.positions_affected.join(', ')})
                            </div>
                          ))}
                        </div>
                      )}

                      <div className="rounded-xl bg-gradient-to-br from-green-500/10 to-emerald-500/10 border border-green-400/30 p-4">
                        <div className="flex items-center justify-between mb-2 flex-wrap gap-2">
                          <div className="text-lg font-bold text-white">{waiverAnalysis.league_name}</div>
                          <div className="flex items-center gap-2 flex-wrap">
                            <span className={`px-3 py-1 rounded-full text-xs font-bold ${
                              waiverAnalysis.team_goal === 'win-now' ? 'bg-green-500/30 text-green-300' :
                              waiverAnalysis.team_goal === 'rebuild' ? 'bg-purple-500/30 text-purple-300' :
                              'bg-yellow-500/30 text-yellow-300'
                            }`}>
                              {waiverAnalysis.team_goal === 'win-now' ? 'WIN NOW' : waiverAnalysis.team_goal === 'rebuild' ? 'REBUILD' : 'BALANCED'}
                            </span>
                            {waiverAnalysis.league_context?.is_superflex && <span className="px-2 py-0.5 rounded bg-cyan-500/20 text-cyan-300 text-[10px] font-bold border border-cyan-400/30">SF</span>}
                            {waiverAnalysis.league_context?.is_tep && <span className="px-2 py-0.5 rounded bg-purple-500/20 text-purple-300 text-[10px] font-bold border border-purple-400/30">TEP</span>}
                          </div>
                        </div>
                        {waiverAnalysis.summary && <p className="text-sm text-white/70 mt-2">{waiverAnalysis.summary}</p>}
                      </div>

                      {waiverAnalysis.one_move && (
                        <div className="rounded-2xl bg-gradient-to-br from-emerald-500/15 to-green-500/10 border border-emerald-400/30 p-5">
                          <div className="flex items-center gap-2 mb-3">
                            <span className="text-emerald-400 text-base">&#x26A1;</span>
                            <span className="text-sm font-bold text-emerald-300">If You Only Do One Move</span>
                          </div>
                          <div className="flex items-start gap-4">
                            <div className="flex-shrink-0">
                              {waiverAnalysis.one_move.player_id ? (
                                <img
                                  src={headshotUrl(waiverAnalysis.one_move.player_id)}
                                  alt={waiverAnalysis.one_move.player_name}
                                  className="w-14 h-14 rounded-xl object-cover bg-white/10 border border-white/10"
                                  onError={(e) => { (e.currentTarget as HTMLImageElement).style.display = 'none' }}
                                />
                              ) : null}
                            </div>
                            <div className="flex-1 min-w-0">
                              <div className="text-lg font-bold text-white">{waiverAnalysis.one_move.player_name}</div>
                              <div className="flex items-center gap-2 mt-1 flex-wrap">
                                <span className="text-[10px] text-white/50 px-1.5 py-0.5 rounded bg-white/10">{waiverAnalysis.one_move.position}</span>
                                {waiverAnalysis.one_move.team && <span className="text-[10px] text-white/40">{waiverAnalysis.one_move.team}</span>}
                                <span className="text-[10px] font-bold text-emerald-300">Score: {waiverAnalysis.one_move.composite_score}/100</span>
                                {waiverAnalysis.one_move.faab_bid != null && (
                                  <span className="text-[10px] text-cyan-300 font-mono">FAAB: ${waiverAnalysis.one_move.faab_bid}</span>
                                )}
                              </div>
                              {waiverAnalysis.one_move.reasoning && (
                                <p className="text-xs text-white/60 mt-2 leading-relaxed">{waiverAnalysis.one_move.reasoning}</p>
                              )}
                              {waiverAnalysis.one_move.drop_candidate && (
                                <div className="mt-2 flex items-center gap-2 text-xs">
                                  <span className="text-rose-400">Drop:</span>
                                  <span className="text-white/70">{waiverAnalysis.one_move.drop_candidate.name}</span>
                                  <span className={`px-1.5 py-0.5 rounded text-[9px] font-bold ${
                                    waiverAnalysis.one_move.drop_candidate.riskLabel === 'High' ? 'bg-rose-500/20 text-rose-300' :
                                    waiverAnalysis.one_move.drop_candidate.riskLabel === 'Moderate' ? 'bg-amber-500/20 text-amber-300' :
                                    'bg-white/10 text-white/50'
                                  }`}>
                                    {waiverAnalysis.one_move.drop_candidate.riskLabel} regret risk
                                  </span>
                                </div>
                              )}
                            </div>
                          </div>
                        </div>
                      )}

                      <div className="space-y-3">
                        <div className="flex items-center justify-between">
                          <h4 className="text-sm font-bold text-white/80">Top Adds</h4>
                        </div>

                        {(() => {
                          const allSuggestions = waiverAnalysis.suggestions || []
                          const filtered = allSuggestions.filter((s: any) => {
                            if (waiverRiskTolerance <= 25) return s.composite_score >= 60
                            if (waiverRiskTolerance <= 50) return s.composite_score >= 40
                            if (waiverRiskTolerance <= 75) return s.composite_score >= 25
                            return true
                          })
                          const displayed = filtered.slice(0, 5)

                          return displayed.map((s: any, idx: number) => {
                            const dims = s.dimension_scores
                            const drivers: any[] = s.top_drivers || s.all_drivers || []
                            const isExpanded = expandedWaivers[idx] ?? false
                            const tierBg = s.tier === 'Must Add' ? 'bg-emerald-500/20 text-emerald-300 border-emerald-500/30' :
                              s.tier === 'Strong Add' ? 'bg-cyan-500/20 text-cyan-300 border-cyan-500/30' :
                              s.tier === 'Add' ? 'bg-blue-500/20 text-blue-300 border-blue-500/30' :
                              s.tier === 'Stash' ? 'bg-purple-500/20 text-purple-300 border-purple-500/30' :
                              'bg-white/10 text-white/60 border-white/20'

                            return (
                              <div key={`${s.player_name}-${idx}`} className="rounded-xl bg-black/40 border border-white/10 overflow-hidden">
                                <button
                                  onClick={() => setExpandedWaivers(prev => ({ ...prev, [idx]: !prev[idx] }))}
                                  className="w-full p-4 flex items-center gap-3 text-left hover:bg-white/5 transition"
                                >
                                  <div className="flex-shrink-0 relative">
                                    {s.player_id ? (
                                      <img
                                        src={headshotUrl(s.player_id)}
                                        alt={s.player_name}
                                        className="w-11 h-11 rounded-xl object-cover bg-white/10 border border-white/10"
                                        onError={(e) => { (e.currentTarget as HTMLImageElement).style.display = 'none'; if (e.currentTarget.nextElementSibling) (e.currentTarget.nextElementSibling as HTMLElement).style.display = 'flex' }}
                                      />
                                    ) : null}
                                    <div className={`w-11 h-11 rounded-xl bg-gradient-to-br from-emerald-500/20 to-cyan-500/20 items-center justify-center text-base font-bold text-white/60 ${s.player_id ? 'hidden' : 'flex'}`}>
                                      {(s.player_name || '?').charAt(0)}
                                    </div>
                                  </div>

                                  <div className="min-w-0 flex-1">
                                    <div className="flex items-center gap-2 flex-wrap">
                                      <span className="text-sm font-semibold text-white truncate">{s.player_name}</span>
                                      <span className="text-[10px] text-white/50 px-1.5 py-0.5 rounded bg-white/10">{s.position}</span>
                                      {s.team && <span className="text-[10px] text-white/40">{s.team}</span>}
                                    </div>
                                    <div className="flex items-center gap-2 mt-1 flex-wrap">
                                      <span className={`px-2 py-0.5 text-[10px] font-bold rounded-full border ${tierBg}`}>{s.tier}</span>
                                      <span className="text-[10px] text-white/40">Score: {s.composite_score}/100</span>
                                      {s.faab_bid != null && <span className="text-[10px] text-cyan-300 font-mono">FAAB: ${s.faab_bid}</span>}
                                    </div>
                                  </div>

                                  <div className="flex items-center gap-2 flex-shrink-0">
                                    <div className="text-right hidden sm:block">
                                      <div className="text-xs font-semibold text-white/70">#{s.priority}</div>
                                    </div>
                                    <span className={`text-white/40 transition-transform text-xs inline-block ${isExpanded ? 'rotate-90' : ''}`}>&#x25B6;</span>
                                  </div>
                                </button>

                                {isExpanded && (
                                  <div className="px-4 pb-4 space-y-3">
                                    {dims && (
                                      <div className="grid grid-cols-2 gap-2">
                                        {[
                                          { key: 'startNow', label: 'Start Now', desc: 'Next 2-week starter utility' },
                                          { key: 'stash', label: 'Stash', desc: 'Dynasty ceiling vs age' },
                                          { key: 'needFit', label: 'Need Fit', desc: 'Fills your weakest slot' },
                                          { key: 'leagueDemand', label: 'League Demand', desc: 'How much your league values this' },
                                        ].map(dim => {
                                          const val = dims[dim.key] ?? 0
                                          const barColor = val >= 70 ? 'bg-emerald-500' : val >= 45 ? 'bg-cyan-500' : val >= 25 ? 'bg-amber-500' : 'bg-rose-500'
                                          return (
                                            <div key={dim.key} className="rounded-lg bg-black/30 border border-white/10 p-2.5">
                                              <div className="flex items-center justify-between mb-1">
                                                <span className="text-[10px] text-white/60 font-medium">{dim.label}</span>
                                                <span className="text-[10px] text-white/80 font-bold">{val}</span>
                                              </div>
                                              <div className="h-1.5 rounded-full bg-white/10 overflow-hidden">
                                                <div className={`h-full rounded-full ${barColor} transition-all`} style={{ width: `${val}%` }} />
                                              </div>
                                              <div className="text-[9px] text-white/30 mt-0.5">{dim.desc}</div>
                                            </div>
                                          )
                                        })}
                                      </div>
                                    )}

                                    {drivers.length > 0 && (
                                      <div className="space-y-1">
                                        <div className="text-[10px] text-white/40 font-semibold uppercase">Top Drivers</div>
                                        <div className="flex flex-wrap gap-1.5">
                                          {drivers.slice(0, 3).map((d: any) => (
                                            <div
                                              key={d.id}
                                              className={`inline-flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg text-[10px] border ${
                                                d.direction === 'positive' ? 'bg-emerald-500/10 border-emerald-500/20 text-emerald-300' :
                                                d.direction === 'negative' ? 'bg-rose-500/10 border-rose-500/20 text-rose-300' :
                                                'bg-white/5 border-white/10 text-white/60'
                                              }`}
                                              title={d.detail}
                                            >
                                              <span className="font-medium">{d.label}</span>
                                              <span className="text-white/30 font-mono">{d.score}</span>
                                            </div>
                                          ))}
                                        </div>
                                      </div>
                                    )}

                                    {s.reasoning && (
                                      <div className="rounded-lg bg-black/30 border border-white/10 p-3">
                                        <div className="text-[10px] text-white/40 font-semibold uppercase mb-1">Analysis</div>
                                        <p className="text-xs text-white/70 leading-relaxed">{s.reasoning}</p>
                                      </div>
                                    )}

                                    {s.drop_candidate && (
                                      <div className="rounded-lg bg-rose-500/5 border border-rose-500/15 p-2.5">
                                        <div className="flex items-center gap-2 flex-wrap">
                                          <span className="text-rose-400 text-xs font-semibold">Drop:</span>
                                          <span className="text-xs text-white/70">{s.drop_candidate}</span>
                                          {s.drop_risk_label && (
                                            <span className={`px-1.5 py-0.5 rounded text-[9px] font-bold ${
                                              s.drop_risk_label === 'High' ? 'bg-rose-500/20 text-rose-300' :
                                              s.drop_risk_label === 'Moderate' || s.drop_risk_label === 'Low-Moderate' ? 'bg-amber-500/20 text-amber-300' :
                                              'bg-white/10 text-white/50'
                                            }`}>
                                              {s.drop_risk_label} regret risk
                                            </span>
                                          )}
                                        </div>
                                        {s.drop_reasoning && <p className="text-[10px] text-white/40 mt-1">{s.drop_reasoning}</p>}
                                      </div>
                                    )}
                                  </div>
                                )}
                              </div>
                            )
                          })
                        })()}
                      </div>

                      {(waiverAnalysis.positional_depth || []).length > 0 && (
                        <div className="rounded-xl bg-black/40 border border-white/10 p-4">
                          <h4 className="text-xs font-bold text-white/60 uppercase mb-3">Positional Depth</h4>
                          <div className="grid grid-cols-2 sm:grid-cols-4 gap-2">
                            {waiverAnalysis.positional_depth.map((d: any) => (
                              <div key={d.position} className="text-center p-2 rounded-lg bg-black/30 border border-white/5">
                                <div className="text-xs font-bold text-white/80">{d.position}</div>
                                <div className={`text-lg font-bold ${d.depth_rating >= 60 ? 'text-emerald-300' : d.depth_rating >= 40 ? 'text-cyan-300' : 'text-amber-300'}`}>
                                  {d.count}
                                </div>
                                <div className="text-[9px] text-white/30">vs {d.league_median} median</div>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}

                      {waiverAnalysis.roster_notes?.length > 0 && (
                        <div className="rounded-xl bg-black/40 border border-white/10 p-4">
                          <h4 className="text-xs font-bold text-white/60 uppercase mb-2">Roster Notes</h4>
                          <ul className="space-y-1">
                            {waiverAnalysis.roster_notes.map((note: string, i: number) => (
                              <li key={i} className="text-sm text-white/60 flex items-start gap-2">
                                <span className="w-1 h-1 rounded-full bg-cyan-400/50 flex-shrink-0 mt-2" />
                                {note}
                              </li>
                            ))}
                          </ul>
                        </div>
                      )}
                    </div>
                  )}
                  </>
                )}

                {activeTab === 'rankings' && (
                  <>
                  {/* Hero Metric */}
                  <HeroMetric 
                    value={rankingsData?.userRank ? `#${rankingsData.userRank}` : '‚Äî'}
                    label="Your Rank"
                    helper="Where you stand in this league"
                    accent="amber"
                  />
                  {/* Tab Headline */}
                  <p className="text-center text-sm sm:text-base text-white/60 mb-4">See exactly where your team stands in the league hierarchy.</p>
                  <div className="bg-black/30 border border-cyan-500/20 rounded-2xl p-4 sm:p-6">
                    <div className="flex items-start sm:items-center gap-3 mb-4">
                      <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-yellow-500/30 to-amber-500/30 flex items-center justify-center text-xl flex-shrink-0">üèÜ</div>
                      <div className="flex-1">
                        <h3 className="text-lg sm:text-xl font-bold text-cyan-400">League Rankings</h3>
                        <p className="text-xs sm:text-sm text-gray-400">See where you rank in your dynasty leagues</p>
                      </div>
                      {rankingsSelectedLeague && rankingsData && (
                        <button
                          onClick={() => {
                            const leagueName = rankingsDynastyLeagues.find(l => l.league_id === rankingsSelectedLeague)?.name || 'my league'
                            const url = `${window.location.origin}/af-legacy?tab=rankings&league=${rankingsSelectedLeague}`
                            const shareMessage = `Check out where you rank in ${leagueName} on AllFantasy!\n\n${url}\n\nEnter your Sleeper username to see your league rankings instantly.`
                            navigator.clipboard.writeText(shareMessage).then(() => {
                              setRankingsShareCopied(true)
                              setTimeout(() => setRankingsShareCopied(false), 3000)
                            }).catch(() => {
                              const ta = document.createElement('textarea')
                              ta.value = shareMessage
                              document.body.appendChild(ta)
                              ta.select()
                              document.execCommand('copy')
                              document.body.removeChild(ta)
                              setRankingsShareCopied(true)
                              setTimeout(() => setRankingsShareCopied(false), 3000)
                            })
                          }}
                          className={`flex items-center gap-1.5 px-3 py-1.5 rounded-xl text-xs font-medium transition flex-shrink-0 ${
                            rankingsShareCopied
                              ? 'bg-emerald-500/20 border border-emerald-400/30 text-emerald-300'
                              : 'bg-cyan-500/15 border border-cyan-400/20 text-cyan-300 hover:bg-cyan-500/25'
                          }`}
                        >
                          {rankingsShareCopied ? (
                            <>
                              <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>
                              Copied!
                            </>
                          ) : (
                            <>
                              <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" /></svg>
                              Share to League
                            </>
                          )}
                        </button>
                      )}
                    </div>

                    {rankingsDynastyLeagues.length === 0 && !rankingsLeaguesLoading && (
                      <button
                        onClick={loadRankingsLeagues}
                        className="px-5 py-2.5 bg-cyan-500/20 hover:bg-cyan-500/30 border border-cyan-400/30 text-cyan-200 rounded-xl transition font-medium"
                      >
                        Find Leagues
                      </button>
                    )}

                    {rankingsLeaguesLoading && (
                      <div className="text-gray-400 mb-4">Loading dynasty leagues...</div>
                    )}

                    {rankingsDynastyLeagues.length > 0 && (
                      <div className="space-y-4">
                        <div>
                          <label className="block text-sm text-white/70 mb-2">Select Dynasty League</label>
                          <select
                            value={rankingsSelectedLeague}
                            onChange={(e) => {
                              const newLeague = e.target.value
                              setRankingsSelectedLeague(newLeague)
                              setRankingsData(null)
                              if (newLeague && username) {
                                runRankingsAnalysis(newLeague)
                              }
                            }}
                            className="w-full px-4 py-3 rounded-xl bg-black/50 border border-white/20 text-white focus:outline-none focus:border-cyan-500/50"
                          >
                            {rankingsDynastyLeagues.map((lg) => (
                              <option key={lg.league_id} value={lg.league_id}>
                                {lg.name} ({lg.season}) - {lg.team_count} teams
                              </option>
                            ))}
                          </select>
                        </div>

                        <button
                          onClick={() => runRankingsAnalysis()}
                          disabled={rankingsLoading || !rankingsSelectedLeague}
                          className="px-6 py-3 bg-gradient-to-r from-yellow-500 to-amber-500 text-white font-semibold rounded-xl hover:from-yellow-400 hover:to-amber-400 transition disabled:opacity-50"
                        >
                          {rankingsLoading ? 'Analyzing Rankings...' : 'üèÜ Show My Rankings'}
                        </button>

                        {rankingsSelectedLeague && username && (
                          <>
                          <div className="mt-4 pt-4 border-t border-white/10">
                            <LeagueRankingsV2Panel
                              leagueId={rankingsSelectedLeague}
                              leagueName={rankingsDynastyLeagues.find(l => l.league_id === rankingsSelectedLeague)?.name}
                              username={username}
                            />
                          </div>
                          <div className="mt-6 pt-6 border-t border-white/10">
                            <EnhancedRankingsPanel
                              username={username}
                              leagueId={rankingsSelectedLeague}
                              leagueName={rankingsDynastyLeagues.find(l => l.league_id === rankingsSelectedLeague)?.name}
                            />
                          </div>
                          <div className="mt-6 pt-6 border-t border-white/10">
                            <AdaptiveRankings
                              username={username}
                              leagueId={rankingsSelectedLeague}
                              leagueName={rankingsDynastyLeagues.find(l => l.league_id === rankingsSelectedLeague)?.name}
                            />
                          </div>
                          <div className="mt-6 pt-6 border-t border-white/10 space-y-4">
                            <DraftGradesSection
                              leagueId={rankingsSelectedLeague}
                              season={String(rankingsData?.season ?? rankingsDynastyLeagues.find(l => l.league_id === rankingsSelectedLeague)?.season ?? new Date().getFullYear())}
                              defaultWeek={Number(rankingsData?.week ?? 1)}
                            />
                            <HallOfFameSection
                              leagueId={rankingsSelectedLeague}
                              seasons={[String(new Date().getFullYear()), String(new Date().getFullYear() - 1), String(new Date().getFullYear() - 2)]}
                              defaultSeason={String(
                                rankingsData?.season ??
                                  rankingsDynastyLeagues.find(
                                    (l) => l.league_id === rankingsSelectedLeague
                                  )?.season ??
                                  new Date().getFullYear()
                              )}
                            />
                          </div>
                          </>
                        )}

                        {rankingsLoading && (
                          <div className="space-y-2">
                            <div className="h-2 bg-white/10 rounded-full overflow-hidden">
                              <div className="h-full bg-gradient-to-r from-yellow-500 via-amber-500 to-yellow-500 rounded-full animate-pulse" style={{ width: '100%' }} />
                            </div>
                            <p className="text-center text-sm text-gray-400">AI is analyzing all rosters and stats...</p>
                          </div>
                        )}

                        {rankingsError && (
                          <div className="p-4 rounded-xl bg-red-500/10 border border-red-400/30 text-red-300 flex items-center justify-between gap-3">
                            <span>{rankingsError}</span>
                            <button
                              onClick={() => runRankingsAnalysis()}
                              className="shrink-0 px-4 py-1.5 bg-red-500/20 hover:bg-red-500/30 border border-red-400/30 rounded-lg text-sm text-red-200 transition"
                            >
                              Retry
                            </button>
                          </div>
                        )}

                        {rankingsData && rankingsData.fallbackMode && (
                          <div className="space-y-6 mt-4">
                            <div className="rounded-xl border border-yellow-500/30 bg-yellow-500/10 p-4 text-sm text-yellow-200">
                              <div className="font-semibold">Preseason Mode</div>
                              <div className="mt-1 text-yellow-300/80">
                                No finalized roster data available yet. Rankings will populate automatically once the season begins.
                              </div>
                            </div>
                            {rankingsData.aiAnalysis && (
                              <div className="rounded-xl bg-black/30 border border-white/10 p-4">
                                <div className="text-xs font-semibold text-white/60 uppercase tracking-wider mb-2">AI Insight</div>
                                <p className="text-sm text-white/70">{rankingsData.aiAnalysis}</p>
                              </div>
                            )}
                          </div>
                        )}

                        {rankingsData && !rankingsData.fallbackMode && (
                          <div className="space-y-6 mt-4">
                            {rankingsData.rankingSourceNote && (
                              <div className={`rounded-xl px-3 py-2 text-xs flex items-center gap-2 ${
                                rankingsData.rankingSource === 'preseason_market'
                                  ? 'bg-amber-500/10 border border-amber-500/20 text-amber-300'
                                  : rankingsData.rankingSource === 'snapshot'
                                    ? 'bg-blue-500/10 border border-blue-500/20 text-blue-300'
                                    : 'bg-emerald-500/10 border border-emerald-500/20 text-emerald-300'
                              }`}>
                                <span className="font-semibold">{rankingsData.rankingSource === 'preseason_market' ? 'Preseason' : rankingsData.rankingSource === 'snapshot' ? 'Cached' : 'Live'}</span>
                                <span className="text-white/50">{rankingsData.rankingSourceNote}</span>
                              </div>
                            )}
                            {/* Dynasty Daddy Style Top Stat Cards */}
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                              <div className="p-4 rounded-xl bg-gradient-to-b from-slate-800/80 to-slate-900/80 border border-slate-700/50 text-center">
                                <div className="text-[10px] sm:text-xs text-slate-400 uppercase tracking-wider mb-1">Roster Value</div>
                                <div className="text-2xl sm:text-3xl font-bold text-white">#{rankingsData.rosterValueRank}</div>
                              </div>
                              <div className="p-4 rounded-xl bg-gradient-to-b from-slate-800/80 to-slate-900/80 border border-slate-700/50 text-center">
                                <div className="text-[10px] sm:text-xs text-slate-400 uppercase tracking-wider mb-1">Points For</div>
                                <div className="text-2xl sm:text-3xl font-bold text-white">#{rankingsData.pointsForRank}</div>
                              </div>
                              <div className="p-4 rounded-xl bg-gradient-to-b from-slate-800/80 to-slate-900/80 border border-slate-700/50 text-center">
                                <div className="text-[10px] sm:text-xs text-slate-400 uppercase tracking-wider mb-1">Win Rate</div>
                                <div className="text-2xl sm:text-3xl font-bold text-white">#{rankingsData.winRateRank}</div>
                              </div>
                              <div className="p-4 rounded-xl bg-gradient-to-b from-cyan-900/50 to-cyan-950/50 border border-cyan-700/40 text-center">
                                <div className="text-[10px] sm:text-xs text-cyan-400 uppercase tracking-wider mb-1">Future Outlook</div>
                                <div className="text-2xl sm:text-3xl font-bold text-cyan-300">#{rankingsData.futureOutlookRank}</div>
                              </div>
                            </div>

                            {/* Horizontal Roster Value Chart */}
                            <div className="rounded-xl bg-slate-900/80 border border-slate-700/50 p-4">
                              <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-4">
                                <h4 className="text-base sm:text-lg font-bold text-white">Roster Value by Position</h4>
                                <div className="flex flex-wrap gap-x-3 gap-y-1 text-[10px] sm:text-xs text-slate-300">
                                  <span className="flex items-center gap-1.5"><span className="w-2.5 h-2.5 rounded-sm bg-violet-500"></span>QB</span>
                                  <span className="flex items-center gap-1.5"><span className="w-2.5 h-2.5 rounded-sm bg-sky-500"></span>RB</span>
                                  <span className="flex items-center gap-1.5"><span className="w-2.5 h-2.5 rounded-sm bg-emerald-500"></span>WR</span>
                                  <span className="flex items-center gap-1.5"><span className="w-2.5 h-2.5 rounded-sm bg-amber-500"></span>TE</span>
                                  <span className="flex items-center gap-1.5"><span className="w-2.5 h-2.5 rounded-sm bg-rose-500"></span>Picks</span>
                                </div>
                              </div>
                              {(() => {
                                const allTeamValues = rankingsData.allTeams?.map((t: any) => ({
                                  ...t,
                                  total: (t.qbValue || 0) + (t.rbValue || 0) + (t.wrValue || 0) + (t.teValue || 0) + (t.pickValue || 0)
                                })) || []
                                const sortedTeams = [...allTeamValues].sort((a, b) => b.total - a.total)
                                const maxValue = Math.max(...sortedTeams.map((t: any) => t.total), 1)
                                const leagueAvg = allTeamValues.length > 0 
                                  ? Math.round(allTeamValues.reduce((sum: number, t: any) => sum + t.total, 0) / allTeamValues.length)
                                  : 0
                                const avgPctOfMax = maxValue > 0 ? (leagueAvg / maxValue) * 100 : 0

                                const posColors = {
                                  qb: { bg: 'bg-violet-500', text: 'text-violet-300', label: 'QB' },
                                  rb: { bg: 'bg-sky-500', text: 'text-sky-300', label: 'RB' },
                                  wr: { bg: 'bg-emerald-500', text: 'text-emerald-300', label: 'WR' },
                                  te: { bg: 'bg-amber-500', text: 'text-amber-300', label: 'TE' },
                                  picks: { bg: 'bg-rose-500', text: 'text-rose-300', label: 'Pk' },
                                }
                                
                                return (
                                  <>
                                    <div className="flex items-center gap-4 mb-4 text-xs text-slate-400">
                                      <span>League Avg: <span className="text-white font-semibold">{leagueAvg.toLocaleString()}</span></span>
                                      <span>|</span>
                                      <span>Top Team: <span className="text-emerald-400 font-semibold">{sortedTeams[0]?.total?.toLocaleString() || 0}</span></span>
                                    </div>
                                    <div className="space-y-2 relative">
                                      {/* League avg vertical line */}
                                      <div className="absolute top-0 bottom-0 z-10 pointer-events-none" style={{ left: `${avgPctOfMax}%` }}>
                                        <div className="h-full border-l-2 border-dashed border-slate-500/40"></div>
                                        <div className="absolute -top-5 left-1/2 -translate-x-1/2 text-[9px] text-slate-500 whitespace-nowrap">AVG</div>
                                      </div>
                                      {sortedTeams.map((team: any, idx: number) => {
                                        const totalValue = team.total
                                        const widthPct = maxValue > 0 ? (totalValue / maxValue) * 100 : 0
                                        const rank = idx + 1

                                        const qbVal = team.qbValue || 0
                                        const rbVal = team.rbValue || 0
                                        const wrVal = team.wrValue || 0
                                        const teVal = team.teValue || 0
                                        const pickVal = team.pickValue || 0

                                        const qbPct = totalValue > 0 ? (qbVal / totalValue) * 100 : 0
                                        const rbPct = totalValue > 0 ? (rbVal / totalValue) * 100 : 0
                                        const wrPct = totalValue > 0 ? (wrVal / totalValue) * 100 : 0
                                        const tePct = totalValue > 0 ? (teVal / totalValue) * 100 : 0
                                        const pickPct = totalValue > 0 ? (pickVal / totalValue) * 100 : 0

                                        const vsAvg = totalValue - leagueAvg
                                        const vsAvgPct = leagueAvg > 0 ? Math.round((vsAvg / leagueAvg) * 100) : 0

                                        const rankColor = rank <= 3 ? 'bg-emerald-500 text-white' : rank <= Math.ceil(sortedTeams.length * 0.5) ? 'bg-cyan-600/80 text-white' : rank >= sortedTeams.length - 2 ? 'bg-red-500 text-white' : 'bg-slate-600 text-slate-300'

                                        return (
                                          <div key={team.userId} className="group">
                                            <div className="flex items-center gap-2 sm:gap-3">
                                              <div className={`w-6 h-6 sm:w-7 sm:h-7 rounded-md flex items-center justify-center text-[10px] sm:text-xs font-bold flex-shrink-0 ${rankColor}`}>
                                                {rank}
                                              </div>
                                              <div className={`w-20 sm:w-28 text-xs sm:text-sm font-medium truncate flex-shrink-0 ${team.isUser ? 'text-yellow-400' : 'text-slate-200'}`} title={team.teamName}>
                                                {team.teamName}
                                              </div>
                                              <div className="flex-1 min-w-0">
                                                <div className="relative flex h-7 sm:h-8 rounded-md overflow-hidden cursor-pointer transition-all group-hover:brightness-110" style={{ width: `${Math.max(widthPct, 8)}%` }}
                                                  onClick={() => setRankingsExpandedTeam(rankingsExpandedTeam === team.userId ? null : team.userId)}
                                                >
                                                  {qbPct > 0 && <div className={`${posColors.qb.bg} h-full relative flex items-center justify-center transition-all`} style={{ width: `${qbPct}%` }}>
                                                    {qbPct > 10 && <span className="text-[8px] sm:text-[9px] font-bold text-white/90">{Math.round(qbPct)}%</span>}
                                                  </div>}
                                                  {rbPct > 0 && <div className={`${posColors.rb.bg} h-full relative flex items-center justify-center transition-all`} style={{ width: `${rbPct}%` }}>
                                                    {rbPct > 10 && <span className="text-[8px] sm:text-[9px] font-bold text-white/90">{Math.round(rbPct)}%</span>}
                                                  </div>}
                                                  {wrPct > 0 && <div className={`${posColors.wr.bg} h-full relative flex items-center justify-center transition-all`} style={{ width: `${wrPct}%` }}>
                                                    {wrPct > 10 && <span className="text-[8px] sm:text-[9px] font-bold text-white/90">{Math.round(wrPct)}%</span>}
                                                  </div>}
                                                  {tePct > 0 && <div className={`${posColors.te.bg} h-full relative flex items-center justify-center transition-all`} style={{ width: `${tePct}%` }}>
                                                    {tePct > 10 && <span className="text-[8px] sm:text-[9px] font-bold text-white/90">{Math.round(tePct)}%</span>}
                                                  </div>}
                                                  {pickPct > 0 && <div className={`${posColors.picks.bg} h-full relative flex items-center justify-center transition-all`} style={{ width: `${pickPct}%` }}>
                                                    {pickPct > 10 && <span className="text-[8px] sm:text-[9px] font-bold text-white/90">{Math.round(pickPct)}%</span>}
                                                  </div>}
                                                  {team.isUser && <div className="absolute inset-0 ring-2 ring-yellow-400/60 rounded-md pointer-events-none"></div>}
                                                </div>
                                              </div>
                                              <div className="flex items-center gap-2 flex-shrink-0 w-24 sm:w-32 justify-end">
                                                <span className="text-[10px] sm:text-xs font-semibold text-white tabular-nums">{(totalValue / 1000).toFixed(1)}k</span>
                                                <span className={`text-[9px] sm:text-[10px] font-medium tabular-nums w-10 text-right ${vsAvg >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                                  {vsAvg >= 0 ? '+' : ''}{vsAvgPct}%
                                                </span>
                                              </div>
                                            </div>
                                            {/* Expandable detail row */}
                                            {rankingsExpandedTeam === team.userId && (
                                              <div className="ml-8 sm:ml-10 mt-1.5 mb-2 p-3 rounded-lg bg-slate-800/60 border border-slate-700/40 text-xs animate-fadeIn">
                                                <div className="grid grid-cols-5 gap-2">
                                                  {[
                                                    { label: 'QB', val: qbVal, pct: qbPct, color: posColors.qb },
                                                    { label: 'RB', val: rbVal, pct: rbPct, color: posColors.rb },
                                                    { label: 'WR', val: wrVal, pct: wrPct, color: posColors.wr },
                                                    { label: 'TE', val: teVal, pct: tePct, color: posColors.te },
                                                    { label: 'Picks', val: pickVal, pct: pickPct, color: posColors.picks },
                                                  ].map(pos => (
                                                    <div key={pos.label} className="text-center">
                                                      <div className={`text-[10px] font-bold ${pos.color.text}`}>{pos.label}</div>
                                                      <div className="text-white font-semibold text-sm">{(pos.val / 1000).toFixed(1)}k</div>
                                                      <div className="text-slate-400 text-[10px]">{Math.round(pos.pct)}%</div>
                                                    </div>
                                                  ))}
                                                </div>
                                                <div className="mt-2 pt-2 border-t border-slate-700/40 flex items-center justify-between">
                                                  <span className="text-slate-400">Total: <span className="text-white font-semibold">{totalValue.toLocaleString()}</span></span>
                                                  <span className={`font-medium ${vsAvg >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                                    {vsAvg >= 0 ? '+' : ''}{vsAvg.toLocaleString()} vs avg
                                                  </span>
                                                </div>
                                                <button
                                                  onClick={() => navigateToChat(`Tell me about ${team.displayName || team.username}'s team in my league. They have ${(totalValue / 1000).toFixed(1)}k total value (${vsAvg >= 0 ? '+' : ''}${vsAvg.toLocaleString()} vs avg). What trade opportunities do I have with them?`, rankingsSelectedLeague)}
                                                  className="mt-2 w-full flex items-center justify-center gap-1.5 px-2 py-1 rounded-md bg-cyan-500/10 border border-cyan-400/20 text-cyan-300 text-[10px] font-medium hover:bg-cyan-500/20 transition"
                                                >
                                                  üí¨ Ask AI about this team
                                                </button>
                                              </div>
                                            )}
                                          </div>
                                        )
                                      })}
                                    </div>
                                  </>
                                )
                              })()}
                            </div>

                            {/* League Overview Table - Dynasty Daddy Style */}
                            <div className="rounded-xl bg-slate-900/80 border border-slate-700/50 overflow-hidden">
                              <div className="p-4 border-b border-slate-700/50">
                                <h4 className="text-base sm:text-lg font-bold text-white mb-3">League Overview</h4>
                                <div className="flex flex-wrap gap-2">
                                  <span className="px-3 py-1.5 rounded-lg bg-slate-700/80 border border-slate-600/50 text-xs font-medium text-white">
                                    {rankingsData.totalTeams} Teams
                                  </span>
                                  {rankingsData.leagueSettings?.isSF && (
                                    <span className="px-3 py-1.5 rounded-lg bg-slate-700/80 border border-slate-600/50 text-xs font-medium text-white">
                                      SF/2QB
                                    </span>
                                  )}
                                  {rankingsData.leagueSettings?.starters && (
                                    <span className="px-3 py-1.5 rounded-lg bg-slate-700/80 border border-slate-600/50 text-xs font-medium text-white">
                                      Start {rankingsData.leagueSettings.starters}
                                    </span>
                                  )}
                                  {rankingsData.leagueSettings?.hasTEP && (
                                    <span className="px-3 py-1.5 rounded-lg bg-slate-700/80 border border-slate-600/50 text-xs font-medium text-white">
                                      TE+{rankingsData.leagueSettings.tepBonus?.toFixed(1) || ''}
                                    </span>
                                  )}
                                </div>
                              </div>
                              
                              {/* Desktop Table */}
                              <div className="hidden md:block overflow-x-auto">
                                <table className="w-full text-sm">
                                  <thead>
                                    <tr className="border-b border-slate-700/50 bg-slate-800/30">
                                      <th className="px-2 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider w-10"></th>
                                      <th className="px-3 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Team</th>
                                      <th className="px-2 py-3 text-center text-xs font-medium text-slate-400 uppercase tracking-wider w-16">Record</th>
                                      <th className="px-2 py-3 text-center text-xs font-medium text-slate-400 uppercase tracking-wider w-28">Tier</th>
                                      <th className="px-2 py-3 text-center text-xs font-medium text-slate-400 uppercase tracking-wider w-16">Value</th>
                                      <th className="px-2 py-3 text-center text-xs font-medium text-slate-400 uppercase tracking-wider w-16">QB</th>
                                      <th className="px-2 py-3 text-center text-xs font-medium text-slate-400 uppercase tracking-wider w-16">RB</th>
                                      <th className="px-2 py-3 text-center text-xs font-medium text-slate-400 uppercase tracking-wider w-16">WR</th>
                                      <th className="px-2 py-3 text-center text-xs font-medium text-slate-400 uppercase tracking-wider w-16">TE</th>
                                      <th className="px-2 py-3 text-center text-xs font-medium text-slate-400 uppercase tracking-wider w-16">Picks</th>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    {rankingsData.allTeams?.map((team: any, idx: number) => {
                                      const getRankIndicator = (rank: number, total: number) => {
                                        const pct = (total - rank + 1) / total
                                        const width = Math.max(20, Math.round(pct * 100))
                                        let barColor = 'bg-slate-600'
                                        let textColor = 'text-slate-300'
                                        if (rank <= Math.ceil(total * 0.25)) {
                                          barColor = 'bg-emerald-500/70'
                                          textColor = 'text-emerald-300'
                                        } else if (rank <= Math.ceil(total * 0.5)) {
                                          barColor = 'bg-cyan-500/50'
                                          textColor = 'text-cyan-300'
                                        } else if (rank <= Math.ceil(total * 0.75)) {
                                          barColor = 'bg-amber-500/50'
                                          textColor = 'text-amber-300'
                                        } else {
                                          barColor = 'bg-rose-500/50'
                                          textColor = 'text-rose-300'
                                        }
                                        return { width, barColor, textColor }
                                      }
                                      
                                      const getTierStyle = (tier: string) => {
                                        switch (tier) {
                                          case 'Contender': return 'border-emerald-500/50 bg-emerald-500/10 text-emerald-400'
                                          case 'Frisky': return 'border-amber-500/50 bg-amber-500/10 text-amber-400'
                                          case 'Fraud': return 'border-rose-500/50 bg-rose-500/10 text-rose-400'
                                          case 'Trust the Process': return 'border-purple-500/50 bg-purple-500/10 text-purple-400'
                                          default: return 'border-slate-500/50 bg-slate-500/10 text-slate-400'
                                        }
                                      }
                                      
                                      const isExpanded = rankingsExpandedTeam === team.userId
                                      
                                      const RankCell = ({ rank, total }: { rank: number; total: number }) => {
                                        const { width, barColor, textColor } = getRankIndicator(rank, total)
                                        return (
                                          <div className="relative flex items-center justify-center">
                                            <div className="absolute inset-y-1 left-0 right-0 rounded-sm overflow-hidden bg-slate-800/50">
                                              <div 
                                                className={`h-full ${barColor} transition-all`} 
                                                style={{ width: `${width}%` }}
                                              />
                                            </div>
                                            <span className={`relative z-10 font-semibold text-sm ${textColor}`}>{rank}</span>
                                          </div>
                                        )
                                      }
                                      
                                      return (
                                        <React.Fragment key={team.userId}>
                                          <tr 
                                            className={`border-b border-slate-800/30 cursor-pointer transition-colors ${team.isUser ? 'bg-gradient-to-r from-yellow-500/10 to-transparent' : 'hover:bg-slate-800/20'} ${isExpanded ? 'bg-slate-800/40' : ''}`}
                                            onClick={() => setRankingsExpandedTeam(isExpanded ? null : team.userId)}
                                          >
                                            <td className="px-2 py-3">
                                              <div className="flex items-center gap-1">
                                                <span className={`text-xs text-slate-500 transition-transform ${isExpanded ? 'rotate-90' : ''}`}>‚ñ∂</span>
                                                <span className={`w-6 h-6 flex items-center justify-center rounded font-bold text-xs ${
                                                  idx === 0 ? 'bg-gradient-to-br from-yellow-400 to-amber-500 text-black shadow-sm shadow-yellow-500/30' :
                                                  idx === 1 ? 'bg-gradient-to-br from-slate-300 to-slate-400 text-black' :
                                                  idx === 2 ? 'bg-gradient-to-br from-amber-600 to-amber-700 text-white' :
                                                  'text-slate-400'
                                                }`}>
                                                  {idx + 1}
                                                </span>
                                              </div>
                                            </td>
                                            <td className="px-3 py-3">
                                              <div className={`font-medium ${team.isUser ? 'text-yellow-300' : 'text-white'}`}>
                                                {team.teamName}
                                                {team.sleeperUsername && team.sleeperUsername !== team.teamName && (
                                                  <span className="text-slate-500 font-normal text-xs ml-1.5">@{team.sleeperUsername}</span>
                                                )}
                                              </div>
                                            </td>
                                            <td className="px-2 py-2 text-center">
                                              <span className="text-slate-300 font-medium">{team.wins}-{team.losses}</span>
                                            </td>
                                            <td className="px-2 py-2 text-center">
                                              <span className={`inline-flex items-center justify-center px-2.5 py-1 rounded border text-xs font-medium ${getTierStyle(team.tier)}`}>
                                                {team.tier === 'Trust the Process' ? 'Rebuild' : team.tier}
                                              </span>
                                            </td>
                                            <td className="px-2 py-2">
                                              <RankCell rank={team.overallRank} total={rankingsData.totalTeams} />
                                            </td>
                                            <td className="px-2 py-2">
                                              <RankCell rank={team.qbRank} total={rankingsData.totalTeams} />
                                            </td>
                                            <td className="px-2 py-2">
                                              <RankCell rank={team.rbRank} total={rankingsData.totalTeams} />
                                            </td>
                                            <td className="px-2 py-2">
                                              <RankCell rank={team.wrRank} total={rankingsData.totalTeams} />
                                            </td>
                                            <td className="px-2 py-2">
                                              <RankCell rank={team.teRank} total={rankingsData.totalTeams} />
                                            </td>
                                            <td className="px-2 py-2">
                                              <RankCell rank={team.pickRank} total={rankingsData.totalTeams} />
                                            </td>
                                          </tr>
                                          {isExpanded && team.players && (
                                            <tr className="bg-slate-900/80">
                                              <td colSpan={10} className="p-4">
                                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                                  <div className="space-y-2">
                                                    <div className="flex items-center gap-2 mb-2">
                                                      <span className="text-xs font-bold text-rose-400 uppercase">QB Rank: {team.qbRank}</span>
                                                      <span className="text-xs text-slate-500">Value: {team.qbValue?.toLocaleString()} | Age: {team.avgAge}</span>
                                                    </div>
                                                    {team.players?.qb?.slice(0, 5).map((p: any, i: number) => (
                                                      <div key={i} className="flex items-center gap-2 text-xs">
                                                        <span className={`w-4 h-4 flex items-center justify-center rounded text-[10px] font-bold ${i === 0 ? 'bg-rose-500/50 text-rose-200' : 'bg-slate-700/50 text-slate-400'}`}>
                                                          {i === 0 ? '‚òÖ' : ''}
                                                        </span>
                                                        <PlayerBadge name={p.name} sleeperId={p.id || p.playerId} position={p.position || 'QB'} team={p.team} size="sm" showTeamLogo={false} showPosition={false} />
                                                        <span className="text-slate-400 ml-auto">{p.value?.toLocaleString()}</span>
                                                      </div>
                                                    ))}
                                                  </div>
                                                  <div className="space-y-2">
                                                    <div className="flex items-center gap-2 mb-2">
                                                      <span className="text-xs font-bold text-emerald-400 uppercase">RB Rank: {team.rbRank}</span>
                                                      <span className="text-xs text-slate-500">Value: {team.rbValue?.toLocaleString()}</span>
                                                    </div>
                                                    {team.players?.rb?.slice(0, 6).map((p: any, i: number) => (
                                                      <div key={i} className="flex items-center gap-2 text-xs">
                                                        <span className={`w-4 h-4 flex items-center justify-center rounded text-[10px] font-bold ${i < 2 ? 'bg-emerald-500/50 text-emerald-200' : 'bg-slate-700/50 text-slate-400'}`}>
                                                          {i < 2 ? '‚òÖ' : ''}
                                                        </span>
                                                        <PlayerBadge name={p.name} sleeperId={p.id || p.playerId} position={p.position || 'RB'} team={p.team} size="sm" showTeamLogo={false} showPosition={false} />
                                                        <span className="text-slate-400 ml-auto">{p.value?.toLocaleString()}</span>
                                                      </div>
                                                    ))}
                                                  </div>
                                                  <div className="space-y-2">
                                                    <div className="flex items-center gap-2 mb-2">
                                                      <span className="text-xs font-bold text-sky-400 uppercase">WR Rank: {team.wrRank}</span>
                                                      <span className="text-xs text-slate-500">Value: {team.wrValue?.toLocaleString()}</span>
                                                    </div>
                                                    {team.players?.wr?.slice(0, 8).map((p: any, i: number) => (
                                                      <div key={i} className="flex items-center gap-2 text-xs">
                                                        <span className={`w-4 h-4 flex items-center justify-center rounded text-[10px] font-bold ${i < 3 ? 'bg-sky-500/50 text-sky-200' : 'bg-slate-700/50 text-slate-400'}`}>
                                                          {i < 3 ? '‚òÖ' : ''}
                                                        </span>
                                                        <PlayerBadge name={p.name} sleeperId={p.id || p.playerId} position={p.position || 'WR'} team={p.team} size="sm" showTeamLogo={false} showPosition={false} />
                                                        <span className="text-slate-400 ml-auto">{p.value?.toLocaleString()}</span>
                                                      </div>
                                                    ))}
                                                  </div>
                                                  <div className="space-y-2">
                                                    <div className="flex items-center gap-2 mb-2">
                                                      <span className="text-xs font-bold text-amber-400 uppercase">TE Rank: {team.teRank}</span>
                                                      <span className="text-xs text-slate-500">Value: {team.teValue?.toLocaleString()}</span>
                                                    </div>
                                                    {team.players?.te?.slice(0, 4).map((p: any, i: number) => (
                                                      <div key={i} className="flex items-center gap-2 text-xs">
                                                        <span className={`w-4 h-4 flex items-center justify-center rounded text-[10px] font-bold ${i === 0 ? 'bg-amber-500/50 text-amber-200' : 'bg-slate-700/50 text-slate-400'}`}>
                                                          {i === 0 ? '‚òÖ' : ''}
                                                        </span>
                                                        <PlayerBadge name={p.name} sleeperId={p.id || p.playerId} position={p.position || 'TE'} team={p.team} size="sm" showTeamLogo={false} showPosition={false} />
                                                        <span className="text-slate-400 ml-auto">{p.value?.toLocaleString()}</span>
                                                      </div>
                                                    ))}
                                                  </div>
                                                  {team.players?.picks?.length > 0 && (
                                                    <div className="space-y-2 col-span-4 pt-2 border-t border-slate-700/50 mt-2">
                                                      <div className="flex items-center gap-2 mb-2">
                                                        <span className="text-xs font-bold text-yellow-400 uppercase">Draft Capital Rank: {team.pickRank}</span>
                                                        <span className="text-xs text-slate-500">Value: {team.pickValue?.toLocaleString()}</span>
                                                      </div>
                                                      <div className="flex flex-wrap gap-2">
                                                        {team.players?.picks?.map((pick: any, i: number) => (
                                                          <span key={i} className="px-2 py-1 rounded bg-yellow-600/30 text-yellow-300 text-xs">
                                                            {pick.name} ({pick.value?.toLocaleString()})
                                                          </span>
                                                        ))}
                                                      </div>
                                                    </div>
                                                  )}
                                                </div>
                                              </td>
                                            </tr>
                                          )}
                                        </React.Fragment>
                                      )
                                    })}
                                  </tbody>
                                </table>
                              </div>
                              
                              {/* Mobile Cards - Dynasty Daddy Style */}
                              <div className="md:hidden p-3 space-y-2">
                                {rankingsData.allTeams?.map((team: any, idx: number) => {
                                  const getRankColor = (rank: number, total: number) => {
                                    const pct = rank / total
                                    if (pct <= 0.17) return 'bg-teal-500 text-white'
                                    if (pct <= 0.33) return 'bg-teal-600/70 text-white'
                                    if (pct <= 0.50) return 'bg-slate-600/70 text-white'
                                    if (pct <= 0.67) return 'bg-slate-700/70 text-white'
                                    if (pct <= 0.83) return 'bg-rose-700/70 text-white'
                                    return 'bg-rose-800 text-white'
                                  }
                                  
                                  const getTierStyle = (tier: string) => {
                                    switch (tier) {
                                      case 'Contender': return 'bg-emerald-600/80 text-white'
                                      case 'Frisky': return 'bg-amber-600/80 text-white'
                                      case 'Fraud': return 'bg-orange-600/80 text-white'
                                      case 'Trust the Process': return 'bg-purple-600/80 text-white'
                                      default: return 'bg-slate-600/80 text-white'
                                    }
                                  }
                                  
                                  const isMobileExpanded = rankingsExpandedTeam === team.userId
                                  
                                  return (
                                    <div 
                                      key={team.userId}
                                      className={`rounded-xl ${team.isUser ? 'bg-yellow-500/15 border border-yellow-500/30' : 'bg-slate-800/50 border border-slate-700/30'}`}
                                    >
                                      <div 
                                        className="p-3 cursor-pointer"
                                        onClick={() => setRankingsExpandedTeam(isMobileExpanded ? null : team.userId)}
                                      >
                                        <div className="flex items-center gap-3 mb-2">
                                          <div className="flex items-center gap-1">
                                            <span className={`text-xs transition ${isMobileExpanded ? 'rotate-90' : ''}`}>‚ñ∂</span>
                                            <span className={`w-7 h-7 flex items-center justify-center rounded-full font-bold text-sm ${
                                              idx === 0 ? 'bg-gradient-to-br from-yellow-400 to-amber-500 text-black' :
                                              idx === 1 ? 'bg-gradient-to-br from-slate-300 to-slate-400 text-black' :
                                              idx === 2 ? 'bg-gradient-to-br from-amber-600 to-amber-700 text-white' :
                                              'bg-slate-700 text-slate-300'
                                            }`}>
                                              {idx + 1}
                                            </span>
                                          </div>
                                          <div className="flex-1 min-w-0">
                                            <div className={`font-medium truncate ${team.isUser ? 'text-yellow-300' : 'text-white'}`}>
                                              {team.teamName}
                                            </div>
                                            {team.sleeperUsername && team.sleeperUsername !== team.teamName && (
                                              <div className="text-slate-400 text-xs truncate">@{team.sleeperUsername}</div>
                                            )}
                                          </div>
                                          <div className="text-right">
                                            <div className="text-white font-medium text-sm">{team.wins}-{team.losses}</div>
                                            <span className={`inline-flex items-center justify-center px-2 py-0.5 rounded text-[10px] font-semibold ${getTierStyle(team.tier)}`}>
                                              {team.tier}
                                            </span>
                                          </div>
                                        </div>
                                        <div className="grid grid-cols-6 gap-1">
                                          <div className={`rounded py-1.5 text-center ${getRankColor(team.overallRank, rankingsData.totalTeams)}`}>
                                            <div className="text-[9px] opacity-80 font-medium">TEAM</div>
                                            <div className="font-bold text-xs">{team.overallRank}</div>
                                          </div>
                                          <div className={`rounded py-1.5 text-center ${getRankColor(team.qbRank, rankingsData.totalTeams)}`}>
                                            <div className="text-[9px] opacity-80 font-medium">QB</div>
                                            <div className="font-bold text-xs">{team.qbRank}</div>
                                          </div>
                                          <div className={`rounded py-1.5 text-center ${getRankColor(team.rbRank, rankingsData.totalTeams)}`}>
                                            <div className="text-[9px] opacity-80 font-medium">RB</div>
                                            <div className="font-bold text-xs">{team.rbRank}</div>
                                          </div>
                                          <div className={`rounded py-1.5 text-center ${getRankColor(team.wrRank, rankingsData.totalTeams)}`}>
                                            <div className="text-[9px] opacity-80 font-medium">WR</div>
                                            <div className="font-bold text-xs">{team.wrRank}</div>
                                          </div>
                                          <div className={`rounded py-1.5 text-center ${getRankColor(team.teRank, rankingsData.totalTeams)}`}>
                                            <div className="text-[9px] opacity-80 font-medium">TE</div>
                                            <div className="font-bold text-xs">{team.teRank}</div>
                                          </div>
                                          <div className={`rounded py-1.5 text-center ${getRankColor(team.pickRank, rankingsData.totalTeams)}`}>
                                            <div className="text-[9px] opacity-80 font-medium">Pick</div>
                                            <div className="font-bold text-xs">{team.pickRank}</div>
                                          </div>
                                        </div>
                                      </div>
                                      {isMobileExpanded && team.players && (
                                        <div className="px-3 pb-3 pt-1 border-t border-slate-700/50 space-y-3">
                                          <div>
                                            <div className="text-xs font-bold text-rose-400 mb-1">QB (Rank: {team.qbRank})</div>
                                            <div className="space-y-0.5">
                                              {team.players?.qb?.slice(0, 3).map((p: any, i: number) => (
                                                <div key={i} className="flex items-center justify-between text-xs">
                                                  <PlayerBadge name={p.name} sleeperId={p.id || p.playerId} position={p.position || 'QB'} team={p.team} size="sm" showTeamLogo={false} showPosition={false} />
                                                  <span className="text-slate-400">{p.value?.toLocaleString()}</span>
                                                </div>
                                              ))}
                                            </div>
                                          </div>
                                          <div>
                                            <div className="text-xs font-bold text-emerald-400 mb-1">RB (Rank: {team.rbRank})</div>
                                            <div className="space-y-0.5">
                                              {team.players?.rb?.slice(0, 4).map((p: any, i: number) => (
                                                <div key={i} className="flex items-center justify-between text-xs">
                                                  <PlayerBadge name={p.name} sleeperId={p.id || p.playerId} position={p.position || 'RB'} team={p.team} size="sm" showTeamLogo={false} showPosition={false} />
                                                  <span className="text-slate-400">{p.value?.toLocaleString()}</span>
                                                </div>
                                              ))}
                                            </div>
                                          </div>
                                          <div>
                                            <div className="text-xs font-bold text-sky-400 mb-1">WR (Rank: {team.wrRank})</div>
                                            <div className="space-y-0.5">
                                              {team.players?.wr?.slice(0, 5).map((p: any, i: number) => (
                                                <div key={i} className="flex items-center justify-between text-xs">
                                                  <PlayerBadge name={p.name} sleeperId={p.id || p.playerId} position={p.position || 'WR'} team={p.team} size="sm" showTeamLogo={false} showPosition={false} />
                                                  <span className="text-slate-400">{p.value?.toLocaleString()}</span>
                                                </div>
                                              ))}
                                            </div>
                                          </div>
                                          <div>
                                            <div className="text-xs font-bold text-amber-400 mb-1">TE (Rank: {team.teRank})</div>
                                            <div className="space-y-0.5">
                                              {team.players?.te?.slice(0, 3).map((p: any, i: number) => (
                                                <div key={i} className="flex items-center justify-between text-xs">
                                                  <PlayerBadge name={p.name} sleeperId={p.id || p.playerId} position={p.position || 'TE'} team={p.team} size="sm" showTeamLogo={false} showPosition={false} />
                                                  <span className="text-slate-400">{p.value?.toLocaleString()}</span>
                                                </div>
                                              ))}
                                            </div>
                                          </div>
                                          {team.players?.picks?.length > 0 && (
                                            <div>
                                              <div className="text-xs font-bold text-yellow-400 mb-1">Picks (Rank: {team.pickRank})</div>
                                              <div className="flex flex-wrap gap-1">
                                                {team.players?.picks?.map((pick: any, i: number) => (
                                                  <span key={i} className="px-1.5 py-0.5 rounded bg-yellow-600/30 text-yellow-300 text-[10px]">
                                                    {pick.name}
                                                  </span>
                                                ))}
                                              </div>
                                            </div>
                                          )}
                                        </div>
                                      )}
                                    </div>
                                  )
                                })}
                              </div>
                            </div>

                            {rankingsData.aiAnalysis && (
                              <div className="p-4 rounded-xl bg-cyan-500/10 border border-cyan-400/30">
                                <h4 className="text-sm font-semibold text-cyan-400 mb-2">AI Analysis</h4>
                                <p className="text-sm text-gray-300 whitespace-pre-wrap">{rankingsData.aiAnalysis}</p>
                                <div className="flex flex-wrap gap-3 mt-4 pt-4 border-t border-cyan-400/20">
                                  <span className="text-xs text-gray-400">Improve your standing:</span>
                                  <button
                                    onClick={() => handleActiveTabChange('trade')}
                                    className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-purple-500/20 border border-purple-400/30 text-purple-200 text-xs font-medium hover:bg-purple-500/30 transition"
                                  >
                                    <span>üîÑ</span> Trade Analyzer
                                  </button>
                                  <button
                                    onClick={() => handleActiveTabChange('waiver')}
                                    className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-emerald-500/20 border border-emerald-400/30 text-emerald-200 text-xs font-medium hover:bg-emerald-500/30 transition"
                                  >
                                    <span>üìà</span> Waiver AI
                                  </button>
                                </div>
                              </div>
                            )}

                            {/* Team Comparison Section */}
                            <div className="p-4 rounded-xl bg-black/40 border border-white/10">
                              <div className="flex flex-wrap items-center justify-between gap-3 mb-4">
                                <h4 className="text-base sm:text-lg font-bold text-white">Compare Teams</h4>
                              </div>
                              
                              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
                                <div className="relative">
                                  <select
                                    value={rankingsCompareTeam1}
                                    onChange={(e) => setRankingsCompareTeam1(e.target.value)}
                                    className="w-full px-4 py-3 rounded-xl bg-black/40 border border-white/20 text-white focus:border-cyan-400/50 focus:outline-none appearance-none cursor-pointer"
                                  >
                                    <option value="">Select Team One</option>
                                    {rankingsData.allTeams?.map((team: any) => (
                                      <option key={team.userId} value={team.userId}>
                                        {team.teamName}
                                      </option>
                                    ))}
                                  </select>
                                  <div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400">
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
                                  </div>
                                </div>
                                
                                <div className="relative">
                                  <select
                                    value={rankingsCompareTeam2}
                                    onChange={(e) => setRankingsCompareTeam2(e.target.value)}
                                    className="w-full px-4 py-3 rounded-xl bg-black/40 border border-white/20 text-white focus:border-cyan-400/50 focus:outline-none appearance-none cursor-pointer"
                                  >
                                    <option value="">Select Team Two</option>
                                    {rankingsData.allTeams?.map((team: any) => (
                                      <option key={team.userId} value={team.userId}>
                                        {team.teamName}
                                      </option>
                                    ))}
                                  </select>
                                  <div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400">
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
                                  </div>
                                </div>
                              </div>
                              
                              {!compareTeamsData ? (
                                <div className="p-6 sm:p-8 rounded-xl bg-slate-700/30 border border-slate-600/30 text-center">
                                  <h5 className="text-base sm:text-lg font-semibold text-white mb-2">Select two teams above to compare</h5>
                                  <p className="text-sm text-gray-400">Compare positional strength, roster depth, and overall rankings between any two teams in your league.</p>
                                </div>
                              ) : (
                                <div key={`compare-${compareTeamsData.team1.userId}-${compareTeamsData.team2.userId}`} className="space-y-4">
                                  {/* Team Headers */}
                                  <div className="grid grid-cols-3 gap-2 sm:gap-4">
                                    <div className={`p-3 sm:p-4 rounded-xl text-center ${compareTeamsData.team1.isUser ? 'bg-yellow-500/10 border border-yellow-400/30' : 'bg-cyan-500/10 border border-cyan-400/30'}`}>
                                      <div className="text-sm sm:text-base font-bold text-white truncate">{compareTeamsData.team1.teamName}</div>
                                      <div className="text-xs text-gray-400">#{compareTeamsData.team1.overallRank} overall</div>
                                    </div>
                                    <div className="flex items-center justify-center">
                                      <span className="text-2xl sm:text-3xl font-bold text-white">vs</span>
                                    </div>
                                    <div className={`p-3 sm:p-4 rounded-xl text-center ${compareTeamsData.team2.isUser ? 'bg-yellow-500/10 border border-yellow-400/30' : 'bg-purple-500/10 border border-purple-400/30'}`}>
                                      <div className="text-sm sm:text-base font-bold text-white truncate">{compareTeamsData.team2.teamName}</div>
                                      <div className="text-xs text-gray-400">#{compareTeamsData.team2.overallRank} overall</div>
                                    </div>
                                  </div>
                                  
                                  {/* Win Counter */}
                                  <div className="flex items-center justify-center gap-4 p-3 rounded-xl bg-black/30 border border-white/10">
                                    <span className={`text-xl sm:text-2xl font-bold ${compareTeamsData.team1Wins > compareTeamsData.team2Wins ? 'text-emerald-400' : compareTeamsData.team1Wins < compareTeamsData.team2Wins ? 'text-gray-400' : 'text-gray-300'}`}>{compareTeamsData.team1Wins}</span>
                                    <span className="text-sm text-gray-400">categories won</span>
                                    <span className={`text-xl sm:text-2xl font-bold ${compareTeamsData.team2Wins > compareTeamsData.team1Wins ? 'text-emerald-400' : compareTeamsData.team2Wins < compareTeamsData.team1Wins ? 'text-gray-400' : 'text-gray-300'}`}>{compareTeamsData.team2Wins}</span>
                                  </div>
                                  
                                  {/* Category Comparisons */}
                                  <div className="space-y-2">
                                    {compareTeamsData.categories.map((cat) => {
                                      const getCompareColor = (rank1: number, rank2: number) => {
                                        if (rank1 < rank2) return { left: 'text-emerald-400', right: 'text-rose-400' }
                                        if (rank1 > rank2) return { left: 'text-rose-400', right: 'text-emerald-400' }
                                        return { left: 'text-gray-300', right: 'text-gray-300' }
                                      }
                                      const colors = getCompareColor(cat.rank1, cat.rank2)
                                      return (
                                        <div key={cat.label} className="grid grid-cols-3 gap-2 items-center p-2.5 sm:p-3 rounded-xl bg-black/30 border border-white/5">
                                          <div className="text-right">
                                            <span className={`text-lg sm:text-xl font-bold ${colors.left}`}>#{cat.rank1}</span>
                                          </div>
                                          <div className="text-center">
                                            <span className="text-xs sm:text-sm font-medium text-gray-400">{cat.label}</span>
                                          </div>
                                          <div className="text-left">
                                            <span className={`text-lg sm:text-xl font-bold ${colors.right}`}>#{cat.rank2}</span>
                                          </div>
                                        </div>
                                      )
                                    })}
                                  </div>
                                </div>
                              )}
                            </div>

                            {/* Devy Draft Assistant Panel */}
                            <div className="mt-6 rounded-2xl bg-gradient-to-b from-indigo-950/50 to-slate-900/80 border border-indigo-500/30 overflow-hidden">
                              {/* Header */}
                              <div className="p-4 sm:p-5 border-b border-indigo-500/20 bg-gradient-to-r from-indigo-900/30 to-purple-900/30">
                                <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                                  <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500/40 to-purple-500/40 flex items-center justify-center text-xl">üéì</div>
                                    <div>
                                      <h4 className="text-lg font-bold text-white">Devy Draft Assistant <span className="text-xs font-medium text-indigo-400 ml-1.5">(AI)</span></h4>
                                      <p className="text-xs text-white/50">Recommendations update with roster changes, injuries, news, and league context.</p>
                                    </div>
                                  </div>
                                  <div className="flex flex-wrap gap-2">
                                    {devyBoardData && (
                                      <>
                                        <span className="px-2.5 py-1 rounded-lg bg-slate-700/60 text-[10px] font-medium text-slate-300">
                                          Updated: {new Date(devyBoardData.updatedAt).toLocaleTimeString()}
                                        </span>
                                        <span className={`px-2.5 py-1 rounded-lg text-[10px] font-medium ${
                                          devyBoardData.confidence === 'High' ? 'bg-emerald-500/20 text-emerald-300' :
                                          devyBoardData.confidence === 'Learning' ? 'bg-yellow-500/20 text-yellow-300' :
                                          'bg-blue-500/20 text-blue-300'
                                        }`}>
                                          Confidence: {devyBoardData.confidence}
                                        </span>
                                        {devyBoardData.dataSource && (
                                          <span className={`px-2.5 py-1 rounded-lg text-[10px] font-medium ${
                                            devyBoardData.dataSource === 'database' ? 'bg-cyan-500/20 text-cyan-300' :
                                            devyBoardData.dataSource === 'hybrid' ? 'bg-violet-500/20 text-violet-300' :
                                            'bg-slate-600/50 text-slate-300'
                                          }`}>
                                            {devyBoardData.dataSource === 'hybrid' ? 'CFBD + AI' : devyBoardData.dataSource === 'database' ? 'CFBD Data' : 'AI Only'}
                                          </span>
                                        )}
                                        {devyBoardData.totalClassifiedPlayers && (
                                          <span className="px-2.5 py-1 rounded-lg bg-slate-700/60 text-[10px] font-medium text-slate-300">
                                            {devyBoardData.totalClassifiedPlayers} Players Classified
                                          </span>
                                        )}
                                      </>
                                    )}
                                    <span className="px-2.5 py-1 rounded-lg bg-slate-700/60 text-[10px] font-medium text-slate-400">Read-only</span>
                                  </div>
                                </div>
                              </div>

                              {/* Content */}
                              <div className="p-4 sm:p-5">
                                {/* Loading State */}
                                {devyBoardLoading && (
                                  <div className="py-12 text-center">
                                    <div className="inline-flex items-center gap-3 px-6 py-3 rounded-xl bg-indigo-500/10 border border-indigo-400/20">
                                      <span className="animate-spin text-xl">‚öôÔ∏è</span>
                                      <span className="text-indigo-300 font-medium">Generating draft board...</span>
                                    </div>
                                    <p className="text-xs text-white/40 mt-3">Analyzing roster needs, market values, and league context</p>
                                  </div>
                                )}

                                {/* Error State */}
                                {devyBoardError && !devyBoardLoading && (
                                  <div className="p-4 rounded-xl bg-red-500/10 border border-red-400/30 text-center">
                                    <p className="text-red-300 text-sm">{devyBoardError}</p>
                                  </div>
                                )}

                                {/* Empty State */}
                                {!devyBoardLoading && !devyBoardError && !devyBoardData && (
                                  <div className="py-10 text-center">
                                    <div className="w-16 h-16 mx-auto mb-4 rounded-2xl bg-indigo-500/10 border border-indigo-400/20 flex items-center justify-center text-3xl">üéì</div>
                                    <h5 className="text-base font-semibold text-white mb-2">Generate Your Devy Draft Board</h5>
                                    <p className="text-sm text-white/50 max-w-md mx-auto">Click "Show My Rankings" above to analyze your league and generate personalized devy draft recommendations.</p>
                                  </div>
                                )}

                                {/* Devy Board Data */}
                                {devyBoardData && !devyBoardLoading && (
                                  <div className="space-y-5">
                                    {/* League Context Chips */}
                                    <div className="flex flex-wrap gap-2">
                                      <span className="px-3 py-1.5 rounded-lg bg-indigo-500/20 border border-indigo-400/30 text-xs font-medium text-indigo-200">
                                        {devyBoardData.leagueContext.format}
                                      </span>
                                      <span className="px-3 py-1.5 rounded-lg bg-slate-700/60 border border-slate-600/40 text-xs font-medium text-slate-200">
                                        {devyBoardData.leagueContext.teams} Teams
                                      </span>
                                      <span className="px-3 py-1.5 rounded-lg bg-slate-700/60 border border-slate-600/40 text-xs font-medium text-slate-200">
                                        {devyBoardData.leagueContext.scoring}
                                      </span>
                                      <span className="px-3 py-1.5 rounded-lg bg-amber-500/20 border border-amber-400/30 text-xs font-medium text-amber-200">
                                        Your Pick: {devyBoardData.leagueContext.yourPick}
                                      </span>
                                      <span className={`px-3 py-1.5 rounded-lg text-xs font-medium ${
                                        devyBoardData.leagueContext.teamDirection === 'Contender' 
                                          ? 'bg-emerald-500/20 border border-emerald-400/30 text-emerald-200' 
                                          : 'bg-purple-500/20 border border-purple-400/30 text-purple-200'
                                      }`}>
                                        {devyBoardData.leagueContext.teamDirection}
                                      </span>
                                      <span className="px-3 py-1.5 rounded-lg bg-rose-500/20 border border-rose-400/30 text-xs font-medium text-rose-200">
                                        Need: {devyBoardData.leagueContext.biggestNeed}
                                      </span>
                                    </div>

                                    {/* Top Targets */}
                                    <div>
                                      <h5 className="text-sm font-semibold text-white mb-3 flex items-center gap-2">
                                        <span className="text-lg">üéØ</span> Top Targets at Your Pick
                                        <span className="text-xs text-white/40 font-normal">(AllFantasy Draft Value / Market Estimate)</span>
                                      </h5>
                                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                        {devyBoardData.topTargets?.map((player: any, idx: number) => (
                                          <div key={idx} className="p-3 rounded-xl bg-slate-800/60 border border-slate-700/50 hover:border-indigo-500/40 transition">
                                            <div className="flex items-start justify-between gap-2 mb-2">
                                              <div>
                                                <div className="flex items-center gap-1.5 font-semibold text-white text-sm"><MiniPlayerImg sleeperId={player.id} name={player.name} size={18} />{player.name}</div>
                                                <div className="text-xs text-white/50">{player.position} ‚Ä¢ {player.school}</div>
                                              </div>
                                              <div className="flex flex-col items-end gap-1">
                                                <span className={`px-2 py-0.5 rounded text-[10px] font-bold ${
                                                  player.tier === 'Tier 1' ? 'bg-amber-500/30 text-amber-200' :
                                                  player.tier === 'Tier 2' ? 'bg-slate-600/50 text-slate-200' :
                                                  'bg-purple-500/30 text-purple-200'
                                                }`}>
                                                  {player.tier}
                                                </span>
                                                {player.badge && (
                                                  <span className={`px-1.5 py-0.5 rounded text-[9px] font-semibold ${
                                                    player.badge === 'NCAA' ? 'bg-blue-500/20 text-blue-300' :
                                                    player.badge === 'Graduated' ? 'bg-emerald-500/20 text-emerald-300' :
                                                    'bg-orange-500/20 text-orange-300'
                                                  }`}>
                                                    {player.badge}
                                                  </span>
                                                )}
                                              </div>
                                            </div>
                                            
                                            {/* Draft Value Meter */}
                                            <div className="mb-2">
                                              <div className="flex items-center justify-between text-[10px] mb-1">
                                                <span className="text-white/50">Draft Value</span>
                                                <span className="font-bold text-indigo-300">{player.draftValue}</span>
                                              </div>
                                              <div className="h-1.5 rounded-full bg-slate-700 overflow-hidden">
                                                <div 
                                                  className="h-full bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full"
                                                  style={{ width: `${player.draftValue}%` }}
                                                />
                                              </div>
                                            </div>

                                            {/* Availability */}
                                            <div className="flex items-center justify-between text-[10px] mb-2">
                                              <span className="text-white/50">Availability at pick</span>
                                              <span className={`font-medium ${player.availabilityPct >= 60 ? 'text-emerald-400' : player.availabilityPct >= 30 ? 'text-yellow-400' : 'text-rose-400'}`}>
                                                {player.availabilityPct}%
                                              </span>
                                            </div>

                                            {/* Why Bullets */}
                                            <div className="space-y-1 mb-2">
                                              {player.whyBullets?.slice(0, 2).map((bullet: string, bIdx: number) => (
                                                <div key={bIdx} className="flex items-start gap-1.5 text-[10px] text-white/60">
                                                  <span className="text-indigo-400 mt-0.5">‚Ä¢</span>
                                                  <span>{bullet}</span>
                                                </div>
                                              ))}
                                            </div>

                                            {/* Need Match Tag */}
                                            <div className="flex items-center gap-2">
                                              <span className={`px-2 py-0.5 rounded text-[10px] font-medium ${
                                                player.needMatch === 'Strong' ? 'bg-emerald-500/20 text-emerald-300' :
                                                player.needMatch === 'Medium' ? 'bg-yellow-500/20 text-yellow-300' :
                                                'bg-slate-600/50 text-slate-300'
                                              }`}>
                                                {player.needMatch} Need Match
                                              </span>
                                            </div>
                                          </div>
                                        ))}
                                      </div>
                                    </div>

                                    {/* If Sniped Fallbacks */}
                                    {devyBoardData.fallbacks?.length > 0 && (
                                      <div>
                                        <h5 className="text-sm font-semibold text-white/70 mb-3 flex items-center gap-2">
                                          <span className="text-base">üîÑ</span> If Sniped ‚Äî Fallback Options
                                        </h5>
                                        <div className="grid grid-cols-1 sm:grid-cols-3 gap-2">
                                          {devyBoardData.fallbacks?.map((player: any, idx: number) => (
                                            <div key={idx} className="p-2.5 rounded-lg bg-slate-800/40 border border-slate-700/30">
                                              <div className="flex items-center justify-between mb-1">
                                                <div className="flex items-center gap-1.5">
                                                  <MiniPlayerImg sleeperId={player.id} name={player.name} size={18} />
                                                  <span className="font-medium text-white/80 text-sm">{player.name}</span>
                                                  <span className="text-[10px] text-white/40 ml-1.5">{player.position}</span>
                                                </div>
                                                <span className="text-[10px] text-indigo-300 font-medium">{player.draftValue}</span>
                                              </div>
                                              <div className="text-[10px] text-white/50">{player.whyBullets?.[0]}</div>
                                            </div>
                                          ))}
                                        </div>
                                      </div>
                                    )}

                                    {/* Projected Picks Ahead */}
                                    {devyBoardData.projectedPicksAhead?.length > 0 && (
                                      <div>
                                        <h5 className="text-xs font-medium text-white/50 mb-2">Who Might Go Before You</h5>
                                        <div className="flex flex-wrap gap-2">
                                          {devyBoardData.projectedPicksAhead?.map((p: any, idx: number) => (
                                            <div key={idx} className="flex items-center gap-1.5 px-2.5 py-1 rounded-lg bg-slate-800/40 border border-slate-700/30">
                                              <MiniPlayerImg sleeperId={p.id} name={p.name} size={18} />
                                              <span className="text-xs text-white/70">{p.name}</span>
                                              <span className="text-[10px] text-rose-400 font-medium">{p.pct}%</span>
                                            </div>
                                          ))}
                                        </div>
                                        <p className="text-[10px] text-white/30 mt-1.5">Projected picks ahead (based on team needs + value). If insufficient data, projection is learning.</p>
                                      </div>
                                    )}

                                    {/* Why This Changed */}
                                    {devyBoardData.updateReasons?.length > 0 && (
                                      <div className="p-3 rounded-xl bg-indigo-500/5 border border-indigo-500/20">
                                        <h5 className="text-xs font-semibold text-indigo-300 mb-2">Why the board updated</h5>
                                        <div className="space-y-1">
                                          {devyBoardData.updateReasons?.map((reason: string, idx: number) => (
                                            <div key={idx} className="flex items-start gap-2 text-[11px] text-white/60">
                                              <span className="text-indigo-400">‚Üí</span>
                                              <span>{reason}</span>
                                            </div>
                                          ))}
                                        </div>
                                      </div>
                                    )}

                                    {/* Action Buttons */}
                                    <div className="flex flex-wrap items-center gap-3 pt-2">
                                      <button
                                        onClick={() => fetchDevyBoard(rankingsSelectedLeague, rankingsData)}
                                        disabled={devyBoardLoading}
                                        className="px-4 py-2 rounded-lg bg-indigo-500/20 border border-indigo-400/30 text-indigo-200 text-sm font-medium hover:bg-indigo-500/30 transition disabled:opacity-50"
                                      >
                                        üîÑ Refresh Board
                                      </button>
                                      <button
                                        disabled
                                        className="px-4 py-2 rounded-lg bg-slate-700/30 border border-slate-600/30 text-slate-400 text-sm font-medium cursor-not-allowed"
                                      >
                                        üíæ Save to Notes <span className="text-[10px] ml-1">(Coming soon)</span>
                                      </button>
                                    </div>

                                    {/* Disclaimer */}
                                    <p className="text-[10px] text-white/30 text-center pt-2">
                                      AI is learning ‚Äî not perfect yet. Always verify major decisions. Draft values are AllFantasy estimates, not licensed ADP.
                                    </p>
                                  </div>
                                )}
                              </div>
                            </div>

                            {/* Playoff Calculator */}
                            <div className="mt-6 rounded-2xl bg-gradient-to-b from-emerald-950/50 to-slate-900/80 border border-emerald-500/30 overflow-hidden">
                              <div className="p-4 sm:p-5 border-b border-emerald-500/20 bg-gradient-to-r from-emerald-900/30 to-teal-900/30">
                                <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                                  <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-emerald-500/40 to-teal-500/40 flex items-center justify-center text-xl">üìä</div>
                                    <div>
                                      <h4 className="text-lg font-bold text-white">Playoff Calculator</h4>
                                      <p className="text-xs text-white/50">See your playoff chances for the next 3 years</p>
                                    </div>
                                  </div>
                                  <div className="flex items-center gap-2">
                                    <select
                                      value={playoffForecastYear}
                                      onChange={(e) => {
                                        const year = parseInt(e.target.value)
                                        setPlayoffForecastYear(year)
                                        fetchPlayoffForecast(year)
                                      }}
                                      className="px-3 py-1.5 rounded-lg bg-slate-800/80 border border-slate-600/50 text-white text-sm"
                                    >
                                      {[0, 1, 2, 3].map(offset => (
                                        <option key={offset} value={new Date().getFullYear() + offset}>
                                          {new Date().getFullYear() + offset}
                                        </option>
                                      ))}
                                    </select>
                                    <div className="flex rounded-lg overflow-hidden border border-slate-600/50">
                                      <button
                                        onClick={() => {
                                          setPlayoffForecastType('traditional')
                                          fetchPlayoffForecast(playoffForecastYear, 'traditional')
                                        }}
                                        className={`px-3 py-1.5 text-xs font-medium transition ${playoffForecastType === 'traditional' ? 'bg-emerald-600 text-white' : 'bg-slate-800/80 text-slate-400'}`}
                                      >
                                        Traditional ADP Forecast
                                      </button>
                                      <button
                                        onClick={() => {
                                          setPlayoffForecastType('elo')
                                          fetchPlayoffForecast(playoffForecastYear, 'elo')
                                        }}
                                        className={`px-3 py-1.5 text-xs font-medium transition ${playoffForecastType === 'elo' ? 'bg-emerald-600 text-white' : 'bg-slate-800/80 text-slate-400'}`}
                                      >
                                        Elo Adjusted ADP Forecast
                                      </button>
                                    </div>
                                  </div>
                                </div>
                              </div>
                              
                              <div className="p-4 sm:p-5">
                                {playoffForecastLoading && (
                                  <div className="py-8 text-center">
                                    <span className="animate-spin text-2xl">‚öôÔ∏è</span>
                                    <p className="text-white/50 text-sm mt-2">Calculating playoff probabilities...</p>
                                  </div>
                                )}
                                
                                {!playoffForecastLoading && playoffForecastData && (
                                  <div className="space-y-4">
                                    {/* AI Recommendations */}
                                    {playoffForecastData.aiRecommendations?.length > 0 && (
                                      <div className="p-3 rounded-xl bg-emerald-500/10 border border-emerald-500/20 mb-4">
                                        <h5 className="text-xs font-semibold text-emerald-300 mb-2">AI Recommendations to Improve Your Chances</h5>
                                        <div className="space-y-1.5">
                                          {playoffForecastData.aiRecommendations.map((rec: string, i: number) => (
                                            <div key={i} className="flex items-start gap-2 text-xs text-white/70">
                                              <span className="text-emerald-400">‚Üí</span>
                                              <span>{rec}</span>
                                            </div>
                                          ))}
                                        </div>
                                      </div>
                                    )}
                                    
                                    {/* Forecast Table */}
                                    <div className="overflow-x-auto">
                                      <table className="w-full text-sm">
                                        <thead>
                                          <tr className="border-b border-slate-700/50">
                                            <th className="px-2 py-3 text-left text-xs font-medium text-slate-400 w-16">Team Rating</th>
                                            <th className="px-3 py-3 text-left text-xs font-medium text-slate-400">Team</th>
                                            <th className="px-2 py-3 text-center text-xs font-medium text-slate-400 w-20">Current Record</th>
                                            <th className="px-2 py-3 text-center text-xs font-medium bg-blue-600/30 text-blue-200 w-24">Make Playoffs</th>
                                            <th className="px-2 py-3 text-center text-xs font-medium bg-blue-700/30 text-blue-200 w-24">Make Semi-Finals</th>
                                            <th className="px-2 py-3 text-center text-xs font-medium bg-blue-800/30 text-blue-200 w-24">Make Finals</th>
                                            <th className="px-2 py-3 text-center text-xs font-medium bg-blue-900/40 text-blue-200 w-20">Win Finals</th>
                                          </tr>
                                        </thead>
                                        <tbody>
                                          {playoffForecastData.forecasts?.map((team: any) => (
                                            <tr key={team.userId} className={`border-b border-slate-800/50 ${team.isUser ? 'bg-yellow-500/10' : 'hover:bg-slate-800/30'}`}>
                                              <td className="px-2 py-3 text-left font-bold text-white">{team.teamRating}</td>
                                              <td className="px-3 py-3">
                                                <div className={`font-medium ${team.isUser ? 'text-yellow-300' : 'text-white'}`}>
                                                  {team.teamName}
                                                  {team.sleeperUsername && team.sleeperUsername !== team.teamName && (
                                                    <span className="text-slate-400 font-normal text-xs ml-1.5">@{team.sleeperUsername}</span>
                                                  )}
                                                </div>
                                              </td>
                                              <td className="px-2 py-3 text-center text-white">{team.currentRecord}</td>
                                              <td className="px-2 py-3 text-center">
                                                {team.probabilities.makePlayoffs >= 50 ? (
                                                  <span className="inline-flex items-center justify-center w-8 h-8 rounded-md bg-blue-500/30 text-blue-200">‚úì</span>
                                                ) : (
                                                  <span className="text-slate-500">-</span>
                                                )}
                                              </td>
                                              <td className="px-2 py-3 text-center">
                                                {team.probabilities.makeSemiFinals >= 30 ? (
                                                  <span className="inline-flex items-center justify-center w-8 h-8 rounded-md bg-blue-500/30 text-blue-200">‚úì</span>
                                                ) : (
                                                  <span className="text-slate-500">-</span>
                                                )}
                                              </td>
                                              <td className="px-2 py-3 text-center">
                                                {team.probabilities.makeFinals >= 20 ? (
                                                  <span className="inline-flex items-center justify-center w-8 h-8 rounded-md bg-blue-500/30 text-blue-200">‚úì</span>
                                                ) : (
                                                  <span className="text-slate-500">-</span>
                                                )}
                                              </td>
                                              <td className="px-2 py-3 text-center">
                                                {team.probabilities.winFinals >= 10 ? (
                                                  <span className="inline-flex items-center justify-center w-8 h-8 rounded-md bg-blue-500/30 text-blue-200">‚úì</span>
                                                ) : (
                                                  <span className="text-slate-500">-</span>
                                                )}
                                              </td>
                                            </tr>
                                          ))}
                                        </tbody>
                                      </table>
                                    </div>
                                  </div>
                                )}
                                
                                {!playoffForecastLoading && !playoffForecastData && (
                                  <div className="py-8 text-center text-white/50 text-sm">
                                    Playoff forecast will appear after loading rankings
                                  </div>
                                )}
                              </div>
                            </div>

                            {/* Historical Ratings Chart */}
                            <div className="mt-6 rounded-2xl bg-gradient-to-b from-purple-950/50 to-slate-900/80 border border-purple-500/30 overflow-hidden">
                              <div className="p-4 sm:p-5 border-b border-purple-500/20 bg-gradient-to-r from-purple-900/30 to-indigo-900/30">
                                <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                                  <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500/40 to-indigo-500/40 flex items-center justify-center text-xl">üìà</div>
                                    <div>
                                      <h4 className="text-lg font-bold text-white">Historical Elo Adjusted ADP Rankings</h4>
                                      <p className="text-xs text-white/50">Week 1</p>
                                    </div>
                                  </div>
                                  <select
                                    value={historicalRatingsSeason}
                                    onChange={(e) => {
                                      const season = parseInt(e.target.value)
                                      setHistoricalRatingsSeason(season)
                                      fetchHistoricalRatings(season)
                                    }}
                                    className="px-3 py-1.5 rounded-lg bg-slate-800/80 border border-slate-600/50 text-white text-sm"
                                  >
                                    {(() => {
                                      const currentYear = new Date().getFullYear()
                                      const apiSeasons = historicalRatingsData?.availableSeasons || []
                                      const allSeasons = [...new Set([...apiSeasons, currentYear - 1, currentYear])].sort((a, b) => a - b)
                                      return allSeasons.map((s: number) => (
                                        <option key={s} value={s}>{s}</option>
                                      ))
                                    })()}
                                  </select>
                                </div>
                              </div>
                              
                              <div className="p-4 sm:p-5">
                                {historicalRatingsLoading && (
                                  <div className="py-8 text-center">
                                    <span className="animate-spin text-2xl">‚öôÔ∏è</span>
                                    <p className="text-white/50 text-sm mt-2">Loading historical ratings...</p>
                                  </div>
                                )}
                                
                                {!historicalRatingsLoading && historicalRatingsData && (
                                  <div className="space-y-4">
                                    {/* Team Legend */}
                                    <div className="flex flex-wrap gap-2 mb-4">
                                      {historicalRatingsData.teamHistories?.map((team: any) => (
                                        <div key={team.userId} className="flex items-center gap-1.5 px-2 py-1 rounded-lg" style={{ backgroundColor: `${team.color}20` }}>
                                          <span className="w-2.5 h-2.5 rounded" style={{ backgroundColor: team.color }}></span>
                                          <span className="text-xs text-white font-medium">{team.teamName} : {team.currentRating}</span>
                                        </div>
                                      ))}
                                    </div>
                                    
                                    {/* Chart Area */}
                                    <div className="relative h-64 sm:h-80 bg-slate-900/50 rounded-xl border border-slate-700/30 p-4">
                                      <svg viewBox="0 0 800 300" className="w-full h-full" preserveAspectRatio="none">
                                        {/* Grid lines */}
                                        {[0, 1, 2, 3, 4].map(i => (
                                          <line key={i} x1="50" y1={50 + i * 50} x2="780" y2={50 + i * 50} stroke="#334155" strokeWidth="1" strokeDasharray="4" />
                                        ))}
                                        
                                        {/* X-axis labels */}
                                        {[1, 4, 7, 10, 13, 16].map((week, i) => (
                                          <text key={i} x={50 + i * 146} y="290" fill="#64748b" fontSize="10" textAnchor="middle">Week {week}</text>
                                        ))}
                                        
                                        {/* Lines for each team */}
                                        {historicalRatingsData.teamHistories?.map((team: any) => {
                                          const maxRating = Math.max(...historicalRatingsData.teamHistories.flatMap((t: any) => t.weeklyRatings.map((w: any) => w.rating)))
                                          const minRating = Math.min(...historicalRatingsData.teamHistories.flatMap((t: any) => t.weeklyRatings.map((w: any) => w.rating)))
                                          const range = maxRating - minRating || 1
                                          
                                          const points = team.weeklyRatings.map((w: any, i: number) => {
                                            const x = 50 + (w.week / (historicalRatingsData.leagueInfo?.maxWeek || 18)) * 730
                                            const y = 250 - ((w.rating - minRating) / range) * 200
                                            return `${x},${y}`
                                          }).join(' ')
                                          
                                          return (
                                            <g key={team.userId}>
                                              <polyline
                                                points={points}
                                                fill="none"
                                                stroke={team.color}
                                                strokeWidth="2"
                                                strokeLinecap="round"
                                                strokeLinejoin="round"
                                              />
                                              {team.weeklyRatings.length > 0 && (
                                                <circle
                                                  cx={50 + (team.weeklyRatings[team.weeklyRatings.length - 1].week / (historicalRatingsData.leagueInfo?.maxWeek || 18)) * 730}
                                                  cy={250 - ((team.weeklyRatings[team.weeklyRatings.length - 1].rating - minRating) / range) * 200}
                                                  r="4"
                                                  fill={team.color}
                                                />
                                              )}
                                            </g>
                                          )
                                        })}
                                      </svg>
                                    </div>
                                  </div>
                                )}
                                
                                {!historicalRatingsLoading && !historicalRatingsData && (
                                  <div className="py-8 text-center text-white/50 text-sm">
                                    Historical ratings will appear after loading rankings
                                  </div>
                                )}
                              </div>
                            </div>

                            {/* League Format Tool */}
                            <div className="mt-6 rounded-2xl bg-gradient-to-b from-cyan-950/50 to-slate-900/80 border border-cyan-500/30 overflow-hidden">
                              <div className="p-4 sm:p-5 border-b border-cyan-500/20 bg-gradient-to-r from-cyan-900/30 to-blue-900/30">
                                <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                                  <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-500/40 to-blue-500/40 flex items-center justify-center text-xl">‚öôÔ∏è</div>
                                    <div>
                                      <h4 className="text-lg font-bold text-white">League Format Tool</h4>
                                      <p className="text-xs text-white/50">Identify positional advantages for your league settings</p>
                                    </div>
                                  </div>
                                  <div className="flex items-center gap-2">
                                    <span className="text-xs text-white/50">Selected Preset</span>
                                    <select
                                      value={leagueFormatPreset}
                                      onChange={(e) => setLeagueFormatPreset(e.target.value)}
                                      className="px-3 py-1.5 rounded-lg bg-slate-800/80 border border-slate-600/50 text-cyan-300 text-sm font-medium"
                                    >
                                      {leagueFormatData?.presets?.map((preset: string) => (
                                        <option key={preset} value={preset}>{preset}</option>
                                      )) || (
                                        <option value="WAR View">WAR View</option>
                                      )}
                                    </select>
                                    <button className="p-1.5 rounded-lg bg-slate-800/80 border border-slate-600/50 text-white/60 hover:text-white transition">
                                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" /></svg>
                                    </button>
                                  </div>
                                </div>
                                <div className="mt-3 text-center">
                                  <button className="text-xs text-cyan-400 hover:text-cyan-300 transition flex items-center gap-1 mx-auto">
                                    <Info className="w-3.5 h-3.5" />
                                    How to use League Format?
                                  </button>
                                </div>
                              </div>
                              
                              <div className="p-4 sm:p-5">
                                {leagueFormatLoading && (
                                  <div className="py-8 text-center">
                                    <span className="animate-spin text-2xl">‚öôÔ∏è</span>
                                    <p className="text-white/50 text-sm mt-2">Analyzing league format...</p>
                                  </div>
                                )}
                                
                                {!leagueFormatLoading && leagueFormatData && (
                                  <div className="space-y-6">
                                    {/* Format Tags */}
                                    <div className="flex flex-wrap gap-2">
                                      <span className="px-3 py-1.5 rounded-lg bg-slate-700/60 border border-slate-600/40 text-xs font-medium text-slate-200">
                                        {leagueFormatData.leagueSettings?.format}
                                      </span>
                                      {leagueFormatData.leagueSettings?.isSF && (
                                        <span className="px-3 py-1.5 rounded-lg bg-cyan-500/20 border border-cyan-400/30 text-xs font-medium text-cyan-200">
                                          Superflex
                                        </span>
                                      )}
                                      {leagueFormatData.leagueSettings?.hasTEP && (
                                        <span className="px-3 py-1.5 rounded-lg bg-orange-500/20 border border-orange-400/30 text-xs font-medium text-orange-200">
                                          TE Premium
                                        </span>
                                      )}
                                    </div>
                                    
                                    {/* Charts Grid - changes based on preset */}
                                    <div className={`grid gap-4 ${leagueFormatPreset === 'Trade Value' ? 'grid-cols-1' : 'grid-cols-1 lg:grid-cols-2'}`}>
                                      {/* WAR Curve Chart - shows for WAR View and ADP Comparison */}
                                      {(leagueFormatPreset === 'WAR View' || leagueFormatPreset === 'ADP Comparison') && (
                                      <div className="p-4 rounded-xl bg-slate-900/50 border border-slate-700/30">
                                        <h5 className="text-sm font-semibold text-white mb-3 text-center">Wins Over Replacement (WAR)</h5>
                                        <div className="flex items-center justify-center gap-4 mb-3 flex-wrap">
                                          {leagueFormatData.warCurves?.map((curve: any) => (
                                            <span key={curve.position} className="flex items-center gap-1 text-xs">
                                              <span className="w-3 h-3 rounded" style={{ backgroundColor: curve.color }}></span>
                                              {curve.position}
                                            </span>
                                          ))}
                                        </div>
                                        <div className="relative h-48 sm:h-56">
                                          <svg viewBox="0 0 400 200" className="w-full h-full" preserveAspectRatio="none">
                                            {/* Y-axis labels */}
                                            <text x="20" y="25" fill="#64748b" fontSize="9">3.0</text>
                                            <text x="20" y="65" fill="#64748b" fontSize="9">2.0</text>
                                            <text x="20" y="105" fill="#64748b" fontSize="9">1.0</text>
                                            <text x="20" y="145" fill="#64748b" fontSize="9">0</text>
                                            <text x="16" y="185" fill="#64748b" fontSize="9">-0.5</text>
                                            
                                            {/* Y-axis label */}
                                            <text x="10" y="100" fill="#64748b" fontSize="9" transform="rotate(-90, 10, 100)">WAR</text>
                                            
                                            {/* X-axis label */}
                                            <text x="200" y="198" fill="#64748b" fontSize="9" textAnchor="middle">Position Rank</text>
                                            
                                            {/* Grid */}
                                            {[0, 1, 2, 3, 4].map(i => (
                                              <line key={i} x1="40" y1={20 + i * 40} x2="390" y2={20 + i * 40} stroke="#334155" strokeWidth="0.5" strokeDasharray="2" />
                                            ))}
                                            
                                            {/* WAR Curves */}
                                            {leagueFormatData.warCurves?.map((curve: any) => {
                                              const points = curve.data.slice(0, 30).map((d: any, i: number) => {
                                                const x = 40 + (i / 29) * 350
                                                const y = 140 - (d.war / 3.5) * 120
                                                return `${x},${Math.max(20, Math.min(180, y))}`
                                              }).join(' ')
                                              
                                              return (
                                                <polyline
                                                  key={curve.position}
                                                  points={points}
                                                  fill="none"
                                                  stroke={curve.color}
                                                  strokeWidth="2"
                                                  strokeLinecap="round"
                                                />
                                              )
                                            })}
                                          </svg>
                                        </div>
                                      </div>
                                      )}
                                      
                                      {/* Trade Value x WAR Scatter Plot - shows for WAR View and Trade Value */}
                                      {(leagueFormatPreset === 'WAR View' || leagueFormatPreset === 'Trade Value') && (
                                      <div className="p-4 rounded-xl bg-slate-900/50 border border-slate-700/30">
                                        <h5 className="text-sm font-semibold text-white mb-3 text-center">Trade Value x WAR</h5>
                                        <div className="flex items-center justify-center gap-4 mb-3 flex-wrap">
                                          {leagueFormatData.warCurves?.map((curve: any) => (
                                            <span key={curve.position} className="flex items-center gap-1 text-xs">
                                              <span className="w-3 h-3 rounded" style={{ backgroundColor: curve.color }}></span>
                                              {curve.position}
                                            </span>
                                          ))}
                                        </div>
                                        <div className="relative h-48 sm:h-56">
                                          <svg viewBox="0 0 400 200" className="w-full h-full" preserveAspectRatio="none">
                                            {/* Y-axis labels */}
                                            <text x="20" y="25" fill="#64748b" fontSize="9">3.0</text>
                                            <text x="20" y="65" fill="#64748b" fontSize="9">2.0</text>
                                            <text x="20" y="105" fill="#64748b" fontSize="9">1.0</text>
                                            <text x="20" y="145" fill="#64748b" fontSize="9">0</text>
                                            <text x="16" y="185" fill="#64748b" fontSize="9">-1.0</text>
                                            
                                            {/* Y-axis label */}
                                            <text x="10" y="100" fill="#64748b" fontSize="9" transform="rotate(-90, 10, 100)">WAR</text>
                                            
                                            {/* X-axis labels */}
                                            <text x="60" y="198" fill="#64748b" fontSize="8">2,000</text>
                                            <text x="140" y="198" fill="#64748b" fontSize="8">4,000</text>
                                            <text x="220" y="198" fill="#64748b" fontSize="8">6,000</text>
                                            <text x="300" y="198" fill="#64748b" fontSize="8">8,000</text>
                                            <text x="370" y="198" fill="#64748b" fontSize="8">10,000</text>
                                            
                                            {/* X-axis label */}
                                            <text x="200" y="198" fill="#64748b" fontSize="9" textAnchor="middle" dy="8">Fantasy Market</text>
                                            
                                            {/* Grid */}
                                            {[0, 1, 2, 3, 4].map(i => (
                                              <line key={i} x1="40" y1={20 + i * 40} x2="390" y2={20 + i * 40} stroke="#334155" strokeWidth="0.5" strokeDasharray="2" />
                                            ))}
                                            
                                            {/* Scatter Points */}
                                            {leagueFormatData.scatterData?.slice(0, 80).map((point: any, i: number) => (
                                              <circle
                                                key={i}
                                                cx={40 + (point.marketValue / 10000) * 350}
                                                cy={Math.max(20, Math.min(180, 140 - (point.war / 3.5) * 120))}
                                                r="3"
                                                fill={point.color}
                                                opacity="0.7"
                                              />
                                            ))}
                                            
                                            {/* Trend lines */}
                                            {leagueFormatData.warCurves?.map((curve: any, idx: number) => {
                                              const positions = leagueFormatData.scatterData?.filter((p: any) => p.position === curve.position).slice(0, 20)
                                              if (!positions?.length) return null
                                              
                                              const avgX = positions.reduce((sum: number, p: any) => sum + p.marketValue, 0) / positions.length
                                              const avgY = positions.reduce((sum: number, p: any) => sum + p.war, 0) / positions.length
                                              
                                              return (
                                                <line
                                                  key={curve.position}
                                                  x1="60"
                                                  y1={140 - (avgY * 0.5 / 3.5) * 120}
                                                  x2="370"
                                                  y2={140 - (avgY * 1.5 / 3.5) * 120}
                                                  stroke={curve.color}
                                                  strokeWidth="1.5"
                                                  strokeDasharray="4"
                                                  opacity="0.6"
                                                />
                                              )
                                            })}
                                          </svg>
                                        </div>
                                      </div>
                                      )}
                                    </div>
                                    
                                    {/* Insights */}
                                    {leagueFormatData.insights?.length > 0 && (
                                      <div className="p-3 rounded-xl bg-cyan-500/10 border border-cyan-500/20">
                                        <h5 className="text-xs font-semibold text-cyan-300 mb-2">Format Insights</h5>
                                        <div className="space-y-1.5">
                                          {leagueFormatData.insights.slice(0, 3).map((insight: string, i: number) => (
                                            <div key={i} className="flex items-start gap-2 text-xs text-white/70">
                                              <span className="text-cyan-400">‚Ä¢</span>
                                              <span>{insight}</span>
                                            </div>
                                          ))}
                                        </div>
                                      </div>
                                    )}
                                  </div>
                                )}
                                
                                {!leagueFormatLoading && !leagueFormatData && (
                                  <div className="py-8 text-center text-white/50 text-sm">
                                    League format analysis will appear after loading rankings
                                  </div>
                                )}
                              </div>
                            </div>
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                  </>
                )}

                {activeTab === 'pulse' && (
                  <>
                  {/* Hero Metric */}
                  <HeroMetric 
                    value={pulseData?.sentiment || '‚Äî'}
                    label="Sentiment"
                    helper="Public narrative direction (read-only)"
                    accent="pink"
                  />
                  {/* Tab Headline */}
                  <p className="text-center text-sm sm:text-base text-white/60 mb-4">Understand player narratives before the market shifts.</p>
                  <div className="bg-black/30 border border-cyan-500/20 rounded-2xl p-4 sm:p-6">
                    <div className="flex items-start sm:items-center gap-3 mb-4">
                      <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500/30 to-pink-500/30 flex items-center justify-center text-xl flex-shrink-0">üì°</div>
                      <div>
                        <h3 className="text-lg sm:text-xl font-bold text-cyan-400">Social Pulse</h3>
                        <p className="text-xs sm:text-sm text-gray-400">Live X and web search for real-time player/team news and sentiment</p>
                      </div>
                    </div>

                    <div className="space-y-4">
                      <div>
                        <label className="block text-sm text-white/70 mb-2">Players, Teams, or Coaches (comma-separated)</label>
                        <input
                          type="text"
                          value={pulsePlayerInput}
                          onChange={(e) => setPulsePlayerInput(e.target.value)}
                          onKeyDown={(e) => e.key === 'Enter' && runSocialPulse()}
                          placeholder="e.g. Josh Allen, Keon Coleman, Buffalo Bills"
                          className="w-full px-4 py-3 rounded-xl bg-black/50 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:border-purple-500/50"
                        />
                      </div>

                      <div className="flex flex-wrap items-center gap-2 sm:gap-4">
                        <span className="text-sm text-white/60">Format:</span>
                        <div className="flex items-center gap-2">
                          <button
                            onClick={() => setPulseFormat('dynasty')}
                            className={`px-4 py-2 sm:px-3 sm:py-1.5 rounded-lg text-sm transition min-h-[40px] sm:min-h-0 ${
                              pulseFormat === 'dynasty'
                                ? 'bg-purple-500/30 text-purple-200 border border-purple-400/40'
                                : 'bg-black/30 text-white/60 border border-white/10 hover:bg-white/5'
                            }`}
                          >
                            Dynasty
                          </button>
                          <button
                            onClick={() => setPulseFormat('redraft')}
                            className={`px-4 py-2 sm:px-3 sm:py-1.5 rounded-lg text-sm transition min-h-[40px] sm:min-h-0 ${
                              pulseFormat === 'redraft'
                                ? 'bg-purple-500/30 text-purple-200 border border-purple-400/40'
                                : 'bg-black/30 text-white/60 border border-white/10 hover:bg-white/5'
                            }`}
                          >
                            Redraft
                          </button>
                        </div>
                      </div>

                      <button
                        onClick={runSocialPulse}
                        disabled={pulseLoading || !pulsePlayerInput.trim()}
                        className="w-full sm:w-auto px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold rounded-xl hover:from-purple-400 hover:to-pink-400 transition disabled:opacity-50 min-h-[48px]"
                      >
                        {pulseLoading ? 'Analyzing Sentiment...' : 'üì° Get Social Pulse'}
                      </button>

                      {pulseLoading && (
                        <div className="space-y-2">
                          <div className="h-2 bg-white/10 rounded-full overflow-hidden">
                            <div className="h-full bg-gradient-to-r from-purple-500 via-pink-500 to-purple-500 rounded-full animate-pulse" style={{ width: '100%' }} />
                          </div>
                          <p className="text-center text-sm text-gray-400">Searching X and the web for real-time news...</p>
                          <p className="text-center text-xs text-gray-500">This may take 15-30 seconds for live search</p>
                        </div>
                      )}

                      {pulseError && (
                        <div className="p-4 rounded-xl bg-red-500/10 border border-red-400/30 text-red-300">
                          {pulseError}
                        </div>
                      )}

                      {pulseData && (
                        <div className="space-y-4 mt-4">
                          <div className="p-4 rounded-xl bg-purple-500/10 border border-purple-400/30">
                            <div className="flex items-center justify-between mb-2">
                              <div className="text-sm font-semibold text-purple-300">Summary</div>
                              {pulseData.lastUpdated && (
                                <div className="text-xs text-purple-400/70">Latest news: {pulseData.lastUpdated}</div>
                              )}
                            </div>
                            <p className="text-sm text-gray-300">{pulseData.summary}</p>
                          </div>

                          {pulseData.bullets?.length > 0 && (
                            <div className="p-4 rounded-xl bg-black/40 border border-white/10">
                              <div className="text-sm font-semibold text-cyan-400 mb-3">Latest News & Narratives</div>
                              <ul className="space-y-2">
                                {pulseData.bullets.map((bullet: string, idx: number) => (
                                  <li key={idx} className="flex gap-2 text-sm text-gray-300">
                                    <span className="text-purple-400">‚Ä¢</span>
                                    <span>{bullet}</span>
                                  </li>
                                ))}
                              </ul>
                            </div>
                          )}

                          {pulseData.connections?.length > 0 && (
                            <div className="p-4 rounded-xl bg-blue-500/10 border border-blue-400/30">
                              <div className="text-sm font-semibold text-blue-300 mb-3">Connections Found</div>
                              <ul className="space-y-2">
                                {pulseData.connections.map((conn: string, idx: number) => (
                                  <li key={idx} className="flex gap-2 text-sm text-gray-300">
                                    <span className="text-blue-400">üîó</span>
                                    <span>{conn}</span>
                                  </li>
                                ))}
                              </ul>
                            </div>
                          )}

                          {pulseData.market?.length > 0 && (
                            <div className="p-4 rounded-xl bg-black/40 border border-white/10">
                              <div className="text-sm font-semibold text-cyan-400 mb-3">Market Signals</div>
                              <div className="space-y-2">
                                {pulseData.market.map((m: any, idx: number) => (
                                  <div
                                    key={idx}
                                    className={`px-3 py-2 rounded-lg text-sm border ${
                                      m.signal === 'up' ? 'bg-green-500/20 border-green-400/30' :
                                      m.signal === 'down' ? 'bg-red-500/20 border-red-400/30' :
                                      m.signal === 'buy_low' ? 'bg-emerald-500/20 border-emerald-400/30' :
                                      m.signal === 'sell_high' ? 'bg-orange-500/20 border-orange-400/30' :
                                      m.signal === 'injury' ? 'bg-yellow-500/20 border-yellow-400/30' :
                                      m.signal === 'hype' ? 'bg-pink-500/20 border-pink-400/30' :
                                      m.signal === 'released' ? 'bg-red-600/20 border-red-500/30' :
                                      m.signal === 'traded' ? 'bg-purple-500/20 border-purple-400/30' :
                                      'bg-white/5 border-white/10'
                                    }`}
                                  >
                                    <div className="flex items-center gap-2">
                                      <span className={`font-medium ${
                                        m.signal === 'up' ? 'text-green-300' :
                                        m.signal === 'down' ? 'text-red-300' :
                                        m.signal === 'buy_low' ? 'text-emerald-300' :
                                        m.signal === 'sell_high' ? 'text-orange-300' :
                                        m.signal === 'injury' ? 'text-yellow-300' :
                                        m.signal === 'hype' ? 'text-pink-300' :
                                        m.signal === 'released' ? 'text-red-300' :
                                        m.signal === 'traded' ? 'text-purple-300' :
                                        'text-white/70'
                                      }`}>{m.player}</span>
                                      <span className={`px-2 py-0.5 rounded text-xs uppercase ${
                                        m.signal === 'up' ? 'bg-green-500/30 text-green-200' :
                                        m.signal === 'down' ? 'bg-red-500/30 text-red-200' :
                                        m.signal === 'buy_low' ? 'bg-emerald-500/30 text-emerald-200' :
                                        m.signal === 'sell_high' ? 'bg-orange-500/30 text-orange-200' :
                                        m.signal === 'injury' ? 'bg-yellow-500/30 text-yellow-200' :
                                        m.signal === 'hype' ? 'bg-pink-500/30 text-pink-200' :
                                        m.signal === 'released' ? 'bg-red-600/30 text-red-200' :
                                        m.signal === 'traded' ? 'bg-purple-500/30 text-purple-200' :
                                        'bg-white/10 text-white/60'
                                      }`}>{m.signal}</span>
                                    </div>
                                    {m.reason && (
                                      <p className="text-xs text-gray-400 mt-1">{m.reason}</p>
                                    )}
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}
                        </div>
                      )}

                      {!pulseLoading && !pulseData && !pulseError && (
                        <div className="p-4 rounded-xl bg-black/30 border border-white/10 text-center">
                          <p className="text-sm text-gray-400">Enter player names, teams, or coaches to get the latest real-time news from X and the web.</p>
                          <p className="text-xs text-gray-500 mt-1">Search for multiple names to find connections between them.</p>
                        </div>
                      )}
                    </div>
                  </div>
                  </>
                )}

                {activeTab === 'compare' && (
                  <>
                  {/* Hero Metric */}
                  <HeroMetric 
                    value={compareResult?.comparison?.winner || '‚Äî'}
                    label="Winner"
                    helper="One decision, backed by context"
                    accent="amber"
                  />
                  {/* Tab Headline */}
                  <p className="text-center text-sm sm:text-base text-white/60 mb-4">One question. One answer. Who should you choose?</p>
                  <div className="bg-black/30 border border-cyan-500/20 rounded-2xl p-4 sm:p-6">
                    <div className="flex items-start sm:items-center gap-3 mb-4">
                      <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-red-500/30 to-orange-500/30 flex items-center justify-center text-xl flex-shrink-0">‚öîÔ∏è</div>
                      <div>
                        <h3 className="text-lg sm:text-xl font-bold text-cyan-400">Manager Comparison</h3>
                        <p className="text-xs sm:text-sm text-gray-400">Compare any two Sleeper managers instantly</p>
                      </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                      <div className="rounded-xl bg-cyan-500/10 border border-cyan-400/30 p-4">
                        <div className="text-xs uppercase tracking-wider text-cyan-300/70 mb-2">You</div>
                        <div className="text-lg font-bold text-white">{profile?.display_name || username}</div>
                      </div>
                      <div className="rounded-xl bg-purple-500/10 border border-purple-400/30 p-4">
                        <div className="text-xs uppercase tracking-wider text-purple-300/70 mb-2">Opponent</div>
                        <input
                          type="text"
                          value={compareOpponent}
                          onChange={(e) => setCompareOpponent(e.target.value)}
                          placeholder="Enter Sleeper username..."
                          className="w-full px-3 py-2 rounded-lg bg-black/50 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:border-purple-400/50"
                        />
                      </div>
                    </div>

                    <button
                      onClick={runManagerComparison}
                      disabled={compareLoading || !compareOpponent.trim()}
                      className="w-full px-6 py-3 bg-gradient-to-r from-red-500 to-orange-500 text-white font-semibold rounded-xl hover:from-red-400 hover:to-orange-400 transition disabled:opacity-50"
                    >
                      {compareLoading ? 'Comparing Managers...' : '‚öîÔ∏è Compare Managers'}
                    </button>

                    {compareLoading && (
                      <div className="mt-4 space-y-2">
                        <div className="h-2 bg-white/10 rounded-full overflow-hidden">
                          <div className="h-full bg-gradient-to-r from-red-500 via-orange-500 to-red-500 rounded-full animate-pulse" style={{ width: '100%', animation: 'progress-bar 2s ease-in-out infinite' }} />
                        </div>
                        <p className="text-sm text-white/60 text-center">Analyzing career stats, head-to-head records, and fantasy history...</p>
                        <style jsx>{`
                          @keyframes progress-bar {
                            0% { transform: translateX(-100%); }
                            50% { transform: translateX(0%); }
                            100% { transform: translateX(100%); }
                          }
                        `}</style>
                      </div>
                    )}

                    {compareError && (
                      <p className="text-red-400 text-sm mt-3">{compareError}</p>
                    )}

                    {compareResult && compareResult.comparison && (
                      <div className="mt-6 space-y-4">
                        {/* Fair Comparison Notice */}
                        {compareResult.comparison.comparable_formats && (
                          <div className="rounded-xl p-3 bg-blue-500/10 border border-blue-400/30">
                            <div className="flex items-center gap-2 mb-2">
                              <span className="text-blue-400">‚öñÔ∏è</span>
                              <span className="text-sm font-semibold text-blue-300">Fair Comparison Analysis</span>
                            </div>
                            <div className="flex flex-wrap gap-2">
                              {compareResult.comparison.comparable_formats.length > 0 ? (
                                compareResult.comparison.comparable_formats.map((format: string) => (
                                  <span key={format} className="px-2 py-1 rounded-lg bg-green-500/20 border border-green-400/30 text-xs text-green-300">
                                    ‚úì {format.charAt(0).toUpperCase() + format.slice(1)}
                                  </span>
                                ))
                              ) : (
                                <span className="text-xs text-yellow-300">Managers play different formats - individual grades only</span>
                              )}
                            </div>
                          </div>
                        )}

                        <div className={`rounded-xl p-5 border ${
                          compareResult.comparison.winner === 'A' ? 'bg-gradient-to-br from-green-500/20 to-emerald-500/10 border-green-400/30' :
                          compareResult.comparison.winner === 'B' ? 'bg-gradient-to-br from-red-500/20 to-rose-500/10 border-red-400/30' :
                          compareResult.comparison.winner === 'INCOMPARABLE' ? 'bg-gradient-to-br from-blue-500/20 to-indigo-500/10 border-blue-400/30' :
                          'bg-gradient-to-br from-yellow-500/20 to-amber-500/10 border-yellow-400/30'
                        }`}>
                          <div className="text-center mb-4">
                            <div className="text-sm text-white/60 mb-1">
                              {compareResult.comparison.winner === 'INCOMPARABLE' ? 'Comparison Result' : 'Winner'}
                            </div>
                            <div className="text-3xl font-black text-white">
                              {compareResult.comparison.winner === 'TIE' ? "IT'S A TIE!" : 
                               compareResult.comparison.winner === 'INCOMPARABLE' ? "Different Formats" :
                               compareResult.comparison.winner_username}
                            </div>
                            <div className={`inline-block mt-2 px-3 py-1 rounded-full text-sm font-bold ${
                              compareResult.comparison.margin === 'DOMINANT' ? 'bg-red-500/30 text-red-300' :
                              compareResult.comparison.margin === 'CLEAR' ? 'bg-orange-500/30 text-orange-300' :
                              compareResult.comparison.margin === 'SLIGHT' ? 'bg-yellow-500/30 text-yellow-300' :
                              compareResult.comparison.margin === 'INCOMPARABLE' ? 'bg-blue-500/30 text-blue-300' :
                              'bg-gray-500/30 text-gray-300'
                            }`}>
                              {compareResult.comparison.margin === 'INCOMPARABLE' ? 'Individual Grades' : `${compareResult.comparison.margin} Victory`}
                            </div>
                          </div>
                          <p className="text-center text-white/80">{compareResult.comparison.verdict}</p>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          {[compareResult.comparison.manager_a, compareResult.comparison.manager_b].map((manager: any, idx: number) => (
                            <div key={idx} className={`rounded-xl border p-4 ${
                              idx === 0 ? 'bg-cyan-500/10 border-cyan-400/30' : 'bg-purple-500/10 border-purple-400/30'
                            }`}>
                              <div className="flex items-center justify-between mb-3">
                                <div className="text-lg font-bold text-white">{manager.username}</div>
                                <div className={`text-2xl font-black ${
                                  manager.overall_grade?.startsWith('A') ? 'text-green-300' :
                                  manager.overall_grade?.startsWith('B') ? 'text-cyan-300' :
                                  manager.overall_grade?.startsWith('C') ? 'text-yellow-300' :
                                  'text-red-300'
                                }`}>
                                  {manager.overall_grade}
                                </div>
                              </div>

                              <div className="grid grid-cols-3 gap-2 mb-3">
                                {Object.entries(manager.grades_by_type || {}).map(([type, data]: [string, any]) => (
                                  <div key={type} className={`rounded-lg p-2 text-center ${
                                    data.grade === 'N/A' ? 'bg-gray-800/30 opacity-50' : 'bg-black/30'
                                  }`}>
                                    <div className="text-[10px] uppercase text-white/50">{type}</div>
                                    <div className={`text-lg font-bold ${
                                      data.grade === 'N/A' ? 'text-gray-500' :
                                      data.grade?.startsWith('A') ? 'text-green-300' :
                                      data.grade?.startsWith('B') ? 'text-cyan-300' :
                                      data.grade?.startsWith('C') ? 'text-yellow-300' :
                                      'text-red-300'
                                    }`}>{data.grade || '‚Äî'}</div>
                                    <div className="text-[10px] text-white/40">
                                      {data.grade === 'N/A' ? 'No leagues' : `${data.record || '0-0'} (${data.leagues_played || 0} lg)`}
                                    </div>
                                  </div>
                                ))}
                              </div>

                              <div className="space-y-2">
                                <div>
                                  <div className="text-xs text-green-400 font-semibold mb-1">Strengths</div>
                                  <ul className="text-xs text-white/70 space-y-0.5">
                                    {(manager.strengths || []).slice(0, 2).map((s: string, i: number) => (
                                      <li key={i}>‚Ä¢ {s}</li>
                                    ))}
                                  </ul>
                                </div>
                                <div>
                                  <div className="text-xs text-red-400 font-semibold mb-1">Weaknesses</div>
                                  <ul className="text-xs text-white/70 space-y-0.5">
                                    {(manager.weaknesses || []).slice(0, 2).map((w: string, i: number) => (
                                      <li key={i}>‚Ä¢ {w}</li>
                                    ))}
                                  </ul>
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>

                        <div className="rounded-xl bg-black/40 border border-white/10 p-4">
                          <div className="text-sm font-bold text-white/80 mb-2">Head-to-Head by League Type</div>
                          <p className="text-xs text-white/40 mb-3">Only formats where both managers participate are compared</p>
                          <div className="space-y-3">
                            {(['redraft', 'dynasty', 'specialty'] as const).map((format) => {
                              const h2h = compareResult.comparison.head_to_head_breakdown || {}
                              const winnerKey = `${format}_winner`
                              const winner = h2h[winnerKey] || 'N/A'
                              const snapA = compareResult.snapshots?.a?.standard_stats?.[format]
                              const snapB = compareResult.snapshots?.b?.standard_stats?.[format]
                              const aLeagues = snapA?.leagues || 0
                              const bLeagues = snapB?.leagues || 0
                              const notComparable = winner === 'N/A' || (aLeagues === 0 && bLeagues === 0)
                              const nameA = compareResult.comparison.manager_a?.username || 'Manager A'
                              const nameB = compareResult.comparison.manager_b?.username || 'Manager B'

                              if (notComparable && aLeagues === 0 && bLeagues === 0) return null

                              return (
                                <div key={format} className={`rounded-lg border p-3 ${notComparable ? 'bg-gray-800/20 border-white/5 opacity-60' : 'bg-black/20 border-white/10'}`}>
                                  <div className="flex items-center justify-between mb-2">
                                    <span className="text-xs font-bold uppercase text-white/60">{format}</span>
                                    {notComparable ? (
                                      <span className="text-[10px] text-gray-500 bg-gray-700/30 px-2 py-0.5 rounded">Not comparable</span>
                                    ) : (
                                      <span className={`text-[10px] font-bold px-2 py-0.5 rounded ${
                                        winner === 'A' ? 'bg-cyan-500/20 text-cyan-300' :
                                        winner === 'B' ? 'bg-purple-500/20 text-purple-300' :
                                        'bg-gray-500/20 text-gray-300'
                                      }`}>
                                        {winner === 'TIE' ? 'Tied' : winner === 'A' ? `${nameA} wins` : `${nameB} wins`}
                                      </span>
                                    )}
                                  </div>
                                  <div className="grid grid-cols-2 gap-2">
                                    <div className={`text-center p-2 rounded ${winner === 'A' && !notComparable ? 'bg-cyan-500/10 border border-cyan-500/20' : 'bg-black/20'}`}>
                                      <div className="text-[10px] text-white/40 truncate">{nameA}</div>
                                      {aLeagues > 0 ? (
                                        <>
                                          <div className="text-sm font-bold text-white">{snapA.wins}-{snapA.losses}{snapA.ties > 0 ? `-${snapA.ties}` : ''}</div>
                                          <div className="text-[10px] text-white/40">{aLeagues} lg ¬∑ {snapA.championships || 0} üèÜ</div>
                                        </>
                                      ) : (
                                        <div className="text-xs text-gray-500">No leagues</div>
                                      )}
                                    </div>
                                    <div className={`text-center p-2 rounded ${winner === 'B' && !notComparable ? 'bg-purple-500/10 border border-purple-500/20' : 'bg-black/20'}`}>
                                      <div className="text-[10px] text-white/40 truncate">{nameB}</div>
                                      {bLeagues > 0 ? (
                                        <>
                                          <div className="text-sm font-bold text-white">{snapB.wins}-{snapB.losses}{snapB.ties > 0 ? `-${snapB.ties}` : ''}</div>
                                          <div className="text-[10px] text-white/40">{bLeagues} lg ¬∑ {snapB.championships || 0} üèÜ</div>
                                        </>
                                      ) : (
                                        <div className="text-xs text-gray-500">No leagues</div>
                                      )}
                                    </div>
                                  </div>
                                </div>
                              )
                            })}
                          </div>
                        </div>

                        {compareResult.comparison.trash_talk && (
                          <div className="rounded-xl bg-gradient-to-br from-orange-500/10 to-red-500/10 border border-orange-400/20 p-4">
                            <div className="text-sm font-bold text-orange-300 mb-1">üî• Trash Talk</div>
                            <p className="text-sm text-white/80 italic">"{compareResult.comparison.trash_talk}"</p>
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                  </>
                )}

                {activeTab === 'chat' && (
                  <>
                  {/* Hero Metric */}
                  <HeroMetric 
                    value={chatMessages.length > 0 ? `${chatMessages.length}` : '‚Äî'}
                    label="Messages"
                    helper="Your most recent AI guidance"
                    accent="purple"
                  />
                  {/* Tab Headline */}
                  <p className="text-center text-sm sm:text-base text-white/60 mb-4">Ask your fantasy questions and get clear, contextual answers.</p>
                  <div className="bg-black/30 border border-cyan-500/20 rounded-2xl p-4 sm:p-6 flex flex-col h-[600px] sm:h-[700px]">
                    <div className="flex items-start sm:items-center gap-3 mb-4">
                      <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-500/30 to-purple-500/30 flex items-center justify-center text-xl flex-shrink-0">üí¨</div>
                      <div className="flex-1 min-w-0">
                        <h3 className="text-lg sm:text-xl font-bold text-cyan-400">AI Fantasy Coach</h3>
                        <p className="text-xs sm:text-sm text-gray-400">
                          {username 
                            ? 'Personalized to your leagues, rosters & trading style'
                            : 'Ask about trades, players, drafts, waivers, or drop a screenshot'}
                        </p>
                      </div>
                      {username && leagues.length > 0 && (
                        <select
                          value={chatLeagueId}
                          onChange={(e) => setChatLeagueId(e.target.value)}
                          className="px-2 py-1.5 rounded-lg bg-black/40 border border-white/15 text-xs text-white/80 focus:outline-none focus:border-cyan-400/40 max-w-[160px] sm:max-w-[200px] truncate"
                          title="Select a league to give AI more context"
                        >
                          <option value="">All leagues</option>
                          {leagues.map((lg) => (
                            <option key={lg.league_id} value={lg.league_id}>
                              {lg.name} ({lg.season})
                            </option>
                          ))}
                        </select>
                      )}
                    </div>
                    
                    <div 
                      ref={chatContainerRef}
                      className="flex-1 overflow-y-auto space-y-4 mb-4 pr-2"
                    >
                      {chatMessages.length === 0 && (
                        <div className="h-full flex flex-col items-center justify-center text-center p-4">
                          <div className="text-4xl mb-4">üèà</div>
                          <h4 className="text-lg font-semibold text-white mb-2">
                            {username ? `Hey ${username}, I'm Your AI Fantasy Coach` : 'Welcome to AI Fantasy Coach'}
                          </h4>
                          <p className="text-sm text-gray-400 max-w-md mb-6">
                            {username 
                              ? "I know your leagues, rosters, and trading history. Ask me anything - I'll give you personalized advice based on YOUR teams."
                              : "Ask me anything about fantasy sports - trades, player values, draft strategy, start/sit decisions, or upload a screenshot of a trade to analyze."
                            }
                          </p>
                          {username && (
                            <div className="mb-4 px-3 py-1.5 rounded-full bg-gradient-to-r from-cyan-500/20 to-purple-500/20 border border-cyan-400/30 text-xs text-cyan-300">
                              ‚ú® Personalized to your leagues & trading style
                            </div>
                          )}
                          <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 w-full max-w-md">
                            {(username && chatLeagueId ? (() => {
                              const lg = leagues.find(l => l.league_id === chatLeagueId)
                              const n = lg?.name || 'this league'
                              return [
                                `Who should I trade in my "${n}" league?`,
                                `What are my weakest positions in "${n}"?`,
                                `Who are the best trade targets in "${n}"?`,
                                `What moves should I make to improve in "${n}"?`,
                              ]
                            })() : username ? [
                              'Which of my players should I try to sell high on?',
                              'Do I have too much exposure to any one player?',
                              'Based on my trading style, what moves should I make?',
                              'Analyze my best trade opportunity right now',
                            ] : [
                              'Who should I start this week: Ja\'Marr Chase or CeeDee Lamb?',
                              'Is trading away a 2026 1st for Bijan Robinson worth it?',
                              'What FAAB % should I spend on a top waiver pickup?',
                              'How do I value draft picks in dynasty?',
                            ]).map((prompt, idx) => (
                              <button
                                key={idx}
                                onClick={() => { setChatInput(prompt) }}
                                className="text-left p-3 rounded-xl bg-black/40 border border-white/10 text-xs text-gray-300 hover:border-cyan-400/50 hover:bg-cyan-500/10 transition"
                              >
                                {prompt}
                              </button>
                            ))}
                          </div>
                        </div>
                      )}
                      
                      {chatMessages.map((msg, idx) => {
                        const tabMap: Record<string, { tab: Tab; label: string }> = {
                          trade: { tab: 'trade', label: 'Trade Analyzer' },
                          finder: { tab: 'finder', label: 'Trade Finder' },
                          waiver: { tab: 'waiver', label: 'Waiver Wire' },
                          rankings: { tab: 'rankings', label: 'League Rankings' },
                          pulse: { tab: 'pulse', label: 'Market Pulse' },
                          compare: { tab: 'compare', label: 'Player Compare' },
                          strategy: { tab: 'strategy', label: 'Season Strategy' },
                          overview: { tab: 'overview', label: 'Overview' },
                          share: { tab: 'share', label: 'Share' },
                          'player-finder': { tab: 'player-finder', label: 'Player Finder' },
                        }
                        const renderContent = (text: string) => {
                          const lines = text.split('\n')
                          return lines.map((line, li) => {
                            const parts = line.split(/(\[\[tab:[\w-]+\]\])/g)
                            const rendered = parts.map((part, pi) => {
                              const m = part.match(/^\[\[tab:([\w-]+)\]\]$/)
                              if (m && tabMap[m[1]]) {
                                const { tab, label } = tabMap[m[1]]
                                return (
                                  <button
                                    key={pi}
                                    onClick={() => handleActiveTabChange(tab)}
                                    className="inline-flex items-center gap-1 px-2 py-0.5 mx-0.5 rounded-lg bg-cyan-500/20 border border-cyan-400/30 text-cyan-300 text-xs font-medium hover:bg-cyan-500/30 transition"
                                  >
                                    ‚Üí {label}
                                  </button>
                                )
                              }
                              return <span key={pi}>{part}</span>
                            })
                            return <span key={li}>{rendered}{li < lines.length - 1 && <br />}</span>
                          })
                        }
                        return (
                        <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                          <div className={`max-w-[85%] sm:max-w-[75%] p-3 rounded-2xl ${
                            msg.role === 'user' 
                              ? 'bg-cyan-500/20 border border-cyan-400/30 text-white' 
                              : 'bg-black/50 border border-white/10 text-gray-200'
                          }`}>
                            {msg.imageUrl && (
                              <img 
                                src={msg.imageUrl} 
                                alt="Uploaded" 
                                className="max-w-full max-h-48 rounded-lg mb-2"
                              />
                            )}
                            {msg.role === 'assistant' ? (
                              <div className="text-sm">{renderContent(msg.content)}</div>
                            ) : (
                              <p className="text-sm whitespace-pre-wrap">{msg.content}</p>
                            )}
                          </div>
                        </div>
                        )
                      })}
                      
                      {chatLoading && (
                        <div className="flex justify-start">
                          <div className="bg-black/50 border border-white/10 p-3 rounded-2xl">
                            <div className="flex items-center gap-2 text-gray-400 text-sm">
                              <div className="w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></div>
                              <div className="w-2 h-2 bg-cyan-400 rounded-full animate-pulse" style={{ animationDelay: '0.2s' }}></div>
                              <div className="w-2 h-2 bg-cyan-400 rounded-full animate-pulse" style={{ animationDelay: '0.4s' }}></div>
                              <span className="ml-1">Thinking...</span>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                    
                    {chatError && (
                      <div className="mb-3 p-3 rounded-xl bg-red-500/10 border border-red-400/30 text-red-300 text-sm">
                        {chatError}
                      </div>
                    )}
                    
                    {chatImagePreview && (
                      <div className="mb-3 relative inline-block">
                        <img src={chatImagePreview} alt="Preview" className="max-h-24 rounded-lg border border-cyan-400/30" />
                        <button
                          onClick={() => setChatImagePreview(null)}
                          className="absolute -top-2 -right-2 w-6 h-6 bg-red-500 rounded-full flex items-center justify-center text-white text-xs hover:bg-red-600 transition"
                        >
                          ‚úï
                        </button>
                      </div>
                    )}
                    
                    <div className="flex gap-2">
                      <label className="flex-shrink-0 w-11 h-11 sm:w-12 sm:h-12 rounded-xl bg-black/40 border border-white/20 flex items-center justify-center cursor-pointer hover:border-cyan-400/50 hover:bg-cyan-500/10 transition">
                        <input
                          type="file"
                          accept="image/*"
                          onChange={handleChatImageUpload}
                          className="hidden"
                        />
                        <span className="text-lg">üì∑</span>
                      </label>
                      <input
                        type="text"
                        data-chat-input
                        value={chatInput}
                        onChange={(e) => setChatInput(e.target.value)}
                        onKeyDown={(e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChatMessage() } }}
                        placeholder={chatLeagueId ? `Ask about ${leagues.find(l => l.league_id === chatLeagueId)?.name || 'this league'}...` : 'Ask about trades, players, drafts...'}
                        className="flex-1 px-4 py-3 rounded-xl bg-black/40 border border-white/20 text-white placeholder:text-gray-500 focus:border-cyan-400/50 focus:outline-none text-sm sm:text-base"
                        disabled={chatLoading}
                      />
                      <button
                        onClick={sendChatMessage}
                        disabled={chatLoading || (!chatInput.trim() && !chatImagePreview)}
                        className="flex-shrink-0 px-4 sm:px-6 py-3 bg-gradient-to-r from-cyan-500 to-purple-500 text-white font-semibold rounded-xl hover:from-cyan-400 hover:to-purple-400 transition disabled:opacity-50 disabled:cursor-not-allowed min-h-[44px]"
                      >
                        {chatLoading ? '...' : 'Send'}
                      </button>
                    </div>
                    
                    <p className="mt-3 text-[10px] sm:text-xs text-gray-500 text-center">
                      Sports and fantasy sports questions only. Upload trade screenshots for instant analysis.
                    </p>
                  </div>
                  </>
                )}

                {activeTab === 'share' && (
                  <>
                  {/* Hero Metric */}
                  <HeroMetric 
                    value={aiReport?.rating ? `${Math.round(aiReport.rating)}` : '‚Äî'}
                    label="Share Card Ready"
                    helper="Screenshot-ready legacy card"
                    accent="cyan"
                  />
                  {/* Tab Headline */}
                  <p className="text-center text-sm sm:text-base text-white/60 mb-4">Turn your fantasy career into a shareable report card.</p>
                  <div className="bg-black/30 border border-cyan-500/20 rounded-2xl p-4 sm:p-6">
                    <div className="flex items-center justify-between gap-3 flex-wrap mb-4">
                      <div className="flex items-center gap-2">
                        <h3 className="text-lg sm:text-xl font-bold text-cyan-400">Share Your Legacy</h3>
                        <CooldownPill label="Share" ms={shareCooldownMs} tone="slate" />
                      </div>

                      {shareRemaining != null && (
                        <div className="text-[11px] text-white/50">Remaining: {shareRemaining}</div>
                      )}
                    </div>

                    {/* Share Type Selection */}
                    <div className="mb-4">
                      <p className="text-xs text-gray-400 mb-2">What do you want to share?</p>
                      <div className="grid grid-cols-2 sm:grid-cols-4 gap-2">
                        <button
                          onClick={() => { setShareType('legacy'); setShareText(''); setShareTradeAnalysis(null); setShareTradeError(''); setShareTradeSideA(''); setShareTradeSideB(''); setSharePlayerResult(null); setSharePlayerError(''); setSharePlayerSearch(''); }}
                          className={`p-3 rounded-xl text-left transition ${
                            shareType === 'legacy'
                              ? 'bg-gradient-to-br from-cyan-500/30 to-purple-500/30 border border-cyan-400/50'
                              : 'bg-black/30 border border-white/10 hover:border-white/20'
                          }`}
                        >
                          <div className="text-2xl mb-1">üèÜ</div>
                          <div className="text-sm font-semibold text-white">My Legacy</div>
                          <div className="text-[10px] text-gray-400">Career stats & tier</div>
                        </button>
                        <button
                          onClick={() => { setShareType('trade'); setShareText(''); setShareTradeAnalysis(null); setShareTradeSideA(''); setShareTradeSideB(''); setShareTradeError(''); setSharePlayerResult(null); setSharePlayerError(''); }}
                          className={`p-3 rounded-xl text-left transition relative ${
                            shareType === 'trade'
                              ? 'bg-gradient-to-br from-green-500/30 to-emerald-500/30 border border-green-400/50'
                              : 'bg-black/30 border border-white/10 hover:border-white/20'
                          }`}
                        >
                          <div className="text-2xl mb-1">üîÑ</div>
                          <div className="text-sm font-semibold text-white">Trade Vote</div>
                          <div className="text-[10px] text-gray-400">Get community input</div>
                        </button>
                        <button
                          onClick={() => { setShareType('rankings'); setShareText(''); setShareTradeAnalysis(null); setShareTradeError(''); setShareTradeSideA(''); setShareTradeSideB(''); setSharePlayerResult(null); setSharePlayerError(''); setSharePlayerSearch(''); }}
                          disabled={rankingsDynastyLeagues.length === 0}
                          className={`p-3 rounded-xl text-left transition relative ${
                            shareType === 'rankings'
                              ? 'bg-gradient-to-br from-yellow-500/30 to-orange-500/30 border border-yellow-400/50'
                              : 'bg-black/30 border border-white/10 hover:border-white/20'
                          } ${rankingsDynastyLeagues.length === 0 ? 'opacity-50' : ''}`}
                        >
                          {rankingsDynastyLeagues.length === 0 && (
                            <div className="absolute -top-1 -right-1 bg-gray-500 text-white text-[8px] font-bold px-1.5 py-0.5 rounded-full">?</div>
                          )}
                          <div className="text-2xl mb-1">üìä</div>
                          <div className="text-sm font-semibold text-white">League Rank</div>
                          <div className="text-[10px] text-gray-400">{rankingsDynastyLeagues.length > 0 ? 'Show your standing' : 'Check Rankings tab first'}</div>
                        </button>
                        <button
                          onClick={() => { setShareType('exposure'); setShareText(''); setSharePlayerResult(null); setSharePlayerSearch(''); setSharePlayerError(''); setShareTradeAnalysis(null); setShareTradeError(''); }}
                          className={`p-3 rounded-xl text-left transition relative ${
                            shareType === 'exposure'
                              ? 'bg-gradient-to-br from-pink-500/30 to-red-500/30 border border-pink-400/50'
                              : 'bg-black/30 border border-white/10 hover:border-white/20'
                          }`}
                        >
                          <div className="text-2xl mb-1">üìà</div>
                          <div className="text-sm font-semibold text-white">Player Stock</div>
                          <div className="text-[10px] text-gray-400">Share buy/sell signal</div>
                        </button>
                      </div>
                    </div>

                    {/* Trade Vote Inline Form */}
                    {shareType === 'trade' && (
                      <div className="mb-4 p-4 rounded-xl bg-gradient-to-br from-green-500/10 to-emerald-500/10 border border-green-500/20">
                        <h4 className="text-sm font-semibold text-green-400 mb-3">Quick Trade Analysis</h4>
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                          <div>
                            <label className="text-xs text-gray-400 block mb-1">Side A (comma-separated)</label>
                            <input
                              type="text"
                              value={shareTradeSideA}
                              onChange={(e) => setShareTradeSideA(e.target.value)}
                              placeholder="e.g. Ja'Marr Chase, 2025 1st"
                              className="w-full bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-sm text-white placeholder:text-gray-500 focus:border-green-400/50 focus:outline-none"
                            />
                          </div>
                          <div>
                            <label className="text-xs text-gray-400 block mb-1">Side B (comma-separated)</label>
                            <input
                              type="text"
                              value={shareTradeSideB}
                              onChange={(e) => setShareTradeSideB(e.target.value)}
                              placeholder="e.g. CeeDee Lamb"
                              className="w-full bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-sm text-white placeholder:text-gray-500 focus:border-green-400/50 focus:outline-none"
                            />
                          </div>
                        </div>
                        <div className="flex items-center gap-3 mb-3">
                          <select
                            value={shareTradeLeagueType}
                            onChange={(e) => setShareTradeLeagueType(e.target.value as 'dynasty' | 'redraft')}
                            className="bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:border-green-400/50 focus:outline-none"
                          >
                            <option value="dynasty">Dynasty</option>
                            <option value="redraft">Redraft</option>
                          </select>
                          <button
                            onClick={analyzeShareTrade}
                            disabled={shareTradeLoading || !shareTradeSideA.trim() || !shareTradeSideB.trim()}
                            className="px-4 py-2 bg-green-500/20 border border-green-400/50 rounded-lg text-sm text-green-300 hover:bg-green-500/30 disabled:opacity-50 disabled:cursor-not-allowed transition"
                          >
                            {shareTradeLoading ? 'Analyzing...' : 'Analyze Trade'}
                          </button>
                        </div>
                        {shareTradeAnalysis && (
                          <div className="p-3 rounded-lg bg-black/30 border border-green-500/30">
                            <div className="flex items-center gap-2 mb-1">
                              <span className="text-2xl font-bold text-green-400">{shareTradeAnalysis.grade}</span>
                              <span className="text-sm text-gray-300">{shareTradeAnalysis.verdict}</span>
                            </div>
                            <div className="text-xs text-gray-400">Ready to generate share post!</div>
                          </div>
                        )}
                        {shareTradeError && (
                          <div className="p-3 rounded-lg bg-red-500/10 border border-red-500/30 text-red-300 text-sm">
                            {shareTradeError}
                          </div>
                        )}
                      </div>
                    )}

                    {/* Player Stock Inline Form */}
                    {shareType === 'exposure' && (
                      <div className="mb-4 p-4 rounded-xl bg-gradient-to-br from-pink-500/10 to-red-500/10 border border-pink-500/20">
                        <h4 className="text-sm font-semibold text-pink-400 mb-3">Player Stock Lookup</h4>
                        <div className="flex items-center gap-3 mb-3">
                          <input
                            type="text"
                            value={sharePlayerSearch}
                            onChange={(e) => setSharePlayerSearch(e.target.value)}
                            onKeyDown={(e) => e.key === 'Enter' && lookupSharePlayerStock()}
                            placeholder="Search player name..."
                            className="flex-1 bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-sm text-white placeholder:text-gray-500 focus:border-pink-400/50 focus:outline-none"
                          />
                          <button
                            onClick={lookupSharePlayerStock}
                            disabled={sharePlayerLoading || !sharePlayerSearch.trim()}
                            className="px-4 py-2 bg-pink-500/20 border border-pink-400/50 rounded-lg text-sm text-pink-300 hover:bg-pink-500/30 disabled:opacity-50 disabled:cursor-not-allowed transition"
                          >
                            {sharePlayerLoading ? 'Looking up...' : 'Lookup'}
                          </button>
                        </div>
                        {sharePlayerResult && (
                          <div className="p-3 rounded-lg bg-black/30 border border-pink-500/30">
                            <div className="flex items-center justify-between mb-2">
                              <div className="flex items-center gap-2">
                                <MiniPlayerImg sleeperId={sharePlayerResult.sleeperId} name={sharePlayerResult.name} size={28} />
                                <div>
                                  <span className="text-lg font-bold text-white">{sharePlayerResult.name}</span>
                                  <span className="ml-2 text-xs text-gray-400">{sharePlayerResult.position} - {sharePlayerResult.team}</span>
                                </div>
                              </div>
                              <span className={`px-2 py-1 rounded-full text-xs font-bold ${
                                sharePlayerResult.signal === 'BUY' ? 'bg-green-500/30 text-green-300' :
                                sharePlayerResult.signal === 'SELL' ? 'bg-red-500/30 text-red-300' :
                                sharePlayerResult.signal === 'HOLD' ? 'bg-yellow-500/30 text-yellow-300' :
                                'bg-purple-500/30 text-purple-300'
                              }`}>
                                {sharePlayerResult.signal}
                              </span>
                            </div>
                            <div className="text-xs text-gray-400">{sharePlayerResult.trend}</div>
                            <div className="text-xs text-gray-500 mt-1">Dynasty Rank: #{sharePlayerResult.rank}</div>
                          </div>
                        )}
                        {sharePlayerError && (
                          <div className="p-3 rounded-lg bg-red-500/10 border border-red-500/30 text-red-300 text-sm">
                            {sharePlayerError}
                          </div>
                        )}
                      </div>
                    )}

                    {/* Style Selection */}
                    <div className="flex gap-2 mb-3 flex-wrap">
                      {(['balanced', 'humble', 'trash_talk'] as const).map((style) => (
                        <button
                          key={style}
                          onClick={() => generateShareText(style, shareType)}
                          disabled={shareLoading || isShareLocked}
                          className={`px-3 py-1.5 rounded-lg text-sm transition disabled:opacity-50 ${
                            shareStyle === style
                              ? 'bg-cyan-500/30 text-cyan-300 border border-cyan-400/50'
                              : 'bg-black/30 text-gray-400 border border-white/10 hover:border-white/20'
                          }`}
                          title={isShareLocked ? `Cooldown: ${formatCooldown(shareCooldownMs)}` : undefined}
                        >
                          {style === 'balanced' ? '‚öñÔ∏è Balanced' : style === 'humble' ? 'üôè Humble' : 'üî• Trash Talk'}
                        </button>
                      ))}
                    </div>

                    {/* Share Preview Card */}
                    <div className={`rounded-xl p-6 mb-4 ${
                      shareType === 'legacy' ? 'bg-gradient-to-br from-cyan-500/20 to-purple-500/20' :
                      shareType === 'trade' ? 'bg-gradient-to-br from-green-500/20 to-emerald-500/20' :
                      shareType === 'rankings' ? 'bg-gradient-to-br from-yellow-500/20 to-orange-500/20' :
                      'bg-gradient-to-br from-pink-500/20 to-red-500/20'
                    }`}>
                      <div className="flex items-center gap-4 mb-4">
                        {profile?.avatar && <img src={profile.avatar} alt="Avatar" className="w-12 h-12 rounded-full" />}
                        <div>
                          <div className="text-xl font-bold text-white">
                            {profile?.display_name ? `${profile.display_name}` : 'Your'} ‚Ä¢{' '}
                            {shareType === 'legacy' ? 'AF Legacy' :
                             shareType === 'trade' ? 'Trade Vote' :
                             shareType === 'rankings' ? 'League Rank' : 'Player Stock'}
                          </div>
                          <div className={`${
                            shareType === 'legacy' ? 'text-cyan-400' :
                            shareType === 'trade' ? 'text-green-400' :
                            shareType === 'rankings' ? 'text-yellow-400' : 'text-pink-400'
                          }`}>
                            {shareType === 'legacy' && aiReport?.title}
                            {shareType === 'trade' && (shareTradeAnalysis 
                              ? `${shareTradeAnalysis.grade} Grade Trade` 
                              : lastTradeResult 
                                ? 'Recent Trade Analysis' 
                                : 'Enter a trade above to analyze')}
                            {shareType === 'rankings' && (rankingsDynastyLeagues.length > 0 ? 'Dynasty League Standing' : 'Check League Rankings tab first')}
                            {shareType === 'exposure' && (sharePlayerResult 
                              ? `${sharePlayerResult.name} - ${sharePlayerResult.signal}` 
                              : playerSearchResults.length > 0 
                                ? `${playerSearchResults[0]?.playerName} Stock` 
                                : 'Search a player above')}
                          </div>
                        </div>
                        {shareType === 'legacy' && (
                          <div className="ml-auto text-4xl font-bold text-cyan-400">{aiReport?.rating}</div>
                        )}
                      </div>

                      {shareLoading ? (
                        <div className="text-gray-400 text-sm animate-pulse">Generating with Grok...</div>
                      ) : shareText ? (
                        <p className="text-gray-300 text-sm whitespace-pre-wrap">{shareText}</p>
                      ) : (
                        <div className="text-gray-400 text-sm">
                          {shareType === 'legacy' && (aiReport?.share_text || 'Click a style button above to generate your share post')}
                          {shareType === 'trade' && (shareTradeAnalysis 
                            ? `${shareTradeAnalysis.sideA?.join(', ')} ‚Üî ${shareTradeAnalysis.sideB?.join(', ')} - Click a style to generate vote post`
                            : lastTradeResult 
                              ? 'Click a style to generate a trade vote post for community feedback'
                              : 'Enter players for each side above, click Analyze, then pick a style')}
                          {shareType === 'rankings' && (rankingsDynastyLeagues.length > 0 
                            ? 'Click a style to share your league ranking with the community'
                            : 'Go to League Rankings tab to see your standings first')}
                          {shareType === 'exposure' && (sharePlayerResult 
                            ? `${sharePlayerResult.trend} - Click a style to share your take`
                            : playerSearchResults.length > 0 
                              ? `Share your ${playerSearchResults[0]?.stock?.signal || 'hold'} signal on ${playerSearchResults[0]?.playerName}`
                              : 'Search a player above and click Lookup to see their stock signal')}
                        </div>
                      )}
                    </div>

                    <div className="space-y-3">
                      <p className="text-xs text-gray-400 mb-2">Choose where to share:</p>
                      
                      <div className="flex flex-wrap gap-2">
                        <button
                          onClick={() => {
                            const text = shareText || aiReport?.share_text || ''
                            if (!text) { alert('Generate a share post first!'); return }
                            navigator.clipboard.writeText(text)
                            alert('Copied to clipboard!')
                          }}
                          className="flex items-center gap-2 px-4 py-2.5 bg-cyan-500/20 text-cyan-300 rounded-xl hover:bg-cyan-500/30 transition min-h-[44px]"
                        >
                          <span>üìã</span> Copy Text
                        </button>
                        <a
                          href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(
                            shareText || aiReport?.share_text || ''
                          )}`}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="flex items-center gap-2 px-4 py-2.5 bg-black/40 text-white rounded-xl hover:bg-white/10 transition border border-white/20 min-h-[44px]"
                        >
                          <span>ùïè</span> X / Twitter
                        </a>
                        <a
                          href={`https://www.facebook.com/sharer/sharer.php?quote=${encodeURIComponent(
                            shareText || aiReport?.share_text || ''
                          )}`}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="flex items-center gap-2 px-4 py-2.5 bg-blue-600/20 text-blue-300 rounded-xl hover:bg-blue-600/30 transition border border-blue-500/30 min-h-[44px]"
                        >
                          <span>üìò</span> Facebook
                        </a>
                        <a
                          href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(
                            'https://allfantasy.io/af-legacy'
                          )}&summary=${encodeURIComponent(shareText || aiReport?.share_text || '')}`}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="flex items-center gap-2 px-4 py-2.5 bg-blue-700/20 text-blue-200 rounded-xl hover:bg-blue-700/30 transition border border-blue-600/30 min-h-[44px]"
                        >
                          <span>üíº</span> LinkedIn
                        </a>
                      </div>
                      
                      <div className="flex flex-wrap gap-2">
                        <a
                          href={`https://api.whatsapp.com/send?text=${encodeURIComponent(
                            shareText || aiReport?.share_text || ''
                          )}`}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="flex items-center gap-2 px-4 py-2.5 bg-green-600/20 text-green-300 rounded-xl hover:bg-green-600/30 transition border border-green-500/30 min-h-[44px]"
                        >
                          <span>üí¨</span> WhatsApp
                        </a>
                        <a
                          href={`https://www.reddit.com/submit?title=${encodeURIComponent(
                            'My AF Legacy Stats'
                          )}&text=${encodeURIComponent(shareText || aiReport?.share_text || '')}`}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="flex items-center gap-2 px-4 py-2.5 bg-orange-600/20 text-orange-300 rounded-xl hover:bg-orange-600/30 transition border border-orange-500/30 min-h-[44px]"
                        >
                          <span>üî∫</span> Reddit
                        </a>
                        <button
                          onClick={() => {
                            const text = shareText || aiReport?.share_text || ''
                            if (!text) { alert('Generate a share post first!'); return }
                            navigator.clipboard.writeText(text)
                            alert('Copied! Open Threads and paste in your post.')
                          }}
                          className="flex items-center gap-2 px-4 py-2.5 bg-gray-600/20 text-gray-200 rounded-xl hover:bg-gray-600/30 transition border border-gray-500/30 min-h-[44px]"
                        >
                          <span>üßµ</span> Threads
                        </button>
                        <button
                          onClick={() => {
                            const text = shareText || aiReport?.share_text || ''
                            if (!text) { alert('Generate a share post first!'); return }
                            navigator.clipboard.writeText(text)
                            alert('Copied! Paste in any Discord channel.')
                          }}
                          className="flex items-center gap-2 px-4 py-2.5 bg-indigo-600/20 text-indigo-300 rounded-xl hover:bg-indigo-600/30 transition border border-indigo-500/30 min-h-[44px]"
                        >
                          <span>üéÆ</span> Discord
                        </button>
                      </div>
                      
                      <div className="flex flex-wrap gap-2">
                        <button
                          onClick={() => {
                            const text = shareText || aiReport?.share_text || ''
                            if (!text) { alert('Generate a share post first!'); return }
                            navigator.clipboard.writeText(text)
                            alert('Copied! Open TikTok and paste in your caption.')
                          }}
                          className="flex items-center gap-2 px-4 py-2.5 bg-pink-500/20 text-pink-300 rounded-xl hover:bg-pink-500/30 transition border border-pink-500/30 min-h-[44px]"
                        >
                          <span>üéµ</span> TikTok
                        </button>
                        <button
                          onClick={() => {
                            const text = shareText || aiReport?.share_text || ''
                            if (!text) { alert('Generate a share post first!'); return }
                            navigator.clipboard.writeText(text)
                            alert('Copied! Open Instagram and paste in your bio or caption.')
                          }}
                          className="flex items-center gap-2 px-4 py-2.5 bg-gradient-to-r from-purple-500/20 to-pink-500/20 text-pink-200 rounded-xl hover:from-purple-500/30 hover:to-pink-500/30 transition border border-pink-400/30 min-h-[44px]"
                        >
                          <span>üì∏</span> Instagram
                        </button>
                        <button
                          onClick={() => {
                            const text = shareText || aiReport?.share_text || ''
                            if (!text) { alert('Generate a share post first!'); return }
                            navigator.clipboard.writeText(text)
                            alert('Copied! Open Snapchat and paste in your story.')
                          }}
                          className="flex items-center gap-2 px-4 py-2.5 bg-yellow-500/20 text-yellow-300 rounded-xl hover:bg-yellow-500/30 transition border border-yellow-500/30 min-h-[44px]"
                        >
                          <span>üëª</span> Snapchat
                        </button>
                        {typeof navigator !== 'undefined' && navigator.share && (
                          <button
                            onClick={() => {
                              navigator.share({
                                title: 'My AF Legacy',
                                text: shareText || aiReport?.share_text || '',
                              }).catch(() => {})
                            }}
                            className="flex items-center gap-2 px-4 py-2.5 bg-emerald-500/20 text-emerald-300 rounded-xl hover:bg-emerald-500/30 transition border border-emerald-500/30 min-h-[44px]"
                          >
                            <span>üì§</span> More
                          </button>
                        )}
                      </div>
                      
                      <div className="pt-3 border-t border-white/10">
                        <p className="text-xs text-gray-500 mb-2">Share link to your legacy:</p>
                        <div className="flex gap-2">
                          <input
                            type="text"
                            readOnly
                            value={`https://allfantasy.ai/af-legacy?user=${encodeURIComponent(username || '')}`}
                            className="flex-1 px-3 py-2 rounded-lg bg-black/40 border border-white/10 text-gray-400 text-sm"
                          />
                          <button
                            onClick={() => {
                              navigator.clipboard.writeText(`https://allfantasy.ai/af-legacy?user=${encodeURIComponent(username || '')}`)
                              alert('Link copied!')
                            }}
                            className="px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition text-sm"
                          >
                            Copy Link
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                  </>
                )}

                {activeTab === 'transfer' && (
                  <>
                  {/* Hero Metric */}
                  <HeroMetric 
                    value={transferPreview ? 'Ready' : '‚Äî'}
                    label="Transfer Status"
                    helper="What kind of transfer this platform supports"
                    accent="emerald"
                  />
                  {/* Tab Headline */}
                  <p className="text-center text-sm sm:text-base text-white/60 mb-4">Bring your leagues with you ‚Äî no reset, no risk.</p>
                  <div className="bg-black/30 border border-cyan-500/20 rounded-2xl p-4 sm:p-6">
                    <div className="flex flex-wrap items-start sm:items-center gap-3 mb-6">
                      <div className="w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-gradient-to-br from-emerald-500/30 to-cyan-500/30 flex items-center justify-center text-xl sm:text-2xl flex-shrink-0">üì¶</div>
                      <div className="flex-1 min-w-0">
                        <h3 className="text-lg sm:text-xl font-bold text-cyan-400">League Transfer</h3>
                        <p className="text-xs sm:text-sm text-gray-400">Migrate your entire Sleeper league to AllFantasy</p>
                      </div>
                      <span className="px-3 py-1 rounded-full bg-emerald-500/20 border border-emerald-400/30 text-emerald-300 text-[10px] sm:text-xs font-semibold whitespace-nowrap">Live Preview</span>
                    </div>

                    <div className="p-4 rounded-xl bg-gradient-to-r from-emerald-500/10 to-cyan-500/10 border border-emerald-400/20 mb-6">
                      <p className="text-sm text-gray-300">
                        <span className="text-emerald-400 font-semibold">Full League Migration</span> ‚Äî Transfer your complete Sleeper league history, 
                        settings, and data to AllFantasy with one click. Everything stays intact.
                      </p>
                    </div>

                    {/* Transfer Input */}
                    <div className="space-y-4 mb-6 sm:mb-8">
                      {/* League Dropdown Selector */}
                      <div>
                        <label className="block text-sm text-white/70 mb-2">Select Sleeper League</label>
                        <select
                          value={transferLeagueId}
                          onChange={(e) => setTransferLeagueId(e.target.value)}
                          className="w-full px-4 py-3.5 rounded-xl bg-black/50 border border-white/20 text-white focus:outline-none focus:border-cyan-400/60 focus:ring-2 focus:ring-cyan-400/20 transition appearance-none cursor-pointer"
                          style={{ backgroundImage: `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23999'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E")`, backgroundRepeat: 'no-repeat', backgroundPosition: 'right 1rem center', backgroundSize: '1.5rem' }}
                        >
                          <option value="" className="bg-gray-900">Choose a league...</option>
                          {leagues.map((league) => (
                            <option key={league.league_id} value={league.league_id} className="bg-gray-900">
                              {league.name} ({league.season}) - {league.team_count} teams
                            </option>
                          ))}
                        </select>
                      </div>

                      {/* Transfer Button */}
                      <button
                        onClick={() => handleTransfer()}
                        disabled={transferLoading || !transferLeagueId.trim()}
                        className="w-full sm:w-auto px-8 py-3.5 bg-gradient-to-r from-emerald-500 to-cyan-500 hover:from-emerald-400 hover:to-cyan-400 text-white font-bold rounded-xl transition disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-emerald-500/20"
                      >
                        {transferLoading ? 'Loading...' : 'üì¶ Transfer to AF'}
                      </button>

                      {transferError && (
                        <p className="mt-2 text-sm text-red-400">{transferError}</p>
                      )}

                      {/* No leagues message */}
                      {leagues.length === 0 && (
                        <p className="text-sm text-white/50 text-center py-4">
                          Import your Sleeper username first to see your leagues here.
                        </p>
                      )}
                    </div>

                    {/* Transfer Preview Results - Enhanced Phone Mockup */}
                    {transferPreview && (
                      <div className="mb-6 sm:mb-8">
                        {/* Screen indicator dots */}
                        <div className="flex justify-center gap-2 mb-4">
                          {phoneScreens.map((screen, idx) => (
                            <button
                              key={screen}
                              onClick={() => setPhoneScreenIndex(idx)}
                              className={`w-2.5 h-2.5 rounded-full transition-all ${
                                phoneScreenIndex === idx 
                                  ? 'bg-cyan-400 scale-125' 
                                  : 'bg-white/30 hover:bg-white/50'
                              }`}
                            />
                          ))}
                        </div>
                        <div className="text-center text-xs text-white/50 mb-4 capitalize">
                          {phoneScreens[phoneScreenIndex].replace('aitools', 'AI Tools')} Preview
                        </div>

                        {/* Phone Frame with Navigation Arrows */}
                        <div className="relative mx-auto max-w-sm flex items-center justify-center gap-4">
                          {/* Left Arrow */}
                          <button
                            onClick={() => setPhoneScreenIndex(prev => prev > 0 ? prev - 1 : phoneScreens.length - 1)}
                            className="flex-shrink-0 w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 border border-white/20 flex items-center justify-center text-white/70 hover:text-white transition"
                          >
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>
                          </button>

                          {/* Phone Frame */}
                          <div className="relative flex-shrink-0">
                            {/* Glow effect */}
                            <div className="absolute inset-0 bg-gradient-to-br from-cyan-500/30 via-purple-500/20 to-emerald-500/30 blur-3xl opacity-50 rounded-[3rem]" />
                            
                            {/* Phone Frame - Taller aspect ratio */}
                            <div className="relative bg-gradient-to-b from-gray-800 to-gray-900 rounded-[2.5rem] p-2 shadow-2xl shadow-black/50 border border-white/10 w-[280px]">
                              {/* Phone notch */}
                              <div className="absolute top-0 left-1/2 -translate-x-1/2 w-24 h-5 bg-black rounded-b-xl z-10" />
                              
                              {/* Screen - Taller with scrollable content */}
                              <div className="bg-[#0a0a12] rounded-[2rem] overflow-hidden relative h-[520px]">
                                {/* Status bar */}
                                <div className="flex items-center justify-between px-4 py-1.5 text-[9px] text-white/60 bg-black/50">
                                  <span>9:41</span>
                                  <div className="flex items-center gap-1">
                                    <span>üì∂</span>
                                    <span>üîã</span>
                                  </div>
                                </div>
                                
                                {/* Scrollable Content Area */}
                                <div className="h-[485px] overflow-y-auto custom-scrollbar">
                                  {/* Screen 1: Overview */}
                                  {phoneScreenIndex === 0 && (
                                    <div className="px-3 pb-4">
                                      {/* Header */}
                                      <div className="flex items-center gap-2 mb-3 p-2 rounded-xl bg-gradient-to-r from-white/5 to-transparent">
                                        <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-500 to-purple-600 flex items-center justify-center text-lg font-bold text-white">
                                          {transferPreview.league.name.charAt(0)}
                                        </div>
                                        <div className="flex-1 min-w-0">
                                          <h4 className="text-sm font-bold text-white truncate">{transferPreview.league.name}</h4>
                                          <div className="flex flex-wrap gap-1 mt-0.5">
                                            <span className="px-1.5 py-0.5 text-[8px] font-semibold rounded bg-cyan-500/30 text-cyan-300">{transferPreview.league.sport}</span>
                                            <span className="px-1.5 py-0.5 text-[8px] font-semibold rounded bg-purple-500/30 text-purple-300">{transferPreview.league.type}</span>
                                            <span className="px-1.5 py-0.5 text-[8px] font-semibold rounded bg-emerald-500/30 text-emerald-300">{transferPreview.league.teamCount} Teams</span>
                                            <span className="px-1.5 py-0.5 text-[8px] font-semibold rounded bg-amber-500/30 text-amber-300">{transferPreview.league.season}</span>
                                          </div>
                                        </div>
                                      </div>
                                      
                                      {/* Stats Grid */}
                                      <div className="grid grid-cols-2 sm:grid-cols-4 gap-2 mb-4">
                                        {[
                                          { icon: 'üìÖ', value: String(transferPreview.stats?.totalSeasons || 1), label: 'SEASONS' },
                                          { icon: 'üë•', value: String(transferPreview.managers?.length || 0), label: 'MANAGERS' },
                                          { icon: 'üîÑ', value: String(transferPreview.stats?.totalTrades || 0), label: 'TRADES' },
                                          { icon: 'üéØ', value: String(transferPreview.stats?.totalDraftPicks || 0), label: 'PICKS' },
                                        ].map((stat, i) => (
                                          <div key={i} className="p-2 rounded-lg bg-white/5 border border-white/10 text-center">
                                            <span className="text-sm">{stat.icon}</span>
                                            <div className="text-base font-bold text-white">{stat.value}</div>
                                            <div className="text-[7px] text-white/50">{stat.label}</div>
                                          </div>
                                        ))}
                                      </div>
                                      
                                      {/* League Members */}
                                      <div className="mb-3">
                                        <div className="flex items-center gap-1 mb-2">
                                          <span className="text-[10px]">üë•</span>
                                          <span className="text-[10px] font-semibold text-white">LEAGUE MEMBERS</span>
                                        </div>
                                        <div className="grid grid-cols-2 gap-1.5">
                                          {(transferPreview.managers || []).map((m: any, i: number) => (
                                            <div key={i} className="flex items-center gap-1.5 p-1.5 rounded-lg bg-white/5">
                                              {m.avatar ? (
                                                <img src={m.avatar} alt={m.displayName} className="w-6 h-6 rounded-full object-cover" onError={(e) => { e.currentTarget.style.display='none'; e.currentTarget.nextElementSibling && ((e.currentTarget.nextElementSibling as HTMLElement).style.display='flex') }} />
                                              ) : null}
                                              <div className={`w-6 h-6 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-[10px] font-bold text-white ${m.avatar ? 'hidden' : ''}`}>
                                                {(m.displayName || '?').charAt(0).toUpperCase()}
                                              </div>
                                              <div className="min-w-0">
                                                <div className="text-[9px] font-semibold text-white truncate">{m.displayName}</div>
                                                <div className="text-[8px] text-white/50">{m.wins}-{m.losses}{m.ties ? `-${m.ties}` : ''}</div>
                                              </div>
                                            </div>
                                          ))}
                                        </div>
                                      </div>
                                      
                                      {/* AI Tools Teaser */}
                                      <div className="p-2 rounded-lg bg-gradient-to-r from-cyan-500/10 to-purple-500/10 border border-cyan-400/20">
                                        <div className="flex items-center gap-1 mb-1">
                                          <span className="text-[10px]">ü§ñ</span>
                                          <span className="text-[9px] font-semibold text-cyan-300">AF AI TOOLS AVAILABLE</span>
                                        </div>
                                        <div className="flex flex-wrap gap-1">
                                          <span className="px-1.5 py-0.5 text-[7px] rounded bg-cyan-500/20 text-cyan-300">Trade Analyzer</span>
                                          <span className="px-1.5 py-0.5 text-[7px] rounded bg-purple-500/20 text-purple-300">Waiver AI</span>
                                          <span className="px-1.5 py-0.5 text-[7px] rounded bg-emerald-500/20 text-emerald-300">Trade Finder</span>
                                        </div>
                                      </div>
                                    </div>
                                  )}
                                  
                                  {/* Screen 2: Standings */}
                                  {phoneScreenIndex === 1 && (
                                    <div className="px-3 pb-4">
                                      {/* Tab Bar */}
                                      <div className="flex gap-1 mb-3 overflow-x-auto pb-1">
                                        {['DRAFT', 'TEAM', 'LEAGUE', 'PLAYERS', 'TRADES', 'SCORES'].map((tab, i) => (
                                          <span key={tab} className={`px-2 py-1 text-[8px] font-semibold rounded-full whitespace-nowrap ${i === 2 ? 'bg-emerald-500 text-white' : 'bg-white/10 text-white/60'}`}>
                                            {tab}
                                          </span>
                                        ))}
                                      </div>
                                      
                                      <div className="mb-3">
                                        <h5 className="text-xs font-bold text-white mb-2">Standings</h5>
                                        <div className="space-y-1">
                                          {[...(transferPreview.managers || [])].sort((a: any, b: any) => b.wins - a.wins || parseFloat(b.pointsFor) - parseFloat(a.pointsFor)).map((m: any, idx: number) => (
                                            <div key={m.rosterId || idx} className="flex items-center justify-between p-1.5 rounded-lg bg-white/5 hover:bg-white/10">
                                              <div className="flex items-center gap-2">
                                                <span className="w-4 text-center text-[9px] font-bold text-cyan-400">{idx + 1}</span>
                                                {m.avatar ? (
                                                  <img src={m.avatar} alt={m.displayName} className="w-5 h-5 rounded-full object-cover" onError={(e) => { (e.currentTarget as HTMLImageElement).style.display='none'; e.currentTarget.nextElementSibling && ((e.currentTarget.nextElementSibling as HTMLElement).style.display='flex') }} />
                                                ) : null}
                                                <div className={`w-5 h-5 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center text-[8px] font-bold text-white ${m.avatar ? 'hidden' : ''}`}>
                                                  {(m.displayName || '?').charAt(0).toUpperCase()}
                                                </div>
                                                <div>
                                                  <div className="text-[9px] font-semibold text-white truncate max-w-[100px]">{m.displayName}</div>
                                                  <div className="text-[7px] text-white/40">PF {m.pointsFor}</div>
                                                </div>
                                              </div>
                                              <div className="text-right">
                                                <div className="text-[10px] font-bold text-white">{m.wins}-{m.losses}{m.ties ? `-${m.ties}` : ''}</div>
                                              </div>
                                            </div>
                                          ))}
                                        </div>
                                      </div>
                                      
                                      {/* AI Tool Indicator */}
                                      <div className="p-2 rounded-lg bg-gradient-to-r from-purple-500/10 to-cyan-500/10 border border-purple-400/20">
                                        <div className="flex items-center gap-1">
                                          <span className="text-[10px]">üìä</span>
                                          <span className="text-[8px] text-purple-300">League Rankings AI available</span>
                                        </div>
                                      </div>
                                    </div>
                                  )}
                                  
                                  {/* Screen 3: Draft */}
                                  {phoneScreenIndex === 2 && (
                                    <div className="px-3 pb-4">
                                      {/* Tab Bar */}
                                      <div className="flex gap-1 mb-3 overflow-x-auto pb-1">
                                        {['DRAFT', 'TEAM', 'LEAGUE', 'PLAYERS', 'TRADES', 'SCORES'].map((tab, i) => (
                                          <span key={tab} className={`px-2 py-1 text-[8px] font-semibold rounded-full whitespace-nowrap ${i === 0 ? 'bg-emerald-500 text-white' : 'bg-white/10 text-white/60'}`}>
                                            {tab}
                                          </span>
                                        ))}
                                      </div>
                                      
                                      {/* Draftboard */}
                                      <div className="p-3 rounded-xl bg-gradient-to-r from-purple-500/10 to-blue-500/10 border border-purple-400/20 mb-3">
                                        <div className="flex items-center justify-between mb-2">
                                          <h5 className="text-xs font-bold text-white">Draftboard</h5>
                                          <span className="text-[8px] text-white/50">üåê</span>
                                        </div>
                                        <p className="text-[9px] text-white/60 mb-2">Draft time has not yet set</p>
                                        <div className="flex gap-4 justify-center mb-3">
                                          {['DAYS', 'HRS', 'MINS', 'SECS'].map((unit) => (
                                            <div key={unit} className="text-center">
                                              <div className="text-lg font-bold text-white">--</div>
                                              <div className="text-[7px] text-white/40">{unit}</div>
                                            </div>
                                          ))}
                                        </div>
                                        <div className="flex gap-2">
                                          <button className="flex-1 py-1.5 rounded-lg bg-purple-500/30 text-[9px] font-semibold text-purple-300">MOCK DRAFTS</button>
                                          <button className="flex-1 py-1.5 rounded-lg bg-emerald-500 text-[9px] font-semibold text-white">DRAFTROOM</button>
                                        </div>
                                      </div>
                                      
                                      {/* Draft Order */}
                                      <div className="mb-3">
                                        <h5 className="text-xs font-bold text-white mb-2">Team Draft Order</h5>
                                        <div className="space-y-1">
                                          {[...(transferPreview.managers || [])].sort((a: any, b: any) => {
                                            if (a.draftSlot && b.draftSlot) return a.draftSlot - b.draftSlot
                                            if (a.draftSlot) return -1
                                            if (b.draftSlot) return 1
                                            return 0
                                          }).map((m: any, idx: number) => (
                                            <div key={m.rosterId || idx} className="flex items-center gap-2 p-1.5 rounded-lg bg-white/5">
                                              <span className="w-4 text-center text-[10px] font-bold text-cyan-400">{m.draftSlot || '‚Äî'}</span>
                                              {m.avatar ? (
                                                <img src={m.avatar} alt={m.displayName} className="w-5 h-5 rounded-full object-cover" onError={(e) => { (e.currentTarget as HTMLImageElement).style.display='none'; e.currentTarget.nextElementSibling && ((e.currentTarget.nextElementSibling as HTMLElement).style.display='flex') }} />
                                              ) : null}
                                              <div className={`w-5 h-5 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-[9px] font-bold text-white ${m.avatar ? 'hidden' : ''}`}>
                                                {(m.displayName || '?').charAt(0).toUpperCase()}
                                              </div>
                                              <span className="text-[9px] text-white truncate flex-1">{m.displayName}</span>
                                              {!m.draftSlot && (
                                                <span className="text-[7px] text-white/30 italic">No draft position</span>
                                              )}
                                            </div>
                                          ))}
                                        </div>
                                      </div>

                                      {/* Recent Draft Picks */}
                                      {transferPreview.recentDraft && transferPreview.recentDraft.length > 0 && (
                                        <div className="mb-3">
                                          <h5 className="text-xs font-bold text-white mb-2">Recent Draft Picks</h5>
                                          <div className="space-y-1">
                                            {transferPreview.recentDraft.map((pick: any, idx: number) => (
                                              <div key={idx} className="flex items-center gap-2 p-1.5 rounded-lg bg-white/5">
                                                <span className="text-[8px] text-white/40 w-8">R{pick.round}P{pick.pick}</span>
                                                <img
                                                  src={headshotUrl(pick.playerId)}
                                                  alt={pick.playerName}
                                                  className="w-5 h-5 rounded-full object-cover"
                                                  onError={(e) => { (e.currentTarget as HTMLImageElement).style.display='none' }}
                                                />
                                                <div className="min-w-0">
                                                  <div className="text-[9px] font-semibold text-white truncate">{pick.playerName}</div>
                                                  <div className="text-[7px] text-white/40">{pick.position} ¬∑ {pick.team}</div>
                                                </div>
                                              </div>
                                            ))}
                                          </div>
                                        </div>
                                      )}
                                    </div>
                                  )}
                                  
                                  {/* Screen 4: Team/Roster */}
                                  {phoneScreenIndex === 3 && (
                                    <div className="px-3 pb-4">
                                      {/* Tab Bar */}
                                      <div className="flex gap-1 mb-3 overflow-x-auto pb-1">
                                        {['DRAFT', 'TEAM', 'LEAGUE', 'PLAYERS', 'TRADES', 'SCORES'].map((tab, i) => (
                                          <span key={tab} className={`px-2 py-1 text-[8px] font-semibold rounded-full whitespace-nowrap ${i === 1 ? 'bg-emerald-500 text-white' : 'bg-white/10 text-white/60'}`}>
                                            {tab}
                                          </span>
                                        ))}
                                      </div>
                                      
                                      {/* Manager Header */}
                                      <div className="flex items-center gap-2 mb-3 p-2 rounded-xl bg-gradient-to-r from-emerald-500/10 to-transparent">
                                        {transferPreview.managers?.[0]?.avatar ? (
                                          <img src={transferPreview.managers[0].avatar} alt="" className="w-8 h-8 rounded-full object-cover" onError={(e) => { (e.currentTarget as HTMLImageElement).style.display='none'; e.currentTarget.nextElementSibling && ((e.currentTarget.nextElementSibling as HTMLElement).style.display='flex') }} />
                                        ) : null}
                                        <div className={`w-8 h-8 rounded-full bg-gradient-to-br from-emerald-500 to-cyan-600 flex items-center justify-center text-sm font-bold text-white ${transferPreview.managers?.[0]?.avatar ? 'hidden' : ''}`}>
                                          {(transferPreview.managers?.[0]?.displayName || '?').charAt(0).toUpperCase()}
                                        </div>
                                        <div>
                                          <div className="text-[10px] font-bold text-white">{transferPreview.managers?.[0]?.displayName || 'Team'}</div>
                                          <div className="text-[8px] text-white/50">{transferPreview.managers?.[0]?.wins || 0}-{transferPreview.managers?.[0]?.losses || 0} ¬∑ {transferPreview.managers?.[0]?.rosterSize || 0} players</div>
                                        </div>
                                      </div>
                                      
                                      {/* Starters Section */}
                                      <div className="mb-3">
                                        <div className="flex items-center gap-1 mb-2">
                                          <span className="text-[10px]">‚ö°</span>
                                          <span className="text-[10px] font-semibold text-emerald-300">STARTERS</span>
                                        </div>
                                        <div className="space-y-1">
                                          {(() => {
                                            const mgr = transferPreview.managers?.[0]
                                            const starters = mgr?.starters || []
                                            const rosterPos = (transferPreview.rosterPositions || []).filter((p: string) => p !== 'BN' && p !== 'IR' && p !== 'TAXI')
                                            return rosterPos.map((pos: string, idx: number) => {
                                              const playerId = starters[idx]
                                              const player = playerId && transferPreview.playerMap?.[playerId]
                                              const isEmptySlot = !playerId || playerId === '0'
                                              return (
                                                <div key={idx} className="flex items-center gap-2 p-1.5 rounded-lg bg-white/5">
                                                  <span className={`w-10 text-[8px] font-bold px-1 py-0.5 rounded text-center ${
                                                    pos === 'QB' ? 'bg-red-500/30 text-red-300' :
                                                    pos === 'RB' ? 'bg-emerald-500/30 text-emerald-300' :
                                                    pos === 'WR' ? 'bg-blue-500/30 text-blue-300' :
                                                    pos === 'TE' ? 'bg-amber-500/30 text-amber-300' :
                                                    pos === 'K' ? 'bg-purple-500/30 text-purple-300' :
                                                    pos === 'DEF' ? 'bg-orange-500/30 text-orange-300' :
                                                    'bg-cyan-500/30 text-cyan-300'
                                                  }`}>{pos === 'SUPER_FLEX' ? 'SF' : pos}</span>
                                                  {!isEmptySlot && (
                                                    <img
                                                      src={headshotUrl(playerId)}
                                                      alt=""
                                                      className="w-6 h-6 rounded-full object-cover bg-white/10"
                                                      onError={(e) => { (e.currentTarget as HTMLImageElement).src = ''; (e.currentTarget as HTMLImageElement).style.display='none' }}
                                                    />
                                                  )}
                                                  <div className="flex-1 min-w-0">
                                                    {isEmptySlot ? (
                                                      <div className="text-[8px] text-white/30 italic">Empty</div>
                                                    ) : player ? (
                                                      <>
                                                        <div className="text-[9px] font-semibold text-white truncate">{player.name}</div>
                                                        <div className="text-[7px] text-white/40">{player.position} ¬∑ {player.team}</div>
                                                      </>
                                                    ) : (
                                                      <>
                                                        <div className="text-[9px] font-semibold text-white truncate">Player #{playerId}</div>
                                                        <div className="text-[7px] text-white/40">‚Äî</div>
                                                      </>
                                                    )}
                                                  </div>
                                                  {!isEmptySlot && player?.team && (
                                                    <img
                                                      src={teamLogoUrl(player.team)}
                                                      alt=""
                                                      className="w-4 h-4 object-contain"
                                                      onError={(e) => { (e.currentTarget as HTMLImageElement).style.display='none' }}
                                                    />
                                                  )}
                                                </div>
                                              )
                                            })
                                          })()}
                                        </div>
                                      </div>
                                      
                                      {/* Bench Section */}
                                      <div className="mb-3">
                                        <div className="flex items-center gap-1 mb-2">
                                          <span className="text-[10px]">ü™ë</span>
                                          <span className="text-[10px] font-semibold text-white/60">BENCH</span>
                                        </div>
                                        <div className="space-y-1">
                                          {(() => {
                                            const mgr = transferPreview.managers?.[0]
                                            const starters = mgr?.starters || []
                                            const allPlayers = mgr?.players || []
                                            const reserveIds = new Set(mgr?.reserve || [])
                                            const taxiIds = new Set(mgr?.taxi || [])
                                            const benchIds = allPlayers.filter((pid: string) => !starters.includes(pid) && !reserveIds.has(pid) && !taxiIds.has(pid))
                                            return benchIds.map((playerId: string, idx: number) => {
                                              const player = transferPreview.playerMap?.[playerId]
                                              return (
                                                <div key={idx} className="flex items-center gap-2 p-1 rounded-lg bg-white/5">
                                                  <span className={`w-10 text-[8px] font-bold px-1 py-0.5 rounded text-center ${
                                                    player?.position === 'QB' ? 'bg-red-500/20 text-red-300/60' :
                                                    player?.position === 'RB' ? 'bg-emerald-500/20 text-emerald-300/60' :
                                                    player?.position === 'WR' ? 'bg-blue-500/20 text-blue-300/60' :
                                                    player?.position === 'TE' ? 'bg-amber-500/20 text-amber-300/60' :
                                                    'bg-white/10 text-white/30'
                                                  }`}>BN</span>
                                                  <img
                                                    src={headshotUrl(playerId)}
                                                    alt=""
                                                    className="w-5 h-5 rounded-full object-cover bg-white/10"
                                                    onError={(e) => { (e.currentTarget as HTMLImageElement).style.display='none' }}
                                                  />
                                                  <div className="flex-1 min-w-0">
                                                    {player ? (
                                                      <>
                                                        <div className="text-[8px] font-semibold text-white/70 truncate">{player.name}</div>
                                                        <div className="text-[7px] text-white/30">{player.position} ¬∑ {player.team}</div>
                                                      </>
                                                    ) : (
                                                      <div className="text-[8px] text-white/40 truncate">Player #{playerId}</div>
                                                    )}
                                                  </div>
                                                </div>
                                              )
                                            })
                                          })()}
                                        </div>
                                      </div>

                                      {/* IR Section */}
                                      {(() => {
                                        const irIds = transferPreview.managers?.[0]?.reserve || []
                                        if (irIds.length === 0) return null
                                        return (
                                          <div className="mb-3">
                                            <div className="flex items-center gap-1 mb-2">
                                              <span className="text-[10px]">üè•</span>
                                              <span className="text-[10px] font-semibold text-red-400/80">IR</span>
                                              <span className="text-[8px] text-white/30 ml-1">({irIds.length})</span>
                                            </div>
                                            <div className="space-y-1">
                                              {irIds.map((playerId: string, idx: number) => {
                                                const player = transferPreview.playerMap?.[playerId]
                                                return (
                                                  <div key={idx} className="flex items-center gap-2 p-1 rounded-lg bg-red-500/5 border border-red-500/10">
                                                    <span className="w-10 text-[8px] font-bold px-1 py-0.5 rounded text-center bg-red-500/20 text-red-300/60">IR</span>
                                                    <img
                                                      src={headshotUrl(playerId)}
                                                      alt=""
                                                      className="w-5 h-5 rounded-full object-cover bg-white/10 opacity-60"
                                                      onError={(e) => { (e.currentTarget as HTMLImageElement).style.display='none' }}
                                                    />
                                                    <div className="flex-1 min-w-0">
                                                      {player ? (
                                                        <>
                                                          <div className="text-[8px] font-semibold text-white/50 truncate">{player.name}</div>
                                                          <div className="text-[7px] text-red-300/40">{player.position} ¬∑ {player.team}</div>
                                                        </>
                                                      ) : (
                                                        <div className="text-[8px] text-white/40 truncate">Player #{playerId}</div>
                                                      )}
                                                    </div>
                                                  </div>
                                                )
                                              })}
                                            </div>
                                          </div>
                                        )
                                      })()}

                                      {/* Taxi Section */}
                                      {(() => {
                                        const taxiIds = transferPreview.managers?.[0]?.taxi || []
                                        if (taxiIds.length === 0) return null
                                        return (
                                          <div className="mb-3">
                                            <div className="flex items-center gap-1 mb-2">
                                              <span className="text-[10px]">üöï</span>
                                              <span className="text-[10px] font-semibold text-amber-400/80">TAXI</span>
                                              <span className="text-[8px] text-white/30 ml-1">({taxiIds.length})</span>
                                            </div>
                                            <div className="space-y-1">
                                              {taxiIds.map((playerId: string, idx: number) => {
                                                const player = transferPreview.playerMap?.[playerId]
                                                return (
                                                  <div key={idx} className="flex items-center gap-2 p-1 rounded-lg bg-amber-500/5 border border-amber-500/10">
                                                    <span className="w-10 text-[8px] font-bold px-1 py-0.5 rounded text-center bg-amber-500/20 text-amber-300/60">TAXI</span>
                                                    <img
                                                      src={headshotUrl(playerId)}
                                                      alt=""
                                                      className="w-5 h-5 rounded-full object-cover bg-white/10 opacity-70"
                                                      onError={(e) => { (e.currentTarget as HTMLImageElement).style.display='none' }}
                                                    />
                                                    <div className="flex-1 min-w-0">
                                                      {player ? (
                                                        <>
                                                          <div className="text-[8px] font-semibold text-white/60 truncate">{player.name}</div>
                                                          <div className="text-[7px] text-amber-300/40">{player.position} ¬∑ {player.team}</div>
                                                        </>
                                                      ) : (
                                                        <div className="text-[8px] text-white/40 truncate">Player #{playerId}</div>
                                                      )}
                                                    </div>
                                                  </div>
                                                )
                                              })}
                                            </div>
                                          </div>
                                        )
                                      })()}
                                      
                                      {/* Roster Info */}
                                      <div className="p-2 rounded-lg bg-gradient-to-r from-emerald-500/10 to-cyan-500/10 border border-emerald-400/20">
                                        <div className="flex items-center justify-between">
                                          <span className="text-[9px] text-white/60">Roster Size</span>
                                          <span className="text-[9px] text-white font-semibold">{transferPreview.managers?.[0]?.rosterSize || 0} players</span>
                                        </div>
                                        <div className="flex items-center justify-between mt-1">
                                          <span className="text-[9px] text-white/60">Starter Slots</span>
                                          <span className="text-[9px] text-white font-semibold">{(transferPreview.rosterPositions || []).filter((p: string) => p !== 'BN' && p !== 'IR' && p !== 'TAXI').length}</span>
                                        </div>
                                      </div>
                                    </div>
                                  )}
                                  
                                  {/* Screen 5: Trades */}
                                  {phoneScreenIndex === 4 && (
                                    <div className="px-3 pb-4">
                                      {/* Tab Bar */}
                                      <div className="flex gap-1 mb-3 overflow-x-auto pb-1">
                                        {['DRAFT', 'TEAM', 'LEAGUE', 'PLAYERS', 'TRADES', 'SCORES'].map((tab, i) => (
                                          <span key={tab} className={`px-2 py-1 text-[8px] font-semibold rounded-full whitespace-nowrap ${i === 4 ? 'bg-emerald-500 text-white' : 'bg-white/10 text-white/60'}`}>
                                            {i === 4 && <span className="mr-0.5">üî¥</span>}{tab}
                                          </span>
                                        ))}
                                      </div>
                                      
                                      <div className="flex items-center justify-between mb-3">
                                        <div className="flex items-center gap-1">
                                          <span className="text-xs font-bold text-white">Recent Trades</span>
                                          <span className="w-4 h-4 rounded-full bg-red-500 text-[8px] text-white flex items-center justify-center">{transferPreview.recentTrades?.length || 0}</span>
                                        </div>
                                        <button className="px-3 py-1 rounded-full bg-emerald-500 text-[9px] font-semibold text-white">TRADE</button>
                                      </div>
                                      
                                      {/* Trade Cards */}
                                      <div className="space-y-2 mb-3">
                                        {transferPreview.recentTrades && transferPreview.recentTrades.length > 0 ? (
                                          transferPreview.recentTrades.slice(0, 3).map((trade: any, idx: number) => (
                                            <div key={trade.id || idx} className="p-2.5 rounded-lg bg-white/5 border border-white/10">
                                              <div className="flex items-center justify-between mb-2">
                                                <div className="flex items-center gap-1">
                                                  <span className="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                                                  <span className="text-[8px] text-emerald-400">COMPLETED</span>
                                                </div>
                                                <span className="text-[7px] text-white/40">{trade.teamsInvolved} teams</span>
                                              </div>
                                              {trade.sides && trade.sides.length >= 2 ? (
                                                <div className="space-y-2">
                                                  {trade.sides.map((side: any, sIdx: number) => (
                                                    <div key={sIdx}>
                                                      <div className="flex items-center gap-1.5 mb-1">
                                                        {side.avatar ? (
                                                          <img src={side.avatar} alt="" className="w-4 h-4 rounded-full object-cover bg-white/10" onError={(e) => { (e.currentTarget as HTMLImageElement).style.display='none' }} />
                                                        ) : (
                                                          <div className="w-4 h-4 rounded-full bg-white/10 flex items-center justify-center text-[7px] text-white/40">{(side.username || '?')[0]}</div>
                                                        )}
                                                        <span className="text-[8px] font-semibold text-white/80 truncate">{side.username}</span>
                                                        <span className="text-[7px] text-white/30">receives</span>
                                                      </div>
                                                      <div className="ml-5 space-y-0.5">
                                                        {side.receives?.players?.map((p: any, pIdx: number) => (
                                                          <div key={pIdx} className="flex items-center gap-1.5">
                                                            <PlayerBadge name={p.name} sleeperId={p.id} position={p.pos} team={p.team} size="sm" showTeamLogo={false} />
                                                          </div>
                                                        ))}
                                                        {side.receives?.picks > 0 && (
                                                          <div className="text-[7px] text-amber-400 bg-amber-500/10 px-1 py-0.5 rounded inline-block">
                                                            +{side.receives.picks} draft pick{side.receives.picks !== 1 ? 's' : ''}
                                                          </div>
                                                        )}
                                                        {(!side.receives?.players?.length && !side.receives?.picks) && (
                                                          <span className="text-[7px] text-white/30 italic">No assets</span>
                                                        )}
                                                      </div>
                                                      {sIdx < trade.sides.length - 1 && (
                                                        <div className="flex items-center justify-center my-1">
                                                          <div className="w-12 border-t border-white/10"></div>
                                                          <span className="text-[8px] text-white/30 mx-1">‚áÑ</span>
                                                          <div className="w-12 border-t border-white/10"></div>
                                                        </div>
                                                      )}
                                                    </div>
                                                  ))}
                                                </div>
                                              ) : (
                                                <div className="flex items-center justify-center gap-3">
                                                  <div className="text-center">
                                                    <div className="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center mx-auto mb-0.5">
                                                      <span className="text-[9px]">üèà</span>
                                                    </div>
                                                    <div className="text-[7px] text-white">{trade.playersAdded} player{trade.playersAdded !== 1 ? 's' : ''}</div>
                                                  </div>
                                                  <span className="text-white/40">‚áÑ</span>
                                                  <div className="text-center">
                                                    <div className="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center mx-auto mb-0.5">
                                                      <span className="text-[9px]">üèà</span>
                                                    </div>
                                                    <div className="text-[7px] text-white">{trade.playersDropped} player{trade.playersDropped !== 1 ? 's' : ''}</div>
                                                  </div>
                                                </div>
                                              )}
                                            </div>
                                          ))
                                        ) : (
                                          <div className="p-3 rounded-lg bg-white/5 border border-white/10 text-center">
                                            <span className="text-[9px] text-white/40">No recent trades</span>
                                          </div>
                                        )}
                                      </div>
                                      
                                      {/* AI Tool Indicator */}
                                      <div className="p-2 rounded-lg bg-gradient-to-r from-cyan-500/10 to-purple-500/10 border border-cyan-400/20">
                                        <div className="flex items-center gap-1 mb-1">
                                          <span className="text-[10px]">ü§ñ</span>
                                          <span className="text-[8px] font-semibold text-cyan-300">AF AI TRADE TOOLS</span>
                                        </div>
                                        <div className="flex flex-wrap gap-1">
                                          <span className="px-1.5 py-0.5 text-[7px] rounded bg-cyan-500/20 text-cyan-300">Trade Analyzer</span>
                                          <span className="px-1.5 py-0.5 text-[7px] rounded bg-purple-500/20 text-purple-300">Trade Finder</span>
                                          <span className="px-1.5 py-0.5 text-[7px] rounded bg-amber-500/20 text-amber-300">AI GM</span>
                                        </div>
                                      </div>
                                    </div>
                                  )}
                                  
                                  {/* Screen 6: Settings */}
                                  {phoneScreenIndex === 5 && (
                                    <div className="px-3 pb-4">
                                      <h5 className="text-xs font-bold text-white mb-3">League Settings</h5>
                                      
                                      <div className="space-y-2 mb-3">
                                        {[
                                          { label: 'Number of Teams', value: '12' },
                                          { label: 'Roster', value: '' },
                                          { label: 'Playoffs', value: '6 teams, starts week 15' },
                                          { label: 'Waiver Type', value: 'FAAB (Bidding)' },
                                          { label: 'Clear Waivers', value: 'Wednesday (3 AM EST)' },
                                          { label: 'Waiver Time', value: '2 Days' },
                                          { label: 'Trade Deadline', value: 'Week 12' },
                                          { label: 'Injured Reserve Slots', value: '4' },
                                          { label: 'Draft Pick Trading', value: 'Yes' },
                                        ].map((setting, i) => (
                                          <div key={i} className="flex items-center justify-between py-1.5 border-b border-white/5">
                                            <span className="text-[9px] text-white/60">{setting.label}</span>
                                            <span className="text-[9px] text-white font-medium">{setting.value}</span>
                                          </div>
                                        ))}
                                      </div>
                                      
                                      {/* Scoring */}
                                      <div className="p-2 rounded-lg bg-purple-500/10 border border-purple-400/20 mb-3">
                                        <h6 className="text-[10px] font-bold text-white mb-1">Scoring</h6>
                                        <p className="text-[8px] text-cyan-300 mb-2">Non-standard settings highlighted</p>
                                        
                                        {(() => {
                                          const ss = transferPreview.league?.scoringSettings || {} as Record<string, number>
                                          const std: Record<string, number> = { pass_yd: 0.04, pass_td: 4, pass_int: -1, rush_yd: 0.1, rush_td: 6, rec: 0, rec_yd: 0.1, rec_td: 6, fum_lost: -2, st_td: 6, def_st_td: 6, pts_allow_0: 10, sack: 1, int: 2, fum_rec: 2, ff: 1, safe: 2, blk_kick: 2 }
                                          const fmt = (v: number) => { const r = Math.round(v * 1e4) / 1e4; return r >= 0 ? `+${r}` : `${r}` }
                                          const perYd = (v: number) => `${fmt(v)} per yard`
                                          const isHL = (key: string, val: number) => std[key] !== undefined && val !== std[key]

                                          const categories: { title: string; items: { label: string; key: string; format?: 'perYd' }[] }[] = [
                                            { title: 'Passing', items: [
                                              { label: 'Passing Yards', key: 'pass_yd', format: 'perYd' },
                                              { label: 'Passing TD', key: 'pass_td' },
                                              { label: 'Pass Intercepted', key: 'pass_int' },
                                              { label: 'Pass 2pt Conversion', key: 'pass_2pt' },
                                            ]},
                                            { title: 'Rushing', items: [
                                              { label: 'Rushing Yards', key: 'rush_yd', format: 'perYd' },
                                              { label: 'Rushing TD', key: 'rush_td' },
                                              { label: 'Rush 2pt Conversion', key: 'rush_2pt' },
                                              { label: 'Rush First Down', key: 'rush_fd' },
                                            ]},
                                            { title: 'Receiving', items: [
                                              { label: 'Reception', key: 'rec' },
                                              { label: 'Receiving Yards', key: 'rec_yd', format: 'perYd' },
                                              { label: 'Receiving TD', key: 'rec_td' },
                                              { label: 'Reception Bonus - TE', key: 'bonus_rec_te' },
                                              { label: 'Rec First Down', key: 'rec_fd' },
                                              { label: 'Rec 2pt Conversion', key: 'rec_2pt' },
                                            ]},
                                            { title: 'Misc', items: [
                                              { label: 'Fumble Lost', key: 'fum_lost' },
                                              { label: 'Fumble', key: 'fum' },
                                              { label: 'Special Teams TD', key: 'st_td' },
                                            ]},
                                            { title: 'Kicking', items: [
                                              { label: 'FG 0-19', key: 'fg_miss_0_19' },
                                              { label: 'FG 20-29', key: 'fg_20_29' },
                                              { label: 'FG 30-39', key: 'fg_30_39' },
                                              { label: 'FG 40-49', key: 'fg_40_49' },
                                              { label: 'FG 50+', key: 'fg_50p' },
                                              { label: 'Extra Point', key: 'xpm' },
                                              { label: 'Extra Point Missed', key: 'xpmiss' },
                                            ]},
                                            { title: 'Defense / ST', items: [
                                              { label: 'Sack', key: 'sack' },
                                              { label: 'Interception', key: 'int' },
                                              { label: 'Fumble Recovery', key: 'fum_rec' },
                                              { label: 'Forced Fumble', key: 'ff' },
                                              { label: 'Def/ST TD', key: 'def_st_td' },
                                              { label: 'Safety', key: 'safe' },
                                              { label: 'Blocked Kick', key: 'blk_kick' },
                                              { label: 'Pts Allow 0', key: 'pts_allow_0' },
                                              { label: 'Pts Allow 1-6', key: 'pts_allow_1_6' },
                                              { label: 'Pts Allow 7-13', key: 'pts_allow_7_13' },
                                              { label: 'Pts Allow 14-20', key: 'pts_allow_14_20' },
                                              { label: 'Pts Allow 21-27', key: 'pts_allow_21_27' },
                                              { label: 'Pts Allow 28-34', key: 'pts_allow_28_34' },
                                              { label: 'Pts Allow 35+', key: 'pts_allow_35p' },
                                            ]},
                                          ]

                                          return (
                                            <div className="space-y-1">
                                              {categories.map((cat) => {
                                                const visibleItems = cat.items.filter(item => ss[item.key] !== undefined && ss[item.key] !== 0)
                                                if (visibleItems.length === 0) return null
                                                return (
                                                  <div key={cat.title}>
                                                    <div className="text-[9px] font-semibold text-white mt-2 mb-0.5">{cat.title}</div>
                                                    {visibleItems.map((item, i) => {
                                                      const val = ss[item.key] ?? 0
                                                      const hl = isHL(item.key, val)
                                                      const display = item.format === 'perYd' ? perYd(val) : fmt(val)
                                                      return (
                                                        <div key={i} className={`flex justify-between py-1 px-1.5 rounded ${hl ? 'bg-amber-500/20' : ''}`}>
                                                          <span className={`text-[8px] ${hl ? 'text-amber-300' : 'text-white/60'}`}>{item.label}</span>
                                                          <span className={`text-[8px] ${hl ? 'text-amber-300 font-semibold' : 'text-cyan-300'}`}>{display}</span>
                                                        </div>
                                                      )
                                                    })}
                                                  </div>
                                                )
                                              })}
                                            </div>
                                          )
                                        })()}
                                      </div>
                                    </div>
                                  )}
                                  
                                  {/* Screen 7: AI Tools */}
                                  {phoneScreenIndex === 6 && (
                                    <div className="px-3 pb-4">
                                      <div className="flex items-center gap-2 mb-3">
                                        <span className="text-lg">ü§ñ</span>
                                        <h5 className="text-xs font-bold text-white">AF AI Tools</h5>
                                      </div>
                                      <p className="text-[9px] text-white/60 mb-3">Powerful AI-powered tools available for your league</p>
                                      
                                      <div className="space-y-2">
                                        {[
                                          { name: 'Trade Analyzer', desc: 'AI-powered trade evaluation with tier system', icon: 'üìä', color: 'cyan' },
                                          { name: 'Trade Finder', desc: 'Find optimal trades with other managers', icon: 'üîç', color: 'purple' },
                                          { name: 'Waiver AI', desc: 'Smart waiver recommendations & FAAB', icon: 'üéØ', color: 'emerald' },
                                          { name: 'AI GM Assistant', desc: 'Personal GM with counter-offers & targeting', icon: 'üß†', color: 'amber' },
                                          { name: 'League Rankings', desc: 'See where you rank in your league', icon: 'üèÜ', color: 'pink' },
                                          { name: 'AI Chat', desc: 'Personalized advice based on your data', icon: 'üí¨', color: 'blue' },
                                        ].map((tool, i) => (
                                          <div key={i} className={`p-2.5 rounded-lg bg-gradient-to-r from-${tool.color}-500/10 to-transparent border border-${tool.color}-400/20`}>
                                            <div className="flex items-center gap-2">
                                              <span className="text-lg">{tool.icon}</span>
                                              <div>
                                                <div className="text-[10px] font-semibold text-white">{tool.name}</div>
                                                <div className="text-[8px] text-white/50">{tool.desc}</div>
                                              </div>
                                            </div>
                                          </div>
                                        ))}
                                      </div>
                                      
                                      {/* Exclusive Features */}
                                      <div className="mt-3 p-2 rounded-lg bg-gradient-to-r from-amber-500/10 to-orange-500/10 border border-amber-400/30">
                                        <div className="flex items-center gap-1 mb-1">
                                          <span className="text-[10px]">‚ú®</span>
                                          <span className="text-[9px] font-semibold text-amber-300">AF EXCLUSIVE</span>
                                        </div>
                                        <div className="text-[8px] text-white/60">
                                          All AI tools learn from your trading history and league patterns for personalized recommendations.
                                        </div>
                                      </div>
                                    </div>
                                  )}
                                </div>
                                
                                {/* Home indicator */}
                                <div className="absolute bottom-1 left-1/2 -translate-x-1/2 w-24 h-1 bg-white/30 rounded-full"></div>
                              </div>
                            </div>
                          </div>

                          {/* Right Arrow */}
                          <button
                            onClick={() => setPhoneScreenIndex(prev => prev < phoneScreens.length - 1 ? prev + 1 : 0)}
                            className="flex-shrink-0 w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 border border-white/20 flex items-center justify-center text-white/70 hover:text-white transition"
                          >
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>
                          </button>
                        </div>
                        
                        {/* Screen Labels */}
                        <div className="flex justify-center gap-3 mt-4 flex-wrap">
                          {phoneScreens.map((screen, idx) => (
                            <button
                              key={screen}
                              onClick={() => setPhoneScreenIndex(idx)}
                              className={`px-3 py-1.5 rounded-lg text-[10px] font-semibold transition capitalize ${
                                phoneScreenIndex === idx
                                  ? 'bg-cyan-500 text-white'
                                  : 'bg-white/10 text-white/50 hover:bg-white/20'
                              }`}
                            >
                              {screen.replace('aitools', 'AI Tools')}
                            </button>
                          ))}
                        </div>
                      </div>
                    )}
                    
                    {/* Demo Phone Mockup - Always visible */}
                    {!transferPreview && (
                      <div className="mb-6 sm:mb-8">
                        <p className="text-center text-sm text-white/50 mb-4">Select a league above to see the full preview, or explore the demo below</p>
                        
                        {/* Screen indicator dots */}
                        <div className="flex justify-center gap-2 mb-4">
                          {phoneScreens.map((screen, idx) => (
                            <button
                              key={screen}
                              onClick={() => setPhoneScreenIndex(idx)}
                              className={`w-2.5 h-2.5 rounded-full transition-all ${
                                phoneScreenIndex === idx 
                                  ? 'bg-cyan-400 scale-125' 
                                  : 'bg-white/30 hover:bg-white/50'
                              }`}
                            />
                          ))}
                        </div>
                        <div className="text-center text-xs text-white/50 mb-4 capitalize">
                          {phoneScreens[phoneScreenIndex].replace('aitools', 'AI Tools')} Preview
                        </div>

                        {/* Phone Frame with Navigation Arrows */}
                        <div className="relative mx-auto max-w-sm flex items-center justify-center gap-4">
                          {/* Left Arrow */}
                          <button
                            onClick={() => setPhoneScreenIndex(prev => prev > 0 ? prev - 1 : phoneScreens.length - 1)}
                            className="flex-shrink-0 w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 border border-white/20 flex items-center justify-center text-white/70 hover:text-white transition"
                          >
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>
                          </button>

                          {/* Phone Frame */}
                          <div className="relative flex-shrink-0">
                            {/* Glow effect */}
                            <div className="absolute inset-0 bg-gradient-to-br from-cyan-500/30 via-purple-500/20 to-emerald-500/30 blur-3xl opacity-50 rounded-[3rem]" />
                            
                            {/* Phone Frame - Taller aspect ratio */}
                            <div className="relative bg-gradient-to-b from-gray-800 to-gray-900 rounded-[2.5rem] p-2 shadow-2xl shadow-black/50 border border-white/10 w-[280px]">
                              {/* Phone notch */}
                              <div className="absolute top-0 left-1/2 -translate-x-1/2 w-24 h-5 bg-black rounded-b-xl z-10" />
                              
                              {/* Screen - Taller with scrollable content */}
                              <div className="bg-[#0a0a12] rounded-[2rem] overflow-hidden relative h-[520px]">
                                {/* Status bar */}
                                <div className="flex items-center justify-between px-4 py-1.5 text-[9px] text-white/60 bg-black/50">
                                  <span>9:41</span>
                                  <div className="flex items-center gap-1">
                                    <span>üì∂</span>
                                    <span>üîã</span>
                                  </div>
                                </div>
                                
                                {/* Scrollable Content Area - Demo Data */}
                                <div className="h-[485px] overflow-y-auto custom-scrollbar">
                                  {/* Demo screens with placeholder data */}
                                  {phoneScreenIndex === 0 && (
                                    <div className="px-3 pb-4">
                                      <div className="flex items-center gap-2 mb-3 p-2 rounded-xl bg-gradient-to-r from-white/5 to-transparent">
                                        <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-emerald-500 to-cyan-600 flex items-center justify-center text-sm font-bold text-white">AF</div>
                                        <div className="flex-1 min-w-0">
                                          <h4 className="text-sm font-bold text-white truncate">Your Fantasy League</h4>
                                          <div className="flex flex-wrap gap-1 mt-0.5">
                                            <span className="px-1.5 py-0.5 text-[8px] font-semibold rounded bg-cyan-500/30 text-cyan-300">NFL</span>
                                            <span className="px-1.5 py-0.5 text-[8px] font-semibold rounded bg-purple-500/30 text-purple-300">Dynasty</span>
                                            <span className="px-1.5 py-0.5 text-[8px] font-semibold rounded bg-emerald-500/30 text-emerald-300">12 Teams</span>
                                            <span className="px-1.5 py-0.5 text-[8px] font-semibold rounded bg-amber-500/30 text-amber-300">Full PPR</span>
                                          </div>
                                        </div>
                                      </div>
                                      <div className="grid grid-cols-2 sm:grid-cols-4 gap-2 mb-4">
                                        {[
                                          { icon: 'üìÖ', value: '3', label: 'SEASONS' },
                                          { icon: 'üë•', value: '12', label: 'MANAGERS' },
                                          { icon: 'üîÑ', value: '18', label: 'TRADES' },
                                          { icon: 'üéØ', value: '180', label: 'PICKS' },
                                        ].map((stat, i) => (
                                          <div key={i} className="p-2 rounded-lg bg-white/5 border border-white/10 text-center">
                                            <span className="text-sm">{stat.icon}</span>
                                            <div className="text-base font-bold text-white">{stat.value}</div>
                                            <div className="text-[7px] text-white/50">{stat.label}</div>
                                          </div>
                                        ))}
                                      </div>
                                      <div className="mb-3">
                                        <div className="flex items-center gap-1 mb-2">
                                          <span className="text-[10px]">üë•</span>
                                          <span className="text-[10px] font-semibold text-white">LEAGUE MEMBERS</span>
                                        </div>
                                        <div className="grid grid-cols-2 gap-1.5">
                                          {Array.from({ length: 12 }, (_, i) => ({
                                            name: `Manager ${i + 1}`,
                                            record: `${11 - i}-${3 + i}`,
                                            initial: `M${i + 1}`,
                                          })).map((m, i) => (
                                            <div key={i} className="flex items-center gap-1.5 p-1.5 rounded-lg bg-white/5">
                                              <div className="w-6 h-6 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-[8px] font-bold text-white">{m.initial}</div>
                                              <div className="min-w-0">
                                                <div className="text-[9px] font-semibold text-white truncate">{m.name}</div>
                                                <div className="text-[8px] text-white/50">{m.record}</div>
                                              </div>
                                            </div>
                                          ))}
                                        </div>
                                      </div>
                                      <div className="p-2 rounded-lg bg-gradient-to-r from-cyan-500/10 to-purple-500/10 border border-cyan-400/20">
                                        <div className="flex items-center gap-1 mb-1">
                                          <span className="text-[10px]">ü§ñ</span>
                                          <span className="text-[9px] font-semibold text-cyan-300">AF AI TOOLS AVAILABLE</span>
                                        </div>
                                        <div className="flex flex-wrap gap-1">
                                          <span className="px-1.5 py-0.5 text-[7px] rounded bg-cyan-500/20 text-cyan-300">Trade Analyzer</span>
                                          <span className="px-1.5 py-0.5 text-[7px] rounded bg-purple-500/20 text-purple-300">Waiver AI</span>
                                          <span className="px-1.5 py-0.5 text-[7px] rounded bg-emerald-500/20 text-emerald-300">Trade Finder</span>
                                        </div>
                                      </div>
                                    </div>
                                  )}
                                  {phoneScreenIndex === 1 && (
                                    <div className="px-3 pb-4">
                                      <div className="flex gap-1 mb-3 overflow-x-auto pb-1">
                                        {['DRAFT', 'TEAM', 'LEAGUE', 'PLAYERS', 'TRADES', 'SCORES'].map((tab, i) => (
                                          <span key={tab} className={`px-2 py-1 text-[8px] font-semibold rounded-full whitespace-nowrap ${i === 2 ? 'bg-emerald-500 text-white' : 'bg-white/10 text-white/60'}`}>{tab}</span>
                                        ))}
                                      </div>
                                      <h5 className="text-xs font-bold text-white mb-2">Standings</h5>
                                      <div className="space-y-1">
                                        {[
                                          { rank: 1, name: 'Team Alpha', record: '11-3', pf: 1842 },
                                          { rank: 2, name: 'Team Bravo', record: '10-4', pf: 1798 },
                                          { rank: 3, name: 'Team Charlie', record: '9-5', pf: 1756 },
                                          { rank: 4, name: 'Team Delta', record: '9-5', pf: 1721 },
                                          { rank: 5, name: 'Team Echo', record: '8-6', pf: 1698 },
                                          { rank: 6, name: 'Team Foxtrot', record: '8-6', pf: 1654 },
                                          { rank: 7, name: 'Team Golf', record: '7-7', pf: 1632 },
                                          { rank: 8, name: 'Team Hotel', record: '6-8', pf: 1589 },
                                          { rank: 9, name: 'Team India', record: '5-9', pf: 1545 },
                                          { rank: 10, name: 'Team Juliet', record: '4-10', pf: 1512 },
                                          { rank: 11, name: 'Team Kilo', record: '3-11', pf: 1478 },
                                          { rank: 12, name: 'Team Lima', record: '2-12', pf: 1423 },
                                        ].map((team) => (
                                          <div key={team.rank} className="flex items-center justify-between p-1.5 rounded-lg bg-white/5">
                                            <div className="flex items-center gap-2">
                                              <span className="w-4 text-center text-[9px] font-bold text-cyan-400">{team.rank}</span>
                                              <div className="w-5 h-5 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center text-[8px] font-bold text-white">{team.rank}</div>
                                              <div className="text-[9px] font-semibold text-white truncate max-w-[100px]">{team.name}</div>
                                            </div>
                                            <div className="text-[10px] font-bold text-white">{team.record}</div>
                                          </div>
                                        ))}
                                      </div>
                                    </div>
                                  )}
                                  {phoneScreenIndex >= 2 && phoneScreenIndex <= 6 && (
                                    <div className="px-3 pb-4 flex items-center justify-center h-full">
                                      <div className="text-center">
                                        <div className="text-4xl mb-2">{['üìã', 'üèà', 'üîÑ', '‚öôÔ∏è', 'ü§ñ'][phoneScreenIndex - 2]}</div>
                                        <div className="text-sm font-semibold text-white mb-1">{['Draft', 'Team', 'Trades', 'Settings', 'AI Tools'][phoneScreenIndex - 2]} Screen</div>
                                        <div className="text-[10px] text-white/50">Select a league to see full preview</div>
                                      </div>
                                    </div>
                                  )}
                                </div>
                                <div className="absolute bottom-1 left-1/2 -translate-x-1/2 w-24 h-1 bg-white/30 rounded-full"></div>
                              </div>
                            </div>
                          </div>

                          {/* Right Arrow */}
                          <button
                            onClick={() => setPhoneScreenIndex(prev => prev < phoneScreens.length - 1 ? prev + 1 : 0)}
                            className="flex-shrink-0 w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 border border-white/20 flex items-center justify-center text-white/70 hover:text-white transition"
                          >
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>
                          </button>
                        </div>
                        
                        {/* Screen Labels */}
                        <div className="flex justify-center gap-3 mt-4 flex-wrap">
                          {phoneScreens.map((screen, idx) => (
                            <button
                              key={screen}
                              onClick={() => setPhoneScreenIndex(idx)}
                              className={`px-3 py-1.5 rounded-lg text-[10px] font-semibold transition capitalize ${
                                phoneScreenIndex === idx
                                  ? 'bg-cyan-500 text-white'
                                  : 'bg-white/10 text-white/50 hover:bg-white/20'
                              }`}
                            >
                              {screen.replace('aitools', 'AI Tools')}
                            </button>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* League Preview Card - Compact summary when league selected */}
                    {transferPreview && (
                      <div className="rounded-2xl border border-cyan-400/30 bg-gradient-to-br from-slate-800/80 to-slate-900/80 overflow-hidden mb-6">
                        <div className="p-4 border-b border-white/10 bg-gradient-to-r from-cyan-500/10 via-purple-500/5 to-transparent">
                          <div className="flex items-center gap-3">
                            <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-cyan-500 to-purple-600 flex items-center justify-center text-xl font-bold text-white">
                              {transferPreview.league.name.charAt(0)}
                            </div>
                            <div className="flex-1">
                              <h4 className="text-base font-bold text-white">{transferPreview.league.name}</h4>
                              <div className="flex gap-2 mt-1 flex-wrap">
                                <span className="px-2 py-0.5 text-[10px] font-semibold rounded-full bg-cyan-500/20 text-cyan-300">{transferPreview.league.sport}</span>
                                <span className="px-2 py-0.5 text-[10px] font-semibold rounded-full bg-purple-500/20 text-purple-300">{transferPreview.league.teamCount} Teams</span>
                                <span className="px-2 py-0.5 text-[10px] font-semibold rounded-full bg-emerald-500/20 text-emerald-300">{transferPreview.league.season}</span>
                              </div>
                            </div>
                            <span className="px-3 py-1.5 rounded-full bg-emerald-500/20 border border-emerald-400/30 text-emerald-300 text-xs font-semibold">Ready</span>
                          </div>
                        </div>
                        <div className="p-4 grid grid-cols-2 sm:grid-cols-4 gap-3">
                          {[
                            { label: 'Managers', value: transferPreview.league.teamCount, icon: 'üë•' },
                            { label: 'Trades', value: transferPreview.totalTrades || 0, icon: 'üîÑ' },
                            { label: 'Seasons', value: transferPreview.seasonCount || 1, icon: 'üìÖ' },
                            { label: 'Picks', value: transferPreview.draftPickCount || 0, icon: 'üéØ' },
                          ].map((stat, i) => (
                            <div key={i} className="text-center">
                              <div className="text-lg">{stat.icon}</div>
                              <div className="text-lg font-bold text-white">{stat.value}</div>
                              <div className="text-[10px] text-white/50">{stat.label}</div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}


                    {/* Playoff Bracket Preview */}
                    <h4 className="text-base sm:text-lg font-bold text-white mt-8 mb-3 sm:mb-4 flex items-center gap-2">
                      <span className="text-2xl">üèÜ</span> Playoff Bracket
                    </h4>
                    <p className="text-sm text-gray-400 mb-4">
                      See how your league playoffs will look in AllFantasy. Select your playoff format below.
                    </p>
                    
                    {/* Playoff Team Count Selector */}
                    <div className="flex flex-wrap gap-2 mb-2">
                      {[4, 6, 8].map((count) => (
                        <button
                          key={count}
                          onClick={() => setPlayoffTeamCount(count as 4 | 6 | 7 | 8 | 9)}
                          className={`px-4 py-2 rounded-lg text-sm font-semibold transition ${
                            playoffTeamCount === count
                              ? 'bg-cyan-500 text-white'
                              : 'bg-white/10 text-white/60 hover:bg-white/20'
                          }`}
                        >
                          {count} Teams
                        </button>
                      ))}
                      <div className="flex items-center gap-1.5 ml-2 pl-2 border-l border-white/20">
                        <span className="text-[10px] text-amber-400 font-semibold uppercase tracking-wider">AF Super Commissioner</span>
                      </div>
                      {[7, 9].map((count) => (
                        <button
                          key={count}
                          onClick={() => setPlayoffTeamCount(count as 4 | 6 | 7 | 8 | 9)}
                          className={`px-4 py-2 rounded-lg text-sm font-semibold transition border ${
                            playoffTeamCount === count
                              ? 'bg-amber-500 text-white border-amber-400'
                              : 'bg-amber-500/10 text-amber-300 border-amber-400/30 hover:bg-amber-500/20'
                          }`}
                        >
                          {count} Teams
                        </button>
                      ))}
                    </div>
                    {(playoffTeamCount === 7 || playoffTeamCount === 9) && (
                      <p className="text-[11px] text-amber-400/80 mb-3 flex items-center gap-1">
                        <span>‚≠ê</span> AF Super Commissioner Setting ‚Äî exclusive to AllFantasy
                      </p>
                    )}
                    
                    <div className="rounded-2xl overflow-hidden relative" style={{ background: 'linear-gradient(135deg, #0a1628 0%, #1a3a5c 50%, #0d2442 100%)' }}>
                      {/* AF Crest Watermark */}
                      <div className="absolute top-4 right-4 z-10">
                        <img src="/af-crest.jpg" alt="AllFantasy Crest" className="w-14 h-14 rounded-lg shadow-lg shadow-blue-500/30 object-cover" />
                      </div>
                      
                      {/* Header */}
                      <div className="text-center pt-6 pb-4">
                        <h3 className="text-2xl sm:text-3xl font-bold text-white tracking-wide">PLAYOFFS</h3>
                        <p className="text-cyan-300/70 text-sm mt-1">Peach Bowl Dynasty ¬∑ 2025 Season ¬∑ {playoffTeamCount} Team Bracket</p>
                      </div>
                      
                      {/* Bracket Container */}
                      <div className="px-4 sm:px-8 pb-8 overflow-x-auto">
                        {/* 4 Team Bracket */}
                        {playoffTeamCount === 4 && (
                          <div className="min-w-[500px]">
                            <div className="flex justify-around mb-4">
                              <div className="text-center">
                                <span className="text-xs uppercase tracking-wider text-cyan-300/80 font-semibold">Semifinals</span>
                                <span className="block text-[10px] text-white/40">(Week 16)</span>
                              </div>
                              <div className="text-center">
                                <span className="text-xs uppercase tracking-wider text-amber-400 font-semibold">Championship</span>
                                <span className="block text-[10px] text-white/40">(Week 17)</span>
                              </div>
                              <div className="text-center">
                                <span className="text-xs uppercase tracking-wider text-cyan-300/80 font-semibold">3rd Place</span>
                                <span className="block text-[10px] text-white/40">(Week 17)</span>
                              </div>
                            </div>
                            <div className="flex items-center justify-around gap-4">
                              {/* Semis */}
                              <div className="space-y-4">
                                <div className="rounded-lg bg-gradient-to-r from-white/5 to-white/10 border border-white/20 overflow-hidden w-44">
                                  <div className="p-2 flex items-center justify-between border-b border-white/10">
                                    <div className="flex items-center gap-2">
                                      <div className="w-5 h-5 rounded-full bg-gradient-to-br from-cyan-400 to-blue-500 flex items-center justify-center text-[9px] font-bold text-white">1</div>
                                      <span className="text-xs font-medium text-white/80">TysonLeiss</span>
                                    </div>
                                    <span className="text-xs text-white/60">145.20</span>
                                  </div>
                                  <div className="p-2 flex items-center justify-between bg-emerald-500/10">
                                    <div className="flex items-center gap-2">
                                      <div className="w-5 h-5 rounded-full bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center text-[9px] font-bold text-white">4</div>
                                      <span className="text-xs font-semibold text-white">TheCiege24</span>
                                    </div>
                                    <span className="text-sm font-bold text-emerald-400">158.32</span>
                                  </div>
                                </div>
                                <div className="rounded-lg bg-gradient-to-r from-white/5 to-white/10 border border-white/20 overflow-hidden w-44">
                                  <div className="p-2 flex items-center justify-between border-b border-white/10 bg-emerald-500/10">
                                    <div className="flex items-center gap-2">
                                      <div className="w-5 h-5 rounded-full bg-gradient-to-br from-emerald-400 to-green-500 flex items-center justify-center text-[9px] font-bold text-white">2</div>
                                      <span className="text-xs font-semibold text-white">David91R</span>
                                    </div>
                                    <span className="text-sm font-bold text-emerald-400">172.48</span>
                                  </div>
                                  <div className="p-2 flex items-center justify-between">
                                    <div className="flex items-center gap-2">
                                      <div className="w-5 h-5 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center text-[9px] font-bold text-white">3</div>
                                      <span className="text-xs font-medium text-white/80">ADS78</span>
                                    </div>
                                    <span className="text-xs text-white/60">165.90</span>
                                  </div>
                                </div>
                              </div>
                              {/* Championship */}
                              <div className="rounded-xl bg-gradient-to-br from-amber-500/20 via-yellow-500/10 to-amber-500/20 border-2 border-amber-400/50 overflow-hidden shadow-lg shadow-amber-500/20 w-48">
                                <div className="text-center py-2 bg-gradient-to-r from-amber-500/30 to-yellow-500/30 border-b border-amber-400/30">
                                  <span className="text-lg">üèÜ</span>
                                  <span className="text-xs font-bold text-amber-300 ml-1">CHAMPIONSHIP</span>
                                </div>
                                <div className="p-2 flex items-center justify-between border-b border-white/10">
                                  <div className="flex items-center gap-2">
                                    <div className="w-5 h-5 rounded-full bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center text-[9px] font-bold text-white">4</div>
                                    <span className="text-xs font-medium text-white/80">TheCiege24</span>
                                  </div>
                                  <span className="text-xs text-white/60">142.15</span>
                                </div>
                                <div className="p-2 flex items-center justify-between bg-gradient-to-r from-amber-500/20 to-yellow-500/20">
                                  <div className="flex items-center gap-2">
                                    <div className="w-5 h-5 rounded-full bg-gradient-to-br from-emerald-400 to-green-500 flex items-center justify-center text-[9px] font-bold text-white">2</div>
                                    <span className="text-xs font-bold text-amber-300">David91R</span>
                                    <span className="text-sm">üëë</span>
                                  </div>
                                  <span className="text-sm font-bold text-amber-400">197.86</span>
                                </div>
                              </div>
                              {/* 3rd Place */}
                              <div className="rounded-lg bg-gradient-to-r from-white/5 to-white/10 border border-orange-400/30 overflow-hidden w-44">
                                <div className="text-center py-1.5 bg-orange-500/20 border-b border-orange-400/30">
                                  <span className="text-xs font-semibold text-orange-300">3RD PLACE</span>
                                </div>
                                <div className="p-2 flex items-center justify-between border-b border-white/10">
                                  <div className="flex items-center gap-2">
                                    <div className="w-5 h-5 rounded-full bg-gradient-to-br from-cyan-400 to-blue-500 flex items-center justify-center text-[9px] font-bold text-white">1</div>
                                    <span className="text-xs font-medium text-white/80">TysonLeiss</span>
                                  </div>
                                  <span className="text-xs text-white/60">138.40</span>
                                </div>
                                <div className="p-2 flex items-center justify-between bg-orange-500/10">
                                  <div className="flex items-center gap-2">
                                    <div className="w-5 h-5 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center text-[9px] font-bold text-white">3</div>
                                    <span className="text-xs font-semibold text-white">ADS78</span>
                                    <span className="text-xs">ü•â</span>
                                  </div>
                                  <span className="text-sm font-bold text-orange-400">156.80</span>
                                </div>
                              </div>
                            </div>
                          </div>
                        )}

                        {/* 6 Team Bracket */}
                        {playoffTeamCount === 6 && (
                          <div className="min-w-[700px]">
                            <div className="flex justify-between mb-4 px-4">
                              <div className="text-center w-1/4">
                                <span className="text-xs uppercase tracking-wider text-cyan-300/80 font-semibold">Round 1</span>
                                <span className="block text-[10px] text-white/40">(Week 15)</span>
                              </div>
                              <div className="text-center w-1/4">
                                <span className="text-xs uppercase tracking-wider text-cyan-300/80 font-semibold">Semifinals</span>
                                <span className="block text-[10px] text-white/40">(Week 16)</span>
                              </div>
                              <div className="text-center w-1/4">
                                <span className="text-xs uppercase tracking-wider text-amber-400 font-semibold">Championship</span>
                                <span className="block text-[10px] text-white/40">(Week 17)</span>
                              </div>
                              <div className="text-center w-1/4">
                                <span className="text-xs uppercase tracking-wider text-cyan-300/80 font-semibold">3rd Place</span>
                                <span className="block text-[10px] text-white/40">(Week 17)</span>
                              </div>
                            </div>
                            <div className="flex items-center justify-between gap-2">
                              {/* Round 1 */}
                              <div className="w-1/4 space-y-3">
                                <div className="rounded-lg bg-gradient-to-r from-white/5 to-white/10 border border-white/20 overflow-hidden">
                                  <div className="p-2 flex items-center justify-between bg-cyan-500/10 border-b border-white/10">
                                    <div className="flex items-center gap-2">
                                      <div className="w-5 h-5 rounded-full bg-gradient-to-br from-cyan-400 to-blue-500 flex items-center justify-center text-[9px] font-bold text-white">1</div>
                                      <span className="text-xs font-semibold text-white">TysonLeiss</span>
                                    </div>
                                    <span className="text-xs text-emerald-400 font-semibold">BYE</span>
                                  </div>
                                </div>
                                <div className="rounded-lg bg-gradient-to-r from-white/5 to-white/10 border border-white/20 overflow-hidden">
                                  <div className="p-2 flex items-center justify-between border-b border-white/10">
                                    <div className="flex items-center gap-2">
                                      <div className="w-5 h-5 rounded-full bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center text-[9px] font-bold text-white">4</div>
                                      <span className="text-xs font-medium text-white/80">TheCiege24</span>
                                    </div>
                                    <span className="text-xs text-white/60">115.48</span>
                                  </div>
                                  <div className="p-2 flex items-center justify-between bg-emerald-500/10">
                                    <div className="flex items-center gap-2">
                                      <div className="w-5 h-5 rounded-full bg-gradient-to-br from-blue-400 to-cyan-500 flex items-center justify-center text-[9px] font-bold text-white">5</div>
                                      <span className="text-xs font-semibold text-white">PensiveCat</span>
                                    </div>
                                    <span className="text-sm font-bold text-emerald-400">152.44</span>
                                  </div>
                                </div>
                                <div className="rounded-lg bg-gradient-to-r from-white/5 to-white/10 border border-white/20 overflow-hidden">
                                  <div className="p-2 flex items-center justify-between bg-cyan-500/10 border-b border-white/10">
                                    <div className="flex items-center gap-2">
                                      <div className="w-5 h-5 rounded-full bg-gradient-to-br from-emerald-400 to-green-500 flex items-center justify-center text-[9px] font-bold text-white">2</div>
                                      <span className="text-xs font-semibold text-white">David91R</span>
                                    </div>
                                    <span className="text-xs text-emerald-400 font-semibold">BYE</span>
                                  </div>
                                </div>
                                <div className="rounded-lg bg-gradient-to-r from-white/5 to-white/10 border border-white/20 overflow-hidden">
                                  <div className="p-2 flex items-center justify-between border-b border-white/10 bg-emerald-500/10">
                                    <div className="flex items-center gap-2">
                                      <div className="w-5 h-5 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center text-[9px] font-bold text-white">3</div>
                                      <span className="text-xs font-semibold text-white">ADS78</span>
                                    </div>
                                    <span className="text-sm font-bold text-emerald-400">167.20</span>
                                  </div>
                                  <div className="p-2 flex items-center justify-between">
                                    <div className="flex items-center gap-2">
                                      <div className="w-5 h-5 rounded-full bg-gradient-to-br from-gray-400 to-slate-500 flex items-center justify-center text-[9px] font-bold text-white">6</div>
                                      <span className="text-xs font-medium text-white/80">CrazyFisher</span>
                                    </div>
                                    <span className="text-xs text-white/60">112.58</span>
                                  </div>
                                </div>
                              </div>
                              {/* Semis */}
                              <div className="w-1/4 space-y-6 py-8">
                                <div className="rounded-lg bg-gradient-to-r from-white/5 to-white/10 border border-white/20 overflow-hidden">
                                  <div className="p-2 flex items-center justify-between border-b border-white/10">
                                    <div className="flex items-center gap-2">
                                      <div className="w-5 h-5 rounded-full bg-gradient-to-br from-cyan-400 to-blue-500 flex items-center justify-center text-[9px] font-bold text-white">1</div>
                                      <span className="text-xs font-medium text-white/80">TysonLeiss</span>
                                    </div>
                                    <span className="text-xs text-white/60">123.74</span>
                                  </div>
                                  <div className="p-2 flex items-center justify-between bg-emerald-500/10">
                                    <div className="flex items-center gap-2">
                                      <div className="w-5 h-5 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center text-[9px] font-bold text-white">3</div>
                                      <span className="text-xs font-semibold text-white">ADS78</span>
                                    </div>
                                    <span className="text-sm font-bold text-emerald-400">156.80</span>
                                  </div>
                                </div>
                                <div className="rounded-lg bg-gradient-to-r from-white/5 to-white/10 border border-white/20 overflow-hidden">
                                  <div className="p-2 flex items-center justify-between border-b border-white/10 bg-emerald-500/10">
                                    <div className="flex items-center gap-2">
                                      <div className="w-5 h-5 rounded-full bg-gradient-to-br from-emerald-400 to-green-500 flex items-center justify-center text-[9px] font-bold text-white">2</div>
                                      <span className="text-xs font-semibold text-white">David91R</span>
                                    </div>
                                    <span className="text-sm font-bold text-emerald-400">165.60</span>
                                  </div>
                                  <div className="p-2 flex items-center justify-between">
                                    <div className="flex items-center gap-2">
                                      <div className="w-5 h-5 rounded-full bg-gradient-to-br from-blue-400 to-cyan-500 flex items-center justify-center text-[9px] font-bold text-white">5</div>
                                      <span className="text-xs font-medium text-white/80">PensiveCat</span>
                                    </div>
                                    <span className="text-xs text-white/60">112.12</span>
                                  </div>
                                </div>
                              </div>
                              {/* Championship */}
                              <div className="w-1/4 py-16">
                                <div className="rounded-xl bg-gradient-to-br from-amber-500/20 via-yellow-500/10 to-amber-500/20 border-2 border-amber-400/50 overflow-hidden shadow-lg shadow-amber-500/20">
                                  <div className="text-center py-2 bg-gradient-to-r from-amber-500/30 to-yellow-500/30 border-b border-amber-400/30">
                                    <span className="text-lg">üèÜ</span>
                                    <span className="text-xs font-bold text-amber-300 ml-1">CHAMPIONSHIP</span>
                                  </div>
                                  <div className="p-2 flex items-center justify-between border-b border-white/10">
                                    <div className="flex items-center gap-2">
                                      <div className="w-5 h-5 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center text-[9px] font-bold text-white">3</div>
                                      <span className="text-xs font-medium text-white/80">ADS78</span>
                                    </div>
                                    <span className="text-xs text-white/60">119.62</span>
                                  </div>
                                  <div className="p-2 flex items-center justify-between bg-gradient-to-r from-amber-500/20 to-yellow-500/20">
                                    <div className="flex items-center gap-2">
                                      <div className="w-5 h-5 rounded-full bg-gradient-to-br from-emerald-400 to-green-500 flex items-center justify-center text-[9px] font-bold text-white">2</div>
                                      <span className="text-xs font-bold text-amber-300">David91R</span>
                                      <span className="text-sm">üëë</span>
                                    </div>
                                    <span className="text-sm font-bold text-amber-400">197.86</span>
                                  </div>
                                </div>
                              </div>
                              {/* 3rd Place */}
                              <div className="w-1/4 py-16">
                                <div className="rounded-lg bg-gradient-to-r from-white/5 to-white/10 border border-orange-400/30 overflow-hidden">
                                  <div className="text-center py-1.5 bg-orange-500/20 border-b border-orange-400/30">
                                    <span className="text-xs font-semibold text-orange-300">3RD PLACE</span>
                                  </div>
                                  <div className="p-2 flex items-center justify-between border-b border-white/10">
                                    <div className="flex items-center gap-2">
                                      <div className="w-5 h-5 rounded-full bg-gradient-to-br from-cyan-400 to-blue-500 flex items-center justify-center text-[9px] font-bold text-white">1</div>
                                      <span className="text-xs font-medium text-white/80">TysonLeiss</span>
                                    </div>
                                    <span className="text-xs text-white/60">95.92</span>
                                  </div>
                                  <div className="p-2 flex items-center justify-between bg-orange-500/10">
                                    <div className="flex items-center gap-2">
                                      <div className="w-5 h-5 rounded-full bg-gradient-to-br from-blue-400 to-cyan-500 flex items-center justify-center text-[9px] font-bold text-white">5</div>
                                      <span className="text-xs font-semibold text-white">PensiveCat</span>
                                      <span className="text-xs">ü•â</span>
                                    </div>
                                    <span className="text-sm font-bold text-orange-400">109.98</span>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        )}

                        {/* 7 Team Bracket - AF Super Commissioner */}
                        {playoffTeamCount === 7 && (
                          <div className="min-w-[800px]">
                            <div className="flex items-center justify-center gap-2 mb-3">
                              <span className="text-amber-400 text-xs">‚≠ê</span>
                              <span className="text-[10px] text-amber-400 font-semibold uppercase tracking-wider">AF Super Commissioner Format</span>
                              <span className="text-amber-400 text-xs">‚≠ê</span>
                            </div>
                            <div className="flex justify-between mb-4 px-2">
                              <div className="text-center w-1/5">
                                <span className="text-xs uppercase tracking-wider text-cyan-300/80 font-semibold">Wild Card</span>
                                <span className="block text-[10px] text-white/40">(Week 15)</span>
                              </div>
                              <div className="text-center w-1/5">
                                <span className="text-xs uppercase tracking-wider text-cyan-300/80 font-semibold">Semifinals</span>
                                <span className="block text-[10px] text-white/40">(Week 16)</span>
                              </div>
                              <div className="text-center w-1/5">
                                <span className="text-xs uppercase tracking-wider text-amber-400 font-semibold">Championship</span>
                                <span className="block text-[10px] text-white/40">(Week 17)</span>
                              </div>
                              <div className="text-center w-1/5">
                                <span className="text-xs uppercase tracking-wider text-cyan-300/80 font-semibold">3rd Place</span>
                                <span className="block text-[10px] text-white/40">(Week 17)</span>
                              </div>
                              <div className="text-center w-1/5">
                                <span className="text-xs uppercase tracking-wider text-cyan-300/80 font-semibold">5th Place</span>
                                <span className="block text-[10px] text-white/40">(Week 17)</span>
                              </div>
                            </div>
                            <div className="flex items-center justify-between gap-1">
                              {/* Wild Card Round - #1 seed gets bye, 2v7, 3v6, 4v5 */}
                              <div className="w-1/5 space-y-2">
                                <div className="rounded-lg bg-gradient-to-r from-white/5 to-white/10 border border-cyan-400/30 overflow-hidden">
                                  <div className="p-1.5 flex items-center justify-between bg-cyan-500/10">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-cyan-400 to-blue-500 flex items-center justify-center text-[8px] font-bold text-white">1</div>
                                      <span className="text-[10px] font-semibold text-white">TysonLeiss</span>
                                    </div>
                                    <span className="text-[10px] text-emerald-400 font-semibold">BYE</span>
                                  </div>
                                </div>
                                {[
                                  { s1: 2, n1: 'David91R', sc1: 145.30, s2: 7, n2: 'NeverMiss', sc2: 128.78, w: 1 },
                                  { s1: 3, n1: 'ADS78', sc1: 167.20, s2: 6, n2: 'CrazyFisher', sc2: 112.58, w: 1 },
                                  { s1: 4, n1: 'TheCiege24', sc1: 115.48, s2: 5, n2: 'PensiveCat', sc2: 152.44, w: 2 },
                                ].map((m, i) => (
                                  <div key={i} className="rounded-lg bg-gradient-to-r from-white/5 to-white/10 border border-white/20 overflow-hidden">
                                    <div className={`p-1.5 flex items-center justify-between border-b border-white/10 ${m.w === 1 ? 'bg-emerald-500/10' : ''}`}>
                                      <div className="flex items-center gap-1.5">
                                        <div className="w-4 h-4 rounded-full bg-gradient-to-br from-cyan-400 to-blue-500 flex items-center justify-center text-[8px] font-bold text-white">{m.s1}</div>
                                        <span className={`text-[10px] ${m.w === 1 ? 'font-semibold text-white' : 'text-white/70'}`}>{m.n1}</span>
                                      </div>
                                      <span className={`text-[10px] ${m.w === 1 ? 'font-bold text-emerald-400' : 'text-white/50'}`}>{m.sc1}</span>
                                    </div>
                                    <div className={`p-1.5 flex items-center justify-between ${m.w === 2 ? 'bg-emerald-500/10' : ''}`}>
                                      <div className="flex items-center gap-1.5">
                                        <div className="w-4 h-4 rounded-full bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center text-[8px] font-bold text-white">{m.s2}</div>
                                        <span className={`text-[10px] ${m.w === 2 ? 'font-semibold text-white' : 'text-white/70'}`}>{m.n2}</span>
                                      </div>
                                      <span className={`text-[10px] ${m.w === 2 ? 'font-bold text-emerald-400' : 'text-white/50'}`}>{m.sc2}</span>
                                    </div>
                                  </div>
                                ))}
                              </div>
                              {/* Semifinals: 1 vs lowest, other two winners */}
                              <div className="w-1/5 space-y-2 py-4">
                                <div className="rounded-lg bg-gradient-to-r from-white/5 to-white/10 border border-white/20 overflow-hidden">
                                  <div className="p-1.5 flex items-center justify-between border-b border-white/10">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-cyan-400 to-blue-500 flex items-center justify-center text-[8px] font-bold text-white">1</div>
                                      <span className="text-[10px] text-white/70">TysonLeiss</span>
                                    </div>
                                    <span className="text-[10px] text-white/50">123.74</span>
                                  </div>
                                  <div className="p-1.5 flex items-center justify-between bg-emerald-500/10">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-blue-400 to-cyan-500 flex items-center justify-center text-[8px] font-bold text-white">5</div>
                                      <span className="text-[10px] font-semibold text-white">PensiveCat</span>
                                    </div>
                                    <span className="text-[10px] font-bold text-emerald-400">148.20</span>
                                  </div>
                                </div>
                                <div className="rounded-lg bg-gradient-to-r from-white/5 to-white/10 border border-white/20 overflow-hidden">
                                  <div className="p-1.5 flex items-center justify-between border-b border-white/10 bg-emerald-500/10">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-emerald-400 to-green-500 flex items-center justify-center text-[8px] font-bold text-white">2</div>
                                      <span className="text-[10px] font-semibold text-white">David91R</span>
                                    </div>
                                    <span className="text-[10px] font-bold text-emerald-400">165.60</span>
                                  </div>
                                  <div className="p-1.5 flex items-center justify-between">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center text-[8px] font-bold text-white">3</div>
                                      <span className="text-[10px] text-white/70">ADS78</span>
                                    </div>
                                    <span className="text-[10px] text-white/50">156.80</span>
                                  </div>
                                </div>
                              </div>
                              {/* Championship */}
                              <div className="w-1/5 py-14">
                                <div className="rounded-xl bg-gradient-to-br from-amber-500/20 via-yellow-500/10 to-amber-500/20 border-2 border-amber-400/50 overflow-hidden shadow-lg shadow-amber-500/20">
                                  <div className="text-center py-1.5 bg-gradient-to-r from-amber-500/30 to-yellow-500/30 border-b border-amber-400/30">
                                    <span className="text-base">üèÜ</span>
                                  </div>
                                  <div className="p-1.5 flex items-center justify-between border-b border-white/10">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-blue-400 to-cyan-500 flex items-center justify-center text-[8px] font-bold text-white">5</div>
                                      <span className="text-[10px] text-white/70">PensiveCat</span>
                                    </div>
                                    <span className="text-[10px] text-white/50">119.62</span>
                                  </div>
                                  <div className="p-1.5 flex items-center justify-between bg-gradient-to-r from-amber-500/20 to-yellow-500/20">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-emerald-400 to-green-500 flex items-center justify-center text-[8px] font-bold text-white">2</div>
                                      <span className="text-[10px] font-bold text-amber-300">David91R üëë</span>
                                    </div>
                                    <span className="text-[10px] font-bold text-amber-400">197.86</span>
                                  </div>
                                </div>
                              </div>
                              {/* 3rd Place */}
                              <div className="w-1/5 py-14">
                                <div className="rounded-lg bg-gradient-to-r from-white/5 to-white/10 border border-orange-400/30 overflow-hidden">
                                  <div className="text-center py-1 bg-orange-500/20 border-b border-orange-400/30">
                                    <span className="text-[10px] font-semibold text-orange-300">3RD</span>
                                  </div>
                                  <div className="p-1.5 flex items-center justify-between border-b border-white/10">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-cyan-400 to-blue-500 flex items-center justify-center text-[8px] font-bold text-white">1</div>
                                      <span className="text-[10px] text-white/70">TysonLeiss</span>
                                    </div>
                                    <span className="text-[10px] text-white/50">95.92</span>
                                  </div>
                                  <div className="p-1.5 flex items-center justify-between bg-orange-500/10">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center text-[8px] font-bold text-white">3</div>
                                      <span className="text-[10px] font-semibold text-white">ADS78 ü•â</span>
                                    </div>
                                    <span className="text-[10px] font-bold text-orange-400">142.30</span>
                                  </div>
                                </div>
                              </div>
                              {/* 5th Place */}
                              <div className="w-1/5 py-14">
                                <div className="rounded-lg bg-gradient-to-r from-white/5 to-white/10 border border-gray-400/30 overflow-hidden">
                                  <div className="text-center py-1 bg-gray-500/20 border-b border-gray-400/30">
                                    <span className="text-[10px] font-semibold text-gray-300">5TH</span>
                                  </div>
                                  <div className="p-1.5 flex items-center justify-between border-b border-white/10 bg-gray-500/10">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-gray-400 to-slate-500 flex items-center justify-center text-[8px] font-bold text-white">6</div>
                                      <span className="text-[10px] font-semibold text-white">CrazyFisher</span>
                                    </div>
                                    <span className="text-[10px] font-bold text-gray-300">151.04</span>
                                  </div>
                                  <div className="p-1.5 flex items-center justify-between">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center text-[8px] font-bold text-white">7</div>
                                      <span className="text-[10px] text-white/70">NeverMiss</span>
                                    </div>
                                    <span className="text-[10px] text-white/50">129.16</span>
                                  </div>
                                </div>
                              </div>
                            </div>
                            <div className="mt-3 px-2">
                              <div className="rounded-lg bg-amber-500/10 border border-amber-400/20 px-3 py-2">
                                <p className="text-[10px] text-amber-300/80"><span className="font-semibold text-amber-300">How 7-Team Playoffs Work:</span> The #1 seed receives a first-round bye. Seeds 2-7 play in the Wild Card round (2v7, 3v6, 4v5). Winners advance to Semifinals where the #1 seed faces the lowest remaining seed. Championship and consolation rounds follow.</p>
                              </div>
                            </div>
                          </div>
                        )}

                        {/* 9 Team Bracket - AF Super Commissioner */}
                        {playoffTeamCount === 9 && (
                          <div className="min-w-[900px]">
                            <div className="flex items-center justify-center gap-2 mb-3">
                              <span className="text-amber-400 text-xs">‚≠ê</span>
                              <span className="text-[10px] text-amber-400 font-semibold uppercase tracking-wider">AF Super Commissioner Format</span>
                              <span className="text-amber-400 text-xs">‚≠ê</span>
                            </div>
                            <div className="flex justify-between mb-4 px-2">
                              <div className="text-center" style={{ width: '18%' }}>
                                <span className="text-xs uppercase tracking-wider text-cyan-300/80 font-semibold">Wild Card</span>
                                <span className="block text-[10px] text-white/40">(Week 14)</span>
                              </div>
                              <div className="text-center" style={{ width: '18%' }}>
                                <span className="text-xs uppercase tracking-wider text-cyan-300/80 font-semibold">Quarterfinals</span>
                                <span className="block text-[10px] text-white/40">(Week 15)</span>
                              </div>
                              <div className="text-center" style={{ width: '18%' }}>
                                <span className="text-xs uppercase tracking-wider text-cyan-300/80 font-semibold">Semifinals</span>
                                <span className="block text-[10px] text-white/40">(Week 16)</span>
                              </div>
                              <div className="text-center" style={{ width: '18%' }}>
                                <span className="text-xs uppercase tracking-wider text-amber-400 font-semibold">Championship</span>
                                <span className="block text-[10px] text-white/40">(Week 17)</span>
                              </div>
                              <div className="text-center" style={{ width: '14%' }}>
                                <span className="text-xs uppercase tracking-wider text-cyan-300/80 font-semibold">3rd Place</span>
                                <span className="block text-[10px] text-white/40">(Week 17)</span>
                              </div>
                              <div className="text-center" style={{ width: '14%' }}>
                                <span className="text-xs uppercase tracking-wider text-cyan-300/80 font-semibold">5th Place</span>
                                <span className="block text-[10px] text-white/40">(Week 17)</span>
                              </div>
                            </div>
                            <div className="flex items-center justify-between gap-1">
                              {/* Wild Card: 1-4 get bye, 5v9 and 6v8, 7 gets bye into QF */}
                              <div style={{ width: '18%' }} className="space-y-2">
                                {[1, 2, 3, 4].map((s) => (
                                  <div key={s} className="rounded-lg bg-gradient-to-r from-white/5 to-white/10 border border-cyan-400/30 overflow-hidden">
                                    <div className="p-1.5 flex items-center justify-between bg-cyan-500/10">
                                      <div className="flex items-center gap-1.5">
                                        <div className="w-4 h-4 rounded-full bg-gradient-to-br from-cyan-400 to-blue-500 flex items-center justify-center text-[8px] font-bold text-white">{s}</div>
                                        <span className="text-[10px] font-semibold text-white">{['TysonLeiss','David91R','ADS78','TheCiege24'][s-1]}</span>
                                      </div>
                                      <span className="text-[10px] text-emerald-400 font-semibold">BYE</span>
                                    </div>
                                  </div>
                                ))}
                                <div className="rounded-lg bg-gradient-to-r from-white/5 to-white/10 border border-white/20 overflow-hidden">
                                  <div className="p-1.5 flex items-center justify-between border-b border-white/10 bg-emerald-500/10">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-blue-400 to-cyan-500 flex items-center justify-center text-[8px] font-bold text-white">5</div>
                                      <span className="text-[10px] font-semibold text-white">PensiveCat</span>
                                    </div>
                                    <span className="text-[10px] font-bold text-emerald-400">152.44</span>
                                  </div>
                                  <div className="p-1.5 flex items-center justify-between">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center text-[8px] font-bold text-white">9</div>
                                      <span className="text-[10px] text-white/70">TradeKing</span>
                                    </div>
                                    <span className="text-[10px] text-white/50">108.30</span>
                                  </div>
                                </div>
                                <div className="rounded-lg bg-gradient-to-r from-white/5 to-white/10 border border-white/20 overflow-hidden">
                                  <div className="p-1.5 flex items-center justify-between border-b border-white/10 bg-emerald-500/10">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-blue-400 to-cyan-500 flex items-center justify-center text-[8px] font-bold text-white">8</div>
                                      <span className="text-[10px] font-semibold text-white">ObiWanKeBl</span>
                                    </div>
                                    <span className="text-[10px] font-bold text-emerald-400">138.74</span>
                                  </div>
                                  <div className="p-1.5 flex items-center justify-between">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center text-[8px] font-bold text-white">6</div>
                                      <span className="text-[10px] text-white/70">CrazyFisher</span>
                                    </div>
                                    <span className="text-[10px] text-white/50">112.58</span>
                                  </div>
                                </div>
                                <div className="rounded-lg bg-gradient-to-r from-white/5 to-white/10 border border-cyan-400/30 overflow-hidden">
                                  <div className="p-1.5 flex items-center justify-between bg-cyan-500/10">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-cyan-400 to-blue-500 flex items-center justify-center text-[8px] font-bold text-white">7</div>
                                      <span className="text-[10px] font-semibold text-white">NeverMiss</span>
                                    </div>
                                    <span className="text-[10px] text-emerald-400 font-semibold">BYE‚ÜíQF</span>
                                  </div>
                                </div>
                              </div>
                              {/* Quarterfinals: 1v8w, 2v7, 3v6w (6 lost so 5w), 4v5w */}
                              <div style={{ width: '18%' }} className="space-y-2 py-4">
                                {[
                                  { s1: 1, n1: 'TysonLeiss', sc1: 134.60, s2: 8, n2: 'ObiWanKeBl', sc2: 118.74, w: 1 },
                                  { s1: 4, n1: 'TheCiege24', sc1: 115.48, s2: 5, n2: 'PensiveCat', sc2: 148.20, w: 2 },
                                  { s1: 2, n1: 'David91R', sc1: 145.30, s2: 7, n2: 'NeverMiss', sc2: 128.78, w: 1 },
                                  { s1: 3, n1: 'ADS78', sc1: 167.20, s2: 9, n2: 'TradeKing', sc2: 98.30, w: 1 },
                                ].map((m, i) => (
                                  <div key={i} className="rounded-lg bg-gradient-to-r from-white/5 to-white/10 border border-white/20 overflow-hidden">
                                    <div className={`p-1.5 flex items-center justify-between border-b border-white/10 ${m.w === 1 ? 'bg-emerald-500/10' : ''}`}>
                                      <div className="flex items-center gap-1.5">
                                        <div className="w-4 h-4 rounded-full bg-gradient-to-br from-cyan-400 to-blue-500 flex items-center justify-center text-[8px] font-bold text-white">{m.s1}</div>
                                        <span className={`text-[10px] ${m.w === 1 ? 'font-semibold text-white' : 'text-white/70'}`}>{m.n1}</span>
                                      </div>
                                      <span className={`text-[10px] ${m.w === 1 ? 'font-bold text-emerald-400' : 'text-white/50'}`}>{m.sc1}</span>
                                    </div>
                                    <div className={`p-1.5 flex items-center justify-between ${m.w === 2 ? 'bg-emerald-500/10' : ''}`}>
                                      <div className="flex items-center gap-1.5">
                                        <div className="w-4 h-4 rounded-full bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center text-[8px] font-bold text-white">{m.s2}</div>
                                        <span className={`text-[10px] ${m.w === 2 ? 'font-semibold text-white' : 'text-white/70'}`}>{m.n2}</span>
                                      </div>
                                      <span className={`text-[10px] ${m.w === 2 ? 'font-bold text-emerald-400' : 'text-white/50'}`}>{m.sc2}</span>
                                    </div>
                                  </div>
                                ))}
                              </div>
                              {/* Semifinals */}
                              <div style={{ width: '18%' }} className="space-y-2 py-10">
                                <div className="rounded-lg bg-gradient-to-r from-white/5 to-white/10 border border-white/20 overflow-hidden">
                                  <div className="p-1.5 flex items-center justify-between border-b border-white/10">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-cyan-400 to-blue-500 flex items-center justify-center text-[8px] font-bold text-white">1</div>
                                      <span className="text-[10px] text-white/70">TysonLeiss</span>
                                    </div>
                                    <span className="text-[10px] text-white/50">123.74</span>
                                  </div>
                                  <div className="p-1.5 flex items-center justify-between bg-emerald-500/10">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-blue-400 to-cyan-500 flex items-center justify-center text-[8px] font-bold text-white">5</div>
                                      <span className="text-[10px] font-semibold text-white">PensiveCat</span>
                                    </div>
                                    <span className="text-[10px] font-bold text-emerald-400">148.20</span>
                                  </div>
                                </div>
                                <div className="rounded-lg bg-gradient-to-r from-white/5 to-white/10 border border-white/20 overflow-hidden">
                                  <div className="p-1.5 flex items-center justify-between border-b border-white/10 bg-emerald-500/10">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-emerald-400 to-green-500 flex items-center justify-center text-[8px] font-bold text-white">2</div>
                                      <span className="text-[10px] font-semibold text-white">David91R</span>
                                    </div>
                                    <span className="text-[10px] font-bold text-emerald-400">165.60</span>
                                  </div>
                                  <div className="p-1.5 flex items-center justify-between">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center text-[8px] font-bold text-white">3</div>
                                      <span className="text-[10px] text-white/70">ADS78</span>
                                    </div>
                                    <span className="text-[10px] text-white/50">156.80</span>
                                  </div>
                                </div>
                              </div>
                              {/* Championship */}
                              <div style={{ width: '18%' }} className="py-16">
                                <div className="rounded-xl bg-gradient-to-br from-amber-500/20 via-yellow-500/10 to-amber-500/20 border-2 border-amber-400/50 overflow-hidden shadow-lg shadow-amber-500/20">
                                  <div className="text-center py-1.5 bg-gradient-to-r from-amber-500/30 to-yellow-500/30 border-b border-amber-400/30">
                                    <span className="text-base">üèÜ</span>
                                  </div>
                                  <div className="p-1.5 flex items-center justify-between border-b border-white/10">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-blue-400 to-cyan-500 flex items-center justify-center text-[8px] font-bold text-white">5</div>
                                      <span className="text-[10px] text-white/70">PensiveCat</span>
                                    </div>
                                    <span className="text-[10px] text-white/50">119.62</span>
                                  </div>
                                  <div className="p-1.5 flex items-center justify-between bg-gradient-to-r from-amber-500/20 to-yellow-500/20">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-emerald-400 to-green-500 flex items-center justify-center text-[8px] font-bold text-white">2</div>
                                      <span className="text-[10px] font-bold text-amber-300">David91R üëë</span>
                                    </div>
                                    <span className="text-[10px] font-bold text-amber-400">197.86</span>
                                  </div>
                                </div>
                              </div>
                              {/* 3rd Place */}
                              <div style={{ width: '14%' }} className="py-16">
                                <div className="rounded-lg bg-gradient-to-r from-white/5 to-white/10 border border-orange-400/30 overflow-hidden">
                                  <div className="text-center py-1 bg-orange-500/20 border-b border-orange-400/30">
                                    <span className="text-[10px] font-semibold text-orange-300">3RD</span>
                                  </div>
                                  <div className="p-1.5 flex items-center justify-between border-b border-white/10">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-cyan-400 to-blue-500 flex items-center justify-center text-[8px] font-bold text-white">1</div>
                                      <span className="text-[10px] text-white/70">TysonLeiss</span>
                                    </div>
                                    <span className="text-[10px] text-white/50">95.92</span>
                                  </div>
                                  <div className="p-1.5 flex items-center justify-between bg-orange-500/10">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center text-[8px] font-bold text-white">3</div>
                                      <span className="text-[10px] font-semibold text-white">ADS78 ü•â</span>
                                    </div>
                                    <span className="text-[10px] font-bold text-orange-400">142.30</span>
                                  </div>
                                </div>
                              </div>
                              {/* 5th Place */}
                              <div style={{ width: '14%' }} className="py-16">
                                <div className="rounded-lg bg-gradient-to-r from-white/5 to-white/10 border border-gray-400/30 overflow-hidden">
                                  <div className="text-center py-1 bg-gray-500/20 border-b border-gray-400/30">
                                    <span className="text-[10px] font-semibold text-gray-300">5TH</span>
                                  </div>
                                  <div className="p-1.5 flex items-center justify-between border-b border-white/10 bg-gray-500/10">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center text-[8px] font-bold text-white">4</div>
                                      <span className="text-[10px] font-semibold text-white">TheCiege24</span>
                                    </div>
                                    <span className="text-[10px] font-bold text-gray-300">151.04</span>
                                  </div>
                                  <div className="p-1.5 flex items-center justify-between">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-gray-400 to-slate-500 flex items-center justify-center text-[8px] font-bold text-white">8</div>
                                      <span className="text-[10px] text-white/70">ObiWanKeBl</span>
                                    </div>
                                    <span className="text-[10px] text-white/50">129.16</span>
                                  </div>
                                </div>
                              </div>
                            </div>
                            <div className="mt-3 px-2">
                              <div className="rounded-lg bg-amber-500/10 border border-amber-400/20 px-3 py-2">
                                <p className="text-[10px] text-amber-300/80"><span className="font-semibold text-amber-300">How 9-Team Playoffs Work:</span> Seeds 1-4 receive first-round byes. Seed 7 gets a bye into the Quarterfinals. Wild Card: 5v9 and 8v6. Quarterfinals: 1 vs lowest WC winner, 4 vs highest WC winner, 2v7, 3 vs remaining WC winner. Semifinals ‚Üí Championship ‚Üí consolation rounds follow standard bracket seeding.</p>
                              </div>
                            </div>
                          </div>
                        )}

                        {/* 8 Team Bracket */}
                        {playoffTeamCount === 8 && (
                          <div className="min-w-[800px]">
                            <div className="flex justify-between mb-4 px-2">
                              <div className="text-center w-1/5">
                                <span className="text-xs uppercase tracking-wider text-cyan-300/80 font-semibold">Quarterfinals</span>
                                <span className="block text-[10px] text-white/40">(Week 15)</span>
                              </div>
                              <div className="text-center w-1/5">
                                <span className="text-xs uppercase tracking-wider text-cyan-300/80 font-semibold">Semifinals</span>
                                <span className="block text-[10px] text-white/40">(Week 16)</span>
                              </div>
                              <div className="text-center w-1/5">
                                <span className="text-xs uppercase tracking-wider text-amber-400 font-semibold">Championship</span>
                                <span className="block text-[10px] text-white/40">(Week 17)</span>
                              </div>
                              <div className="text-center w-1/5">
                                <span className="text-xs uppercase tracking-wider text-cyan-300/80 font-semibold">3rd Place</span>
                                <span className="block text-[10px] text-white/40">(Week 17)</span>
                              </div>
                              <div className="text-center w-1/5">
                                <span className="text-xs uppercase tracking-wider text-cyan-300/80 font-semibold">5th Place</span>
                                <span className="block text-[10px] text-white/40">(Week 17)</span>
                              </div>
                            </div>
                            <div className="flex items-center justify-between gap-1">
                              {/* Quarterfinals */}
                              <div className="w-1/5 space-y-2">
                                {[
                                  { s1: 1, n1: 'TysonLeiss', sc1: 134.60, s2: 8, n2: 'ObiWanKeBl', sc2: 118.74, w: 1 },
                                  { s1: 4, n1: 'TheCiege24', sc1: 115.48, s2: 5, n2: 'PensiveCat', sc2: 152.44, w: 2 },
                                  { s1: 2, n1: 'David91R', sc1: 145.30, s2: 7, n2: 'NeverMiss', sc2: 128.78, w: 1 },
                                  { s1: 3, n1: 'ADS78', sc1: 167.20, s2: 6, n2: 'CrazyFisher', sc2: 112.58, w: 1 },
                                ].map((m, i) => (
                                  <div key={i} className="rounded-lg bg-gradient-to-r from-white/5 to-white/10 border border-white/20 overflow-hidden">
                                    <div className={`p-1.5 flex items-center justify-between border-b border-white/10 ${m.w === 1 ? 'bg-emerald-500/10' : ''}`}>
                                      <div className="flex items-center gap-1.5">
                                        <div className="w-4 h-4 rounded-full bg-gradient-to-br from-cyan-400 to-blue-500 flex items-center justify-center text-[8px] font-bold text-white">{m.s1}</div>
                                        <span className={`text-[10px] ${m.w === 1 ? 'font-semibold text-white' : 'text-white/70'}`}>{m.n1}</span>
                                      </div>
                                      <span className={`text-[10px] ${m.w === 1 ? 'font-bold text-emerald-400' : 'text-white/50'}`}>{m.sc1}</span>
                                    </div>
                                    <div className={`p-1.5 flex items-center justify-between ${m.w === 2 ? 'bg-emerald-500/10' : ''}`}>
                                      <div className="flex items-center gap-1.5">
                                        <div className="w-4 h-4 rounded-full bg-gradient-to-br from-gray-400 to-slate-500 flex items-center justify-center text-[8px] font-bold text-white">{m.s2}</div>
                                        <span className={`text-[10px] ${m.w === 2 ? 'font-semibold text-white' : 'text-white/70'}`}>{m.n2}</span>
                                      </div>
                                      <span className={`text-[10px] ${m.w === 2 ? 'font-bold text-emerald-400' : 'text-white/50'}`}>{m.sc2}</span>
                                    </div>
                                  </div>
                                ))}
                              </div>
                              {/* Semis */}
                              <div className="w-1/5 space-y-4 py-6">
                                <div className="rounded-lg bg-gradient-to-r from-white/5 to-white/10 border border-white/20 overflow-hidden">
                                  <div className="p-1.5 flex items-center justify-between border-b border-white/10">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-cyan-400 to-blue-500 flex items-center justify-center text-[8px] font-bold text-white">1</div>
                                      <span className="text-[10px] text-white/70">TysonLeiss</span>
                                    </div>
                                    <span className="text-[10px] text-white/50">123.74</span>
                                  </div>
                                  <div className="p-1.5 flex items-center justify-between bg-emerald-500/10">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center text-[8px] font-bold text-white">3</div>
                                      <span className="text-[10px] font-semibold text-white">ADS78</span>
                                    </div>
                                    <span className="text-[10px] font-bold text-emerald-400">156.80</span>
                                  </div>
                                </div>
                                <div className="rounded-lg bg-gradient-to-r from-white/5 to-white/10 border border-white/20 overflow-hidden">
                                  <div className="p-1.5 flex items-center justify-between border-b border-white/10 bg-emerald-500/10">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-emerald-400 to-green-500 flex items-center justify-center text-[8px] font-bold text-white">2</div>
                                      <span className="text-[10px] font-semibold text-white">David91R</span>
                                    </div>
                                    <span className="text-[10px] font-bold text-emerald-400">165.60</span>
                                  </div>
                                  <div className="p-1.5 flex items-center justify-between">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-blue-400 to-cyan-500 flex items-center justify-center text-[8px] font-bold text-white">5</div>
                                      <span className="text-[10px] text-white/70">PensiveCat</span>
                                    </div>
                                    <span className="text-[10px] text-white/50">112.12</span>
                                  </div>
                                </div>
                              </div>
                              {/* Championship */}
                              <div className="w-1/5 py-14">
                                <div className="rounded-xl bg-gradient-to-br from-amber-500/20 via-yellow-500/10 to-amber-500/20 border-2 border-amber-400/50 overflow-hidden shadow-lg shadow-amber-500/20">
                                  <div className="text-center py-1.5 bg-gradient-to-r from-amber-500/30 to-yellow-500/30 border-b border-amber-400/30">
                                    <span className="text-base">üèÜ</span>
                                  </div>
                                  <div className="p-1.5 flex items-center justify-between border-b border-white/10">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center text-[8px] font-bold text-white">3</div>
                                      <span className="text-[10px] text-white/70">ADS78</span>
                                    </div>
                                    <span className="text-[10px] text-white/50">119.62</span>
                                  </div>
                                  <div className="p-1.5 flex items-center justify-between bg-gradient-to-r from-amber-500/20 to-yellow-500/20">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-emerald-400 to-green-500 flex items-center justify-center text-[8px] font-bold text-white">2</div>
                                      <span className="text-[10px] font-bold text-amber-300">David91R üëë</span>
                                    </div>
                                    <span className="text-[10px] font-bold text-amber-400">197.86</span>
                                  </div>
                                </div>
                              </div>
                              {/* 3rd Place */}
                              <div className="w-1/5 py-14">
                                <div className="rounded-lg bg-gradient-to-r from-white/5 to-white/10 border border-orange-400/30 overflow-hidden">
                                  <div className="text-center py-1 bg-orange-500/20 border-b border-orange-400/30">
                                    <span className="text-[10px] font-semibold text-orange-300">3RD</span>
                                  </div>
                                  <div className="p-1.5 flex items-center justify-between border-b border-white/10">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-cyan-400 to-blue-500 flex items-center justify-center text-[8px] font-bold text-white">1</div>
                                      <span className="text-[10px] text-white/70">TysonLeiss</span>
                                    </div>
                                    <span className="text-[10px] text-white/50">95.92</span>
                                  </div>
                                  <div className="p-1.5 flex items-center justify-between bg-orange-500/10">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-blue-400 to-cyan-500 flex items-center justify-center text-[8px] font-bold text-white">5</div>
                                      <span className="text-[10px] font-semibold text-white">PensiveCat ü•â</span>
                                    </div>
                                    <span className="text-[10px] font-bold text-orange-400">109.98</span>
                                  </div>
                                </div>
                              </div>
                              {/* 5th Place */}
                              <div className="w-1/5 py-14">
                                <div className="rounded-lg bg-gradient-to-r from-white/5 to-white/10 border border-gray-400/30 overflow-hidden">
                                  <div className="text-center py-1 bg-gray-500/20 border-b border-gray-400/30">
                                    <span className="text-[10px] font-semibold text-gray-300">5TH</span>
                                  </div>
                                  <div className="p-1.5 flex items-center justify-between border-b border-white/10 bg-gray-500/10">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-gray-400 to-slate-500 flex items-center justify-center text-[8px] font-bold text-white">6</div>
                                      <span className="text-[10px] font-semibold text-white">CrazyFisher</span>
                                    </div>
                                    <span className="text-[10px] font-bold text-gray-300">151.04</span>
                                  </div>
                                  <div className="p-1.5 flex items-center justify-between">
                                    <div className="flex items-center gap-1.5">
                                      <div className="w-4 h-4 rounded-full bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center text-[8px] font-bold text-white">4</div>
                                      <span className="text-[10px] text-white/70">TheCiege24</span>
                                    </div>
                                    <span className="text-[10px] text-white/50">129.16</span>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        )}
                      </div>
                      
                      {/* Footer with AF Branding */}
                      <div className="px-6 py-3 bg-gradient-to-r from-blue-900/50 to-cyan-900/50 border-t border-cyan-400/20 flex items-center justify-between">
                        <div className="flex items-center gap-2">
                          <div className="w-8 h-8 rounded bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center border border-cyan-400/30">
                            <span className="text-white font-bold text-xs">AF</span>
                          </div>
                          <span className="text-xs text-cyan-300/70">Powered by AllFantasy</span>
                        </div>
                        <span className="text-[10px] text-white/40">Live bracket updates coming soon</span>
                      </div>
                    </div>

                    {/* C2C League Preview - Hidden until demo mode with C2C selected */}
                    {false && (
                    <><h4 className="text-base sm:text-lg font-bold text-white mt-8 mb-3 sm:mb-4 flex items-center gap-2">
                      <span className="text-2xl">üéì</span> C2C League Preview: College to Career
                    </h4>
                    <p className="text-sm text-gray-400 mb-4">
                      See how your NFL dynasty (Sleeper) and CFB devy (Fantrax) leagues combine into one unified C2C experience.
                    </p>
                    
                    <div className="rounded-2xl border border-purple-400/30 bg-gradient-to-br from-slate-800/80 to-slate-900/80 overflow-hidden">
                      {/* C2C League Header */}
                      <div className="p-4 sm:p-6 border-b border-white/10 bg-gradient-to-r from-purple-500/15 via-cyan-500/10 to-emerald-500/15">
                        <div className="flex flex-col sm:flex-row sm:items-center gap-4">
                          <div className="flex items-center gap-4">
                            <div className="relative">
                              <div className="w-14 h-14 sm:w-16 sm:h-16 rounded-xl bg-gradient-to-br from-purple-500 via-cyan-500 to-emerald-500 flex items-center justify-center text-2xl sm:text-3xl shadow-lg">
                                üèà
                              </div>
                              <div className="absolute -bottom-1 -right-1 w-6 h-6 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center text-xs shadow-lg">
                                üéì
                              </div>
                            </div>
                            <div>
                              <h5 className="text-lg sm:text-xl font-bold text-white flex items-center gap-2">
                                Peach Bowl C2C
                                <span className="px-2 py-0.5 text-[10px] font-semibold rounded-full bg-gradient-to-r from-purple-500/30 to-cyan-500/30 text-purple-300 border border-purple-400/30">
                                  C2C
                                </span>
                              </h5>
                              <div className="flex flex-wrap items-center gap-1.5 sm:gap-2 text-xs text-gray-400 mt-1">
                                <span className="flex items-center gap-1 px-2 py-0.5 rounded-full bg-cyan-500/20 text-cyan-300 border border-cyan-400/20">
                                  <span className="w-2 h-2 rounded-full bg-cyan-400"></span>
                                  Peach Bowl (NFL)
                                </span>
                                <span className="text-white/30">+</span>
                                <span className="flex items-center gap-1 px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-300 border border-emerald-400/20">
                                  <span className="w-2 h-2 rounded-full bg-emerald-400"></span>
                                  Cream Bowl (CFB)
                                </span>
                              </div>
                            </div>
                          </div>
                          <div className="sm:ml-auto flex items-center gap-4">
                            <div className="text-center">
                              <div className="text-lg font-bold text-purple-400">12</div>
                              <div className="text-[10px] text-gray-400">Teams</div>
                            </div>
                            <div className="text-center">
                              <div className="text-lg font-bold text-cyan-400">Dynasty</div>
                              <div className="text-[10px] text-gray-400">Format</div>
                            </div>
                            <div className="text-center">
                              <div className="text-lg font-bold text-emerald-400">SF</div>
                              <div className="text-[10px] text-gray-400">Superflex</div>
                            </div>
                          </div>
                        </div>
                      </div>

                      {/* Scrollable Roster Section */}
                      <div className="p-4 sm:p-6">
                        <div className="flex items-center justify-between mb-4">
                          <h6 className="text-sm font-semibold text-white flex items-center gap-2">
                            <span className="text-base">üë§</span> Your Roster
                          </h6>
                          <span className="text-[10px] text-gray-400">Scroll to see all ‚Üí</span>
                        </div>
                        
                        {/* Scrollable Container */}
                        <div className="max-h-[500px] overflow-y-auto pr-2 space-y-4 scrollbar-thin scrollbar-thumb-white/20 scrollbar-track-transparent">
                          
                          {/* NFL Starters */}
                          <div className="p-4 rounded-xl bg-gradient-to-r from-cyan-500/10 to-cyan-500/5 border border-cyan-400/20">
                            <div className="flex items-center gap-2 mb-3">
                              <span className="text-base">üèà</span>
                              <span className="text-xs font-semibold text-cyan-400 uppercase tracking-wide">NFL Starters</span>
                              <span className="ml-auto text-[10px] text-cyan-300/70 bg-cyan-500/20 px-2 py-0.5 rounded-full">10 spots</span>
                            </div>
                            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-2">
                              {[
                                { pos: 'QB', name: 'Josh Allen', team: 'BUF', value: 9850 },
                                { pos: 'RB', name: 'Breece Hall', team: 'NYJ', value: 7200 },
                                { pos: 'RB', name: 'Bijan Robinson', team: 'ATL', value: 8100 },
                                { pos: 'WR', name: 'Ja\'Marr Chase', team: 'CIN', value: 9200 },
                                { pos: 'WR', name: 'Amon-Ra St. Brown', team: 'DET', value: 7800 },
                                { pos: 'WR', name: 'CeeDee Lamb', team: 'DAL', value: 8500 },
                                { pos: 'TE', name: 'Sam LaPorta', team: 'DET', value: 5200 },
                                { pos: 'FLEX', name: 'De\'Von Achane', team: 'MIA', value: 6800 },
                                { pos: 'SF', name: 'Lamar Jackson', team: 'BAL', value: 8900 },
                                { pos: 'K', name: 'Justin Tucker', team: 'BAL', value: 200 },
                              ].map((player, idx) => (
                                <div key={idx} className="p-2 rounded-lg bg-black/40 border border-white/10 hover:border-cyan-400/40 transition group">
                                  <div className="flex items-center justify-between mb-1">
                                    <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded ${
                                      player.pos === 'QB' || player.pos === 'SF' ? 'bg-red-500/30 text-red-300' :
                                      player.pos === 'RB' || player.pos === 'FLEX' ? 'bg-green-500/30 text-green-300' :
                                      player.pos === 'WR' ? 'bg-blue-500/30 text-blue-300' :
                                      player.pos === 'TE' ? 'bg-orange-500/30 text-orange-300' :
                                      'bg-gray-500/30 text-gray-300'
                                    }`}>{player.pos}</span>
                                    <span className="text-[9px] text-gray-500">{player.team}</span>
                                  </div>
                                  <div className="flex items-center gap-1.5">
                                    <MiniPlayerImg name={player.name} size={16} />
                                    <div className="text-xs font-semibold text-white truncate group-hover:text-cyan-300 transition">{player.name}</div>
                                  </div>
                                  <div className="text-[10px] text-emerald-400 mt-0.5">FC: {player.value.toLocaleString()}</div>
                                </div>
                              ))}
                            </div>
                          </div>

                          {/* NFL Bench */}
                          <div className="p-4 rounded-xl bg-gradient-to-r from-slate-500/10 to-slate-500/5 border border-white/10">
                            <div className="flex items-center gap-2 mb-3">
                              <span className="text-base">üìã</span>
                              <span className="text-xs font-semibold text-gray-300 uppercase tracking-wide">NFL Bench</span>
                              <span className="ml-auto text-[10px] text-gray-400 bg-white/10 px-2 py-0.5 rounded-full">15 spots</span>
                            </div>
                            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-2">
                              {[
                                { pos: 'QB', name: 'Anthony Richardson', team: 'IND', value: 4800 },
                                { pos: 'RB', name: 'Jahmyr Gibbs', team: 'DET', value: 7500 },
                                { pos: 'RB', name: 'Kenneth Walker', team: 'SEA', value: 5100 },
                                { pos: 'WR', name: 'Chris Olave', team: 'NO', value: 5800 },
                                { pos: 'WR', name: 'Drake London', team: 'ATL', value: 5400 },
                                { pos: 'WR', name: 'Jaylen Waddle', team: 'MIA', value: 6200 },
                                { pos: 'TE', name: 'Dalton Kincaid', team: 'BUF', value: 4100 },
                                { pos: 'RB', name: 'Zach Charbonnet', team: 'SEA', value: 3200 },
                              ].map((player, idx) => (
                                <div key={idx} className="p-2 rounded-lg bg-black/30 border border-white/5 hover:border-white/20 transition">
                                  <div className="flex items-center justify-between mb-1">
                                    <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded ${
                                      player.pos === 'QB' ? 'bg-red-500/20 text-red-300/80' :
                                      player.pos === 'RB' ? 'bg-green-500/20 text-green-300/80' :
                                      player.pos === 'WR' ? 'bg-blue-500/20 text-blue-300/80' :
                                      'bg-orange-500/20 text-orange-300/80'
                                    }`}>{player.pos}</span>
                                    <span className="text-[9px] text-gray-500">{player.team}</span>
                                  </div>
                                  <div className="flex items-center gap-1.5">
                                    <MiniPlayerImg name={player.name} size={16} />
                                    <div className="text-xs font-medium text-white/80 truncate">{player.name}</div>
                                  </div>
                                  <div className="text-[10px] text-emerald-400/70 mt-0.5">FC: {player.value.toLocaleString()}</div>
                                </div>
                              ))}
                            </div>
                          </div>

                          {/* Taxi Squad */}
                          <div className="p-4 rounded-xl bg-gradient-to-r from-yellow-500/10 to-amber-500/5 border border-yellow-400/20">
                            <div className="flex items-center gap-2 mb-3">
                              <span className="text-base">üöï</span>
                              <span className="text-xs font-semibold text-yellow-400 uppercase tracking-wide">Taxi Squad</span>
                              <span className="ml-auto text-[10px] text-yellow-300/70 bg-yellow-500/20 px-2 py-0.5 rounded-full">5 spots</span>
                            </div>
                            <p className="text-[10px] text-gray-400 mb-3">Rookie NFL players (1st-2nd year) developing on your practice squad</p>
                            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-2">
                              {[
                                { pos: 'QB', name: 'Caleb Williams', team: 'CHI', value: 7200, rookie: '2024' },
                                { pos: 'WR', name: 'Marvin Harrison Jr', team: 'ARI', value: 7800, rookie: '2024' },
                                { pos: 'WR', name: 'Malik Nabers', team: 'NYG', value: 6500, rookie: '2024' },
                                { pos: 'RB', name: 'Jonathon Brooks', team: 'CAR', value: 4200, rookie: '2024' },
                                { pos: 'TE', name: 'Brock Bowers', team: 'LV', value: 5800, rookie: '2024' },
                              ].map((player, idx) => (
                                <div key={idx} className="p-2 rounded-lg bg-black/40 border border-yellow-400/20 hover:border-yellow-400/40 transition group">
                                  <div className="flex items-center justify-between mb-1">
                                    <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded ${
                                      player.pos === 'QB' ? 'bg-red-500/30 text-red-300' :
                                      player.pos === 'RB' ? 'bg-green-500/30 text-green-300' :
                                      player.pos === 'WR' ? 'bg-blue-500/30 text-blue-300' :
                                      'bg-orange-500/30 text-orange-300'
                                    }`}>{player.pos}</span>
                                    <span className="text-[9px] text-yellow-400/70 bg-yellow-500/20 px-1 rounded">{player.rookie}</span>
                                  </div>
                                  <div className="flex items-center gap-1.5">
                                    <MiniPlayerImg name={player.name} size={16} />
                                    <div className="text-xs font-semibold text-white truncate group-hover:text-yellow-300 transition">{player.name}</div>
                                  </div>
                                  <div className="flex items-center justify-between mt-0.5">
                                    <span className="text-[9px] text-gray-500">{player.team}</span>
                                    <span className="text-[10px] text-emerald-400">FC: {player.value.toLocaleString()}</span>
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>

                          {/* Devy Roster - CFB Players (from CFBD API) */}
                          <div className="p-4 rounded-xl bg-gradient-to-r from-purple-500/10 via-pink-500/5 to-emerald-500/10 border border-purple-400/20">
                            <div className="flex items-center gap-2 mb-3">
                              <span className="text-base">üéì</span>
                              <span className="text-xs font-semibold text-purple-400 uppercase tracking-wide">Devy Roster (CFB)</span>
                              <span className="ml-auto flex items-center gap-2">
                                {c2cDevyLoading && (
                                  <span className="text-[9px] text-cyan-300 animate-pulse">Loading from CFBD...</span>
                                )}
                                <span className="text-[10px] text-purple-300/70 bg-purple-500/20 px-2 py-0.5 rounded-full">
                                  {c2cDevyLeague?.name || 'From Cream Bowl'}
                                </span>
                              </span>
                            </div>
                            <p className="text-[10px] text-gray-400 mb-3">
                              {c2cDevyRoster.length > 0 
                                ? `${c2cDevyRoster.length} CFB players with devy values from CollegeFootballData.com` 
                                : 'College football players linked from your Fantrax devy league'}
                            </p>
                            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
                              {(c2cDevyRoster.length > 0 ? c2cDevyRoster.slice(0, 8).map(p => ({
                                pos: p.position,
                                name: p.name,
                                school: p.team,
                                class: p.classYear,
                                value: p.devyValue,
                              })) : [
                                { pos: 'QB', name: 'Carson Beck', school: 'Georgia', class: 'SR', value: 4500 },
                                { pos: 'RB', name: 'Ollie Gordon II', school: 'Oklahoma St', class: 'JR', value: 3800 },
                                { pos: 'WR', name: 'Tetairoa McMillan', school: 'Arizona', class: 'JR', value: 5200 },
                                { pos: 'WR', name: 'Luther Burden III', school: 'Missouri', class: 'JR', value: 4800 },
                                { pos: 'TE', name: 'Tyler Warren', school: 'Penn State', class: 'SR', value: 3200 },
                                { pos: 'QB', name: 'Quinn Ewers', school: 'Texas', class: 'JR', value: 3500 },
                                { pos: 'RB', name: 'Quinshon Judkins', school: 'Ohio State', class: 'JR', value: 4100 },
                                { pos: 'WR', name: 'Evan Stewart', school: 'Oregon', class: 'JR', value: 3600 },
                              ]).map((player, idx) => (
                                <div key={idx} className="p-2.5 rounded-lg bg-gradient-to-br from-purple-900/30 to-black/40 border border-purple-400/20 hover:border-purple-400/40 transition group">
                                  <div className="flex items-center justify-between mb-1.5">
                                    <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded ${
                                      player.pos === 'QB' ? 'bg-red-500/30 text-red-300' :
                                      player.pos === 'RB' ? 'bg-green-500/30 text-green-300' :
                                      player.pos === 'WR' ? 'bg-blue-500/30 text-blue-300' :
                                      'bg-orange-500/30 text-orange-300'
                                    }`}>{player.pos}</span>
                                    <span className="text-[9px] text-purple-300/70 bg-purple-500/20 px-1.5 rounded">{player.class}</span>
                                  </div>
                                  <div className="flex items-center gap-1.5">
                                    <MiniPlayerImg name={player.name} size={16} />
                                    <div className="text-xs font-semibold text-white truncate group-hover:text-purple-300 transition">{player.name}</div>
                                  </div>
                                  <div className="text-[10px] text-gray-400 truncate mt-0.5">üìç {player.school}</div>
                                  <div className="flex items-center justify-between mt-1 pt-1 border-t border-white/5">
                                    <span className="text-[9px] text-gray-500">Devy Value</span>
                                    <span className="text-[10px] text-emerald-400 font-medium">{player.value.toLocaleString()}</span>
                                  </div>
                                </div>
                              ))}
                            </div>
                            {c2cDevyRoster.length === 0 && !c2cDevyLoading && fantraxUsername && (
                              <p className="text-[10px] text-center text-purple-300/50 mt-3 italic">
                                Import a devy league from Fantrax to see your real roster with CFBD valuations
                              </p>
                            )}
                          </div>

                          {/* Draft Capital */}
                          <div className="p-4 rounded-xl bg-gradient-to-r from-indigo-500/10 to-blue-500/5 border border-indigo-400/20">
                            <div className="flex items-center gap-2 mb-3">
                              <span className="text-base">üéØ</span>
                              <span className="text-xs font-semibold text-indigo-400 uppercase tracking-wide">Draft Capital</span>
                            </div>
                            <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
                              {[
                                { year: '2025', picks: ['1.03', '2.03', '3.03', '4.03'] },
                                { year: '2026', picks: ['1.05', '2.03', '2.08', '3.03'] },
                                { year: '2027', picks: ['1.03', '2.03', '3.03'] },
                              ].map((year, idx) => (
                                <div key={idx} className="p-3 rounded-lg bg-black/30 border border-white/10">
                                  <div className="text-sm font-bold text-indigo-400 mb-2">{year.year}</div>
                                  <div className="flex flex-wrap gap-1.5">
                                    {year.picks.map((pick, pidx) => (
                                      <span key={pidx} className={`px-2 py-1 rounded text-[11px] font-semibold ${
                                        pick.startsWith('1.') ? 'bg-amber-500/20 text-amber-300 border border-amber-400/30' :
                                        pick.startsWith('2.') ? 'bg-gray-400/20 text-gray-300 border border-gray-400/30' :
                                        'bg-orange-500/20 text-orange-300 border border-orange-400/30'
                                      }`}>
                                        {pick}
                                      </span>
                                    ))}
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>
                          
                        </div>
                      </div>
                      
                      {/* C2C Footer */}
                      <div className="p-4 border-t border-white/10 bg-gradient-to-r from-purple-500/5 via-transparent to-emerald-500/5">
                        <div className="flex flex-wrap items-center justify-between gap-3">
                          <div className="flex items-center gap-3">
                            <div className="flex -space-x-2">
                              <div className="w-8 h-8 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-xs font-bold text-white border-2 border-slate-800" title="Sleeper">S</div>
                              <div className="w-8 h-8 rounded-full bg-gradient-to-br from-emerald-500 to-green-600 flex items-center justify-center text-xs font-bold text-white border-2 border-slate-800" title="Fantrax">F</div>
                            </div>
                            <div className="text-xs text-gray-400">
                              <span className="text-white font-medium">2 platforms</span> linked
                            </div>
                          </div>
                          <div className="flex items-center gap-2 text-xs">
                            <span className="text-gray-400">Total Roster Value:</span>
                            <span className="text-lg font-bold text-emerald-400">142,850</span>
                            <span className="text-[10px] text-gray-500">FC</span>
                          </div>
                        </div>
                      </div>
                    </div></>
                    )}

                    {/* CTA */}
                    <div className="mt-6 sm:mt-8 p-4 sm:p-6 rounded-xl bg-gradient-to-r from-cyan-500/10 to-purple-500/10 border border-cyan-400/20 text-center">
                      <h5 className="text-base sm:text-lg font-bold text-white mb-2">Ready to Transfer?</h5>
                      <p className="text-xs sm:text-sm text-gray-400 mb-4">Enter your Sleeper League ID above to preview what will be migrated to AllFantasy.</p>
                      {!transferPreview && (
                        <button
                          onClick={() => {
                            const input = document.querySelector('input[placeholder="Enter your Sleeper League ID"]') as HTMLInputElement
                            if (input) input.focus()
                          }}
                          className="w-full sm:w-auto px-6 py-3 bg-gradient-to-r from-cyan-500 to-purple-500 hover:from-cyan-400 hover:to-purple-400 text-white font-semibold rounded-xl transition min-h-[48px]"
                        >
                          Enter League ID
                        </button>
                      )}
                    </div>
                  </div>
                  </>
                )}

                {activeTab === 'strategy' && (
                  <>
                  <HeroMetric 
                    value="AI"
                    label="Season Strategy Planner"
                    helper="AI-powered roadmap for your fantasy season"
                    accent="purple"
                  />
                  <p className="text-center text-sm sm:text-base text-white/60 mb-4">Get a personalized strategy based on your roster, standings, and draft capital.</p>
                  <div className="bg-black/30 border border-purple-500/20 rounded-2xl p-4 sm:p-6">
                    <StrategyPlanner
                      leagues={leagues.filter(l => l.season === Math.max(...leagues.map(lg => lg.season)))}
                      sleeperUsername={username}
                    />
                  </div>
                  </>
                )}

                {activeTab === 'shop' && (
                  <>
                  <HeroMetric 
                    value="10"
                    label="Official AllFantasy Merch"
                    helper="Rep the brand with AF gear"
                    accent="cyan"
                  />
                  <p className="text-center text-sm sm:text-base text-white/60 mb-4">Gear up with official AllFantasy merchandise. T-shirts, hoodies, hats, and more.</p>
                  <div className="bg-black/30 border border-white/10 rounded-2xl p-4 sm:p-6">
                    <EtsyShop />
                  </div>
                  </>
                )}
                </div>
              </>
            )
          })()}
      </div>

      {/* Floating Buttons */}
      <div className="fixed bottom-20 sm:bottom-6 right-4 sm:right-6 z-40 flex flex-col gap-3">
        <button
          onClick={() => setShowTutorial(true)}
          className="flex h-12 w-12 items-center justify-center rounded-full bg-white/10 border border-white/20 backdrop-blur-sm text-white/70 hover:text-white hover:bg-white/20 shadow-lg transition-all hover:scale-105"
          title="Show Tutorial"
        >
          <HelpCircle className="h-5 w-5" />
        </button>
        <button
          onClick={() => setFeedbackOpen(true)}
          className="flex items-center gap-2 rounded-full bg-gradient-to-r from-cyan-500 to-purple-600 px-4 py-3 font-medium text-white shadow-lg shadow-cyan-500/20 hover:shadow-xl hover:shadow-cyan-500/30 transition-all hover:scale-105"
        >
          <MessageSquareText className="h-5 w-5" />
          <span className="hidden sm:inline">Feedback</span>
        </button>
      </div>

      {/* Tutorial Modal */}
      {showTutorial && (
        <LegacyTutorial 
          onClose={() => setShowTutorial(false)} 
          onChangeTab={(tab) => handleActiveTabChange(tab)}
        />
      )}

      {/* Feedback Modal */}
      <FeedbackModal
        isOpen={feedbackOpen}
        onClose={() => setFeedbackOpen(false)}
        sleeperUsername={username}
        userId={profile?.sleeper_user_id}
        defaultTool={
          activeTab === 'overview' ? 'Career Stats / History' :
          activeTab === 'trade' ? 'AI Trade Hub' :
          activeTab === 'finder' ? 'Trade Finder' :
          activeTab === 'player-finder' ? 'Player Finder' :
          activeTab === 'waiver' ? 'Waiver AI' :
          activeTab === 'rankings' ? 'League Rankings' :
          activeTab === 'pulse' ? 'Social Pulse' :
          activeTab === 'compare' ? 'Rankings / Percentiles' :
          activeTab === 'chat' ? 'AI Chat' :
          activeTab === 'share' ? 'Share / Social Cards' :
          activeTab === 'transfer' ? 'League Transfer' :
          activeTab === 'strategy' ? 'Season Strategy' :
          activeTab === 'shop' ? 'AF Merch Shop' :
          undefined
        }
      />
      {guardianVisible && guardianEval && (
        <DecisionGuardianModal
          evaluation={guardianEval}
          interventionId={guardianInterventionId}
          actionType={guardianActionType}
          guardianPayload={guardianPayload}
          onProceed={() => {
            closeGuardian(true)
            setGuardianEval(null)
          }}
          onCancel={() => {
            closeGuardian(false)
            setGuardianEval(null)
          }}
          onClose={() => {
            closeGuardian(false)
            setGuardianEval(null)
          }}
        />
      )}

      {importStatus === 'complete' && (
        <BottomTabBar
          activeTab={mobileMainTab}
          onChange={handleMobileTabChange}
          alertCount={0}
        />
      )}

      {trustSheetData && (
        <TrustExplanationSheet
          data={trustSheetData}
          open={trustSheetOpen}
          onClose={() => setTrustSheetOpen(false)}
        />
      )}

      {toast && (
        <div className="fixed bottom-6 right-6 z-50 rounded-xl bg-emerald-500/90 px-4 py-3 text-sm text-white shadow-lg transition-all duration-500">
          {toast}
        </div>
      )}
    </main>
  )
}

export default function AFLegacyPage() {
  return (
    <Suspense fallback={<div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900/20 to-slate-900 flex items-center justify-center"><div className="text-white">Loading...</div></div>}>
      <AFLegacyContent />
    </Suspense>
  )
}
