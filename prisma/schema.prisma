generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model EarlyAccessSignup {
  id          String    @id @default(cuid())
  email       String    @unique
  name        String?
  createdAt   DateTime  @default(now())
  confirmedAt DateTime?
  source      String?   @default("allfantasy.ai")
  referrer    String?
  utmCampaign String?
  utmContent  String?
  utmMedium   String?
  utmSource   String?
  utmTerm     String?

  @@index([createdAt])
  @@index([confirmedAt])
  @@index([source])
  @@index([utmSource])
}

model VisitorLocation {
  id          String   @id @default(cuid())
  ipAddress   String   @unique
  city        String?
  region      String?
  country     String?
  countryCode String?
  lat         Float?
  lng         Float?
  visits      Int      @default(1)
  firstSeen   DateTime @default(now())
  lastSeen    DateTime @default(now())

  @@index([country])
  @@index([lastSeen])
}

model QuestionnaireResponse {
  id                   String   @id @default(uuid())
  email                String
  favoriteSport        String
  favoriteLeagueType   String
  competitiveness      String
  draftPreference      String
  painPoint            String
  experimentalInterest String[]
  freeText             String?
  createdAt            DateTime @default(now())

  @@index([email])
}

model SportsDataCache {
  id         String   @id @default(uuid())
  sport      String
  dataType   String
  identifier String
  data       Json
  source     String
  fetchedAt  DateTime @default(now())
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([sport, dataType, identifier])
  @@index([sport, dataType])
  @@index([expiresAt])
}

model SportsTeam {
  id           String   @id @default(uuid())
  sport        String
  externalId   String
  name         String
  shortName    String?
  city         String?
  conference   String?
  division     String?
  logo         String?
  primaryColor String?
  source       String
  fetchedAt    DateTime @default(now())
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([sport, externalId, source])
  @@index([sport])
}

model SportsPlayer {
  id         String   @id @default(uuid())
  sport      String
  externalId String
  name       String
  position   String?
  team       String?
  teamId     String?
  number     Int?
  age        Int?
  height     String?
  weight     String?
  college    String?
  imageUrl   String?
  sleeperId  String?
  dob        String?
  status     String?
  source     String
  fetchedAt  DateTime @default(now())
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([sport, externalId, source])
  @@index([sport, team])
  @@index([sleeperId])
  @@index([name])
}

model PlayerIdentityMap {
  id                 String   @id @default(uuid())
  canonicalName      String
  normalizedName     String
  position           String?
  currentTeam        String?
  dob                String?
  sleeperId          String?  @unique
  fantasyCalcId      String?
  rollingInsightsId  String?
  apiSportsId        String?
  mflId              String?
  sport              String   @default("NFL")
  status             String?
  lastSyncedAt       DateTime @default(now())
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([normalizedName])
  @@index([fantasyCalcId])
  @@index([rollingInsightsId])
  @@index([apiSportsId])
  @@index([currentTeam])
  @@index([sport, position])
}

model PlayerTeamHistory {
  id        String   @id @default(uuid())
  playerId  String
  sport     String   @default("nfl")
  season    Int
  week      Int      @default(0)
  teamAbbr  String
  source    String   @default("sleeper")
  createdAt DateTime @default(now())

  @@unique([playerId, sport, season, week])
  @@index([playerId, sport, season])
  @@index([teamAbbr, sport, season])
  @@map("player_team_history")
}

model SportsGame {
  id         String    @id @default(uuid())
  sport      String
  externalId String
  homeTeam   String
  homeTeamId String?
  awayTeam   String
  awayTeamId String?
  homeScore  Int?
  awayScore  Int?
  status     String?
  startTime  DateTime?
  venue      String?
  week       Int?
  season     Int?
  source     String
  fetchedAt  DateTime  @default(now())
  expiresAt  DateTime
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@unique([sport, externalId, source])
  @@index([sport, startTime])
  @@index([sport, season, week])
}

model SportsInjury {
  id           String    @id @default(uuid())
  sport        String
  externalId   String
  playerName   String
  playerId     String?
  team         String?
  teamId       String?
  position     String?
  type         String?
  status       String?
  description  String?
  date         DateTime?
  season       Int?
  week         Int?
  source       String
  fetchedAt    DateTime  @default(now())
  expiresAt    DateTime
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([sport, externalId, source])
  @@index([sport, team])
  @@index([playerName])
  @@index([playerId])
  @@index([sport, season, week])
}

model SportsNews {
  id           String    @id @default(uuid())
  sport        String
  externalId   String
  title        String
  content      String?
  source       String
  sourceUrl    String?
  playerName   String?
  playerId     String?
  team         String?
  category     String?
  publishedAt  DateTime?
  fetchedAt    DateTime  @default(now())
  expiresAt    DateTime
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([sport, externalId, source])
  @@index([sport, publishedAt])
  @@index([playerName])
  @@index([team])
}

model LegacyUser {
  id              String               @id @default(uuid())
  sleeperUsername String               @unique
  sleeperUserId   String               @unique
  displayName     String?
  avatar          String?
  avatarUrl       String?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  aiReports       LegacyAIReport[]
  importJobs      LegacyImportJob[]
  leagues         LegacyLeague[]
  rankCache       LegacyUserRankCache?
  userEvents      UserEvent[]
  appUser         AppUser?

  @@index([sleeperUsername])
}

model UserEvent {
  id        String   @id @default(uuid())
  userId    String
  eventType String
  metadata  Json?
  createdAt DateTime @default(now())
  user      LegacyUser @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
  @@index([userId, eventType])
}

model LegacyUserRankCache {
  legacyUserId                  String     @id @map("legacy_user_id")
  careerXp                      BigInt     @default(0) @map("career_xp")
  careerLevel                   Int        @default(0) @map("career_level")
  careerTier                    Int        @default(1) @map("career_tier")
  careerTierName                String     @default("Practice Squad") @map("career_tier_name")
  baselineYearXp                BigInt     @default(0) @map("baseline_year_xp")
  aiLowYearXp                   BigInt     @default(0) @map("ai_low_year_xp")
  aiMidYearXp                   BigInt     @default(0) @map("ai_mid_year_xp")
  aiHighYearXp                  BigInt     @default(0) @map("ai_high_year_xp")
  assumptionsJson               Json       @default("{}") @map("assumptions_json")
  lastCalculatedAt              DateTime   @default(now()) @map("last_calculated_at")
  lastRefreshAt                 DateTime?  @map("last_refresh_at")
  computedFromImportCompletedAt DateTime?  @map("computed_from_import_completed_at")
  user                          LegacyUser @relation(fields: [legacyUserId], references: [id], onDelete: Cascade)

  @@index([lastCalculatedAt], map: "legacy_user_rank_cache_last_calculated_idx")
  @@index([lastRefreshAt], map: "legacy_user_rank_cache_last_refresh_idx")
  @@map("legacy_user_rank_cache")
}

model LegacyImportJob {
  id            String     @id @default(uuid())
  userId        String
  status        String     @default("queued")
  progress      Int        @default(0)
  currentSeason Int?
  emptyYears    Int        @default(0)
  error         String?
  startedAt     DateTime?
  completedAt   DateTime?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  user          LegacyUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
}

model LegacyLeague {
  id              String               @id @default(uuid())
  userId          String
  sleeperLeagueId String
  name            String
  season          Int
  sport           String               @default("nfl")
  leagueType      String?
  scoringType     String?
  teamCount       Int?
  status          String?
  draftId         String?
  winnerRosterId  Int?
  playoffTeams    Int?
  avatar          String?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  specialtyFormat String?
  isSF            Boolean              @default(false)
  isTEP           Boolean              @default(false)
  tepBonus        Float?
  user            LegacyUser           @relation(fields: [userId], references: [id], onDelete: Cascade)
  rosters         LegacyRoster[]
  seasonSummary   LegacySeasonSummary?

  @@unique([userId, sleeperLeagueId])
  @@index([userId, season])
}

model LegacyRoster {
  id            String       @id @default(uuid())
  leagueId      String
  rosterId      Int          @default(0)
  ownerId       String?
  ownerName     String?
  isOwner       Boolean      @default(false)
  wins          Int          @default(0)
  losses        Int          @default(0)
  ties          Int          @default(0)
  pointsFor     Float        @default(0)
  pointsAgainst Float        @default(0)
  rank          Int?
  playoffSeed   Int?
  finalStanding Int?
  isChampion    Boolean      @default(false)
  players       Json?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  league        LegacyLeague @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  @@unique([leagueId, rosterId])
  @@index([leagueId])
}

model LegacySeasonSummary {
  id                String       @id @default(uuid())
  leagueId          String       @unique
  season            Int          @default(0)
  champion          Boolean      @default(false)
  wins              Int          @default(0)
  losses            Int          @default(0)
  pointsFor         Float        @default(0)
  finalRank         Int?
  championUserId    String?
  championName      String?
  regularSeasonMVP  String?
  highestScorer     String?
  highestScore      Float?
  averageScore      Float?
  totalTrades       Int          @default(0)
  totalTransactions Int          @default(0)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  league            LegacyLeague @relation(fields: [leagueId], references: [id], onDelete: Cascade)
}

model LegacyAIReport {
  id         String     @id @default(uuid())
  userId     String
  reportType String
  rating     Int?
  title      String?
  summary    String?
  insights   Json?
  shareText  String?
  createdAt  DateTime   @default(now())
  user       LegacyUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, reportType])
}

model AnalyticsEvent {
  id        String   @id @default(uuid())
  event     String
  path      String?
  referrer  String?
  userAgent String?
  sessionId String?
  userId    String?
  emailHash String?
  toolKey   String?
  meta      Json?
  createdAt DateTime @default(now())

  @@index([sessionId])
  @@index([userId])
  @@index([emailHash])
  @@index([toolKey])
  @@index([event, createdAt])
  @@index([path, createdAt])
}

model TradeNotification {
  id               String    @id @default(uuid())
  userId           String
  leagueId         String
  sleeperLeagueId  String
  transactionId    String    @unique
  status           String    @default("pending")
  type             String    @default("trade")
  senderRosterId   Int
  senderName       String?
  receiverRosterId Int
  receiverName     String?
  playersGiven     Json      @default("[]")
  playersReceived  Json      @default("[]")
  picksGiven       Json      @default("[]")
  picksReceived    Json      @default("[]")
  aiGrade          String?
  aiVerdict        String?
  aiAnalysis       Json?
  aiAnalyzedAt     DateTime?
  sleeperCreatedAt DateTime?
  seenAt           DateTime?
  emailSentAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([userId, status])
  @@index([userId, seenAt])
  @@index([leagueId])
}

model EmailPreference {
  id              String    @id @default(uuid())
  email           String    @unique
  legacyUserId    String?
  sleeperUsername String?
  tradeAlerts     Boolean   @default(true)
  weeklyDigest    Boolean   @default(false)
  productUpdates  Boolean   @default(true)
  verified        Boolean   @default(false)
  verifiedAt      DateTime?
  unsubscribedAt  DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([legacyUserId])
  @@index([sleeperUsername])
}

model AIUserProfile {
  id                      String   @id @default(uuid())
  userId                  String   @unique
  sleeperUsername         String?
  toneMode                String   @default("professional")
  detailLevel             String   @default("concise")
  riskMode                String   @default("conservative")
  humorLevel              String   @default("medium")
  strategyBias            Json     @default("{\"qb_priority\": 0.5, \"rb_aversion\": 0.3, \"prefers_picks\": 0.5, \"prefers_youth\": 0.5}")
  behaviorMetrics         Json     @default("{\"draft_reach_tendency\": null, \"trade_rate_percentile\": null, \"waiver_rate_percentile\": null}")
  personalizeEnabled      Boolean  @default(true)
  tradePreferenceProfile  String?  @db.Text
  tradeProfileUpdatedAt   DateTime?
  tradeProfileVoteCount   Int      @default(0)
  tradeProfileVersion     Int      @default(1)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@index([sleeperUsername])
}

model TradeSuggestionVote {
  id               String          @id @default(cuid())
  userId           String
  tradeText        String          @db.Text
  suggestionTitle  String
  suggestionText   String?         @db.Text
  vote             String
  reason           String?
  feedbackReason   FeedbackReason?
  leagueSize       Int?
  isDynasty        Boolean?
  scoring          String?
  userRoster       String?         @db.Text
  userContention   String?
  createdAt        DateTime        @default(now())

  @@index([userId])
  @@index([userId, createdAt])
  @@index([vote])
  @@map("trade_suggestion_votes")
}

enum FeedbackReason {
  OVERVALUED
  TOO_RISKY
  NOT_MY_STYLE
  BAD_ROSTER_FIT
  OTHER
}

model AILeagueContext {
  id              String   @id @default(uuid())
  leagueId        String   @unique
  sport           String   @default("NFL")
  format          String   @default("dynasty")
  sfEnabled       Boolean  @default(false)
  tepPremium      Boolean  @default(false)
  scoringSettings Json?
  rosterSettings  Json?
  phase           String   @default("offseason")
  marketBaselines Json     @default("{\"qb_price_index\": 1.0, \"rb_price_index\": 1.0, \"pick_liquidity_index\": 1.0}")
  lastComputedAt  DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([sport])
  @@index([phase])
}

model AITeamStateSnapshot {
  id                String   @id @default(uuid())
  leagueId          String
  teamId            String
  sleeperUsername   String?
  computedAt        DateTime @default(now())
  windowStatus      String   @default("middle")
  winNowScore       Int      @default(50)
  futureValueScore  Int      @default(50)
  qbStabilityScore  Int      @default(50)
  rbDependencyScore Int      @default(50)
  pickInventory     Json     @default("{}")
  notes             String?
  createdAt         DateTime @default(now())

  @@index([leagueId, teamId])
  @@index([sleeperUsername])
  @@index([computedAt])
}

model AIMemoryEvent {
  id         String    @id @default(uuid())
  userId     String?
  leagueId   String?
  teamId     String?
  eventType  String
  subject    String
  content    Json
  confidence Float     @default(0.7)
  expiresAt  DateTime?
  createdAt  DateTime  @default(now())

  @@index([userId])
  @@index([leagueId])
  @@index([eventType])
  @@index([expiresAt])
}

model AIUserFeedback {
  id            String   @id @default(uuid())
  userId        String
  leagueId      String?
  actionType    String
  referenceId   String?
  referenceType String?
  result        Json?
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([leagueId])
  @@index([actionType])
}

model TradeFeedback {
  id              String   @id @default(cuid())
  sleeperUsername String
  leagueId        String
  leagueName      String?
  targetManager   String
  youGive         String[]
  youReceive      String[]
  aiGrade         String?
  rating          Int
  createdAt       DateTime @default(now())

  @@index([sleeperUsername])
  @@index([leagueId])
  @@index([rating])
  @@index([createdAt])
}

model TradePreferences {
  id                   String   @id @default(cuid())
  sleeperUsername      String   @unique
  youthVsProduction    Float    @default(0)
  consolidationVsDepth Float    @default(0)
  picksVsPlayers       Float    @default(0)
  riskTolerance        Float    @default(0)
  qbPriority           Float    @default(0)
  tePriority           Float    @default(0)
  quizCompleted        Boolean  @default(false)
  quizResponses        Json?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([sleeperUsername])
}

model LeagueTradeHistory {
  id               String        @id @default(cuid())
  sleeperLeagueId  String
  sleeperUsername  String
  status           String        @default("pending")
  tradesLoaded     Int           @default(0)
  totalTradesFound Int           @default(0)
  lastWeekFetched  Int           @default(0)
  tradingStyle     Json?
  favoriteTargets  Json?
  avoidedAssets    Json?
  tradeFrequency   String?
  notifiedComplete Boolean       @default(false)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  trades           LeagueTrade[]

  @@unique([sleeperLeagueId, sleeperUsername])
  @@index([sleeperUsername])
  @@index([status])
}

model LeagueTrade {
  id                String             @id @default(cuid())
  historyId         String
  transactionId     String
  week              Int
  season            Int
  playersGiven      Json               @default("[]")
  picksGiven        Json               @default("[]")
  playersReceived   Json               @default("[]")
  picksReceived     Json               @default("[]")
  partnerRosterId   Int?
  partnerName       String?
  valueGiven        Float?
  valueReceived     Float?
  tradeDate         DateTime?
  createdAt         DateTime           @default(now())
  analysisResult    Json?
  analyzed          Boolean            @default(false)
  isSuperFlex       Boolean?
  leagueFormat      String?
  scoringType       String?
  valueDifferential Float?
  dynastyTierScore  Float?
  performanceData   Json?
  platform          String             @default("sleeper")
  playerAgeData     Json?
  sport             String             @default("nfl")
  history           LeagueTradeHistory @relation(fields: [historyId], references: [id], onDelete: Cascade)

  @@unique([historyId, transactionId])
  @@index([historyId])
  @@index([analyzed])
  @@index([season])
  @@index([platform])
  @@index([sport])
}

model TradeLearningInsight {
  id               String   @id @default(cuid())
  insightType      String
  playerName       String?
  position         String?
  ageRange         String?
  sampleSize       Int      @default(0)
  avgValueGiven    Float?
  avgValueReceived Float?
  winRate          Float?
  marketTrend      String?
  confidenceScore  Float?
  insightText      String?
  examples         Json?
  season           Int      @default(2025)
  lastUpdated      DateTime @updatedAt
  createdAt        DateTime @default(now())
  platform         String?
  sport            String?

  @@unique([insightType, playerName, position, ageRange, season])
  @@index([insightType])
  @@index([position])
  @@index([season])
}

model TradeLearningStats {
  id                     String   @id @default(cuid())
  season                 Int      @unique
  totalTradesAnalyzed    Int      @default(0)
  totalUsersContributing Int      @default(0)
  avgValueDifferential   Float?
  mostOvervaluedPlayers  Json?
  mostUndervaluedPlayers Json?
  positionTrends         Json?
  pickValueObserved      Json?
  ageCurveData           Json?
  calibratedB0           Float?
  calibrationSampleSize  Int      @default(0)
  calibrationHistory     Json?
  feedbackWeightAdj      Json?
  driftReport            Json?
  shadowB0               Float?
  shadowB0SampleSize     Int?
  shadowB0ComputedAt     DateTime?
  shadowB0Metrics        Json?
  segmentB0s             Json?
  lastRecalibrationAt    DateTime?
  lastCalibrated         DateTime?
  lastUpdated            DateTime @updatedAt
  createdAt              DateTime @default(now())
}

model TradePreAnalysisCache {
  id                        String    @id @default(cuid())
  sleeperUsername           String
  sleeperLeagueId           String
  leagueName                String?
  leagueSettings            Json?
  userTradingProfile        Json?
  leagueTradePatterns       Json?
  managerProfiles           Json?
  managerTendencyProfiles   Json?
  rosterNeeds               Json?
  marketInsights            Json?
  status                    String    @default("pending")
  analysisStartedAt         DateTime?
  analysisCompletedAt       DateTime?
  tendencyComputedAt        DateTime?
  lastUsedAt                DateTime?
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt

  @@unique([sleeperUsername, sleeperLeagueId])
  @@index([sleeperUsername])
  @@index([status])
}

model LeagueTypeSubmission {
  id                String    @id @default(cuid())
  leagueTypeName    String
  tagline           String
  description       String
  sports            String[]
  recommendedSize   String
  seasonFormat      String
  draftType         String
  winCondition      String
  hasSpecialScoring Boolean   @default(false)
  scoringRules      String?
  positionsImpacted String?
  specialMechanics  String[]
  weeklyFlow        String
  edgeCases         String?
  rosterSetup       String?
  waiverSystem      String?
  tradeRules        String?
  playoffSetup      String?
  commissionerTools String?
  creditName        String
  email             String
  socialHandle      String?
  permissionConsent Boolean   @default(false)
  rightsConsent     Boolean   @default(false)
  canContact        Boolean   @default(false)
  status            String    @default("received")
  adminNotes        String?
  reviewedAt        DateTime?
  reviewedBy        String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([email])
  @@index([status])
  @@index([createdAt])
}

model LegacyFeedback {
  id               String    @id @default(cuid())
  feedbackType     String
  tool             String
  feedbackText     String
  stepsToReproduce String?
  rating           Int?
  importance       String?
  wasLoggedIn      Boolean?
  device           String?
  browser          String?
  email            String?
  canContact       Boolean   @default(false)
  userId           String?
  sleeperUsername  String?
  status           String    @default("new")
  adminNotes       String?
  reviewedAt       DateTime?
  reviewedBy       String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  aiCategory       String?
  aiReproSteps     String?
  aiSeverity       String?
  aiSuggestedFix   String?
  aiSummary        String?
  aiSuspectedCause String?
  aiTriagedAt      DateTime?
  assignedTo       String?
  pageUrl          String?
  priority         String?
  resolvedAt       DateTime?
  screenshotMeta   String?
  screenshotUrl    String?

  @@index([status])
  @@index([feedbackType])
  @@index([tool])
  @@index([priority])
  @@index([aiSeverity])
  @@index([createdAt])
}

model YahooConnection {
  id             String        @id @default(uuid())
  yahooUserId    String        @unique
  displayName    String?
  email          String?
  accessToken    String
  refreshToken   String
  tokenExpiresAt DateTime
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  leagues        YahooLeague[]

  @@index([yahooUserId])
}

model YahooLeague {
  id             String          @id @default(uuid())
  yahooLeagueKey String          @unique
  name           String
  sport          String
  season         String
  numTeams       Int?
  leagueType     String?
  draftStatus    String?
  currentWeek    Int?
  startWeek      Int?
  endWeek        Int?
  isFinished     Boolean         @default(false)
  rawData        Json?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  connectionId   String
  connection     YahooConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  teams          YahooTeam[]

  @@index([connectionId])
  @@index([sport])
  @@index([season])
}

model YahooTeam {
  id             String      @id @default(uuid())
  yahooTeamKey   String      @unique
  name           String
  managerName    String?
  logoUrl        String?
  waiverPriority Int?
  faabBalance    Int?
  wins           Int         @default(0)
  losses         Int         @default(0)
  ties           Int         @default(0)
  pointsFor      Float       @default(0)
  pointsAgainst  Float       @default(0)
  standing       Int?
  playoffSeed    Int?
  isUserTeam     Boolean     @default(false)
  rawData        Json?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  leagueId       String
  league         YahooLeague @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  @@index([leagueId])
  @@index([isUserTeam])
}

model MFLConnection {
  id          String   @id @default(uuid())
  sessionId   String   @unique
  mflUsername String   @unique
  mflCookie   String
  year        Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([mflUsername])
}

model InsightEvent {
  id              String   @id @default(uuid())
  eventType       String
  insightId       String?
  insightType     String?
  confidenceLevel String?
  confidenceScore String?
  leagueId        String?
  sport           String?
  scoringType     String?
  dataCoverage    String?
  placement       String?
  userId          String?
  feedbackType    String?
  feedbackText    String?
  metadata        Json?
  createdAt       DateTime @default(now())

  @@index([eventType])
  @@index([insightId])
  @@index([confidenceLevel])
  @@index([createdAt])
}

model AIIssue {
  id                String            @id @default(uuid())
  title             String
  description       String?
  area              String
  priority          String            @default("low")
  status            String            @default("open")
  avgConfidence     Float?
  reportCount       Int               @default(1)
  feltOffRate       Float?
  sport             String?
  leagueType        String?
  aiSelfAssessment  String?
  tags              String[]
  resolutionSummary String?
  resolutionType    String?
  resolvedAt        DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  feedbackItems     AIIssueFeedback[]

  @@index([status])
  @@index([priority])
  @@index([area])
  @@index([createdAt])
}

model AIIssueFeedback {
  id              String   @id @default(uuid())
  issueId         String
  feedbackText    String
  feedbackType    String?
  confidenceLevel String?
  sport           String?
  leagueType      String?
  insightType     String?
  createdAt       DateTime @default(now())
  issue           AIIssue  @relation(fields: [issueId], references: [id], onDelete: Cascade)

  @@index([issueId])
}

model FantraxUser {
  id              String          @id @default(uuid())
  fantraxUsername String          @unique
  displayName     String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  leagues         FantraxLeague[]

  @@index([fantraxUsername])
}

model FantraxLeague {
  id            String      @id @default(uuid())
  userId        String
  leagueName    String
  season        Int
  sport         String      @default("cfb")
  teamCount     Int         @default(12)
  userTeam      String
  isChampion    Boolean     @default(false)
  champion      String?
  wins          Int         @default(0)
  losses        Int         @default(0)
  ties          Int         @default(0)
  pointsFor     Float       @default(0)
  pointsAgainst Float       @default(0)
  finalRank     Int?
  playoffFinish String?
  standings     Json?
  matchups      Json?
  roster        Json?
  teamStats     Json?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  isDevy        Boolean     @default(false)
  transactions  Json?
  user          FantraxUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, leagueName, season])
  @@index([userId, season])
  @@index([season])
}

model manager_trade_tendencies {
  user_id           String    @id
  leagues_played    Int?      @default(0)
  trades_sent       Int?      @default(0)
  trades_accepted   Int?      @default(0)
  avg_overpay_ratio Float?    @default(1.0)
  prefers_youth     Boolean?  @default(false)
  prefers_picks     Boolean?  @default(false)
  risk_tolerance    String?   @default("medium")
  updated_at        DateTime? @default(now()) @db.Timestamp(6)
}

model user_trade_reputation {
  user_id         String    @id
  trades_sent     Int?      @default(0)
  trades_accepted Int?      @default(0)
  avg_value_delta Float?    @default(1.0)
  reputation      String?   @default("Fair Dealer")
  updated_at      DateTime? @default(now()) @db.Timestamp(6)
}

model SleeperImportCache {
  id               String   @id @default(cuid())
  sleeperUsername  String   @db.VarChar(64)
  sleeperLeagueId  String   @db.VarChar(64)
  leagueName       String?  @db.VarChar(255)

  leagueContext        Json
  managerRosters       Json
  fantasyCalcValueMap  Json

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([sleeperUsername, sleeperLeagueId])
  @@index([sleeperUsername])
  @@index([sleeperLeagueId])
}

model TradeBlockEntry {
  id                String   @id @default(cuid())

  sleeperLeagueId   String   @db.VarChar(64)
  rosterId          Int

  playerId          String   @db.VarChar(32)
  playerName        String   @db.VarChar(128)
  position          String?  @db.VarChar(16)
  team              String?  @db.VarChar(8)

  createdByUsername String   @db.VarChar(64)
  notes             String?

  isActive          Boolean  @default(true)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([sleeperLeagueId, playerId], map: "uq_trade_block_active")
  @@index([sleeperLeagueId, isActive, updatedAt(sort: Desc)], map: "idx_trade_block_league_active")
  @@index([sleeperLeagueId, rosterId], map: "idx_trade_block_roster")

  @@map("trade_block_entries")
}

model TradeAnalysisSnapshot {
  id               String    @id @default(uuid())
  leagueId         String    @db.VarChar(64)
  sleeperUsername  String    @db.VarChar(64)
  snapshotType     String    @db.VarChar(32)
  contextKey       String?   @db.VarChar(64)
  payloadJson      Json
  season           Int?
  expiresAt        DateTime?
  createdAt        DateTime  @default(now())

  @@index([leagueId, sleeperUsername, snapshotType])
  @@index([sleeperUsername, createdAt])
  @@index([expiresAt])

  @@map("trade_analysis_snapshots")
}

model ShareReward {
  id               String    @id @default(uuid())
  sleeperUsername  String    @db.VarChar(64)
  leagueId         String?   @db.VarChar(64)
  shareType        String    @db.VarChar(32)
  shareContent     Json?
  tokensAwarded    Int       @default(1)
  platform         String?   @db.VarChar(32)
  redeemed         Boolean   @default(false)
  redeemedAt       DateTime?
  createdAt        DateTime  @default(now())

  @@index([sleeperUsername])
  @@index([createdAt])
  @@index([redeemed])

  @@map("share_rewards")
}

model DecisionLog {
  id                 String            @id @default(uuid())
  userId             String            @db.VarChar(64)
  leagueId           String            @db.VarChar(64)
  decisionType       String            @db.VarChar(32)
  aiRecommendation   Json
  confidenceScore    Float
  numericConfidence  Int?
  riskProfile        String            @db.VarChar(32)
  volatilityLabel    String?           @db.VarChar(16)
  volatilityScore    Float?
  riskTags           Json?
  confidenceExplanation String?
  contextSnapshot    Json?
  userFollowed       Boolean?
  userAction         Json?
  resolvedAt         DateTime?
  expiresAt          DateTime?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  outcome            DecisionOutcome?

  @@index([userId])
  @@index([leagueId])
  @@index([userId, leagueId])
  @@index([decisionType])
  @@index([userFollowed])
  @@index([createdAt])
  @@index([resolvedAt])
  @@index([numericConfidence])

  @@map("decision_logs")
}

model DecisionOutcome {
  id                  String      @id @default(uuid())
  decisionLogId       String      @unique
  rosterValueBefore   Float?
  rosterValueAfter    Float?
  rosterValueDelta    Float?
  winProbBefore       Float?
  winProbAfter        Float?
  winProbDelta        Float?
  evaluationWeeks     Int         @default(3)
  actualResult        String?     @db.VarChar(32)
  outcomeGrade        String?     @db.VarChar(8)
  aiRetroSummary      String?
  detailJson          Json?
  evaluatedAt         DateTime    @default(now())
  decisionLog         DecisionLog @relation(fields: [decisionLogId], references: [id], onDelete: Cascade)

  @@index([decisionLogId])
  @@index([evaluatedAt])
  @@index([outcomeGrade])
  @@index([actualResult])

  @@map("decision_outcomes")
}

model TradeOfferEvent {
  id                    String         @id @default(uuid())
  createdAt             DateTime       @default(now())

  mode                  TradeOfferMode
  season                Int?
  week                  Int?

  leagueId              String?        @db.VarChar(64)
  senderUserId          String?        @db.VarChar(64)
  opponentUserId        String?        @db.VarChar(64)

  inputHash             String         @unique
  assetsGiven           Json           @default("[]")
  assetsReceived        Json           @default("[]")

  acceptProb            Float
  verdict               String         @db.VarChar(32)
  lean                  String         @db.VarChar(32)
  grade                 String?        @db.VarChar(16)
  confidenceScore       Int?
  confidenceLabel       String?        @db.VarChar(32)

  featuresJson          Json
  driversJson           Json
  confidenceDriversJson Json

  narrativeValid        Boolean        @default(true)
  driverSetComplete     Boolean        @default(true)

  isSuperFlex           Boolean?
  leagueFormat          String?        @db.VarChar(32)
  scoringType           String?        @db.VarChar(16)
  leagueTradeId         String?
  modelVersion          String?        @db.VarChar(32)

  @@index([leagueId, createdAt])
  @@index([senderUserId, createdAt])
  @@index([opponentUserId, createdAt])
  @@index([mode, createdAt])
  @@index([leagueTradeId])
}

enum TradeOfferMode {
  INSTANT
  STRUCTURED
  TRADE_HUB
  TRADE_IDEAS
  PROPOSAL_GENERATOR
}

model TradeOutcomeEvent {
  id                    String       @id @default(uuid())
  createdAt             DateTime     @default(now())

  leagueId              String?      @db.VarChar(64)
  season                Int?
  week                  Int?

  offerEventId          String?      @unique @db.VarChar(64)
  leagueTradeId         String?

  outcome               TradeOutcome
  timeToDecisionMin     Int?
  outcomeMetaJson       Json?

  @@index([leagueId, createdAt])
  @@index([outcome, createdAt])
  @@index([leagueTradeId])
}

enum TradeOutcome {
  ACCEPTED
  REJECTED
  EXPIRED
  COUNTERED
  UNKNOWN
}

model ModelMetricsDaily {
  id               String         @id @default(cuid())
  day              DateTime
  mode             TradeOfferMode
  segmentKey       String         @db.VarChar(64)

  nOffers          Int
  nLabeled         Int
  nAccepted        Int

  meanPred         Float
  meanObs          Float
  ece              Float
  brier            Float
  auc              Float?

  psiJson          Json?
  capRateJson      Json?
  bucketStatsJson  Json?
  narrativeFailRate Float

  @@unique([day, mode, segmentKey])
  @@index([day])
}

model LearnedWeights {
  id          String   @id @default(cuid())
  leagueClass String   @db.VarChar(16)
  season      Int
  wMarket     Float
  wImpact     Float
  wScarcity   Float
  wDemand     Float
  nTrades     Int
  corrMarket  Float    @default(0)
  corrImpact  Float    @default(0)
  corrScarcity Float   @default(0)
  corrDemand  Float    @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([leagueClass, season])
  @@index([leagueClass])
}

model RankingWeightsWeekly {
  id           String   @id @default(cuid())
  weekStart    DateTime
  segmentKey   String   @db.VarChar(32)
  priorJson    Json
  learnedJson  Json
  finalJson    Json
  metricsJson  Json     @default("{}")
  status       String   @db.VarChar(32)  // APPLIED | REJECTED | INSUFFICIENT_DATA | ROLLED_BACK
  version      String   @db.VarChar(48)
  nSamples     Int      @default(0)
  createdAt    DateTime @default(now())

  @@unique([segmentKey, weekStart])
  @@index([segmentKey, status])
  @@index([weekStart])
}

model LeagueDemandWeekly {
  id               String   @id @default(cuid())
  leagueId         String   @db.VarChar(64)
  weekStart        DateTime
  rangeDays        Int      @default(90)
  positionDemand   Json     @default("[]")
  pickDemand       Json     @default("[]")
  hotPlayers       Json     @default("[]")
  demandByPosition Json     @default("{}")
  tradesAnalyzed   Int      @default(0)
  createdAt        DateTime @default(now())

  @@unique([leagueId, weekStart, rangeDays])
  @@index([leagueId])
  @@index([weekStart])
}

model NarrativeValidationLog {
  id           String   @id @default(uuid())
  offerEventId String?  @db.VarChar(64)
  mode         String   @db.VarChar(32)
  contractType String   @db.VarChar(32)
  valid        Boolean
  violations   Json     @default("[]")
  createdAt    DateTime @default(now())

  @@index([mode])
  @@index([contractType])
  @@index([valid])
  @@index([createdAt])
}

model ManagerDNA {
  id                String   @id @default(uuid())
  sleeperUsername    String
  sleeperUserId     String?  @db.VarChar(64)
  archetype         String   @db.VarChar(64)
  secondaryArchetype String? @db.VarChar(64)
  metrics           Json
  strengths         Json     @default("[]")
  blindSpots        Json     @default("[]")
  recommendations   Json     @default("[]")
  confidence        Float    @default(0)
  tradeCount        Int      @default(0)
  waiverCount       Int      @default(0)
  seasonsCovered    Int      @default(0)
  lastComputedAt    DateTime @default(now())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([sleeperUsername])
  @@index([sleeperUserId])
  @@index([lastComputedAt])

  @@map("manager_dna")
}

model OpponentTendency {
  id               String   @id @default(uuid())
  leagueId         String   @db.VarChar(64)
  rosterId         Int
  username         String?  @db.VarChar(64)
  displayName      String?  @db.VarChar(128)
  tendencies       Json
  tradeLikelihood  Json     @default("{}")
  pitchAngles      Json     @default("[]")
  confidence       Float    @default(0)
  tradeCount       Int      @default(0)
  seasonsCovered   Int      @default(0)
  lastComputedAt   DateTime @default(now())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([leagueId, rosterId])
  @@index([leagueId])
  @@index([lastComputedAt])

  @@map("opponent_tendencies")
}

model StrategySnapshot {
  id               String   @id @default(uuid())
  leagueId         String   @db.VarChar(64)
  rosterId         Int
  season           String   @db.VarChar(8)
  sleeperUsername   String?  @db.VarChar(64)
  classification   String   @db.VarChar(32)
  confidence       Float    @default(0)
  metrics          Json
  roster           Json     @default("{}")
  standings        Json     @default("{}")
  draftCapital     Json     @default("[]")
  phases           Json     @default("[]")
  tradeWindows     Json     @default("[]")
  riskPoints       Json     @default("[]")
  aiRoadmap        String?
  weekNumber       Int      @default(0)
  lastComputedAt   DateTime @default(now())
  expiresAt        DateTime
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([leagueId, rosterId, season])
  @@index([leagueId])
  @@index([sleeperUsername])
  @@index([lastComputedAt])
  @@index([expiresAt])

  @@map("strategy_snapshots")
}

model PlayerSeasonStats {
  id                   String   @id @default(uuid())
  sport                String
  playerId             String
  playerName           String
  season               String
  seasonType           String   @default("regular")
  position             String?
  team                 String?
  stats                Json
  gamesPlayed          Int?
  fantasyPoints        Float?
  fantasyPointsPerGame Float?
  source               String
  fetchedAt            DateTime @default(now())
  expiresAt            DateTime
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@unique([sport, playerId, season, seasonType, source])
  @@index([sport, playerId])
  @@index([sport, playerName])
  @@index([sport, position])
  @@index([season])
  @@index([source])

  @@map("player_season_stats")
}

model GuardianIntervention {
  id                String   @id @default(uuid())
  userId            String   @db.VarChar(64)
  leagueId          String?  @db.VarChar(64)
  actionType        String   @db.VarChar(32)
  severity          String   @db.VarChar(16)
  userAction        Json
  aiRecommendation  Json
  expectedValueLoss Float?
  deviationScore    Float
  riskFactors       Json?
  confidenceScore   Int?
  userDecision      String?  @db.VarChar(16)
  overrideReason    String?
  decisionLogId     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
  @@index([leagueId])
  @@index([actionType])
  @@index([severity])
  @@index([userDecision])
  @@index([createdAt])

  @@map("guardian_interventions")
}

model AIInsight {
  id               String   @id @default(uuid())
  userId           String
  sleeperUsername   String?
  leagueId         String?
  insightType      String   @db.VarChar(48)
  category         String   @db.VarChar(32)
  title            String
  body             String
  data             Json?
  priority         Int      @default(50)
  confidence       Float    @default(0.7)
  isRead           Boolean  @default(false)
  isDismissed      Boolean  @default(false)
  expiresAt        DateTime?
  createdAt        DateTime @default(now())

  @@index([userId])
  @@index([sleeperUsername])
  @@index([insightType])
  @@index([category])
  @@index([isRead])
  @@index([createdAt])

  @@map("ai_insights")
}

model AIBadge {
  id               String   @id @default(uuid())
  userId           String
  sleeperUsername   String?
  badgeType        String   @db.VarChar(48)
  badgeName        String
  description      String
  tier             String   @default("bronze") @db.VarChar(16)
  xpReward         Int      @default(0)
  data             Json?
  earnedAt         DateTime @default(now())
  createdAt        DateTime @default(now())

  @@index([userId])
  @@index([sleeperUsername])
  @@index([badgeType])
  @@index([earnedAt])

  @@map("ai_badges")
}

model SimulationRun {
  id               String   @id @default(uuid())
  userId           String
  sleeperUsername   String?
  leagueId         String?
  simulationType   String   @db.VarChar(32)
  scenario         Json
  results          Json
  iterations       Int      @default(1000)
  confidence       Float    @default(0.7)
  summary          String?
  createdAt        DateTime @default(now())

  @@index([userId])
  @@index([sleeperUsername])
  @@index([leagueId])
  @@index([simulationType])
  @@index([createdAt])

  @@map("simulation_runs")
}

model ChatConversation {
  id               String   @id @default(uuid())
  userId           String
  sleeperUsername   String?
  title            String?
  messageCount     Int      @default(0)
  lastMessageAt    DateTime @default(now())
  dataSources      Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([userId])
  @@index([sleeperUsername])
  @@index([lastMessageAt])

  @@map("chat_conversations")
}

model WeeklyMatchup {
  id            String   @id @default(cuid())
  leagueId      String   @db.VarChar(64)
  seasonYear    Int
  week          Int
  rosterId      Int
  matchupId     Int?
  pointsFor     Float
  pointsAgainst Float
  win           Int

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([leagueId, seasonYear, week, rosterId])
  @@index([leagueId, seasonYear, week])
  @@index([leagueId, seasonYear, rosterId])
}

model RankingsSnapshot {
  id           BigInt   @id @default(autoincrement())
  leagueId     String
  season       String
  week         Int
  rosterId     String
  rank         Int
  composite    Decimal  @db.Decimal(10, 4)
  expectedWins Decimal? @db.Decimal(10, 4)
  luckDelta    Decimal? @db.Decimal(10, 4)
  createdAt    DateTime @default(now())

  @@index([leagueId, season, week])
  @@index([leagueId, rosterId, createdAt])
  @@unique([leagueId, season, week, rosterId], name: "uniq_snapshot_league_season_week_roster")
  @@map("rankings_snapshots")
}


model RankingsWeightsSnapshot {
  id        String   @id @default(cuid())
  leagueId  String
  season    String
  week      Int
  weights   Json
  metrics   Json?
  reason    String?
  createdAt DateTime @default(now())

  @@index([leagueId, season, week])
  @@map("rankings_weights_snapshot")
}

model SeasonResult {
  id             String   @id @default(cuid())
  leagueId       String
  season         String
  rosterId       String
  wins           Int?
  losses         Int?
  pointsFor      Decimal? @db.Decimal(12, 2)
  pointsAgainst  Decimal? @db.Decimal(12, 2)
  champion       Boolean  @default(false)
  createdAt      DateTime @default(now())

  @@unique([leagueId, season, rosterId], name: "uniq_season_result_league_season_roster")
  @@index([leagueId, season])
  @@index([leagueId, rosterId])
  @@map("season_results")
}

model DraftGrade {
  id        String   @id @default(cuid())
  leagueId  String
  season    String
  rosterId  String
  grade     String
  score     Decimal  @db.Decimal(5, 2)
  breakdown Json
  createdAt DateTime @default(now())

  @@unique([leagueId, season, rosterId], name: "uniq_draft_grade_league_season_roster")
  @@index([leagueId, season])
  @@index([leagueId, rosterId, season])
  @@map("draft_grades")
}

model HallOfFameRow {
  id            String   @id @default(cuid())
  leagueId      String
  rosterId      String
  championships Int      @default(0)
  seasonsPlayed Int      @default(0)
  dominance     Decimal  @db.Decimal(10, 4)
  efficiency    Decimal  @db.Decimal(10, 4)
  longevity     Decimal  @db.Decimal(10, 4)
  score         Decimal  @db.Decimal(10, 4)
  updatedAt     DateTime @updatedAt

  @@unique([leagueId, rosterId], name: "uniq_hof_league_roster")
  @@index([leagueId, score])
  @@map("hall_of_fame")
}

model ApiUsageEvent {
  id          BigInt   @id @default(autoincrement())
  ts          DateTime @default(now())

  userId      String?
  username    String?
  leagueId    String?

  scope       String
  tool        String?
  endpoint    String?
  method      String?
  status      Int?
  ok          Boolean?

  durationMs  Int?
  bytesIn     Int?
  bytesOut    Int?

  meta        Json?

  @@index([ts])
  @@index([scope, ts])
  @@index([endpoint, ts])
  @@index([tool, ts])
  @@index([leagueId, ts])
  @@index([userId, ts])
}

model ApiUsageRollup {
  id           BigInt   @id @default(autoincrement())

  bucketStart  DateTime
  bucketType   String

  scope        String   @default("")
  tool         String   @default("")
  endpoint     String   @default("")
  leagueId     String   @default("")

  count        Int      @default(0)
  okCount      Int      @default(0)
  errCount     Int      @default(0)

  avgMs        Int?
  p95Ms        Int?
  maxMs        Int?

  bytesInSum   BigInt?  @default(0)
  bytesOutSum  BigInt?  @default(0)

  meta         Json?

  updatedAt    DateTime @updatedAt

  @@index([bucketType, bucketStart])
  @@index([scope, bucketType, bucketStart])
  @@index([endpoint, bucketType, bucketStart])
  @@index([tool, bucketType, bucketStart])
  @@index([leagueId, bucketType, bucketStart])

  @@unique([bucketType, bucketStart, scope, tool, endpoint, leagueId], name: "uniq_usage_rollup_bucket_key")
}

model Player {
  id                     String   @id
  name                   String
  sport                  String
  position               String
  team                   String?
  birthYear              Int?

  league                 String
  devyEligible           Boolean  @default(false)
  graduatedToNFL         Boolean  @default(false)

  recruitingComposite    Float?
  breakoutAge            Float?
  draftProjectionScore   Float?
  projectedDraftRound    Int?
  projectedDraftPick     Int?
  devyAdp                Float?
  redshirtStatus         Boolean  @default(false)
  transferStatus         Boolean  @default(false)
  nilImpactScore         Float?
  injurySeverityScore    Float?

  nflDraftRound          Int?
  nflDraftPick           Int?
  nflTeam                String?

  active                 Boolean  @default(true)
  injuryStatus           String?

  lastSyncedAt           DateTime @updatedAt
  createdAt              DateTime @default(now())

  @@index([league])
  @@index([devyEligible])
}

model DevyPlayer {
  id                 String   @id @default(uuid())
  name               String
  normalizedName     String
  position           String
  school             String
  conference         String?
  classYear          Int?
  heightInches       Int?
  weightLbs          Int?

  league             String   @default("NCAA")
  devyEligible       Boolean  @default(true)
  graduatedToNFL     Boolean  @default(false)
  draftYear          Int?
  draftEligibleYear  Int?
  draftRound         Int?
  draftPick          Int?

  cfbdId             String?
  sleeperId          String?
  nflTeam            String?

  passingYards       Int?
  passingTDs         Int?
  rushingYards       Int?
  rushingTDs         Int?
  receivingYards     Int?
  receivingTDs       Int?
  receptions         Int?
  statSeason         Int?

  devyValue          Int      @default(0)
  projectedNFLValue  Int?
  trend              String   @default("stable")

  recruitingStars    Int?
  recruitingRanking  Int?

  recruitingComposite    Float?
  breakoutAge            Float?
  draftProjectionScore   Float?
  projectedDraftRound    Int?
  projectedDraftPick     Int?
  devyAdp                Float?
  redshirtStatus         Boolean  @default(false)
  transferStatus         Boolean  @default(false)
  nilImpactScore         Float?
  injurySeverityScore    Float?
  athleticProfileScore   Float?
  productionIndex        Float?
  volatilityScore        Float?
  nflDraftRound          Int?
  nflDraftPick           Int?

  devyAdpHistory DevyAdp[]

  source             String   @default("cfbd")
  lastClassifiedAt   DateTime?
  lastSyncedAt       DateTime @default(now())
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([normalizedName, position, school], name: "uniq_devy_player")
  @@index([devyEligible])
  @@index([league])
  @@index([position])
  @@index([draftEligibleYear])
  @@index([graduatedToNFL])
  @@index([cfbdId])
  @@index([draftProjectionScore])
}

model DevyAdp {
  id        String   @id @default(cuid())
  playerId  String
  player    DevyPlayer @relation(fields: [playerId], references: [id], onDelete: Cascade)
  adp       Float
  source    String
  season    Int
  updatedAt DateTime @updatedAt

  @@unique([playerId, source, season])
  @@index([playerId])
  @@index([season])
}

model RookieClass {
  year        Int      @id
  strength    Float
  qbDepth     Float
  rbDepth     Float
  wrDepth     Float
  teDepth     Float
  updatedAt   DateTime @updatedAt
}

model TradeOutcomeTraining {
  id               String   @id @default(cuid())
  leagueId         String
  proposerRosterId String
  partnerRosterId  String

  fairnessScore    Float
  ldiAlignment     Float
  needsFitScore    Float
  archetypeMatch   Float
  dealShapeScore   Float
  volatilityDelta  Float

  wasAccepted      Boolean
  createdAt        DateTime @default(now())

  @@index([leagueId, createdAt])
  @@index([wasAccepted])
}

model EngineSnapshot {
  id         String   @id @default(cuid())
  leagueId   String
  type       String   @db.VarChar(32)
  hash       String   @db.VarChar(64)
  payload    Json
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  @@unique([leagueId, type, hash])
  @@index([leagueId, type])
  @@index([expiresAt])
}

model PlayerAnalyticsSnapshot {
  id                        String   @id @default(uuid())
  normalizedName            String
  name                      String
  position                  String
  status                    String?
  currentTeam               String?
  season                    String

  // Combine & Athletic Metrics
  fortyYardDash             Float?
  twentyYardShuttle         Float?
  threeConeDrill            Float?
  benchPress                Int?
  broadJump                 Int?
  verticalJump              Float?
  athleticismScore          Float?
  speedScore                Float?
  burstScore                Float?
  agilityScore              Float?
  sparqX                    Float?
  armLengthIn               Float?
  handSizeIn                Float?
  heightIn                  Int?
  weightLb                  Int?
  bmi                       Float?
  catchRadius               Float?
  throwVelocityMph          Float?

  // College Production
  breakoutAge               Float?
  breakoutRating            Float?
  breakoutYear              Int?
  college                   String?
  collegeDominatorRating    Float?
  collegeDynamicScore       Float?
  collegeLevelOfCompetition Float?
  collegeFreshmanYards      Float?
  collegeTargetShare        Float?
  collegeReceiverRating     String?
  collegeYpr                Float?
  collegeTeammateScore      Float?
  bestCollegeSeasonYardageShare Float?

  // Draft Info
  draftPick                 Float?
  draftYear                 Int?
  currentAdp                Float?
  currentAdpTrend           Float?
  lifetimeValue             Float?

  // Comparables
  bestComparablePlayers     String?

  // Key Production & Fantasy
  totalFantasyPoints        Float?
  fantasyPointsPerGame      Float?
  expectedFantasyPoints     Float?
  expectedFantasyPointsPerGame Float?
  weeklyVolatility          Float?

  // All 355 columns stored as JSON
  rawData                   Json?

  source                    String   @default("csv_import")
  dataVersion               String   @default("v1")
  importedAt                DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  @@unique([normalizedName, season, source])
  @@index([normalizedName])
  @@index([position])
  @@index([season])
  @@index([status])
  @@index([currentTeam])
}

model AppUser {
  id            String    @id @default(uuid())
  email         String    @unique
  emailVerified DateTime?
  username      String    @unique
  passwordHash  String?
  displayName   String?
  avatarUrl     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  legacyUserId String?     @unique
  legacyUser   LegacyUser? @relation(fields: [legacyUserId], references: [id], onDelete: SetNull)

  accounts AuthAccount[]
  sessions AuthSession[]

  bracketLeaguesOwned  BracketLeague[]       @relation("BracketLeagueOwner")
  bracketMemberships   BracketLeagueMember[]
  bracketEntries       BracketEntry[]
  profile              UserProfile?
  emailVerifyTokens    EmailVerifyToken[]
  passwordResetTokens  PasswordResetToken[]

  @@map("app_users")
}

model AuthAccount {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user AppUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("auth_accounts")
}

model AuthSession {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user AppUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("auth_sessions")
}

model AuthVerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("auth_verification_tokens")
}

model BracketTournament {
  id        String    @id @default(uuid())
  name      String
  season    Int
  sport     String
  lockAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  nodes     BracketNode[]
  leagues   BracketLeague[]

  @@unique([sport, season])
}

model BracketNode {
  id            String   @id @default(uuid())
  tournamentId  String
  round         Int
  region        String?
  slot          String

  seedHome      Int?
  seedAway      Int?

  homeTeamName  String?
  awayTeamName  String?

  sportsGameId  String?  @unique

  nextNodeId    String?
  nextNodeSide  String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tournament    BracketTournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  picks         BracketPick[]

  @@unique([tournamentId, slot])
  @@index([tournamentId, round, region])
}

model BracketLeague {
  id           String   @id @default(uuid())
  tournamentId String
  ownerId      String
  name         String
  joinCode     String   @unique
  isPrivate    Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tournament   BracketTournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  owner        AppUser @relation("BracketLeagueOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  members      BracketLeagueMember[]
  entries      BracketEntry[]

  @@index([tournamentId])
  @@index([ownerId])
}

model BracketLeagueMember {
  id        String   @id @default(uuid())
  leagueId  String
  userId    String
  role      String   @default("MEMBER")
  createdAt DateTime @default(now())

  league    BracketLeague @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  user      AppUser       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([leagueId, userId])
  @@index([userId])
}

model BracketEntry {
  id           String   @id @default(uuid())
  leagueId     String
  userId       String
  name         String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  league       BracketLeague @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  user         AppUser       @relation(fields: [userId], references: [id], onDelete: Cascade)
  picks        BracketPick[]

  @@index([leagueId])
  @@index([userId])
}

model BracketPick {
  id             String    @id @default(uuid())
  entryId        String
  nodeId         String
  pickedTeamName String?
  lockedAt       DateTime?
  points         Int       @default(0)
  isCorrect      Boolean?

  entry     BracketEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)
  node      BracketNode  @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  @@unique([entryId, nodeId])
  @@index([nodeId])
}

enum VerificationMethod {
  EMAIL
  PHONE
}

model UserProfile {
  userId              String              @id
  displayName         String?
  phone               String?             @unique
  phoneVerifiedAt     DateTime?
  emailVerifiedAt     DateTime?
  ageConfirmedAt      DateTime?
  verificationMethod  VerificationMethod?
  sleeperUsername      String?
  sleeperUserId       String?             @unique
  sleeperLinkedAt     DateTime?
  sleeperVerifiedAt   DateTime?
  profileComplete     Boolean             @default(false)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  user AppUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sleeperUsername])
  @@index([phone])
  @@map("user_profiles")
}

model PendingSignup {
  email       String   @id
  displayName String?
  phone       String?
  createdAt   DateTime @default(now())

  @@map("pending_signups")
}

model EmailVerifyToken {
  id        String   @id @default(uuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user AppUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("email_verify_tokens")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user AppUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("password_reset_tokens")
}
